{% extends "base.html" %}

{% block title %}Conclusion Comparison - {{ document.title }}{% endblock %}

{% block head %}
{{ super() }}
<style>
  .comparison-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  .comparison-header {
    margin-bottom: 30px;
  }
  .comparison-section {
    margin-bottom: 40px;
  }
  .case-details {
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }
  .case-section {
    margin-bottom: 15px;
  }
  .section-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: #0066cc;
  }
  .comparison-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }
  .prediction-card {
    padding: 20px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: #fff;
  }
  .prediction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #dee2e6;
  }
  .prediction-method {
    font-size: 1.2em;
    font-weight: bold;
  }
  .prediction-tag {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
  }
  .tag-baseline {
    background-color: #e9ecef;
    color: #495057;
  }
  .tag-proethica {
    background-color: #e3f2fd;
    color: #0066cc;
  }
  .validation-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 20px;
  }
  .metric-card {
    padding: 10px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    text-align: center;
  }
  .metric-value {
    font-weight: bold;
    font-size: 1.2em;
    color: #0066cc;
  }
  .metric-label {
    font-size: 0.8em;
    color: #6c757d;
  }
  .highlighted-term {
    background-color: rgba(0, 102, 204, 0.1);
    padding: 0 3px;
    border-radius: 3px;
  }
  .entity-tag {
    display: inline-block;
    background-color: #e9ecef;
    padding: 0.2em 0.6em;
    margin: 0.1em;
    border-radius: 0.25rem;
    font-size: 0.8em;
  }
  .evaluation-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }
  .evaluation-form {
    margin-top: 20px;
  }
  .evaluation-header {
    margin-bottom: 20px;
  }
  .evaluation-metrics {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }
  .evaluation-metric {
    margin-bottom: 15px;
  }
  .footer-actions {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }
  .diff-highlight-add {
    background-color: #e6ffec;
    text-decoration: none;
  }
  .diff-highlight-remove {
    background-color: #ffebe9;
    text-decoration: line-through;
  }
  .comparison-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  .diff-view-container {
    margin-top: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }
</style>
{% endblock %}

{% block content %}
<div class="comparison-container">
  <div class="comparison-header">
    <h1>Conclusion Comparison</h1>
    <h2>{{ document.title }}</h2>
    <div class="mt-3">
      <span class="badge badge-primary">Experiment: {{ experiment.name }}</span>
      <span class="badge badge-info ml-2">Document ID: {{ document.id }}</span>
    </div>
  </div>

  <div class="comparison-buttons">
    <button class="btn btn-outline-primary" id="show-diff-view">Show Differences</button>
    <button class="btn btn-outline-primary" id="highlight-entities">Highlight Ontology Entities</button>
    <button class="btn btn-outline-secondary" onclick="location.href='{{ url_for('experiment.view_results', experiment_id=experiment.id) }}'">Back to Results</button>
  </div>
  
  <div class="case-details">
    <h3>Case Summary</h3>
    
    {% if document.doc_metadata and document.doc_metadata.document_structure and document.doc_metadata.document_structure.sections %}
      {% for section_id, section in document.doc_metadata.document_structure.sections.items() %}
        {% if section.type.lower() != 'conclusion' %}
        <div class="case-section">
          <div class="section-title">{{ section.type.title() }}</div>
          <div class="section-content">{{ section.content }}</div>
        </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <div class="case-section">
        <div class="section-content">{{ document.content }}</div>
      </div>
    {% endif %}
    
    {% if original_conclusion %}
    <div class="case-section">
      <div class="section-title">Original NSPE Conclusion</div>
      <div class="section-content">{{ original_conclusion }}</div>
    </div>
    {% endif %}
  </div>
  
  <div class="comparison-section">
    <h3>Prediction Comparison</h3>
    
    <div class="comparison-grid">
      {% for prediction in predictions %}
      <div class="prediction-card">
        <div class="prediction-header">
          <div class="prediction-method">
            {{ prediction.condition.title() }}
            <span class="prediction-tag {% if prediction.condition == 'baseline' %}tag-baseline{% else %}tag-proethica{% endif %}">
              {{ prediction.target.title() }}
            </span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-info view-details" data-toggle="collapse" data-target="#details-{{ prediction.id }}">
              View Details
            </button>
          </div>
        </div>
        
        <div class="prediction-content prediction-text" data-prediction-id="{{ prediction.id }}">
          {{ prediction.prediction_text|safe }}
        </div>
        
        {% if prediction.condition == 'proethica' and prediction.meta_info and prediction.meta_info.get('ontology_entities') %}
        <div class="ontology-entities">
          <strong>Ontology Entities:</strong>
          {% for entity in prediction.meta_info.get('mentioned_entities', []) %}
            <span class="entity-tag" data-entity="{{ entity }}">{{ entity }}</span>
          {% endfor %}
        </div>
        {% endif %}
        
        <div class="collapse" id="details-{{ prediction.id }}">
          <div class="card card-body mt-3">
            <h5>Prompt</h5>
            <pre class="p-3 bg-light"><code>{{ prediction.prompt }}</code></pre>
            
            {% if prediction.meta_info and prediction.meta_info.get('validation_metrics') %}
            <div class="validation-metrics mt-3">
              <div class="metric-card">
                <div class="metric-value">{{ prediction.meta_info.validation_metrics.entity_mentions }}</div>
                <div class="metric-label">Entity Mentions</div>
              </div>
              
              <div class="metric-card">
                <div class="metric-value">{{ prediction.meta_info.validation_metrics.total_entities }}</div>
                <div class="metric-label">Total Entities</div>
              </div>
              
              <div class="metric-card">
                <div class="metric-value">{{ (prediction.meta_info.validation_metrics.mention_ratio * 100)|round(1) }}%</div>
                <div class="metric-label">Mention Ratio</div>
              </div>
              
              <div class="metric-card">
                <div class="metric-value">{{ prediction.meta_info.validation_metrics.validation_status }}</div>
                <div class="metric-label">Validation Status</div>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <div class="diff-view-container collapse" id="diff-view">
      <h4>Difference View</h4>
      <div id="diff-content">
        <!-- Diff will be displayed here -->
      </div>
    </div>
  </div>
  
  <div class="evaluation-section">
    <div class="evaluation-header">
      <h3>Evaluate Predictions</h3>
      <p>Compare both predictions and evaluate their quality based on the metrics below.</p>
    </div>
    
    <form id="evaluation-form" class="evaluation-form" method="POST" action="{{ url_for('experiment.submit_comparison_evaluation', experiment_id=experiment.id, document_id=document.id) }}">
      <div class="evaluation-metrics">
        <div class="evaluation-column">
          <div class="evaluation-metric">
            <label>Reasoning Quality (0-10)</label>
            <div class="form-row">
              <div class="col">
                <label>Baseline</label>
                <input type="number" class="form-control" name="baseline_reasoning_quality" min="0" max="10" required>
              </div>
              <div class="col">
                <label>ProEthica</label>
                <input type="number" class="form-control" name="proethica_reasoning_quality" min="0" max="10" required>
              </div>
            </div>
          </div>
          
          <div class="evaluation-metric">
            <label>Persuasiveness (0-10)</label>
            <div class="form-row">
              <div class="col">
                <label>Baseline</label>
                <input type="number" class="form-control" name="baseline_persuasiveness" min="0" max="10" required>
              </div>
              <div class="col">
                <label>ProEthica</label>
                <input type="number" class="form-control" name="proethica_persuasiveness" min="0" max="10" required>
              </div>
            </div>
          </div>
          
          <div class="evaluation-metric">
            <label>Coherence (0-10)</label>
            <div class="form-row">
              <div class="col">
                <label>Baseline</label>
                <input type="number" class="form-control" name="baseline_coherence" min="0" max="10" required>
              </div>
              <div class="col">
                <label>ProEthica</label>
                <input type="number" class="form-control" name="proethica_coherence" min="0" max="10" required>
              </div>
            </div>
          </div>
        </div>
        
        <div class="evaluation-column">
          <div class="evaluation-metric">
            <label>Support Quality (0-10)</label>
            <div class="form-row">
              <div class="col">
                <label>Baseline</label>
                <input type="number" class="form-control" name="baseline_support_quality" min="0" max="10" required>
              </div>
              <div class="col">
                <label>ProEthica</label>
                <input type="number" class="form-control" name="proethica_support_quality" min="0" max="10" required>
              </div>
            </div>
          </div>
          
          <div class="evaluation-metric">
            <label>Accuracy (0-10)</label>
            <div class="form-row">
              <div class="col">
                <label>Baseline</label>
                <input type="number" class="form-control" name="baseline_accuracy" min="0" max="10" required>
              </div>
              <div class="col">
                <label>ProEthica</label>
                <input type="number" class="form-control" name="proethica_accuracy" min="0" max="10" required>
              </div>
            </div>
          </div>
          
          <div class="evaluation-metric">
            <label>Overall Preference</label>
            <select class="form-control" name="overall_preference" required>
              <option value="">Select preference...</option>
              <option value="baseline">Baseline is better</option>
              <option value="proethica">ProEthica is better</option>
              <option value="equal">Equal quality</option>
            </select>
          </div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="comments">Comments</label>
        <textarea class="form-control" id="comments" name="comments" rows="3"></textarea>
      </div>
      
      <button type="submit" class="btn btn-primary">Submit Evaluation</button>
    </form>
  </div>
  
  <div class="footer-actions">
    <button class="btn btn-light" onclick="location.href='{{ url_for('experiment.view_results', experiment_id=experiment.id) }}'">Back to Results</button>
    <div>
      <button class="btn btn-outline-primary" onclick="location.href='{{ url_for('experiment.export_comparison', experiment_id=experiment.id, document_id=document.id) }}'">Export Comparison</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/diff@5.0.0/dist/diff.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle diff view
    document.getElementById('show-diff-view').addEventListener('click', function() {
      const diffView = document.getElementById('diff-view');
      
      if (diffView.classList.contains('show')) {
        diffView.classList.remove('show');
        this.textContent = 'Show Differences';
      } else {
        // Get prediction texts
        const predictions = document.querySelectorAll('.prediction-text');
        if (predictions.length < 2) return;
        
        const baselineText = predictions[0].innerHTML;
        const proethicaText = predictions[1].innerHTML;
        
        // Generate diff
        const diff = Diff.diffWords(baselineText, proethicaText);
        
        // Display diff
        const diffContent = document.getElementById('diff-content');
        diffContent.innerHTML = '';
        
        diff.forEach(part => {
          const span = document.createElement('span');
          span.textContent = part.value;
          
          if (part.added) {
            span.className = 'diff-highlight-add';
          } else if (part.removed) {
            span.className = 'diff-highlight-remove';
          }
          
          diffContent.appendChild(span);
        });
        
        diffView.classList.add('show');
        this.textContent = 'Hide Differences';
      }
    });
    
    // Toggle entity highlighting
    document.getElementById('highlight-entities').addEventListener('click', function() {
      const predictions = document.querySelectorAll('.prediction-card');
      const isHighlighting = this.getAttribute('data-highlighting') === 'true';
      
      if (isHighlighting) {
        // Remove highlighting
        document.querySelectorAll('.highlighted-term').forEach(el => {
          const text = el.textContent;
          el.outerHTML = text;
        });
        
        this.setAttribute('data-highlighting', 'false');
        this.textContent = 'Highlight Ontology Entities';
      } else {
        // Add highlighting
        predictions.forEach(container => {
          const entityTags = container.querySelectorAll('.entity-tag');
          const predictionText = container.querySelector('.prediction-text');
          
          if (entityTags.length > 0 && predictionText) {
            let text = predictionText.innerHTML;
            
            entityTags.forEach(tag => {
              const term = tag.textContent;
              // Only highlight if term is substantial (not just a few characters)
              if (term && term.length > 3) {
                const regex = new RegExp(`\\b${term}\\b`, 'gi');
                text = text.replace(regex, `<span class="highlighted-term">$&</span>`);
              }
            });
            
            predictionText.innerHTML = text;
          }
        });
        
        this.setAttribute('data-highlighting', 'true');
        this.textContent = 'Remove Highlighting';
      }
    });
    
    // Form validation
    document.getElementById('evaluation-form').addEventListener('submit', function(e) {
      const inputs = this.querySelectorAll('input[type="number"]');
      let valid = true;
      
      inputs.forEach(input => {
        const value = parseInt(input.value);
        if (isNaN(value) || value < 0 || value > 10) {
          valid = false;
          input.classList.add('is-invalid');
        } else {
          input.classList.remove('is-invalid');
        }
      });
      
      if (!valid) {
        e.preventDefault();
        alert('Please ensure all rating scores are between 0 and 10.');
      }
    });
  });
</script>
{% endblock %}
