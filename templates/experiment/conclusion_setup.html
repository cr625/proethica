{% extends "base.html" %}

{% block title %}Setup Conclusion Prediction Experiment{% endblock %}

{% block head %}
{{ super() }}
<style>
  .experiment-setup-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }
  .form-section {
    margin-bottom: 30px;
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: #f8f9fa;
  }
  .case-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    margin-top: 20px;
  }
  .case-card {
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: white;
  }
  .case-card.selected {
    border-color: #007bff;
    background-color: #f0f7ff;
  }
  .selected-cases-container {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    background-color: white;
  }
  .alert-info {
    background-color: #e8f4f8;
    border-color: #bee5eb;
    color: #0c5460;
  }
  .footer-actions {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }
</style>
{% endblock %}

{% block content %}
<div class="experiment-setup-container">
  <h1>Setup Conclusion Prediction Experiment</h1>
  
  <div class="alert alert-info mb-4">
    <h4>About This Experiment</h4>
    <p>This experiment compares standard LLM predictions with ProEthica enhanced ethical reasoning for engineering ethics case conclusions.</p>
    <p>You will select cases, then the system will generate conclusions using both methods for comparison and evaluation.</p>
  </div>
  
  <form id="setup-form" method="POST" action="{{ url_for('experiment.setup_conclusion_prediction') }}">
    <div class="form-section">
      <h3>Experiment Details</h3>
      <div class="form-group">
        <label for="experiment-name">Experiment Name</label>
        <input type="text" class="form-control" id="experiment-name" name="name" required>
      </div>
      <div class="form-group">
        <label for="experiment-description">Description</label>
        <textarea class="form-control" id="experiment-description" name="description" rows="3"></textarea>
      </div>
    </div>
    
    <div class="form-section">
      <h3>Case Selection</h3>
      <div class="form-group">
        <label for="search-cases">Search Cases</label>
        <input type="text" class="form-control" id="search-cases" placeholder="Enter keywords to filter cases">
      </div>
      
      <div class="case-selection-grid" id="case-grid">
        {% for case in cases %}
        <div class="case-card" data-case-id="{{ case.id }}">
          <div class="form-check">
            <input class="form-check-input case-checkbox" type="checkbox" name="selected_cases" value="{{ case.id }}" id="case-{{ case.id }}">
            <label class="form-check-label" for="case-{{ case.id }}">
              <strong>{{ case.title }}</strong>
            </label>
          </div>
          <small class="text-muted d-block mt-2">{{ case.description|truncate(100) }}</small>
        </div>
        {% endfor %}
      </div>
      
      <div class="selected-cases-container mt-4" id="selected-cases">
        <h4>Selected Cases <span class="badge badge-primary" id="selected-count">0</span></h4>
        <ul class="list-group" id="selected-cases-list">
          <!-- Selected cases will be listed here -->
        </ul>
      </div>
    </div>
    
    <div class="form-section">
      <h3>Prediction Settings</h3>
      <div class="form-group">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="use-ontology" name="use_ontology" checked>
          <label class="form-check-label" for="use-ontology">
            Use ontology constraints for enhanced predictions
          </label>
          <small class="form-text text-muted">ProEthica will use relevant engineering ethics principles from the ontology to guide prediction.</small>
        </div>
      </div>
      
      <div class="form-group">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="use-validation" name="use_validation" checked>
          <label class="form-check-label" for="use-validation">
            Apply bidirectional validation
          </label>
          <small class="form-text text-muted">Predictions will be validated against ontology constraints and ethical principles.</small>
        </div>
      </div>
    </div>
    
    <div class="footer-actions">
      <button type="button" class="btn btn-light" onclick="window.location='{{ url_for('experiment.index') }}'">Cancel</button>
      <button type="submit" class="btn btn-primary" id="run-experiment">Create & Run Experiment</button>
    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle case selection
    const caseCards = document.querySelectorAll('.case-card');
    const selectedCasesList = document.getElementById('selected-cases-list');
    const selectedCountBadge = document.getElementById('selected-count');
    
    updateSelectedCasesList();
    
    caseCards.forEach(card => {
      card.addEventListener('click', function(e) {
        // Don't toggle if clicking on the checkbox directly
        if (e.target.type !== 'checkbox') {
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
        }
        
        // Update UI
        this.classList.toggle('selected', this.querySelector('input[type="checkbox"]').checked);
        updateSelectedCasesList();
      });
    });
    
    // Search functionality
    document.getElementById('search-cases').addEventListener('input', function(e) {
      const searchText = this.value.toLowerCase();
      
      caseCards.forEach(card => {
        const title = card.querySelector('label').innerText.toLowerCase();
        const description = card.querySelector('small').innerText.toLowerCase();
        
        if (title.includes(searchText) || description.includes(searchText)) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    });
    
    // Form validation
    document.getElementById('setup-form').addEventListener('submit', function(e) {
      const selectedCases = document.querySelectorAll('input[name="selected_cases"]:checked');
      
      if (selectedCases.length === 0) {
        e.preventDefault();
        alert('Please select at least one case for the experiment.');
        return false;
      }
      
      if (document.getElementById('experiment-name').value.trim() === '') {
        e.preventDefault();
        alert('Please enter an experiment name.');
        return false;
      }
      
      return true;
    });
    
    function updateSelectedCasesList() {
      const selectedCases = document.querySelectorAll('input[name="selected_cases"]:checked');
      selectedCasesList.innerHTML = '';
      selectedCountBadge.textContent = selectedCases.length;
      
      selectedCases.forEach(checkbox => {
        const caseTitle = checkbox.closest('.case-card').querySelector('label').innerText;
        const listItem = document.createElement('li');
        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        listItem.innerHTML = `
          ${caseTitle}
          <button type="button" class="btn btn-sm btn-outline-danger remove-case" data-case-id="${checkbox.value}">
            Remove
          </button>
        `;
        selectedCasesList.appendChild(listItem);
      });
      
      // Add event listeners to remove buttons
      document.querySelectorAll('.remove-case').forEach(button => {
        button.addEventListener('click', function() {
          const caseId = this.getAttribute('data-case-id');
          const checkbox = document.querySelector(`input[value="${caseId}"]`);
          checkbox.checked = false;
          checkbox.closest('.case-card').classList.remove('selected');
          updateSelectedCasesList();
        });
      });
    }
  });
</script>
{% endblock %}
