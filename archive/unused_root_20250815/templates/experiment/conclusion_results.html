{% extends "base.html" %}

{% block title %}Experiment Results - Conclusion Predictions{% endblock %}

{% block head %}
{{ super() }}
<style>
  .results-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }
  .results-header {
    margin-bottom: 30px;
  }
  .metrics-panel {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
  }
  .metric-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    text-align: center;
  }
  .metric-value {
    font-size: 1.8em;
    font-weight: bold;
    color: #0066cc;
  }
  .metric-label {
    font-size: 0.9em;
    color: #6c757d;
  }
  .case-results {
    margin-bottom: 30px;
  }
  .case-card {
    margin-bottom: 20px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
  }
  .case-header {
    background-color: #f8f9fa;
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
  }
  .case-body {
    padding: 15px;
  }
  .prediction-container {
    margin-top: 15px;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }
  .prediction-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }
  .prediction-tag {
    display: inline-block;
    padding: 0.25em 0.6em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
  }
  .tag-baseline {
    background-color: #e9ecef;
    color: #495057;
  }
  .tag-proethica {
    background-color: #e3f2fd;
    color: #0066cc;
  }
  .highlighted-term {
    background-color: rgba(0, 102, 204, 0.1);
    padding: 0 3px;
    border-radius: 3px;
  }
  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 30px;
  }
  .evaluation-buttons {
    margin-top: 15px;
    display: flex;
    gap: 10px;
  }
  .footer-actions {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }
  .filtered-message {
    padding: 10px;
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    margin-bottom: 10px;
  }
  .ontology-entities {
    margin-top: 10px;
    font-size: 0.9em;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
  }
  .entity-tag {
    display: inline-block;
    background-color: #e9ecef;
    padding: 0.2em 0.6em;
    margin: 0.1em;
    border-radius: 0.25rem;
    font-size: 0.8em;
  }
</style>
{% endblock %}

{% block content %}
<div class="results-container">
  <div class="results-header">
    <h1>Experiment Results: {{ experiment.name }}</h1>
    <p class="text-muted">{{ experiment.description }}</p>
    <div class="mt-3">
      <span class="badge badge-primary">Created: {{ experiment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
      <span class="badge badge-info ml-2">Status: {{ experiment.status.title() }}</span>
      <span class="badge badge-secondary ml-2">Cases: {{ predictions|length if predictions else 0 }}</span>
    </div>
  </div>
  
  <div class="metrics-panel">
    <div class="metric-card">
      <div class="metric-value">{{ experiment.predictions|length }}</div>
      <div class="metric-label">Total Predictions</div>
    </div>
    <div class="metric-card">
      <div class="metric-value">{{ predictions|length if predictions else 0 }}</div>
      <div class="metric-label">Processed Cases</div>
    </div>
    <div class="metric-card">
      <div class="metric-value">{{ completed_percentage }}%</div>
      <div class="metric-label">Completion</div>
    </div>
    <div class="metric-card">
      <div class="metric-value">{{ evaluation_count }}</div>
      <div class="metric-label">Evaluations</div>
    </div>
  </div>
  
  {% if filtered_results %}
  <div class="filtered-message">
    <strong>Note:</strong> Some results are filtered due to low quality or validation failures.
  </div>
  {% endif %}
  
  <div class="case-results">
    <h2>Case Results</h2>
    
    {% for case_id, predictions in predictions.items() %}
    <div class="case-card">
      <div class="case-header">
        <h3>{{ documents[case_id].title }}</h3>
        <div class="text-muted">Document ID: {{ case_id }}</div>
      </div>
      <div class="case-body">
        <div class="accordion" id="accordion-case-{{ case_id }}">
          <div class="card">
            <div class="card-header" id="heading-case-{{ case_id }}">
              <h5 class="mb-0">
                <button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapse-case-{{ case_id }}" aria-expanded="false" aria-controls="collapse-case-{{ case_id }}">
                  Show Case Details
                </button>
              </h5>
            </div>
            <div id="collapse-case-{{ case_id }}" class="collapse" aria-labelledby="heading-case-{{ case_id }}" data-parent="#accordion-case-{{ case_id }}">
              <div class="card-body">
                {% if documents[case_id].doc_metadata.document_structure and documents[case_id].doc_metadata.document_structure.sections %}
                  {% for section_id, section in documents[case_id].doc_metadata.document_structure.sections.items() %}
                    <h5>{{ section.type.title() }}</h5>
                    <p>{{ section.content }}</p>
                  {% endfor %}
                {% else %}
                  <p>{{ documents[case_id].content }}</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        {% for prediction in predictions %}
        <div class="prediction-container">
          <div class="prediction-header">
            <h4>{{ prediction.target.title() }} Prediction 
              <span class="prediction-tag {% if prediction.condition == 'baseline' %}tag-baseline{% else %}tag-proethica{% endif %}">
                {{ prediction.condition.title() }}
              </span>
            </h4>
            <div>
              <button class="btn btn-sm btn-outline-primary" type="button" data-toggle="collapse" data-target="#collapse-details-{{ prediction.id }}" aria-expanded="false">
                Show Details
              </button>
            </div>
          </div>
          
          <div class="prediction-content">
            {{ prediction.prediction_text|safe }}
          </div>
          
          {% if prediction.condition == 'proethica' and prediction.meta_info and prediction.meta_info.get('ontology_entities') %}
          <div class="ontology-entities">
            <strong>Ontology Entities:</strong>
            {% for entity in prediction.meta_info.get('mentioned_entities', []) %}
              <span class="entity-tag">{{ entity }}</span>
            {% endfor %}
          </div>
          {% endif %}
          
          <div class="collapse" id="collapse-details-{{ prediction.id }}">
            <div class="card card-body mt-3">
              <h5>Prompt</h5>
              <pre class="p-3 bg-light"><code>{{ prediction.prompt }}</code></pre>
              
              {% if prediction.meta_info %}
              <h5 class="mt-3">Metadata</h5>
              <div class="row">
                <div class="col-md-6">
                  <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      Condition
                      <span class="badge badge-primary badge-pill">{{ prediction.condition }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      Target
                      <span class="badge badge-primary badge-pill">{{ prediction.target }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      Created
                      <span class="badge badge-primary badge-pill">{{ prediction.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </li>
                  </ul>
                </div>
                <div class="col-md-6">
                  <ul class="list-group">
                    {% if prediction.meta_info.validation_metrics %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      Entity Mentions
                      <span class="badge badge-primary badge-pill">{{ prediction.meta_info.validation_metrics.entity_mentions }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      Validation Status
                      <span class="badge {% if prediction.meta_info.validation_metrics.validation_status == 'passed' %}badge-success{% else %}badge-warning{% endif %} badge-pill">
                        {{ prediction.meta_info.validation_metrics.validation_status }}
                      </span>
                    </li>
                    {% endif %}
                    {% if prediction.meta_info.similar_cases %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      Similar Cases
                      <span class="badge badge-primary badge-pill">{{ prediction.meta_info.similar_cases|length }}</span>
                    </li>
                    {% endif %}
                  </ul>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          
          <div class="evaluation-buttons">
            <button class="btn btn-sm btn-outline-success" onclick="location.href='{{ url_for('experiment.evaluate_prediction', prediction_id=prediction.id) }}'">
              Evaluate
            </button>
            <button class="btn btn-sm btn-outline-primary" onclick="location.href='{{ url_for('experiment.compare_predictions', experiment_id=experiment.id, case_id=case_id) }}'">
              Compare
            </button>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>
  
  <div class="pagination-container">
    <nav aria-label="Page navigation">
      <ul class="pagination">
        <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('experiment.view_results', experiment_id=experiment.id, page=current_page-1) }}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        
        {% for page in range(1, total_pages + 1) %}
        <li class="page-item {% if page == current_page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('experiment.view_results', experiment_id=experiment.id, page=page) }}">{{ page }}</a>
        </li>
        {% endfor %}
        
        <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('experiment.view_results', experiment_id=experiment.id, page=current_page+1) }}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
  
  <div class="footer-actions">
    <button class="btn btn-light" onclick="location.href='{{ url_for('experiment.index') }}'">Back to Experiments</button>
    <div>
      <button class="btn btn-outline-primary" onclick="location.href='{{ url_for('experiment.export_results', experiment_id=experiment.id) }}'">Export Results</button>
      <button class="btn btn-primary" onclick="location.href='{{ url_for('experiment.setup_conclusion_prediction') }}'">Create New Experiment</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Highlight ontology terms in prediction text
    const predictions = document.querySelectorAll('.prediction-container');
    
    predictions.forEach(container => {
      const entityTags = container.querySelectorAll('.entity-tag');
      const predictionText = container.querySelector('.prediction-content');
      
      if (entityTags.length > 0 && predictionText) {
        let text = predictionText.innerHTML;
        
        entityTags.forEach(tag => {
          const term = tag.textContent;
          // Only highlight if term is substantial (not just a few characters)
          if (term && term.length > 3) {
            const regex = new RegExp(`\\b${term}\\b`, 'gi');
            text = text.replace(regex, `<span class="highlighted-term">$&</span>`);
          }
        });
        
        predictionText.innerHTML = text;
      }
    });
  });
</script>
{% endblock %}
