/**
 * Ontology Diff Viewer JavaScript
 * 
 * This script handles the interaction with the diff viewer interface,
 * allowing users to compare different versions of an ontology.
 */

// Document ready function
document.addEventListener('DOMContentLoaded', function() {
    // Set up diff modal events
    setupDiffModal();
    
    // Set up compare buttons on version list items
    setupCompareButtons();
});

/**
 * Set up the diff modal
 */
function setupDiffModal() {
    // Close button event
    document.getElementById('closeDiffBtn').addEventListener('click', function() {
        document.getElementById('diffModal').classList.remove('show');
        document.getElementById('diffModalBackdrop').style.display = 'none';
    });

    // Footer close button event
    document.getElementById('closeDiffBtnFooter').addEventListener('click', function() {
        document.getElementById('diffModal').classList.remove('show');
        document.getElementById('diffModalBackdrop').style.display = 'none';
    });

    // Format toggle
    document.getElementById('diffFormatToggle').addEventListener('change', function() {
        // If we already have versions selected, reload the diff with the new format
        let fromVersion = document.getElementById('diffFromVersion').value;
        let toVersion = document.getElementById('diffToVersion').value;
        
    if (fromVersion && toVersion) {
        // Log the versions being compared
        console.log(`Comparing versions: ${fromVersion} → ${toVersion}`);
        
        // Validate versions
        fromVersion = fromVersion.toString().trim();
        toVersion = toVersion.toString().trim();
        
        // Reload versions if needed
        if (!fromVersion || !toVersion) {
            console.error('Invalid version selection');
            return;
        }
        
        loadDiff(fromVersion, toVersion);
    }

    });

    // Version selection changes
    document.getElementById('diffFromVersion').addEventListener('change', function() {
        let fromVersion = this.value;
        let toVersion = document.getElementById('diffToVersion').value;
        
    if (fromVersion && toVersion) {
        // Log the versions being compared
        console.log(`Comparing versions: ${fromVersion} → ${toVersion}`);
        
        // Validate versions
        fromVersion = fromVersion.toString().trim();
        toVersion = toVersion.toString().trim();
        
        // Reload versions if needed
        if (!fromVersion || !toVersion) {
            console.error('Invalid version selection');
            return;
        }
        
        loadDiff(fromVersion, toVersion);
    }

    });

    document.getElementById('diffToVersion').addEventListener('change', function() {
        let fromVersion = document.getElementById('diffFromVersion').value;
        let toVersion = this.value;
        
    if (fromVersion && toVersion) {
        // Log the versions being compared
        console.log(`Comparing versions: ${fromVersion} → ${toVersion}`);
        
        // Validate versions
        fromVersion = fromVersion.toString().trim();
        toVersion = toVersion.toString().trim();
        
        // Reload versions if needed
        if (!fromVersion || !toVersion) {
            console.error('Invalid version selection');
            return;
        }
        
        loadDiff(fromVersion, toVersion);
    }

    });
}

/**
 * Set up compare buttons on version list items
 */
function setupCompareButtons() {
    // This will be called whenever the version list is updated
    // Add a mutation observer to the version list to detect when it's updated
    const versionList = document.getElementById('versionList');
    
    // Create a new MutationObserver
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                // Version list was updated, add compare buttons to each item
                addCompareButtonsToVersions();
            }
        });
    });
    
    // Start observing
    observer.observe(versionList, { childList: true });
}

/**
 * Add compare buttons to each version item in the list
 */
function addCompareButtonsToVersions() {
    // Get all version items
    const versionItems = document.querySelectorAll('#versionList li');

    // Remove any existing compare buttons first
    document.querySelectorAll('.compare-version-btn').forEach(btn => {
        btn.remove();
    });

    // Add new compare buttons to each item
    versionItems.forEach((item) => {
        const versionNumber = item.dataset.versionNumber;
        if (!versionNumber) return;
        
        // Create the compare button
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-primary compare-version-btn ms-2';
        btn.textContent = 'Compare';
        btn.title = 'Compare with another version';
        
        // Add click event handler
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showDiffModal(versionNumber);
        });

        // Find where to insert the button (after version info)
        const versionInfo = item.querySelector('.version-info');
        if (versionInfo) {
            versionInfo.appendChild(btn);
        } else {
            // Fallback to append to the item itself
            item.appendChild(btn);
        }
    });

    console.log(`Added compare buttons to ${versionItems.length} version items`);
}

/**
 * Show the diff modal for comparing versions
 * 
 * @param {string} fromVersion - The version number to compare from (optional)
 */
function showDiffModal(fromVersion = null) {
    // Get all available versions from the versionList
    const versions = [];
    document.querySelectorAll('#versionList li').forEach(item => {
        if (item.dataset.versionNumber) {
            versions.push({
                number: item.dataset.versionNumber,
                label: `v${item.dataset.versionNumber} - ${item.querySelector('.version-date').innerText}`
            });
        }
    });
    
    // Sort versions by number (descending)
    versions.sort((a, b) => b.number - a.number);
    
    // Populate the from version dropdown
    const fromSelect = document.getElementById('diffFromVersion');
    fromSelect.innerHTML = '';
    
    versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version.number;
        option.innerText = version.label;
        
        // Select the provided fromVersion if specified
        if (fromVersion && version.number === fromVersion) {
            option.selected = true;
        }
        
        fromSelect.appendChild(option);
    });
    
    // Populate the to version dropdown
    const toSelect = document.getElementById('diffToVersion');
    toSelect.innerHTML = '';
    
    versions.forEach(version => {
        const option = document.createElement('option');
        option.value = version.number;
        option.innerText = version.label;
        
        // Select the newest version by default (first one since we sorted desc)
        if (version === versions[0]) {
            option.selected = true;
        }
        
        toSelect.appendChild(option);
    });
    
    // Show the modal
    document.getElementById('diffModal').classList.add('show');
    document.getElementById('diffModalBackdrop').style.display = 'block';
    
    // Load the diff if versions are selected
    const selectedFromVersion = fromSelect.value;
    const selectedToVersion = toSelect.value;
    
    if (selectedFromVersion && selectedToVersion) {
        loadDiff(selectedFromVersion, selectedToVersion);
    }
}

/**
 * Load and display the diff between two versions
 * 
 * @param {string} fromVersion - The version number to compare from
 * @param {string} toVersion - The version number to compare to
 */
function loadDiff(fromVersion, toVersion) {
    // Show loading indicator
    const diffContent = document.getElementById('diffContent');
    diffContent.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading diff...</p>
        </div>
    `;
    
    // Get the format from the toggle
    const format = document.getElementById('diffFormatToggle').checked ? 'split' : 'unified';
    
    // Make request to the API
    // Check if comparing the same version
    if (fromVersion === toVersion) {
        // Display a message about same version comparison
        diffContent.innerHTML = `
            <div class="alert alert-info">
                <h5>Same Version Selected</h5>
                <p>You have selected the same version for comparison. There are no differences to display.</p>
            </div>
        `;
        // Update metadata
        document.getElementById('diffFromInfo').innerText = 
            `Version ${fromVersion}`;
        document.getElementById('diffToInfo').innerText = 
            `Version ${toVersion} (Same)`;
        // Hide commit message sections
        document.getElementById('diffFromCommitSection').style.display = 'none';
        document.getElementById('diffToCommitSection').style.display = 'none';
        return; // Exit early
    }
    
    
    // Debug URL parameters
    console.log('Loading diff with parameters:', { fromVersion, toVersion, format });
    const currentOntologyId = document.getElementById('currentOntologyId').value || document.body.dataset.ontologyId || '1';
    const url = `/ontology-editor/api/versions/${currentOntologyId}/diff?from=${fromVersion}&to=${toVersion}&format=${format}`;
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}: ${response.statusText}` || "Failed to load diff");
            }
            return response.json();
        })
        .then(data => {
            
            // Validate data structure
            if (!data || !data.diff) {
                diffContent.innerHTML = `
                    <div class="alert alert-danger">
                        <h5>Invalid Response Format</h5>
                        <p>The server response did not contain the expected data format.</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                return;
            }
            
        // Display the diff
            if (format === 'unified') {
                // For unified diff, we need to format it as code
                diffContent.innerHTML = `
                    <pre class="diff-unified">${escapeHtml(data.diff)}</pre>
                `;
            } else {
                // For split diff, it's already HTML
                diffContent.innerHTML = data.diff;
            }
            
            // Update metadata
            document.getElementById('diffFromInfo').innerText = 
                data && data.from_version ? 
                `Version ${data.from_version.number || 'N/A'} - ${formatDate(data.from_version.created_at || null)}` : 
                'Version information unavailable';
                
            document.getElementById('diffToInfo').innerText = 
                data && data.to_version ? 
                `Version ${data.to_version.number || 'N/A'} - ${formatDate(data.to_version.created_at || null)}` : 
                'Version information unavailable';
                
            // Add commit messages if available
            if (data && data.from_version && data.from_version.commit_message) {
                document.getElementById('diffFromCommit').innerText = data.from_version.commit_message;
                document.getElementById('diffFromCommitSection').style.display = 'block';
            } else {
                document.getElementById('diffFromCommitSection').style.display = 'none';
            }
            
            if (data && data.to_version && data.to_version.commit_message) {
                document.getElementById('diffToCommit').innerText = data.to_version.commit_message;
                document.getElementById('diffToCommitSection').style.display = 'block';
            } else {
                document.getElementById('diffToCommitSection').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading diff:', error);
            diffContent.innerHTML = `
                <div class="alert alert-danger">
                    <h5>Error Loading Diff</h5>
                    <p>${error.message}</p>
                    ${error.stack ? `<details><summary>Technical Details</summary><pre>${error.stack}</pre></details>` : ""}
                </div>
                <div class="mt-3">
                    <p><strong>Troubleshooting Suggestions:</strong></p>
                    <ul>
                        <li>Check that the server is running</li>
                        <li>Make sure both versions exist in the database</li>
                        <li>Try refreshing the page and trying again</li>
                    </ul>
                </div>
            `;
        });
}

/**
 * Format a date string
 * 
 * @param {string} dateStr - ISO date string
 * @returns {string} - Formatted date
 */
function formatDate(dateStr) {
    if (!dateStr) return 'Unknown date';
    
    const date = new Date(dateStr);
    return date.toLocaleString();
}

/**
 * Escape HTML special characters
 * 
 * @param {string} html - String that might contain HTML
 * @returns {string} - Escaped string
 */
function escapeHtml(html) {
    const div = document.createElement('div');
    div.textContent = html;
    return div.innerHTML;
}
