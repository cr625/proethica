<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProEthica Ontology Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('ontology_editor.static', filename='css/editor.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
            background-color: #f7f7f7;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            width: 100%;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .header h1 {
            margin: 0;
            color: #2c3e50;
            font-size: 24px;
        }
        
        .controls {
            margin-top: 15px;
        }
        
        .btn {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-group .btn {
            margin-right: 5px;
        }
        
        .view-controls {
            margin-bottom: 15px;
        }
        
        .visualization-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-height: 600px;
            max-height: 800px;
            overflow: auto;
        }
        
        #visualization-network {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        
        /* Visualization-specific styles */
        .node {
            cursor: pointer;
        }
        
        .node rect {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 2px;
            rx: 5px;
            ry: 5px;
        }
        
        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }
        
        .node text {
            font: 12px sans-serif;
            text-anchor: middle;
            dominant-baseline: central;
            pointer-events: none;
        }
        
        .link {
            fill: none;
            stroke: #999;
            stroke-width: 2px;
        }
        
        .type-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }
        
        .filter-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .filter-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* Color coding for entity types */
        .node-bfo rect, .node-type-bfo rect {
            fill: #f5f5f5;
            stroke: #5D4037;
        }
        
        .node-bfo text, .node-type-bfo text {
            fill: #5D4037;
        }
        
        .node-bfo-aligned rect {
            fill: #f5f5f5;
            stroke: #795548;
        }
        
        .node-root rect, .node-type-root rect {
            fill: #E3F2FD;
            stroke: #333;
            stroke-width: 3px;
        }
        
        .node-non-bfo rect {
            fill: #f5f5f5;
            stroke: #2196F3;
        }
        
        .node-type-Role rect {
            fill: #E3F2FD;
            stroke: #1565C0;
        }
        
        .node-type-State rect,
        .node-type-Condition rect {
            fill: #E8F5E9;
            stroke: #2E7D32;
        }
        
        .node-type-Principle rect {
            fill: #FCE4EC;
            stroke: #AD1457;
        }
        
        .node-type-Obligation rect {
            fill: #FFF8E1;
            stroke: #F57F17;
        }
        
        .node-type-Capability rect {
            fill: #E1F5FE;
            stroke: #0277BD;
        }
        
        .node-type-Event rect {
            fill: #FFF3E0;
            stroke: #EF6C00;
        }
        
        .node-type-Action rect {
            fill: #F3E5F5;
            stroke: #6A1B9A;
        }
        
        .node-type-Resource rect {
            fill: #FFEBEE;
            stroke: #C62828;
        }
        
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px;
            border-radius: 4px;
            pointer-events: none;
            max-width: 300px;
            z-index: 100;
            font-size: 13px;
        }
        
        .legend {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            border-radius: 50%;
            border-width: 2px;
            border-style: solid;
        }
    
    /* Header and navbar styles to match main application */
    .header {
        padding-bottom: 20px;
        border-bottom: 1px solid #e5e5e5;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .navbar {
        width: 100%;
        padding: 0;
    }
    
    .navbar-light {
        background-color: transparent;
    }
</style>
</head>
<body>

<div class="header">
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="{{ url_for('ontology_editor.index') }}">ProEthica Ontology</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('ontology_editor.index') }}">Editor</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#">Visualization</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/">Main Application</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </div>
    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1>Ontology Visualization</h1>
                <div class="btn-group">
                    <button class="btn" id="back-to-editor-btn">Back to Editor</button>
                    <button class="btn" id="download-btn"><i class="fas fa-download"></i> Download TTL</button>
                    <button class="btn" id="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
            </div>
            
            <div class="view-controls">
                <button class="btn" id="hierarchical-view-btn">Network View</button>
                <button class="btn" id="categorized-view-btn">Category View</button>
                <button class="btn active" id="simple-view-btn">Simple Tree</button>
            </div>
            
            <div class="type-filter">
                <span>Filter by Type: </span>
                <button class="filter-btn active" data-type="all">All</button>
                <button class="filter-btn" data-type="Role">Roles</button>
                <button class="filter-btn" data-type="Principle">Principles</button>
                <button class="filter-btn" data-type="Obligation">Obligations</button>
                <button class="filter-btn" data-type="State">States</button>
                <button class="filter-btn" data-type="Resource">Resources</button>
                <button class="filter-btn" data-type="Action">Actions</button>
                <button class="filter-btn" data-type="Event">Events</button>
                <button class="filter-btn" data-type="Capability">Capabilities</button>
                <button class="filter-btn" data-type="bfo">BFO Classes</button>
            </div>
            
            <div class="visualization-container">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Note:</strong> For best ontology visualization experience, download the TTL file and open it in:
                    <br>• <a href="https://protege.stanford.edu/" target="_blank">Protégé</a> (desktop application)
                    <br>• <a href="https://service.tib.eu/webvowl/" target="_blank">WebVOWL</a> (online visualization)
                    <br>• <a href="https://github.com/VisualDataWeb/WebVOWL" target="_blank">WebVOWL GitHub</a> (if online version is down)
                </div>
                <div id="visualization-network"></div>
                <div id="simple-hierarchy" style="display: none;">
                    <div id="hierarchy-content"></div>
                </div>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f5f5f5; border-color: #333;"></div>
                    <span>Root</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f5f5f5; border-color: #5D4037;"></div>
                    <span>BFO</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E3F2FD; border-color: #1565C0;"></div>
                    <span>Role</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FCE4EC; border-color: #AD1457;"></div>
                    <span>Principle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFF8E1; border-color: #F57F17;"></div>
                    <span>Obligation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E8F5E9; border-color: #2E7D32;"></div>
                    <span>State</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFEBEE; border-color: #C62828;"></div>
                    <span>Resource</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #FFF3E0; border-color: #EF6C00;"></div>
                    <span>Event</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #F3E5F5; border-color: #6A1B9A;"></div>
                    <span>Action</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #E1F5FE; border-color: #0277BD;"></div>
                    <span>Capability</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global variables
        let ontologyHierarchy = null;
        let currentView = 'simple';  // Default to simple view
        let currentFilter = 'all';
        let maxDepth = 3;
        let network = null;
        let nodes = null;
        let edges = null;
        
        // Color mapping for entity types
        const colorMap = {
            'root': '#E3F2FD',
            'bfo': '#F5F5F5',
            'bfo-aligned': '#E8F5E8',
            'Role': '#E3F2FD',
            'Principle': '#FCE4EC',
            'Obligation': '#FFF8E1',
            'State': '#E8F5E9',
            'Resource': '#FFEBEE',
            'Action': '#F3E5F5',
            'Event': '#FFF3E0',
            'Capability': '#E1F5FE',
            'non-bfo': '#F0F8FF'
        };
        
        // Initialize when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Get ontology ID from URL
            const ontologyId = '{{ ontology_id }}';
            
            // Initialize event handlers
            initializeControls();
            
            // Load the ontology data
            loadOntologyHierarchy(ontologyId);
        });
        
        function initializeControls() {
            // View type toggle
            document.getElementById('hierarchical-view-btn').addEventListener('click', () => {
                switchViewType('hierarchical');
            });
            
            document.getElementById('categorized-view-btn').addEventListener('click', () => {
                switchViewType('categorized');
            });
            
            document.getElementById('simple-view-btn').addEventListener('click', () => {
                switchViewType('simple');
            });
            
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const filterType = btn.getAttribute('data-type');
                    filterByType(filterType);
                    
                    // Update active state
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            // Note: Sidebar controls removed for full-width visualization
            
            // Back to editor button
            document.getElementById('back-to-editor-btn').addEventListener('click', () => {
                window.location.href = `{{ url_for('ontology_editor.index') }}?ontology_id={{ ontology_id }}`;
            });
            
            // Download button
            document.getElementById('download-btn').addEventListener('click', () => {
                window.location.href = `{{ url_for('ontology_editor.api.download_ontology', ontology_id=ontology_id) }}`;
            });
            
            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', () => {
                loadOntologyHierarchy('{{ ontology_id }}');
            });
        }
        
        function loadOntologyHierarchy(ontologyId) {
            // Show loading indicator
            document.getElementById('visualization-network').innerHTML = '<div style="text-align: center; padding: 100px; color: #666;">Loading ontology data...</div>';
            
            // Fetch the hierarchy data from the API
            fetch(`{{ url_for('ontology_editor.api.get_ontology_hierarchy', ontology_id=0) }}`.replace('0', ontologyId))
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Store the data globally
                    ontologyHierarchy = data.hierarchy;
                    
                    // Clear loading indicator
                    document.getElementById('visualization-network').innerHTML = '';
                    
                    // Render the visualization
                    renderVisualization();
                })
                .catch(error => {
                    console.error('Error loading ontology hierarchy:', error);
                    document.getElementById('visualization-network').innerHTML = `
                        <div style="text-align: center; padding: 100px; color: red;">
                            <p><strong>Error loading ontology data:</strong></p>
                            <p>${error.message}</p>
                            <p>Please try refreshing the page or check your connection.</p>
                        </div>
                    `;
                });
        }
        
        function renderVisualization() {
            if (!ontologyHierarchy) return;
            
            if (currentView === 'hierarchical') {
                document.getElementById('visualization-network').style.display = 'block';
                document.getElementById('simple-hierarchy').style.display = 'none';
                renderHierarchicalView();
            } else if (currentView === 'categorized') {
                document.getElementById('visualization-network').style.display = 'block';
                document.getElementById('simple-hierarchy').style.display = 'none';
                renderCategorizedView();
            } else if (currentView === 'simple') {
                document.getElementById('visualization-network').style.display = 'none';
                document.getElementById('simple-hierarchy').style.display = 'block';
                renderSimpleTreeView();
            }
        }
        
        function redrawVisualization() {
            // Clear current visualization
            if (network) {
                network.destroy();
                network = null;
            }
            
            // Redraw
            renderVisualization();
        }
        
        function switchViewType(viewType) {
            // Update button states
            document.getElementById('hierarchical-view-btn').classList.toggle('active', viewType === 'hierarchical');
            document.getElementById('categorized-view-btn').classList.toggle('active', viewType === 'categorized');
            document.getElementById('simple-view-btn').classList.toggle('active', viewType === 'simple');
            
            // Update view
            currentView = viewType;
            redrawVisualization();
        }
        
        function renderSimpleTreeView() {
            if (!ontologyHierarchy) return;
            
            const container = document.getElementById('hierarchy-content');
            container.innerHTML = '<h4>Ontology Class Hierarchy</h4>';
            
            function renderNode(node, level = 0) {
                const indent = '  '.repeat(level);
                const entityType = node.entity_type || node.type;
                const color = colorMap[entityType] || '#333';
                
                const nodeHtml = `
                    <div style="margin-left: ${level * 20}px; margin: 5px 0; padding: 8px; 
                               background: ${color}; border-radius: 4px; border-left: 4px solid ${getDarkerColor(color)};">
                        <strong>${node.name}</strong>
                        ${node.description ? `<br><small style="opacity: 0.8;">${node.description}</small>` : ''}
                        <span style="float: right; font-size: 0.8em; opacity: 0.7;">${entityType}</span>
                    </div>
                `;
                
                container.innerHTML += nodeHtml;
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        renderNode(child, level + 1);
                    });
                }
            }
            
            renderNode(ontologyHierarchy);
        }
        
        function filterByType(filterType) {
            currentFilter = filterType;
            redrawVisualization();
        }
        
        function shouldIncludeNode(node) {
            // Always show root node
            if (node.type === 'root') return true;
            
            // Apply current filter
            if (currentFilter === 'all') return true;
            
            // Filter by entity type or ontology type
            if (currentFilter === 'bfo') {
                return node.type === 'bfo' || node.type === 'bfo-aligned';
            }
            
            // Check if node name contains the filter type (e.g., Role, Condition)
            // or if node has a data-entity-type attribute that matches
            if (node.name.includes(currentFilter) || node.entity_type === currentFilter) {
                return true;
            }
            
            return false;
        }
        
        function processHierarchyForDisplay(rootNode, depth = 0) {
            if (!rootNode) return null;
            
            // Apply depth filter
            if (depth > maxDepth) {
                // Check if this node has children
                if (rootNode.children && rootNode.children.length > 0) {
                    // Mark as collapsed but don't process children
                    return { ...rootNode, _children: rootNode.children, children: null };
                }
                return rootNode;
            }
            
            // Process children recursively
            if (rootNode.children && rootNode.children.length > 0) {
                const processedChildren = rootNode.children
                    .map(child => processHierarchyForDisplay(child, depth + 1))
                    .filter(Boolean); // Remove null items
                
                if (processedChildren.length === 0) {
                    // No children after filtering
                    return { ...rootNode, children: null };
                }
                
                return { ...rootNode, children: processedChildren };
            }
            
            return rootNode;
        }
        
        function renderHierarchicalView() {
            if (!ontologyHierarchy) return;
            
            // Check if vis.js is available
            if (typeof vis === 'undefined') {
                document.getElementById('visualization-network').innerHTML = 
                    '<div style="text-align: center; padding: 100px; color: red;">Visualization library not loaded. Please try the Simple Tree view instead.</div>';
                return;
            }
            
            // Convert hierarchy to vis.js format
            const visData = convertHierarchyToVisFormat(ontologyHierarchy);
            
            // Create vis.js network
            const container = document.getElementById('visualization-network');
            
            const options = {
                layout: {
                    hierarchical: {
                        direction: 'UD',        // Up-Down
                        sortMethod: 'directed',
                        levelSeparation: 150,
                        nodeSpacing: 300,
                        treeSpacing: 400,
                        blockShifting: true,
                        edgeMinimization: true,
                        parentCentralization: true
                    }
                },
                physics: {
                    enabled: false  // Disable physics for hierarchical layout
                },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    size: 30,
                    widthConstraint: {
                        minimum: 120,
                        maximum: 250
                    },
                    heightConstraint: {
                        minimum: 40,
                        maximum: 60
                    },
                    font: {
                        size: 14,
                        face: 'Arial, sans-serif',
                        color: '#333'
                    },
                    borderWidth: 2,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.3)',
                        size: 8,
                        x: 3,
                        y: 3
                    }
                },
                edges: {
                    arrows: {
                        to: { enabled: true, scaleFactor: 1.2, type: 'arrow' }
                    },
                    color: '#848484',
                    width: 3,
                    smooth: {
                        enabled: false  // Use straight lines for clearer hierarchy
                    }
                },
                interaction: {
                    dragNodes: true,
                    zoomView: true,
                    dragView: true
                }
            };
            
            network = new vis.Network(container, visData, options);
            
            // Fit the network to the container after a short delay
            setTimeout(() => {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }, 100);
            
            // Add click event for node details
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const nodeData = visData.nodes.get(nodeId);
                    showNodeDetails(nodeData);
                }
            });
        }
        
        function convertHierarchyToVisFormat(hierarchy) {
            const nodes = [];
            const edges = [];
            let nodeId = 1;
            
            function processNode(node, parentId = null) {
                const currentId = nodeId++;
                
                // Determine node color based on type
                const entityType = node.entity_type || node.type;
                const color = colorMap[entityType] || '#F0F8FF';
                
                nodes.push({
                    id: currentId,
                    label: node.name,
                    title: node.description || node.name,
                    color: {
                        background: color,
                        border: getDarkerColor(color),
                        highlight: {
                            background: getLighterColor(color),
                            border: getDarkerColor(color)
                        }
                    },
                    font: {
                        size: node.type === 'root' ? 14 : 12,
                        color: '#333'
                    },
                    originalData: node
                });
                
                if (parentId !== null) {
                    edges.push({
                        from: parentId,
                        to: currentId,
                        label: 'subClassOf'
                    });
                }
                
                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        processNode(child, currentId);
                    });
                }
            }
            
            processNode(hierarchy);
            
            return {
                nodes: new vis.DataSet(nodes),
                edges: new vis.DataSet(edges)
            };
        }
        
        function getDarkerColor(hexColor) {
            // Simple function to get a darker version of a hex color
            const hex = hexColor.replace('#', '');
            const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - 40);
            const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - 40);
            const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - 40);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        function getLighterColor(hexColor) {
            // Simple function to get a lighter version of a hex color
            const hex = hexColor.replace('#', '');
            const r = Math.min(255, parseInt(hex.substr(0, 2), 16) + 20);
            const g = Math.min(255, parseInt(hex.substr(2, 2), 16) + 20);
            const b = Math.min(255, parseInt(hex.substr(4, 2), 16) + 20);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
        
        function showNodeDetails(nodeData) {
            const details = nodeData.originalData;
            let html = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: white; border: 2px solid #ddd; border-radius: 8px; 
                           padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000; max-width: 400px;">
                    <h4>${details.name}</h4>
                    ${details.description ? `<p><strong>Description:</strong> ${details.description}</p>` : ''}
                    ${details.uri ? `<p><strong>URI:</strong> <small>${details.uri}</small></p>` : ''}
                    <p><strong>Type:</strong> ${details.entity_type || details.type}</p>
                    <button onclick="this.parentElement.remove()" style="float: right; margin-top: 10px;">Close</button>
                </div>
                <div onclick="this.remove(); this.previousElementSibling.remove();" 
                     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                           background: rgba(0,0,0,0.5); z-index: 999;"></div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function renderCategorizedView() {
            if (!ontologyHierarchy) return;
            
            // Check if vis.js is available
            if (typeof vis === 'undefined') {
                document.getElementById('visualization-network').innerHTML = 
                    '<div style="text-align: center; padding: 100px; color: red;">Visualization library not loaded. Please try the Simple Tree view instead.</div>';
                return;
            }
            
            // Create categorized hierarchy
            const categorizedData = createCategorizedHierarchy(ontologyHierarchy);
            const visData = convertHierarchyToVisFormat(categorizedData);
            
            // Create vis.js network with different layout for categories
            const container = document.getElementById('visualization-network');
            
            const options = {
                layout: {
                    hierarchical: {
                        direction: 'UD',
                        sortMethod: 'directed',
                        levelSeparation: 100,
                        nodeSpacing: 150,
                        treeSpacing: 200
                    }
                },
                physics: {
                    hierarchicalRepulsion: {
                        centralGravity: 0.0,
                        springLength: 80,
                        springConstant: 0.01,
                        nodeDistance: 100,
                        damping: 0.09
                    },
                    maxVelocity: 50,
                    solver: 'hierarchicalRepulsion'
                },
                nodes: {
                    shape: 'box',
                    margin: 10,
                    widthConstraint: {
                        minimum: 80,
                        maximum: 200
                    },
                    font: {
                        size: 11,
                        face: 'arial'
                    },
                    borderWidth: 2
                },
                edges: {
                    arrows: {
                        to: { enabled: true, scaleFactor: 0.8, type: 'arrow' }
                    },
                    color: '#848484',
                    width: 1
                },
                interaction: {
                    dragNodes: true,
                    zoomView: true,
                    dragView: true
                }
            };
            
            network = new vis.Network(container, visData, options);
            
            // Fit the network to the container after a short delay
            setTimeout(() => {
                network.fit({
                    animation: {
                        duration: 1000,
                        easingFunction: 'easeInOutQuad'
                    }
                });
            }, 100);
            
            // Add click event for node details
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const nodeData = visData.nodes.get(nodeId);
                    showNodeDetails(nodeData);
                }
            });
        }
        
        function createCategorizedHierarchy(originalHierarchy) {
            // Create a simplified categorized view
            const categories = {
                'Role': { name: 'Roles', type: 'category', children: [] },
                'Principle': { name: 'Principles', type: 'category', children: [] },
                'Obligation': { name: 'Obligations', type: 'category', children: [] },
                'State': { name: 'States', type: 'category', children: [] },
                'Resource': { name: 'Resources', type: 'category', children: [] },
                'Action': { name: 'Actions', type: 'category', children: [] },
                'Event': { name: 'Events', type: 'category', children: [] },
                'Capability': { name: 'Capabilities', type: 'category', children: [] }
            };
            
            function categorizeNodes(node) {
                if (node.children) {
                    node.children.forEach(categorizeNodes);
                }
                
                const entityType = node.entity_type || node.type;
                if (categories[entityType]) {
                    categories[entityType].children.push(node);
                }
            }
            
            if (originalHierarchy.children) {
                originalHierarchy.children.forEach(categorizeNodes);
            }
            
            return {
                name: originalHierarchy.name,
                type: 'root',
                children: Object.values(categories).filter(cat => cat.children.length > 0)
            };
        }
        
        function expandAll() {
            if (network) {
                network.fit();
            }
        }
        
        function collapseAll() {
            if (network) {
                network.fit();
            }
        }
        
        function applyZoom(zoomLevel) {
            if (network) {
                network.setOptions({
                    physics: { enabled: zoomLevel > 1 }
                });
            }
        }
    </script>
</body>
</html>
