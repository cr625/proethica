<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ontology Visualization</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('ontology_editor.static', filename='css/hierarchy.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('ontology_editor.index') }}">BFO Ontology Editor</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('ontology_editor.index') }}?ontology_id={{ ontology_id }}">Editor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Visualization</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="visualizationTitle">Ontology Hierarchy</h5>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" id="expandAllBtn">
                                <i class="bi bi-arrows-expand"></i> Expand All
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="collapseAllBtn">
                                <i class="bi bi-arrows-collapse"></i> Collapse All
                            </button>
                            <button class="btn btn-sm btn-outline-dark" id="backToEditorBtn">
                                <i class="bi bi-pencil"></i> Back to Editor
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Visualization Main Section - Using full width now -->
            <div class="col-12">
                <div class="card">
                    <div class="card-body p-0">
                        <div id="hierarchyContainer">
                            <div id="loadingIndicator" class="text-center p-5">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3">Loading ontology hierarchy...</p>
                            </div>
                            <div id="hierarchyTree" style="height: 700px; overflow: auto; border: 1px solid #ccc;"></div>
                        </div>
                    </div>
                </div>

                <!-- Entity Details Panel -->
                <div class="card mt-3" id="entityDetailsCard" style="display: none;">
                    <div class="card-header">
                        <h5 class="mb-0">Entity Details</h5>
                    </div>
                    <div class="card-body">
                        <div id="entityDetails">
                            <!-- Entity details will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store the ontology ID from the template
        const ontologyId = "{{ ontology_id }}";
        console.log("Loading ontology with ID:", ontologyId);
        
        // Add loading indicator
        function showLoadingIndicator(message = "Loading ontology hierarchy...") {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.innerHTML = `
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">${message}</p>
            `;
            loadingIndicator.style.display = 'block';
            document.getElementById('hierarchyTree').style.display = 'none';
        }
        
        // Add error display
        function showError(message) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            loadingIndicator.innerHTML = `
                <div class="alert alert-danger">
                    ${message}
                </div>
            `;
            loadingIndicator.style.display = 'block';
            document.getElementById('hierarchyTree').style.display = 'none';
        }
        
        // Function to fetch and visualize the ontology
        function loadOntologyHierarchy(ontologyId) {
            console.log("Fetching hierarchy for ontology ID:", ontologyId);
            showLoadingIndicator();
            
            // Fetch the ontology hierarchy
            fetch(`/ontology-editor/api/hierarchy/${ontologyId}`)
                .then(response => {
                    console.log("API response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received hierarchy data:", data);
                    
                    // Use the hierarchy data to create the visualization
                    if (data.hierarchy) {
                        // Create the visualization
                        visualizeHierarchy(data.hierarchy);
                        
                        // Update the title
                        const title = data.ontology.name || data.hierarchy.name || "Ontology";
                        document.getElementById('visualizationTitle').innerText = `Ontology Hierarchy: ${title}`;
                        
                        // Hide loading indicator and show the hierarchy
                        document.getElementById('loadingIndicator').style.display = 'none';
                        document.getElementById('hierarchyTree').style.display = 'block';
                    } else {
                        showError("No hierarchy data found in API response");
                    }
                })
                .catch(error => {
                    console.error("Error fetching hierarchy:", error);
                    showError(`Error loading hierarchy: ${error.message}`);
                });
        }
        
        // Visualize the hierarchy using D3.js
        function visualizeHierarchy(data) {
            console.log("Visualizing hierarchy:", data);
            
            // Clear previous visualization
            const hierarchyTree = document.getElementById('hierarchyTree');
            hierarchyTree.innerHTML = '';
            
            // Set background color for the container
            hierarchyTree.style.backgroundColor = '#f8f9fa';
            hierarchyTree.style.padding = '20px';
            
            // Create a simple indented list layout
            function createIndentedList(data) {
                const list = document.createElement('ul');
                list.className = 'ontology-list';
                list.style.listStyle = 'none';
                list.style.padding = '0';
                list.style.margin = '0';
                
                // Recursively build the list with proper nesting
                function buildList(node, parentElement, level = 0) {
                    // Create a list item for this node
                    const item = document.createElement('li');
                    item.style.padding = '5px 0';
                    
                    // Create the item content
                    const itemContent = document.createElement('div');
                    itemContent.className = `node-item ${node.type || ''}`;
                    itemContent.style.display = 'flex';
                    itemContent.style.alignItems = 'center';
                    
                    // Add a circle indicator
                    const circle = document.createElement('span');
                    circle.className = `circle ${node.type || ''}`;
                    circle.style.display = 'inline-block';
                    circle.style.width = '10px';
                    circle.style.height = '10px';
                    circle.style.borderRadius = '50%';
                    circle.style.marginRight = '8px';
                    
                    // Set circle color based on node type
                    switch(node.type) {
                        case 'bfo':
                            circle.style.backgroundColor = '#007bff';
                            break;
                        case 'bfo-aligned':
                            circle.style.backgroundColor = '#28a745';
                            break;
                        case 'non-bfo':
                            circle.style.backgroundColor = '#ffc107';
                            break;
                        case 'property':
                            circle.style.backgroundColor = '#17a2b8';
                            break;
                        case 'individual':
                            circle.style.backgroundColor = '#6c757d';
                            break;
                        default:
                            circle.style.backgroundColor = '#343a40';
                    }
                    
                    // Add the node name
                    const text = document.createElement('span');
                    text.textContent = node.name;
                    text.style.fontWeight = node.children && node.children.length > 0 ? 'bold' : 'normal';
                    
                    // Combine elements
                    itemContent.appendChild(circle);
                    itemContent.appendChild(text);
                    item.appendChild(itemContent);
                    
                    // Add this item to the parent element
                    parentElement.appendChild(item);
                    
                    // If this node has children, create a nested list for them
                    if (node.children && node.children.length > 0) {
                        const childList = document.createElement('ul');
                        childList.style.listStyle = 'none';
                        childList.style.padding = '0';
                        childList.style.margin = '0';
                        childList.style.marginLeft = '20px'; // Indentation for children
                        
                        // Add each child to this node's child list
                        node.children.forEach(child => {
                            buildList(child, childList, level + 1);
                        });
                        
                        // Add the child list to this item
                        item.appendChild(childList);
                    }
                }
                
                // Build the list starting with the root
                buildList(data, list);
                
                return list;
            }
            
            // Create the list and add it to the DOM
            const listView = createIndentedList(data);
            hierarchyTree.appendChild(listView);
            
            console.log("Visualization complete");
        }
        
        // When document is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM content loaded, setting up visualization");
            
            // Make the ontology ID available globally
            window.ontologyId = "{{ ontology_id }}";
            console.log("Set window.ontologyId to:", window.ontologyId);
            
            // Load the ontology hierarchy
            if (ontologyId) {
                loadOntologyHierarchy(ontologyId);
            } else {
                showError("No ontology ID provided. Please select an ontology from the editor.");
            }
            
            // Event listeners for buttons
            document.getElementById('backToEditorBtn').addEventListener('click', function() {
                window.location.href = '/ontology-editor/?ontology_id={{ ontology_id }}';
            });
            
            // Apply filters button
            document.getElementById('applyFiltersBtn').addEventListener('click', function() {
                // Add filter functionality here
                console.log("Filters applied");
            });
            
            // Expand all button
            document.getElementById('expandAllBtn').addEventListener('click', function() {
                console.log("Expand all clicked");
                // Add expand all functionality here
            });
            
            // Collapse all button
            document.getElementById('collapseAllBtn').addEventListener('click', function() {
                console.log("Collapse all clicked");
                // Add collapse all functionality here
            });
        });
    </script>
</body>

</html>
