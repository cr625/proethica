{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 3: Temporal Dynamics Pass - Facts Section{% endblock %}
{% block step_header %}Step 3: Temporal Dynamics Pass (Facts){% endblock %}
{% block step_subtitle %}Extract actions and events from the facts section with Allen's Interval Algebra and causal relationships{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Step 2
    </a>
    <div>
        <a href="{{ url_for('entity_review.review_case_entities', case_id=case.id) }}" class="btn btn-info me-2">
            <i class="bi bi-list-check"></i> Review All Entities
        </a>
        <a href="{{ url_for('scenario_pipeline.complete_analysis', case_id=case.id) }}" class="btn btn-success">
            Complete Analysis <i class="bi bi-cogs"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-text"></i> Facts Section
        </h4>
    </div>
    <div class="step-content">
        {% if discussion_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="discussion-text">{{ discussion_section.llm_text }}</pre>
        </div>

        <!-- Full Temporal Dynamics Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
            <button id="temporalPassBtn" class="btn btn-warning btn-lg" onclick="executeFullTemporalPass()">
                <i class="bi bi-clock-history"></i> Extract Actions & Events (Pass 3)
            </button>
            <button id="enhancedTemporalBtn" class="btn btn-success btn-lg" onclick="executeEnhancedTemporalPass()">
                <i class="bi bi-stars"></i> Enhanced Temporal (Beta)
            </button>
        </div>

        <!-- Temporal Pass Results Container -->
        <div id="temporalPassResults" style="display: none;" class="mb-4"></div>

        <!-- Enhanced Temporal Progress Container -->
        <div id="enhancedTemporalProgress" class="card mb-4" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i id="enhanced-progress-icon" class="bi bi-hourglass-split"></i>
                    <span id="enhanced-progress-header">Enhanced Temporal Extraction Progress</span>
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 25px;">
                    <div id="enhanced-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar" style="width: 0%">0%</div>
                </div>

                <!-- Current Stage Info -->
                <div id="enhanced-stage-info" class="alert alert-info mb-3" style="display: none;">
                    <strong>Current Stage:</strong> <span id="enhanced-current-stage">Initializing...</span>
                </div>

                <!-- Extraction Log -->
                <div class="card mb-3">
                    <div class="card-header" style="cursor: pointer;" onclick="toggleEnhancedLog()">
                        <i id="log-toggle-icon" class="bi bi-chevron-down"></i>
                        <strong>Extraction Log</strong>
                        <span class="badge bg-secondary ms-2" id="log-count">0 messages</span>
                    </div>
                    <div id="enhanced-messages" class="card-body" style="max-height: 400px; overflow-y: auto; display: block;">
                        <em class="text-muted">Waiting for extraction to start...</em>
                    </div>
                </div>

                <!-- Summary Section (shown on completion) -->
                <div id="enhanced-summary" class="card mb-3" style="display: none;">
                    <div class="card-header bg-success bg-opacity-10">
                        <strong><i class="bi bi-check-circle text-success"></i> Extraction Summary</strong>
                    </div>
                    <div class="card-body" id="enhanced-summary-content">
                    </div>
                </div>

                <button id="enhanced-refresh-btn" class="btn btn-success mt-3" style="display: none;" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh to See Results
                </button>
            </div>
        </div>

        <!-- Saved Extraction Display (shows on page reload if extraction exists) -->
        <div id="actionsEventsRawResponse" class="step-card" style="display: none;">
            <div class="step-header bg-success bg-opacity-10">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle text-success"></i> Previous Extraction Results
                </h5>
            </div>
            <div class="step-content">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    This extraction has already been performed. Results are saved and available in the entity review page.
                </div>
                <div id="actionsEventsRawResponseContent"></div>
            </div>
        </div>

        {% else %}
        <div class="alert alert-warning">No facts section found.</div>
        {% endif %}

        <!-- Allen's Interval Algebra Reference -->
        <div class="step-card border-info mb-4">
            <div class="step-header bg-info bg-opacity-10">
                <h5 class="mb-0"><i class="bi bi-diagram-3 text-info"></i> Allen's Interval Algebra Reference</h5>
            </div>
            <div class="step-content">
                <div class="alert alert-light">
                    <h6>Temporal Relations Used in Extraction:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="mb-0">
                                <li><strong>before:</strong> A finishes before B starts</li>
                                <li><strong>after:</strong> A starts after B finishes</li>
                                <li><strong>meets:</strong> A finishes exactly when B starts</li>
                                <li><strong>overlaps:</strong> A and B partially overlap</li>
                                <li><strong>during:</strong> A occurs completely within B</li>
                                <li><strong>starts:</strong> A and B start together, A finishes first</li>
                                <li><strong>finishes:</strong> A and B finish together, A starts later</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="mb-0">
                                <li><strong>equals:</strong> A and B have same start and end times</li>
                                <li><strong>contains:</strong> A contains B completely</li>
                                <li><strong>started-by:</strong> B starts with A, B finishes after A</li>
                                <li><strong>finished-by:</strong> B finishes with A, B starts before A</li>
                                <li><strong>met-by:</strong> B finishes exactly when A starts</li>
                                <li><strong>overlapped-by:</strong> B and A partially overlap (B first)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation to entity review -->
<div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
    <a href="{{ url_for('entity_review.review_case_entities_pass3', case_id=case.id) }}" class="btn btn-outline-primary">
        <i class="bi bi-eye"></i> Review Pass 3 Entities
    </a>
</div>

{% endblock %}

{% block step_styles %}
<style>
    .discussion-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: none;
        margin: 0;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    /* Temporal Pass Button Styling */
    #temporalPassBtn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    #temporalPassBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    #temporalPassBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    /* Extractor Section Styling */
    .extractor-section {
        margin-bottom: 1.5rem;
    }

    .extractor-section .step-card {
        border-width: 2px;
    }

    .extractor-section .step-header {
        border-bottom: 2px solid;
        padding: 1rem;
    }

    .extractor-section .step-content {
        padding: 1.5rem;
    }

    /* Prompt Preview Styling */
    .prompt-preview {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.75rem;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Results Container Styling */
    .results-container {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .raw-response-container {
        background: #e8f4fd;
        border: 1px solid #0d6efd;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .metadata-container {
        background: #f8f9fa;
        border: 1px solid #6c757d;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    /* Concept Item Styling */
    .concept-item {
        background: white;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }

    .concept-item.action-class {
        border-left-color: #28a745;
    }

    .concept-item.action-individual {
        border-left-color: #20c997;
    }

    .concept-item.event-class {
        border-left-color: #ffc107;
    }

    .concept-item.event-individual {
        border-left-color: #fd7e14;
    }

    .concept-label {
        font-weight: bold;
        color: #333;
    }

    .concept-description {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }

    .concept-metadata {
        font-size: 0.8rem;
        color: #999;
        margin-top: 0.5rem;
    }

    .raw-response-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        background-color: #ffffff;
        border: 1px solid #0d6efd;
        border-radius: 0.25rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Allen Algebra Reference */
    .alert-light {
        background-color: #fefefe;
        border-color: #fdfdfe;
        color: #495057;
    }

    /* Loading states */
    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }

    .badge-action-class {
        background-color: #28a745 !important;
    }

    .badge-action-individual {
        background-color: #20c997 !important;
    }

    .badge-event-class {
        background-color: #ffc107 !important;
        color: #000 !important;
    }

    .badge-event-individual {
        background-color: #fd7e14 !important;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
    let currentSectionText = '';
    let currentCaseId = {{ case.id }};

    // Initialize section text and load saved raw response
    document.addEventListener('DOMContentLoaded', function () {
        const discussionTextElement = document.querySelector('.discussion-text');
        if (discussionTextElement) {
            currentSectionText = discussionTextElement.textContent.trim();
        }

        // Load saved raw response for actions_events
        loadSavedRawResponse();
    });

    function loadSavedRawResponse() {
        // Fetch saved extraction prompt and raw response
        fetch(`/scenario_pipeline/case/${currentCaseId}/step3/get_saved_prompt?concept_type=actions_events`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.raw_response) {
                    // Display the prompt and raw response
                    const rawResponseDiv = document.getElementById('actionsEventsRawResponse');
                    const rawResponseContent = document.getElementById('actionsEventsRawResponseContent');

                    if (rawResponseDiv && rawResponseContent) {
                        let html = '<div class="mb-4">';

                        // Show prompt if available
                        if (data.prompt_text) {
                            html += `
                                <div class="mb-3">
                                    <h6><i class="bi bi-file-text"></i> Extraction Prompt</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <pre class="mb-0" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 0.85rem;">${escapeHtml(data.prompt_text)}</pre>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }

                        // Show response
                        html += `
                            <div class="mb-3">
                                <h6><i class="bi bi-code-square"></i> LLM Response</h6>
                                <div class="card">
                                    <div class="card-body">
                                        <pre class="mb-0" style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; font-size: 0.85rem;">${escapeHtml(data.raw_response)}</pre>
                                    </div>
                                </div>
                            </div>
                        `;

                        // Show metadata
                        if (data.created_at || data.llm_model) {
                            html += `
                                <div class="small text-muted">
                                    ${data.created_at ? `<div><strong>Extracted:</strong> ${data.created_at}</div>` : ''}
                                    ${data.llm_model ? `<div><strong>Model:</strong> ${data.llm_model}</div>` : ''}
                                </div>
                            `;
                        }

                        html += '</div>';

                        rawResponseContent.innerHTML = html;
                        rawResponseDiv.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.log('No saved raw response found or error loading:', error);
            });
    }

    function executeFullTemporalPass() {
        // This calls the original behavioral_pass_execute endpoint
        const temporalBtn = document.getElementById('temporalPassBtn');
        const resultsArea = document.getElementById('temporalPassResults');

        // Disable the button and show loading
        temporalBtn.disabled = true;
        temporalBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Executing Temporal Pass...';

        // Show results area
        if (resultsArea) {
            resultsArea.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Executing temporal dynamics pass...</div>';
            resultsArea.style.display = 'block';
        }

        // Call the existing endpoint with required concept_type parameter
        fetch(`/scenario_pipeline/case/${currentCaseId}/step3/extract`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                concept_type: 'actions_events'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display results instead of redirecting
                displayTemporalPassResults(data);
            } else {
                if (resultsArea) {
                    resultsArea.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Error: ${data.error}</div>`;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (resultsArea) {
                resultsArea.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Network error: ${error.message}</div>`;
            }
        })
        .finally(() => {
            // Re-enable the button
            temporalBtn.disabled = false;
            temporalBtn.innerHTML = '<i class="bi bi-clock-history"></i> Extract Actions & Events (Pass 3)';
        });
    }

    function displayTemporalPassResults(data) {
        const resultsArea = document.getElementById('temporalPassResults');
        if (!resultsArea) return;

        // Extract metadata
        const metadata = data.metadata || {};
        const conceptCounts = metadata.concept_counts || {};
        const totalConcepts = conceptCounts.total || (data.concepts ? data.concepts.length : 0);

        let html = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Temporal dynamics pass completed successfully!
                    Extracted ${totalConcepts} entities (${conceptCounts.action_classes || 0} action classes,
                    ${conceptCounts.action_individuals || 0} action individuals,
                    ${conceptCounts.event_classes || 0} event classes,
                    ${conceptCounts.event_individuals || 0} event individuals)</div>`;

        // Prompt and Response (dual extractor format)
        if (data.prompt || data.raw_response) {
            html += `<div class="card mb-3"><div class="card-header bg-light"><h6 class="mb-0"><i class="bi bi-file-text"></i> Extraction Details</h6></div><div class="card-body">`;

            // Prompt
            if (data.prompt) {
                html += `
                    <div class="mb-3">
                        <h6 class="text-info"><i class="bi bi-clock-history"></i> Temporal Dynamics Extraction Prompt</h6>
                        <pre class="bg-light p-3 border rounded" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">${escapeHtml(data.prompt)}</pre>
                    </div>
                `;
            }

            // Raw Response
            if (data.raw_response) {
                html += `
                    <div>
                        <h6 class="text-success"><i class="bi bi-code-square"></i> LLM Response</h6>
                        <pre class="bg-light p-3 border rounded" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap;">${escapeHtml(data.raw_response)}</pre>
                    </div>
                `;
            }

            html += `</div></div>`;
        }

        // Display extracted concepts grouped by type
        if (data.concepts && data.concepts.length > 0) {
            // Group concepts by type
            const actionClasses = data.concepts.filter(c => c.type === 'action_class');
            const actionIndividuals = data.concepts.filter(c => c.type === 'action_individual');
            const eventClasses = data.concepts.filter(c => c.type === 'event_class');
            const eventIndividuals = data.concepts.filter(c => c.type === 'event_individual');

            // Action Classes
            if (actionClasses.length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-warning bg-opacity-10">
                            <h6 class="mb-0"><i class="bi bi-sitemap text-warning"></i> Action Classes (${actionClasses.length})</h6>
                        </div>
                        <div class="card-body">
                `;
                actionClasses.forEach(concept => {
                    html += `
                        <div class="concept-item mb-3 p-3 border-start border-warning border-3">
                            <h6>${escapeHtml(concept.label)}</h6>
                            <p>${escapeHtml(concept.description)}</p>
                            <div class="small text-muted">
                                <div><strong>Category:</strong> ${escapeHtml(concept.category)}</div>
                                <div><strong>Confidence:</strong> ${(concept.confidence * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Action Individuals
            if (actionIndividuals.length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-warning bg-opacity-25">
                            <h6 class="mb-0"><i class="bi bi-play-circle text-warning"></i> Action Individuals (${actionIndividuals.length})</h6>
                        </div>
                        <div class="card-body">
                `;
                actionIndividuals.forEach(concept => {
                    html += `
                        <div class="concept-item mb-3 p-3 border-start border-warning border-3">
                            <h6>${escapeHtml(concept.label)}</h6>
                            <p>${escapeHtml(concept.description)}</p>
                            <div class="small text-muted">
                                <div><strong>Class:</strong> ${escapeHtml(concept.category)}</div>
                                <div><strong>Confidence:</strong> ${(concept.confidence * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Event Classes
            if (eventClasses.length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-info bg-opacity-10">
                            <h6 class="mb-0"><i class="bi bi-sitemap text-info"></i> Event Classes (${eventClasses.length})</h6>
                        </div>
                        <div class="card-body">
                `;
                eventClasses.forEach(concept => {
                    html += `
                        <div class="concept-item mb-3 p-3 border-start border-info border-3">
                            <h6>${escapeHtml(concept.label)}</h6>
                            <p>${escapeHtml(concept.description)}</p>
                            <div class="small text-muted">
                                <div><strong>Category:</strong> ${escapeHtml(concept.category)}</div>
                                <div><strong>Confidence:</strong> ${(concept.confidence * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // Event Individuals
            if (eventIndividuals.length > 0) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-info bg-opacity-25">
                            <h6 class="mb-0"><i class="bi bi-calendar-event text-info"></i> Event Individuals (${eventIndividuals.length})</h6>
                        </div>
                        <div class="card-body">
                `;
                eventIndividuals.forEach(concept => {
                    html += `
                        <div class="concept-item mb-3 p-3 border-start border-info border-3">
                            <h6>${escapeHtml(concept.label)}</h6>
                            <p>${escapeHtml(concept.description)}</p>
                            <div class="small text-muted">
                                <div><strong>Class:</strong> ${escapeHtml(concept.category)}</div>
                                <div><strong>Confidence:</strong> ${(concept.confidence * 100).toFixed(0)}%</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
        }

        // Metadata
        if (data.extraction_metadata) {
            html += `
                <div class="card mb-3">
                    <div class="card-header bg-secondary bg-opacity-10">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Extraction Metadata</h6>
                    </div>
                    <div class="card-body">
                        <div class="small">
                            ${data.extraction_metadata.extraction_method ? `<div><strong>Method:</strong> ${escapeHtml(data.extraction_metadata.extraction_method)}</div>` : ''}
                            ${data.extraction_metadata.model_used ? `<div><strong>Model:</strong> ${escapeHtml(data.extraction_metadata.model_used)}</div>` : ''}
                            ${data.extraction_metadata.timestamp ? `<div><strong>Timestamp:</strong> ${escapeHtml(data.extraction_metadata.timestamp)}</div>` : ''}
                            ${data.extraction_metadata.provenance_tracked !== undefined ? `<div><strong>Provenance Tracked:</strong> ${data.extraction_metadata.provenance_tracked ? 'Yes' : 'No'}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        resultsArea.innerHTML = html;
        resultsArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    async function extractIndividualConcept(conceptType) {
        if (conceptType !== 'actions_events') {
            console.error('Only actions_events concept type supported');
            return;
        }

        const section = document.getElementById('actionsEventsSection');
        const promptDiv = document.getElementById('actionsEventsPrompt');
        const resultsDiv = document.getElementById('actionsEventsResults');
        const rawResponseDiv = document.getElementById('actionsEventsRawResponse');
        const metadataDiv = document.getElementById('actionsEventsMetadata');

        // Show loading
        promptDiv.innerHTML = '<div class="loading-spinner"><div class="spinner-border text-warning" role="status"></div><span class="ms-2">Extracting actions & events...</span></div>';

        // Hide previous results
        resultsDiv.style.display = 'none';
        rawResponseDiv.style.display = 'none';
        metadataDiv.style.display = 'none';

        try {
            const response = await fetch(`/scenario_pipeline/case/${currentCaseId}/step3/extract_individual`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    concept_type: 'actions_events'
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
                displayActionsEventsResults(data);
            } else {
                displayActionsEventsError(data.error || 'Unknown error');
            }

        } catch (error) {
            console.error('Error during actions/events extraction:', error);
            displayActionsEventsError(error.message);
        }
    }

    function displayActionsEventsResults(data) {
        const promptDiv = document.getElementById('actionsEventsPrompt');
        const resultsDiv = document.getElementById('actionsEventsResults');
        const resultsContent = document.getElementById('actionsEventsResultsContent');
        const rawResponseDiv = document.getElementById('actionsEventsRawResponse');
        const rawResponseContent = document.getElementById('actionsEventsRawResponseContent');
        const metadataDiv = document.getElementById('actionsEventsMetadata');
        const metadataContent = document.getElementById('actionsEventsMetadataContent');

        // Display prompt
        promptDiv.innerHTML = `<div class="prompt-preview">${escapeHtml(data.prompt || 'Prompt not available')}</div>`;

        // Display results
        if (data.concepts && data.concepts.length > 0) {
            let resultsHtml = '';

            // Group by type
            const actionClasses = data.concepts.filter(c => c.type === 'action_class');
            const actionIndividuals = data.concepts.filter(c => c.type === 'action_individual');
            const eventClasses = data.concepts.filter(c => c.type === 'event_class');
            const eventIndividuals = data.concepts.filter(c => c.type === 'event_individual');

            if (actionClasses.length > 0) {
                resultsHtml += `<h6 class="text-success"><i class="bi bi-play-circle"></i> Action Classes (${actionClasses.length})</h6>`;
                actionClasses.forEach(concept => {
                    resultsHtml += createConceptItem(concept, 'action-class');
                });
            }

            if (actionIndividuals.length > 0) {
                resultsHtml += `<h6 class="text-success mt-3"><i class="bi bi-person"></i> Action Individuals (${actionIndividuals.length})</h6>`;
                actionIndividuals.forEach(concept => {
                    resultsHtml += createConceptItem(concept, 'action-individual');
                });
            }

            if (eventClasses.length > 0) {
                resultsHtml += `<h6 class="text-warning mt-3"><i class="bi bi-lightning"></i> Event Classes (${eventClasses.length})</h6>`;
                eventClasses.forEach(concept => {
                    resultsHtml += createConceptItem(concept, 'event-class');
                });
            }

            if (eventIndividuals.length > 0) {
                resultsHtml += `<h6 class="text-warning mt-3"><i class="bi bi-clock"></i> Event Individuals (${eventIndividuals.length})</h6>`;
                eventIndividuals.forEach(concept => {
                    resultsHtml += createConceptItem(concept, 'event-individual');
                });
            }

            resultsContent.innerHTML = resultsHtml;
        } else {
            resultsContent.innerHTML = '<p class="text-muted">No actions or events extracted</p>';
        }

        // Display raw response
        rawResponseContent.innerHTML = `<div class="raw-response-text">${escapeHtml(data.raw_response || 'Raw response not available')}</div>`;

        // Display metadata
        if (data.metadata) {
            const metadata = data.metadata;
            let metadataHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <small><strong>Model:</strong> ${metadata.model_used || 'Unknown'}</small><br>
                        <small><strong>Method:</strong> ${metadata.extraction_method || 'Unknown'}</small><br>
                        <small><strong>Session ID:</strong> ${metadata.session_id || 'Unknown'}</small>
                    </div>
                    <div class="col-md-6">
                        <small><strong>Total Entities:</strong> ${metadata.concept_counts?.total || 0}</small><br>
                        <small><strong>Temporal Relations:</strong> ${metadata.temporal_relationships ? 'Yes' : 'No'}</small><br>
                        <small><strong>Allen Algebra:</strong> ${metadata.allen_algebra ? 'Yes' : 'No'}</small>
                    </div>
                </div>
            `;

            if (metadata.concept_counts) {
                metadataHtml += `
                    <div class="mt-2">
                        <small><strong>Breakdown:</strong>
                        ${metadata.concept_counts.action_classes || 0} Action Classes,
                        ${metadata.concept_counts.action_individuals || 0} Action Individuals,
                        ${metadata.concept_counts.event_classes || 0} Event Classes,
                        ${metadata.concept_counts.event_individuals || 0} Event Individuals</small>
                    </div>
                `;
            }

            metadataContent.innerHTML = metadataHtml;
        }

        // Show all result containers
        resultsDiv.style.display = 'block';
        rawResponseDiv.style.display = 'block';
        metadataDiv.style.display = 'block';

        // Scroll to results
        resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function createConceptItem(concept, typeClass) {
        let badgeClass = 'bg-secondary';
        if (typeClass === 'action-class') badgeClass = 'badge-action-class';
        else if (typeClass === 'action-individual') badgeClass = 'badge-action-individual';
        else if (typeClass === 'event-class') badgeClass = 'badge-event-class';
        else if (typeClass === 'event-individual') badgeClass = 'badge-event-individual';

        let debugInfo = '';
        if (concept.debug) {
            // Show relevant debug information based on type
            if (concept.type.includes('action')) {
                debugInfo = `
                    <div class="concept-metadata">
                        ${concept.debug.performed_by ? `<div><strong>Performed by:</strong> ${concept.debug.performed_by}</div>` : ''}
                        ${concept.debug.temporal_interval ? `<div><strong>When:</strong> ${concept.debug.temporal_interval}</div>` : ''}
                        ${concept.debug.volitional_requirement ? `<div><strong>Volitional:</strong> ${concept.debug.volitional_requirement}</div>` : ''}
                        ${concept.debug.causal_triggers && concept.debug.causal_triggers.length ? `<div><strong>Triggered by:</strong> ${concept.debug.causal_triggers.join(', ')}</div>` : ''}
                        ${concept.debug.causal_results && concept.debug.causal_results.length ? `<div><strong>Results in:</strong> ${concept.debug.causal_results.join(', ')}</div>` : ''}
                        ${concept.debug.allen_relations && concept.debug.allen_relations.length ? `<div><strong>Temporal Relations:</strong> ${concept.debug.allen_relations.map(r => r.relation + ' ' + r.target).join(', ')}</div>` : ''}
                    </div>
                `;
            } else if (concept.type.includes('event')) {
                debugInfo = `
                    <div class="concept-metadata">
                        ${concept.debug.occurred_to ? `<div><strong>Occurred to:</strong> ${concept.debug.occurred_to}</div>` : ''}
                        ${concept.debug.discovered_by ? `<div><strong>Discovered by:</strong> ${concept.debug.discovered_by}</div>` : ''}
                        ${concept.debug.temporal_interval ? `<div><strong>When:</strong> ${concept.debug.temporal_interval}</div>` : ''}
                        ${concept.debug.temporal_marker ? `<div><strong>Temporal Marker:</strong> ${concept.debug.temporal_marker}</div>` : ''}
                        ${concept.debug.automatic_nature ? `<div><strong>Nature:</strong> ${concept.debug.automatic_nature}</div>` : ''}
                        ${concept.debug.causal_triggers && concept.debug.causal_triggers.length ? `<div><strong>Triggered by:</strong> ${concept.debug.causal_triggers.join(', ')}</div>` : ''}
                        ${concept.debug.causal_results && concept.debug.causal_results.length ? `<div><strong>Results in:</strong> ${concept.debug.causal_results.join(', ')}</div>` : ''}
                        ${concept.debug.allen_relations && concept.debug.allen_relations.length ? `<div><strong>Temporal Relations:</strong> ${concept.debug.allen_relations.map(r => r.relation + ' ' + r.target).join(', ')}</div>` : ''}
                    </div>
                `;
            }
        }

        return `
            <div class="concept-item ${typeClass}">
                <div class="concept-label">${concept.label}</div>
                <div class="concept-description">${concept.description}</div>
                <div class="mt-2">
                    <span class="badge ${badgeClass} me-1">${concept.category}</span>
                    <span class="badge bg-light text-dark">Confidence: ${(concept.confidence * 100).toFixed(0)}%</span>
                </div>
                ${debugInfo}
            </div>
        `;
    }

    function displayActionsEventsError(error) {
        const promptDiv = document.getElementById('actionsEventsPrompt');
        promptDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> Error extracting actions & events: ${error}
            </div>
        `;
    }

    function regenerateActionsEventsPrompt() {
        const promptDiv = document.getElementById('actionsEventsPrompt');
        const resultsDiv = document.getElementById('actionsEventsResults');
        const rawResponseDiv = document.getElementById('actionsEventsRawResponse');
        const metadataDiv = document.getElementById('actionsEventsMetadata');

        // Reset prompt
        promptDiv.innerHTML = '<em class="text-muted">Click "Extract Actions & Events" to generate and view the prompt...</em>';

        // Hide results
        resultsDiv.style.display = 'none';
        rawResponseDiv.style.display = 'none';
        metadataDiv.style.display = 'none';
    }

    function getCsrfToken() {
        return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ========== ENHANCED TEMPORAL EXTRACTION (LangGraph) ==========
    let messageCount = 0;
    let extractionData = {
        stages: [],
        totalMessages: 0,
        startTime: null,
        endTime: null
    };

    function toggleEnhancedLog() {
        const messagesDiv = document.getElementById("enhanced-messages");
        const toggleIcon = document.getElementById("log-toggle-icon");
        if (messagesDiv.style.display === "none") {
            messagesDiv.style.display = "block";
            toggleIcon.className = "bi bi-chevron-down";
        } else {
            messagesDiv.style.display = "none";
            toggleIcon.className = "bi bi-chevron-right";
        }
    }

    function executeEnhancedTemporalPass() {
        const progressCard = document.getElementById("enhancedTemporalProgress");
        const progressBar = document.getElementById("enhanced-progress-bar");
        const progressIcon = document.getElementById("enhanced-progress-icon");
        const progressHeader = document.getElementById("enhanced-progress-header");
        const messagesDiv = document.getElementById("enhanced-messages");
        const refreshBtn = document.getElementById("enhanced-refresh-btn");
        const stageInfo = document.getElementById("enhanced-stage-info");
        const currentStage = document.getElementById("enhanced-current-stage");
        const summaryCard = document.getElementById("enhanced-summary");
        const currentCaseId = {{ case.id }};

        // Reset state
        messageCount = 0;
        extractionData = {
            stages: [],
            totalMessages: 0,
            startTime: new Date(),
            endTime: null
        };

        // Show progress card
        progressCard.style.display = "block";
        progressBar.style.width = "0%";
        progressBar.textContent = "0%";
        messagesDiv.innerHTML = "";
        refreshBtn.style.display = "none";
        summaryCard.style.display = "none";
        stageInfo.style.display = "block";
        progressIcon.className = "bi bi-hourglass-split";
        currentStage.textContent = "Initializing...";
        document.getElementById("log-count").textContent = "0 messages";

        // Scroll to progress card
        progressCard.scrollIntoView({ behavior: "smooth", block: "start" });

        // Create EventSource for Server-Sent Events
        const eventSource = new EventSource(
            `/scenario_pipeline/case/${currentCaseId}/step3/extract_enhanced`
        );

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log("Enhanced extraction event:", data);

            // Check for completion
            if (data.complete) {
                eventSource.close();
                extractionData.endTime = new Date();
                const duration = ((extractionData.endTime - extractionData.startTime) / 1000).toFixed(1);

                progressBar.style.width = "100%";
                progressBar.textContent = "100%";
                progressBar.classList.remove("progress-bar-animated");
                progressBar.classList.add("bg-success");
                progressIcon.className = "bi bi-check-circle text-success";
                progressHeader.textContent = "Enhanced Extraction Complete";
                stageInfo.style.display = "none";

                // Show summary
                summaryCard.style.display = "block";
                document.getElementById("enhanced-summary-content").innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Duration:</strong> ${duration} seconds
                        </div>
                        <div class="col-md-4">
                            <strong>Stages Completed:</strong> ${extractionData.stages.length}
                        </div>
                        <div class="col-md-4">
                            <strong>Total Messages:</strong> ${messageCount}
                        </div>
                    </div>
                    <div class="mt-3">
                        <strong>Stages:</strong>
                        <ul class="mb-0">
                            ${extractionData.stages.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                `;

                addEnhancedMessage("success", `âœ“ Extraction completed in ${duration} seconds`);
                refreshBtn.style.display = "block";
                return;
            }

            // Check for error
            if (data.error) {
                eventSource.close();
                addEnhancedMessage("danger", `Error: ${data.error}`);
                progressIcon.className = "bi bi-exclamation-triangle text-danger";
                progressHeader.textContent = "Enhanced Extraction Failed";
                stageInfo.style.display = "none";
                return;
            }

            // Update stage info
            if (data.stage) {
                currentStage.textContent = data.stage || data.node || "Processing...";
                if (data.stage && !extractionData.stages.includes(data.stage)) {
                    extractionData.stages.push(data.stage);
                }
            }

            // Update progress bar
            if (data.progress) {
                progressBar.style.width = data.progress + "%";
                progressBar.textContent = data.progress + "%";
            }

            // Add messages
            if (data.messages && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    addEnhancedMessage("info", msg);
                });
            }

            // Add errors
            if (data.errors && data.errors.length > 0) {
                data.errors.forEach(err => {
                    addEnhancedMessage("warning", err);
                });
            }
        };

        eventSource.onerror = function(error) {
            console.error("Enhanced extraction SSE error:", error);
            eventSource.close();
            addEnhancedMessage("danger", "Connection error during extraction");
            progressIcon.className = "bi bi-exclamation-triangle text-danger";
            progressHeader.textContent = "Enhanced Extraction Failed";
        };
    }

    function addEnhancedMessage(type, message) {
        const messagesDiv = document.getElementById("enhanced-messages");

        // Clear "waiting" message on first real message
        if (messageCount === 0) {
            messagesDiv.innerHTML = "";
        }

        messageCount++;
        document.getElementById("log-count").textContent = `${messageCount} message${messageCount !== 1 ? 's' : ''}`;

        const timestamp = new Date().toLocaleTimeString();
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} mb-2 py-2`;

        let icon = "bi-arrow-right";
        if (type === "success") icon = "bi-check-circle";
        else if (type === "danger") icon = "bi-exclamation-triangle";
        else if (type === "warning") icon = "bi-exclamation-circle";
        else if (type === "info") icon = "bi-info-circle";

        alertDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div><i class="bi ${icon}"></i> ${message}</div>
                <small class="text-muted ms-2" style="white-space: nowrap;">${timestamp}</small>
            </div>
        `;
        messagesDiv.appendChild(alertDiv);

        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
{% endblock %}
