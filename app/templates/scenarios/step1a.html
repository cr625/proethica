{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 1a: LangExtract Content Analysis{% endblock %}
{% block step_header %}Step 1a: LangExtract Content Analysis{% endblock %}
{% block step_subtitle %}Enhanced document analysis with LangExtract integration{% endblock %}
{% block step_info %}Step 1a: Content Analysis{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-earmark-text"></i> Document Sections
        </h4>
    </div>
    <div class="step-content">
        <!-- LangExtract Service Status -->
        {% if langextract_status %}
        <div class="alert alert-{{ 'success' if langextract_status.available else 'warning' }} mb-3">
            <h6 class="mb-2">
                <i class="bi bi-{{ 'check-circle' if langextract_status.available else 'exclamation-triangle' }}"></i>
                LangExtract Service Status
            </h6>
            <p class="mb-1">Status: {{ langextract_status.status }}</p>
            {% if langextract_status.details %}
            <small class="text-muted">{{ langextract_status.details }}</small>
            {% endif %}
        </div>
        {% endif %}

        <!-- Document Sections -->
        {% if sections %}
        <div class="accordion" id="sectionsAccordion">
            {% for section_key, section in sections.items() %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading-{{ loop.index }}">
                    <button class="accordion-button {{ 'collapsed' if loop.index > 1 else '' }}"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapse-{{ loop.index }}"
                            aria-expanded="{{ 'true' if loop.index == 1 else 'false' }}"
                            aria-controls="collapse-{{ loop.index }}">
                        <strong>{{ section.display_name }}</strong>
                        <span class="ms-2 badge bg-secondary">{{ section.llm_text|length }} chars</span>
                    </button>
                </h2>
                <div id="collapse-{{ loop.index }}"
                     class="accordion-collapse collapse {{ 'show' if loop.index == 1 else '' }}"
                     aria-labelledby="heading-{{ loop.index }}"
                     data-bs-parent="#sectionsAccordion">
                    <div class="accordion-body">
                        <div class="section-content mb-3">
                            <pre class="bg-light p-3 rounded">{{ section.llm_text }}</pre>
                        </div>

                        <!-- LangExtract Analysis Button -->
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary analyze-btn"
                                    data-section="{{ section_key }}"
                                    data-case-id="{{ case.id }}"
                                    onclick="analyzeSectionWithLangExtract(this)">
                                <i class="bi bi-search"></i> Analyze with LangExtract
                            </button>
                        </div>

                        <!-- Results Container -->
                        <div id="results-{{ section_key }}" class="mt-3" style="display: none;">
                            <!-- Analysis results will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No sections found in this document.
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript for LangExtract Analysis -->
<script>
function analyzeSectionWithLangExtract(button) {
    const sectionKey = button.dataset.section;
    const caseId = button.dataset.caseId;
    const resultsDiv = document.getElementById(`results-${sectionKey}`);

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Send analysis request
    fetch(`/scenario_pipeline/case/${caseId}/step1a/analyze`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            section_key: sectionKey
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display results
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6 class="mb-2"><i class="bi bi-check-circle"></i> LangExtract Analysis Complete</h6>
                    <div class="analysis-results">
                        ${formatAnalysisResults(data.results)}
                    </div>
                </div>
            `;
        } else {
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> Analysis failed: ${data.error || 'Unknown error'}
                </div>
            `;
        }
    })
    .catch(error => {
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> Error: ${error.message}
            </div>
        `;
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-search"></i> Analyze with LangExtract';
    });
}

function formatAnalysisResults(results) {
    if (!results) return '<p>No results available</p>';

    // Format the results based on the structure returned by LangExtract
    let html = '<ul class="list-group">';

    if (results.entities) {
        html += '<li class="list-group-item"><strong>Entities:</strong> ' +
                results.entities.join(', ') + '</li>';
    }

    if (results.concepts) {
        html += '<li class="list-group-item"><strong>Concepts:</strong> ' +
                results.concepts.join(', ') + '</li>';
    }

    if (results.relationships) {
        html += '<li class="list-group-item"><strong>Relationships:</strong> ' +
                results.relationships.join(', ') + '</li>';
    }

    // Add any other result fields as needed
    for (const [key, value] of Object.entries(results)) {
        if (!['entities', 'concepts', 'relationships'].includes(key)) {
            html += `<li class="list-group-item"><strong>${key}:</strong> ${JSON.stringify(value)}</li>`;
        }
    }

    html += '</ul>';
    return html;
}
</script>
{% endblock %}

{% block step_styles %}
<style>
.section-content pre {
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.analysis-results {
    margin-top: 10px;
}

.analyze-btn {
    max-width: 300px;
    margin: 0 auto;
}
</style>
{% endblock %}

{% block step_scripts %}
{% endblock %}