{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 2: Normative Requirements Pass - Discussion Section{% endblock %}
{% block step_header %}Step 2: Normative Requirements Pass (Discussion){% endblock %}
{% block step_subtitle %}Extract principles, obligations, constraints, and capabilities from the discussion section{% endblock %}

{% block head %}
{{ super() }}
<style>
    .extraction-progress {
        margin: 20px 0;
    }

    .extraction-item {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .extraction-item.extracting {
        background-color: #fff3cd;
        border-color: #ffc107;
    }

    .extraction-item.success {
        background-color: #d4edda;
        border-color: #28a745;
    }

    .extraction-item.error {
        background-color: #f8d7da;
        border-color: #dc3545;
    }

    .extraction-status {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .extraction-status .spinner-border {
        margin-right: 10px;
    }

    .extraction-results {
        margin-top: 10px;
        padding: 10px;
        background-color: white;
        border-radius: 4px;
        display: none;
    }

    .extraction-results.show {
        display: block;
    }

    .progress-indicator {
        margin: 20px 0;
    }

    .entity-count {
        display: inline-block;
        padding: 2px 8px;
        background-color: #007bff;
        color: white;
        border-radius: 12px;
        font-size: 0.9em;
        margin-left: 10px;
    }

    .retry-badge {
        display: inline-block;
        padding: 2px 8px;
        background-color: #ffc107;
        color: #212529;
        border-radius: 4px;
        font-size: 0.8em;
        margin-left: 10px;
    }

    .extraction-error {
        color: #dc3545;
        margin-top: 10px;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.step1', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Step 1
    </a>
    <div>
        <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id) }}" class="btn btn-info me-2">
            <i class="bi bi-list-check"></i> Review Pass 2 Entities
        </a>
        <a href="{{ url_for('scenario_pipeline.step3', case_id=case.id) }}" class="btn btn-outline-primary">
            Step 3: Temporal Pass <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-text"></i> Discussion Section
        </h4>
    </div>
    <div class="step-content">
        {% if discussion_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="discussion-text">{{ discussion_section.llm_text }}</pre>
        </div>

        <!-- Enhanced Normative Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-3">
            <button id="normativePassBtn" class="btn btn-primary btn-lg" onclick="executeStreamingPass()">
                <i class="bi bi-arrow-right-circle"></i> Full Normative Requirements Pass (Enhanced)
                <small class="d-block">Extract Principles + Obligations + Constraints + Capabilities with Real-time Updates</small>
            </button>
        </div>

        <!-- Progress Indicator (Hidden initially) -->
        <div id="progressIndicator" class="progress-indicator" style="display: none;">
            <div class="progress" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%">
                    <span id="progressText">Starting...</span>
                </div>
            </div>
        </div>

        <!-- Extraction Progress Container -->
        <div id="extractionProgress" class="extraction-progress" style="display: none;">

            <!-- Principles Extraction Item -->
            <div id="principlesExtraction" class="extraction-item">
                <div class="extraction-status">
                    <div id="principlesSpinner" class="spinner-border spinner-border-sm text-success" style="display: none;"></div>
                    <h5 class="mb-0">
                        <i class="bi bi-stars text-success"></i> Principles Extraction
                        <span id="principlesCount" class="entity-count" style="display: none;"></span>
                        <span id="principlesRetry" class="retry-badge" style="display: none;"></span>
                    </h5>
                </div>
                <div id="principlesResults" class="extraction-results">
                    <!-- Results will be populated here -->
                </div>
                <div id="principlesError" class="extraction-error" style="display: none;">
                    <!-- Error message will be shown here -->
                </div>
            </div>

            <!-- Obligations Extraction Item -->
            <div id="obligationsExtraction" class="extraction-item">
                <div class="extraction-status">
                    <div id="obligationsSpinner" class="spinner-border spinner-border-sm text-warning" style="display: none;"></div>
                    <h5 class="mb-0">
                        <i class="bi bi-shield-check text-warning"></i> Obligations Extraction
                        <span id="obligationsCount" class="entity-count" style="display: none;"></span>
                        <span id="obligationsRetry" class="retry-badge" style="display: none;"></span>
                    </h5>
                </div>
                <div id="obligationsResults" class="extraction-results">
                    <!-- Results will be populated here -->
                </div>
                <div id="obligationsError" class="extraction-error" style="display: none;">
                    <!-- Error message will be shown here -->
                </div>
            </div>

            <!-- Constraints Extraction Item -->
            <div id="constraintsExtraction" class="extraction-item">
                <div class="extraction-status">
                    <div id="constraintsSpinner" class="spinner-border spinner-border-sm text-danger" style="display: none;"></div>
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle text-danger"></i> Constraints Extraction
                        <span id="constraintsCount" class="entity-count" style="display: none;"></span>
                        <span id="constraintsRetry" class="retry-badge" style="display: none;"></span>
                    </h5>
                </div>
                <div id="constraintsResults" class="extraction-results">
                    <!-- Results will be populated here -->
                </div>
                <div id="constraintsError" class="extraction-error" style="display: none;">
                    <!-- Error message will be shown here -->
                </div>
            </div>

            <!-- Capabilities Extraction Item -->
            <div id="capabilitiesExtraction" class="extraction-item">
                <div class="extraction-status">
                    <div id="capabilitiesSpinner" class="spinner-border spinner-border-sm text-info" style="display: none;"></div>
                    <h5 class="mb-0">
                        <i class="bi bi-gear text-info"></i> Capabilities Extraction
                        <span id="capabilitiesCount" class="entity-count" style="display: none;"></span>
                        <span id="capabilitiesRetry" class="retry-badge" style="display: none;"></span>
                    </h5>
                </div>
                <div id="capabilitiesResults" class="extraction-results">
                    <!-- Results will be populated here -->
                </div>
                <div id="capabilitiesError" class="extraction-error" style="display: none;">
                    <!-- Error message will be shown here -->
                </div>
            </div>
        </div>

        <!-- Summary Card (Hidden initially) -->
        <div id="summaryCard" class="step-card mt-4" style="display: none;">
            <div class="step-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle"></i> Extraction Complete
                </h5>
            </div>
            <div class="step-content" id="summaryContent">
                <!-- Summary will be displayed here -->
            </div>
        </div>

        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No discussion section found in this case.
        </div>
        {% endif %}
    </div>
</div>

<script>
// Store the current section text globally
const currentSectionText = `{{ discussion_section.llm_text if discussion_section else '' }}`;

function executeStreamingPass() {
    const normativeBtn = document.getElementById('normativePassBtn');
    const progressIndicator = document.getElementById('progressIndicator');
    const extractionProgress = document.getElementById('extractionProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // Disable button and show progress
    normativeBtn.disabled = true;
    normativeBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting...';

    progressIndicator.style.display = 'block';
    extractionProgress.style.display = 'block';

    // Reset all extraction items
    ['principles', 'obligations', 'constraints', 'capabilities'].forEach(type => {
        document.getElementById(`${type}Extraction`).className = 'extraction-item';
        document.getElementById(`${type}Spinner`).style.display = 'none';
        document.getElementById(`${type}Count`).style.display = 'none';
        document.getElementById(`${type}Retry`).style.display = 'none';
        document.getElementById(`${type}Results`).classList.remove('show');
        document.getElementById(`${type}Error`).style.display = 'none';
    });

    // Create EventSource for streaming
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // We need to use fetch with ReadableStream since EventSource doesn't support POST with body
    fetch(`{{ url_for('scenario_pipeline.normative_pass_execute_streaming', case_id=case.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            section_text: currentSectionText
        })
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        handleStreamData(data);
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        normativeBtn.disabled = false;
        normativeBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Full Normative Requirements Pass (Enhanced)';
        alert('Error during extraction: ' + error.message);
    });
}

function handleStreamData(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    if (data.status === 'starting') {
        progressBar.style.width = '10%';
        progressText.textContent = 'Initializing...';

    } else if (data.status === 'extracting') {
        // Show spinner for current extraction
        const typeEl = document.getElementById(`${data.current}Extraction`);
        const spinner = document.getElementById(`${data.current}Spinner`);

        typeEl.classList.add('extracting');
        spinner.style.display = 'inline-block';

        // Update progress bar
        const percent = Math.round((data.progress / data.total) * 80) + 10;
        progressBar.style.width = percent + '%';
        progressText.textContent = `Extracting ${data.current} (${data.progress + 1}/${data.total})`;

    } else if (data.status === 'extracted') {
        // Hide spinner and show results for extracted type
        const type = data.concept_type;
        const typeEl = document.getElementById(`${type}Extraction`);
        const spinner = document.getElementById(`${type}Spinner`);
        const resultsEl = document.getElementById(`${type}Results`);
        const countEl = document.getElementById(`${type}Count`);
        const retryEl = document.getElementById(`${type}Retry`);
        const errorEl = document.getElementById(`${type}Error`);

        spinner.style.display = 'none';

        if (data.result.success) {
            typeEl.classList.remove('extracting');
            typeEl.classList.add('success');

            // Show entity count
            let entityCount = 0;
            if (data.result.data) {
                if (data.result.data.classes) entityCount += data.result.data.classes.length;
                if (data.result.data.individuals) entityCount += data.result.data.individuals.length;
            }

            countEl.textContent = entityCount + ' entities';
            countEl.style.display = 'inline-block';

            // Show retry count if retries were needed
            if (data.result.retry_count > 0) {
                retryEl.textContent = `${data.result.retry_count} retries`;
                retryEl.style.display = 'inline-block';
            }

            // Display results
            displayExtractionResults(type, data.result.data);
            resultsEl.classList.add('show');

        } else {
            typeEl.classList.remove('extracting');
            typeEl.classList.add('error');
            errorEl.textContent = 'Error: ' + data.result.error;
            errorEl.style.display = 'block';
        }

        // Update progress bar
        const percent = Math.round((data.progress / data.total) * 80) + 10;
        progressBar.style.width = percent + '%';
        progressText.textContent = `Completed ${type} (${data.progress}/${data.total})`;

    } else if (data.status === 'complete') {
        // Show summary
        progressBar.style.width = '100%';
        progressText.textContent = 'Complete!';
        progressBar.classList.remove('progress-bar-animated');

        displaySummary(data.summary, data.session_id);

        // Re-enable button
        const normativeBtn = document.getElementById('normativePassBtn');
        normativeBtn.disabled = false;
        normativeBtn.innerHTML = '<i class="bi bi-check-circle"></i> Extraction Complete - Run Again';

    } else if (data.status === 'error') {
        // Handle error
        progressBar.classList.add('bg-danger');
        progressText.textContent = 'Error: ' + data.error;

        const normativeBtn = document.getElementById('normativePassBtn');
        normativeBtn.disabled = false;
        normativeBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Full Normative Requirements Pass (Enhanced)';
    }
}

function displayExtractionResults(type, data) {
    const resultsEl = document.getElementById(`${type}Results`);
    let html = '';

    if (data) {
        if (data.classes && data.classes.length > 0) {
            html += '<h6>' + type.charAt(0).toUpperCase() + type.slice(1) + ' Classes:</h6><ul>';
            data.classes.forEach(cls => {
                html += `<li><strong>${cls.label}</strong> - ${cls.definition}
                         <span class="badge bg-secondary">${(cls.confidence * 100).toFixed(0)}%</span></li>`;
            });
            html += '</ul>';
        }

        if (data.individuals && data.individuals.length > 0) {
            html += '<h6>' + type.charAt(0).toUpperCase() + type.slice(1) + ' Individuals:</h6><ul>';
            data.individuals.forEach(ind => {
                const classField = ind.principle_class || ind.obligation_class || ind.constraint_class || ind.capability_class;
                const identField = ind.identifier || ind.name;
                html += `<li><strong>${identField}</strong> (${classField})
                         <span class="badge bg-info">Individual</span></li>`;
            });
            html += '</ul>';
        }
    }

    resultsEl.innerHTML = html || '<p class="text-muted">No entities found</p>';
}

// Load existing extraction results on page load
(function() {
    const existing = {{ existing_extractions | default({}) | tojson }};
    const conceptTypes = ['principles', 'obligations', 'constraints', 'capabilities'];
    if (Object.keys(existing).length === 0) return;

    // Show the progress container
    document.getElementById('extractionProgress').style.display = 'block';

    for (const [type, data] of Object.entries(existing)) {
        // Show entity count
        const countEl = document.getElementById(`${type}Count`);
        const entityCount = (data.classes ? data.classes.length : 0) +
                           (data.individuals ? data.individuals.length : 0);
        countEl.textContent = entityCount + ' entities';
        countEl.style.display = 'inline-block';

        // Mark as completed
        const typeEl = document.getElementById(`${type}Extraction`);
        typeEl.classList.add('success');

        // Display results
        displayExtractionResults(type, data);
        document.getElementById(`${type}Results`).classList.add('show');
    }

    // Show summary card if all concepts have results
    if (Object.keys(existing).length === conceptTypes.length) {
        const totalEntities = Object.values(existing).reduce((sum, d) => {
            return sum + (d.classes ? d.classes.length : 0) + (d.individuals ? d.individuals.length : 0);
        }, 0);
        displaySummary({
            total_success: Object.keys(existing).length,
            total_failed: 0,
            total_entities: totalEntities
        }, 'previous');
    }
})();

function displaySummary(summary, sessionId) {
    const summaryCard = document.getElementById('summaryCard');
    const summaryContent = document.getElementById('summaryContent');

    summaryCard.style.display = 'block';
    summaryContent.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center">
                    <h3 class="text-success">${summary.total_success}</h3>
                    <p>Successful Extractions</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h3 class="text-primary">${summary.total_entities}</h3>
                    <p>Total Entities Found</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h3 class="text-danger">${summary.total_failed}</h3>
                    <p>Failed Extractions</p>
                </div>
            </div>
        </div>
        <hr>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id) }}" class="btn btn-primary">
                <i class="bi bi-list-check"></i> Review Extracted Entities
            </a>
            <a href="/tools/provenance?case_id={{ case.id }}&session_id=${sessionId}" class="btn btn-outline-secondary">
                <i class="bi bi-clock-history"></i> View Provenance
            </a>
        </div>
    `;
}
</script>
{% endblock %}