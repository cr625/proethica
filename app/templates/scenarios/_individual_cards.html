{# Card layout for extracted individual entities.
   Included from entity_review.html and entity_review_pass2.html.
   Expects parent context: type_data, concept_type, concept_colors, ontserve_web_url, case #}

{% set color = concept_colors.get(concept_type, '#dee2e6') %}

{% for indiv in type_data.individuals %}
<div class="card mb-2" style="border-left: 4px solid {{ color }}; opacity: 0.9;">
    <div class="card-body p-3">
        {# -- Row 1: Header -- #}
        <div class="d-flex justify-content-between align-items-start">
            <div class="d-flex align-items-start gap-2">
                {% if indiv.is_published %}
                <span class="badge bg-success rounded-circle p-1 mt-1" title="Published to OntServe">
                    <i class="bi bi-check-lg"></i>
                </span>
                {% else %}
                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle delete-entity-btn p-0 mt-1"
                        style="width: 24px; height: 24px; line-height: 1;"
                        data-entity-id="{{ indiv.id }}"
                        data-entity-label="{{ indiv.entity_label }}"
                        title="Remove this entity">
                    <i class="bi bi-x" style="font-size: 14px;"></i>
                </button>
                {% endif %}
                <div>
                    <h6 class="mb-0">
                        {{ indiv.entity_label }}
                        {% if indiv.rdf_json_ld and indiv.rdf_json_ld.get('section_sources') and indiv.rdf_json_ld.get('section_sources')|length > 1 %}
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.7em;" title="Merged from multiple sections">
                            <i class="bi bi-layers"></i> {{ indiv.rdf_json_ld.get('section_sources') | join(', ') }}
                        </span>
                        {% elif indiv.cross_section_matches %}
                        <span class="badge bg-info ms-1" style="font-size: 0.7em;" title="Also extracted from other section(s)">
                            Also in: {{ indiv.cross_section_matches | map(attribute='section_label') | join(', ') }}
                        </span>
                        {% endif %}
                    </h6>
                    <small class="text-muted">
                        {# rdf:type display -- skip when match badge present (avoids redundancy) #}
                        {% if not indiv.matched_ontology_uri %}
                            {% if indiv.rdf_json_ld and indiv.rdf_json_ld.types %}
                                {% for type in indiv.rdf_json_ld.types %}
                                <span class="badge bg-secondary" style="font-size: 0.8em;">{{ type.split('#')[-1] if '#' in type else type.split('/')[-1] }}</span>
                                {% endfor %}
                            {% elif indiv.entity_type %}
                                <span class="badge bg-secondary" style="font-size: 0.8em;">{{ indiv.entity_type | title }}</span>
                            {% else %}
                                Individual Instance
                            {% endif %}
                        {% elif indiv.matched_ontology_label %}
                            <span style="font-size: 0.85em;">{{ indiv.matched_ontology_label }}</span>
                        {% endif %}
                    </small>
                </div>
            </div>
            <div class="d-flex gap-2 align-items-start">
                {# -- Match status badge -- #}
                {% if indiv.matched_ontology_uri %}
                    {% set confidence = indiv.match_confidence or 0 %}
                    {% if confidence >= 0.90 %}
                    <div class="text-end">
                        <span class="badge match-status-badge match-linked"
                              style="background-color: #d4edda !important; color: #155724 !important; border: 1px solid #28a745 !important;"
                              data-bs-toggle="modal" data-bs-target="#matchDetailsModal"
                              data-entity-id="{{ indiv.id }}"
                              data-entity-label="{{ indiv.entity_label }}"
                              data-matched-uri="{{ indiv.matched_ontology_uri }}"
                              data-matched-label="{{ indiv.matched_ontology_label or 'Unknown' }}"
                              data-confidence="{{ confidence }}"
                              data-method="{{ indiv.match_method or 'llm' }}"
                              data-reasoning="{{ indiv.match_reasoning or '' }}"
                              title="Linked: {{ indiv.matched_ontology_label or indiv.matched_ontology_uri }}">
                            <i class="bi bi-link-45deg" style="color: #155724 !important;"></i> Linked
                        </span>
                        <br/>
                        {% set ontserve_path = indiv.matched_ontology_uri.replace('http://proethica.org/', '').replace('#', '/') %}
                        <small><a href="{{ ontserve_web_url }}/{{ ontserve_path }}" target="_blank" class="text-decoration-none" title="View in OntServe">{{ indiv.matched_ontology_label or indiv.matched_ontology_uri.split('#')[-1] }} <i class="bi bi-box-arrow-up-right" style="font-size: 0.7em;"></i></a></small>
                        <div class="match-confidence-bar">
                            <div class="match-confidence-fill confidence-high" style="width: {{ (confidence * 100)|int }}%"></div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-end">
                        <span class="badge match-status-badge match-review"
                              data-bs-toggle="modal" data-bs-target="#matchDetailsModal"
                              data-entity-id="{{ indiv.id }}"
                              data-entity-label="{{ indiv.entity_label }}"
                              data-matched-uri="{{ indiv.matched_ontology_uri }}"
                              data-matched-label="{{ indiv.matched_ontology_label or 'Unknown' }}"
                              data-confidence="{{ confidence }}"
                              data-method="{{ indiv.match_method or 'llm' }}"
                              data-reasoning="{{ indiv.match_reasoning or '' }}"
                              title="Review: {{ indiv.matched_ontology_label or indiv.matched_ontology_uri }}">
                            <i class="bi bi-search"></i> Review
                        </span>
                        <br/>
                        {% set ontserve_path = indiv.matched_ontology_uri.replace('http://proethica.org/', '').replace('#', '/') %}
                        <small><a href="{{ ontserve_web_url }}/{{ ontserve_path }}" target="_blank" class="text-decoration-none" title="View in OntServe">{{ indiv.matched_ontology_label or indiv.matched_ontology_uri.split('#')[-1] }} <i class="bi bi-box-arrow-up-right" style="font-size: 0.7em;"></i></a></small>
                        <div class="match-confidence-bar">
                            <div class="match-confidence-fill {% if confidence >= 0.75 %}confidence-medium{% else %}confidence-low{% endif %}" style="width: {{ (confidence * 100)|int }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                <span class="badge bg-secondary match-status-badge match-new"
                      data-bs-toggle="modal" data-bs-target="#matchDetailsModal"
                      data-entity-id="{{ indiv.id }}"
                      data-entity-label="{{ indiv.entity_label }}"
                      data-matched-uri=""
                      data-matched-label=""
                      data-confidence="0"
                      data-method=""
                      data-reasoning=""
                      title="New individual - no match found">
                    <i class="bi bi-plus-circle"></i> New
                </span>
                {% endif %}
                <small class="text-muted ms-2">C{{ indiv.case_id if indiv.case_id else case.id }}</small>
            </div>
        </div>

        {# -- Row 2: Properties & Relations (full width) -- #}
        <div class="mt-2">
            <div class="rdf-properties" style="font-size: 0.85rem;">
                {% set ns = namespace(has_content=false) %}
                {% set skip_props = ['wasGeneratedAt', 'wasAttributedTo', 'discoveredInCase',
                                     'generatedAtTime', 'firstDiscoveredInCase', 'firstDiscoveredAt',
                                     'discoveredInSection', 'discoveredInPass',
                                     'sourceText'] %}
                {% set quote_props = ['textReferences', 'hasExample'] %}
                {% if indiv.rdf_json_ld and indiv.rdf_json_ld.properties %}
                    {% for prop_name, prop_values in indiv.rdf_json_ld.properties.items() if prop_name not in skip_props and prop_values and prop_values != ['{}'] and prop_values != ['[]'] %}
                        {% set ns.has_content = true %}
                        <div class="mb-1 property-item" data-property="{{ prop_name }}" data-type="property">
                            <strong class="property-name">{{ prop_name | camel_to_readable }}:</strong>
                            {% if prop_name in quote_props %}
                                {% for val in prop_values if val %}
                                <br/><small class="text-info"><i class="bi bi-quote"></i> "{{ val[:200] }}{% if val|length > 200 %}...{% endif %}"</small>
                                {% endfor %}
                            {% else %}
                            <span class="property-value">
                                {% if prop_values is string %}
                                    {{ prop_values }}
                                {% elif prop_values is iterable %}
                                    {% if prop_values|length > 1 %}
                                        {% if prop_values[0]|length == 1 %}
                                            {{ prop_values|join('') }}
                                        {% else %}
                                            <ul class="list-unstyled ms-3 mb-0">
                                            {% for val in prop_values if val %}
                                                <li>{{ val }}</li>
                                            {% endfor %}
                                            </ul>
                                        {% endif %}
                                    {% elif prop_values|length == 1 %}
                                        {{ prop_values[0] }}
                                    {% else %}
                                        <small class="text-muted">-</small>
                                    {% endif %}
                                {% else %}
                                    {{ prop_values }}
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% endif %}

                {# Relationships #}
                {% if indiv.rdf_json_ld and indiv.rdf_json_ld.relationships %}
                    {% set ns.has_content = true %}
                    {% for rel in indiv.rdf_json_ld.relationships %}
                        <div class="mb-1 property-item" data-property="{{ rel.type }}" data-type="relation">
                            <strong class="property-name">{{ rel.type | camel_to_readable }}:</strong>
                            <span class="property-value text-info">{{ rel.target }}</span>
                        </div>
                    {% endfor %}
                {% endif %}

                {# Fallback: definition + reasoning if no properties #}
                {% if not ns.has_content %}
                    {% set definitions = (indiv.rdf_json_ld or {}).get('definitions', []) %}
                    {% if definitions and definitions|length > 1 %}
                        <div class="mb-1"><strong class="text-muted">Definitions:</strong></div>
                        {% for defn in definitions %}
                        <div class="small{% if not defn.is_primary %} text-muted{% endif %} mb-1">
                            {% if defn.is_primary %}<strong>{{ defn.text }}</strong>
                            {% else %}{{ defn.text }}{% endif %}
                            <span class="badge bg-{{ 'primary' if defn.source_type == 'extraction' else ('info' if defn.source_type == 'ontology' else 'secondary') }}" style="font-size: 0.65em;">{{ defn.source_section or defn.source_ontology or defn.source_type }}</span>
                        </div>
                        {% endfor %}
                    {% elif indiv.rdf_json_ld and indiv.rdf_json_ld.definition %}
                        <div class="mb-1"><strong class="text-muted">Definition:</strong> <span class="small">{{ indiv.rdf_json_ld.definition }}</span></div>
                        {% if indiv.rdf_json_ld.reasoning %}
                        <div class="mb-1"><strong class="text-muted">Reasoning:</strong> <span class="small text-muted">{{ indiv.rdf_json_ld.reasoning }}</span></div>
                        {% endif %}
                        {% if indiv.rdf_json_ld.confidence %}
                        <div><strong class="text-muted">Confidence:</strong> <span class="badge bg-secondary">{{ (indiv.rdf_json_ld.confidence * 100)|round(0)|int }}%</span></div>
                        {% endif %}
                    {% else %}
                        <small class="text-muted">No properties or relations</small>
                    {% endif %}
                {% endif %}
            </div>
        </div>

        {# -- Row 3: Source quotes (if any) -- #}
        {% if indiv.rdf_json_ld and indiv.rdf_json_ld.get('source_texts') %}
        <div class="mt-2 pt-2 border-top" style="font-size: 0.85em;">
            {% for section, text in indiv.rdf_json_ld.get('source_texts').items() %}
            <div class="text-info"><i class="bi bi-quote"></i> <strong>[{{ section }}]</strong> "{{ text[:200] }}{% if text|length > 200 %}...{% endif %}"</div>
            {% endfor %}
        </div>
        {% elif indiv.rdf_json_ld and indiv.rdf_json_ld.get('source_text') %}
        <div class="mt-2 pt-2 border-top" style="font-size: 0.85em;">
            <div class="text-info"><i class="bi bi-quote"></i> "{{ indiv.rdf_json_ld.get('source_text')[:200] }}{% if indiv.rdf_json_ld.get('source_text')|length > 200 %}...{% endif %}"</div>
        </div>
        {% endif %}
    </div>
</div>
{% endfor %}
