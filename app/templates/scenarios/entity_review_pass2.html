{% extends "base.html" %}

{% block title %}Pass 2 Entity Review - Case {{ case.id }}{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Enhanced styling for entity review page */
    .entity-section-header {
        border-left: 4px solid;
        padding-left: 15px;
        margin-bottom: 20px;
    }

    .classes-section .entity-section-header {
        border-left-color: #007bff;
    }

    .individuals-section .entity-section-header {
        border-left-color: #17a2b8;
    }

    .section-icon-circle {
        width: 45px;
        height: 45px;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card.border-primary {
        border-width: 2px;
    }

    .card.border-info {
        border-width: 2px;
    }

    /* Hover effects for entity rows */
    .table-hover tbody tr:hover {
        background-color: rgba(0,123,255,0.05);
    }

    .card.border-info .table-hover tbody tr:hover {
        background-color: rgba(23,162,184,0.05);
    }

    /* Visual indicators for entity types */
    .entity-type-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 5px;
    }

    .entity-type-class {
        background-color: #007bff;
    }

    .entity-type-individual {
        background-color: #17a2b8;
    }

    /* Section separators */
    .ontology-section-divider {
        border: 0;
        height: 2px;
        background: linear-gradient(to right, transparent, #dee2e6, transparent);
        margin: 40px 0;
    }

    /* Property editing preparation */
    .property-item {
        transition: background-color 0.2s;
        padding: 2px 4px;
        border-radius: 3px;
        position: relative;
    }

    .property-item:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }

    .property-name {
        color: #495057;
        font-weight: 600;
    }

    .property-value {
        color: #212529;
    }

    .property-value.text-info {
        color: #17a2b8 !important;
    }

    /* Future edit button placeholder */
    .property-edit-btn {
        display: none; /* Hidden for now */
        position: absolute;
        right: 0;
        top: 2px;
        padding: 2px 6px;
        font-size: 0.75rem;
        line-height: 1;
        border-radius: 3px;
        cursor: pointer;
    }

    .property-item:hover .property-edit-btn {
        /* Will be enabled when edit functionality is added */
        /* display: inline-block; */
    }

    /* Editable property styling (for future) */
    .property-item.editing {
        background-color: #fff3cd;
        border: 1px solid #ffc107;
        padding: 4px 6px;
    }

    .property-item.editing input,
    .property-item.editing textarea {
        background: white;
        border: 1px solid #ced4da;
        padding: 2px 6px;
        font-size: 0.85rem;
        width: 100%;
    }

    /* RDF-style formatting */
    .rdf-properties {
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }

    .rdf-triple {
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }

    /* Match status styling */
    .match-status-badge {
        cursor: pointer;
        transition: all 0.15s ease;
        padding: 0.35em 0.65em;
        font-size: 0.85em;
        border: 1px solid transparent;
    }

    .match-status-badge:hover {
        transform: scale(1.08);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .match-linked {
        background-color: #28a745 !important;
        color: #fff !important;
        border-color: #1e7e34 !important;
    }

    .match-review {
        background-color: #ffc107 !important;
        color: #000 !important;
        border-color: #d39e00 !important;
    }

    .match-new {
        background-color: #6c757d !important;
        color: #fff !important;
        border-color: #545b62 !important;
    }

    .match-confidence-bar {
        height: 4px;
        border-radius: 2px;
        margin-top: 4px;
        background-color: #e9ecef;
    }

    .match-confidence-fill {
        height: 100%;
        border-radius: 2px;
    }

    .confidence-high { background-color: #28a745; }
    .confidence-medium { background-color: #ffc107; }
    .confidence-low { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Top Menu Bar -->
            <div class="bg-light border rounded p-3 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        {% if section_type == 'discussion' %}
                            <a href="{{ url_for('scenario_pipeline.step2b', case_id=case.id) }}" class="btn btn-sm btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Step 2b (Discussion)
                            </a>
                        {% elif section_type == 'questions' %}
                            <a href="{{ url_for('scenario_pipeline.step2c', case_id=case.id) }}" class="btn btn-sm btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Step 2c (Questions)
                            </a>
                        {% elif section_type == 'conclusions' %}
                            <a href="{{ url_for('scenario_pipeline.step2d', case_id=case.id) }}" class="btn btn-sm btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Step 2d (Conclusions)
                            </a>
                        {% elif section_type == 'references' %}
                            <a href="{{ url_for('scenario_pipeline.step2e', case_id=case.id) }}" class="btn btn-sm btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Step 2e (References)
                            </a>
                        {% else %}
                            <a href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}" class="btn btn-sm btn-secondary">
                                <i class="bi bi-arrow-left"></i> Back to Step 2 (Facts)
                            </a>
                        {% endif %}
                    </div>
                    <div>
                        <!-- Draft/Publish workflow: Publishing moved to Step 4 Review -->
                        <span class="badge bg-info" title="Entities will be published to OntServe from Step 4 Review">
                            <i class="bi bi-info-circle"></i> Draft - Publish at Step 4
                        </span>
                    </div>
                </div>
            </div>

            <!-- Pass Information Header -->
            <div class="bg-success bg-gradient text-white rounded p-3 mb-3">
                <div class="row align-items-center">
                    <div class="col-12">
                        <h2 class="mb-1">
                            <i class="bi bi-diagram-2"></i> PASS 2: Normative Requirements
                            {% if section_display and section_display != 'All Sections' %}
                                <span class="badge bg-info">{{ section_display }}</span>
                            {% endif %}
                        </h2>
                        <p class="mb-0">Case {{ case.id }}: {{ case.title }}</p>
                    </div>
                </div>
            </div>

            <!-- Entity Type Counts -->
            <div class="row mb-3">
                <!-- Principles -->
                <div class="col-md-3 mb-2">
                    <div class="card border-success">
                        <div class="card-body">
                            <h5 class="card-title text-success">
                                <i class="bi bi-stars"></i> Principles
                            </h5>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.principles.classes|length if rdf_data and rdf_data.by_type and rdf_data.by_type.principles else 0 }}</div>
                                    <small class="text-muted">Classes</small>
                                </div>
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.principles.individuals|length if rdf_data and rdf_data.by_type and rdf_data.by_type.principles else 0 }}</div>
                                    <small class="text-muted">Individuals</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Obligations -->
                <div class="col-md-3 mb-2">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h5 class="card-title text-warning">
                                <i class="bi bi-shield-check"></i> Obligations
                            </h5>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.obligations.classes|length if rdf_data and rdf_data.by_type and rdf_data.by_type.obligations else 0 }}</div>
                                    <small class="text-muted">Classes</small>
                                </div>
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.obligations.individuals|length if rdf_data and rdf_data.by_type and rdf_data.by_type.obligations else 0 }}</div>
                                    <small class="text-muted">Individuals</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Constraints -->
                <div class="col-md-3 mb-2">
                    <div class="card border-danger">
                        <div class="card-body">
                            <h5 class="card-title text-danger">
                                <i class="bi bi-exclamation-triangle"></i> Constraints
                            </h5>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.constraints.classes|length if rdf_data and rdf_data.by_type and rdf_data.by_type.constraints else 0 }}</div>
                                    <small class="text-muted">Classes</small>
                                </div>
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.constraints.individuals|length if rdf_data and rdf_data.by_type and rdf_data.by_type.constraints else 0 }}</div>
                                    <small class="text-muted">Individuals</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Capabilities -->
                <div class="col-md-3 mb-2">
                    <div class="card border-info">
                        <div class="card-body">
                            <h5 class="card-title text-info">
                                <i class="bi bi-gear"></i> Capabilities
                            </h5>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.capabilities.classes|length if rdf_data and rdf_data.by_type and rdf_data.by_type.capabilities else 0 }}</div>
                                    <small class="text-muted">Classes</small>
                                </div>
                                <div class="col-6">
                                    <div class="fs-3 fw-bold">{{ rdf_data.by_type.capabilities.individuals|length if rdf_data and rdf_data.by_type and rdf_data.by_type.capabilities else 0 }}</div>
                                    <small class="text-muted">Individuals</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- RDF Entities Section -->
            {% if rdf_data and rdf_data.total_rdf_entities > 0 %}

            <!-- Section Header with Clear Separation -->
            <div class="row mb-4">
                <div class="col-12">
                    <hr class="my-4">
                    <h2 class="mb-3">Extracted Ontology Entities</h2>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>{{ rdf_data.total_rdf_entities }} RDF entities extracted</strong> organized by concept type
                    </div>
                </div>
            </div>

            <!-- CONCEPT TYPE PANELS -->
            {% for concept_type, type_data in rdf_data.by_type.items() %}
            {% if type_data.classes or type_data.individuals %}
            <div class="row mb-5">
                <div class="col-12">
                    <!-- Panel Header for {{ concept_type|title }} -->
                    <div class="card {% if concept_type == 'principles' %}border-success{% elif concept_type == 'obligations' %}border-warning{% elif concept_type == 'constraints' %}border-danger{% else %}border-info{% endif %}">
                        <div class="card-header {% if concept_type == 'principles' %}bg-success{% elif concept_type == 'obligations' %}bg-warning{% elif concept_type == 'constraints' %}bg-danger{% else %}bg-info{% endif %} text-white">
                            <h4 class="mb-0">
                                <i class="fas fa-{% if concept_type == 'principles' %}stars{% elif concept_type == 'obligations' %}shield-alt{% elif concept_type == 'constraints' %}exclamation-triangle{% else %}cogs{% endif %}"></i>
                                {{ concept_type|title }} Extraction
                            </h4>
                        </div>
                        <div class="card-body">

            {# Split classes into matched (cross-case) vs new (no match or circular same-case match) #}
            {% set case_uri_fragment = '/case/' ~ case.id ~ '#' %}
            {% set matched_classes = [] %}
            {% set new_classes = [] %}
            {% for cls in type_data.classes %}
                {% if cls.matched_ontology_uri and case_uri_fragment not in cls.matched_ontology_uri %}
                    {% set _ = matched_classes.append(cls) %}
                {% else %}
                    {% set _ = new_classes.append(cls) %}
                {% endif %}
            {% endfor %}

            <!-- MATCHED CLASSES SUB-SECTION (Cross-Case Links) -->
            {% if matched_classes %}
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="mb-3">Matched {{ concept_type|title }} Classes</h5>
                    <div class="card border-success shadow-sm">
                        <div class="card-header bg-success text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">
                                        <i class="fas fa-link"></i>
                                        Classes Linked to Existing Ontology
                                    </h6>
                                    <small>These match existing classes in OntServe - review the links below</small>
                                </div>
                                <span class="badge bg-light text-success">{{ matched_classes|length }} Matched</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="3%"></th>
                                            <th width="20%">Extracted Class</th>
                                            <th width="20%">Linked To</th>
                                            <th width="10%">Confidence</th>
                                            <th width="30%">Definition</th>
                                            <th width="15%">Properties</th>
                                            <th width="2%">Src</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cls in matched_classes %}
                                        <tr>
                                            <td class="text-center">
                                                {% if cls.is_published %}
                                                <span class="badge bg-success rounded-circle p-1" title="Published to OntServe">
                                                    <i class="bi bi-check-lg"></i>
                                                </span>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle delete-entity-btn p-0"
                                                        style="width: 24px; height: 24px; line-height: 1;"
                                                        data-entity-id="{{ cls.id }}"
                                                        data-entity-label="{{ cls.entity_label }}"
                                                        title="Remove this entity">
                                                    <i class="bi bi-x" style="font-size: 14px;"></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong>{{ cls.entity_label }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge match-status-badge match-linked"
                                                      style="background-color: #28a745; color: #fff;"
                                                      data-bs-toggle="modal" data-bs-target="#matchDetailsModal"
                                                      data-entity-id="{{ cls.id }}"
                                                      data-entity-label="{{ cls.entity_label }}"
                                                      data-matched-uri="{{ cls.matched_ontology_uri }}"
                                                      data-matched-label="{{ cls.matched_ontology_label or 'Unknown' }}"
                                                      data-confidence="{{ cls.match_confidence or 0 }}"
                                                      data-method="{{ cls.match_method or 'llm' }}"
                                                      data-reasoning="{{ cls.match_reasoning or '' }}">
                                                    <i class="bi bi-link-45deg"></i> {{ cls.matched_ontology_label or cls.matched_ontology_uri.split('#')[-1] }}
                                                </span>
                                            </td>
                                            <td>
                                                {% set confidence = cls.match_confidence or 0 %}
                                                <div class="match-confidence-bar" style="width: 60px;">
                                                    <div class="match-confidence-fill {% if confidence >= 0.90 %}confidence-high{% elif confidence >= 0.75 %}confidence-medium{% else %}confidence-low{% endif %}"
                                                         style="width: {{ (confidence * 100)|int }}%"></div>
                                                </div>
                                                <small class="text-muted">{{ (confidence * 100)|int }}%</small>
                                            </td>
                                            <td><small>{{ cls.entity_definition[:80] if cls.entity_definition else '-' }}{% if cls.entity_definition and cls.entity_definition|length > 80 %}...{% endif %}</small></td>
                                            <td>
                                                {% if cls.rdf_json_ld and cls.rdf_json_ld.properties %}
                                                <small class="text-muted">{{ cls.rdf_json_ld.properties|length }} props</small>
                                                {% else %}
                                                <small class="text-muted">-</small>
                                                {% endif %}
                                            </td>
                                            <td><small>C{{ cls.case_id }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- NEW CLASSES SUB-SECTION -->
            {% if new_classes %}
            <div class="row mb-5">
                <div class="col-12">
                    <h5 class="mb-3">New {{ concept_type|title }} Classes</h5>
                    <div class="card border-primary shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">
                                        <i class="fas fa-plus-circle"></i>
                                        Classes to Add to proethica-intermediate
                                    </h6>
                                    <small>These are new {{ concept_type }} types not currently in the ontology</small>
                                </div>
                                <span class="badge bg-light text-primary">{{ new_classes|length }} New</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="3%"></th>
                                            <th width="22%">Class Label</th>
                                            <th width="35%">Definition</th>
                                            <th width="38%">Properties & Relations</th>
                                            <th width="2%">Src</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cls in new_classes %}
                                        <tr>
                                            <td class="text-center">
                                                {% if cls.is_published %}
                                                <span class="badge bg-success rounded-circle p-1" title="Published to OntServe">
                                                    <i class="bi bi-check-lg"></i>
                                                </span>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle delete-entity-btn p-0"
                                                        style="width: 24px; height: 24px; line-height: 1;"
                                                        data-entity-id="{{ cls.id }}"
                                                        data-entity-label="{{ cls.entity_label }}"
                                                        title="Remove this entity">
                                                    <i class="bi bi-x" style="font-size: 14px;"></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong>{{ cls.entity_label }}</strong>
                                                <br/>
                                                <small class="text-muted">rdfs:subClassOf {{ concept_type|title }}</small>
                                                {% if cls.rdf_json_ld and cls.rdf_json_ld.get('source_text') %}
                                                <br/>
                                                <small class="text-info"><i class="fas fa-quote-left"></i> "{{ cls.rdf_json_ld.get('source_text')[:100] }}..."</small>
                                                {% endif %}
                                            </td>
                                            <td><small>{{ cls.entity_definition or '-' }}</small></td>
                                            <td>
                                                <div class="rdf-properties" style="font-size: 0.85rem;">
                                                    {% if cls.rdf_json_ld and cls.rdf_json_ld.properties %}
                                                        {% for prop_name, prop_values in cls.rdf_json_ld.properties.items() if prop_name not in ['wasGeneratedAt', 'wasAttributedTo', 'discoveredInCase'] and prop_values %}
                                                            <div class="mb-1 property-item" data-property="{{ prop_name }}">
                                                                <strong class="property-name">
                                                                    {{ prop_name | camel_to_readable }}:
                                                                </strong>
                                                                <span class="property-value">
                                                                    {% if prop_values is string %}
                                                                        {{ prop_values }}
                                                                    {% elif prop_values is iterable %}
                                                                        {% if prop_values|length > 1 %}
                                                                            {# Check if first item is a single character (indicates string treated as list) #}
                                                                            {% if prop_values[0]|length == 1 %}
                                                                                {# It's a string that was split into characters, join it back #}
                                                                                {{ prop_values|join('') }}
                                                                            {% else %}
                                                                                {# It's a real list, display as list #}
                                                                                <ul class="list-unstyled ms-3 mb-0">
                                                                                {% for val in prop_values if val %}
                                                                                    <li>• {{ val }}</li>
                                                                                {% endfor %}
                                                                                </ul>
                                                                            {% endif %}
                                                                        {% elif prop_values|length == 1 %}
                                                                            {{ prop_values[0] }}
                                                                        {% else %}
                                                                            <small class="text-muted">-</small>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        {{ prop_values }}
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <small class="text-muted">No additional properties</small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td><small>C{{ cls.case_id }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {# Show message if no classes at all #}
            {% if not matched_classes and not new_classes %}
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i>
                        No {{ concept_type }} classes were identified in this section.
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Show existing OntServe classes for reference (always visible) -->
            {% if ontserve_classes and ontserve_classes[concept_type] %}
            <div class="row mb-3">
                <div class="col-12">
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#ontserve-{{ concept_type }}-classes" role="button" aria-expanded="false">
                        <i class="fas fa-chevron-down"></i>
                        <strong>Available {{ concept_type|title }} Classes in OntServe</strong>
                        <span class="badge bg-secondary">{{ ontserve_classes[concept_type]|length }}</span>
                    </a>
                    <div class="collapse mt-2" id="ontserve-{{ concept_type }}-classes">
                        <div class="card card-body bg-light">
                            <small class="text-muted mb-2">
                                These {{ concept_type }} classes already exist in the shared ontology.
                                Individuals extracted below are typed using these classes.
                            </small>
                            <div class="row">
                                {% for cls in ontserve_classes[concept_type]|sort(attribute='label') %}
                                <div class="col-md-6 col-lg-4 mb-2">
                                    <div class="border rounded p-2 bg-white h-100">
                                        <strong class="text-primary">{{ cls.label }}</strong>
                                        {% if cls.description %}
                                        <br/><small class="text-muted">{{ cls.description[:100] }}{% if cls.description|length > 100 %}...{% endif %}</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- INDIVIDUALS SUB-SECTION -->
            {% if type_data.individuals %}
            <div class="row mb-5">
                <div class="col-12">
                    <h5 class="mb-3">{{ concept_type|title }} Individuals</h5>
                    <div class="card border-info shadow-sm">
                        <div class="card-header bg-info text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">
                                        <i class="fas fa-users"></i>
                                        Individuals to Add to proethica-case-{{ case.id }}
                                    </h5>
                                    <small>Specific people, organizations, and entities in this case</small>
                                </div>
                                <span class="badge bg-light text-info">{{ type_data.individuals|length }} Individuals</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th width="3%"></th>
                                            <th width="22%">Individual</th>
                                            <th width="15%">rdf:type</th>
                                            <th width="58%">Properties & Relations</th>
                                            <th width="2%">Src</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for indiv in type_data.individuals %}
                                        <tr>
                                            <td class="text-center">
                                                {% if indiv.is_published %}
                                                <span class="badge bg-success rounded-circle p-1" title="Published to OntServe">
                                                    <i class="bi bi-check-lg"></i>
                                                </span>
                                                {% else %}
                                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle delete-entity-btn p-0"
                                                        style="width: 24px; height: 24px; line-height: 1;"
                                                        data-entity-id="{{ indiv.id }}"
                                                        data-entity-label="{{ indiv.entity_label }}"
                                                        title="Remove this entity">
                                                    <i class="bi bi-x" style="font-size: 14px;"></i>
                                                </button>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <strong>{{ indiv.entity_label }}</strong>
                                                <br/>
                                                <small class="text-muted">Individual Instance</small>
                                                {% if indiv.rdf_json_ld and indiv.rdf_json_ld.get('source_text') %}
                                                <br/>
                                                <small class="text-info"><i class="fas fa-quote-left"></i> "{{ indiv.rdf_json_ld.get('source_text')[:100] }}..."</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if indiv.rdf_json_ld and indiv.rdf_json_ld.types %}
                                                    {% for type in indiv.rdf_json_ld.types %}
                                                        <span class="badge bg-secondary">{{ type.split('#')[-1] if '#' in type else type.split('/')[-1] }}</span><br/>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="rdf-properties" style="font-size: 0.85rem;">
                                                    {# Display properties - same approach as classes #}
                                                    {# Use namespace to persist variable across loops #}
                                                    {% set ns = namespace(has_content=false) %}
                                                    {% if indiv.rdf_json_ld and indiv.rdf_json_ld.properties %}
                                                        {% for prop_name, prop_values in indiv.rdf_json_ld.properties.items() if prop_name not in ['wasGeneratedAt', 'wasAttributedTo', 'discoveredInCase'] and prop_values %}
                                                            {% set ns.has_content = true %}
                                                            <div class="mb-1 property-item" data-property="{{ prop_name }}" data-type="property">
                                                                <strong class="property-name">
                                                                    {{ prop_name | camel_to_readable }}:
                                                                </strong>
                                                                <span class="property-value">
                                                                    {% if prop_values is string %}
                                                                        {{ prop_values }}
                                                                    {% elif prop_values is iterable %}
                                                                        {% if prop_values|length > 1 %}
                                                                            {# Check if first item is a single character (indicates string treated as list) #}
                                                                            {% if prop_values[0]|length == 1 %}
                                                                                {# It's a string that was split into characters, join it back #}
                                                                                {{ prop_values|join('') }}
                                                                            {% else %}
                                                                                {# It's a real list, display as list #}
                                                                                <ul class="list-unstyled ms-3 mb-0">
                                                                                {% for val in prop_values if val %}
                                                                                    <li>• {{ val }}</li>
                                                                                {% endfor %}
                                                                                </ul>
                                                                            {% endif %}
                                                                        {% elif prop_values|length == 1 %}
                                                                            {{ prop_values[0] }}
                                                                        {% else %}
                                                                            <small class="text-muted">-</small>
                                                                        {% endif %}
                                                                    {% else %}
                                                                        {{ prop_values }}
                                                                    {% endif %}
                                                                </span>
                                                            </div>
                                                        {% endfor %}
                                                    {% endif %}

                                                    {# Display relationships #}
                                                    {% if indiv.rdf_json_ld and indiv.rdf_json_ld.relationships %}
                                                        {% set ns.has_content = true %}
                                                        {% for rel in indiv.rdf_json_ld.relationships %}
                                                            <div class="mb-1 property-item" data-property="{{ rel.type }}" data-type="relation">
                                                                <strong class="property-name">
                                                                    {{ rel.type | camel_to_readable }}:
                                                                </strong>
                                                                <span class="property-value text-info">
                                                                    {{ rel.target }}
                                                                </span>
                                                            </div>
                                                        {% endfor %}
                                                    {% endif %}

                                                    {# Show message if no content #}
                                                    {% if not ns.has_content %}
                                                        <small class="text-muted">No properties or relations</small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td><small>C{{ indiv.case_id if indiv.case_id else case.id }}</small></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

                        </div> <!-- End card-body -->
                    </div> <!-- End card -->
                </div> <!-- End col-12 -->
            </div> <!-- End row for concept type panel -->
            {% endif %} <!-- End if type_data.classes or type_data.individuals -->
            {% endfor %} <!-- End for concept_type loop -->

            <!-- End of RDF Entities Section -->
            <hr class="my-4">
            {% endif %}

            {% if section_data and (not rdf_data or rdf_data.total_rdf_entities == 0) %}
            <!-- Legacy Format Notice -->
            <div class="alert alert-warning mb-4">
                <h4><i class="fas fa-exclamation-triangle"></i> Legacy Format Detected</h4>
                <p>These entities were extracted using the old format. To see the enhanced display with all properties:</p>
                <ol>
                    <li>Clear all entities using the "Clear All Entities" button above</li>
                    <li>Go back to <a href="{{ url_for('scenario_pipeline.step1', case_id=case.id) }}">Step 1</a></li>
                    <li>Click "Extract Roles Only" to re-extract with the new format</li>
                </ol>
                <p>The new format will show:</p>
                <ul>
                    <li><strong>Classes</strong>: New professional role types with distinguishing features, scope, and qualifications</li>
                    <li><strong>Individuals</strong>: Specific people with attributes, relationships, and case involvement</li>
                </ul>
            </div>
            {% endif %}

            {% if not section_data and (not rdf_data or rdf_data.total_rdf_entities == 0) %}
            <!-- No entities found -->
            <div class="alert alert-info">
                <h4>No Extracted Entities Found</h4>
                <p>No entities have been extracted for this case yet. Try:</p>
                <ul>
                    <li>Go to <a href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}">Step 2</a> and extract principles, obligations, constraints, or capabilities individually</li>
                    <li>Run the complete entity extraction pass</li>
                    <li>Check the console logs for any extraction errors</li>
                </ul>
            </div>
            {% else %}

            <!-- Entity Sections (Old Format - only show if no RDF data) -->
            {% if not rdf_data or rdf_data.total_rdf_entities == 0 %}
            {% for section_type, section in section_data.items() %}
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4>{{ section.info.label }}</h4>
                            <p class="mb-0 text-muted">{{ section.info.description }}</p>
                        </div>
                        <div>
                            <span class="badge badge-primary">{{ section.count }} entities</span>
                            <span class="badge badge-success">{{ section.selected_count }} selected</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if section.entities %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="5%">
                                        <input type="checkbox" class="section-select-all"
                                               data-section="{{ section_type }}">
                                    </th>
                                    <th>Label</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Confidence</th>
                                    <th>Session</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entity in section.entities %}
                                <tr data-entity-id="{{ entity.id }}">
                                    <td>
                                        <input type="checkbox" class="entity-select"
                                               data-entity-id="{{ entity.id }}"
                                               {% if entity.concept_data.get('selected', False) %}checked{% endif %}>
                                    </td>
                                    <td>
                                        <strong>{{ entity.concept_data.get('label', 'Unknown') }}</strong>
                                        {% if entity.concept_data.get('category') == 'Role' %}
                                            <span class="badge badge-primary badge-sm ms-1">Role Class</span>
                                        {% elif entity.concept_data.get('category') == 'Individual' %}
                                            <span class="badge badge-info badge-sm ms-1">Individual</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-secondary">
                                            {{ entity.concept_data.get('category', 'Unknown') }}
                                        </span>
                                    </td>
                                    <td>
                                        {{ entity.concept_data.get('description', '')[:100] }}
                                        {% if entity.concept_data.get('description', '') | length > 100 %}...{% endif %}
                                    </td>
                                    <td>
                                        {% set confidence = entity.concept_data.get('confidence', 0.8) %}
                                        <span class="badge {% if confidence > 0.8 %}badge-success{% elif confidence > 0.6 %}badge-warning{% else %}badge-danger{% endif %}">
                                            {{ "%.2f" | format(confidence) }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ entity.session_id[-8:] }}</small>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary edit-entity"
                                                data-entity-id="{{ entity.id }}">
                                            Edit
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted">No entities in this section.</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endif %}

        </div>
    </div>
</div>

<!-- Edit Entity Modal -->
<div class="modal fade" id="editEntityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Entity</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editEntityForm">
                    <input type="hidden" id="editEntityId">
                    <div class="form-group">
                        <label for="editLabel">Label</label>
                        <input type="text" class="form-control" id="editLabel" required>
                    </div>
                    <div class="form-group">
                        <label for="editDescription">Description</label>
                        <textarea class="form-control" id="editDescription" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editReviewNotes">Review Notes</label>
                        <textarea class="form-control" id="editReviewNotes" rows="2"
                                  placeholder="Add any review notes or modifications..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveEntityBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Match Details Modal -->
<div class="modal fade" id="matchDetailsModal" tabindex="-1" aria-labelledby="matchDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="matchDetailsModalLabel">
                    <i class="bi bi-link-45deg"></i> Entity Match Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="matchEntityId">

                <!-- Entity Label -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Entity</label>
                    <div class="form-control-plaintext fs-5" id="matchEntityLabel">-</div>
                </div>

                <!-- Current Match Status -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong>Current Match</strong>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Matched Class</label>
                                <div id="matchedClassLabel" class="fw-bold">-</div>
                                <small id="matchedClassUri" class="text-muted">-</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Confidence</label>
                                <div id="matchConfidenceValue" class="fw-bold">-</div>
                                <div class="progress" style="height: 8px;">
                                    <div id="matchConfidenceBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Match Method</label>
                                <div id="matchMethodValue">-</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small">Status</label>
                                <div id="matchStatusBadge">-</div>
                            </div>
                        </div>
                        <div class="row mt-3" id="matchReasoningSection">
                            <div class="col-12">
                                <label class="form-label text-muted small">Reasoning</label>
                                <div id="matchReasoningValue" class="small bg-light p-2 rounded">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manual Override Section -->
                {% if current_user.is_authenticated %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong>Manual Override</strong>
                        <small class="text-muted ms-2">(Admin only)</small>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Search for Alternative Match</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchMatchInput"
                                       placeholder="Search OntServe classes...">
                                <button class="btn btn-outline-secondary" type="button" id="searchMatchBtn">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                        <div id="searchResults" class="mb-3" style="max-height: 200px; overflow-y: auto; display: none;">
                            <!-- Search results will be populated here -->
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-success" id="confirmMatchBtn" disabled>
                                <i class="bi bi-check-circle"></i> Confirm Current Match
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="markAsNewBtn">
                                <i class="bi bi-plus-circle"></i> Mark as New Class
                            </button>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <a href="{{ url_for('auth.login') }}">Login</a> to manually adjust entity matches.
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% if current_user.is_authenticated %}
                <button type="button" class="btn btn-primary" id="saveMatchBtn" disabled>
                    <i class="bi bi-save"></i> Save Changes
                </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const caseId = {{ case.id }};
    const sectionType = {{ section_type | tojson if section_type else 'null' }};

    // Load session count
    appFetch(`/scenario_pipeline/case/${caseId}/entities/sessions`)
        .then(response => response.json())
        .then(data => {
            const sessionCountElement = document.getElementById('sessionCount');
            if (sessionCountElement && data.total_sessions !== undefined) {
                sessionCountElement.textContent = data.total_sessions;
            }
        })
        .catch(error => {
            const sessionCountElement = document.getElementById('sessionCount');
            if (sessionCountElement) {
                sessionCountElement.textContent = 'Error';
            }
            console.error('Error loading sessions:', error);
        });

    // Auto-select all uncommitted entities on page load
    // and update their selection status in the database
    const uncommittedCheckboxes = document.querySelectorAll('.rdf-entity-checkbox:checked');
    uncommittedCheckboxes.forEach(checkbox => {
        const entityId = checkbox.dataset.entityId;
        const entityType = checkbox.dataset.entityType;
        // Update selection status in database for pre-checked items
        updateRDFEntitySelection(entityId, entityType, true);
    });

    // Also update the select-all checkboxes to match the state
    document.querySelectorAll('.rdf-class-select-all').forEach(selectAll => {
        const conceptType = selectAll.dataset.conceptType;
        const allClassBoxes = document.querySelectorAll(`.rdf-entity-checkbox[data-entity-type="class"][data-concept-type="${conceptType}"]`);
        const checkedClassBoxes = document.querySelectorAll(`.rdf-entity-checkbox[data-entity-type="class"][data-concept-type="${conceptType}"]:checked`);
        if (allClassBoxes.length > 0 && allClassBoxes.length === checkedClassBoxes.length) {
            selectAll.checked = true;
        }
    });

    document.querySelectorAll('.rdf-individual-select-all').forEach(selectAll => {
        const conceptType = selectAll.dataset.conceptType;
        const allIndivBoxes = document.querySelectorAll(`.rdf-entity-checkbox[data-entity-type="individual"][data-concept-type="${conceptType}"]`);
        const checkedIndivBoxes = document.querySelectorAll(`.rdf-entity-checkbox[data-entity-type="individual"][data-concept-type="${conceptType}"]:checked`);
        if (allIndivBoxes.length > 0 && allIndivBoxes.length === checkedIndivBoxes.length) {
            selectAll.checked = true;
        }
    });

    // Entity selection handling
    document.querySelectorAll('.entity-select').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const entityId = this.dataset.entityId;
            const selected = this.checked;
            updateEntitySelection(entityId, selected);
        });
    });

    // RDF Entity selection handling
    document.querySelectorAll('.rdf-entity-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const entityId = this.dataset.entityId;
            const entityType = this.dataset.entityType;
            const selected = this.checked;
            updateRDFEntitySelection(entityId, entityType, selected);
        });
    });

    // RDF Class select all handling - per concept type
    document.querySelectorAll('.rdf-class-select-all').forEach(selectAll => {
        selectAll.addEventListener('change', function() {
            const checked = this.checked;
            const conceptType = this.dataset.conceptType;
            // Only select checkboxes within the same concept type
            document.querySelectorAll(`.rdf-entity-checkbox[data-entity-type="class"][data-concept-type="${conceptType}"]`).forEach(checkbox => {
                checkbox.checked = checked;
                updateRDFEntitySelection(checkbox.dataset.entityId, 'class', checked);
            });
        });
    });

    // RDF Individual select all handling - per concept type
    document.querySelectorAll('.rdf-individual-select-all').forEach(selectAll => {
        selectAll.addEventListener('change', function() {
            const checked = this.checked;
            const conceptType = this.dataset.conceptType;
            // Only select checkboxes within the same concept type
            document.querySelectorAll(`.rdf-entity-checkbox[data-entity-type="individual"][data-concept-type="${conceptType}"]`).forEach(checkbox => {
                checkbox.checked = checked;
                updateRDFEntitySelection(checkbox.dataset.entityId, 'individual', checked);
            });
        });
    });

    // Section select all handling
    document.querySelectorAll('.section-select-all').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const section = this.dataset.section;
            const checked = this.checked;

            const card = this.closest('.card');
            card.querySelectorAll('.entity-select').forEach(entityCheckbox => {
                entityCheckbox.checked = checked;
                const entityId = entityCheckbox.dataset.entityId;
                updateEntitySelection(entityId, checked);
            });
        });
    });

    // Edit entity handling (placeholder for future functionality)
    document.querySelectorAll('.edit-entity').forEach(button => {
        button.addEventListener('click', function() {
            const entityId = this.dataset.entityId;
            // For now, just show a placeholder modal
            document.getElementById('editEntityId').value = entityId;
            // Note: Bootstrap modal would need to be handled differently without jQuery
            console.log('Edit entity:', entityId);
        });
    });

    // Foundation for property editing (future functionality)
    // This code prepares for inline property editing capability
    function preparePropertyEditing() {
        // Add data attributes to property items for future editing
        document.querySelectorAll('.property-item').forEach(item => {
            const entityRow = item.closest('tr');
            const entityCheckbox = entityRow?.querySelector('.rdf-entity-checkbox');
            if (entityCheckbox) {
                item.setAttribute('data-entity-id', entityCheckbox.dataset.entityId);
                item.setAttribute('data-entity-type', entityCheckbox.dataset.entityType);
            }

            // Double-click handler (currently disabled)
            item.addEventListener('dblclick', function(e) {
                // Uncomment when edit functionality is implemented
                // e.preventDefault();
                // startPropertyEdit(this);
            });
        });
    }

    // Call preparation function
    preparePropertyEditing();

    // Future edit functions (placeholders)
    function startPropertyEdit(propertyElement) {
        // Will be implemented to enable inline editing
        console.log('Property editing will be available in future update');
    }

    function savePropertyEdit(propertyElement, newValue) {
        // Will be implemented to save edited properties
        console.log('Property saving will be available in future update');
    }

    function cancelPropertyEdit(propertyElement) {
        // Will be implemented to cancel property editing
        console.log('Cancel editing will be available in future update');
    }

    // Delete entity buttons
    document.querySelectorAll('.delete-entity-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const entityId = this.dataset.entityId;
            const entityLabel = this.dataset.entityLabel;

            if (confirm(`Remove entity "${entityLabel}" from this case?`)) {
                const btnElement = this;
                btnElement.disabled = true;
                btnElement.innerHTML = '<i class="bi bi-hourglass"></i>';

                appFetch(`/scenario_pipeline/case/${caseId}/rdf_entities/${entityId}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the row from the table
                        const row = btnElement.closest('tr');
                        if (row) {
                            row.remove();
                        }
                        console.log(`Deleted entity: ${entityLabel}`);
                    } else {
                        alert(`Error: ${data.error}`);
                        btnElement.disabled = false;
                        btnElement.innerHTML = '<i class="bi bi-x-lg"></i>';
                    }
                })
                .catch(error => {
                    console.error('Delete error:', error);
                    alert(`Error deleting entity: ${error}`);
                    btnElement.disabled = false;
                    btnElement.innerHTML = '<i class="bi bi-x-lg"></i>';
                });
            }
        });
    });

    // Legacy: Commit button code removed - publishing moved to Step 4 Review

    function updateEntitySelection(entityId, selected) {
        appFetch(`/scenario_pipeline/case/${caseId}/entities/update_selection`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                entity_id: entityId,
                selected: selected,
                review_notes: ''
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update selected count
                updateSelectedCount();
            } else {
                console.error('Error updating selection:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating selection:', error);
        });
    }

    function updateRDFEntitySelection(entityId, entityType, selected) {
        appFetch(`/scenario_pipeline/case/${caseId}/rdf_entities/update_selection`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
            },
            body: JSON.stringify({
                entity_id: entityId,
                entity_type: entityType,
                selected: selected
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update selected count
                updateSelectedCount();
            } else {
                console.error('Error updating RDF entity selection:', data.error);
            }
        })
        .catch(error => {
            console.error('Error updating RDF entity selection:', error);
        });
    }

    function updateSelectedCount() {
        const selectedCount = document.querySelectorAll('.entity-select:checked').length;
        const rdfSelectedCount = document.querySelectorAll('.rdf-entity-checkbox:checked').length;
        const totalSelected = selectedCount + rdfSelectedCount;
        const selectedCountElement = document.getElementById('selectedCount');
        if (selectedCountElement) {
            selectedCountElement.textContent = totalSelected;
        }
    }

    // Match Details Modal handling
    const matchDetailsModal = document.getElementById('matchDetailsModal');
    if (matchDetailsModal) {
        matchDetailsModal.addEventListener('show.bs.modal', function(event) {
            const trigger = event.relatedTarget;
            if (!trigger) return;

            // Get data from the trigger element
            const entityId = trigger.dataset.entityId;
            const entityLabel = trigger.dataset.entityLabel;
            const matchedUri = trigger.dataset.matchedUri;
            const matchedLabel = trigger.dataset.matchedLabel;
            const confidence = parseFloat(trigger.dataset.confidence) || 0;
            const method = trigger.dataset.method || 'unknown';
            const reasoning = trigger.dataset.reasoning || '';

            // Populate modal fields
            document.getElementById('matchEntityId').value = entityId;
            document.getElementById('matchEntityLabel').textContent = entityLabel;

            // Matched class info
            if (matchedUri) {
                document.getElementById('matchedClassLabel').textContent = matchedLabel || 'Unknown';
                document.getElementById('matchedClassUri').textContent = matchedUri;
            } else {
                document.getElementById('matchedClassLabel').textContent = 'No match';
                document.getElementById('matchedClassUri').textContent = 'Entity marked as new class';
            }

            // Confidence
            const confidencePercent = Math.round(confidence * 100);
            document.getElementById('matchConfidenceValue').textContent = `${confidencePercent}%`;
            const confidenceBar = document.getElementById('matchConfidenceBar');
            confidenceBar.style.width = `${confidencePercent}%`;
            confidenceBar.className = 'progress-bar';
            if (confidence >= 0.90) {
                confidenceBar.classList.add('bg-success');
            } else if (confidence >= 0.75) {
                confidenceBar.classList.add('bg-warning');
            } else if (confidence > 0) {
                confidenceBar.classList.add('bg-danger');
            } else {
                confidenceBar.classList.add('bg-secondary');
            }

            // Method
            const methodDisplay = {
                'llm': 'LLM Extraction',
                'embedding': 'Embedding Similarity',
                'manual': 'Manual Override',
                'label_match': 'Label Match'
            };
            document.getElementById('matchMethodValue').textContent = methodDisplay[method] || method || 'Not specified';

            // Status badge
            const statusBadge = document.getElementById('matchStatusBadge');
            if (matchedUri) {
                if (confidence >= 0.90) {
                    statusBadge.innerHTML = '<span class="badge bg-success">Auto-Linked</span>';
                } else if (confidence >= 0.75) {
                    statusBadge.innerHTML = '<span class="badge bg-warning text-dark">Needs Review</span>';
                } else {
                    statusBadge.innerHTML = '<span class="badge bg-secondary">Low Confidence</span>';
                }
            } else {
                statusBadge.innerHTML = '<span class="badge bg-secondary">New Class</span>';
            }

            // Reasoning
            const reasoningSection = document.getElementById('matchReasoningSection');
            const reasoningValue = document.getElementById('matchReasoningValue');
            if (reasoning) {
                reasoningSection.style.display = 'block';
                reasoningValue.textContent = reasoning;
            } else {
                reasoningSection.style.display = 'none';
            }

            // Enable/disable buttons
            const confirmBtn = document.getElementById('confirmMatchBtn');
            if (confirmBtn) {
                confirmBtn.disabled = !matchedUri;
            }
        });

        // Search for alternative matches
        const searchBtn = document.getElementById('searchMatchBtn');
        const searchInput = document.getElementById('searchMatchInput');
        const searchResults = document.getElementById('searchResults');

        if (searchBtn && searchInput && searchResults) {
            searchBtn.addEventListener('click', function() {
                const query = searchInput.value.trim();
                if (!query) return;

                searchBtn.disabled = true;
                searchBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Searching...';

                appFetch(`/scenario_pipeline/case/${caseId}/entities/search_ontserve?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        searchResults.innerHTML = '';
                        searchResults.style.display = 'block';

                        if (data.success && data.results && data.results.length > 0) {
                            data.results.forEach(result => {
                                const item = document.createElement('div');
                                item.className = 'border rounded p-2 mb-2 search-result-item';
                                item.style.cursor = 'pointer';
                                item.innerHTML = `
                                    <strong>${result.label}</strong>
                                    <br/><small class="text-muted">${result.uri}</small>
                                    ${result.description ? `<br/><small>${result.description.substring(0, 100)}...</small>` : ''}
                                `;
                                item.addEventListener('click', function() {
                                    // Highlight selected
                                    document.querySelectorAll('.search-result-item').forEach(el => el.classList.remove('border-primary'));
                                    this.classList.add('border-primary');

                                    // Store selected match
                                    searchResults.dataset.selectedUri = result.uri;
                                    searchResults.dataset.selectedLabel = result.label;

                                    // Enable save button
                                    const saveBtn = document.getElementById('saveMatchBtn');
                                    if (saveBtn) saveBtn.disabled = false;
                                });
                                searchResults.appendChild(item);
                            });
                        } else {
                            searchResults.innerHTML = '<div class="text-muted">No matching classes found</div>';
                        }
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        searchResults.innerHTML = '<div class="text-danger">Search failed</div>';
                        searchResults.style.display = 'block';
                    })
                    .finally(() => {
                        searchBtn.disabled = false;
                        searchBtn.innerHTML = '<i class="bi bi-search"></i> Search';
                    });
            });

            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
        }

        // Mark as new class
        const markAsNewBtn = document.getElementById('markAsNewBtn');
        if (markAsNewBtn) {
            markAsNewBtn.addEventListener('click', function() {
                const entityId = document.getElementById('matchEntityId').value;
                if (!entityId) return;

                if (!confirm('Mark this entity as a new class? This will clear any existing match.')) return;

                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

                appFetch(`/scenario_pipeline/case/${caseId}/entities/${entityId}/mark_new`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Entity marked as new class');
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Mark as new error:', error);
                    alert(`Error: ${error}`);
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-plus-circle"></i> Mark as New Class';
                });
            });
        }

        // Save match changes
        const saveMatchBtn = document.getElementById('saveMatchBtn');
        if (saveMatchBtn) {
            saveMatchBtn.addEventListener('click', function() {
                const entityId = document.getElementById('matchEntityId').value;
                const selectedUri = searchResults?.dataset.selectedUri;
                const selectedLabel = searchResults?.dataset.selectedLabel;

                if (!entityId || !selectedUri) {
                    alert('Please select a match from the search results first');
                    return;
                }

                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';

                appFetch(`/scenario_pipeline/case/${caseId}/entities/${entityId}/set_match`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        matched_uri: selectedUri,
                        matched_label: selectedLabel,
                        method: 'manual',
                        confidence: 1.0
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Match updated successfully');
                        location.reload();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Save match error:', error);
                    alert(`Error: ${error}`);
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="bi bi-save"></i> Save Changes';
                });
            });
        }
    }
});
</script>

{% endblock %}