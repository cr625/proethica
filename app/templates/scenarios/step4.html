{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 4: Case Synthesis{% endblock %}
{% block step_header %}Step 4: Case Synthesis{% endblock %}
{% block step_subtitle %}Build a coherent case model from extracted entities{% endblock %}

{% block step_content %}

<!-- Synthesis Pipeline Overview -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3-fill"></i> Four-Phase Synthesis Pipeline
        </h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div id="phase1-indicator" class="phase-indicator phase-complete">
                    <span class="phase-number">1</span>
                    <div class="phase-label">Entity Foundation</div>
                    <small class="text-muted">Passes 1-3 entities</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase2-indicator" class="phase-indicator">
                    <span class="phase-number">2</span>
                    <div class="phase-label">Analytical Extraction</div>
                    <small class="text-muted">Provisions, Q&C, Rich Analysis</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase3-indicator" class="phase-indicator">
                    <span class="phase-number">3</span>
                    <div class="phase-label">Decision Synthesis</div>
                    <small class="text-muted">E1-E3 + LLM</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase4-indicator" class="phase-indicator">
                    <span class="phase-number">4</span>
                    <div class="phase-label">Narrative</div>
                    <small class="text-muted">Timeline + Scenario</small>
                </div>
            </div>
        </div>

        <hr>

        <div class="text-center">
            {% if current_user.is_authenticated %}
            <button type="button" id="run-complete-synthesis-btn" class="btn btn-primary btn-lg" onclick="runCompleteSynthesis()">
                <i class="bi bi-play-circle"></i> Run Complete Synthesis
            </button>
            <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-outline-secondary btn-lg ms-2">
                <i class="bi bi-eye"></i> Review Results
            </a>
            {% else %}
            <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='{{ url_for('auth.login') }}';">
                <i class="bi bi-lock-fill"></i> Login to Run Synthesis
            </button>
            {% endif %}
            <div id="synthesis-progress-text" class="mt-2 text-muted"></div>
        </div>
    </div>
</div>

<!-- Phase 1: Entity Foundation (Display only - no extraction) -->
<div class="card mb-4" id="phase1-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <span class="badge bg-success me-2">Phase 1</span> Entity Foundation
        </h5>
        <span id="phase1-status" class="badge bg-success">{{ entities_summary.total }} entities</span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-muted">Pass 1: Contextual Framework</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-primary me-1">{{ entities_summary.roles }}</span> Roles</li>
                    <li><span class="badge bg-info me-1">{{ entities_summary.states }}</span> States</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.resources }}</span> Resources</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Pass 2: Normative Requirements</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-purple me-1">{{ entities_summary.principles }}</span> Principles</li>
                    <li><span class="badge bg-warning text-dark me-1">{{ entities_summary.obligations }}</span> Obligations</li>
                    <li><span class="badge bg-danger me-1">{{ entities_summary.constraints }}</span> Constraints</li>
                    <li><span class="badge bg-success me-1">{{ entities_summary.capabilities }}</span> Capabilities</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Pass 3: Temporal Dynamics</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-dark me-1">{{ entities_summary.actions }}</span> Actions</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.events }}</span> Events</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Phase 2: Analytical Extraction - Individual Tasks -->
<div class="card mb-4" id="phase2-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 2</span> Analytical Extraction
        </h5>
    </div>
    <div class="card-body">
        <!-- 2A: Code Provisions -->
        <div class="extractor-section mb-4" id="provisionsSection">
            <div class="step-card border-secondary">
                <div class="step-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-file-text text-secondary"></i> 2A: Code Provisions Extraction
                            <span id="provisionsCount" class="badge bg-secondary ms-2">{{ synthesis_status.provisions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="extractTask('provisions')" id="extractProvisionsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="provisionsPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="provisionsPromptText"></div>
                    </div>
                    <div class="results-preview" id="provisionsResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="provisionsResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2B: Questions -->
        <div class="extractor-section mb-4" id="questionsSection">
            <div class="step-card border-warning">
                <div class="step-header bg-warning bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle text-warning"></i> 2B: Ethical Questions Extraction
                            <span id="questionsCount" class="badge bg-warning text-dark ms-2">{{ synthesis_status.questions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-warning btn-sm" onclick="extractTask('questions')" id="extractQuestionsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="questionsPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="questionsPromptText"></div>
                    </div>
                    <div class="results-preview" id="questionsResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="questionsResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2C: Conclusions -->
        <div class="extractor-section mb-4" id="conclusionsSection">
            <div class="step-card border-success">
                <div class="step-header bg-success bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-check-circle text-success"></i> 2C: Board Conclusions Extraction
                            <span id="conclusionsCount" class="badge bg-success ms-2">{{ synthesis_status.conclusions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-success btn-sm" onclick="extractTask('conclusions')" id="extractConclusionsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="conclusionsPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="conclusionsPromptText"></div>
                    </div>
                    <div class="results-preview" id="conclusionsResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="conclusionsResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2D: Transformation Classification -->
        <div class="extractor-section mb-4" id="transformationSection">
            <div class="step-card border-purple">
                <div class="step-header bg-purple bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-shuffle text-purple"></i> 2D: Transformation Classification
                            <span id="transformationType" class="badge bg-purple ms-2">{{ synthesis_status.transformation_type or 'Not classified' }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="extractTask('transformation')" id="extractTransformationBtn">
                            <i class="bi bi-play-fill"></i> Classify
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="transformationPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="transformationPromptText"></div>
                    </div>
                    <div class="results-preview" id="transformationResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="transformationResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2E: Rich Analysis -->
        <div class="extractor-section mb-4" id="rich_analysisSection">
            <div class="step-card border-info">
                <div class="step-header bg-info bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-diagram-3 text-info"></i> 2E: Rich Analysis
                            <small class="text-muted">(Causal Links, Question Emergence, Resolution Patterns)</small>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-info btn-sm" onclick="extractTask('rich_analysis')" id="extractRich_analysisBtn">
                            <i class="bi bi-play-fill"></i> Analyze
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="rich_analysisPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompts (3 analyses)</h6>
                        </div>
                        <div class="prompt-text" id="rich_analysisPromptText"></div>
                    </div>
                    <div class="results-preview" id="rich_analysisResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Responses</h6>
                        </div>
                        <div id="rich_analysisResultsContent"></div>
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <strong>Causal-Normative Links:</strong>
                                <span id="causalLinksCount" class="badge bg-info">0</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Question Emergence:</strong>
                                <span id="questionEmergenceCount" class="badge bg-warning text-dark">0</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Resolution Patterns:</strong>
                                <span id="resolutionPatternsCount" class="badge bg-success">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 3: Decision Point Synthesis -->
<div class="card mb-4" id="phase3-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 3</span> Decision Point Synthesis
        </h5>
    </div>
    <div class="card-body">
        <div class="extractor-section" id="decisionSynthesisSection">
            <div class="step-card border-primary">
                <div class="step-header bg-primary bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-bullseye text-primary"></i> Decision Point Synthesis (E1-E3 + LLM)
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-primary btn-sm" onclick="extractTask('decision_synthesis')" id="extractDecisionSynthesisBtn">
                            <i class="bi bi-play-fill"></i> Synthesize
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <p class="text-muted small mb-3">
                        Combines E1-E3 algorithmic composition with LLM refinement using Q&C as ground truth.
                    </p>

                    <!-- Algorithmic Steps -->
                    <div class="row text-center small mb-3" id="algorithmicSteps">
                        <div class="col border-end">
                            <span id="step-e1" class="badge bg-secondary mb-1">E1</span><br>
                            Coverage Analysis<br>
                            <span id="e1Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-e2" class="badge bg-secondary mb-1">E2</span><br>
                            Action Mapping<br>
                            <span id="e2Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-e3" class="badge bg-secondary mb-1">E3</span><br>
                            Composition<br>
                            <span id="e3Result" class="text-muted">-</span>
                        </div>
                        <div class="col">
                            <span id="step-llm" class="badge bg-secondary mb-1">LLM</span><br>
                            Refinement<br>
                            <span id="llmResult" class="text-muted">-</span>
                        </div>
                    </div>

                    <div class="prompt-preview mb-3" id="decisionSynthesisPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt (Refinement)</h6>
                        </div>
                        <div class="prompt-text" id="decisionSynthesisPromptText"></div>
                    </div>
                    <div class="results-preview" id="decisionSynthesisResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="decisionSynthesisResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 4: Narrative Construction -->
<div class="card mb-4" id="phase4-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 4</span> Narrative Construction
        </h5>
    </div>
    <div class="card-body">
        <div class="extractor-section" id="narrativeSection">
            <div class="step-card border-dark">
                <div class="step-header bg-dark bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-clock-history text-dark"></i> Narrative Construction (Timeline + Scenario Seeds)
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-dark btn-sm" onclick="extractTask('narrative')" id="extractNarrativeBtn">
                            <i class="bi bi-play-fill"></i> Construct
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="narrativePromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="narrativePromptText"></div>
                    </div>
                    <div class="results-preview" id="narrativeResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="narrativeResultsContent"></div>
                    </div>

                    <!-- Case Summary (shown after extraction) -->
                    <div id="case-summary-area" style="display: none;">
                        <hr>
                        <h6>Case Summary</h6>
                        <div id="case-summary-text" class="alert alert-light mb-3"></div>
                    </div>

                    <!-- Timeline Preview (shown after extraction) -->
                    <div id="timeline-preview" style="display: none;">
                        <h6>Timeline</h6>
                        <div id="timeline-events" class="mb-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation to review page -->
<div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
    <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-primary btn-lg">
        <i class="bi bi-eye"></i> Review Step 4 Results
    </a>
</div>

{% endblock %}

{% block step_styles %}
<style>
    .phase-indicator {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .phase-indicator.phase-complete {
        background-color: #d4edda;
        border: 2px solid #28a745;
    }

    .phase-indicator.phase-active {
        background-color: #cce5ff;
        border: 2px solid #007bff;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    .phase-number {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        line-height: 2rem;
        text-align: center;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .phase-complete .phase-number {
        background-color: #28a745;
    }

    .phase-active .phase-number {
        background-color: #007bff;
    }

    .extractor-section .step-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .extractor-section .step-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .extractor-section .step-content {
        padding: 1rem;
    }

    .prompt-preview {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .prompt-text {
        font-size: 0.9rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .prompt-text-content {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: white;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
        max-height: 400px;
        overflow-y: auto;
    }

    .results-preview {
        background-color: #f0fff4;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #d4edda;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .text-purple {
        color: #6f42c1 !important;
    }

    .border-purple {
        border-color: #6f42c1 !important;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
const currentCaseId = {{ case.id }};

function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// Individual task extraction
function extractTask(taskType) {
    const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
    const promptSection = document.getElementById(`${taskType}PromptSection`);
    const resultsSection = document.getElementById(`${taskType}Results`);
    const promptText = document.getElementById(`${taskType}PromptText`);
    const resultsContent = document.getElementById(`${taskType}ResultsContent`);

    // Use streaming for provisions, questions, conclusions, transformation, and rich_analysis (shows real-time progress)
    if (taskType === 'provisions' || taskType === 'questions' || taskType === 'conclusions' || taskType === 'transformation' || taskType === 'rich_analysis') {
        extractTaskStreaming(taskType, button, promptSection, resultsSection, promptText, resultsContent);
        return;
    }

    // Map task types to endpoints (non-streaming)
    const endpoints = {
        'questions': 'extract_questions',
        'conclusions': 'extract_conclusions',
        'transformation': 'extract_transformation',
        'rich_analysis': 'extract_rich_analysis',
        'decision_synthesis': 'extract_decision_synthesis',
        'narrative': 'extract_narrative'
    };

    const endpoint = endpoints[taskType];
    if (!endpoint) {
        console.error('Unknown task type:', taskType);
        return;
    }

    // Disable button and show loading
    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    }

    // Clear previous results and show prompt section with loading
    if (promptSection) {
        promptSection.style.display = 'block';
        if (promptText) {
            promptText.innerHTML = '<div class="text-center text-muted"><i class="bi bi-hourglass-split"></i> Generating prompt...</div>';
        }
    }

    // Clear previous response
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
    if (resultsContent) {
        resultsContent.innerHTML = '';
    }

    fetch(`/scenario_pipeline/case/${currentCaseId}/${endpoint}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display status messages + prompt
            if (promptText) {
                let promptHtml = '';

                // Show status messages if available
                if (data.status_messages && data.status_messages.length > 0) {
                    promptHtml += '<div class="alert alert-info mb-3 py-2"><strong>Extraction Results:</strong><ul class="mb-0 mt-1 small">';
                    data.status_messages.forEach(msg => {
                        promptHtml += `<li>${escapeHtml(msg)}</li>`;
                    });
                    promptHtml += '</ul></div>';
                }

                // Show the prompt
                if (data.prompt) {
                    promptHtml += `<div class="prompt-text-content">${escapeHtml(data.prompt)}</div>`;
                }

                promptText.innerHTML = promptHtml;
            }

            // Display response
            if (resultsSection && resultsContent) {
                resultsSection.style.display = 'block';

                if (data.raw_llm_response) {
                    resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.raw_llm_response)}</pre>`;
                }

                // Handle task-specific results
                handleTaskResults(taskType, data);
            }

            // Update counts if available
            updateCountBadges(taskType, data.result);

            // Re-enable button with Re-run label
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                button.classList.remove('btn-outline-' + getButtonColor(taskType));
                button.classList.add('btn-outline-secondary');
            }
        } else {
            throw new Error(data.error || 'Extraction failed');
        }
    })
    .catch(error => {
        console.error('Extraction error:', error);
        if (promptText) {
            promptText.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Retry';
        }
    });
}

function handleTaskResults(taskType, data) {
    switch(taskType) {
        case 'rich_analysis':
            handleRichAnalysisResults(data);
            break;
        case 'decision_synthesis':
            handleDecisionSynthesisResults(data);
            break;
        case 'narrative':
            handleNarrativeResults(data);
            break;
    }
}

function handleRichAnalysisResults(data) {
    if (data.result) {
        document.getElementById('causalLinksCount').textContent = data.result.causal_normative_links || 0;
        document.getElementById('questionEmergenceCount').textContent = data.result.question_emergence || 0;
        document.getElementById('resolutionPatternsCount').textContent = data.result.resolution_patterns || 0;
    }

    // Display LLM traces (now handled by streaming, but keep for non-streaming fallback)
    if (data.llm_traces && data.llm_traces.length > 0) {
        const promptSection = document.getElementById('rich_analysisPromptSection');
        const promptText = document.getElementById('rich_analysisPromptText');
        const resultsSection = document.getElementById('rich_analysisResults');
        const resultsContent = document.getElementById('rich_analysisResultsContent');

        if (promptSection) promptSection.style.display = 'block';
        if (resultsSection) resultsSection.style.display = 'block';

        // Combine prompts and responses
        if (promptText) {
            promptText.innerHTML = data.llm_traces.map((trace, i) =>
                `<h6 class="mt-2">${trace.stage}</h6><pre style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">${escapeHtml(trace.prompt)}</pre>`
            ).join('');
        }

        if (resultsContent) {
            resultsContent.innerHTML = data.llm_traces.map((trace, i) =>
                `<h6 class="mt-2">${trace.stage}</h6><pre style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">${escapeHtml(trace.response)}</pre>`
            ).join('');
        }
    }
}

function handleDecisionSynthesisResults(data) {
    if (data.result) {
        document.getElementById('e1Result').textContent = data.result.e1_decision_relevant + ' decision-relevant';
        document.getElementById('e2Result').textContent = data.result.e2_action_sets + ' action sets';
        document.getElementById('e3Result').textContent = data.result.e3_candidates + ' candidates';
        document.getElementById('llmResult').textContent = data.result.canonical_count + ' canonical';

        // Update step badges to success
        ['step-e1', 'step-e2', 'step-e3', 'step-llm'].forEach(id => {
            document.getElementById(id).classList.remove('bg-secondary');
            document.getElementById(id).classList.add('bg-success');
        });
    }

    if (data.llm_trace) {
        document.getElementById('decisionSynthesisPromptSection').style.display = 'block';
        document.getElementById('decisionSynthesisPromptText').textContent = data.llm_trace.prompt;
        document.getElementById('decisionSynthesisResultsContent').innerHTML =
            `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.llm_trace.response)}</pre>`;
    }
}

function handleNarrativeResults(data) {
    if (data.narrative) {
        if (data.narrative.case_summary) {
            document.getElementById('case-summary-area').style.display = 'block';
            document.getElementById('case-summary-text').textContent = data.narrative.case_summary;
        }

        if (data.narrative.timeline && data.narrative.timeline.length > 0) {
            document.getElementById('timeline-preview').style.display = 'block';
            document.getElementById('timeline-events').innerHTML = data.narrative.timeline.map(e =>
                `<div class="d-flex mb-2">
                    <span class="badge bg-secondary me-2">${e.sequence}</span>
                    <span><strong>${e.phase_label}:</strong> ${e.description}</span>
                </div>`
            ).join('');
        }
    }

    if (data.llm_trace) {
        document.getElementById('narrativePromptSection').style.display = 'block';
        document.getElementById('narrativePromptText').textContent = data.llm_trace.prompt;
        document.getElementById('narrativeResultsContent').innerHTML =
            `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.llm_trace.response)}</pre>`;
    }
}

function updateCountBadges(taskType, result) {
    if (!result) return;

    switch(taskType) {
        case 'provisions':
            document.getElementById('provisionsCount').textContent = result.count || 0;
            break;
        case 'questions':
            document.getElementById('questionsCount').textContent = result.count || 0;
            break;
        case 'conclusions':
            document.getElementById('conclusionsCount').textContent = result.count || 0;
            break;
        case 'transformation':
            document.getElementById('transformationType').textContent = result.type || 'classified';
            break;
    }
}

function getButtonColor(taskType) {
    const colors = {
        'provisions': 'secondary',
        'questions': 'warning',
        'conclusions': 'success',
        'transformation': 'secondary',
        'rich_analysis': 'info',
        'decision_synthesis': 'primary',
        'narrative': 'dark'
    };
    return colors[taskType] || 'secondary';
}

function capitalizeFirst(str) {
    // Handle underscored names like rich_analysis -> RichAnalysis
    return str.split('_').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Streaming extraction for provisions (real-time progress)
function extractTaskStreaming(taskType, button, promptSection, resultsSection, promptText, resultsContent) {
    // Reset streaming messages for this task
    streamingMessages[taskType] = [];

    // Disable button and show loading
    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    }

    // Show prompt section with initial message
    if (promptSection) {
        promptSection.style.display = 'block';
        if (promptText) {
            promptText.innerHTML = '<div class="alert alert-info py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Starting extraction...</strong></div>';
        }
    }

    // Clear previous response
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
    if (resultsContent) {
        resultsContent.innerHTML = '';
    }

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/extract_${taskType}_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    // Re-enable button
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                        button.classList.add('btn-outline-secondary');
                    }
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handleStreamingExtraction(taskType, data, promptText, resultsSection, resultsContent);
                        } catch (e) {
                            console.log('Parse error:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        if (promptText) {
            promptText.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Retry';
        }
    });
}

// Handle streaming extraction data
function handleStreamingExtraction(taskType, data, promptText, resultsSection, resultsContent) {
    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!streamingMessages[taskType].includes(msg)) {
                streamingMessages[taskType].push(msg);
            }
        });
    }

    // Build the display
    if (promptText) {
        let html = '<div class="alert alert-info mb-2 py-2">';
        html += '<strong><i class="bi bi-gear-fill me-1"></i> Processing:</strong>';
        html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

        streamingMessages[taskType].forEach((msg, idx) => {
            const isLatest = idx === streamingMessages[taskType].length - 1;
            html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
                <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-primary' : 'check-circle text-success'} me-1"></i>
                ${escapeHtml(msg)}
            </div>`;
        });

        html += '</div>';

        // Show progress bar
        if (data.progress) {
            html += `<div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
            </div>`;
        }

        html += '</div>';
        promptText.innerHTML = html;

        // Auto-scroll
        const messagesDiv = promptText.querySelector('.streaming-messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

    // Update count badge on completion
    if (data.stage === 'COMPLETE' && data.result) {
        // Handle task-specific count updates
        if (taskType === 'rich_analysis') {
            // Rich analysis has 3 separate counts
            const causalEl = document.getElementById('causalLinksCount');
            const emergenceEl = document.getElementById('questionEmergenceCount');
            const resolutionEl = document.getElementById('resolutionPatternsCount');
            if (causalEl) causalEl.textContent = data.result.causal_normative_links || 0;
            if (emergenceEl) emergenceEl.textContent = data.result.question_emergence || 0;
            if (resolutionEl) resolutionEl.textContent = data.result.resolution_patterns || 0;
        } else {
            const countEl = document.getElementById(`${taskType}Count`);
            if (countEl) {
                countEl.textContent = data.result.count || 0;
            }
        }

        // Show final status messages + prompt
        if (promptText) {
            let html = '<div class="alert alert-success mb-2 py-2">';
            html += '<strong><i class="bi bi-check-circle-fill me-1"></i> Extraction Complete:</strong>';
            if (data.status_messages && data.status_messages.length > 0) {
                html += '<ul class="mb-0 mt-1 small">';
                data.status_messages.forEach(msg => {
                    html += `<li>${escapeHtml(msg)}</li>`;
                });
                html += '</ul>';
            }
            html += '</div>';

            // Show the prompt if available
            if (data.prompt) {
                html += `<div class="prompt-text-content">${escapeHtml(data.prompt)}</div>`;
            }

            promptText.innerHTML = html;
        }

        // Show the LLM response if available
        if (data.raw_llm_response && resultsSection && resultsContent) {
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.raw_llm_response)}</pre>`;
        }
    }

    // Handle errors
    if (data.error) {
        if (promptText) {
            promptText.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-1"></i> ${data.messages ? data.messages[0] : 'Error occurred'}</div>`;
        }
    }
}

// Run complete synthesis with SSE streaming for real-time progress
async function runCompleteSynthesis() {
    const button = document.getElementById('run-complete-synthesis-btn');
    const progressText = document.getElementById('synthesis-progress-text');

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    progressText.textContent = 'Starting synthesis...';

    // Reset streaming message trackers
    Object.keys(streamingMessages).forEach(key => {
        streamingMessages[key] = [];
    });

    // Show prompt sections for streaming updates
    document.getElementById('provisionsPromptSection').style.display = 'block';
    document.getElementById('provisionsPromptText').innerHTML = '<div class="alert alert-info py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Waiting to start...</strong></div>';

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/synthesize_complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    // Streaming complete
                    progressText.textContent = 'Complete! Review your results below.';
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-check-circle"></i> Synthesis Complete';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-success');
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handleStreamingData(data);
                        } catch (e) {
                            console.log('Parse error for line:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        progressText.textContent = `Error: ${error.message}`;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-circle"></i> Run Complete Synthesis';
    });
}

// Handle streaming data updates
function handleStreamingData(data) {
    const progressText = document.getElementById('synthesis-progress-text');

    // Update progress text
    if (data.messages && data.messages.length > 0) {
        progressText.textContent = data.messages[data.messages.length - 1];
    }

    // Update phase indicator based on stage
    if (data.stage) {
        if (data.stage.startsWith('PART_A')) {
            updatePhaseIndicator('provisions');
            updatePromptSection('provisions', data);
        } else if (data.stage.startsWith('PART_B')) {
            updatePhaseIndicator('questions');
            updatePromptSection('questions', data);
        } else if (data.stage.startsWith('PART_C') || data.stage.includes('TRANSFORMATION')) {
            updatePhaseIndicator('transformation');
            updatePromptSection('transformation', data);
        } else if (data.stage.includes('RICH') || data.stage.includes('ANALYSIS')) {
            updatePhaseIndicator('rich_analysis');
        } else if (data.stage.includes('DECISION')) {
            updatePhaseIndicator('decision_synthesis');
        } else if (data.stage.includes('NARRATIVE')) {
            updatePhaseIndicator('narrative');
        }
    }

    // Update counts when complete
    if (data.stage === 'PART_A_COMPLETE' && data.result) {
        document.getElementById('provisionsCount').textContent = data.result.provision_count || 0;
        markTaskComplete('provisions');
    } else if (data.stage === 'PART_B_COMPLETE' && data.result) {
        document.getElementById('questionsCount').textContent = data.result.question_count || 0;
        document.getElementById('conclusionsCount').textContent = data.result.conclusion_count || 0;
        markTaskComplete('questions');
        markTaskComplete('conclusions');
    } else if (data.stage === 'PART_C_COMPLETE' || data.stage === 'TRANSFORMATION_COMPLETE') {
        if (data.result && data.result.transformation_type) {
            document.getElementById('transformationType').textContent = data.result.transformation_type;
        }
        markTaskComplete('transformation');
    } else if (data.stage === 'COMPLETE') {
        // Final completion
        markTaskComplete('rich_analysis');
        markTaskComplete('decision_synthesis');
        markTaskComplete('narrative');
    }

    // Show LLM traces
    if (data.llm_trace) {
        showLLMTrace(data.stage, data.llm_trace);
    }
}

// Track streaming messages per task
const streamingMessages = {
    provisions: [],
    questions: [],
    conclusions: [],
    transformation: [],
    rich_analysis: [],
    decision_synthesis: [],
    narrative: []
};

// Update prompt section with streaming messages (accumulates)
function updatePromptSection(taskType, data) {
    const promptSection = document.getElementById(`${taskType}PromptSection`);
    const promptText = document.getElementById(`${taskType}PromptText`);

    if (promptSection && promptText) {
        promptSection.style.display = 'block';

        // Accumulate messages
        if (data.messages) {
            data.messages.forEach(msg => {
                if (!streamingMessages[taskType].includes(msg)) {
                    streamingMessages[taskType].push(msg);
                }
            });
        }

        // Build the display with all accumulated messages
        let html = '<div class="alert alert-info mb-2 py-2">';
        html += '<strong><i class="bi bi-gear-fill me-1"></i> Processing:</strong>';
        html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

        streamingMessages[taskType].forEach((msg, idx) => {
            const isLatest = idx === streamingMessages[taskType].length - 1;
            html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
                <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-primary' : 'check-circle text-success'} me-1"></i>
                ${escapeHtml(msg)}
            </div>`;
        });

        html += '</div>';

        // Show progress bar if available
        if (data.progress) {
            html += `<div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
            </div>`;
        }

        html += '</div>';

        promptText.innerHTML = html;

        // Auto-scroll to show latest message
        const messagesDiv = promptText.querySelector('.streaming-messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
}

// Show LLM trace in prompt/response sections
function showLLMTrace(stage, trace) {
    // Determine which section to update based on stage
    let taskType = 'provisions';
    if (stage.includes('QUESTION')) taskType = 'questions';
    else if (stage.includes('CONCLUSION')) taskType = 'conclusions';
    else if (stage.includes('TRANSFORMATION')) taskType = 'transformation';

    const promptSection = document.getElementById(`${taskType}PromptSection`);
    const promptText = document.getElementById(`${taskType}PromptText`);
    const resultsSection = document.getElementById(`${taskType}Results`);
    const resultsContent = document.getElementById(`${taskType}ResultsContent`);

    if (promptSection && promptText && trace.prompt) {
        promptSection.style.display = 'block';
        // Add the actual prompt
        const promptHtml = `<div class="alert alert-success mb-2 py-1 small">LLM call: ${stage}</div>
            <div class="prompt-text-content">${escapeHtml(trace.prompt)}</div>`;
        promptText.innerHTML = promptHtml;
    }

    if (resultsSection && resultsContent && trace.response) {
        resultsSection.style.display = 'block';
        resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 300px; overflow-y: auto;">${escapeHtml(trace.response)}</pre>`;
    }
}

// Mark a task button as complete (shows Re-run)
function markTaskComplete(taskType) {
    const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
    if (button) {
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
        button.classList.add('btn-outline-secondary');
        button.classList.remove('btn-outline-warning', 'btn-outline-success', 'btn-outline-info', 'btn-outline-primary', 'btn-outline-dark');
    }
}

async function runSingleTask(taskType) {
    return new Promise((resolve, reject) => {
        const endpoints = {
            'provisions': 'extract_provisions',
            'questions': 'extract_questions',
            'conclusions': 'extract_conclusions',
            'transformation': 'extract_transformation',
            'rich_analysis': 'extract_rich_analysis',
            'decision_synthesis': 'extract_decision_synthesis',
            'narrative': 'extract_narrative'
        };

        fetch(`/scenario_pipeline/case/${currentCaseId}/${endpoints[taskType]}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI with results
                handleTaskResults(taskType, data);
                updateCountBadges(taskType, data.result);

                // Mark button as done
                const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
                if (button) {
                    button.innerHTML = '<i class="bi bi-check-circle"></i> Done';
                    button.classList.add('btn-success');
                }

                resolve(data);
            } else {
                reject(new Error(data.error || 'Task failed'));
            }
        })
        .catch(reject);
    });
}

function updatePhaseIndicator(currentTask) {
    const phaseMap = {
        'provisions': 'phase2',
        'questions': 'phase2',
        'conclusions': 'phase2',
        'transformation': 'phase2',
        'rich_analysis': 'phase2',
        'decision_synthesis': 'phase3',
        'narrative': 'phase4'
    };

    const phase = phaseMap[currentTask];

    // Remove active from all except phase 1 (always complete)
    ['phase2', 'phase3', 'phase4'].forEach(p => {
        const indicator = document.getElementById(`${p}-indicator`);
        if (indicator) {
            indicator.classList.remove('phase-active');
        }
    });

    // Set current phase as active
    const currentIndicator = document.getElementById(`${phase}-indicator`);
    if (currentIndicator) {
        currentIndicator.classList.add('phase-active');
    }
}

// Load saved prompts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedPrompts();
});

function loadSavedPrompts() {
    const tasks = ['provisions', 'questions', 'conclusions', 'transformation'];

    tasks.forEach(task => {
        fetch(`/scenario_pipeline/case/${currentCaseId}/get_saved_step4_prompt?task_type=${task}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.prompt_text) {
                    const promptSection = document.getElementById(`${task}PromptSection`);
                    const promptText = document.getElementById(`${task}PromptText`);
                    const resultsSection = document.getElementById(`${task}Results`);
                    const resultsContent = document.getElementById(`${task}ResultsContent`);

                    if (promptSection && promptText) {
                        promptSection.style.display = 'block';
                        promptText.textContent = data.prompt_text;
                    }

                    if (resultsSection && resultsContent && data.raw_response) {
                        resultsSection.style.display = 'block';
                        resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.raw_response)}</pre>`;
                    }

                    // Mark button as done
                    const button = document.getElementById(`extract${capitalizeFirst(task)}Btn`);
                    if (button && data.prompt_text) {
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                    }
                }
            })
            .catch(error => console.log(`No saved prompt for ${task}`));
    });
}
</script>
{% endblock %}
