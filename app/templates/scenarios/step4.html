{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 4: Case Synthesis{% endblock %}
{% block step_header %}Step 4: Case Synthesis{% endblock %}
{% block step_subtitle %}Build a coherent case model from extracted entities{% endblock %}

{% block step_content %}

<!-- Synthesis Pipeline Overview -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3-fill"></i> Four-Phase Synthesis Pipeline
        </h5>
    </div>
    <div class="card-body">
        {% set p2_done = pipeline_status.step4.phase2_complete if pipeline_status and pipeline_status.step4 else false %}
        {% set p3_done = pipeline_status.step4.phase3_complete if pipeline_status and pipeline_status.step4 else false %}
        {% set p4_done = pipeline_status.step4.phase4_complete if pipeline_status and pipeline_status.step4 else false %}
        <div class="phase-row text-center">
            <div class="phase-col">
                <div id="phase1-indicator" class="phase-indicator phase-complete">
                    <span class="phase-number">1</span>
                    <div class="phase-label">Entity Foundation</div>
                    <small class="text-muted">Passes 1-3</small>
                </div>
            </div>
            <div class="phase-col">
                <div id="phase2-indicator" class="phase-indicator{% if p2_done %} phase-complete{% endif %}">
                    <span class="phase-number">2</span>
                    <div class="phase-label">Analytical Extraction</div>
                    <small class="text-muted">2A-2E</small>
                    <div class="phase2-progress mt-1">
                        <div class="d-flex justify-content-center gap-1">
                            <span id="p2-provisions" class="substep-dot" title="2A: Provisions"></span>
                            <span id="p2-precedents" class="substep-dot" title="2B: Precedents"></span>
                            <span id="p2-questions" class="substep-dot" title="2C: Questions"></span>
                            <span id="p2-conclusions" class="substep-dot" title="2C: Conclusions"></span>
                            <span id="p2-transformation" class="substep-dot" title="2D: Transformation"></span>
                            <span id="p2-rich" class="substep-dot" title="2E: Rich Analysis"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="phase-col">
                <div id="phase3-indicator" class="phase-indicator{% if p3_done %} phase-complete{% endif %}">
                    <span class="phase-number">3</span>
                    <div class="phase-label">Decision Synthesis</div>
                    <small class="text-muted">E1-E3 + LLM</small>
                </div>
            </div>
            <div class="phase-col">
                <div id="phase4-indicator" class="phase-indicator{% if p4_done %} phase-complete{% endif %}">
                    <span class="phase-number">4</span>
                    <div class="phase-label">Narrative</div>
                    <small class="text-muted">Timeline + Scenario</small>
                </div>
            </div>
        </div>

        <hr>

        <div class="text-center">
            {% if current_user.is_authenticated %}
            {% set step4_complete = pipeline_status.step4.complete if pipeline_status else false %}
            <button type="button" id="run-complete-synthesis-btn" class="btn {% if step4_complete %}btn-success{% else %}btn-primary{% endif %} btn-lg" onclick="runCompleteSynthesis()">
                <i class="bi bi-{% if step4_complete %}arrow-clockwise{% else %}play-circle{% endif %}"></i> {% if step4_complete %}Re-run Synthesis{% else %}Run Complete Synthesis{% endif %}
            </button>
            {% if step4_complete %}
            <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-outline-secondary btn-lg ms-2">
                <i class="bi bi-eye"></i> Review Results
            </a>
            {% endif %}
            <button type="button" id="clear-step4-btn" class="btn btn-outline-danger btn-lg ms-2 {% if not step4_complete %}d-none{% endif %}" onclick="clearStep4Data()">
                <i class="bi bi-trash"></i> Clear Step 4
            </button>
            {% else %}
            <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='{{ url_for('auth.login') }}';">
                <i class="bi bi-lock-fill"></i> Login to Run Synthesis
            </button>
            {% endif %}
            <div id="synthesis-progress-text" class="mt-2 text-muted"></div>
        </div>
    </div>
</div>

<!-- Phase 1: Entity Foundation (Display only - no extraction) -->
<div class="card mb-4" id="phase1-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <span class="badge bg-success me-2">Phase 1</span> Entity Foundation
        </h5>
        <span id="phase1-status" class="badge bg-success">{{ entities_summary.total }} entities</span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-muted">Pass 1: Contextual Framework</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-primary me-1">{{ entities_summary.roles }}</span> Roles</li>
                    <li><span class="badge bg-info me-1">{{ entities_summary.states }}</span> States</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.resources }}</span> Resources</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Pass 2: Normative Requirements</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-purple me-1">{{ entities_summary.principles }}</span> Principles</li>
                    <li><span class="badge bg-warning text-dark me-1">{{ entities_summary.obligations }}</span> Obligations</li>
                    <li><span class="badge bg-danger me-1">{{ entities_summary.constraints }}</span> Constraints</li>
                    <li><span class="badge bg-success me-1">{{ entities_summary.capabilities }}</span> Capabilities</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Pass 3: Temporal Dynamics</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-dark me-1">{{ entities_summary.actions }}</span> Actions</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.events }}</span> Events</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Phase 2: Analytical Extraction - Individual Tasks -->
<div class="card mb-4" id="phase2-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 2</span> Analytical Extraction
        </h5>
    </div>
    <div class="card-body">
        <!-- 2A: Code Provisions -->
        <div class="extractor-section mb-4" id="provisionsSection">
            <div class="step-card border-secondary">
                <div class="step-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-file-text text-secondary"></i> 2A: Code Provisions
                            <span id="provisionsCount" class="badge bg-secondary ms-2">{{ synthesis_status.provisions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="extractTask('provisions')" id="extractProvisionsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div id="provisionsStreamStatus" style="display: none;"></div>
                    <div id="provisionsEntityList">
                    {% set prov_entities = phase2_entities.get('code_provision_reference', []) %}
                    {% if prov_entities %}
                        {% for e in prov_entities %}
                        <div class="entity-summary-item">
                            <strong>{{ e.label }}</strong>
                            {% if e.definition %}
                            <small class="text-muted d-block">{{ e.definition[:150] }}{% if e.definition|length > 150 %}...{% endif %}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-muted small">No provisions extracted yet.</div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 2B: Precedent Case References -->
        <div class="extractor-section mb-4" id="precedentsSection">
            <div class="step-card border-dark">
                <div class="step-header bg-dark bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-journal-bookmark text-dark"></i> 2B: Precedent Cases
                            <span id="precedentsCount" class="badge bg-dark ms-2">{{ synthesis_status.precedents_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-dark btn-sm" onclick="extractTask('precedents')" id="extractPrecedentsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div id="precedentsStreamStatus" style="display: none;"></div>
                    <div id="precedentsEntityList">
                    {% set prec_entities = phase2_entities.get('precedent_case_reference', []) %}
                    {% if prec_entities %}
                        {% for e in prec_entities %}
                        <div class="entity-summary-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    {% if e.rdf.get('resolved') and e.rdf.get('internalCaseId') %}
                                    <a href="{{ url_for('cases.view_case', id=e.rdf.internalCaseId) }}" class="fw-semibold text-decoration-none">
                                        <i class="bi bi-journal-bookmark me-1"></i>{{ e.label }}
                                    </a>
                                    {% else %}
                                    <strong><i class="bi bi-journal-bookmark me-1"></i>{{ e.label }}</strong>
                                    {% endif %}
                                    {% if e.rdf.get('citationType') %}
                                    <span class="badge bg-{{ 'success' if e.rdf.citationType == 'supporting' else 'warning' if e.rdf.citationType == 'distinguishing' else 'info' }} ms-1">{{ e.rdf.citationType }}</span>
                                    {% endif %}
                                </div>
                                {% if e.rdf.get('resolved') %}
                                <span class="badge bg-secondary"><i class="bi bi-link-45deg"></i> linked</span>
                                {% endif %}
                            </div>
                            {% if e.rdf.get('principleEstablished') %}
                            <small class="text-muted d-block mt-1">{{ e.rdf.principleEstablished }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="text-muted small">No precedent cases extracted yet.</div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 2C: Questions & Conclusions -->
        <div class="extractor-section mb-4" id="questionsSection">
            <div class="step-card border-warning">
                <div class="step-header bg-warning bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle text-warning"></i> 2C: Questions & Conclusions
                            <span id="questionsCount" class="badge bg-warning text-dark ms-2">{{ synthesis_status.questions_count or 0 }}</span>
                            <span id="conclusionsCount" class="badge bg-success ms-1">{{ synthesis_status.conclusions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-warning btn-sm" onclick="extractTask('qc_unified')" id="extractQuestionsBtn">
                            <i class="bi bi-play-fill"></i> Extract Q&C
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div id="questionsStreamStatus" style="display: none;"></div>
                    <div id="questionsEntityList">
                    {% set q_entities = phase2_entities.get('ethical_question', []) %}
                    {% set c_entities = phase2_entities.get('ethical_conclusion', []) %}
                    {% if q_entities or c_entities %}
                        {% if q_entities %}
                        <div class="mb-2"><small class="text-muted fw-semibold">Questions ({{ q_entities|length }})</small></div>
                        {% for e in q_entities %}
                        <div class="entity-summary-item">
                            <strong>{{ e.label }}</strong>
                            {% if e.definition %}
                            <small class="text-muted d-block">{{ e.definition[:150] }}{% if e.definition|length > 150 %}...{% endif %}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}
                        {% if c_entities %}
                        <div class="mb-2 mt-3"><small class="text-muted fw-semibold">Conclusions ({{ c_entities|length }})</small></div>
                        {% for e in c_entities %}
                        <div class="entity-summary-item">
                            <strong>{{ e.label }}</strong>
                            {% if e.definition %}
                            <small class="text-muted d-block">{{ e.definition[:150] }}{% if e.definition|length > 150 %}...{% endif %}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}
                    {% else %}
                    <div class="text-muted small">No questions or conclusions extracted yet.</div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 2D: Transformation Classification -->
        <div class="extractor-section mb-4" id="transformationSection">
            <div class="step-card border-purple">
                <div class="step-header bg-purple-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-shuffle text-purple"></i> 2D: Transformation Classification
                            <a href="{{ url_for('tools.references') }}#transformation" class="ms-1" title="Marchais-Roubelat & Roubelat (2015)" target="_blank"><i class="bi bi-info-circle text-muted"></i></a>
                            <span id="transformationType" class="badge bg-purple ms-2">{{ synthesis_status.transformation_type or 'Not classified' }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="extractTask('transformation')" id="extractTransformationBtn">
                            <i class="bi bi-play-fill"></i> Classify
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div id="transformationStreamStatus" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- 2E: Rich Analysis -->
        <div class="extractor-section mb-4" id="rich_analysisSection">
            <div class="step-card border-info">
                <div class="step-header bg-info bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-diagram-3 text-info"></i> 2E: Rich Analysis
                            <a href="{{ url_for('tools.references') }}#nine-component" class="ms-1" title="Berreby et al. (2017), McLaren (2003), Harris et al. (2018)" target="_blank"><i class="bi bi-info-circle text-muted"></i></a>
                            <small class="text-muted">(Causal Links, Question Emergence, Resolution Patterns)</small>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-info btn-sm" onclick="extractTask('rich_analysis')" id="extractRich_analysisBtn">
                            <i class="bi bi-play-fill"></i> Analyze
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div id="rich_analysisStreamStatus" style="display: none;"></div>
                    <div id="rich_analysisEntityList">
                    {% set cl_entities = phase2_entities.get('causal_normative_link', []) %}
                    {% set qe_entities = phase2_entities.get('question_emergence', []) %}
                    {% set rp_entities = phase2_entities.get('resolution_pattern', []) %}
                    {% if cl_entities or qe_entities or rp_entities %}
                        {% if cl_entities %}
                        <div class="mb-2"><small class="text-muted fw-semibold">Causal-Normative Links ({{ cl_entities|length }})</small></div>
                        {% for e in cl_entities %}
                        <div class="entity-summary-item">
                            <strong>{{ e.label }}</strong>
                            {% if e.definition %}
                            <small class="text-muted d-block">{{ e.definition[:150] }}{% if e.definition|length > 150 %}...{% endif %}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}
                        {% if qe_entities %}
                        <div class="mb-2 mt-3"><small class="text-muted fw-semibold">Question Emergence ({{ qe_entities|length }})</small></div>
                        {% for e in qe_entities %}
                        <div class="entity-summary-item">
                            <strong>{{ e.label }}</strong>
                            {% if e.definition %}
                            <small class="text-muted d-block">{{ e.definition[:150] }}{% if e.definition|length > 150 %}...{% endif %}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}
                        {% if rp_entities %}
                        <div class="mb-2 mt-3"><small class="text-muted fw-semibold">Resolution Patterns ({{ rp_entities|length }})</small></div>
                        {% for e in rp_entities %}
                        <div class="entity-summary-item">
                            <strong>{{ e.label }}</strong>
                            {% if e.definition %}
                            <small class="text-muted d-block">{{ e.definition[:150] }}{% if e.definition|length > 150 %}...{% endif %}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% endif %}
                    {% else %}
                    <div class="text-muted small">No analysis entities extracted yet.</div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 3: Decision Point Synthesis -->
<div class="card mb-4" id="phase3-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 3</span> Decision Point Synthesis
            <a href="{{ url_for('tools.references') }}#argument-mining" class="text-muted ms-2" title="Toulmin (1958), Jones (1991), Harris et al. (2018)" target="_blank">
                <i class="bi bi-info-circle"></i>
            </a>
        </h5>
    </div>
    <div class="card-body">
        <div class="extractor-section" id="decisionSynthesisSection">
            <div class="step-card border-primary">
                <div class="step-header bg-primary bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-bullseye text-primary"></i> Decision Point Synthesis (E1-E3 + Q&C Alignment + LLM)
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="runPhase3Synthesis()" id="extractDecisionSynthesisBtn" disabled title="Complete Phase 2 first">
                            <i class="bi bi-lock-fill"></i> Synthesize
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <p class="text-muted small mb-3">
                        Composes decision points algorithmically (E1-E3), scores against Q&C using Toulmin analysis, then refines via LLM.
                    </p>

                    <!-- Synthesis Pipeline Stages -->
                    <div class="row text-center small mb-3" id="algorithmicSteps">
                        <div class="col border-end">
                            <span id="step-e1" class="badge bg-secondary mb-1">E1</span><br>
                            <small>Obligation Coverage</small><br>
                            <span id="e1Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-e2" class="badge bg-secondary mb-1">E2</span><br>
                            <small>Action Mapping</small><br>
                            <span id="e2Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-e3" class="badge bg-secondary mb-1">E3</span><br>
                            <small>Composition</small><br>
                            <span id="e3Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-align" class="badge bg-secondary mb-1">Q&C</span><br>
                            <small>Alignment</small><br>
                            <span id="alignResult" class="text-muted">-</span>
                        </div>
                        <div class="col">
                            <span id="step-llm" class="badge bg-secondary mb-1">LLM</span><br>
                            <small>Refinement</small><br>
                            <span id="llmResult" class="text-muted">-</span>
                        </div>
                    </div>

                    <!-- Streaming Progress (blue box like other phases) -->
                    <div class="prompt-preview mb-3" id="decisionSynthesisPromptSection" style="display: none;">
                        <div class="prompt-text" id="decisionSynthesisPromptText"></div>
                    </div>

                    <!-- Decision Points Results -->
                    <div id="decisionPointsResults" style="display: none;">
                        <h6 class="mt-3"><i class="bi bi-diagram-3 text-success"></i> Decision Points</h6>
                        <div id="decisionPointsList" class="mb-3"></div>
                    </div>

                    <!-- LLM Prompt (collapsible) -->
                    <div class="accordion mb-3" id="phase3LLMAccordion" style="display: none;">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#phase3PromptCollapse">
                                    <i class="bi bi-chat-left-text me-2"></i> Refinement Prompt
                                </button>
                            </h2>
                            <div id="phase3PromptCollapse" class="accordion-collapse collapse" data-bs-parent="#phase3LLMAccordion">
                                <div class="accordion-body p-2">
                                    <pre id="phase3PromptContent" class="small mb-0" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem;"></pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#phase3ResponseCollapse">
                                    <i class="bi bi-chat-left-text text-success me-2"></i> LLM Response
                                </button>
                            </h2>
                            <div id="phase3ResponseCollapse" class="accordion-collapse collapse" data-bs-parent="#phase3LLMAccordion">
                                <div class="accordion-body p-2">
                                    <pre id="phase3ResponseContent" class="small mb-0" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem;"></pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#phase3TraceCollapse">
                                    <i class="bi bi-diagram-3 text-info me-2"></i> Synthesis Provenance
                                </button>
                            </h2>
                            <div id="phase3TraceCollapse" class="accordion-collapse collapse" data-bs-parent="#phase3LLMAccordion">
                                <div class="accordion-body p-2">
                                    <div id="phase3SynthesisTrace">
                                        <p class="text-muted small mb-0">No provenance trace available</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 4: Narrative Construction -->
<div class="card mb-4" id="phase4-card">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 4</span> Narrative Construction
        </h5>
    </div>
    <div class="card-body">
        <div class="extractor-section" id="narrativeSection">
            <div class="step-card border-dark">
                <div class="step-header bg-dark bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-book text-dark"></i> Narrative Elements (Event Calculus + Scenario Seeds)
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="runPhase4Narrative()" id="extractNarrativeBtn" disabled title="Complete Phase 3 first">
                            <i class="bi bi-lock-fill"></i> Construct
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <p class="text-muted small mb-3">
                        Transforms entities into narrative elements using Berreby's Event Calculus framework, then generates scenario seeds for Step 5.
                    </p>

                    <!-- Phase 4 Pipeline Stages -->
                    <div class="row text-center small mb-3" id="phase4Steps">
                        <div class="col border-end">
                            <span id="step-4-1" class="badge bg-secondary mb-1">4.1</span><br>
                            <small>Characters</small><br>
                            <span id="stage41Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-4-2" class="badge bg-secondary mb-1">4.2</span><br>
                            <small>Timeline</small><br>
                            <span id="stage42Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-4-3" class="badge bg-secondary mb-1">4.3</span><br>
                            <small>Conflicts</small><br>
                            <span id="stage43Result" class="text-muted">-</span>
                        </div>
                        <div class="col">
                            <span id="step-4-4" class="badge bg-secondary mb-1">4.4</span><br>
                            <small>Decisions</small><br>
                            <span id="stage44Result" class="text-muted">-</span>
                        </div>
                    </div>

                    <!-- Streaming Progress -->
                    <div class="prompt-preview mb-3" id="narrativePromptSection" style="display: none;">
                        <div class="prompt-text" id="narrativePromptText"></div>
                    </div>

                    <!-- Phase 4 Results (Summary) -->
                    <div id="phase4Results" style="display: none;">
                        <div class="alert alert-success mb-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-check-circle-fill me-2"></i>
                                    <strong>Narrative Construction Complete</strong>
                                    <div class="small mt-1">
                                        <span id="phase4Characters">-</span> characters,
                                        <span id="phase4Events">-</span> events,
                                        <span id="phase4Conflicts">-</span> conflicts,
                                        <span id="phase4Fluents">-</span> fluents
                                    </div>
                                </div>
                                <a href="{{ url_for('step4.step4_review', case_id=case.id) }}#narrative" class="btn btn-success btn-sm">
                                    <i class="bi bi-eye"></i> View Narrative
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LLM Interactions Section (separate from Narrative Elements card) -->
        <div id="phase4LLMSection" style="display: none;" class="mt-3">
            <div class="step-card border-secondary">
                <div class="step-header bg-secondary bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-robot text-secondary"></i> LLM Interactions
                            <span id="phase4LLMCount" class="badge bg-secondary ms-2">0</span>
                        </h6>
                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#phase4LLMContent">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                    </div>
                </div>
                <div class="collapse show" id="phase4LLMContent">
                    <div class="step-content">
                        <div id="phase4LLMTraces">
                            <!-- LLM traces will be populated here -->
                            <p class="text-muted small">LLM interactions will appear here as Phase 4 progresses...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
{% set step4_complete = pipeline_status.step4.complete if pipeline_status else false %}
<div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
    <a href="{{ url_for('step4.step4_entities', case_id=case.id) }}" class="btn btn-primary btn-lg">
        <i class="bi bi-list-check"></i> Review Entities & Commit
    </a>
    {% if step4_complete %}
    <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-outline-secondary btn-lg">
        <i class="bi bi-eye"></i> View Synthesis
    </a>
    {% endif %}
</div>

{% endblock %}

{% block step_styles %}
<style>
    .phase-row {
        display: flex;
        gap: 0.75rem;
    }

    .phase-col {
        flex: 1 1 0;
        min-width: 0;
    }

    .phase-indicator {
        padding: 1rem 0.75rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .phase-indicator.phase-complete {
        background-color: #d4edda;
        border-color: #28a745;
    }

    .phase-indicator.phase-active {
        background-color: #cce5ff;
        border-color: #007bff;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    .phase-number {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        line-height: 2rem;
        text-align: center;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .phase-complete .phase-number {
        background-color: #28a745;
    }

    .phase-active .phase-number {
        background-color: #007bff;
    }

    /* Phase 2 substep progress dots */
    .substep-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: #dee2e6;
        transition: all 0.3s ease;
    }

    .substep-dot.complete {
        background-color: #28a745;
    }

    .substep-dot.active {
        background-color: #007bff;
        animation: dotPulse 1s infinite;
    }

    @keyframes dotPulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.3); }
    }

    .extractor-section .step-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .extractor-section .step-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .extractor-section .step-content {
        padding: 1rem;
    }

    .prompt-preview {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .prompt-text {
        font-size: 0.9rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .prompt-text-content {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: white;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
        max-height: 400px;
        overflow-y: auto;
    }

    .results-preview {
        background-color: #f0fff4;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #d4edda;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .text-purple {
        color: #6f42c1 !important;
    }

    .border-purple {
        border-color: #6f42c1 !important;
    }

    .bg-purple-light {
        background-color: #e9ddff !important;
    }

    .commit-status {
        padding: 1rem;
        border-radius: 0.375rem;
    }
    .commit-status.success {
        background: #f0fdf4;
        border: 1px solid #86efac;
    }
    .commit-status.error {
        background: #fef2f2;
        border: 1px solid #fca5a5;
    }
    .entity-summary-item {
        padding: 0.4rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .entity-summary-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
const currentCaseId = {{ case.id }};
let isProcessing = false;

// Warn user if they try to navigate away during processing
window.addEventListener('beforeunload', function(e) {
    if (isProcessing) {
        e.preventDefault();
        e.returnValue = 'Processing is in progress. If you leave, the extraction may be incomplete and you may need to clear and re-run Step 4.';
        return e.returnValue;
    }
});

function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// Clear Step 4 data (Phase 2-4 extractions)
function clearStep4Data() {
    if (!confirm('Clear all Step 4 extractions (provisions, questions, conclusions, decision points)? Phase 1 entities will be preserved.')) {
        return;
    }

    const button = document.getElementById('clear-step4-btn');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Clearing...';

    fetch(`/scenario_pipeline/case/${currentCaseId}/clear_step4`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset all UI elements
            resetStep4UI();
            document.getElementById('synthesis-progress-text').textContent = data.message || 'Step 4 cleared successfully';
        } else {
            alert('Error: ' + (data.error || 'Failed to clear'));
        }
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash"></i> Clear Step 4';
    })
    .catch(error => {
        console.error('Clear error:', error);
        alert('Error clearing Step 4 data');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash"></i> Clear Step 4';
    });
}

// Reset Step 4 UI to initial state
function resetStep4UI() {
    // Reset phase indicators
    ['phase2-indicator', 'phase3-indicator', 'phase4-indicator'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('phase-complete', 'phase-active');
        }
    });

    // Reset counts
    ['provisionsCount', 'precedentsCount', 'questionsCount', 'conclusionsCount'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0';
    });

    // Reset Phase 3 stage badges
    ['step-e1', 'step-e2', 'step-e3', 'step-align', 'step-llm'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['e1Result', 'e2Result', 'e3Result', 'alignResult', 'llmResult'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide prompt/result sections
    document.querySelectorAll('.prompt-preview, .results-preview').forEach(el => {
        el.style.display = 'none';
    });

    // Hide Phase 3 specific elements
    const decisionResults = document.getElementById('decisionPointsResults');
    if (decisionResults) decisionResults.style.display = 'none';
    const phase3Accordion = document.getElementById('phase3LLMAccordion');
    if (phase3Accordion) phase3Accordion.style.display = 'none';

    // Reset Phase 3 streaming messages
    if (typeof phase3StreamingMessages !== 'undefined') {
        phase3StreamingMessages = [];
    }

    // Reset Phase 4 stage badges
    ['step-4-1', 'step-4-2', 'step-4-3', 'step-4-4'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['stage41Result', 'stage42Result', 'stage43Result', 'stage44Result'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide Phase 4 results
    const phase4Results = document.getElementById('phase4Results');
    if (phase4Results) phase4Results.style.display = 'none';

    // Reset Phase 4 streaming messages
    if (typeof phase4StreamingMessages !== 'undefined') {
        phase4StreamingMessages = [];
    }

    // Reset synthesis button
    const synthBtn = document.getElementById('run-complete-synthesis-btn');
    if (synthBtn) {
        synthBtn.classList.remove('btn-success');
        synthBtn.classList.add('btn-primary');
        synthBtn.innerHTML = '<i class="bi bi-play-circle"></i> Run Complete Synthesis';
    }

    // Reset all Phase 2 buttons to their original state
    const phase2Buttons = [
        { id: 'extractProvisionsBtn', color: 'secondary', label: 'Extract' },
        { id: 'extractPrecedentsBtn', color: 'dark', label: 'Extract' },
        { id: 'extractQuestionsBtn', color: 'warning', label: 'Extract' },
        { id: 'extractConclusionsBtn', color: 'success', label: 'Extract' },
        { id: 'extractTransformationBtn', color: 'secondary', label: 'Classify' },
        { id: 'extractRich_analysisBtn', color: 'info', label: 'Analyze' }
    ];
    phase2Buttons.forEach(({ id, color, label }) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = false;
            btn.classList.remove('btn-outline-secondary', 'btn-success', 'btn-outline-success');
            btn.classList.add(`btn-outline-${color}`);
            btn.innerHTML = `<i class="bi bi-play-fill"></i> ${label}`;
        }
    });

    // Reset Phase 3 button to disabled state (requires Phase 2 completion)
    const phase3Btn = document.getElementById('extractDecisionSynthesisBtn');
    if (phase3Btn) {
        phase3Btn.disabled = true;
        phase3Btn.classList.remove('btn-success', 'btn-outline-success', 'btn-outline-primary');
        phase3Btn.classList.add('btn-outline-secondary');
        phase3Btn.innerHTML = '<i class="bi bi-lock-fill"></i> Synthesize';
        phase3Btn.title = 'Complete Phase 2 first';
    }

    // Reset Phase 2 indicator
    const phase2Indicator = document.getElementById('phase2-indicator');
    if (phase2Indicator) {
        phase2Indicator.classList.remove('phase-complete');
    }

    // Reset substep dots
    ['p2-provisions', 'p2-questions', 'p2-conclusions', 'p2-transformation', 'p2-rich'].forEach(id => {
        const dot = document.getElementById(id);
        if (dot) {
            dot.classList.remove('active', 'complete');
        }
    });

    // Reset transformation type badge
    const transformType = document.getElementById('transformationType');
    if (transformType) transformType.textContent = 'Not classified';

    // Reset streaming message trackers
    Object.keys(streamingMessages).forEach(key => {
        streamingMessages[key] = [];
    });
}

// Individual task extraction
function extractTask(taskType) {
    // Map qc_unified to questions DOM elements (since they share the section)
    const domTaskType = taskType === 'qc_unified' ? 'questions' : taskType;

    const button = document.getElementById(`extract${capitalizeFirst(domTaskType)}Btn`);
    const streamStatus = document.getElementById(`${domTaskType}StreamStatus`);

    // Use streaming for Phase 2 tasks (shows real-time progress)
    const useStreaming = ['provisions', 'precedents', 'qc_unified', 'questions', 'conclusions', 'transformation', 'rich_analysis'];
    if (useStreaming.includes(taskType)) {
        extractTaskStreaming(taskType, button, streamStatus);
        return;
    }

    // All Phase 2 tasks use streaming; Phase 3/4 have dedicated handlers
    console.error('extractTask called for non-streaming task:', taskType);
}

function handleTaskResults(taskType, data) {
    switch(taskType) {
        case 'decision_synthesis':
            handleDecisionSynthesisResults(data);
            break;
        case 'narrative':
            handleNarrativeResults(data);
            break;
    }
}

function handleDecisionSynthesisResults(data) {
    if (data.result) {
        document.getElementById('e1Result').textContent = data.result.e1_decision_relevant + ' decision-relevant';
        document.getElementById('e2Result').textContent = data.result.e2_action_sets + ' action sets';
        document.getElementById('e3Result').textContent = data.result.e3_candidates + ' candidates';
        document.getElementById('llmResult').textContent = data.result.canonical_count + ' decision pts';

        // Update step badges to success
        ['step-e1', 'step-e2', 'step-e3', 'step-llm'].forEach(id => {
            document.getElementById(id).classList.remove('bg-secondary');
            document.getElementById(id).classList.add('bg-success');
        });
    }

    if (data.llm_trace) {
        document.getElementById('decisionSynthesisPromptSection').style.display = 'block';
        document.getElementById('decisionSynthesisPromptText').textContent = data.llm_trace.prompt;
        document.getElementById('decisionSynthesisResultsContent').innerHTML =
            `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.llm_trace.response)}</pre>`;
    }
}

function handleNarrativeResults(data) {
    if (data.narrative) {
        if (data.narrative.case_summary) {
            document.getElementById('case-summary-area').style.display = 'block';
            document.getElementById('case-summary-text').textContent = data.narrative.case_summary;
        }

        if (data.narrative.timeline && data.narrative.timeline.length > 0) {
            document.getElementById('timeline-preview').style.display = 'block';
            document.getElementById('timeline-events').innerHTML = data.narrative.timeline.map(e =>
                `<div class="d-flex mb-2">
                    <span class="badge bg-secondary me-2">${e.sequence}</span>
                    <span><strong>${e.phase_label}:</strong> ${e.description}</span>
                </div>`
            ).join('');
        }
    }

    if (data.llm_trace) {
        document.getElementById('narrativePromptSection').style.display = 'block';
        document.getElementById('narrativePromptText').textContent = data.llm_trace.prompt;
        document.getElementById('narrativeResultsContent').innerHTML =
            `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.llm_trace.response)}</pre>`;
    }
}

function updateCountBadges(taskType, result) {
    if (!result) return;

    switch(taskType) {
        case 'provisions':
            document.getElementById('provisionsCount').textContent = result.count || 0;
            break;
        case 'precedents':
            document.getElementById('precedentsCount').textContent = result.count || 0;
            break;
        case 'questions':
            document.getElementById('questionsCount').textContent = result.count || 0;
            break;
        case 'conclusions':
            document.getElementById('conclusionsCount').textContent = result.count || 0;
            break;
        case 'transformation':
            document.getElementById('transformationType').textContent = result.type || 'classified';
            break;
    }
}

function capitalizeFirst(str) {
    // Handle underscored names like rich_analysis -> RichAnalysis
    return str.split('_').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Streaming extraction with real-time progress
function extractTaskStreaming(taskType, button, streamStatus) {
    // Reset streaming messages for this task
    streamingMessages[taskType] = [];

    // Disable button and show loading
    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    }

    // Update substep dot to active
    updateSubstepDot(taskType, 'active');

    // Show streaming status area
    if (streamStatus) {
        streamStatus.style.display = 'block';
        streamStatus.innerHTML = '<div class="alert alert-info py-2 mb-2"><i class="bi bi-hourglass-split me-1"></i> Starting extraction...</div>';
    }

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/extract_${taskType}_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                        button.classList.add('btn-outline-secondary');
                    }
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handleStreamingExtraction(taskType, data, streamStatus);
                        } catch (e) {
                            console.log('Parse error:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        if (streamStatus) {
            streamStatus.innerHTML = `<div class="alert alert-danger py-2 mb-2">Error: ${error.message}</div>`;
        }
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Retry';
        }
    });
}

// Handle streaming extraction events -- progress messages and completion
function handleStreamingExtraction(taskType, data, streamStatus) {
    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!streamingMessages[taskType].includes(msg)) {
                streamingMessages[taskType].push(msg);
            }
        });
    }

    // Show live progress in streamStatus area
    if (streamStatus && data.stage !== 'COMPLETE') {
        let html = '<div class="alert alert-info mb-2 py-2">';
        html += '<strong><i class="bi bi-gear-fill me-1"></i> Processing:</strong>';
        html += '<div class="streaming-messages mt-2" style="max-height: 150px; overflow-y: auto;">';
        streamingMessages[taskType].forEach((msg, idx) => {
            const isLatest = idx === streamingMessages[taskType].length - 1;
            html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
                <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-primary' : 'check-circle text-success'} me-1"></i>
                ${escapeHtml(msg)}
            </div>`;
        });
        html += '</div>';
        if (data.progress) {
            html += `<div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
            </div>`;
        }
        html += '</div>';
        streamStatus.innerHTML = html;
    }

    // On completion: update badges, dots, and reload entity summaries
    if (data.stage === 'COMPLETE' && data.result) {
        if (taskType === 'qc_unified') {
            const qEl = document.getElementById('questionsCount');
            const cEl = document.getElementById('conclusionsCount');
            if (qEl) qEl.textContent = data.result.questions || 0;
            if (cEl) cEl.textContent = data.result.conclusions || 0;
        } else if (taskType !== 'rich_analysis') {
            const countEl = document.getElementById(`${taskType}Count`);
            if (countEl) countEl.textContent = data.result.count || 0;
        }

        updateSubstepDot(taskType, 'complete');

        if (taskType === 'rich_analysis') {
            const phase2Indicator = document.getElementById('phase2-indicator');
            if (phase2Indicator) phase2Indicator.classList.add('phase-complete');
            enablePhase3();
        }

        // Show completion status briefly, then reload to show entity summaries
        if (streamStatus) {
            streamStatus.innerHTML = '<div class="alert alert-success py-2 mb-2"><i class="bi bi-check-circle-fill me-1"></i> Extraction complete. Refreshing...</div>';
            // Reload page after short delay to show server-rendered entity summaries
            setTimeout(() => location.reload(), 800);
        }
    }

    // Handle errors
    if (data.error && streamStatus) {
        streamStatus.innerHTML = `<div class="alert alert-danger py-2 mb-2"><i class="bi bi-exclamation-triangle me-1"></i> ${data.messages ? escapeHtml(data.messages[0]) : 'Error occurred'}</div>`;
    }
}

// Run complete synthesis (non-streaming, calls same services as individual buttons)
async function runCompleteSynthesis() {
    const button = document.getElementById('run-complete-synthesis-btn');
    const progressText = document.getElementById('synthesis-progress-text');

    // Set processing flag to warn on navigation
    isProcessing = true;

    // Show processing state
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running Complete Synthesis...';
    progressText.textContent = 'Running all phases sequentially. This may take several minutes. Do not navigate away from this page.';

    // Show interstitial in provisions stream status area
    const synthStatus = document.getElementById('provisionsStreamStatus');
    if (synthStatus) {
        synthStatus.style.display = 'block';
        synthStatus.innerHTML = `
            <div class="alert alert-info py-3">
                <h5 class="mb-3"><i class="bi bi-hourglass-split me-2"></i>Running Complete Synthesis</h5>
                <p class="mb-2">Executing all phases in sequence:</p>
                <ol class="mb-2">
                    <li>Provisions (2A)</li>
                    <li>Precedent Cases (2B)</li>
                    <li>Questions & Conclusions (2C)</li>
                    <li>Transformation Classification (2D)</li>
                    <li>Rich Analysis (2E)</li>
                    <li>Phase 3: Decision Point Synthesis</li>
                    <li>Phase 4: Narrative Construction</li>
                </ol>
                <p class="mb-0 text-muted small">Page will refresh automatically when complete.</p>
            </div>
        `;
    }

    try {
        // Call non-streaming endpoint
        const response = await fetch(`/scenario_pipeline/case/${currentCaseId}/run_complete_synthesis`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        });

        const result = await response.json();

        if (result.success) {
            // Success - clear processing flag and refresh
            isProcessing = false;
            progressText.textContent = 'Complete! Refreshing page...';
            button.innerHTML = '<i class="bi bi-check-circle"></i> Synthesis Complete';
            button.classList.remove('btn-primary');
            button.classList.add('btn-success');
            if (synthStatus) synthStatus.innerHTML = `
                <div class="alert alert-success py-3">
                    <h5 class="mb-2"><i class="bi bi-check-circle me-2"></i>Synthesis Complete!</h5>
                    <p class="mb-0">Refreshing page to show results...</p>
                </div>
            `;
            // Refresh page to show updated state
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            // Error - clear processing flag
            isProcessing = false;
            progressText.textContent = `Error: ${result.error || 'Unknown error'}`;
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Retry';
            if (synthStatus) synthStatus.innerHTML = `
                <div class="alert alert-danger py-3">
                    <h5 class="mb-2"><i class="bi bi-exclamation-triangle me-2"></i>Synthesis Failed</h5>
                    <p class="mb-0">${result.error || 'Unknown error'}</p>
                    ${result.results ? '<pre class="mt-2 small">' + JSON.stringify(result.results, null, 2) + '</pre>' : ''}
                </div>
            `;
        }
    } catch (error) {
        // Clear processing flag on error
        isProcessing = false;
        console.error('Synthesis error:', error);
        progressText.textContent = `Error: ${error.message}`;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Retry';
        if (synthStatus) synthStatus.innerHTML = `
            <div class="alert alert-danger py-3">
                <h5 class="mb-2"><i class="bi bi-exclamation-triangle me-2"></i>Request Failed</h5>
                <p class="mb-0">${error.message}</p>
            </div>
        `;
    }
}

// Phase 3 streaming messages accumulator
let phase3StreamingMessages = [];

// Run Phase 3 Decision Point Synthesis with SSE streaming
async function runPhase3Synthesis() {
    const button = document.getElementById('extractDecisionSynthesisBtn');
    const promptSection = document.getElementById('decisionSynthesisPromptSection');
    const promptText = document.getElementById('decisionSynthesisPromptText');

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Synthesizing...';

    // Reset streaming messages
    phase3StreamingMessages = [];

    // Show prompt section with initial state
    promptSection.style.display = 'block';
    promptText.innerHTML = '<div class="alert alert-info py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Starting Phase 3 synthesis...</strong></div>';

    // Reset stage badges
    ['step-e1', 'step-e2', 'step-e3', 'step-align', 'step-llm'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['e1Result', 'e2Result', 'e3Result', 'alignResult', 'llmResult'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide previous results
    document.getElementById('decisionPointsResults').style.display = 'none';
    document.getElementById('phase3LLMAccordion').style.display = 'none';

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/synthesize_phase3_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-outline-success');
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handlePhase3StreamingData(data);
                        } catch (e) {
                            console.log('Parse error:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Phase 3 streaming error:', error);
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> Error: ${error.message}</div>`;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-fill"></i> Synthesize';
    });
}

// Handle Phase 3 streaming data with blue box pattern
function handlePhase3StreamingData(data) {
    const promptSection = document.getElementById('decisionSynthesisPromptSection');
    const promptText = document.getElementById('decisionSynthesisPromptText');

    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!phase3StreamingMessages.includes(msg)) {
                phase3StreamingMessages.push(msg);
            }
        });
    }

    // Build streaming messages display (blue box)
    let html = '<div class="alert alert-info mb-2 py-2">';
    html += '<strong><i class="bi bi-gear-fill me-1"></i> Phase 3: Decision Point Synthesis</strong>';
    html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

    phase3StreamingMessages.forEach((msg, idx) => {
        const isLatest = idx === phase3StreamingMessages.length - 1;
        html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
            <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-primary' : 'check-circle text-success'} me-1"></i>
            ${escapeHtml(msg)}
        </div>`;
    });

    html += '</div>';

    // Add progress bar
    if (data.progress) {
        html += `<div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
        </div>`;
    }

    html += '</div>';
    promptText.innerHTML = html;

    // Auto-scroll
    const messagesDiv = promptText.querySelector('.streaming-messages');
    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Update stage badges
    if (data.stage) {
        if (data.stage.includes('E1')) {
            document.getElementById('step-e1').className = 'badge bg-primary mb-1';
            if (data.e1_result) document.getElementById('e1Result').textContent = data.e1_result;
        }
        if (data.stage.includes('E1_DONE')) {
            document.getElementById('step-e1').className = 'badge bg-success mb-1';
        }
        if (data.stage.includes('E2')) {
            document.getElementById('step-e2').className = 'badge bg-primary mb-1';
            if (data.e2_result) document.getElementById('e2Result').textContent = data.e2_result;
        }
        if (data.stage.includes('E2_DONE')) {
            document.getElementById('step-e2').className = 'badge bg-success mb-1';
        }
        if (data.stage.includes('E3')) {
            document.getElementById('step-e3').className = 'badge bg-primary mb-1';
            if (data.e3_result) document.getElementById('e3Result').textContent = data.e3_result;
        }
        if (data.stage.includes('3_1_DONE')) {
            document.getElementById('step-e3').className = 'badge bg-success mb-1';
            // e3_result is sent with this stage
            if (data.e3_result) document.getElementById('e3Result').textContent = data.e3_result;
        }
        // Handle LLM fallback when E3 produces 0 candidates
        if (data.stage === 'E3_LLM_FALLBACK') {
            document.getElementById('step-e3').className = 'badge bg-warning mb-1';
            document.getElementById('e3Result').textContent = '0 candidates';
            // Mark align as skipped
            document.getElementById('step-align').className = 'badge bg-secondary mb-1';
            document.getElementById('alignResult').textContent = 'skipped';
            // Mark LLM as active (fallback mode)
            document.getElementById('step-llm').className = 'badge bg-primary mb-1';
            document.getElementById('llmResult').textContent = 'fallback...';
        }
        if (data.stage === 'E3_LLM_FALLBACK_DONE') {
            document.getElementById('step-llm').className = 'badge bg-success mb-1';
            document.getElementById('llmResult').textContent = 'fallback complete';
        }
        if (data.stage.includes('3_2')) {
            document.getElementById('step-align').className = 'badge bg-primary mb-1';
            if (data.alignment_result) document.getElementById('alignResult').textContent = data.alignment_result;
        }
        if (data.stage.includes('3_2_DONE')) {
            document.getElementById('step-align').className = 'badge bg-success mb-1';
        }
        if (data.stage.includes('3_3')) {
            document.getElementById('step-llm').className = 'badge bg-primary mb-1';
            if (data.llm_result) document.getElementById('llmResult').textContent = data.llm_result;
        }
        if (data.stage.includes('3_3_DONE')) {
            document.getElementById('step-llm').className = 'badge bg-success mb-1';
        }
    }

    // Handle completion
    if (data.stage === 'COMPLETE') {
        // Update LLM result with final count if using fallback
        if (data.used_llm_fallback && data.canonical_count) {
            document.getElementById('llmResult').textContent = `${data.canonical_count} decision points`;
        }

        // Show decision points
        if (data.canonical_decision_points && data.canonical_decision_points.length > 0) {
            const resultsDiv = document.getElementById('decisionPointsResults');
            const listDiv = document.getElementById('decisionPointsList');
            resultsDiv.style.display = 'block';

            let dpHtml = '<div class="list-group">';
            data.canonical_decision_points.forEach((dp, i) => {
                const alignScore = (dp.qc_alignment_score * 100).toFixed(0);
                const alignBadge = dp.qc_alignment_score > 0.5 ? 'bg-success' : 'bg-secondary';
                dpHtml += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${dp.focus_id}: ${escapeHtml(dp.description || '')}</strong>
                                <br><small class="text-muted">${escapeHtml(dp.decision_question || '')}</small>
                            </div>
                            <span class="badge ${alignBadge}">${alignScore}% aligned</span>
                        </div>
                        ${dp.toulmin ? `
                            <div class="mt-2 small">
                                <strong>Toulmin:</strong>
                                <span class="text-muted">DATA: ${escapeHtml(dp.toulmin.data_summary || '-')}</span>
                            </div>
                        ` : ''}
                        ${dp.addresses_questions && dp.addresses_questions.filter(q => q).length > 0 ? `
                            <div class="mt-1 small text-primary">
                                Addresses: ${dp.addresses_questions.filter(q => q).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            dpHtml += '</div>';
            listDiv.innerHTML = dpHtml;
        }

        // Show LLM accordion with prompt and response
        if (data.llm_trace) {
            const accordion = document.getElementById('phase3LLMAccordion');
            accordion.style.display = 'block';

            // Add fallback indicator if LLM fallback was used
            const accordionHeader = accordion.querySelector('.accordion-button');
            if (data.used_llm_fallback && accordionHeader) {
                accordionHeader.innerHTML = '<i class="bi bi-robot me-1"></i> LLM Analysis (Fallback Mode)';
            }

            if (data.llm_trace.prompt) {
                document.getElementById('phase3PromptContent').textContent = data.llm_trace.prompt;
            }
            if (data.llm_trace.response) {
                document.getElementById('phase3ResponseContent').textContent = data.llm_trace.response;
            }
        }

        // Update phase indicator
        const phase3Indicator = document.getElementById('phase3-indicator');
        if (phase3Indicator) phase3Indicator.classList.add('phase-complete');

        // Enable Phase 4 now that Phase 3 is complete
        enablePhase4();

        // Change button to Re-run (in case stream done event doesn't fire)
        const button = document.getElementById('extractDecisionSynthesisBtn');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-outline-success');
        }
    }

    // Handle errors
    if (data.error) {
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> ${data.messages ? data.messages[0] : 'Error'}</div>`;
    }
}

// =============================================================================
// PHASE 4: NARRATIVE CONSTRUCTION
// =============================================================================

// Phase 4 streaming messages accumulator
let phase4StreamingMessages = [];

// Run Phase 4 Narrative Construction with SSE streaming
async function runPhase4Narrative() {
    console.log('[Phase 4] Starting Narrative Construction for case:', currentCaseId);

    const button = document.getElementById('extractNarrativeBtn');
    const promptSection = document.getElementById('narrativePromptSection');
    const promptText = document.getElementById('narrativePromptText');

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Constructing...';

    // Reset streaming messages
    phase4StreamingMessages = [];

    // Show prompt section with initial state
    promptSection.style.display = 'block';
    promptText.innerHTML = '<div class="alert alert-secondary py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Starting Phase 4: Narrative Construction...</strong></div>';

    // Reset stage badges
    ['step-4-1', 'step-4-2', 'step-4-3', 'step-4-4'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['stage41Result', 'stage42Result', 'stage43Result', 'stage44Result'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Clear previous result values
    ['phase4Characters', 'phase4Events', 'phase4Conflicts', 'phase4Fluents'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide previous results
    document.getElementById('phase4Results').style.display = 'none';

    // Reset LLM traces section
    const llmSection = document.getElementById('phase4LLMSection');
    const llmTraces = document.getElementById('phase4LLMTraces');
    const llmCount = document.getElementById('phase4LLMCount');
    if (llmSection) llmSection.style.display = 'none';
    if (llmTraces) llmTraces.innerHTML = '<p class="text-muted small">LLM interactions will appear here as Phase 4 progresses...</p>';
    if (llmCount) llmCount.textContent = '0';

    console.log('[Phase 4] Calling streaming endpoint...');

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/construct_phase4_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        console.log('[Phase 4] Response received:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    console.log('[Phase 4] Stream complete');
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                    button.classList.remove('btn-outline-dark');
                    button.classList.add('btn-outline-success');
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            console.log('[Phase 4] SSE data:', data.stage, data.progress);
                            handlePhase4StreamingData(data);
                        } catch (e) {
                            console.log('[Phase 4] Parse error:', line);
                        }
                    }
                });

                processStream();
            });
        }

        console.log('[Phase 4] Starting stream processing...');
        processStream();
    })
    .catch(error => {
        console.error('[Phase 4] Streaming error:', error);
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> Error: ${error.message}</div>`;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-fill"></i> Construct';
    });
}

// Handle Phase 4 streaming data
function handlePhase4StreamingData(data) {
    const promptSection = document.getElementById('narrativePromptSection');
    const promptText = document.getElementById('narrativePromptText');

    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!phase4StreamingMessages.includes(msg)) {
                phase4StreamingMessages.push(msg);
            }
        });
    }

    // Build streaming messages display (dark/gray box for Phase 4)
    let html = '<div class="alert alert-secondary mb-2 py-2">';
    html += '<strong><i class="bi bi-book me-1"></i> Phase 4: Narrative Construction</strong>';
    html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

    phase4StreamingMessages.forEach((msg, idx) => {
        const isLatest = idx === phase4StreamingMessages.length - 1;
        html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
            <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-dark' : 'check-circle text-success'} me-1"></i>
            ${escapeHtml(msg)}
        </div>`;
    });

    html += '</div>';

    // Add progress bar
    if (data.progress) {
        html += `<div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar bg-dark progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
        </div>`;
    }

    html += '</div>';
    promptText.innerHTML = html;

    // Auto-scroll
    const messagesDiv = promptText.querySelector('.streaming-messages');
    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Update stage badges based on stage
    if (data.stage) {
        if (data.stage.includes('4_1')) {
            document.getElementById('step-4-1').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_1_DONE') && data.stage_4_1_result) {
            document.getElementById('step-4-1').className = 'badge bg-success mb-1';
            const r = data.stage_4_1_result;
            document.getElementById('stage41Result').textContent = `${r.characters || 0} chars`;
        }
        if (data.stage.includes('4_2')) {
            document.getElementById('step-4-2').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_2_DONE') && data.stage_4_2_result) {
            document.getElementById('step-4-2').className = 'badge bg-success mb-1';
            const r = data.stage_4_2_result;
            document.getElementById('stage42Result').textContent = `${r.events_count || 0} events`;
        }
        if (data.stage.includes('4_3')) {
            document.getElementById('step-4-3').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_3_DONE') && data.stage_4_3_result) {
            document.getElementById('step-4-3').className = 'badge bg-success mb-1';
            const r = data.stage_4_3_result;
            document.getElementById('stage43Result').textContent = `${r.branches_count || 0} branches`;
        }
        if (data.stage.includes('4_4')) {
            document.getElementById('step-4-4').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_4_DONE') && data.stage_4_4_result) {
            document.getElementById('step-4-4').className = 'badge bg-success mb-1';
            const r = data.stage_4_4_result;
            document.getElementById('stage44Result').textContent = `${r.key_takeaways_count || 0} takeaways`;
        }
    }

    // Display LLM traces in dedicated section (outside Narrative Elements card)
    if (data.llm_traces && data.llm_traces.length > 0) {
        const llmSection = document.getElementById('phase4LLMSection');
        const llmTraces = document.getElementById('phase4LLMTraces');
        const llmCount = document.getElementById('phase4LLMCount');

        // Show the LLM section
        if (llmSection) llmSection.style.display = 'block';

        // Build HTML for each trace
        let tracesHtml = '';
        for (const trace of data.llm_traces) {
            const promptText = trace.prompt || '';
            const responseText = trace.response || '';

            tracesHtml += `<div class="card mb-3 border-secondary">
                <div class="card-header bg-secondary text-white py-2 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-robot me-2"></i> <strong>${escapeHtml(trace.description || trace.stage)}</strong></span>
                    <span class="badge bg-light text-dark">${escapeHtml(trace.model || 'claude-sonnet')}</span>
                </div>
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-6 border-end">
                            <div class="p-2">
                                <h6 class="text-primary mb-2"><i class="bi bi-chat-right-text me-1"></i> Prompt</h6>
                                <pre class="bg-light p-2 rounded mb-0" style="white-space: pre-wrap; font-size: 0.8rem; max-height: 300px; overflow-y: auto;">${escapeHtml(promptText)}</pre>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-2">
                                <h6 class="text-success mb-2"><i class="bi bi-chat-left-text me-1"></i> Response</h6>
                                <pre class="bg-light p-2 rounded mb-0" style="white-space: pre-wrap; font-size: 0.8rem; max-height: 300px; overflow-y: auto;">${escapeHtml(responseText)}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        // Append to traces container
        if (llmTraces) {
            // Clear placeholder text on first trace
            if (llmTraces.querySelector('.text-muted')) {
                llmTraces.innerHTML = '';
            }
            llmTraces.innerHTML += tracesHtml;
        }

        // Update count badge
        if (llmCount) {
            const currentCount = parseInt(llmCount.textContent) || 0;
            llmCount.textContent = currentCount + data.llm_traces.length;
        }
    }

    // Handle completion
    if (data.stage === 'COMPLETE' && data.result) {
        const resultsDiv = document.getElementById('phase4Results');
        resultsDiv.style.display = 'block';

        // Update narrative elements summary
        if (data.result.summary && data.result.summary.narrative_elements) {
            const ne = data.result.summary.narrative_elements;
            document.getElementById('phase4Characters').textContent = ne.characters || 0;
            document.getElementById('phase4Events').textContent = ne.events || 0;
            document.getElementById('phase4Conflicts').textContent = ne.conflicts || 0;
            document.getElementById('phase4Decisions').textContent = ne.decision_moments || 0;
        }

        // Update timeline preview
        if (data.result.timeline_preview) {
            document.getElementById('phase4TimelinePreview').textContent = data.result.timeline_preview;
        }

        // Update scenario opening
        if (data.result.opening_context) {
            document.getElementById('phase4OpeningContext').textContent = data.result.opening_context;
        }

        // Update key takeaways
        if (data.result.key_takeaways && data.result.key_takeaways.length > 0) {
            const takeawaysUl = document.getElementById('phase4Takeaways');
            takeawaysUl.innerHTML = data.result.key_takeaways.map(t => `<li>${escapeHtml(t)}</li>`).join('');
        }

        // Show LLM interaction count
        if (data.llm_interactions_count) {
            const statusHtml = `<div class="alert alert-success py-2 mb-2">
                <i class="bi bi-check-circle-fill me-1"></i>
                <strong>Phase 4 Complete</strong> - ${data.llm_interactions_count} LLM stages executed
            </div>`;
            promptText.innerHTML = statusHtml + promptText.innerHTML;
        }

        // Update phase indicator
        const phase4Indicator = document.getElementById('phase4-indicator');
        if (phase4Indicator) phase4Indicator.classList.add('phase-complete');

        // Change button to Re-run
        const button = document.getElementById('extractNarrativeBtn');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
            button.classList.remove('btn-outline-dark');
            button.classList.add('btn-outline-success');
        }
    }

    // Handle errors
    if (data.error) {
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> ${data.messages ? data.messages[0] : 'Error'}</div>`;
    }
}

// Handle streaming data updates
function handleStreamingData(data) {
    const progressText = document.getElementById('synthesis-progress-text');

    // Update progress text
    if (data.messages && data.messages.length > 0) {
        progressText.textContent = data.messages[data.messages.length - 1];
    }

    // Update top-level phase indicators (the 1-2-3-4 boxes)
    if (data.stage) {
        if (data.stage === 'PHASE_2_INDICATOR' || data.stage.startsWith('PART_A') || data.stage.startsWith('PART_B') ||
            data.stage.startsWith('PART_C') || data.stage.includes('TRANSFORMATION') || data.stage.includes('RICH')) {
            setPhaseActive('phase2-indicator');
        } else if (data.stage === 'PHASE_3_INDICATOR' || data.stage.includes('DECISION')) {
            setPhaseActive('phase3-indicator');
            setPhaseComplete('phase2-indicator');
        } else if (data.stage === 'PHASE_4_INDICATOR' || data.stage.includes('NARRATIVE')) {
            setPhaseActive('phase4-indicator');
            setPhaseComplete('phase3-indicator');
        } else if (data.stage === 'COMPLETE') {
            setPhaseComplete('phase4-indicator');
        }
    }

    // Update individual task indicators based on stage
    if (data.stage) {
        if (data.stage.startsWith('PART_A')) {
            updatePhaseIndicator('provisions');
            updatePromptSection('provisions', data);
        } else if (data.stage.startsWith('PART_B')) {
            updatePhaseIndicator('questions');
            updatePromptSection('questions', data);
        } else if (data.stage.startsWith('PART_C') || data.stage.includes('TRANSFORMATION')) {
            updatePhaseIndicator('transformation');
            updatePromptSection('transformation', data);
        } else if (data.stage.includes('RICH') || data.stage.includes('ANALYSIS')) {
            updatePhaseIndicator('rich_analysis');
        } else if (data.stage.includes('DECISION')) {
            updatePhaseIndicator('decision_synthesis');
        } else if (data.stage.includes('NARRATIVE')) {
            updatePhaseIndicator('narrative');
        }
    }

    // Update counts when complete
    if (data.stage === 'PART_A_COMPLETE' && data.result) {
        document.getElementById('provisionsCount').textContent = data.result.provision_count || 0;
        markTaskComplete('provisions');
    } else if (data.stage === 'PART_B_COMPLETE' && data.result) {
        document.getElementById('questionsCount').textContent = data.result.question_count || 0;
        document.getElementById('conclusionsCount').textContent = data.result.conclusion_count || 0;
        markTaskComplete('questions');
        markTaskComplete('conclusions');
    } else if (data.stage === 'PART_C_COMPLETE' || data.stage === 'TRANSFORMATION_COMPLETE') {
        if (data.result && data.result.transformation_type) {
            document.getElementById('transformationType').textContent = data.result.transformation_type;
        }
        markTaskComplete('transformation');
    } else if (data.stage === 'COMPLETE') {
        // Final completion
        markTaskComplete('rich_analysis');
        markTaskComplete('decision_synthesis');
        markTaskComplete('narrative');
    }

    // Show LLM traces
    if (data.llm_trace) {
        showLLMTrace(data.stage, data.llm_trace);
    }
}

// Track streaming messages per task
const streamingMessages = {
    provisions: [],
    questions: [],
    conclusions: [],
    transformation: [],
    rich_analysis: [],
    decision_synthesis: [],
    narrative: []
};

// Update stream status area with run-all progress messages
function updatePromptSection(taskType, data) {
    const streamStatus = document.getElementById(`${taskType}StreamStatus`);
    if (!streamStatus) return;

    streamStatus.style.display = 'block';

    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!streamingMessages[taskType].includes(msg)) {
                streamingMessages[taskType].push(msg);
            }
        });
    }

    // Show latest message as a compact status line
    const latest = streamingMessages[taskType][streamingMessages[taskType].length - 1];
    if (latest) {
        streamStatus.innerHTML = `<div class="alert alert-info py-2 mb-2 small">
            <i class="bi bi-gear-fill me-1"></i> ${escapeHtml(latest)}
        </div>`;
    }
}

// LLM traces for Phase 2 tasks are available in the Provenance view
function showLLMTrace(stage, trace) {
    // No-op: prompt/response details shown in provenance, not inline
}

// Mark a task button as complete (shows Re-run)
function markTaskComplete(taskType) {
    const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
    if (button) {
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
        button.classList.add('btn-outline-secondary');
        button.classList.remove('btn-outline-warning', 'btn-outline-success', 'btn-outline-info', 'btn-outline-primary', 'btn-outline-dark');
    }
}

async function runSingleTask(taskType) {
    return new Promise((resolve, reject) => {
        const endpoints = {
            'provisions': 'extract_provisions',
            'questions': 'extract_questions',
            'conclusions': 'extract_conclusions',
            'qc_unified': 'extract_qc_unified',  // Q + C + Link atomically
            'transformation': 'extract_transformation',
            'rich_analysis': 'extract_rich_analysis',
            'decision_synthesis': 'extract_decision_synthesis',
            'narrative': 'extract_narrative'
        };

        fetch(`/scenario_pipeline/case/${currentCaseId}/${endpoints[taskType]}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI with results
                handleTaskResults(taskType, data);
                updateCountBadges(taskType, data.result);

                // Mark button as done
                const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
                if (button) {
                    button.innerHTML = '<i class="bi bi-check-circle"></i> Done';
                    button.classList.add('btn-success');
                }

                resolve(data);
            } else {
                reject(new Error(data.error || 'Task failed'));
            }
        })
        .catch(reject);
    });
}

// Set a phase indicator to active (with animation)
function setPhaseActive(phaseId) {
    const indicator = document.getElementById(phaseId);
    if (indicator) {
        // Remove complete state, add active state
        indicator.classList.remove('phase-complete');
        indicator.classList.add('phase-active');
    }
}

// Set a phase indicator to complete
function setPhaseComplete(phaseId) {
    const indicator = document.getElementById(phaseId);
    if (indicator) {
        // Remove active state, add complete state
        indicator.classList.remove('phase-active');
        indicator.classList.add('phase-complete');
    }
}

function updatePhaseIndicator(currentTask) {
    const phaseMap = {
        'provisions': 'phase2',
        'questions': 'phase2',
        'conclusions': 'phase2',
        'transformation': 'phase2',
        'rich_analysis': 'phase2',
        'decision_synthesis': 'phase3',
        'narrative': 'phase4'
    };

    const phase = phaseMap[currentTask];

    // Remove active from all except phase 1 (always complete)
    ['phase2', 'phase3', 'phase4'].forEach(p => {
        const indicator = document.getElementById(`${p}-indicator`);
        if (indicator) {
            indicator.classList.remove('phase-active');
        }
    });

    // Set current phase as active
    const currentIndicator = document.getElementById(`${phase}-indicator`);
    if (currentIndicator) {
        currentIndicator.classList.add('phase-active');
    }
}

// Load saved prompts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedPrompts();
    loadPhase3Results();
    loadPhase4Results();
});

// Load persisted Phase 4 narrative construction results
function loadPhase4Results() {
    {% if phase4_data %}
    const phase4Data = {{ phase4_data | tojson | safe }};

    if (phase4Data) {
        displayPhase4Data(phase4Data);
    }
    {% else %}
    // Fallback: fetch from API if not in template context
    loadSavedPhase4Results();
    {% endif %}
}

// Display Phase 4 data (handles various data structures)
function displayPhase4Data(data) {
    // Show the results section
    const resultsDiv = document.getElementById('phase4Results');
    if (resultsDiv) resultsDiv.style.display = 'block';

    // Extract counts from various possible structures
    let charCount = 0, eventCount = 0, conflictCount = 0, fluentCount = 0;

    // Handle narrative_elements structure
    if (data.narrative_elements) {
        const ne = data.narrative_elements;
        charCount = Array.isArray(ne.characters) ? ne.characters.length : (ne.characters || 0);
        conflictCount = Array.isArray(ne.conflicts) ? ne.conflicts.length : (ne.conflicts || 0);
    }

    // Handle direct arrays (from streaming result)
    if (data.characters) charCount = Array.isArray(data.characters) ? data.characters.length : data.characters;
    if (data.conflicts) conflictCount = Array.isArray(data.conflicts) ? data.conflicts.length : data.conflicts;

    // Handle timeline (full structure from to_dict())
    if (data.timeline) {
        if (Array.isArray(data.timeline)) {
            eventCount = data.timeline.length;
        } else {
            if (data.timeline.events) {
                eventCount = data.timeline.events.length;
            }
            if (data.timeline.initial_fluents) {
                fluentCount = data.timeline.initial_fluents.length;
            }
        }
    }

    // Update counts in summary
    document.getElementById('phase4Characters').textContent = charCount;
    document.getElementById('phase4Events').textContent = eventCount;
    document.getElementById('phase4Conflicts').textContent = conflictCount;
    document.getElementById('phase4Fluents').textContent = fluentCount;

    // Update stage result placeholders
    document.getElementById('stage41Result').textContent = `${charCount} chars`;
    document.getElementById('stage42Result').textContent = `${eventCount} events`;
    document.getElementById('stage43Result').textContent = `${conflictCount} conflicts`;
    document.getElementById('stage44Result').textContent = `${fluentCount} fluents`;

    // Mark Phase 4 stage badges as complete
    ['step-4-1', 'step-4-2', 'step-4-3', 'step-4-4'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-success mb-1';
    });

    // Update phase indicator
    const phase4Indicator = document.getElementById('phase4-indicator');
    if (phase4Indicator) phase4Indicator.classList.add('phase-complete');

    // Change button to Re-run
    const button = document.getElementById('extractNarrativeBtn');
    if (button) {
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
        button.classList.remove('btn-outline-secondary', 'btn-outline-dark');
        button.classList.add('btn-outline-success');
        button.title = '';
    }

    // Display saved LLM traces if available
    if (data.llm_traces && data.llm_traces.length > 0) {
        displaySavedLLMTraces(data.llm_traces);
    }

    console.log('Phase 4 results displayed');
}

// Display saved LLM traces in the LLM Interactions section
function displaySavedLLMTraces(traces) {
    const llmSection = document.getElementById('phase4LLMSection');
    const llmTracesDiv = document.getElementById('phase4LLMTraces');
    const llmCount = document.getElementById('phase4LLMCount');

    if (!llmSection || !llmTracesDiv) return;

    // Show the section
    llmSection.style.display = 'block';

    // Build HTML for traces
    let tracesHtml = '';
    for (const trace of traces) {
        const promptText = trace.prompt || '';
        const responseText = trace.response || '';

        tracesHtml += `<div class="card mb-3 border-secondary">
            <div class="card-header bg-secondary text-white py-2 d-flex justify-content-between align-items-center">
                <span><i class="bi bi-robot me-2"></i> <strong>${escapeHtml(trace.description || trace.stage)}</strong></span>
                <span class="badge bg-light text-dark">${escapeHtml(trace.model || 'claude-sonnet')}</span>
            </div>
            <div class="card-body p-0">
                <div class="row g-0">
                    <div class="col-md-6 border-end">
                        <div class="p-2">
                            <h6 class="text-primary mb-2"><i class="bi bi-chat-right-text me-1"></i> Prompt</h6>
                            <pre class="bg-light p-2 rounded mb-0" style="white-space: pre-wrap; font-size: 0.8rem; max-height: 300px; overflow-y: auto;">${escapeHtml(promptText)}</pre>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-2">
                            <h6 class="text-success mb-2"><i class="bi bi-chat-left-text me-1"></i> Response</h6>
                            <pre class="bg-light p-2 rounded mb-0" style="white-space: pre-wrap; font-size: 0.8rem; max-height: 300px; overflow-y: auto;">${escapeHtml(responseText)}</pre>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // Set traces HTML
    llmTracesDiv.innerHTML = tracesHtml;

    // Update count
    if (llmCount) llmCount.textContent = traces.length;
}

function loadPhase3Results() {
    fetch(`/scenario_pipeline/case/${currentCaseId}/phase3_results`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.canonical_decision_points && data.canonical_decision_points.length > 0) {
                // Display decision points
                const resultsDiv = document.getElementById('decisionPointsResults');
                const listDiv = document.getElementById('decisionPointsList');
                resultsDiv.style.display = 'block';

                let dpHtml = '<div class="list-group">';
                data.canonical_decision_points.forEach((dp, i) => {
                    const alignScore = ((dp.qc_alignment_score || 0) * 100).toFixed(0);
                    const alignBadge = (dp.qc_alignment_score || 0) > 0.5 ? 'bg-success' : 'bg-secondary';
                    dpHtml += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${dp.focus_id || 'DP' + (i+1)}: ${escapeHtml(dp.description || '')}</strong>
                                    <br><small class="text-muted">${escapeHtml(dp.decision_question || '')}</small>
                                </div>
                                <span class="badge ${alignBadge}">${alignScore}% aligned</span>
                            </div>
                            ${dp.toulmin ? `
                                <div class="mt-2 small">
                                    <strong>Toulmin:</strong>
                                    <span class="text-muted">DATA: ${escapeHtml(dp.toulmin.data_summary || '-')}</span>
                                </div>
                            ` : ''}
                            ${dp.addresses_questions && dp.addresses_questions.filter(q => q).length > 0 ? `
                                <div class="mt-1 small text-primary">
                                    Addresses: ${dp.addresses_questions.filter(q => q).join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                dpHtml += '</div>';
                listDiv.innerHTML = dpHtml;

                // Update button to Re-run
                const button = document.getElementById('extractDecisionSynthesisBtn');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-outline-success');
                }

                // Populate E1-E3 and LLM badges if data available
                if (data.e1_obligations > 0 || data.e1_decision_relevant > 0) {
                    document.getElementById('step-e1').className = 'badge bg-success mb-1';
                    document.getElementById('e1Result').textContent = `${data.e1_obligations} obligations`;
                }
                if (data.e2_action_sets > 0) {
                    document.getElementById('step-e2').className = 'badge bg-success mb-1';
                    document.getElementById('e2Result').textContent = `${data.e2_action_sets} action sets`;
                }
                if (data.e3_candidates > 0) {
                    document.getElementById('step-e3').className = 'badge bg-success mb-1';
                    document.getElementById('e3Result').textContent = `${data.e3_candidates} candidates`;
                }
                if (data.canonical_count > 0) {
                    document.getElementById('step-llm').className = 'badge bg-success mb-1';
                    document.getElementById('llmResult').textContent = `${data.canonical_count} decision pts`;
                }

                // Show LLM trace if available
                if (data.llm_trace) {
                    const accordion = document.getElementById('phase3LLMAccordion');
                    if (accordion) {
                        accordion.style.display = 'block';
                        if (data.llm_trace.prompt) {
                            document.getElementById('phase3PromptContent').textContent = data.llm_trace.prompt;
                        }
                        if (data.llm_trace.response) {
                            document.getElementById('phase3ResponseContent').textContent = data.llm_trace.response;
                        }
                    }
                }

                // Show synthesis trace (MCP resolution info) if available
                if (data.synthesis_trace) {
                    displaySynthesisTrace(data.synthesis_trace);
                }

                // Mark phase indicator as complete
                const phase3Indicator = document.getElementById('phase3-indicator');
                if (phase3Indicator) phase3Indicator.classList.add('phase-complete');

                // Enable Phase 4 now that Phase 3 is complete
                enablePhase4();

                console.log(`Loaded ${data.canonical_decision_points.length} Phase 3 decision points`);
            }
        })
        .catch(error => console.log('No saved Phase 3 results:', error));
}

// Enable Phase 3 button when Phase 2 is complete
function enablePhase3() {
    const phase3Btn = document.getElementById('extractDecisionSynthesisBtn');
    if (phase3Btn) {
        phase3Btn.disabled = false;
        phase3Btn.classList.remove('btn-outline-secondary');
        phase3Btn.classList.add('btn-outline-primary');
        phase3Btn.innerHTML = '<i class="bi bi-play-fill"></i> Synthesize';
        phase3Btn.title = '';
    }
}

// Enable Phase 4 button when Phase 3 is complete
function enablePhase4() {
    const phase4Btn = document.getElementById('extractNarrativeBtn');
    if (phase4Btn) {
        phase4Btn.disabled = false;
        phase4Btn.classList.remove('btn-outline-secondary');
        phase4Btn.classList.add('btn-outline-dark');
        phase4Btn.innerHTML = '<i class="bi bi-play-fill"></i> Construct';
        phase4Btn.title = '';
    }
}

// Display synthesis trace/provenance information
function displaySynthesisTrace(trace) {
    const container = document.getElementById('phase3SynthesisTrace');
    if (!container || !trace) return;

    let html = '<div class="small">';

    // Timing info
    if (trace.synthesis_started || trace.synthesis_completed) {
        html += '<div class="mb-2"><strong><i class="bi bi-clock me-1"></i>Timing</strong>';
        if (trace.synthesis_started) html += `<br>Started: ${trace.synthesis_started}`;
        if (trace.synthesis_completed) html += `<br>Completed: ${trace.synthesis_completed}`;
        html += '</div>';
    }

    // Entity Resolution (MCP info)
    if (trace.entity_resolution) {
        const er = trace.entity_resolution;
        html += '<div class="mb-2 p-2 bg-light rounded">';
        html += '<strong><i class="bi bi-link-45deg me-1"></i>Entity Resolution (MCP)</strong>';
        html += `<div class="mt-1">`;
        html += `<span class="badge bg-success me-1">${er.mcp_resolved_count || 0} from MCP</span>`;
        html += `<span class="badge bg-warning me-1">${er.local_resolved_count || 0} from local</span>`;
        html += `<span class="badge bg-secondary">${er.entities_not_found || 0} not found</span>`;
        html += `</div>`;
        if (er.mcp_server_url) {
            html += `<small class="text-muted">Server: ${er.mcp_server_url}</small>`;
        }

        // Show resolved entities
        if (er.entities_resolved && er.entities_resolved.length > 0) {
            html += '<details class="mt-2"><summary class="text-primary" style="cursor: pointer;">Resolved Entities</summary>';
            html += '<ul class="list-unstyled mt-1 ms-2">';
            er.entities_resolved.forEach(e => {
                const srcBadge = e.source === 'mcp' ? 'success' : e.source === 'local' ? 'warning' : 'secondary';
                const icon = e.found ? 'check-circle' : 'x-circle';
                html += `<li class="mb-1">
                    <i class="bi bi-${icon} text-${e.found ? 'success' : 'danger'} me-1"></i>
                    <span class="badge bg-${srcBadge} me-1">${e.source}</span>
                    <strong>${e.label}</strong> <small class="text-muted">(${e.entity_type})</small>
                </li>`;
            });
            html += '</ul></details>';
        }
        html += '</div>';
    }

    // Algorithmic Composition
    if (trace.algorithmic_composition) {
        const ac = trace.algorithmic_composition;
        html += '<div class="mb-2">';
        html += '<strong><i class="bi bi-gear me-1"></i>Algorithmic Composition</strong>';
        html += `<br>Method: ${ac.method || 'E1-E3'}`;
        html += `<br>Candidates: ${ac.candidates_count || 0}`;
        html += '</div>';
    }

    // Q&C Alignment
    if (trace.qc_alignment) {
        const qc = trace.qc_alignment;
        html += '<div class="mb-2">';
        html += '<strong><i class="bi bi-check2-square me-1"></i>Q&C Alignment</strong>';
        html += `<br>High alignment (&gt;0.5): ${qc.high_alignment_count || 0}`;
        if (qc.top_scores && qc.top_scores.length > 0) {
            html += '<br>Top scores: ';
            qc.top_scores.slice(0, 3).forEach(s => {
                html += `<span class="badge bg-info me-1">${s.candidate_id}: ${(s.score * 100).toFixed(0)}%</span>`;
            });
        }
        html += '</div>';
    }

    // LLM Refinement
    if (trace.llm_refinement && trace.llm_refinement.model) {
        const llm = trace.llm_refinement;
        html += '<div class="mb-2">';
        html += '<strong><i class="bi bi-robot me-1"></i>LLM Refinement</strong>';
        html += `<br>Model: ${llm.model}`;
        html += `<br>Prompt: ${llm.prompt_length || 0} chars, Response: ${llm.response_length || 0} chars`;
        html += '</div>';
    }

    // Output
    if (trace.output) {
        html += '<div class="mb-2">';
        html += '<strong><i class="bi bi-box-arrow-right me-1"></i>Output</strong>';
        html += `<br>Decision points produced: <span class="badge bg-primary">${trace.output.canonical_points_produced || 0}</span>`;
        html += '</div>';
    }

    html += '</div>';
    container.innerHTML = html;
}

// Load saved Phase 4 results via API
function loadSavedPhase4Results() {
    fetch(`/scenario_pipeline/case/${currentCaseId}/get_phase4_data`)
        .then(response => response.json())
        .then(data => {
            if (data.has_phase4 && data.result) {
                displayPhase4Data(data.result);
            }
        })
        .catch(error => console.log('No saved Phase 4 results:', error));
}

// Update Phase 2 substep progress dots
function updateSubstepDot(taskType, status) {
    const dotMapping = {
        'provisions': 'p2-provisions',
        'precedents': 'p2-precedents',
        'questions': 'p2-questions',
        'conclusions': 'p2-conclusions',
        'transformation': 'p2-transformation',
        'rich_analysis': 'p2-rich'
    };
    const dotId = dotMapping[taskType];
    if (dotId) {
        const dot = document.getElementById(dotId);
        if (dot) {
            dot.classList.remove('active', 'complete');
            if (status === 'active') {
                dot.classList.add('active');
            } else if (status === 'complete') {
                dot.classList.add('complete');
            }
        }
    }
}

function loadSavedPrompts() {
    const tasks = ['provisions', 'precedents', 'questions', 'conclusions', 'transformation', 'rich_analysis'];
    const completedTasks = new Set();

    // Track completed tasks and update phase2 indicator when core tasks complete
    // Core tasks: transformation (2D) and rich_analysis (2E) indicate Phase 2 is done
    function checkPhase2Complete() {
        const coreTasks = ['transformation', 'rich_analysis'];
        const coreComplete = coreTasks.every(t => completedTasks.has(t));
        if (coreComplete) {
            const phase2Indicator = document.getElementById('phase2-indicator');
            if (phase2Indicator) {
                phase2Indicator.classList.add('phase-complete');
            }
            // Enable Phase 3 now that Phase 2 is complete
            enablePhase3();
            console.log('Phase 2 (Analytical Extraction) complete - Phase 3 unlocked');
        }
    }

    tasks.forEach(task => {
        fetch(`/scenario_pipeline/case/${currentCaseId}/get_saved_step4_prompt?task_type=${task}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.prompt_text) {
                    // Mark button as done with Re-run styling
                    const button = document.getElementById(`extract${capitalizeFirst(task)}Btn`);
                    if (button) {
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                        button.classList.remove('btn-secondary', 'btn-warning', 'btn-success', 'btn-info');
                        button.classList.add('btn-outline-success');
                    }

                    // Track this task as complete and update substep dot
                    completedTasks.add(task);
                    updateSubstepDot(task, 'complete');
                    checkPhase2Complete();
                }
            })
            .catch(error => console.log(`No saved prompt for ${task}`));
    });
}

// Commit functionality moved to /step4/entities page
</script>
{% endblock %}
