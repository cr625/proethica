{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 4: Case Synthesis{% endblock %}
{% block step_header %}Step 4: Case Synthesis{% endblock %}
{% block step_subtitle %}Build a coherent case model from extracted entities{% endblock %}

{% block step_content %}

<!-- Synthesis Pipeline Overview -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3-fill"></i> Four-Phase Synthesis Pipeline
        </h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div id="phase1-indicator" class="phase-indicator">
                    <span class="phase-number">1</span>
                    <div class="phase-label">Entity Foundation</div>
                    <small class="text-muted">Passes 1-3 entities</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase2-indicator" class="phase-indicator">
                    <span class="phase-number">2</span>
                    <div class="phase-label">Analytical Extraction</div>
                    <small class="text-muted">Provisions, Q&C</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase3-indicator" class="phase-indicator">
                    <span class="phase-number">3</span>
                    <div class="phase-label">Decision Synthesis</div>
                    <small class="text-muted">E1-E3 + LLM</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase4-indicator" class="phase-indicator">
                    <span class="phase-number">4</span>
                    <div class="phase-label">Narrative</div>
                    <small class="text-muted">Timeline + Scenario</small>
                </div>
            </div>
        </div>

        <hr>

        <div class="text-center">
            {% if current_user.is_authenticated %}
            <button type="button" id="run-complete-synthesis-btn" class="btn btn-primary btn-lg" onclick="runCompleteSynthesis()">
                <i class="bi bi-play-circle"></i> Run Complete Synthesis
            </button>
            <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-outline-secondary btn-lg ms-2">
                <i class="bi bi-eye"></i> View Full Analysis
            </a>
            {% else %}
            <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='{{ url_for('auth.login') }}';">
                <i class="bi bi-lock-fill"></i> Login to Run Synthesis
            </button>
            {% endif %}
            <div id="synthesis-progress-text" class="mt-2 text-muted"></div>
        </div>
    </div>
</div>

<!-- Phase 1: Entity Foundation -->
<div class="card mb-4" id="phase1-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <span class="badge bg-primary me-2">Phase 1</span> Entity Foundation
        </h5>
        <span id="phase1-status" class="badge bg-success">{{ entities_summary.total }} entities</span>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Pass 1 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 1: Contextual Framework</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-primary me-1">{{ entities_summary.roles }}</span> Roles</li>
                    <li><span class="badge bg-info me-1">{{ entities_summary.states }}</span> States</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.resources }}</span> Resources</li>
                </ul>
            </div>

            <!-- Pass 2 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 2: Normative Requirements</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-purple me-1">{{ entities_summary.principles }}</span> Principles</li>
                    <li><span class="badge bg-warning text-dark me-1">{{ entities_summary.obligations }}</span> Obligations</li>
                    <li><span class="badge bg-danger me-1">{{ entities_summary.constraints }}</span> Constraints</li>
                    <li><span class="badge bg-success me-1">{{ entities_summary.capabilities }}</span> Capabilities</li>
                </ul>
            </div>

            <!-- Pass 3 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 3: Temporal Dynamics</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-dark me-1">{{ entities_summary.actions }}</span> Actions</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.events }}</span> Events</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Phase 2: Analytical Extraction -->
<div class="card mb-4" id="phase2-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 2</span> Analytical Extraction
        </h5>
        <span id="phase2-status" class="badge {% if synthesis_status.completed %}bg-success{% else %}bg-warning text-dark{% endif %}">
            {% if synthesis_status.completed %}
            {{ synthesis_status.provisions_count + synthesis_status.questions_count + synthesis_status.conclusions_count }} elements
            {% else %}
            Not extracted
            {% endif %}
        </span>
    </div>
    <div class="card-body">
        {% if synthesis_status.completed %}
        <div class="row">
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center py-3">
                        <h3 class="mb-0">{{ synthesis_status.provisions_count }}</h3>
                        <small class="text-muted">Code Provisions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center py-3">
                        <h3 class="mb-0">{{ synthesis_status.questions_count }}</h3>
                        <small class="text-muted">Ethical Questions</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-body text-center py-3">
                        <h3 class="mb-0">{{ synthesis_status.conclusions_count }}</h3>
                        <small class="text-muted">Board Conclusions</small>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center py-4 text-muted">
            <i class="bi bi-hourglass" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">Run synthesis to extract provisions, questions, and conclusions</p>
        </div>
        {% endif %}

        <!-- Rich Analysis Section (populated by JavaScript after synthesis) -->
        <div id="phase2-rich-analysis" class="mt-4" style="display: none;">
            <hr>
            <h6 class="text-primary mb-3">
                <i class="bi bi-diagram-3"></i> Rich Analysis
                <small class="text-muted">(Phase 2B)</small>
            </h6>

            <!-- Causal-Normative Links -->
            <div class="mb-4">
                <h6 class="text-secondary">
                    <i class="bi bi-link-45deg"></i> Causal-Normative Links
                    <span id="causal-links-count" class="badge bg-info ms-1">0</span>
                </h6>
                <p class="text-muted small mb-2">How actions relate to obligations, principles, and constraints</p>
                <div id="causal-links-list" class="small">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Question Emergence -->
            <div class="mb-4">
                <h6 class="text-secondary">
                    <i class="bi bi-question-circle"></i> Question Emergence Analysis
                    <span id="question-emergence-count" class="badge bg-warning text-dark ms-1">0</span>
                </h6>
                <p class="text-muted small mb-2">Why each ethical question emerged from the case</p>
                <div id="question-emergence-list" class="small">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Resolution Patterns -->
            <div class="mb-4">
                <h6 class="text-secondary">
                    <i class="bi bi-check2-square"></i> Resolution Pattern Analysis
                    <span id="resolution-patterns-count" class="badge bg-success ms-1">0</span>
                </h6>
                <p class="text-muted small mb-2">How the board resolved each question</p>
                <div id="resolution-patterns-list" class="small">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- LLM Traces for Phase 2 (collapsed by default) -->
        <div id="phase2-traces" class="mt-3" style="display: none;">
            <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#phase2-traces-content">
                <i class="bi bi-code-slash"></i> Show LLM Reasoning
            </button>
            <div class="collapse mt-2" id="phase2-traces-content">
                <div class="accordion" id="phase2-traces-accordion">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 3: Decision Point Synthesis -->
<div class="card mb-4" id="phase3-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 3</span> Decision Point Synthesis
        </h5>
        <span id="phase3-status" class="badge bg-secondary">Not run</span>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Combines E1-E3 algorithmic composition with LLM refinement using Q&C as ground truth.
            Produces canonical decision points aligned with Board's questions and conclusions.
        </p>

        <!-- Pipeline Steps -->
        <div class="row text-center small mb-3">
            <div class="col border-end">
                <span id="step-s1" class="badge bg-secondary mb-1">S1</span><br>
                Entity Relations
            </div>
            <div class="col border-end">
                <span id="step-s2" class="badge bg-secondary mb-1">S2</span><br>
                Decision Points (E1-E3)
            </div>
            <div class="col border-end">
                <span id="step-s3" class="badge bg-secondary mb-1">S3</span><br>
                LLM + Q&C Alignment
            </div>
            <div class="col">
                <span id="step-s4" class="badge bg-secondary mb-1">S4</span><br>
                Store Results
            </div>
        </div>

        <!-- Decision Points Display -->
        <div id="phase3-results" class="mt-3" style="display: none;">
            <div class="alert alert-success">
                <strong><i class="bi bi-check-circle"></i> Synthesis Complete</strong>
                <p class="mb-1 mt-2">
                    <span id="canonical-count">0</span> canonical decision points created
                    (<span id="qc-aligned-count">0</span> Q&C aligned)
                </p>
                <p class="mb-0 small">
                    <span id="algorithmic-count">0</span> algorithmic candidates processed
                </p>
            </div>
        </div>

        <!-- LLM Traces for Phase 3 (collapsed by default) -->
        <div id="phase3-traces" class="mt-3" style="display: none;">
            <div class="accordion" id="phase3-traces-accordion">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Phase 4: Narrative Construction -->
<div class="card mb-4" id="phase4-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 4</span> Narrative Construction
        </h5>
        <span id="phase4-status" class="badge bg-secondary">Pending</span>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Builds timeline and scenario elements from synthesized entities for case explanation and Step 5 scenario generation.
        </p>

        <!-- Case Summary (shown after synthesis) -->
        <div id="case-summary-area" style="display: none;">
            <h6>Case Summary</h6>
            <div id="case-summary-text" class="alert alert-light mb-3"></div>
        </div>

        <!-- Timeline Preview (shown after synthesis) -->
        <div id="timeline-preview" style="display: none;">
            <h6>Timeline</h6>
            <div id="timeline-events" class="mb-3"></div>
        </div>

        <!-- Scenario Seeds (shown after synthesis) -->
        <div id="scenario-seeds-area" style="display: none;">
            <h6>Scenario Seeds (for Step 5)</h6>
            <div id="scenario-seeds-content" class="alert alert-info small"></div>
        </div>

        <!-- LLM Traces for Phase 4 (collapsed by default) -->
        <div id="phase4-traces" class="mt-3" style="display: none;">
            <div class="accordion" id="phase4-traces-accordion">
                <!-- Populated by JavaScript -->
            </div>
        </div>

        <div class="text-center py-3" id="phase4-placeholder">
            <i class="bi bi-hourglass text-muted" style="font-size: 2rem;"></i>
            <p class="text-muted mt-2 mb-0">Run complete synthesis to generate narrative elements</p>
        </div>
    </div>
</div>

<!-- Navigation to review page -->
<div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
    <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-outline-primary">
        <i class="bi bi-eye"></i> Review Step 4 Synthesis Results
    </a>
</div>

{% endblock %}

{% block step_scripts %}
<script>
const currentCaseId = {{ case.id }};
let messageCount = 0;
let synthesisData = {
    stages: [],
    totalMessages: 0,
    startTime: null,
    endTime: null
};

// Attach clear button handler on page load
document.addEventListener('DOMContentLoaded', function() {
    const clearBtn = document.getElementById('clear-pass4-btn');
    if (clearBtn) {
        clearBtn.addEventListener('click', clearPass4Data);
    }
});

function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

function clearPass4Data() {
    if (!confirm('This will clear all whole-case synthesis data (code provisions, questions, conclusions analysis) for this case.\n\nYou can re-run synthesis afterward if needed. Continue?')) {
        return;
    }

    const button = document.getElementById('clear-pass4-btn');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Clearing...';

    fetch(`/scenario_pipeline/case/${currentCaseId}/entities/clear_and_rerun/pass4`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide warning banner and reload page
            alert('Step 4 synthesis data cleared successfully.\n\nYou can now run synthesis again.');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to clear synthesis'));
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-trash"></i> Clear Synthesis Data';
        }
    })
    .catch(error => {
        alert('Error clearing synthesis: ' + error.message);
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash"></i> Clear Synthesis Data';
    });
}

function toggleLog() {
    const messagesDiv = document.getElementById("progress-messages");
    const toggleIcon = document.getElementById("log-toggle-icon");
    if (messagesDiv.style.display === "none") {
        messagesDiv.style.display = "block";
        toggleIcon.className = "bi bi-chevron-down";
    } else {
        messagesDiv.style.display = "none";
        toggleIcon.className = "bi bi-chevron-right";
    }
}

function runSynthesis() {
    const progressCard = document.getElementById('synthesis-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressIcon = document.getElementById('progress-icon');
    const progressHeader = document.getElementById('progress-header-text');
    const messagesDiv = document.getElementById('progress-messages');
    const stageInfo = document.getElementById('stage-info');
    const currentStageSpan = document.getElementById('current-stage');
    const summaryCard = document.getElementById('synthesis-summary');
    const accordionContainer = document.getElementById('synthesis-stages-accordion');

    // Reset state
    messageCount = 0;
    synthesisData = {
        stages: [],
        totalMessages: 0,
        startTime: new Date(),
        endTime: null
    };

    // Show progress card and reset UI
    if (progressCard) {
        progressCard.style.display = 'block';
    }
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    messagesDiv.innerHTML = '<div class="text-muted"><i class="bi bi-hourglass-split"></i> Clearing previous data...</div>';
    summaryCard.style.display = 'none';
    stageInfo.style.display = 'block';
    progressIcon.className = 'bi bi-hourglass-split';
    currentStageSpan.textContent = 'Clearing previous synthesis data...';
    document.getElementById('log-count').textContent = '0 messages';

    // Reset accordion
    if (accordionContainer) {
        accordionContainer.innerHTML = '<em class="text-muted">Stages will appear here as synthesis progresses...</em>';
    }

    // Scroll to progress card
    progressCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Clear existing data first, then run synthesis
    fetch(`/scenario_pipeline/case/${currentCaseId}/entities/clear_and_rerun/pass4`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(clearResult => {
        if (!clearResult.success) {
            console.warn('Could not clear previous data:', clearResult.error);
        }
        messagesDiv.innerHTML = '';
        currentStageSpan.textContent = 'Initializing...';
        startSynthesisStream();
    })
    .catch(error => {
        console.warn('Error clearing data (proceeding anyway):', error);
        messagesDiv.innerHTML = '';
        currentStageSpan.textContent = 'Initializing...';
        startSynthesisStream();
    });
}

function startSynthesisStream() {
    // Get DOM elements (re-query since these are needed in this scope)
    const progressBar = document.getElementById('progress-bar');
    const progressIcon = document.getElementById('progress-icon');
    const progressHeader = document.getElementById('progress-header-text');
    const messagesDiv = document.getElementById('progress-messages');
    const stageInfo = document.getElementById('stage-info');
    const currentStageSpan = document.getElementById('current-stage');
    const summaryCard = document.getElementById('synthesis-summary');

    // Create EventSource for Server-Sent Events
    const eventSource = new EventSource(
        `/scenario_pipeline/case/${currentCaseId}/synthesize_streaming`
    );

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Synthesis event:', data);

        // Check for completion
        if (data.complete) {
            eventSource.close();
            synthesisData.endTime = new Date();
            const duration = ((synthesisData.endTime - synthesisData.startTime) / 1000).toFixed(1);

            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');
            progressIcon.className = 'bi bi-check-circle text-success';
            progressHeader.textContent = 'Synthesis Complete';
            stageInfo.style.display = 'none';

            // Show summary
            summaryCard.style.display = 'block';
            const summary = data.summary || {};
            document.getElementById('synthesis-summary-content').innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <strong>Duration:</strong> ${duration} seconds
                    </div>
                    <div class="col-md-3">
                        <strong>Provisions:</strong> ${summary.provisions_count || 0}
                    </div>
                    <div class="col-md-3">
                        <strong>Questions:</strong> ${summary.questions_count || 0}
                    </div>
                    <div class="col-md-3">
                        <strong>Conclusions:</strong> ${summary.conclusions_count || 0}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <strong>Entity Nodes:</strong> ${summary.total_nodes || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Causal Links:</strong> ${summary.total_links || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>LLM Interactions:</strong> ${summary.llm_interactions || 0}
                    </div>
                </div>
            `;

            addMessage('success', `✓ Synthesis completed in ${duration} seconds`);
            addMessage('info', 'Saving results to database...');

            // Save synthesis results to database
            saveSynthesisResults(data).then(() => {
                addMessage('success', '✓ Results saved successfully');

                // Update the status message area
                const statusArea = document.getElementById('synthesis-status-area');
                if (statusArea) {
                    statusArea.innerHTML = `
                        <p class="mb-2">
                            <strong>${summary.provisions_count || 0}</strong> provisions,
                            <strong>${summary.questions_count || 0}</strong> questions,
                            <strong>${summary.conclusions_count || 0}</strong> conclusions extracted.
                            <small class="text-muted">(Re-running will replace these results)</small>
                        </p>
                    `;
                }

                // Add refresh button
                const refreshBtn = document.createElement('button');
                refreshBtn.className = 'btn btn-success btn-sm mt-3';
                refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh to See Results';
                refreshBtn.onclick = () => location.reload();
                messagesDiv.appendChild(refreshBtn);
            }).catch((error) => {
                addMessage('warning', `Warning: Failed to save results - ${error.message}`);
                console.error('Error saving synthesis results:', error);
            });

            return;
        }

        // Check for error
        if (data.error) {
            eventSource.close();
            addMessage('danger', `Error: ${data.error}`);
            progressIcon.className = 'bi bi-exclamation-triangle text-danger';
            progressHeader.textContent = 'Synthesis Failed';
            stageInfo.style.display = 'none';
            return;
        }

        // Update stage info
        if (data.stage) {
            currentStageSpan.textContent = data.stage || 'Processing...';
            if (data.stage && !synthesisData.stages.includes(data.stage)) {
                synthesisData.stages.push(data.stage);
            }
        }

        // Update progress bar
        if (data.progress !== undefined) {
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
        }

        // Add messages
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                addMessage('info', msg);
            });
        }

        // Add errors/warnings
        if (data.errors && data.errors.length > 0) {
            data.errors.forEach(err => {
                addMessage('warning', err);
            });
        }

        // Handle LLM trace data
        if (data.llm_trace && data.llm_trace.length > 0) {
            data.llm_trace.forEach(trace => {
                displayStagePromptResponse(trace);
            });
        }
    };

    eventSource.onerror = function(error) {
        console.error('Synthesis SSE error:', error);
        eventSource.close();
        addMessage('danger', 'Connection error during synthesis');
        progressIcon.className = 'bi bi-exclamation-triangle text-danger';
        progressHeader.textContent = 'Synthesis Failed';
    };
}

function addMessage(type, message) {
    const messagesDiv = document.getElementById('progress-messages');

    // Clear "waiting" message on first real message
    if (messageCount === 0) {
        messagesDiv.innerHTML = '';
    }

    messageCount++;
    document.getElementById('log-count').textContent = `${messageCount} message${messageCount !== 1 ? 's' : ''}`;

    const timestamp = new Date().toLocaleTimeString();
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} mb-2 py-2`;

    let icon = 'bi-arrow-right';
    if (type === 'success') icon = 'bi-check-circle';
    else if (type === 'danger') icon = 'bi-exclamation-triangle';
    else if (type === 'warning') icon = 'bi-exclamation-circle';
    else if (type === 'info') icon = 'bi-info-circle';

    alertDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div><i class="bi ${icon}"></i> ${message}</div>
            <small class="text-muted ms-2" style="white-space: nowrap;">${timestamp}</small>
        </div>
    `;
    messagesDiv.appendChild(alertDiv);

    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function displayStagePromptResponse(trace) {
    const accordionContainer = document.getElementById('synthesis-stages-accordion');

    // Remove placeholder text on first trace
    if (accordionContainer.querySelector('em')) {
        accordionContainer.innerHTML = '';
    }

    // Create unique ID for this stage
    const stageName = trace.stage || 'unknown';
    const stageId = 'stage-' + stageName.replace(/[^a-z0-9]/gi, '-');

    // Check if this stage already exists (avoid duplicates)
    if (document.getElementById(stageId)) {
        return; // Already displayed
    }

    // Create accordion item
    const accordionItem = document.createElement('div');
    accordionItem.className = 'accordion-item';
    accordionItem.id = stageId;

    // Format token info
    let tokenBadge = '';
    if (trace.tokens && trace.tokens.total_tokens) {
        tokenBadge = '<span class="badge bg-info ms-2">' + trace.tokens.total_tokens + ' tokens</span>';
    }

    // Stage header
    const header = document.createElement('h2');
    header.className = 'accordion-header';
    header.innerHTML =
        '<button class="accordion-button collapsed" type="button" ' +
        'data-bs-toggle="collapse" data-bs-target="#collapse-' + stageId + '">' +
        '<i class="bi bi-check-circle text-success me-2"></i>' +
        '<strong>Stage: ' + (trace.stage || 'Unknown') + '</strong>' +
        '<span class="badge bg-secondary ms-2">' + (trace.model || 'Unknown') + '</span>' +
        tokenBadge +
        '</button>';

    // Stage content
    const content = document.createElement('div');
    content.id = 'collapse-' + stageId;
    content.className = 'accordion-collapse collapse';

    let tokenSection = '';
    if (trace.tokens) {
        tokenSection = '<div class="mt-3 p-2 bg-light rounded">' +
            '<small class="text-muted">' +
            '<strong>Token Usage:</strong> ' +
            'Input: ' + trace.tokens.input_tokens + ' | ' +
            'Output: ' + trace.tokens.output_tokens + ' | ' +
            'Total: ' + trace.tokens.total_tokens +
            '</small></div>';
    }

    content.innerHTML =
        '<div class="accordion-body">' +
        '<div class="mb-4">' +
        '<h6 class="text-primary">' +
        '<i class="bi bi-file-text"></i> LLM Prompt ' +
        '<small class="text-muted ms-2">' + (trace.timestamp || '') + '</small>' +
        '</h6>' +
        '<pre class="prompt-display">' + escapeHtml(trace.prompt || 'No prompt available') + '</pre>' +
        '</div>' +
        '<div class="mb-3">' +
        '<h6 class="text-success">' +
        '<i class="bi bi-code-square"></i> LLM Response' +
        '</h6>' +
        '<pre class="response-display">' + escapeHtml(trace.response || 'No response available') + '</pre>' +
        '</div>' +
        tokenSection +
        '</div>';

    accordionItem.appendChild(header);
    accordionItem.appendChild(content);
    accordionContainer.appendChild(accordionItem);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function saveSynthesisResults(data) {
    /**
     * Save Step 4 streaming synthesis results to database for persistence.
     *
     * Sends all LLM traces (prompts + responses) and synthesis results
     * to the backend for storage in ExtractionPrompt table.
     */
    console.log('[Save Debug] Received data:', data);
    console.log('[Save Debug] session_id:', data.session_id);
    console.log('[Save Debug] llm_traces length:', (data.llm_traces || []).length);
    console.log('[Save Debug] synthesis_results:', data.synthesis_results);

    const saveData = {
        session_id: data.session_id,
        llm_traces: data.llm_traces || [],
        synthesis_results: data.synthesis_results || {}
    };

    console.log('[Save Debug] Sending saveData:', saveData);
    console.log('[Save Debug] Questions count:', (saveData.synthesis_results.questions || []).length);
    console.log('[Save Debug] Conclusions count:', (saveData.synthesis_results.conclusions || []).length);

    const response = await fetch(
        `/scenario_pipeline/case/${currentCaseId}/save_streaming_results`,
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(saveData)
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save synthesis results');
    }

    return await response.json();
}

// Load saved synthesis results on page load
{% if saved_synthesis %}
document.addEventListener('DOMContentLoaded', function() {
    // Show progress card with saved results
    const progressCard = document.getElementById('synthesis-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressIcon = document.getElementById('progress-icon');
    const progressHeader = document.getElementById('progress-header-text');
    const stageInfo = document.getElementById('stage-info');
    const messagesDiv = document.getElementById('progress-messages');
    const summaryCard = document.getElementById('synthesis-summary');
    const accordionContainer = document.getElementById('synthesis-stages-accordion');

    // Display the saved synthesis
    progressCard.style.display = 'block';
    progressBar.style.width = '100%';
    progressBar.textContent = '100%';
    progressBar.classList.remove('progress-bar-animated');
    progressBar.classList.add('bg-success');
    progressIcon.className = 'bi bi-check-circle text-success';
    progressHeader.textContent = 'Synthesis Complete (Loaded from Database)';
    stageInfo.style.display = 'none';

    // Show summary
    const summary = {{ saved_synthesis.results_summary | tojson | safe }};
    summaryCard.style.display = 'block';
    document.getElementById('synthesis-summary-content').innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <strong>Provisions:</strong> ${summary.provisions_count || 0}
            </div>
            <div class="col-md-3">
                <strong>Questions:</strong> ${summary.questions_count || 0}
            </div>
            <div class="col-md-3">
                <strong>Conclusions:</strong> ${summary.conclusions_count || 0}
            </div>
            <div class="col-md-3">
                <strong>Entity Nodes:</strong> ${summary.total_nodes || 0}
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <strong>LLM Interactions:</strong> ${summary.llm_interactions || 0}
            </div>
            <div class="col-md-6">
                <strong>Completed:</strong> <span class="local-time" data-utc="{{ saved_synthesis.created_at.strftime('%Y-%m-%dT%H:%M:%SZ') }}" data-format="full">{{ saved_synthesis.created_at.strftime('%Y-%m-%d %H:%M') }} UTC</span>
            </div>
        </div>
    `;

    // Convert any local-time spans that were just added to the DOM
    document.querySelectorAll('.local-time').forEach(function(el) {
        if (el.dataset.utc && !el.dataset.converted) {
            const date = new Date(el.dataset.utc);
            el.textContent = date.toLocaleString();
            el.dataset.converted = 'true';
        }
    });

    // Parse saved prompts and responses
    const savedPromptText = {{ saved_synthesis.prompt_text | tojson | safe }};
    const savedResponseText = {{ saved_synthesis.raw_response | tojson | safe }};

    // Extract stages from the combined prompt/response
    const stages = (summary.stages || []);

    // Display saved LLM traces
    if (stages.length > 0) {
        accordionContainer.innerHTML = ''; // Clear placeholder

        stages.forEach((stageName, index) => {
            const stageMarker = `=== ${stageName} ===`;

            // Extract prompt for this stage
            const promptStartIndex = savedPromptText.indexOf(stageMarker);
            const promptEndIndex = savedPromptText.indexOf('=== ', promptStartIndex + stageMarker.length);
            const stagePrompt = promptStartIndex >= 0
                ? savedPromptText.substring(promptStartIndex + stageMarker.length, promptEndIndex >= 0 ? promptEndIndex : undefined).trim()
                : '';

            // Extract response for this stage
            const responseStartIndex = savedResponseText.indexOf(stageMarker);
            const responseEndIndex = savedResponseText.indexOf('=== ', responseStartIndex + stageMarker.length);
            const stageResponse = responseStartIndex >= 0
                ? savedResponseText.substring(responseStartIndex + stageMarker.length, responseEndIndex >= 0 ? responseEndIndex : undefined).trim()
                : '';

            if (stagePrompt || stageResponse) {
                displayStagePromptResponse({
                    stage: stageName,
                    prompt: stagePrompt,
                    response: stageResponse,
                    model: '{{ saved_synthesis.llm_model }}',
                    timestamp: '{{ saved_synthesis.created_at.strftime('%Y-%m-%d %H:%M:%S') }}'
                });
            }
        });
    }

});
{% endif %}

// ============================================================================
// Complete Four-Phase Synthesis
// ============================================================================

function runCompleteSynthesis() {
    const btn = document.getElementById('run-complete-synthesis-btn');
    const progressText = document.getElementById('synthesis-progress-text');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running Synthesis...';

    // Update phase indicators to show progress
    const phases = [
        { id: 'phase1-indicator', status: 'phase1-status' },
        { id: 'phase2-indicator', status: 'phase2-status' },
        { id: 'phase3-indicator', status: 'phase3-status' },
        { id: 'phase4-indicator', status: 'phase4-status' }
    ];

    function setPhaseActive(phaseIndex) {
        phases.forEach((p, i) => {
            const indicator = document.getElementById(p.id);
            if (indicator) {
                if (i < phaseIndex) {
                    indicator.classList.add('phase-complete');
                    indicator.classList.remove('phase-active');
                } else if (i === phaseIndex) {
                    indicator.classList.add('phase-active');
                    indicator.classList.remove('phase-complete');
                } else {
                    indicator.classList.remove('phase-active', 'phase-complete');
                }
            }
        });
    }

    const phaseMessages = [
        'Phase 1: Building entity foundation...',
        'Phase 2: Loading analytical extraction...',
        'Phase 3: Synthesizing decision points...',
        'Phase 4: Constructing narrative...'
    ];

    let currentPhase = 0;
    setPhaseActive(0);
    progressText.textContent = phaseMessages[0];

    // Animate phases
    const phaseInterval = setInterval(() => {
        currentPhase++;
        if (currentPhase < phases.length) {
            setPhaseActive(currentPhase);
            progressText.textContent = phaseMessages[currentPhase];
        }
    }, 3000);

    // Run complete synthesis with LLM
    fetch(`/scenario_pipeline/case/${currentCaseId}/synthesize_complete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(phaseInterval);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Re-run Synthesis';

        if (data.success) {
            // Mark all phases complete
            phases.forEach(p => {
                const indicator = document.getElementById(p.id);
                if (indicator) {
                    indicator.classList.add('phase-complete');
                    indicator.classList.remove('phase-active');
                }
            });

            progressText.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Synthesis complete!</span>';

            // Update all phase cards with results
            updateSynthesisResults(data);
        } else {
            progressText.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> ${data.error || 'Synthesis failed'}</span>`;
        }
    })
    .catch(err => {
        clearInterval(phaseInterval);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-circle"></i> Run Complete Synthesis';
        progressText.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> ${err.message}</span>`;
        console.error('Synthesis error:', err);
    });
}

function updateSynthesisResults(data) {
    const summary = data.summary;
    const synthesis = data.synthesis;

    // Update Phase 1 status
    const phase1Status = document.getElementById('phase1-status');
    if (phase1Status) {
        phase1Status.textContent = `${summary.entity_foundation.total} entities`;
        phase1Status.className = 'badge bg-success';
    }

    // Update Phase 2 status
    const phase2Status = document.getElementById('phase2-status');
    if (phase2Status) {
        const ae = summary.analytical_extraction;
        phase2Status.textContent = `${ae.provisions + ae.questions + ae.conclusions} elements`;
        phase2Status.className = 'badge bg-success';
    }

    // Update Phase 3 status and results
    const phase3Status = document.getElementById('phase3-status');
    if (phase3Status) {
        const dp = summary.decision_points;
        phase3Status.textContent = `${dp.canonical_count} decision points`;
        phase3Status.className = 'badge bg-success';
    }

    // Show Phase 3 results
    const phase3Results = document.getElementById('phase3-results');
    if (phase3Results) {
        document.getElementById('canonical-count').textContent = summary.decision_points.canonical_count;
        document.getElementById('qc-aligned-count').textContent = summary.decision_points.qc_aligned;
        document.getElementById('algorithmic-count').textContent = summary.decision_points.algorithmic_candidates;
        phase3Results.style.display = 'block';
    }

    // Update Phase 4 status and content
    const phase4Status = document.getElementById('phase4-status');
    if (phase4Status) {
        phase4Status.textContent = `${summary.narrative.timeline_events} events`;
        phase4Status.className = 'badge bg-success';
    }

    // Hide placeholder, show content
    const placeholder = document.getElementById('phase4-placeholder');
    if (placeholder) placeholder.style.display = 'none';

    // Show case summary
    if (synthesis.narrative && synthesis.narrative.case_summary) {
        const summaryArea = document.getElementById('case-summary-area');
        const summaryText = document.getElementById('case-summary-text');
        if (summaryArea && summaryText) {
            summaryText.textContent = synthesis.narrative.case_summary;
            summaryArea.style.display = 'block';
        }
    }

    // Show timeline
    if (synthesis.narrative && synthesis.narrative.timeline) {
        const timelinePreview = document.getElementById('timeline-preview');
        const timelineEvents = document.getElementById('timeline-events');
        if (timelinePreview && timelineEvents) {
            let timelineHtml = '<div class="timeline-container">';
            synthesis.narrative.timeline.forEach(event => {
                const typeClass = event.event_type === 'decision' ? 'bg-primary' :
                                  event.event_type === 'outcome' ? 'bg-success' :
                                  event.event_type === 'action' ? 'bg-info' : 'bg-secondary';
                timelineHtml += `
                    <div class="timeline-item d-flex align-items-start mb-2">
                        <span class="badge ${typeClass} me-2">${event.sequence}</span>
                        <div>
                            <strong>${event.phase_label}</strong>
                            <div class="small text-muted">${event.description.substring(0, 100)}${event.description.length > 100 ? '...' : ''}</div>
                        </div>
                    </div>
                `;
            });
            timelineHtml += '</div>';
            timelineEvents.innerHTML = timelineHtml;
            timelinePreview.style.display = 'block';
        }
    }

    // Show scenario seeds
    if (synthesis.narrative && synthesis.narrative.scenario_seeds) {
        const seedsArea = document.getElementById('scenario-seeds-area');
        const seedsContent = document.getElementById('scenario-seeds-content');
        if (seedsArea && seedsContent) {
            const seeds = synthesis.narrative.scenario_seeds;
            seedsContent.innerHTML = `
                <p class="mb-1"><strong>Protagonist:</strong> ${seeds.protagonist}</p>
                <p class="mb-1"><strong>Setting:</strong> ${seeds.setting}</p>
                <p class="mb-1"><strong>Inciting Incident:</strong> ${seeds.inciting_incident.substring(0, 150)}...</p>
                ${seeds.key_tensions.length > 0 ? `<p class="mb-0"><strong>Key Tensions:</strong> ${seeds.key_tensions.join(', ')}</p>` : ''}
            `;
            seedsArea.style.display = 'block';
        }
    }

    // Show LLM traces in their respective phase cards
    if (synthesis.llm_traces && synthesis.llm_traces.length > 0) {
        // Group traces by phase
        const phase2Traces = synthesis.llm_traces.filter(t => t.phase === 2);
        const phase3Traces = synthesis.llm_traces.filter(t => t.phase === 3);
        const phase4Traces = synthesis.llm_traces.filter(t => t.phase === 4);

        // Populate Phase 2 traces
        if (phase2Traces.length > 0) {
            const phase2Container = document.getElementById('phase2-traces');
            const phase2Accordion = document.getElementById('phase2-traces-accordion');
            if (phase2Container && phase2Accordion) {
                phase2Accordion.innerHTML = `
                    <div class="small text-muted mb-2">
                        <i class="bi bi-file-text"></i> ${phase2Traces.length} LLM interaction(s) - click to expand
                    </div>
                `;
                phase2Traces.forEach((trace, idx) => {
                    phase2Accordion.innerHTML += createTraceAccordionItem(trace, `p2-${idx}`, 'phase2-traces-accordion');
                });
                phase2Container.style.display = 'block';
            }
        }

        // Populate Phase 3 traces
        if (phase3Traces.length > 0) {
            const phase3Container = document.getElementById('phase3-traces');
            const phase3Accordion = document.getElementById('phase3-traces-accordion');
            if (phase3Container && phase3Accordion) {
                phase3Accordion.innerHTML = `
                    <div class="small text-muted mb-2">
                        <i class="bi bi-file-text"></i> ${phase3Traces.length} LLM interaction(s) - click to expand
                    </div>
                `;
                phase3Traces.forEach((trace, idx) => {
                    phase3Accordion.innerHTML += createTraceAccordionItem(trace, `p3-${idx}`, 'phase3-traces-accordion');
                });
                phase3Container.style.display = 'block';
            }
        }

        // Populate Phase 4 traces
        if (phase4Traces.length > 0) {
            const phase4Container = document.getElementById('phase4-traces');
            const phase4Accordion = document.getElementById('phase4-traces-accordion');
            if (phase4Container && phase4Accordion) {
                phase4Accordion.innerHTML = `
                    <div class="small text-muted mb-2">
                        <i class="bi bi-file-text"></i> ${phase4Traces.length} LLM interaction(s) - click to expand
                    </div>
                `;
                phase4Traces.forEach((trace, idx) => {
                    phase4Accordion.innerHTML += createTraceAccordionItem(trace, `p4-${idx}`, 'phase4-traces-accordion');
                });
                phase4Container.style.display = 'block';
            }
        }
    }

    // Populate Phase 2 Rich Analysis
    populateRichAnalysis(synthesis);
}

function populateRichAnalysis(synthesis) {
    const richAnalysisDiv = document.getElementById('phase2-rich-analysis');
    if (!richAnalysisDiv) return;

    // Check if we have rich analysis data
    const hasCausalLinks = synthesis.causal_normative_links && synthesis.causal_normative_links.length > 0;
    const hasQuestionEmergence = synthesis.question_emergence && synthesis.question_emergence.length > 0;
    const hasResolutionPatterns = synthesis.resolution_patterns && synthesis.resolution_patterns.length > 0;

    if (!hasCausalLinks && !hasQuestionEmergence && !hasResolutionPatterns) {
        return;  // No rich analysis data
    }

    // Show the rich analysis section
    richAnalysisDiv.style.display = 'block';

    // Populate Causal-Normative Links
    if (hasCausalLinks) {
        document.getElementById('causal-links-count').textContent = synthesis.causal_normative_links.length;
        const linksContainer = document.getElementById('causal-links-list');
        let linksHtml = '<div class="list-group list-group-flush">';

        synthesis.causal_normative_links.forEach(link => {
            const fulfillsBadges = link.fulfills_obligations.map(o =>
                `<span class="badge bg-success me-1" title="Fulfills">${getUriLabel(o)}</span>`
            ).join('');
            const violatesBadges = link.violates_obligations.map(o =>
                `<span class="badge bg-danger me-1" title="Violates">${getUriLabel(o)}</span>`
            ).join('');
            const principlesBadges = link.guided_by_principles.map(p =>
                `<span class="badge bg-primary me-1" title="Guided by">${getUriLabel(p)}</span>`
            ).join('');

            linksHtml += `
                <div class="list-group-item py-2 px-0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong class="text-info">${link.action_label}</strong>
                            <span class="text-muted small ms-2">(${Math.round(link.confidence * 100)}% confidence)</span>
                        </div>
                    </div>
                    <div class="mt-1">
                        ${fulfillsBadges ? '<span class="text-muted small">Fulfills:</span> ' + fulfillsBadges : ''}
                        ${violatesBadges ? '<span class="text-muted small ms-2">Violates:</span> ' + violatesBadges : ''}
                        ${principlesBadges ? '<span class="text-muted small ms-2">Guided by:</span> ' + principlesBadges : ''}
                    </div>
                    ${link.reasoning ? `<div class="text-muted small mt-1 fst-italic">${link.reasoning}</div>` : ''}
                </div>
            `;
        });

        linksHtml += '</div>';
        linksContainer.innerHTML = linksHtml;
    }

    // Populate Question Emergence
    if (hasQuestionEmergence) {
        document.getElementById('question-emergence-count').textContent = synthesis.question_emergence.length;
        const emergenceContainer = document.getElementById('question-emergence-list');
        let emergenceHtml = '<div class="list-group list-group-flush">';

        synthesis.question_emergence.forEach(qa => {
            const rolesBadges = qa.involves_roles.map(r =>
                `<span class="badge bg-primary me-1">${getUriLabel(r)}</span>`
            ).join('');
            const conflictBadges = qa.competing_obligations.map(pair =>
                `<span class="badge bg-warning text-dark me-1">${getUriLabel(pair[0])} vs ${getUriLabel(pair[1])}</span>`
            ).join('');

            emergenceHtml += `
                <div class="list-group-item py-2 px-0">
                    <div class="fw-bold text-dark">${qa.question_text.substring(0, 150)}${qa.question_text.length > 150 ? '...' : ''}</div>
                    <div class="mt-1">
                        ${rolesBadges ? '<span class="text-muted small">Involves:</span> ' + rolesBadges : ''}
                        ${conflictBadges ? '<span class="text-muted small ms-2">Conflicts:</span> ' + conflictBadges : ''}
                    </div>
                    <div class="text-muted small mt-1 fst-italic">${qa.emergence_narrative}</div>
                </div>
            `;
        });

        emergenceHtml += '</div>';
        emergenceContainer.innerHTML = emergenceHtml;
    }

    // Populate Resolution Patterns
    if (hasResolutionPatterns) {
        document.getElementById('resolution-patterns-count').textContent = synthesis.resolution_patterns.length;
        const patternsContainer = document.getElementById('resolution-patterns-list');
        let patternsHtml = '<div class="list-group list-group-flush">';

        synthesis.resolution_patterns.forEach(rp => {
            const principlesList = rp.determinative_principles.map(p =>
                `<span class="badge bg-purple me-1">${p}</span>`
            ).join('');
            const factsList = rp.determinative_facts.map(f =>
                `<li class="small">${f}</li>`
            ).join('');

            patternsHtml += `
                <div class="list-group-item py-2 px-0">
                    <div class="fw-bold text-success">${rp.conclusion_text.substring(0, 150)}${rp.conclusion_text.length > 150 ? '...' : ''}</div>
                    ${principlesList ? `<div class="mt-1"><span class="text-muted small">Determinative Principles:</span> ${principlesList}</div>` : ''}
                    ${factsList ? `<div class="mt-1"><span class="text-muted small">Key Facts:</span><ul class="mb-0 ps-3">${factsList}</ul></div>` : ''}
                    ${rp.weighing_process ? `<div class="text-muted small mt-1"><strong>Weighing:</strong> ${rp.weighing_process}</div>` : ''}
                    <div class="text-muted small mt-1 fst-italic">${rp.resolution_narrative}</div>
                </div>
            `;
        });

        patternsHtml += '</div>';
        patternsContainer.innerHTML = patternsHtml;
    }
}

function getUriLabel(uri) {
    // Extract label from URI (e.g., "case-7#Obligation_1" -> "Obligation_1")
    if (!uri) return 'Unknown';
    const parts = uri.split('#');
    if (parts.length > 1) {
        return parts[1].replace(/_/g, ' ');
    }
    return uri.split('/').pop().replace(/_/g, ' ');
}

function createTraceAccordionItem(trace, id, parentId) {
    return `
        <div class="accordion-item">
            <h2 class="accordion-header" id="trace-heading-${id}">
                <button class="accordion-button collapsed py-2" type="button"
                        data-bs-toggle="collapse" data-bs-target="#trace-collapse-${id}">
                    <strong class="small">${trace.stage}</strong>
                    <small class="text-muted ms-2">${trace.model}</small>
                </button>
            </h2>
            <div id="trace-collapse-${id}" class="accordion-collapse collapse"
                 data-bs-parent="#${parentId}">
                <div class="accordion-body small">
                    <h6 class="small fw-bold">Prompt:</h6>
                    <pre class="bg-light p-2 small" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-size: 0.75rem;">${escapeHtml(trace.prompt)}</pre>
                    <h6 class="small fw-bold mt-2">Response:</h6>
                    <pre class="bg-light p-2 small" style="max-height: 200px; overflow-y: auto; white-space: pre-wrap; font-size: 0.75rem;">${escapeHtml(trace.response)}</pre>
                </div>
            </div>
        </div>
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Load existing synthesis on page load
function loadExistingSynthesis() {
    fetch(`/scenario_pipeline/case/${currentCaseId}/synthesis_model`)
        .then(response => response.json())
        .then(data => {
            if (data.success && (data.has_synthesis || data.has_rich_analysis)) {
                updateSynthesisResults(data);
                document.getElementById('run-complete-synthesis-btn').innerHTML = '<i class="bi bi-arrow-repeat"></i> Re-run Synthesis';

                // Show info about persisted data
                const progressText = document.getElementById('synthesis-progress-text');
                if (progressText) {
                    const summary = data.summary;
                    const richCount = (summary.rich_analysis?.causal_normative_links || 0) +
                                     (summary.rich_analysis?.question_emergence || 0) +
                                     (summary.rich_analysis?.resolution_patterns || 0);
                    if (richCount > 0) {
                        progressText.textContent = `Loaded from database: ${summary.decision_points?.canonical_count || 0} decision points, ${richCount} rich analysis items`;
                    }
                }
            }
        })
        .catch(err => {
            console.log('No existing synthesis found:', err.message);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    loadExistingSynthesis();
});

// ============================================================================
// Unified Case Synthesis Functions (Legacy - kept for compatibility)
// ============================================================================

function runUnifiedSynthesis() {
    const btn = document.getElementById('run-unified-synthesis-btn');
    const statusBadge = document.getElementById('synthesis-pipeline-status-badge');
    const statusArea = document.getElementById('unified-synthesis-status-area');
    const resultsArea = document.getElementById('unified-synthesis-results');

    // Update pipeline step indicators
    const steps = ['step-s1', 'step-s2', 'step-s3', 'step-s4'];

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Synthesizing...';
    statusBadge.className = 'badge bg-warning text-dark';
    statusBadge.textContent = 'Running...';
    resultsArea.style.display = 'none';

    // Animate steps
    let currentStep = 0;
    const stepMessages = [
        'Loading entities...',
        'Composing decision points (E1-E3)...',
        'LLM refinement with Q&C alignment...',
        'Storing canonical decision points...'
    ];

    function updateStep(step) {
        if (step < steps.length) {
            steps.forEach((s, i) => {
                const badge = document.getElementById(s);
                if (i < step) {
                    badge.className = 'badge bg-success mb-1';
                } else if (i === step) {
                    badge.className = 'badge bg-primary mb-1';
                } else {
                    badge.className = 'badge bg-secondary mb-1';
                }
            });
            statusArea.innerHTML = `<p class="text-primary mb-0"><i class="bi bi-hourglass-split"></i> ${stepMessages[step]}</p>`;
        }
    }

    updateStep(0);
    const stepInterval = setInterval(() => {
        currentStep++;
        if (currentStep < steps.length) {
            updateStep(currentStep);
        }
    }, 2000);

    fetch(`/scenario_pipeline/case/${currentCaseId}/synthesize?generate_arguments=false`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        clearInterval(stepInterval);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Re-run Synthesis';

        if (data.success) {
            // Mark all steps complete
            steps.forEach(s => {
                document.getElementById(s).className = 'badge bg-success mb-1';
            });

            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'Complete';
            statusArea.innerHTML = '<p class="text-success mb-0"><i class="bi bi-check-circle"></i> Synthesis complete!</p>';

            // Show results
            resultsArea.style.display = 'block';
            document.getElementById('canonical-count').textContent = data.count;
            document.getElementById('qc-aligned-count').textContent = data.qc_aligned_count;
            document.getElementById('algorithmic-count').textContent = data.algorithmic_candidates_count;
        } else {
            statusBadge.className = 'badge bg-danger';
            statusBadge.textContent = 'Error';
            statusArea.innerHTML = `<p class="text-danger mb-0"><i class="bi bi-exclamation-triangle"></i> ${data.error || 'Synthesis failed'}</p>`;
        }
    })
    .catch(err => {
        clearInterval(stepInterval);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightning-charge"></i> Synthesize Case';
        statusBadge.className = 'badge bg-danger';
        statusBadge.textContent = 'Error';
        statusArea.innerHTML = `<p class="text-danger mb-0"><i class="bi bi-exclamation-triangle"></i> ${err.message}</p>`;
        console.error('Synthesis error:', err);
    });
}

// Check for existing canonical decision points on page load
function checkExistingSynthesis() {
    fetch(`/scenario_pipeline/case/${currentCaseId}/canonical_decision_points`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.count > 0) {
                const statusBadge = document.getElementById('synthesis-pipeline-status-badge');
                const statusArea = document.getElementById('unified-synthesis-status-area');
                const resultsArea = document.getElementById('unified-synthesis-results');
                const btn = document.getElementById('run-unified-synthesis-btn');
                const steps = ['step-s1', 'step-s2', 'step-s3', 'step-s4'];

                // Mark all steps complete
                steps.forEach(s => {
                    document.getElementById(s).className = 'badge bg-success mb-1';
                });

                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Complete';
                statusArea.innerHTML = '<p class="text-success mb-0"><i class="bi bi-check-circle"></i> Synthesis results loaded from database.</p>';
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Re-run Synthesis';

                // Show results
                resultsArea.style.display = 'block';
                document.getElementById('canonical-count').textContent = data.count;
                document.getElementById('qc-aligned-count').textContent = data.qc_aligned_count;
                document.getElementById('algorithmic-count').textContent = data.count; // approximation
            }
        })
        .catch(err => {
            console.log('No existing synthesis found:', err.message);
        });
}

// Load existing synthesis on page ready
document.addEventListener('DOMContentLoaded', function() {
    checkExistingSynthesis();
});

// ============================================================================
// Argument Pipeline Functions (F1-F3) - Legacy, use Unified Synthesis instead
// ============================================================================

function runArgumentPipeline() {
    const btn = document.getElementById('run-args-pipeline-btn');
    const statusBadge = document.getElementById('args-pipeline-status-badge');
    const statusArea = document.getElementById('args-pipeline-status-area');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    statusBadge.className = 'badge bg-warning';
    statusBadge.textContent = 'Running...';
    statusArea.innerHTML = '<p class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Running F1-F3 pipeline...</p>';

    fetch(`/scenario_pipeline/case/${currentCaseId}/entity_arguments`)
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Re-run';

            if (data.success) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Complete';

                const summary = data.pipeline_summary;
                statusArea.innerHTML = `
                    <p class="text-success mb-2">
                        <i class="bi bi-check-circle"></i> Generated <strong>${summary.total_arguments}</strong> arguments
                        (${summary.pro_arguments} pro, ${summary.con_arguments} con),
                        <strong>${summary.valid_arguments}</strong> valid.
                    </p>
                    <a href="/scenario_pipeline/case/${currentCaseId}/step4/review#arguments" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> View Arguments on Review Page
                    </a>
                `;
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'Error';
                statusArea.innerHTML = `<p class="text-danger mb-0"><i class="bi bi-exclamation-triangle"></i> ${data.error || 'Pipeline failed'}</p>`;
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-lightning-charge"></i> Generate Arguments';
            statusBadge.className = 'badge bg-danger';
            statusBadge.textContent = 'Error';
            statusArea.innerHTML = `<p class="text-danger mb-0"><i class="bi bi-exclamation-triangle"></i> ${err.message}</p>`;
            console.error('Pipeline error:', err);
        });
}

</script>
{% endblock %}

{% block step_styles %}
<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .card-header h5 {
        margin-bottom: 0;
    }

    .list-unstyled li {
        padding: 0.25rem 0;
    }

    #progress-messages {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Phase Indicator Styles */
    .phase-indicator {
        padding: 1rem;
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

    .phase-indicator .phase-number {
        display: inline-block;
        width: 40px;
        height: 40px;
        line-height: 40px;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        font-weight: bold;
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
    }

    .phase-indicator .phase-label {
        font-weight: 600;
        color: #333;
    }

    .phase-indicator.phase-active {
        background-color: #e7f1ff;
    }

    .phase-indicator.phase-active .phase-number {
        background-color: #0d6efd;
        animation: pulse 1.5s infinite;
    }

    .phase-indicator.phase-complete .phase-number {
        background-color: #198754;
    }

    .phase-indicator.phase-complete .phase-label {
        color: #198754;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(13, 110, 253, 0); }
        100% { box-shadow: 0 0 0 0 rgba(13, 110, 253, 0); }
    }

    /* Timeline Styles */
    .timeline-container {
        border-left: 2px solid #dee2e6;
        padding-left: 1rem;
        margin-left: 0.5rem;
    }

    .timeline-item {
        position: relative;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.35rem;
        top: 0.5rem;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #6c757d;
    }

    /* Purple badge for principles */
    .bg-purple {
        background-color: #6f42c1 !important;
        color: white;
    }

    /* Prompt and Response Display Styles */
    .prompt-display, .response-display {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 0.85rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        max-height: 600px;
        min-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.5;
        margin: 0;
    }

    .response-display {
        background-color: #e8f4fd;
        border-color: #0d6efd;
    }

    #synthesis-stages-accordion .accordion-item {
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
    }

    #synthesis-stages-accordion .accordion-button {
        font-size: 1rem;
        padding: 1rem;
    }

    #synthesis-stages-accordion .accordion-button:not(.collapsed) {
        background-color: #e7f1ff;
        color: #004085;
    }

    #synthesis-stages-accordion .accordion-body {
        max-height: none;
        padding: 1.5rem;
    }
</style>
{% endblock %}
