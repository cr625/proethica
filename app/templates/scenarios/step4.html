{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 4: Case Synthesis{% endblock %}
{% block step_header %}Step 4: Case Synthesis{% endblock %}
{% block step_subtitle %}Build a coherent case model from extracted entities{% endblock %}

{% block step_content %}

<!-- Synthesis Pipeline Overview -->
<div class="card mb-4 border-primary">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3-fill"></i> Four-Phase Synthesis Pipeline
        </h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div id="phase1-indicator" class="phase-indicator phase-complete">
                    <span class="phase-number">1</span>
                    <div class="phase-label">Entity Foundation</div>
                    <small class="text-muted">Passes 1-3 entities</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase2-indicator" class="phase-indicator">
                    <span class="phase-number">2</span>
                    <div class="phase-label">Analytical Extraction</div>
                    <small class="text-muted">Provisions, Q&C, Rich Analysis</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase3-indicator" class="phase-indicator">
                    <span class="phase-number">3</span>
                    <div class="phase-label">Decision Synthesis</div>
                    <small class="text-muted">E1-E3 + LLM</small>
                </div>
            </div>
            <div class="col-md-3">
                <div id="phase4-indicator" class="phase-indicator">
                    <span class="phase-number">4</span>
                    <div class="phase-label">Narrative</div>
                    <small class="text-muted">Timeline + Scenario</small>
                </div>
            </div>
        </div>

        <hr>

        <div class="text-center">
            {% if current_user.is_authenticated %}
            <button type="button" id="run-complete-synthesis-btn" class="btn btn-primary btn-lg" onclick="runCompleteSynthesis()">
                <i class="bi bi-play-circle"></i> Run Complete Synthesis
            </button>
            <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-outline-secondary btn-lg ms-2">
                <i class="bi bi-eye"></i> Review Results
            </a>
            <button type="button" id="clear-step4-btn" class="btn btn-outline-danger btn-lg ms-2" onclick="clearStep4Data()">
                <i class="bi bi-trash"></i> Clear Step 4
            </button>
            {% else %}
            <button type="button" class="btn btn-secondary btn-lg" onclick="window.location.href='{{ url_for('auth.login') }}';">
                <i class="bi bi-lock-fill"></i> Login to Run Synthesis
            </button>
            {% endif %}
            <div id="synthesis-progress-text" class="mt-2 text-muted"></div>
        </div>
    </div>
</div>

<!-- Phase 1: Entity Foundation (Display only - no extraction) -->
<div class="card mb-4" id="phase1-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <span class="badge bg-success me-2">Phase 1</span> Entity Foundation
        </h5>
        <span id="phase1-status" class="badge bg-success">{{ entities_summary.total }} entities</span>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <h6 class="text-muted">Pass 1: Contextual Framework</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-primary me-1">{{ entities_summary.roles }}</span> Roles</li>
                    <li><span class="badge bg-info me-1">{{ entities_summary.states }}</span> States</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.resources }}</span> Resources</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Pass 2: Normative Requirements</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-purple me-1">{{ entities_summary.principles }}</span> Principles</li>
                    <li><span class="badge bg-warning text-dark me-1">{{ entities_summary.obligations }}</span> Obligations</li>
                    <li><span class="badge bg-danger me-1">{{ entities_summary.constraints }}</span> Constraints</li>
                    <li><span class="badge bg-success me-1">{{ entities_summary.capabilities }}</span> Capabilities</li>
                </ul>
            </div>
            <div class="col-md-4">
                <h6 class="text-muted">Pass 3: Temporal Dynamics</h6>
                <ul class="list-unstyled">
                    <li><span class="badge bg-dark me-1">{{ entities_summary.actions }}</span> Actions</li>
                    <li><span class="badge bg-secondary me-1">{{ entities_summary.events }}</span> Events</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Phase 2: Analytical Extraction - Individual Tasks -->
<div class="card mb-4" id="phase2-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 2</span> Analytical Extraction
        </h5>
    </div>
    <div class="card-body">
        <!-- 2A: Code Provisions -->
        <div class="extractor-section mb-4" id="provisionsSection">
            <div class="step-card border-secondary">
                <div class="step-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-file-text text-secondary"></i> 2A: Code Provisions Extraction
                            <span id="provisionsCount" class="badge bg-secondary ms-2">{{ synthesis_status.provisions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="extractTask('provisions')" id="extractProvisionsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="provisionsPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="provisionsPromptText"></div>
                    </div>
                    <div class="results-preview" id="provisionsResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="provisionsResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2B: Questions -->
        <div class="extractor-section mb-4" id="questionsSection">
            <div class="step-card border-warning">
                <div class="step-header bg-warning bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-question-circle text-warning"></i> 2B: Ethical Questions Extraction
                            <span id="questionsCount" class="badge bg-warning text-dark ms-2">{{ synthesis_status.questions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-warning btn-sm" onclick="extractTask('questions')" id="extractQuestionsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="questionsPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="questionsPromptText"></div>
                    </div>
                    <div class="results-preview" id="questionsResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="questionsResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2C: Conclusions -->
        <div class="extractor-section mb-4" id="conclusionsSection">
            <div class="step-card border-success">
                <div class="step-header bg-success bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-check-circle text-success"></i> 2C: Board Conclusions Extraction
                            <span id="conclusionsCount" class="badge bg-success ms-2">{{ synthesis_status.conclusions_count or 0 }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-success btn-sm" onclick="extractTask('conclusions')" id="extractConclusionsBtn">
                            <i class="bi bi-play-fill"></i> Extract
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="conclusionsPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="conclusionsPromptText"></div>
                    </div>
                    <div class="results-preview" id="conclusionsResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="conclusionsResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2D: Transformation Classification -->
        <div class="extractor-section mb-4" id="transformationSection">
            <div class="step-card border-purple">
                <div class="step-header bg-purple bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-shuffle text-purple"></i> 2D: Transformation Classification
                            <span id="transformationType" class="badge bg-purple ms-2">{{ synthesis_status.transformation_type or 'Not classified' }}</span>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="extractTask('transformation')" id="extractTransformationBtn">
                            <i class="bi bi-play-fill"></i> Classify
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="transformationPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="transformationPromptText"></div>
                    </div>
                    <div class="results-preview" id="transformationResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="transformationResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2E: Rich Analysis -->
        <div class="extractor-section mb-4" id="rich_analysisSection">
            <div class="step-card border-info">
                <div class="step-header bg-info bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-diagram-3 text-info"></i> 2E: Rich Analysis
                            <small class="text-muted">(Causal Links, Question Emergence, Resolution Patterns)</small>
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-info btn-sm" onclick="extractTask('rich_analysis')" id="extractRich_analysisBtn">
                            <i class="bi bi-play-fill"></i> Analyze
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <div class="prompt-preview mb-3" id="rich_analysisPromptSection" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompts (3 analyses)</h6>
                        </div>
                        <div class="prompt-text" id="rich_analysisPromptText"></div>
                    </div>
                    <div class="results-preview" id="rich_analysisResults" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Responses</h6>
                        </div>
                        <div id="rich_analysisResultsContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 3: Decision Point Synthesis -->
<div class="card mb-4" id="phase3-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 3</span> Decision Point Synthesis
            <a href="{{ url_for('tools.references') }}#phase3" class="text-muted ms-2" title="Reference: Toulmin (1958), Harris et al. (2018)">
                <i class="bi bi-info-circle"></i>
            </a>
        </h5>
    </div>
    <div class="card-body">
        <div class="extractor-section" id="decisionSynthesisSection">
            <div class="step-card border-primary">
                <div class="step-header bg-primary bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-bullseye text-primary"></i> Decision Point Synthesis (E1-E3 + Q&C Alignment + LLM)
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-primary btn-sm" onclick="runPhase3Synthesis()" id="extractDecisionSynthesisBtn">
                            <i class="bi bi-play-fill"></i> Synthesize
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <p class="text-muted small mb-3">
                        Composes decision points algorithmically (E1-E3), scores against Q&C using Toulmin analysis, then refines via LLM.
                    </p>

                    <!-- Synthesis Pipeline Stages -->
                    <div class="row text-center small mb-3" id="algorithmicSteps">
                        <div class="col border-end">
                            <span id="step-e1" class="badge bg-secondary mb-1">E1</span><br>
                            <small>Obligation Coverage</small><br>
                            <span id="e1Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-e2" class="badge bg-secondary mb-1">E2</span><br>
                            <small>Action Mapping</small><br>
                            <span id="e2Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-e3" class="badge bg-secondary mb-1">E3</span><br>
                            <small>Composition</small><br>
                            <span id="e3Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-align" class="badge bg-secondary mb-1">Q&C</span><br>
                            <small>Alignment</small><br>
                            <span id="alignResult" class="text-muted">-</span>
                        </div>
                        <div class="col">
                            <span id="step-llm" class="badge bg-secondary mb-1">LLM</span><br>
                            <small>Refinement</small><br>
                            <span id="llmResult" class="text-muted">-</span>
                        </div>
                    </div>

                    <!-- Streaming Progress (blue box like other phases) -->
                    <div class="prompt-preview mb-3" id="decisionSynthesisPromptSection" style="display: none;">
                        <div class="prompt-text" id="decisionSynthesisPromptText"></div>
                    </div>

                    <!-- Decision Points Results -->
                    <div id="decisionPointsResults" style="display: none;">
                        <h6 class="mt-3"><i class="bi bi-diagram-3 text-success"></i> Decision Points</h6>
                        <div id="decisionPointsList" class="mb-3"></div>
                    </div>

                    <!-- LLM Prompt (collapsible) -->
                    <div class="accordion mb-3" id="phase3LLMAccordion" style="display: none;">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#phase3PromptCollapse">
                                    <i class="bi bi-cpu me-2"></i> LLM Prompt (Refinement)
                                </button>
                            </h2>
                            <div id="phase3PromptCollapse" class="accordion-collapse collapse" data-bs-parent="#phase3LLMAccordion">
                                <div class="accordion-body p-2">
                                    <pre id="phase3PromptContent" class="small mb-0" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem;"></pre>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#phase3ResponseCollapse">
                                    <i class="bi bi-chat-left-text text-success me-2"></i> LLM Response
                                </button>
                            </h2>
                            <div id="phase3ResponseCollapse" class="accordion-collapse collapse" data-bs-parent="#phase3LLMAccordion">
                                <div class="accordion-body p-2">
                                    <pre id="phase3ResponseContent" class="small mb-0" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem;"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Phase 4: Narrative Construction -->
<div class="card mb-4" id="phase4-card">
    <div class="card-header">
        <h5 class="mb-0">
            <span class="badge bg-secondary me-2">Phase 4</span> Narrative Construction
            <a href="{{ url_for('tools.references') }}#phase4" class="text-muted ms-2" title="Reference: Berreby et al. (2017)">
                <i class="bi bi-info-circle"></i>
            </a>
        </h5>
    </div>
    <div class="card-body">
        <div class="extractor-section" id="narrativeSection">
            <div class="step-card border-dark">
                <div class="step-header bg-dark bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-book text-dark"></i> Narrative Construction (Event Calculus + Scenario Seeds)
                        </h6>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-dark btn-sm" onclick="runPhase4Narrative()" id="extractNarrativeBtn">
                            <i class="bi bi-play-fill"></i> Construct
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <p class="text-muted small mb-3">
                        Transforms entities into narrative elements using Berreby's Event Calculus framework, then generates scenario seeds for Step 5.
                    </p>

                    <!-- Phase 4 Pipeline Stages -->
                    <div class="row text-center small mb-3" id="phase4Steps">
                        <div class="col border-end">
                            <span id="step-4-1" class="badge bg-secondary mb-1">4.1</span><br>
                            <small>Narrative Elements</small><br>
                            <span id="stage41Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-4-2" class="badge bg-secondary mb-1">4.2</span><br>
                            <small>Timeline</small><br>
                            <span id="stage42Result" class="text-muted">-</span>
                        </div>
                        <div class="col border-end">
                            <span id="step-4-3" class="badge bg-secondary mb-1">4.3</span><br>
                            <small>Scenario Seeds</small><br>
                            <span id="stage43Result" class="text-muted">-</span>
                        </div>
                        <div class="col">
                            <span id="step-4-4" class="badge bg-secondary mb-1">4.4</span><br>
                            <small>Insights</small><br>
                            <span id="stage44Result" class="text-muted">-</span>
                        </div>
                    </div>

                    <!-- Streaming Progress -->
                    <div class="prompt-preview mb-3" id="narrativePromptSection" style="display: none;">
                        <div class="prompt-text" id="narrativePromptText"></div>
                    </div>

                    <!-- Phase 4 Results -->
                    <div id="phase4Results" style="display: none;">
                        <!-- Narrative Elements Summary -->
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <h6 class="mb-0"><i class="bi bi-people text-primary me-1"></i> Narrative Elements</h6>
                            </div>
                            <div class="card-body py-2">
                                <div class="row small">
                                    <div class="col-md-6">
                                        <strong>Characters:</strong> <span id="phase4Characters">-</span><br>
                                        <strong>Events:</strong> <span id="phase4Events">-</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Conflicts:</strong> <span id="phase4Conflicts">-</span><br>
                                        <strong>Decision Moments:</strong> <span id="phase4Decisions">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Timeline Preview -->
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <h6 class="mb-0"><i class="bi bi-clock-history text-success me-1"></i> Event Calculus Timeline</h6>
                            </div>
                            <div class="card-body py-2">
                                <pre id="phase4TimelinePreview" class="small mb-0" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem;"></pre>
                            </div>
                        </div>

                        <!-- Scenario Opening -->
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <h6 class="mb-0"><i class="bi bi-play-circle text-warning me-1"></i> Scenario Opening</h6>
                            </div>
                            <div class="card-body py-2">
                                <p id="phase4OpeningContext" class="mb-0 fst-italic"></p>
                            </div>
                        </div>

                        <!-- Key Takeaways -->
                        <div class="card mb-3">
                            <div class="card-header py-2 bg-light">
                                <h6 class="mb-0"><i class="bi bi-lightbulb text-info me-1"></i> Key Takeaways</h6>
                            </div>
                            <div class="card-body py-2">
                                <ul id="phase4Takeaways" class="mb-0 small"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation to review page -->
<div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
    <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-primary btn-lg">
        <i class="bi bi-eye"></i> Review Step 4 Results
    </a>
</div>

{% endblock %}

{% block step_styles %}
<style>
    .phase-indicator {
        padding: 1rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    .phase-indicator.phase-complete {
        background-color: #d4edda;
        border: 2px solid #28a745;
    }

    .phase-indicator.phase-active {
        background-color: #cce5ff;
        border: 2px solid #007bff;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }

    .phase-number {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        line-height: 2rem;
        text-align: center;
        border-radius: 50%;
        background-color: #6c757d;
        color: white;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .phase-complete .phase-number {
        background-color: #28a745;
    }

    .phase-active .phase-number {
        background-color: #007bff;
    }

    .extractor-section .step-card {
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .extractor-section .step-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
    }

    .extractor-section .step-content {
        padding: 1rem;
    }

    .prompt-preview {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .prompt-text {
        font-size: 0.9rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .prompt-text-content {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: white;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
        max-height: 400px;
        overflow-y: auto;
    }

    .results-preview {
        background-color: #f0fff4;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #d4edda;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .text-purple {
        color: #6f42c1 !important;
    }

    .border-purple {
        border-color: #6f42c1 !important;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
const currentCaseId = {{ case.id }};

function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// Clear Step 4 data (Phase 2-4 extractions)
function clearStep4Data() {
    if (!confirm('Clear all Step 4 extractions (provisions, questions, conclusions, decision points)? Phase 1 entities will be preserved.')) {
        return;
    }

    const button = document.getElementById('clear-step4-btn');
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Clearing...';

    fetch(`/scenario_pipeline/case/${currentCaseId}/clear_step4`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reset all UI elements
            resetStep4UI();
            document.getElementById('synthesis-progress-text').textContent = data.message || 'Step 4 cleared successfully';
        } else {
            alert('Error: ' + (data.error || 'Failed to clear'));
        }
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash"></i> Clear Step 4';
    })
    .catch(error => {
        console.error('Clear error:', error);
        alert('Error clearing Step 4 data');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-trash"></i> Clear Step 4';
    });
}

// Reset Step 4 UI to initial state
function resetStep4UI() {
    // Reset phase indicators
    ['phase2-indicator', 'phase3-indicator', 'phase4-indicator'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('phase-complete', 'phase-active');
        }
    });

    // Reset counts
    ['provisionsCount', 'questionsCount', 'conclusionsCount'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '0';
    });

    // Reset Phase 3 stage badges
    ['step-e1', 'step-e2', 'step-e3', 'step-align', 'step-llm'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['e1Result', 'e2Result', 'e3Result', 'alignResult', 'llmResult'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide prompt/result sections
    document.querySelectorAll('.prompt-preview, .results-preview').forEach(el => {
        el.style.display = 'none';
    });

    // Hide Phase 3 specific elements
    const decisionResults = document.getElementById('decisionPointsResults');
    if (decisionResults) decisionResults.style.display = 'none';
    const phase3Accordion = document.getElementById('phase3LLMAccordion');
    if (phase3Accordion) phase3Accordion.style.display = 'none';

    // Reset Phase 3 streaming messages
    if (typeof phase3StreamingMessages !== 'undefined') {
        phase3StreamingMessages = [];
    }

    // Reset Phase 4 stage badges
    ['step-4-1', 'step-4-2', 'step-4-3', 'step-4-4'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['stage41Result', 'stage42Result', 'stage43Result', 'stage44Result'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide Phase 4 results
    const phase4Results = document.getElementById('phase4Results');
    if (phase4Results) phase4Results.style.display = 'none';

    // Reset Phase 4 streaming messages
    if (typeof phase4StreamingMessages !== 'undefined') {
        phase4StreamingMessages = [];
    }

    // Reset synthesis button
    const synthBtn = document.getElementById('run-complete-synthesis-btn');
    if (synthBtn) {
        synthBtn.classList.remove('btn-success');
        synthBtn.classList.add('btn-primary');
        synthBtn.innerHTML = '<i class="bi bi-play-circle"></i> Run Complete Synthesis';
    }

    // Reset all Phase 2 buttons to their original state
    const phase2Buttons = [
        { id: 'extractProvisionsBtn', color: 'secondary', label: 'Extract' },
        { id: 'extractQuestionsBtn', color: 'warning', label: 'Extract' },
        { id: 'extractConclusionsBtn', color: 'success', label: 'Extract' },
        { id: 'extractTransformationBtn', color: 'secondary', label: 'Classify' },
        { id: 'extractRich_analysisBtn', color: 'info', label: 'Analyze' }
    ];
    phase2Buttons.forEach(({ id, color, label }) => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = false;
            btn.classList.remove('btn-outline-secondary', 'btn-success', 'btn-outline-success');
            btn.classList.add(`btn-outline-${color}`);
            btn.innerHTML = `<i class="bi bi-play-fill"></i> ${label}`;
        }
    });

    // Reset Phase 3 button
    const phase3Btn = document.getElementById('extractDecisionSynthesisBtn');
    if (phase3Btn) {
        phase3Btn.disabled = false;
        phase3Btn.classList.remove('btn-success', 'btn-outline-success', 'btn-outline-secondary');
        phase3Btn.classList.add('btn-outline-primary');
        phase3Btn.innerHTML = '<i class="bi bi-play-fill"></i> Synthesize';
    }

    // Reset Phase 4 button
    const phase4Btn = document.getElementById('extractNarrativeBtn');
    if (phase4Btn) {
        phase4Btn.disabled = false;
        phase4Btn.classList.remove('btn-outline-secondary', 'btn-success', 'btn-outline-success');
        phase4Btn.classList.add('btn-outline-dark');
        phase4Btn.innerHTML = '<i class="bi bi-play-fill"></i> Construct';
    }

    // Reset transformation type badge
    const transformType = document.getElementById('transformationType');
    if (transformType) transformType.textContent = 'Not classified';

    // Reset streaming message trackers
    Object.keys(streamingMessages).forEach(key => {
        streamingMessages[key] = [];
    });
}

// Individual task extraction
function extractTask(taskType) {
    const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
    const promptSection = document.getElementById(`${taskType}PromptSection`);
    const resultsSection = document.getElementById(`${taskType}Results`);
    const promptText = document.getElementById(`${taskType}PromptText`);
    const resultsContent = document.getElementById(`${taskType}ResultsContent`);

    // Use streaming for provisions, questions, conclusions, transformation, and rich_analysis (shows real-time progress)
    if (taskType === 'provisions' || taskType === 'questions' || taskType === 'conclusions' || taskType === 'transformation' || taskType === 'rich_analysis') {
        extractTaskStreaming(taskType, button, promptSection, resultsSection, promptText, resultsContent);
        return;
    }

    // Map task types to endpoints (non-streaming)
    const endpoints = {
        'questions': 'extract_questions',
        'conclusions': 'extract_conclusions',
        'transformation': 'extract_transformation',
        'rich_analysis': 'extract_rich_analysis',
        'decision_synthesis': 'extract_decision_synthesis',
        'narrative': 'extract_narrative'
    };

    const endpoint = endpoints[taskType];
    if (!endpoint) {
        console.error('Unknown task type:', taskType);
        return;
    }

    // Disable button and show loading
    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    }

    // Clear previous results and show prompt section with loading
    if (promptSection) {
        promptSection.style.display = 'block';
        if (promptText) {
            promptText.innerHTML = '<div class="text-center text-muted"><i class="bi bi-hourglass-split"></i> Generating prompt...</div>';
        }
    }

    // Clear previous response
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
    if (resultsContent) {
        resultsContent.innerHTML = '';
    }

    fetch(`/scenario_pipeline/case/${currentCaseId}/${endpoint}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display status messages + prompt
            if (promptText) {
                let promptHtml = '';

                // Show status messages if available
                if (data.status_messages && data.status_messages.length > 0) {
                    promptHtml += '<div class="alert alert-info mb-3 py-2"><strong>Extraction Results:</strong><ul class="mb-0 mt-1 small">';
                    data.status_messages.forEach(msg => {
                        promptHtml += `<li>${escapeHtml(msg)}</li>`;
                    });
                    promptHtml += '</ul></div>';
                }

                // Show the prompt
                if (data.prompt) {
                    promptHtml += `<div class="prompt-text-content">${escapeHtml(data.prompt)}</div>`;
                }

                promptText.innerHTML = promptHtml;
            }

            // Display response
            if (resultsSection && resultsContent) {
                resultsSection.style.display = 'block';

                if (data.raw_llm_response) {
                    resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.raw_llm_response)}</pre>`;
                }

                // Handle task-specific results
                handleTaskResults(taskType, data);
            }

            // Update counts if available
            updateCountBadges(taskType, data.result);

            // Re-enable button with Re-run label
            if (button) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                button.classList.remove('btn-outline-' + getButtonColor(taskType));
                button.classList.add('btn-outline-secondary');
            }
        } else {
            throw new Error(data.error || 'Extraction failed');
        }
    })
    .catch(error => {
        console.error('Extraction error:', error);
        if (promptText) {
            promptText.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Retry';
        }
    });
}

function handleTaskResults(taskType, data) {
    switch(taskType) {
        case 'rich_analysis':
            handleRichAnalysisResults(data);
            break;
        case 'decision_synthesis':
            handleDecisionSynthesisResults(data);
            break;
        case 'narrative':
            handleNarrativeResults(data);
            break;
    }
}

function handleRichAnalysisResults(data) {
    // Display LLM traces (now handled by streaming, but keep for non-streaming fallback)
    if (data.llm_traces && data.llm_traces.length > 0) {
        const promptSection = document.getElementById('rich_analysisPromptSection');
        const promptText = document.getElementById('rich_analysisPromptText');
        const resultsSection = document.getElementById('rich_analysisResults');
        const resultsContent = document.getElementById('rich_analysisResultsContent');

        if (promptSection) promptSection.style.display = 'block';
        if (resultsSection) resultsSection.style.display = 'block';

        // Combine prompts and responses
        if (promptText) {
            promptText.innerHTML = data.llm_traces.map((trace, i) =>
                `<h6 class="mt-2">${trace.stage}</h6><pre style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">${escapeHtml(trace.prompt)}</pre>`
            ).join('');
        }

        if (resultsContent) {
            resultsContent.innerHTML = data.llm_traces.map((trace, i) =>
                `<h6 class="mt-2">${trace.stage}</h6><pre style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">${escapeHtml(trace.response)}</pre>`
            ).join('');
        }
    }
}

function handleDecisionSynthesisResults(data) {
    if (data.result) {
        document.getElementById('e1Result').textContent = data.result.e1_decision_relevant + ' decision-relevant';
        document.getElementById('e2Result').textContent = data.result.e2_action_sets + ' action sets';
        document.getElementById('e3Result').textContent = data.result.e3_candidates + ' candidates';
        document.getElementById('llmResult').textContent = data.result.canonical_count + ' decision pts';

        // Update step badges to success
        ['step-e1', 'step-e2', 'step-e3', 'step-llm'].forEach(id => {
            document.getElementById(id).classList.remove('bg-secondary');
            document.getElementById(id).classList.add('bg-success');
        });
    }

    if (data.llm_trace) {
        document.getElementById('decisionSynthesisPromptSection').style.display = 'block';
        document.getElementById('decisionSynthesisPromptText').textContent = data.llm_trace.prompt;
        document.getElementById('decisionSynthesisResultsContent').innerHTML =
            `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.llm_trace.response)}</pre>`;
    }
}

function handleNarrativeResults(data) {
    if (data.narrative) {
        if (data.narrative.case_summary) {
            document.getElementById('case-summary-area').style.display = 'block';
            document.getElementById('case-summary-text').textContent = data.narrative.case_summary;
        }

        if (data.narrative.timeline && data.narrative.timeline.length > 0) {
            document.getElementById('timeline-preview').style.display = 'block';
            document.getElementById('timeline-events').innerHTML = data.narrative.timeline.map(e =>
                `<div class="d-flex mb-2">
                    <span class="badge bg-secondary me-2">${e.sequence}</span>
                    <span><strong>${e.phase_label}:</strong> ${e.description}</span>
                </div>`
            ).join('');
        }
    }

    if (data.llm_trace) {
        document.getElementById('narrativePromptSection').style.display = 'block';
        document.getElementById('narrativePromptText').textContent = data.llm_trace.prompt;
        document.getElementById('narrativeResultsContent').innerHTML =
            `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.llm_trace.response)}</pre>`;
    }
}

function updateCountBadges(taskType, result) {
    if (!result) return;

    switch(taskType) {
        case 'provisions':
            document.getElementById('provisionsCount').textContent = result.count || 0;
            break;
        case 'questions':
            document.getElementById('questionsCount').textContent = result.count || 0;
            break;
        case 'conclusions':
            document.getElementById('conclusionsCount').textContent = result.count || 0;
            break;
        case 'transformation':
            document.getElementById('transformationType').textContent = result.type || 'classified';
            break;
    }
}

function getButtonColor(taskType) {
    const colors = {
        'provisions': 'secondary',
        'questions': 'warning',
        'conclusions': 'success',
        'transformation': 'secondary',
        'rich_analysis': 'info',
        'decision_synthesis': 'primary',
        'narrative': 'dark'
    };
    return colors[taskType] || 'secondary';
}

function capitalizeFirst(str) {
    // Handle underscored names like rich_analysis -> RichAnalysis
    return str.split('_').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Streaming extraction for provisions (real-time progress)
function extractTaskStreaming(taskType, button, promptSection, resultsSection, promptText, resultsContent) {
    // Reset streaming messages for this task
    streamingMessages[taskType] = [];

    // Disable button and show loading
    if (button) {
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    }

    // Show prompt section with initial message
    if (promptSection) {
        promptSection.style.display = 'block';
        if (promptText) {
            promptText.innerHTML = '<div class="alert alert-info py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Starting extraction...</strong></div>';
        }
    }

    // Clear previous response
    if (resultsSection) {
        resultsSection.style.display = 'none';
    }
    if (resultsContent) {
        resultsContent.innerHTML = '';
    }

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/extract_${taskType}_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    // Re-enable button
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                        button.classList.add('btn-outline-secondary');
                    }
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handleStreamingExtraction(taskType, data, promptText, resultsSection, resultsContent);
                        } catch (e) {
                            console.log('Parse error:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        if (promptText) {
            promptText.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Retry';
        }
    });
}

// Handle streaming extraction data
function handleStreamingExtraction(taskType, data, promptText, resultsSection, resultsContent) {
    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!streamingMessages[taskType].includes(msg)) {
                streamingMessages[taskType].push(msg);
            }
        });
    }

    // Build the display
    if (promptText) {
        let html = '<div class="alert alert-info mb-2 py-2">';
        html += '<strong><i class="bi bi-gear-fill me-1"></i> Processing:</strong>';
        html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

        streamingMessages[taskType].forEach((msg, idx) => {
            const isLatest = idx === streamingMessages[taskType].length - 1;
            html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
                <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-primary' : 'check-circle text-success'} me-1"></i>
                ${escapeHtml(msg)}
            </div>`;
        });

        html += '</div>';

        // Show progress bar
        if (data.progress) {
            html += `<div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
            </div>`;
        }

        html += '</div>';
        promptText.innerHTML = html;

        // Auto-scroll
        const messagesDiv = promptText.querySelector('.streaming-messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }

    // Update count badge on completion
    if (data.stage === 'COMPLETE' && data.result) {
        // Handle task-specific count updates (rich_analysis doesn't have count badges)
        if (taskType !== 'rich_analysis') {
            const countEl = document.getElementById(`${taskType}Count`);
            if (countEl) {
                countEl.textContent = data.result.count || 0;
            }
        }

        // Show final status messages + prompt
        if (promptText) {
            let html = '<div class="alert alert-success mb-2 py-2">';
            html += '<strong><i class="bi bi-check-circle-fill me-1"></i> Extraction Complete:</strong>';
            if (data.status_messages && data.status_messages.length > 0) {
                html += '<ul class="mb-0 mt-1 small">';
                data.status_messages.forEach(msg => {
                    html += `<li>${escapeHtml(msg)}</li>`;
                });
                html += '</ul>';
            }
            html += '</div>';

            // Show the prompt if available
            if (data.prompt) {
                html += `<div class="prompt-text-content">${escapeHtml(data.prompt)}</div>`;
            }

            promptText.innerHTML = html;
        }

        // Show the LLM response if available
        if (data.raw_llm_response && resultsSection && resultsContent) {
            resultsSection.style.display = 'block';
            resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.raw_llm_response)}</pre>`;
        }
    }

    // Handle errors
    if (data.error) {
        if (promptText) {
            promptText.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-1"></i> ${data.messages ? data.messages[0] : 'Error occurred'}</div>`;
        }
    }
}

// Run complete synthesis with SSE streaming for real-time progress
async function runCompleteSynthesis() {
    const button = document.getElementById('run-complete-synthesis-btn');
    const progressText = document.getElementById('synthesis-progress-text');

    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
    progressText.textContent = 'Starting synthesis...';

    // Reset streaming message trackers
    Object.keys(streamingMessages).forEach(key => {
        streamingMessages[key] = [];
    });

    // Show prompt sections for streaming updates
    document.getElementById('provisionsPromptSection').style.display = 'block';
    document.getElementById('provisionsPromptText').innerHTML = '<div class="alert alert-info py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Waiting to start...</strong></div>';

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/synthesize_complete_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    // Streaming complete
                    progressText.textContent = 'Complete! Review your results below.';
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-check-circle"></i> Synthesis Complete';
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-success');
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handleStreamingData(data);
                        } catch (e) {
                            console.log('Parse error for line:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        progressText.textContent = `Error: ${error.message}`;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-circle"></i> Run Complete Synthesis';
    });
}

// Phase 3 streaming messages accumulator
let phase3StreamingMessages = [];

// Run Phase 3 Decision Point Synthesis with SSE streaming
async function runPhase3Synthesis() {
    const button = document.getElementById('extractDecisionSynthesisBtn');
    const promptSection = document.getElementById('decisionSynthesisPromptSection');
    const promptText = document.getElementById('decisionSynthesisPromptText');

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Synthesizing...';

    // Reset streaming messages
    phase3StreamingMessages = [];

    // Show prompt section with initial state
    promptSection.style.display = 'block';
    promptText.innerHTML = '<div class="alert alert-info py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Starting Phase 3 synthesis...</strong></div>';

    // Reset stage badges
    ['step-e1', 'step-e2', 'step-e3', 'step-align', 'step-llm'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['e1Result', 'e2Result', 'e3Result', 'alignResult', 'llmResult'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide previous results
    document.getElementById('decisionPointsResults').style.display = 'none';
    document.getElementById('phase3LLMAccordion').style.display = 'none';

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/synthesize_phase3_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-outline-success');
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handlePhase3StreamingData(data);
                        } catch (e) {
                            console.log('Parse error:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Phase 3 streaming error:', error);
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> Error: ${error.message}</div>`;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-fill"></i> Synthesize';
    });
}

// Handle Phase 3 streaming data with blue box pattern
function handlePhase3StreamingData(data) {
    const promptSection = document.getElementById('decisionSynthesisPromptSection');
    const promptText = document.getElementById('decisionSynthesisPromptText');

    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!phase3StreamingMessages.includes(msg)) {
                phase3StreamingMessages.push(msg);
            }
        });
    }

    // Build streaming messages display (blue box)
    let html = '<div class="alert alert-info mb-2 py-2">';
    html += '<strong><i class="bi bi-gear-fill me-1"></i> Phase 3: Decision Point Synthesis</strong>';
    html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

    phase3StreamingMessages.forEach((msg, idx) => {
        const isLatest = idx === phase3StreamingMessages.length - 1;
        html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
            <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-primary' : 'check-circle text-success'} me-1"></i>
            ${escapeHtml(msg)}
        </div>`;
    });

    html += '</div>';

    // Add progress bar
    if (data.progress) {
        html += `<div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
        </div>`;
    }

    html += '</div>';
    promptText.innerHTML = html;

    // Auto-scroll
    const messagesDiv = promptText.querySelector('.streaming-messages');
    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Update stage badges
    if (data.stage) {
        if (data.stage.includes('E1')) {
            document.getElementById('step-e1').className = 'badge bg-primary mb-1';
            if (data.e1_result) document.getElementById('e1Result').textContent = data.e1_result;
        }
        if (data.stage.includes('E1_DONE')) {
            document.getElementById('step-e1').className = 'badge bg-success mb-1';
        }
        if (data.stage.includes('E2')) {
            document.getElementById('step-e2').className = 'badge bg-primary mb-1';
            if (data.e2_result) document.getElementById('e2Result').textContent = data.e2_result;
        }
        if (data.stage.includes('E2_DONE')) {
            document.getElementById('step-e2').className = 'badge bg-success mb-1';
        }
        if (data.stage.includes('E3')) {
            document.getElementById('step-e3').className = 'badge bg-primary mb-1';
            if (data.e3_result) document.getElementById('e3Result').textContent = data.e3_result;
        }
        if (data.stage.includes('3_1_DONE')) {
            document.getElementById('step-e3').className = 'badge bg-success mb-1';
            // e3_result is sent with this stage
            if (data.e3_result) document.getElementById('e3Result').textContent = data.e3_result;
        }
        if (data.stage.includes('3_2')) {
            document.getElementById('step-align').className = 'badge bg-primary mb-1';
            if (data.alignment_result) document.getElementById('alignResult').textContent = data.alignment_result;
        }
        if (data.stage.includes('3_2_DONE')) {
            document.getElementById('step-align').className = 'badge bg-success mb-1';
        }
        if (data.stage.includes('3_3')) {
            document.getElementById('step-llm').className = 'badge bg-primary mb-1';
            if (data.llm_result) document.getElementById('llmResult').textContent = data.llm_result;
        }
        if (data.stage.includes('3_3_DONE')) {
            document.getElementById('step-llm').className = 'badge bg-success mb-1';
        }
    }

    // Handle completion
    if (data.stage === 'COMPLETE') {
        // Show decision points
        if (data.canonical_decision_points && data.canonical_decision_points.length > 0) {
            const resultsDiv = document.getElementById('decisionPointsResults');
            const listDiv = document.getElementById('decisionPointsList');
            resultsDiv.style.display = 'block';

            let dpHtml = '<div class="list-group">';
            data.canonical_decision_points.forEach((dp, i) => {
                const alignScore = (dp.qc_alignment_score * 100).toFixed(0);
                const alignBadge = dp.qc_alignment_score > 0.5 ? 'bg-success' : 'bg-secondary';
                dpHtml += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${dp.focus_id}: ${escapeHtml(dp.description || '')}</strong>
                                <br><small class="text-muted">${escapeHtml(dp.decision_question || '')}</small>
                            </div>
                            <span class="badge ${alignBadge}">${alignScore}% aligned</span>
                        </div>
                        ${dp.toulmin ? `
                            <div class="mt-2 small">
                                <strong>Toulmin:</strong>
                                <span class="text-muted">DATA: ${escapeHtml(dp.toulmin.data_summary || '-')}</span>
                            </div>
                        ` : ''}
                        ${dp.addresses_questions && dp.addresses_questions.length > 0 ? `
                            <div class="mt-1 small text-primary">
                                Addresses: ${dp.addresses_questions.join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            dpHtml += '</div>';
            listDiv.innerHTML = dpHtml;
        }

        // Show LLM accordion with prompt and response
        if (data.llm_trace) {
            const accordion = document.getElementById('phase3LLMAccordion');
            accordion.style.display = 'block';

            if (data.llm_trace.prompt) {
                document.getElementById('phase3PromptContent').textContent = data.llm_trace.prompt;
            }
            if (data.llm_trace.response) {
                document.getElementById('phase3ResponseContent').textContent = data.llm_trace.response;
            }
        }

        // Update phase indicator
        const phase3Indicator = document.getElementById('phase3-indicator');
        if (phase3Indicator) phase3Indicator.classList.add('phase-complete');

        // Change button to Re-run (in case stream done event doesn't fire)
        const button = document.getElementById('extractDecisionSynthesisBtn');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-outline-success');
        }
    }

    // Handle errors
    if (data.error) {
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> ${data.messages ? data.messages[0] : 'Error'}</div>`;
    }
}

// =============================================================================
// PHASE 4: NARRATIVE CONSTRUCTION
// =============================================================================

// Phase 4 streaming messages accumulator
let phase4StreamingMessages = [];

// Run Phase 4 Narrative Construction with SSE streaming
async function runPhase4Narrative() {
    const button = document.getElementById('extractNarrativeBtn');
    const promptSection = document.getElementById('narrativePromptSection');
    const promptText = document.getElementById('narrativePromptText');

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Constructing...';

    // Reset streaming messages
    phase4StreamingMessages = [];

    // Show prompt section with initial state
    promptSection.style.display = 'block';
    promptText.innerHTML = '<div class="alert alert-secondary py-2"><i class="bi bi-hourglass-split me-1"></i> <strong>Starting Phase 4: Narrative Construction...</strong></div>';

    // Reset stage badges
    ['step-4-1', 'step-4-2', 'step-4-3', 'step-4-4'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) badge.className = 'badge bg-secondary mb-1';
    });
    ['stage41Result', 'stage42Result', 'stage43Result', 'stage44Result'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = '-';
    });

    // Hide previous results
    document.getElementById('phase4Results').style.display = 'none';

    // Use streaming endpoint
    fetch(`/scenario_pipeline/case/${currentCaseId}/construct_phase4_stream`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                    button.classList.remove('btn-outline-dark');
                    button.classList.add('btn-outline-success');
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            handlePhase4StreamingData(data);
                        } catch (e) {
                            console.log('Parse error:', line);
                        }
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Phase 4 streaming error:', error);
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> Error: ${error.message}</div>`;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-fill"></i> Construct';
    });
}

// Handle Phase 4 streaming data
function handlePhase4StreamingData(data) {
    const promptSection = document.getElementById('narrativePromptSection');
    const promptText = document.getElementById('narrativePromptText');

    // Accumulate messages
    if (data.messages) {
        data.messages.forEach(msg => {
            if (!phase4StreamingMessages.includes(msg)) {
                phase4StreamingMessages.push(msg);
            }
        });
    }

    // Build streaming messages display (dark/gray box for Phase 4)
    let html = '<div class="alert alert-secondary mb-2 py-2">';
    html += '<strong><i class="bi bi-book me-1"></i> Phase 4: Narrative Construction</strong>';
    html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

    phase4StreamingMessages.forEach((msg, idx) => {
        const isLatest = idx === phase4StreamingMessages.length - 1;
        html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
            <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-dark' : 'check-circle text-success'} me-1"></i>
            ${escapeHtml(msg)}
        </div>`;
    });

    html += '</div>';

    // Add progress bar
    if (data.progress) {
        html += `<div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar bg-dark progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
        </div>`;
    }

    html += '</div>';
    promptText.innerHTML = html;

    // Auto-scroll
    const messagesDiv = promptText.querySelector('.streaming-messages');
    if (messagesDiv) messagesDiv.scrollTop = messagesDiv.scrollHeight;

    // Update stage badges based on stage
    if (data.stage) {
        if (data.stage.includes('4_1')) {
            document.getElementById('step-4-1').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_1_DONE') && data.stage_4_1_result) {
            document.getElementById('step-4-1').className = 'badge bg-success mb-1';
            const r = data.stage_4_1_result;
            document.getElementById('stage41Result').textContent = `${r.characters || 0} chars`;
        }
        if (data.stage.includes('4_2')) {
            document.getElementById('step-4-2').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_2_DONE') && data.stage_4_2_result) {
            document.getElementById('step-4-2').className = 'badge bg-success mb-1';
            const r = data.stage_4_2_result;
            document.getElementById('stage42Result').textContent = `${r.events_count || 0} events`;
        }
        if (data.stage.includes('4_3')) {
            document.getElementById('step-4-3').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_3_DONE') && data.stage_4_3_result) {
            document.getElementById('step-4-3').className = 'badge bg-success mb-1';
            const r = data.stage_4_3_result;
            document.getElementById('stage43Result').textContent = `${r.branches_count || 0} branches`;
        }
        if (data.stage.includes('4_4')) {
            document.getElementById('step-4-4').className = 'badge bg-dark mb-1';
        }
        if (data.stage.includes('4_4_DONE') && data.stage_4_4_result) {
            document.getElementById('step-4-4').className = 'badge bg-success mb-1';
            const r = data.stage_4_4_result;
            document.getElementById('stage44Result').textContent = `${r.key_takeaways_count || 0} takeaways`;
        }
    }

    // Handle completion
    if (data.stage === 'COMPLETE' && data.result) {
        const resultsDiv = document.getElementById('phase4Results');
        resultsDiv.style.display = 'block';

        // Update narrative elements summary
        if (data.result.summary && data.result.summary.narrative_elements) {
            const ne = data.result.summary.narrative_elements;
            document.getElementById('phase4Characters').textContent = ne.characters || 0;
            document.getElementById('phase4Events').textContent = ne.events || 0;
            document.getElementById('phase4Conflicts').textContent = ne.conflicts || 0;
            document.getElementById('phase4Decisions').textContent = ne.decision_moments || 0;
        }

        // Update timeline preview
        if (data.result.timeline_preview) {
            document.getElementById('phase4TimelinePreview').textContent = data.result.timeline_preview;
        }

        // Update scenario opening
        if (data.result.opening_context) {
            document.getElementById('phase4OpeningContext').textContent = data.result.opening_context;
        }

        // Update key takeaways
        if (data.result.key_takeaways && data.result.key_takeaways.length > 0) {
            const takeawaysUl = document.getElementById('phase4Takeaways');
            takeawaysUl.innerHTML = data.result.key_takeaways.map(t => `<li>${escapeHtml(t)}</li>`).join('');
        }

        // Update phase indicator
        const phase4Indicator = document.getElementById('phase4-indicator');
        if (phase4Indicator) phase4Indicator.classList.add('phase-complete');

        // Change button to Re-run
        const button = document.getElementById('extractNarrativeBtn');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
            button.classList.remove('btn-outline-dark');
            button.classList.add('btn-outline-success');
        }
    }

    // Handle errors
    if (data.error) {
        promptText.innerHTML = `<div class="alert alert-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i> ${data.messages ? data.messages[0] : 'Error'}</div>`;
    }
}

// Handle streaming data updates
function handleStreamingData(data) {
    const progressText = document.getElementById('synthesis-progress-text');

    // Update progress text
    if (data.messages && data.messages.length > 0) {
        progressText.textContent = data.messages[data.messages.length - 1];
    }

    // Update top-level phase indicators (the 1-2-3-4 boxes)
    if (data.stage) {
        if (data.stage === 'PHASE_2_INDICATOR' || data.stage.startsWith('PART_A') || data.stage.startsWith('PART_B') ||
            data.stage.startsWith('PART_C') || data.stage.includes('TRANSFORMATION') || data.stage.includes('RICH')) {
            setPhaseActive('phase2-indicator');
        } else if (data.stage === 'PHASE_3_INDICATOR' || data.stage.includes('DECISION')) {
            setPhaseActive('phase3-indicator');
            setPhaseComplete('phase2-indicator');
        } else if (data.stage === 'PHASE_4_INDICATOR' || data.stage.includes('NARRATIVE')) {
            setPhaseActive('phase4-indicator');
            setPhaseComplete('phase3-indicator');
        } else if (data.stage === 'COMPLETE') {
            setPhaseComplete('phase4-indicator');
        }
    }

    // Update individual task indicators based on stage
    if (data.stage) {
        if (data.stage.startsWith('PART_A')) {
            updatePhaseIndicator('provisions');
            updatePromptSection('provisions', data);
        } else if (data.stage.startsWith('PART_B')) {
            updatePhaseIndicator('questions');
            updatePromptSection('questions', data);
        } else if (data.stage.startsWith('PART_C') || data.stage.includes('TRANSFORMATION')) {
            updatePhaseIndicator('transformation');
            updatePromptSection('transformation', data);
        } else if (data.stage.includes('RICH') || data.stage.includes('ANALYSIS')) {
            updatePhaseIndicator('rich_analysis');
        } else if (data.stage.includes('DECISION')) {
            updatePhaseIndicator('decision_synthesis');
        } else if (data.stage.includes('NARRATIVE')) {
            updatePhaseIndicator('narrative');
        }
    }

    // Update counts when complete
    if (data.stage === 'PART_A_COMPLETE' && data.result) {
        document.getElementById('provisionsCount').textContent = data.result.provision_count || 0;
        markTaskComplete('provisions');
    } else if (data.stage === 'PART_B_COMPLETE' && data.result) {
        document.getElementById('questionsCount').textContent = data.result.question_count || 0;
        document.getElementById('conclusionsCount').textContent = data.result.conclusion_count || 0;
        markTaskComplete('questions');
        markTaskComplete('conclusions');
    } else if (data.stage === 'PART_C_COMPLETE' || data.stage === 'TRANSFORMATION_COMPLETE') {
        if (data.result && data.result.transformation_type) {
            document.getElementById('transformationType').textContent = data.result.transformation_type;
        }
        markTaskComplete('transformation');
    } else if (data.stage === 'COMPLETE') {
        // Final completion
        markTaskComplete('rich_analysis');
        markTaskComplete('decision_synthesis');
        markTaskComplete('narrative');
    }

    // Show LLM traces
    if (data.llm_trace) {
        showLLMTrace(data.stage, data.llm_trace);
    }
}

// Track streaming messages per task
const streamingMessages = {
    provisions: [],
    questions: [],
    conclusions: [],
    transformation: [],
    rich_analysis: [],
    decision_synthesis: [],
    narrative: []
};

// Update prompt section with streaming messages (accumulates)
function updatePromptSection(taskType, data) {
    const promptSection = document.getElementById(`${taskType}PromptSection`);
    const promptText = document.getElementById(`${taskType}PromptText`);

    if (promptSection && promptText) {
        promptSection.style.display = 'block';

        // Accumulate messages
        if (data.messages) {
            data.messages.forEach(msg => {
                if (!streamingMessages[taskType].includes(msg)) {
                    streamingMessages[taskType].push(msg);
                }
            });
        }

        // Build the display with all accumulated messages
        let html = '<div class="alert alert-info mb-2 py-2">';
        html += '<strong><i class="bi bi-gear-fill me-1"></i> Processing:</strong>';
        html += '<div class="streaming-messages mt-2" style="max-height: 200px; overflow-y: auto;">';

        streamingMessages[taskType].forEach((msg, idx) => {
            const isLatest = idx === streamingMessages[taskType].length - 1;
            html += `<div class="mb-1 ${isLatest ? 'fw-bold' : 'text-muted small'}">
                <i class="bi bi-${isLatest ? 'arrow-right-circle-fill text-primary' : 'check-circle text-success'} me-1"></i>
                ${escapeHtml(msg)}
            </div>`;
        });

        html += '</div>';

        // Show progress bar if available
        if (data.progress) {
            html += `<div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${data.progress}%"></div>
            </div>`;
        }

        html += '</div>';

        promptText.innerHTML = html;

        // Auto-scroll to show latest message
        const messagesDiv = promptText.querySelector('.streaming-messages');
        if (messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
}

// Show LLM trace in prompt/response sections
function showLLMTrace(stage, trace) {
    // Determine which section to update based on stage
    let taskType = 'provisions';
    if (stage.includes('QUESTION')) taskType = 'questions';
    else if (stage.includes('CONCLUSION')) taskType = 'conclusions';
    else if (stage.includes('TRANSFORMATION')) taskType = 'transformation';

    const promptSection = document.getElementById(`${taskType}PromptSection`);
    const promptText = document.getElementById(`${taskType}PromptText`);
    const resultsSection = document.getElementById(`${taskType}Results`);
    const resultsContent = document.getElementById(`${taskType}ResultsContent`);

    if (promptSection && promptText && trace.prompt) {
        promptSection.style.display = 'block';
        // Add the actual prompt
        const promptHtml = `<div class="alert alert-success mb-2 py-1 small">LLM call: ${stage}</div>
            <div class="prompt-text-content">${escapeHtml(trace.prompt)}</div>`;
        promptText.innerHTML = promptHtml;
    }

    if (resultsSection && resultsContent && trace.response) {
        resultsSection.style.display = 'block';
        resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 300px; overflow-y: auto;">${escapeHtml(trace.response)}</pre>`;
    }
}

// Mark a task button as complete (shows Re-run)
function markTaskComplete(taskType) {
    const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
    if (button) {
        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
        button.classList.add('btn-outline-secondary');
        button.classList.remove('btn-outline-warning', 'btn-outline-success', 'btn-outline-info', 'btn-outline-primary', 'btn-outline-dark');
    }
}

async function runSingleTask(taskType) {
    return new Promise((resolve, reject) => {
        const endpoints = {
            'provisions': 'extract_provisions',
            'questions': 'extract_questions',
            'conclusions': 'extract_conclusions',
            'transformation': 'extract_transformation',
            'rich_analysis': 'extract_rich_analysis',
            'decision_synthesis': 'extract_decision_synthesis',
            'narrative': 'extract_narrative'
        };

        fetch(`/scenario_pipeline/case/${currentCaseId}/${endpoints[taskType]}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI with results
                handleTaskResults(taskType, data);
                updateCountBadges(taskType, data.result);

                // Mark button as done
                const button = document.getElementById(`extract${capitalizeFirst(taskType)}Btn`);
                if (button) {
                    button.innerHTML = '<i class="bi bi-check-circle"></i> Done';
                    button.classList.add('btn-success');
                }

                resolve(data);
            } else {
                reject(new Error(data.error || 'Task failed'));
            }
        })
        .catch(reject);
    });
}

// Set a phase indicator to active (with animation)
function setPhaseActive(phaseId) {
    const indicator = document.getElementById(phaseId);
    if (indicator) {
        // Remove complete state, add active state
        indicator.classList.remove('phase-complete');
        indicator.classList.add('phase-active');
    }
}

// Set a phase indicator to complete
function setPhaseComplete(phaseId) {
    const indicator = document.getElementById(phaseId);
    if (indicator) {
        // Remove active state, add complete state
        indicator.classList.remove('phase-active');
        indicator.classList.add('phase-complete');
    }
}

function updatePhaseIndicator(currentTask) {
    const phaseMap = {
        'provisions': 'phase2',
        'questions': 'phase2',
        'conclusions': 'phase2',
        'transformation': 'phase2',
        'rich_analysis': 'phase2',
        'decision_synthesis': 'phase3',
        'narrative': 'phase4'
    };

    const phase = phaseMap[currentTask];

    // Remove active from all except phase 1 (always complete)
    ['phase2', 'phase3', 'phase4'].forEach(p => {
        const indicator = document.getElementById(`${p}-indicator`);
        if (indicator) {
            indicator.classList.remove('phase-active');
        }
    });

    // Set current phase as active
    const currentIndicator = document.getElementById(`${phase}-indicator`);
    if (currentIndicator) {
        currentIndicator.classList.add('phase-active');
    }
}

// Load saved prompts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSavedPrompts();
    loadPhase3Results();
    loadPhase4Results();
});

// Load persisted Phase 4 narrative construction results
function loadPhase4Results() {
    {% if phase4_data %}
    const phase4Data = {{ phase4_data | tojson | safe }};

    if (phase4Data && phase4Data.narrative_elements) {
        // Show the results section
        const resultsDiv = document.getElementById('phase4Results');
        if (resultsDiv) resultsDiv.style.display = 'block';

        // Update narrative elements summary
        const ne = phase4Data.narrative_elements;
        if (ne.characters) {
            const charCount = Array.isArray(ne.characters) ? ne.characters.length : ne.characters;
            document.getElementById('phase4Characters').textContent = charCount;
        }
        if (ne.events) {
            const eventCount = Array.isArray(ne.events) ? ne.events.length : ne.events;
            document.getElementById('phase4Events').textContent = eventCount;
        }
        if (ne.conflicts) {
            const conflictCount = Array.isArray(ne.conflicts) ? ne.conflicts.length : ne.conflicts;
            document.getElementById('phase4Conflicts').textContent = conflictCount;
        }
        if (ne.decision_moments) {
            const dmCount = Array.isArray(ne.decision_moments) ? ne.decision_moments.length : ne.decision_moments;
            document.getElementById('phase4Decisions').textContent = dmCount;
        }

        // Update timeline preview
        if (phase4Data.timeline && phase4Data.timeline.event_trace) {
            document.getElementById('phase4TimelinePreview').textContent = phase4Data.timeline.event_trace.substring(0, 1000);
        }

        // Update scenario opening
        if (phase4Data.scenario_seeds && phase4Data.scenario_seeds.opening_context) {
            document.getElementById('phase4OpeningContext').textContent = phase4Data.scenario_seeds.opening_context;
        }

        // Update key takeaways
        if (phase4Data.insights && phase4Data.insights.key_takeaways && phase4Data.insights.key_takeaways.length > 0) {
            const takeawaysUl = document.getElementById('phase4Takeaways');
            takeawaysUl.innerHTML = phase4Data.insights.key_takeaways.map(t => `<li>${escapeHtml(t)}</li>`).join('');
        }

        // Mark Phase 4 stage badges as complete
        ['step-4-1', 'step-4-2', 'step-4-3', 'step-4-4'].forEach(id => {
            const badge = document.getElementById(id);
            if (badge) badge.className = 'badge bg-success mb-1';
        });

        // Update stage result placeholders
        if (ne.characters) {
            const charCount = Array.isArray(ne.characters) ? ne.characters.length : ne.characters;
            document.getElementById('stage41Result').textContent = `${charCount} chars`;
        }
        if (phase4Data.timeline && phase4Data.timeline.events) {
            const eventCount = Array.isArray(phase4Data.timeline.events) ? phase4Data.timeline.events.length : 0;
            document.getElementById('stage42Result').textContent = `${eventCount} events`;
        }
        if (phase4Data.scenario_seeds && phase4Data.scenario_seeds.branches) {
            const branchCount = Array.isArray(phase4Data.scenario_seeds.branches) ? phase4Data.scenario_seeds.branches.length : 0;
            document.getElementById('stage43Result').textContent = `${branchCount} branches`;
        }
        if (phase4Data.insights && phase4Data.insights.key_takeaways) {
            const takeawayCount = phase4Data.insights.key_takeaways.length;
            document.getElementById('stage44Result').textContent = `${takeawayCount} insights`;
        }

        // Update phase indicator
        const phase4Indicator = document.getElementById('phase4-indicator');
        if (phase4Indicator) phase4Indicator.classList.add('phase-complete');

        // Change button to Re-run
        const button = document.getElementById('extractNarrativeBtn');
        if (button) {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
            button.classList.remove('btn-outline-dark');
            button.classList.add('btn-outline-success');
        }
    }
    {% endif %}
}

function loadPhase3Results() {
    fetch(`/scenario_pipeline/case/${currentCaseId}/phase3_results`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.canonical_decision_points && data.canonical_decision_points.length > 0) {
                // Display decision points
                const resultsDiv = document.getElementById('decisionPointsResults');
                const listDiv = document.getElementById('decisionPointsList');
                resultsDiv.style.display = 'block';

                let dpHtml = '<div class="list-group">';
                data.canonical_decision_points.forEach((dp, i) => {
                    const alignScore = ((dp.qc_alignment_score || 0) * 100).toFixed(0);
                    const alignBadge = (dp.qc_alignment_score || 0) > 0.5 ? 'bg-success' : 'bg-secondary';
                    dpHtml += `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${dp.focus_id || 'DP' + (i+1)}: ${escapeHtml(dp.description || '')}</strong>
                                    <br><small class="text-muted">${escapeHtml(dp.decision_question || '')}</small>
                                </div>
                                <span class="badge ${alignBadge}">${alignScore}% aligned</span>
                            </div>
                            ${dp.toulmin ? `
                                <div class="mt-2 small">
                                    <strong>Toulmin:</strong>
                                    <span class="text-muted">DATA: ${escapeHtml(dp.toulmin.data_summary || '-')}</span>
                                </div>
                            ` : ''}
                            ${dp.addresses_questions && dp.addresses_questions.length > 0 ? `
                                <div class="mt-1 small text-primary">
                                    Addresses: ${dp.addresses_questions.join(', ')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                dpHtml += '</div>';
                listDiv.innerHTML = dpHtml;

                // Update button to Re-run
                const button = document.getElementById('extractDecisionSynthesisBtn');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-outline-success');
                }

                // Populate E1-E3 and LLM badges if data available
                if (data.e1_obligations > 0 || data.e1_decision_relevant > 0) {
                    document.getElementById('step-e1').className = 'badge bg-success mb-1';
                    document.getElementById('e1Result').textContent = `${data.e1_obligations} obligations`;
                }
                if (data.e2_action_sets > 0) {
                    document.getElementById('step-e2').className = 'badge bg-success mb-1';
                    document.getElementById('e2Result').textContent = `${data.e2_action_sets} action sets`;
                }
                if (data.e3_candidates > 0) {
                    document.getElementById('step-e3').className = 'badge bg-success mb-1';
                    document.getElementById('e3Result').textContent = `${data.e3_candidates} candidates`;
                }
                if (data.canonical_count > 0) {
                    document.getElementById('step-llm').className = 'badge bg-success mb-1';
                    document.getElementById('llmResult').textContent = `${data.canonical_count} decision pts`;
                }

                // Show LLM trace if available
                if (data.llm_trace) {
                    const accordion = document.getElementById('phase3LLMAccordion');
                    if (accordion) {
                        accordion.style.display = 'block';
                        if (data.llm_trace.prompt) {
                            document.getElementById('phase3PromptContent').textContent = data.llm_trace.prompt;
                        }
                        if (data.llm_trace.response) {
                            document.getElementById('phase3ResponseContent').textContent = data.llm_trace.response;
                        }
                    }
                }

                // Mark phase indicator as complete
                const phase3Indicator = document.getElementById('phase3-indicator');
                if (phase3Indicator) phase3Indicator.classList.add('phase-complete');

                console.log(`Loaded ${data.canonical_decision_points.length} Phase 3 decision points`);
            }
        })
        .catch(error => console.log('No saved Phase 3 results:', error));
}

function loadSavedPrompts() {
    const tasks = ['provisions', 'questions', 'conclusions', 'transformation', 'rich_analysis'];
    const completedTasks = new Set();

    // Track completed tasks and update phase2 indicator when all complete
    function checkPhase2Complete() {
        if (completedTasks.size === tasks.length) {
            const phase2Indicator = document.getElementById('phase2-indicator');
            if (phase2Indicator) {
                phase2Indicator.classList.add('phase-complete');
            }
            console.log('Phase 2 (Analytical Extraction) complete - all 5 tasks loaded');
        }
    }

    tasks.forEach(task => {
        fetch(`/scenario_pipeline/case/${currentCaseId}/get_saved_step4_prompt?task_type=${task}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.prompt_text) {
                    const promptSection = document.getElementById(`${task}PromptSection`);
                    const promptText = document.getElementById(`${task}PromptText`);
                    const resultsSection = document.getElementById(`${task}Results`);
                    const resultsContent = document.getElementById(`${task}ResultsContent`);

                    if (promptSection && promptText) {
                        promptSection.style.display = 'block';
                        promptText.textContent = data.prompt_text;
                    }

                    if (resultsSection && resultsContent && data.raw_response) {
                        resultsSection.style.display = 'block';
                        resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapeHtml(data.raw_response)}</pre>`;
                    }

                    // Mark button as done with Re-run styling
                    const button = document.getElementById(`extract${capitalizeFirst(task)}Btn`);
                    if (button && data.prompt_text) {
                        button.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Re-run';
                        button.classList.remove('btn-secondary', 'btn-warning', 'btn-success', 'btn-info');
                        button.classList.add('btn-outline-success');
                    }

                    // Track this task as complete
                    completedTasks.add(task);
                    checkPhase2Complete();
                }
            })
            .catch(error => console.log(`No saved prompt for ${task}`));
    });
}
</script>
{% endblock %}
