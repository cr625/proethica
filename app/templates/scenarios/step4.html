{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 4: Whole-Case Synthesis{% endblock %}
{% block step_header %}Step 4: Whole-Case Synthesis{% endblock %}
{% block step_subtitle %}Synthesize Code Provisions, Questions, and Conclusions with complete entity context{% endblock %}

{% block step_content %}

<!-- Entity Summary Card -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3"></i> Entity Summary (Passes 1-3)
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Pass 1 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 1: Contextual Framework</h6>
                <ul class="list-unstyled">
                    <li><strong>Roles:</strong> {{ entities_summary.roles }}</li>
                    <li><strong>States:</strong> {{ entities_summary.states }}</li>
                    <li><strong>Resources:</strong> {{ entities_summary.resources }}</li>
                    <li class="mt-2"><strong>Total:</strong> {{ entities_summary.pass1_total }}</li>
                </ul>
            </div>

            <!-- Pass 2 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 2: Normative Requirements</h6>
                <ul class="list-unstyled">
                    <li><strong>Principles:</strong> {{ entities_summary.principles }}</li>
                    <li><strong>Obligations:</strong> {{ entities_summary.obligations }}</li>
                    <li><strong>Constraints:</strong> {{ entities_summary.constraints }}</li>
                    <li><strong>Capabilities:</strong> {{ entities_summary.capabilities }}</li>
                    <li class="mt-2"><strong>Total:</strong> {{ entities_summary.pass2_total }}</li>
                </ul>
            </div>

            <!-- Pass 3 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 3: Temporal Dynamics</h6>
                <ul class="list-unstyled">
                    <li><strong>Actions:</strong> {{ entities_summary.actions }}</li>
                    <li><strong>Events:</strong> {{ entities_summary.events }}</li>
                    <li class="mt-2"><strong>Total:</strong> {{ entities_summary.pass3_total }}</li>
                </ul>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-12 text-center">
                <h4><strong>All Entities:</strong> {{ entities_summary.total }}</h4>
            </div>
        </div>
    </div>
    <div class="card-footer text-center">
        <a href="{{ url_for('entity_review.review_all_case_entities', case_id=case.id) }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-eye"></i> Review All Extracted Entities
        </a>
    </div>
</div>

<!-- Synthesis Status Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-gear"></i> Synthesis Status
        </h5>
    </div>
    <div class="card-body">
        {% if synthesis_status.completed %}
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> Synthesis completed
                <ul class="mb-0 mt-2">
                    <li>Code Provisions: {{ synthesis_status.provisions_count }}</li>
                    <li>Questions: {{ synthesis_status.questions_count }}</li>
                    <li>Conclusions: {{ synthesis_status.conclusions_count }}</li>
                </ul>
            </div>

            <button type="button" class="btn btn-primary" onclick="runSynthesis()">
                <i class="bi bi-arrow-repeat"></i> Re-run Synthesis
            </button>

            <!-- Show synthesis results if available -->
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary">{{ synthesis_status.provisions_count }}</h3>
                            <p class="text-muted mb-2">Code Provisions</p>
                            {% if synthesis_status.provisions_count > 0 %}
                            <button class="btn btn-sm btn-outline-primary" onclick="viewSynthesisResults('provisions')">
                                <i class="bi bi-eye"></i> View
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-info">{{ synthesis_status.questions_count }}</h3>
                            <p class="text-muted mb-2">Questions</p>
                            {% if synthesis_status.questions_count > 0 %}
                            <button class="btn btn-sm btn-outline-info" onclick="viewSynthesisResults('questions')">
                                <i class="bi bi-eye"></i> View
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success">{{ synthesis_status.conclusions_count }}</h3>
                            <p class="text-muted mb-2">Conclusions</p>
                            {% if synthesis_status.conclusions_count > 0 %}
                            <button class="btn btn-sm btn-outline-success" onclick="viewSynthesisResults('conclusions')">
                                <i class="bi bi-eye"></i> View
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Synthesis not yet performed. Click below to start.
            </div>

            <button type="button" class="btn btn-lg btn-primary" onclick="runSynthesis()">
                <i class="bi bi-play-circle"></i> Run Whole-Case Synthesis
            </button>
        {% endif %}
    </div>
</div>

<!-- Synthesis Progress (Hidden until synthesis starts) -->
<div id="synthesis-progress" class="card mb-4" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0">
            <i id="progress-icon" class="bi bi-hourglass-split"></i> <span id="progress-header-text">Synthesis Progress</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="progress mb-3" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%">
                0%
            </div>
        </div>

        <div id="progress-messages">
            <!-- Progress messages will appear here -->
        </div>
    </div>
</div>

<!-- Synthesis Results Card removed - now shown in Status card above -->

<!-- Three-Part Synthesis Explanation -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> About Step 4 Synthesis
        </h5>
    </div>
    <div class="card-body">
        <p>Step 4 performs whole-case synthesis with complete entity context from all three passes:</p>

        <h6>Part A: Code Provisions</h6>
        <ul>
            <li>Extracts NSPE Code provisions mentioned in References section</li>
            <li>Links provisions to ALL 9 entity types (Roles, Principles, Actions, etc.)</li>
            <li>Validates content relevance using LLM</li>
        </ul>

        <h6>Part B: Questions & Conclusions</h6>
        <ul>
            <li>Extracts ethical questions from Questions section</li>
            <li>Extracts conclusions from Conclusions section</li>
            <li>Tags entities across all 9 types</li>
            <li>Creates answersQuestion relationships between Q&C</li>
        </ul>

        <h6>Part C: Cross-Section Synthesis</h6>
        <ul>
            <li>Entity consolidation across sections</li>
            <li>Relationship inference</li>
            <li>Consistency checking</li>
        </ul>

        <div class="alert alert-warning mt-3">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Note:</strong> Synthesis requires all 3 passes (Facts, Discussion, Questions, Conclusions from Passes 1-3) to be completed first.
        </div>
    </div>
</div>

{% endblock %}

{% block step_scripts %}
<script>
function runSynthesis() {
    // Show progress card
    document.getElementById('synthesis-progress').style.display = 'block';
    document.getElementById('synthesis-results').style.display = 'none';

    // Reset progress
    updateProgress(0, 'Starting synthesis...');

    // Start synthesis
    fetch('/scenario_pipeline/case/{{ case.id }}/synthesize', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update progress to 100%
            updateProgress(100, 'Synthesis complete!');

            // Change progress icon to checkmark
            const progressIcon = document.getElementById('progress-icon');
            progressIcon.className = 'bi bi-check-circle text-success';
            document.getElementById('progress-header-text').textContent = 'Synthesis Complete';

            // Results will be shown in Status card after page refresh

            // Add success message with refresh button
            const successMsg = addProgressMessage('success', 'All synthesis operations completed successfully!');
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn btn-success btn-sm mt-2';
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh Page to See Results';
            refreshBtn.onclick = () => location.reload();
            successMsg.appendChild(refreshBtn);
        } else {
            addProgressMessage('danger', 'Error: ' + data.error);
        }
    })
    .catch(error => {
        addProgressMessage('danger', 'Error: ' + error.message);
    });

    // Simulate progress updates (since backend doesn't stream)
    simulateProgress();
}

function simulateProgress() {
    const stages = [
        {percent: 10, message: 'Loading entities from Passes 1-3...'},
        {percent: 20, message: 'Parsing References section...'},
        {percent: 35, message: 'Detecting provision mentions...'},
        {percent: 50, message: 'Validating provisions with LLM...'},
        {percent: 65, message: 'Extracting questions...'},
        {percent: 80, message: 'Extracting conclusions...'},
        {percent: 90, message: 'Linking questions to conclusions...'},
        {percent: 95, message: 'Performing cross-section synthesis...'}
    ];

    let currentStage = 0;
    const interval = setInterval(() => {
        if (currentStage < stages.length) {
            const stage = stages[currentStage];
            updateProgress(stage.percent, stage.message);
            currentStage++;
        } else {
            clearInterval(interval);
        }
    }, 2000);
}

function updateProgress(percent, message) {
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = percent + '%';
    progressBar.textContent = percent + '%';

    if (message) {
        addProgressMessage('info', message);
    }
}

function addProgressMessage(type, message) {
    const messagesDiv = document.getElementById('progress-messages');
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-' + type + ' mb-2';
    alertDiv.innerHTML = '<i class="bi bi-arrow-right"></i> ' + message;
    messagesDiv.appendChild(alertDiv);

    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;

    return alertDiv;  // Return the element so caller can add more content
}

function viewSynthesisResults(type) {
    // Navigate to a view showing the specific synthesis results
    // For now, show in modal or navigate to a filtered view
    const caseId = {{ case.id }};

    if (type === 'provisions') {
        // Navigate to provisions view (to be implemented)
        alert('Code Provisions view - to be implemented. Check database for extraction_type=code_provision_reference');
    } else if (type === 'questions') {
        // Navigate to questions view
        alert('Questions view - to be implemented. Check database for extraction_type=ethical_question');
    } else if (type === 'conclusions') {
        // Navigate to conclusions view
        alert('Conclusions view - to be implemented. Check database for extraction_type=ethical_conclusion');
    }
}
</script>
{% endblock %}

{% block step_styles %}
<style>
    #progress-messages {
        max-height: 300px;
        overflow-y: auto;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .card-header h5 {
        margin-bottom: 0;
    }

    .list-unstyled li {
        padding: 0.25rem 0;
    }
</style>
{% endblock %}
