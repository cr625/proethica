{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 4: Whole-Case Synthesis{% endblock %}
{% block step_header %}Step 4: Whole-Case Synthesis{% endblock %}
{% block step_subtitle %}Synthesize Code Provisions, Questions, and Conclusions with complete entity context{% endblock %}

{% block step_content %}

<!-- Entity Summary Card -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-diagram-3"></i> Entity Summary (Passes 1-3)
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Pass 1 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 1: Contextual Framework</h6>
                <ul class="list-unstyled">
                    <li><strong>Roles:</strong> {{ entities_summary.roles }}</li>
                    <li><strong>States:</strong> {{ entities_summary.states }}</li>
                    <li><strong>Resources:</strong> {{ entities_summary.resources }}</li>
                    <li class="mt-2"><strong>Total:</strong> {{ entities_summary.pass1_total }}</li>
                </ul>
            </div>

            <!-- Pass 2 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 2: Normative Requirements</h6>
                <ul class="list-unstyled">
                    <li><strong>Principles:</strong> {{ entities_summary.principles }}</li>
                    <li><strong>Obligations:</strong> {{ entities_summary.obligations }}</li>
                    <li><strong>Constraints:</strong> {{ entities_summary.constraints }}</li>
                    <li><strong>Capabilities:</strong> {{ entities_summary.capabilities }}</li>
                    <li class="mt-2"><strong>Total:</strong> {{ entities_summary.pass2_total }}</li>
                </ul>
            </div>

            <!-- Pass 3 -->
            <div class="col-md-4">
                <h6 class="text-muted">Pass 3: Temporal Dynamics</h6>
                <ul class="list-unstyled">
                    <li><strong>Actions:</strong> {{ entities_summary.actions }}</li>
                    <li><strong>Events:</strong> {{ entities_summary.events }}</li>
                    <li class="mt-2"><strong>Total:</strong> {{ entities_summary.pass3_total }}</li>
                </ul>
            </div>
        </div>

        <hr>

        <div class="row">
            <div class="col-md-12 text-center">
                <h4><strong>All Entities:</strong> {{ entities_summary.total }}</h4>
            </div>
        </div>
    </div>
</div>

<!-- Synthesis Control Card -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-gear"></i> Whole-Case Synthesis
        </h5>
    </div>
    <div class="card-body">
        {% if synthesis_status.completed %}
            <button type="button" class="btn btn-primary" onclick="runSynthesis()">
                <i class="bi bi-arrow-repeat"></i> Re-run Synthesis
            </button>

            <a href="{{ url_for('step4.step4_review', case_id=case.id) }}" class="btn btn-success ms-2">
                <i class="bi bi-clipboard-check"></i> View Step 4 Review
            </a>

            <a href="{{ url_for('step4.view_synthesis_results', case_id=case.id) }}" class="btn btn-outline-secondary ms-2">
                <i class="bi bi-diagram-3"></i> Technical Results
            </a>
        {% else %}
            <div class="alert alert-info mb-3">
                <i class="bi bi-info-circle"></i> Synthesis not yet performed. Click below to start.
            </div>

            <button type="button" class="btn btn-lg btn-primary" onclick="runSynthesis()">
                <i class="bi bi-play-circle"></i> Run Whole-Case Synthesis
            </button>
        {% endif %}
    </div>
</div>

<!-- Synthesis Progress Card (Hidden until synthesis starts) -->
<div id="synthesis-progress" class="card mb-4" style="display: none;">
    <div class="card-header">
        <h5 class="mb-0">
            <i id="progress-icon" class="bi bi-hourglass-split"></i>
            <span id="progress-header-text">Synthesis Progress</span>
        </h5>
    </div>
    <div class="card-body">
        <div class="progress mb-3" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%">0%</div>
        </div>

        <!-- Current Stage Info -->
        <div id="stage-info" class="alert alert-info mb-3" style="display: none;">
            <strong>Current Stage:</strong> <span id="current-stage">Initializing...</span>
        </div>

        <!-- Extraction Log -->
        <div class="card mb-3">
            <div class="card-header" style="cursor: pointer;" onclick="toggleLog()">
                <i id="log-toggle-icon" class="bi bi-chevron-down"></i>
                <strong>Synthesis Log</strong>
                <span class="badge bg-secondary ms-2" id="log-count">0 messages</span>
            </div>
            <div id="progress-messages" class="card-body" style="max-height: 400px; overflow-y: auto; display: block;">
                <em class="text-muted">Waiting for synthesis to start...</em>
            </div>
        </div>

        <!-- Summary Section (shown on completion) -->
        <div id="synthesis-summary" class="card mb-3" style="display: none;">
            <div class="card-header bg-success bg-opacity-10">
                <strong><i class="bi bi-check-circle text-success"></i> Synthesis Summary</strong>
            </div>
            <div class="card-body" id="synthesis-summary-content">
            </div>
        </div>

        <!-- LLM Prompts & Responses Accordion -->
        <div class="card mb-3">
            <div class="card-header bg-primary bg-opacity-10">
                <strong><i class="bi bi-file-text"></i> LLM Prompts & Responses by Stage</strong>
                <small class="text-muted ms-2">Expand each stage to see Claude interactions</small>
            </div>
            <div class="card-body">
                <div id="synthesis-stages-accordion" class="accordion">
                    <em class="text-muted">Stages will appear here as synthesis progresses...</em>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- About Step 4 -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-info-circle"></i> About Step 4 Synthesis
        </h5>
    </div>
    <div class="card-body">
        <p>Step 4 performs whole-case synthesis with complete entity context from all three passes:</p>

        <h6>Part A: Code Provisions</h6>
        <ul>
            <li>Extracts NSPE Code provisions mentioned in References section</li>
            <li>Links provisions to ALL 9 entity types (Roles, Principles, Actions, etc.)</li>
            <li>Validates content relevance using LLM</li>
        </ul>

        <h6>Part B: Questions & Conclusions</h6>
        <ul>
            <li>Extracts ethical questions from Questions section</li>
            <li>Extracts conclusions from Conclusions section</li>
            <li>Tags entities across all 9 types</li>
            <li>Creates answersQuestion relationships between Q&C</li>
        </ul>

        <h6>Part C: Cross-Section Synthesis</h6>
        <ul>
            <li>Builds entity knowledge graph (205+ nodes)</li>
            <li>Creates causal-normative links (Actions/Events → Obligations/Principles)</li>
            <li>Analyzes question emergence (WHY questions arose)</li>
            <li>Extracts resolution patterns (HOW board decided)</li>
        </ul>

        <div class="alert alert-warning mt-3">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Note:</strong> Synthesis requires all 3 passes to be completed first.
        </div>
    </div>
</div>

{% endblock %}

{% block step_scripts %}
<script>
const currentCaseId = {{ case.id }};
let messageCount = 0;
let synthesisData = {
    stages: [],
    totalMessages: 0,
    startTime: null,
    endTime: null
};

function toggleLog() {
    const messagesDiv = document.getElementById("progress-messages");
    const toggleIcon = document.getElementById("log-toggle-icon");
    if (messagesDiv.style.display === "none") {
        messagesDiv.style.display = "block";
        toggleIcon.className = "bi bi-chevron-down";
    } else {
        messagesDiv.style.display = "none";
        toggleIcon.className = "bi bi-chevron-right";
    }
}

function runSynthesis() {
    const progressCard = document.getElementById('synthesis-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressIcon = document.getElementById('progress-icon');
    const progressHeader = document.getElementById('progress-header-text');
    const messagesDiv = document.getElementById('progress-messages');
    const stageInfo = document.getElementById('stage-info');
    const currentStageSpan = document.getElementById('current-stage');
    const summaryCard = document.getElementById('synthesis-summary');

    // Reset state
    messageCount = 0;
    synthesisData = {
        stages: [],
        totalMessages: 0,
        startTime: new Date(),
        endTime: null
    };

    // Show progress card
    if (progressCard) {
        progressCard.style.display = 'block';
    }
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    messagesDiv.innerHTML = '';
    summaryCard.style.display = 'none';
    stageInfo.style.display = 'block';
    progressIcon.className = 'bi bi-hourglass-split';
    currentStageSpan.textContent = 'Initializing...';
    document.getElementById('log-count').textContent = '0 messages';

    // Scroll to progress card
    progressCard.scrollIntoView({ behavior: 'smooth', block: 'start' });

    // Create EventSource for Server-Sent Events
    const eventSource = new EventSource(
        `/scenario_pipeline/case/${currentCaseId}/synthesize_streaming`
    );

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        console.log('Synthesis event:', data);

        // Check for completion
        if (data.complete) {
            eventSource.close();
            synthesisData.endTime = new Date();
            const duration = ((synthesisData.endTime - synthesisData.startTime) / 1000).toFixed(1);

            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressBar.classList.remove('progress-bar-animated');
            progressBar.classList.add('bg-success');
            progressIcon.className = 'bi bi-check-circle text-success';
            progressHeader.textContent = 'Synthesis Complete';
            stageInfo.style.display = 'none';

            // Show summary
            summaryCard.style.display = 'block';
            const summary = data.summary || {};
            document.getElementById('synthesis-summary-content').innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <strong>Duration:</strong> ${duration} seconds
                    </div>
                    <div class="col-md-3">
                        <strong>Provisions:</strong> ${summary.provisions_count || 0}
                    </div>
                    <div class="col-md-3">
                        <strong>Questions:</strong> ${summary.questions_count || 0}
                    </div>
                    <div class="col-md-3">
                        <strong>Conclusions:</strong> ${summary.conclusions_count || 0}
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <strong>Entity Nodes:</strong> ${summary.total_nodes || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>Causal Links:</strong> ${summary.total_links || 0}
                    </div>
                    <div class="col-md-4">
                        <strong>LLM Interactions:</strong> ${summary.llm_interactions || 0}
                    </div>
                </div>
            `;

            addMessage('success', `✓ Synthesis completed in ${duration} seconds`);
            addMessage('info', 'Saving results to database...');

            // Save synthesis results to database
            saveSynthesisResults(data).then(() => {
                addMessage('success', '✓ Results saved successfully');

                // Add refresh button
                const refreshBtn = document.createElement('button');
                refreshBtn.className = 'btn btn-success btn-sm mt-3';
                refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh to See Results';
                refreshBtn.onclick = () => location.reload();
                messagesDiv.appendChild(refreshBtn);
            }).catch((error) => {
                addMessage('warning', `Warning: Failed to save results - ${error.message}`);
                console.error('Error saving synthesis results:', error);
            });

            return;
        }

        // Check for error
        if (data.error) {
            eventSource.close();
            addMessage('danger', `Error: ${data.error}`);
            progressIcon.className = 'bi bi-exclamation-triangle text-danger';
            progressHeader.textContent = 'Synthesis Failed';
            stageInfo.style.display = 'none';
            return;
        }

        // Update stage info
        if (data.stage) {
            currentStageSpan.textContent = data.stage || 'Processing...';
            if (data.stage && !synthesisData.stages.includes(data.stage)) {
                synthesisData.stages.push(data.stage);
            }
        }

        // Update progress bar
        if (data.progress !== undefined) {
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress + '%';
        }

        // Add messages
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(msg => {
                addMessage('info', msg);
            });
        }

        // Add errors/warnings
        if (data.errors && data.errors.length > 0) {
            data.errors.forEach(err => {
                addMessage('warning', err);
            });
        }

        // Handle LLM trace data
        if (data.llm_trace && data.llm_trace.length > 0) {
            data.llm_trace.forEach(trace => {
                displayStagePromptResponse(trace);
            });
        }
    };

    eventSource.onerror = function(error) {
        console.error('Synthesis SSE error:', error);
        eventSource.close();
        addMessage('danger', 'Connection error during synthesis');
        progressIcon.className = 'bi bi-exclamation-triangle text-danger';
        progressHeader.textContent = 'Synthesis Failed';
    };
}

function addMessage(type, message) {
    const messagesDiv = document.getElementById('progress-messages');

    // Clear "waiting" message on first real message
    if (messageCount === 0) {
        messagesDiv.innerHTML = '';
    }

    messageCount++;
    document.getElementById('log-count').textContent = `${messageCount} message${messageCount !== 1 ? 's' : ''}`;

    const timestamp = new Date().toLocaleTimeString();
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} mb-2 py-2`;

    let icon = 'bi-arrow-right';
    if (type === 'success') icon = 'bi-check-circle';
    else if (type === 'danger') icon = 'bi-exclamation-triangle';
    else if (type === 'warning') icon = 'bi-exclamation-circle';
    else if (type === 'info') icon = 'bi-info-circle';

    alertDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div><i class="bi ${icon}"></i> ${message}</div>
            <small class="text-muted ms-2" style="white-space: nowrap;">${timestamp}</small>
        </div>
    `;
    messagesDiv.appendChild(alertDiv);

    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function displayStagePromptResponse(trace) {
    const accordionContainer = document.getElementById('synthesis-stages-accordion');

    // Remove placeholder text on first trace
    if (accordionContainer.querySelector('em')) {
        accordionContainer.innerHTML = '';
    }

    // Create unique ID for this stage
    const stageName = trace.stage || 'unknown';
    const stageId = 'stage-' + stageName.replace(/[^a-z0-9]/gi, '-');

    // Check if this stage already exists (avoid duplicates)
    if (document.getElementById(stageId)) {
        return; // Already displayed
    }

    // Create accordion item
    const accordionItem = document.createElement('div');
    accordionItem.className = 'accordion-item';
    accordionItem.id = stageId;

    // Format token info
    let tokenBadge = '';
    if (trace.tokens && trace.tokens.total_tokens) {
        tokenBadge = '<span class="badge bg-info ms-2">' + trace.tokens.total_tokens + ' tokens</span>';
    }

    // Stage header
    const header = document.createElement('h2');
    header.className = 'accordion-header';
    header.innerHTML =
        '<button class="accordion-button collapsed" type="button" ' +
        'data-bs-toggle="collapse" data-bs-target="#collapse-' + stageId + '">' +
        '<i class="bi bi-check-circle text-success me-2"></i>' +
        '<strong>Stage: ' + (trace.stage || 'Unknown') + '</strong>' +
        '<span class="badge bg-secondary ms-2">' + (trace.model || 'Unknown') + '</span>' +
        tokenBadge +
        '</button>';

    // Stage content
    const content = document.createElement('div');
    content.id = 'collapse-' + stageId;
    content.className = 'accordion-collapse collapse';

    let tokenSection = '';
    if (trace.tokens) {
        tokenSection = '<div class="mt-3 p-2 bg-light rounded">' +
            '<small class="text-muted">' +
            '<strong>Token Usage:</strong> ' +
            'Input: ' + trace.tokens.input_tokens + ' | ' +
            'Output: ' + trace.tokens.output_tokens + ' | ' +
            'Total: ' + trace.tokens.total_tokens +
            '</small></div>';
    }

    content.innerHTML =
        '<div class="accordion-body">' +
        '<div class="mb-4">' +
        '<h6 class="text-primary">' +
        '<i class="bi bi-file-text"></i> LLM Prompt ' +
        '<small class="text-muted ms-2">' + (trace.timestamp || '') + '</small>' +
        '</h6>' +
        '<pre class="prompt-display">' + escapeHtml(trace.prompt || 'No prompt available') + '</pre>' +
        '</div>' +
        '<div class="mb-3">' +
        '<h6 class="text-success">' +
        '<i class="bi bi-code-square"></i> LLM Response' +
        '</h6>' +
        '<pre class="response-display">' + escapeHtml(trace.response || 'No response available') + '</pre>' +
        '</div>' +
        tokenSection +
        '</div>';

    accordionItem.appendChild(header);
    accordionItem.appendChild(content);
    accordionContainer.appendChild(accordionItem);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function saveSynthesisResults(data) {
    /**
     * Save Step 4 streaming synthesis results to database for persistence.
     *
     * Sends all LLM traces (prompts + responses) and synthesis results
     * to the backend for storage in ExtractionPrompt table.
     */
    const saveData = {
        session_id: data.session_id,
        llm_traces: data.llm_traces || [],
        synthesis_results: data.synthesis_results || {}
    };

    const response = await fetch(
        `/scenario_pipeline/case/${currentCaseId}/save_streaming_results`,
        {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(saveData)
        }
    );

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to save synthesis results');
    }

    return await response.json();
}

// Load saved synthesis results on page load
{% if saved_synthesis %}
document.addEventListener('DOMContentLoaded', function() {
    // Show progress card with saved results
    const progressCard = document.getElementById('synthesis-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressIcon = document.getElementById('progress-icon');
    const progressHeader = document.getElementById('progress-header-text');
    const stageInfo = document.getElementById('stage-info');
    const messagesDiv = document.getElementById('progress-messages');
    const summaryCard = document.getElementById('synthesis-summary');
    const accordionContainer = document.getElementById('synthesis-stages-accordion');

    // Display the saved synthesis
    progressCard.style.display = 'block';
    progressBar.style.width = '100%';
    progressBar.textContent = '100%';
    progressBar.classList.remove('progress-bar-animated');
    progressBar.classList.add('bg-success');
    progressIcon.className = 'bi bi-check-circle text-success';
    progressHeader.textContent = 'Synthesis Complete (Loaded from Database)';
    stageInfo.style.display = 'none';

    // Show summary
    const summary = {{ saved_synthesis.results_summary | tojson | safe }};
    summaryCard.style.display = 'block';
    document.getElementById('synthesis-summary-content').innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <strong>Provisions:</strong> ${summary.provisions_count || 0}
            </div>
            <div class="col-md-3">
                <strong>Questions:</strong> ${summary.questions_count || 0}
            </div>
            <div class="col-md-3">
                <strong>Conclusions:</strong> ${summary.conclusions_count || 0}
            </div>
            <div class="col-md-3">
                <strong>Entity Nodes:</strong> ${summary.total_nodes || 0}
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-6">
                <strong>LLM Interactions:</strong> ${summary.llm_interactions || 0}
            </div>
            <div class="col-md-6">
                <strong>Completed:</strong> {{ saved_synthesis.created_at.strftime('%Y-%m-%d %H:%M') }}
            </div>
        </div>
    `;

    // Parse saved prompts and responses
    const savedPromptText = {{ saved_synthesis.prompt_text | tojson | safe }};
    const savedResponseText = {{ saved_synthesis.raw_response | tojson | safe }};

    // Extract stages from the combined prompt/response
    const stages = (summary.stages || []);

    // Display saved LLM traces
    if (stages.length > 0) {
        accordionContainer.innerHTML = ''; // Clear placeholder

        stages.forEach((stageName, index) => {
            const stageMarker = `=== ${stageName} ===`;

            // Extract prompt for this stage
            const promptStartIndex = savedPromptText.indexOf(stageMarker);
            const promptEndIndex = savedPromptText.indexOf('=== ', promptStartIndex + stageMarker.length);
            const stagePrompt = promptStartIndex >= 0
                ? savedPromptText.substring(promptStartIndex + stageMarker.length, promptEndIndex >= 0 ? promptEndIndex : undefined).trim()
                : '';

            // Extract response for this stage
            const responseStartIndex = savedResponseText.indexOf(stageMarker);
            const responseEndIndex = savedResponseText.indexOf('=== ', responseStartIndex + stageMarker.length);
            const stageResponse = responseStartIndex >= 0
                ? savedResponseText.substring(responseStartIndex + stageMarker.length, responseEndIndex >= 0 ? responseEndIndex : undefined).trim()
                : '';

            if (stagePrompt || stageResponse) {
                displayStagePromptResponse({
                    stage: stageName,
                    prompt: stagePrompt,
                    response: stageResponse,
                    model: '{{ saved_synthesis.llm_model }}',
                    timestamp: '{{ saved_synthesis.created_at.strftime('%Y-%m-%d %H:%M:%S') }}'
                });
            }
        });
    }

    // Add status message
    messagesDiv.innerHTML = '';
    addMessage('info', 'Loaded saved synthesis results from database');
    addMessage('success', 'Synthesis completed: {{ saved_synthesis.created_at.strftime('%Y-%m-%d %H:%M') }}');
});
{% endif %}
</script>
{% endblock %}

{% block step_styles %}
<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    }

    .card-header h5 {
        margin-bottom: 0;
    }

    .list-unstyled li {
        padding: 0.25rem 0;
    }

    #progress-messages {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Prompt and Response Display Styles */
    .prompt-display, .response-display {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
        font-size: 0.85rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        max-height: 600px;
        min-height: 200px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.5;
        margin: 0;
    }

    .response-display {
        background-color: #e8f4fd;
        border-color: #0d6efd;
    }

    #synthesis-stages-accordion .accordion-item {
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
    }

    #synthesis-stages-accordion .accordion-button {
        font-size: 1rem;
        padding: 1rem;
    }

    #synthesis-stages-accordion .accordion-button:not(.collapsed) {
        background-color: #e7f1ff;
        color: #004085;
    }

    #synthesis-stages-accordion .accordion-body {
        max-height: none;
        padding: 1.5rem;
    }
</style>
{% endblock %}
