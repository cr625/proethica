{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 2: Normative Requirements Pass - {{ section_display_name }}{% endblock %}
{% block step_header %}Step 2: Normative Requirements Pass ({{ section_display_name }}){% endblock %}
{% block step_subtitle %}Extract principles, obligations, constraints, and capabilities from the {{ section_display_name.lower() }}{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ prev_step_url }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Previous
    </a>
    <div>
        <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id) }}" class="btn btn-info me-2">
            <i class="bi bi-list-check"></i> Review Pass 2 Entities
        </a>
        <a href="{{ next_step_url }}" class="btn btn-outline-primary">
            Next <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>

<!-- Section tabs for easy navigation -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if step_title == 'Normative Pass - Facts Section' %}active{% endif %}"
           href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}">
            Facts
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if step_title == 'Normative Pass - Discussion' %}active{% endif %}"
           href="{{ url_for('scenario_pipeline.step2b', case_id=case.id) }}">
            Discussion
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if step_title == 'Normative Pass - Questions' %}active{% endif %}"
           href="{{ url_for('scenario_pipeline.step2c', case_id=case.id) }}">
            Questions
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if step_title == 'Normative Pass - Conclusions' %}active{% endif %}"
           href="{{ url_for('scenario_pipeline.step2d', case_id=case.id) }}">
            Conclusions
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if step_title == 'Normative Pass - References' %}active{% endif %}"
           href="{{ url_for('scenario_pipeline.step2e', case_id=case.id) }}">
            References
        </a>
    </li>
</ul>
{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-text"></i> {{ section_display_name }}
        </h4>
    </div>
    <div class="step-content">
        {% if discussion_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="discussion-text">{{ discussion_section.llm_text }}</pre>
        </div>

        <!-- Full Normative Requirements Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
            {% if current_user.is_authenticated %}
            <button id="normativePassBtn" class="btn btn-primary btn-lg" onclick="executeFullNormativePass()">
                <i class="bi bi-arrow-right-circle"></i> Full Normative Requirements Pass
                <small class="d-block">Extract All: Principles + Obligations + Constraints + Capabilities</small>
            </button>
            {% else %}
            <button class="btn btn-secondary btn-lg" onclick="window.location.href='{{ url_for('auth.login') }}';" title="Login required to run extraction">
                <i class="bi bi-lock-fill"></i> Full Normative Requirements Pass
                <small class="d-block">Login Required</small>
            </button>
            {% endif %}
        </div>

        <!-- Individual Extractor Sections -->

        <!-- PRINCIPLES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="principlesSection">
            <div class="step-card border-success">
                <div class="step-header bg-success bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-stars text-success"></i> Principles Extraction
                        </h5>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-success btn-sm" onclick="extractIndividualConcept('principles')">
                            <i class="bi bi-play-fill"></i> Extract Principles
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <!-- Principles Prompt Preview -->
                    <div class="prompt-preview mb-3" id="principlesPromptSection" style="{% if not saved_prompts.principles %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="principlesPromptText">
                            {% if saved_prompts.principles %}
                            {{ saved_prompts.principles.prompt_text }}
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Extract Principles
                            </div>
                            {% endif %}
                        </div>
                        {% if saved_prompts.principles %}
                        <small class="text-muted">Saved: {{ saved_prompts.principles.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>

                    <!-- Principles Results -->
                    <div class="results-preview mb-3" id="principlesResults" style="{% if not saved_prompts.principles or not saved_prompts.principles.raw_response %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="principlesResultsContent">
                            {% if saved_prompts.principles and saved_prompts.principles.raw_response %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">{{ saved_prompts.principles.raw_response }}</pre>
                            {% else %}
                            <!-- LLM response will be displayed here -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OBLIGATIONS EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="obligationsSection">
            <div class="step-card border-warning">
                <div class="step-header bg-warning bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-shield-check text-warning"></i> Obligations Extraction
                        </h5>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-warning btn-sm" onclick="extractIndividualConcept('obligations')">
                            <i class="bi bi-play-fill"></i> Extract Obligations
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <!-- Obligations Prompt Preview -->
                    <div class="prompt-preview mb-3" id="obligationsPromptSection" style="{% if not saved_prompts.obligations %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="obligationsPromptText">
                            {% if saved_prompts.obligations %}
                            {{ saved_prompts.obligations.prompt_text }}
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Extract Obligations
                            </div>
                            {% endif %}
                        </div>
                        {% if saved_prompts.obligations %}
                        <small class="text-muted">Saved: {{ saved_prompts.obligations.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>

                    <!-- Obligations LLM Response -->
                    <div class="results-preview mb-3" id="obligationsResults" style="{% if not saved_prompts.obligations or not saved_prompts.obligations.raw_response %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="obligationsResultsContent">
                            {% if saved_prompts.obligations and saved_prompts.obligations.raw_response %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">{{ saved_prompts.obligations.raw_response }}</pre>
                            {% else %}
                            <!-- LLM response will be displayed here -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONSTRAINTS EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="constraintsSection">
            <div class="step-card border-danger">
                <div class="step-header bg-danger bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle text-danger"></i> Constraints Extraction
                        </h5>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-danger btn-sm" onclick="extractIndividualConcept('constraints')">
                            <i class="bi bi-play-fill"></i> Extract Constraints
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <!-- Constraints Prompt Preview -->
                    <div class="prompt-preview mb-3" id="constraintsPromptSection" style="{% if not saved_prompts.constraints %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="constraintsPromptText">
                            {% if saved_prompts.constraints %}
                            {{ saved_prompts.constraints.prompt_text }}
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Extract Constraints
                            </div>
                            {% endif %}
                        </div>
                        {% if saved_prompts.constraints %}
                        <small class="text-muted">Saved: {{ saved_prompts.constraints.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>

                    <!-- Constraints LLM Response -->
                    <div class="results-preview mb-3" id="constraintsResults" style="{% if not saved_prompts.constraints or not saved_prompts.constraints.raw_response %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="constraintsResultsContent">
                            {% if saved_prompts.constraints and saved_prompts.constraints.raw_response %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">{{ saved_prompts.constraints.raw_response }}</pre>
                            {% else %}
                            <!-- LLM response will be displayed here -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CAPABILITIES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="capabilitiesSection">
            <div class="step-card border-info">
                <div class="step-header bg-info bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-gear text-info"></i> Capabilities Extraction
                        </h5>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-info btn-sm" onclick="extractIndividualConcept('capabilities')">
                            <i class="bi bi-play-fill"></i> Extract Capabilities
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <!-- Capabilities Prompt Preview -->
                    <div class="prompt-preview mb-3" id="capabilitiesPromptSection" style="{% if not saved_prompts.capabilities %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="capabilitiesPromptText">
                            {% if saved_prompts.capabilities %}
                            {{ saved_prompts.capabilities.prompt_text }}
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Extract Capabilities
                            </div>
                            {% endif %}
                        </div>
                        {% if saved_prompts.capabilities %}
                        <small class="text-muted">Saved: {{ saved_prompts.capabilities.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>

                    <!-- Capabilities LLM Response -->
                    <div class="results-preview mb-3" id="capabilitiesResults" style="{% if not saved_prompts.capabilities or not saved_prompts.capabilities.raw_response %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="capabilitiesResultsContent">
                            {% if saved_prompts.capabilities and saved_prompts.capabilities.raw_response %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">{{ saved_prompts.capabilities.raw_response }}</pre>
                            {% else %}
                            <!-- LLM response will be displayed here -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation to entity review -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            {% if step_title == 'Normative Pass - Facts Section' %}
                <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id, section_type='facts') }}" class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> Review Pass 2 Entities (Facts)
                </a>
            {% elif step_title == 'Normative Pass - Discussion' %}
                <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id, section_type='discussion') }}" class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> Review Pass 2 Entities (Discussion)
                </a>
            {% elif step_title == 'Normative Pass - Questions' %}
                <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id, section_type='questions') }}" class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> Review Pass 2 Entities (Questions)
                </a>
            {% elif step_title == 'Normative Pass - Conclusions' %}
                <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id, section_type='conclusions') }}" class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> Review Pass 2 Entities (Conclusions)
                </a>
            {% elif step_title == 'Normative Pass - References' %}
                <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id, section_type='references') }}" class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> Review Pass 2 Entities (References)
                </a>
            {% else %}
                <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id) }}" class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> Review Pass 2 Entities
                </a>
            {% endif %}
        </div>

        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No section content found in this case.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block step_styles %}
<style>
    /* Fade out page smoothly on navigation/redirect */
    body.navigating {
        opacity: 0;
        transition: opacity 0.15s ease-out;
    }

    .discussion-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: none;
        margin: 0;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .extractor-section .step-card {
        transition: all 0.3s ease;
    }

    .extractor-section .step-card:hover {
        box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
    }

    .prompt-preview {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .prompt-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: white;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #e0e0e0;
    }

    .results-preview {
        border-radius: 0.5rem;
        padding: 1rem;
        background-color: #f0fff0;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
const caseId = {{ case.id }};
let currentSectionText = {{ discussion_section.llm_text | tojson if discussion_section else '""' }};
// Determine section type based on step_title
{% if step_title == 'Normative Pass - Facts Section' %}
const currentSectionType = 'facts';
{% elif step_title == 'Normative Pass - Discussion' %}
const currentSectionType = 'discussion';
{% elif step_title == 'Normative Pass - Questions' %}
const currentSectionType = 'questions';
{% elif step_title == 'Normative Pass - Conclusions' %}
const currentSectionType = 'conclusions';
{% elif step_title == 'Normative Pass - References' %}
const currentSectionType = 'references';
{% else %}
const currentSectionType = 'facts';
{% endif %}

// Track extraction status for Pass 2 (this section)
const extractionStatus = {
    principles: {{ 'true' if saved_prompts.principles and saved_prompts.principles.raw_response else 'false' }},
    obligations: {{ 'true' if saved_prompts.obligations and saved_prompts.obligations.raw_response else 'false' }},
    constraints: {{ 'true' if saved_prompts.constraints and saved_prompts.constraints.raw_response else 'false' }},
    capabilities: {{ 'true' if saved_prompts.capabilities and saved_prompts.capabilities.raw_response else 'false' }}
};

// Track if we've already shown the completion popup
let completionPopupShown = false;
let isInitialLoad = true;

function markExtractionComplete(conceptType) {
    extractionStatus[conceptType] = true;
    checkAllExtractionsComplete();
}

function checkAllExtractionsComplete() {
    const allComplete = extractionStatus.principles && extractionStatus.obligations &&
                       extractionStatus.constraints && extractionStatus.capabilities;

    if (allComplete && !isInitialLoad && !completionPopupShown) {
        showCompletionPopup();
        completionPopupShown = true;
    }
}

function showCompletionPopup() {
    // Determine next step based on current section
    const sectionName = '{{ section_display_name }}';
    {% if step_title == 'Normative Pass - Facts Section' %}
    const nextSectionUrl = '{{ url_for("scenario_pipeline.step2b", case_id=case.id) }}';
    const nextSectionText = 'Go to Discussion Section';
    const completionTitle = 'Facts Section Complete';
    {% elif step_title == 'Normative Pass - Discussion' %}
    const nextSectionUrl = '{{ url_for("scenario_pipeline.step3", case_id=case.id) }}';
    const nextSectionText = 'Go to Step 3';
    const completionTitle = 'Discussion Section Complete';
    {% elif step_title == 'Normative Pass - Questions' %}
    const nextSectionUrl = '{{ url_for("scenario_pipeline.step2d", case_id=case.id) }}';
    const nextSectionText = 'Go to Conclusions';
    const completionTitle = 'Questions Section Complete';
    {% elif step_title == 'Normative Pass - Conclusions' %}
    const nextSectionUrl = '{{ url_for("scenario_pipeline.step3", case_id=case.id) }}';
    const nextSectionText = 'Go to Step 3';
    const completionTitle = 'Conclusions Section Complete';
    {% else %}
    const nextSectionUrl = '{{ url_for("scenario_pipeline.step3", case_id=case.id) }}';
    const nextSectionText = 'Go to Step 3';
    const completionTitle = 'Section Complete';
    {% endif %}

    const modalHtml = `
        <div class="modal fade" id="pass2CompleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-check-circle-fill me-2"></i>${completionTitle}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <p class="mb-3">All four normative requirement types have been extracted from ${sectionName}:</p>
                        <div class="d-flex flex-wrap justify-content-center gap-2 mb-3">
                            <span class="badge bg-success fs-6"><i class="bi bi-stars me-1"></i> Principles</span>
                            <span class="badge bg-warning text-dark fs-6"><i class="bi bi-shield-check me-1"></i> Obligations</span>
                            <span class="badge bg-danger fs-6"><i class="bi bi-sign-stop me-1"></i> Constraints</span>
                            <span class="badge bg-info fs-6"><i class="bi bi-gear me-1"></i> Capabilities</span>
                        </div>
                        <p class="text-muted">You can proceed to the next section or review the extracted entities.</p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Stay Here
                        </button>
                        <a href="{{ url_for('entity_review.review_case_entities_pass2', case_id=case.id) }}" class="btn btn-info">
                            <i class="bi bi-list-check me-1"></i> Review Entities
                        </a>
                        <a href="${nextSectionUrl}" class="btn btn-success btn-lg">
                            <i class="bi bi-arrow-right-circle me-1"></i> ${nextSectionText}
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;

    if (!document.getElementById('pass2CompleteModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('pass2CompleteModal'));
        modal.show();
    }
}

// Detect navigation/redirect and fade out page smoothly
let navigationStarted = false;
const markNavigationStarted = () => {
    if (!navigationStarted) {
        navigationStarted = true;
        document.body.classList.add('navigating');
    }
};

// Detect normal navigation via beforeunload event
window.addEventListener('beforeunload', markNavigationStarted);

// Detect link clicks for smooth navigation
document.addEventListener('click', (e) => {
    const link = e.target.closest('a');
    if (link && link.href && !link.href.startsWith('javascript:')) {
        markNavigationStarted();
    }
});

// Load saved prompts on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load saved prompts for each concept type
    ['principles', 'obligations', 'constraints', 'capabilities'].forEach(conceptType => {
        loadSavedPrompt(conceptType);
    });

    // Mark initial load complete after a short delay
    setTimeout(() => { isInitialLoad = false; }, 100);
});

function loadSavedPrompt(conceptType) {
    appFetch(`/scenario_pipeline/case/${caseId}/step2/get_saved_prompt?concept_type=${conceptType}&section_type=${currentSectionType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.prompt_text) {
                // Show the prompt section and display the saved prompt
                const promptSection = document.getElementById(`${conceptType}PromptSection`);
                const promptText = document.getElementById(`${conceptType}PromptText`);

                promptSection.style.display = 'block';
                promptText.innerHTML = data.prompt_text;

                // If there's a saved raw response, display it
                if (data.raw_response) {
                    const resultsSection = document.getElementById(`${conceptType}Results`);
                    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);

                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = data.raw_response;
                    const escapedResponse = tempDiv.innerHTML;
                    resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapedResponse}</pre>`;

                    resultsSection.style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.log(`No saved prompt for ${conceptType}`, error);
        });
}

async function clearEntitiesForType(conceptType, sectionType) {
    // Clear existing entities for this concept type before re-extraction
    try {
        const response = await appFetch(`/scenario_pipeline/case/${caseId}/entities/clear_by_types`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                extraction_types: [conceptType],
                section_type: sectionType
            })
        });
        const data = await response.json();
        if (data.success) {
            console.log(`Cleared ${conceptType} entities: ${data.message}`);
        }
        return data;
    } catch (error) {
        console.error(`Error clearing ${conceptType} entities:`, error);
        return { success: false, error: error.message };
    }
}

async function extractIndividualConcept(conceptType) {
    const button = event.target.closest('button');
    const promptSection = document.getElementById(`${conceptType}PromptSection`);
    const promptText = document.getElementById(`${conceptType}PromptText`);
    const resultsSection = document.getElementById(`${conceptType}Results`);
    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting...';

    // Show prompt section with loading
    promptSection.style.display = 'block';
    promptText.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing request...</span>
            </div>
            <p class="mt-2">Request submitted, awaiting response...</p>
        </div>
    `;

    // Clear existing entities first
    await clearEntitiesForType(conceptType, currentSectionType);

    // Execute extraction using appFetch (handles 401 redirect)
    appFetch(`{{ url_for('scenario_pipeline.step2_extract_individual', case_id=case.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            concept_type: conceptType,
            section_text: currentSectionText,
            section_type: currentSectionType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display the prompt
            if (data.prompt) {
                const tempDiv = document.createElement('div');
                tempDiv.textContent = data.prompt;
                const escapedPrompt = tempDiv.innerHTML;
                promptText.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${escapedPrompt}</pre>`;
            } else {
                promptText.innerHTML = 'No prompt available';
            }

            // Display the raw LLM response
            if (data.raw_llm_response) {
                const tempDiv = document.createElement('div');
                tempDiv.textContent = data.raw_llm_response;
                const escapedResponse = tempDiv.innerHTML;
                resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapedResponse}</pre>`;
            } else {
                resultsContent.innerHTML = '<div class="alert alert-info">No response received from LLM</div>';
            }

            resultsSection.style.display = 'block';

            // Mark this extraction type as complete and check if all done
            markExtractionComplete(conceptType);
        } else {
            resultsContent.innerHTML = `<div class="alert alert-danger">${data.error || 'Extraction failed'}</div>`;
            resultsSection.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultsContent.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
        resultsSection.style.display = 'block';
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = `<i class="bi bi-play-fill"></i> Extract ${conceptType.charAt(0).toUpperCase() + conceptType.slice(1)}`;
    });
}

async function executeFullNormativePass() {
    const button = document.getElementById('normativePassBtn');
    button.disabled = true;
    button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Clearing & Extracting All...';

    // Clear all Pass 2 entities for current section first
    try {
        const response = await appFetch(`/scenario_pipeline/case/${caseId}/entities/clear_by_types`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                extraction_types: ['principles', 'obligations', 'constraints', 'capabilities'],
                section_type: currentSectionType
            })
        });
        const data = await response.json();
        if (data.success) {
            console.log(`Cleared all Pass 2 entities: ${data.message}`);
        }
    } catch (error) {
        console.error('Error clearing Pass 2 entities:', error);
    }

    // Run all four extractors in sequence
    Promise.all([
        extractConcept('principles'),
        extractConcept('obligations'),
        extractConcept('constraints'),
        extractConcept('capabilities')
    ])
    .then(results => {
        console.log('Full normative pass completed', results);
        // Completion popup will be shown by markExtractionComplete when all are done
    })
    .catch(error => {
        console.error('Error in full pass:', error);
        // Individual errors are shown in each section
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = `<i class="bi bi-arrow-right-circle"></i> Full Normative Requirements Pass
                           <small class="d-block">Extract All: Principles + Obligations + Constraints + Capabilities</small>`;
    });
}

function extractConcept(conceptType) {
    return new Promise((resolve, reject) => {
        appFetch(`{{ url_for('scenario_pipeline.step2_extract_individual', case_id=case.id) }}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                concept_type: conceptType,
                section_text: currentSectionText,
                section_type: currentSectionType
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI for this concept
                updateConceptUI(conceptType, data);
                resolve(data);
            } else {
                reject(new Error(data.error || `Failed to extract ${conceptType}`));
            }
        })
        .catch(reject);
    });
}

function updateConceptUI(conceptType, data) {
    const promptSection = document.getElementById(`${conceptType}PromptSection`);
    const promptText = document.getElementById(`${conceptType}PromptText`);
    const resultsSection = document.getElementById(`${conceptType}Results`);
    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);

    // Show prompt
    if (data.prompt) {
        promptSection.style.display = 'block';
        const tempDiv = document.createElement('div');
        tempDiv.textContent = data.prompt;
        promptText.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${tempDiv.innerHTML}</pre>`;
    }

    // Show results
    if (data.raw_llm_response) {
        resultsSection.style.display = 'block';
        const tempDiv = document.createElement('div');
        tempDiv.textContent = data.raw_llm_response;
        resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${tempDiv.innerHTML}</pre>`;

        // Mark this extraction type as complete (for Full Pass tracking)
        markExtractionComplete(conceptType);
    }
}
</script>
{% endblock %}