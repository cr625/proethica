{% extends "scenarios/base_step.html" %}

{# section_type defaults to 'facts' if not provided #}
{% set section_type = section_type | default('facts') %}
{% set section_label = 'Discussion' if section_type == 'discussion' else 'Facts' %}
{% set section_data = discussion_section if section_type == 'discussion' else facts_section %}
{% set step_suffix = 'b' if section_type == 'discussion' else '' %}

{% block step_title %}Step 1{{ step_suffix }}: Contextual Framework Pass - {{ section_label }} Section{% endblock %}
{% block step_header %}Step 1{{ step_suffix }}: Contextual Framework Pass ({{ section_label }}){% endblock %}
{% block step_subtitle %}Extract roles, states, and resources from the {{ section_label | lower }} section{% endblock %}

{% block head %}
{{ super() }}
<style>
    .extraction-progress {
        margin: 20px 0;
    }

    .extraction-item {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        border-left: 4px solid #dee2e6;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

    /* Concept-specific left borders (from CONCEPT_COLORS) */
    #rolesExtraction { border-left-color: #0d6efd; }
    #statesExtraction { border-left-color: #6f42c1; }
    #resourcesExtraction { border-left-color: #20c997; }

    .extraction-item.extracting {
        background-color: #fff3cd;
    }

    .extraction-item.success {
        background-color: #f8f9fa;
    }

    .extraction-item.error {
        background-color: #f8d7da;
        border-left-color: #dc3545;
    }

    /* Concept abbreviation badges */
    .extraction-item h5 .badge { vertical-align: middle; }

    .extraction-status {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .extraction-status .spinner-border {
        margin-right: 10px;
    }

    .extraction-results {
        margin-top: 10px;
        padding: 10px;
        background-color: white;
        border-radius: 4px;
        display: none;
    }

    .extraction-results.show {
        display: block;
    }

    .progress-indicator {
        margin: 20px 0;
    }

    .entity-count {
        display: inline-block;
        padding: 2px 8px;
        background-color: #007bff;
        color: white;
        border-radius: 12px;
        font-size: 0.9em;
        margin-left: 10px;
    }

    .retry-badge {
        display: inline-block;
        padding: 2px 8px;
        background-color: #ffc107;
        color: #212529;
        border-radius: 4px;
        font-size: 0.8em;
        margin-left: 10px;
    }

    .extraction-error {
        color: #dc3545;
        margin-top: 10px;
        padding: 10px;
        background-color: #f8d7da;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block step_navigation_bottom %}{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-{% if section_type == 'discussion' %}chat-left-text{% else %}file-text{% endif %}"></i> {{ section_label }} Section
        </h4>
    </div>
    <div class="step-content">
        {% if section_data %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="section-text" style="white-space: pre-wrap; word-wrap: break-word;">{{ section_data.llm_text }}</pre>
        </div>

        <!-- Enhanced Contextual Framework Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-3">
            <button id="contextualPassBtn" class="btn btn-primary btn-lg" onclick="executeStreamingPass()">
                <i class="bi bi-arrow-right-circle"></i> Full Contextual Framework Pass (Enhanced)
                <small class="d-block">Extract Roles + States + Resources with Real-time Updates</small>
            </button>
        </div>

        <!-- Progress Indicator (Hidden initially) -->
        <div id="progressIndicator" class="progress-indicator" style="display: none;">
            <div class="progress" style="height: 25px;">
                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                     role="progressbar" style="width: 0%">
                    <span id="progressText">Starting...</span>
                </div>
            </div>
        </div>

        <!-- Extraction Progress Container -->
        <div id="extractionProgress" class="extraction-progress" style="display: none;">

            <!-- Roles Extraction Item -->
            <div id="rolesExtraction" class="extraction-item">
                <div class="extraction-status">
                    <div id="rolesSpinner" class="spinner-border spinner-border-sm" style="display: none; color: #0d6efd;"></div>
                    <h5 class="mb-0">
                        <span class="badge" style="background-color: #0d6efd; font-size: 0.75em;">R</span> Roles Extraction
                        <span id="rolesCount" class="entity-count" style="display: none;"></span>
                        <span id="rolesRetry" class="retry-badge" style="display: none;"></span>
                    </h5>
                </div>
                <div id="rolesResults" class="extraction-results">
                    <!-- Results will be populated here -->
                </div>
                <div id="rolesError" class="extraction-error" style="display: none;">
                    <!-- Error message will be shown here -->
                </div>
            </div>

            <!-- States Extraction Item -->
            <div id="statesExtraction" class="extraction-item">
                <div class="extraction-status">
                    <div id="statesSpinner" class="spinner-border spinner-border-sm" style="display: none; color: #6f42c1;"></div>
                    <h5 class="mb-0">
                        <span class="badge" style="background-color: #6f42c1; font-size: 0.75em;">S</span> States Extraction
                        <span id="statesCount" class="entity-count" style="display: none;"></span>
                        <span id="statesRetry" class="retry-badge" style="display: none;"></span>
                    </h5>
                </div>
                <div id="statesResults" class="extraction-results">
                    <!-- Results will be populated here -->
                </div>
                <div id="statesError" class="extraction-error" style="display: none;">
                    <!-- Error message will be shown here -->
                </div>
            </div>

            <!-- Resources Extraction Item -->
            <div id="resourcesExtraction" class="extraction-item">
                <div class="extraction-status">
                    <div id="resourcesSpinner" class="spinner-border spinner-border-sm" style="display: none; color: #20c997;"></div>
                    <h5 class="mb-0">
                        <span class="badge" style="background-color: #20c997; font-size: 0.75em;">Rs</span> Resources Extraction
                        <span id="resourcesCount" class="entity-count" style="display: none;"></span>
                        <span id="resourcesRetry" class="retry-badge" style="display: none;"></span>
                    </h5>
                </div>
                <div id="resourcesResults" class="extraction-results">
                    <!-- Results will be populated here -->
                </div>
                <div id="resourcesError" class="extraction-error" style="display: none;">
                    <!-- Error message will be shown here -->
                </div>
            </div>
        </div>

        <!-- Summary Card (Hidden initially) -->
        <div id="summaryCard" class="step-card mt-4" style="display: none;">
            <div class="step-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle"></i> Extraction Complete
                </h5>
            </div>
            <div class="step-content" id="summaryContent">
                <!-- Summary will be displayed here -->
            </div>
        </div>

        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No {{ section_label | lower }} section found in this case.
        </div>
        {% endif %}
    </div>
</div>

<script>
// Store the current section text and type globally
const currentSectionText = `{{ section_data.llm_text if section_data else '' }}`;
const currentSectionType = '{{ section_type }}';

function executeStreamingPass() {
    const contextualBtn = document.getElementById('contextualPassBtn');
    const progressIndicator = document.getElementById('progressIndicator');
    const extractionProgress = document.getElementById('extractionProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    // Disable button and show progress
    contextualBtn.disabled = true;
    contextualBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting...';

    progressIndicator.style.display = 'block';
    extractionProgress.style.display = 'block';

    // Hide summary card from previous run
    document.getElementById('summaryCard').style.display = 'none';

    // Reset all extraction items and clear previous results
    ['roles', 'states', 'resources'].forEach(type => {
        document.getElementById(`${type}Extraction`).className = 'extraction-item';
        document.getElementById(`${type}Spinner`).style.display = 'none';
        document.getElementById(`${type}Count`).style.display = 'none';
        document.getElementById(`${type}Retry`).style.display = 'none';
        document.getElementById(`${type}Results`).classList.remove('show');
        document.getElementById(`${type}Results`).innerHTML = '';
        document.getElementById(`${type}Error`).style.display = 'none';
    });

    // Create EventSource for streaming
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // We need to use fetch with ReadableStream since EventSource doesn't support POST with body
    fetch(`{{ url_for('scenario_pipeline.entities_pass_execute_streaming', case_id=case.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            section_text: currentSectionText,
            section_type: currentSectionType
        })
    })
    .then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processStream() {
            reader.read().then(({ done, value }) => {
                if (done) {
                    return;
                }

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop(); // Keep incomplete line in buffer

                lines.forEach(line => {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));
                        handleStreamData(data);
                    }
                });

                processStream();
            });
        }

        processStream();
    })
    .catch(error => {
        console.error('Streaming error:', error);
        contextualBtn.disabled = false;
        contextualBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Full Contextual Framework Pass (Enhanced)';
        alert('Error during extraction: ' + error.message);
    });
}

function handleStreamData(data) {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    if (data.status === 'starting') {
        progressBar.style.width = '10%';
        progressText.textContent = 'Initializing...';

    } else if (data.status === 'extracting') {
        // Show spinner for current extraction
        const typeEl = document.getElementById(`${data.current}Extraction`);
        const spinner = document.getElementById(`${data.current}Spinner`);

        typeEl.classList.add('extracting');
        spinner.style.display = 'inline-block';

        // Update progress bar
        const percent = Math.round((data.progress / data.total) * 80) + 10;
        progressBar.style.width = percent + '%';
        progressText.textContent = `Extracting ${data.current} (${data.progress}/${data.total})`;

    } else if (data.status === 'extracted') {
        // Hide spinner and show results for extracted type
        const type = data.entity_type;
        const typeEl = document.getElementById(`${type}Extraction`);
        const spinner = document.getElementById(`${type}Spinner`);
        const resultsEl = document.getElementById(`${type}Results`);
        const countEl = document.getElementById(`${type}Count`);
        const retryEl = document.getElementById(`${type}Retry`);
        const errorEl = document.getElementById(`${type}Error`);

        spinner.style.display = 'none';

        if (data.result.success) {
            typeEl.classList.remove('extracting');
            typeEl.classList.add('success');

            // Show entity count
            let entityCount = 0;
            if (data.result.data) {
                if (data.result.data.classes) entityCount += data.result.data.classes.length;
                if (data.result.data.individuals) entityCount += data.result.data.individuals.length;
                if (data.result.data.resources) entityCount += data.result.data.resources.length;
                if (data.result.data.states) entityCount += data.result.data.states.length;
            }

            countEl.textContent = entityCount + ' entities';
            countEl.style.display = 'inline-block';

            // Show retry count if retries were needed
            if (data.result.retry_count > 0) {
                retryEl.textContent = `${data.result.retry_count} retries`;
                retryEl.style.display = 'inline-block';
            }

            // Display results
            displayExtractionResults(type, data.result.data);
            resultsEl.classList.add('show');

        } else {
            typeEl.classList.remove('extracting');
            typeEl.classList.add('error');
            errorEl.textContent = 'Error: ' + data.result.error;
            errorEl.style.display = 'block';
        }

        // Update progress bar
        const percent = Math.round((data.progress / data.total) * 80) + 10;
        progressBar.style.width = percent + '%';
        progressText.textContent = `Completed ${type} (${data.progress}/${data.total})`;

    } else if (data.status === 'complete') {
        // Show summary
        progressBar.style.width = '100%';
        progressText.textContent = 'Complete!';
        progressBar.classList.remove('progress-bar-animated');

        displaySummary(data.summary, data.session_id);

        // Re-enable button
        const contextualBtn = document.getElementById('contextualPassBtn');
        contextualBtn.disabled = false;
        contextualBtn.innerHTML = '<i class="bi bi-check-circle"></i> Extraction Complete - Run Again';

    } else if (data.status === 'error') {
        // Handle error
        progressBar.classList.add('bg-danger');
        progressText.textContent = 'Error: ' + data.error;

        const contextualBtn = document.getElementById('contextualPassBtn');
        contextualBtn.disabled = false;
        contextualBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Full Contextual Framework Pass (Enhanced)';
    }
}

// Canonical concept colors from CONCEPT_COLORS
const CONCEPT_COLORS = {
    'roles': '#0d6efd', 'states': '#6f42c1', 'resources': '#20c997',
    'principles': '#fd7e14', 'obligations': '#dc3545',
    'constraints': '#6c757d', 'capabilities': '#0dcaf0',
    'actions': '#198754', 'events': '#ffc107'
};

function confidenceBadge(confidence) {
    if (!confidence) return '';
    const pct = (confidence * 100).toFixed(0);
    let cls = 'bg-secondary';
    if (confidence >= 0.90) cls = 'bg-success';
    else if (confidence >= 0.75) cls = 'bg-warning text-dark';
    else if (confidence > 0) cls = 'bg-danger';
    return `<span class="badge ${cls}" style="font-size:0.75em;">${pct}%</span>`;
}

function matchBadge(matchedLabel, confidence) {
    if (!matchedLabel) return '<span class="badge bg-secondary" style="font-size:0.75em;">New</span>';
    if (confidence >= 0.90) return `<span class="badge bg-success" style="font-size:0.75em;">Linked: ${matchedLabel}</span>`;
    return `<span class="badge bg-warning text-dark" style="font-size:0.75em;">Review: ${matchedLabel}</span>`;
}

function displayExtractionResults(type, data) {
    const resultsEl = document.getElementById(`${type}Results`);
    let html = '';

    if (!data) {
        resultsEl.innerHTML = '<p class="text-muted">No entities found</p>';
        return;
    }

    const typeLabel = type.charAt(0).toUpperCase() + type.slice(1);
    const color = CONCEPT_COLORS[type] || '#6c757d';
    // Lighter variant for individuals (30% opacity)
    const indColor = color + '80';

    if (data.classes && data.classes.length > 0) {
        html += `<div class="mb-3" style="border-left: 3px solid ${color}; padding-left: 10px;">`;
        html += `<h6 style="color: ${color};" class="mb-2"><i class="bi bi-diagram-2"></i> ${typeLabel} Classes (${data.classes.length})</h6>`;
        data.classes.forEach(cls => {
            const conf = cls.confidence || 0;
            const matched = cls.matched_ontology_label || '';
            html += `<div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">`;
            html += `<strong>${cls.label}</strong> ${confidenceBadge(conf)} ${matchBadge(matched, conf)}`;
            if (cls.definition) html += `<br/><small class="text-muted">${cls.definition}</small>`;
            html += `</div>`;
        });
        html += `</div>`;
    }

    if (data.individuals && data.individuals.length > 0) {
        html += `<div class="mb-2" style="border-left: 3px solid ${indColor}; padding-left: 10px;">`;
        html += `<h6 style="color: ${color}; opacity: 0.7;" class="mb-2"><i class="bi bi-person"></i> Individuals (${data.individuals.length})</h6>`;
        data.individuals.forEach(ind => {
            const label = ind.name || ind.label || ind.identifier || '';
            const conf = ind.confidence || 0;
            const matched = ind.matched_ontology_label || '';
            html += `<div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">`;
            html += `<strong>${label}</strong> ${confidenceBadge(conf)} ${matchBadge(matched, conf)}`;
            if (ind.definition) html += `<br/><small class="text-muted">${ind.definition}</small>`;
            html += `</div>`;
        });
        html += `</div>`;
    }

    resultsEl.innerHTML = html || '<p class="text-muted">No entities found</p>';
}

// Load existing extraction results on page load
(function() {
    const existing = {{ existing_extractions | default({}) | tojson }};
    if (Object.keys(existing).length === 0) return;

    // Show the progress container
    document.getElementById('extractionProgress').style.display = 'block';

    for (const [type, data] of Object.entries(existing)) {
        // Show entity count
        const countEl = document.getElementById(`${type}Count`);
        const entityCount = (data.classes ? data.classes.length : 0) +
                           (data.individuals ? data.individuals.length : 0);
        countEl.textContent = entityCount + ' entities';
        countEl.style.display = 'inline-block';

        // Mark as completed
        const typeEl = document.getElementById(`${type}Extraction`);
        typeEl.classList.add('success');

        // Display results
        displayExtractionResults(type, data);
        document.getElementById(`${type}Results`).classList.add('show');
    }

    // Show summary card if all 3 concepts have results
    if (existing.roles && existing.states && existing.resources) {
        const totalEntities = Object.values(existing).reduce((sum, d) => {
            return sum + (d.classes ? d.classes.length : 0) + (d.individuals ? d.individuals.length : 0);
        }, 0);
        displaySummary({
            total_success: Object.keys(existing).length,
            total_failed: 0,
            total_entities: totalEntities
        }, 'previous');
    }
})();

function displaySummary(summary, sessionId) {
    const summaryCard = document.getElementById('summaryCard');
    const summaryContent = document.getElementById('summaryContent');

    summaryCard.style.display = 'block';
    summaryContent.innerHTML = `
        <div class="row">
            <div class="col-md-4">
                <div class="text-center">
                    <h3 class="text-success">${summary.total_success}</h3>
                    <p>Successful Extractions</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h3 class="text-primary">${summary.total_entities}</h3>
                    <p>Total Entities Found</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="text-center">
                    <h3 class="text-danger">${summary.total_failed}</h3>
                    <p>Failed Extractions</p>
                </div>
            </div>
        </div>
        <hr>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <a href="{{ url_for('entity_review.review_case_entities', case_id=case.id, section_type=section_type) }}" class="btn btn-primary btn-lg">
                <i class="bi bi-eye"></i> Review Extraction
            </a>
            <a href="{{ url_for('provenance.case_provenance', case_id=case.id, step=1) }}"
               class="btn btn-outline-secondary btn-lg" target="_blank" title="View provenance (opens in new tab)">
                <i class="bi bi-diagram-3"></i> Provenance <i class="bi bi-box-arrow-up-right" style="font-size: 0.7em;"></i>
            </a>
        </div>
    `;
}
</script>
{% endblock %}