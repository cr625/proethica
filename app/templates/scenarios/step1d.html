{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 1d: Contextual Framework Pass - Conclusions Section{% endblock %}
{% block step_header %}Step 1d: Contextual Framework Pass (Conclusions){% endblock %}
{% block step_subtitle %}Extract roles, states, and resources from the conclusions section{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.step1c', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Questions
    </a>
    <a href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}" class="btn btn-outline-primary">
        Step 2: Normative Pass (Facts) <i class="bi bi-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-check-circle"></i> Conclusions Section
        </h4>
    </div>
    <div class="step-content">
        {% if conclusions_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="discussion-text">{{ conclusions_section.llm_text }}</pre>
        </div>

        <!-- Full Contextual Framework Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
            <button id="contextualPassBtn" class="btn btn-primary btn-lg" onclick="executeFullContextualPass()">
                <i class="bi bi-arrow-right-circle"></i> Full Contextual Framework Pass
                <small class="d-block">Extract All: Roles + States + Resources</small>
            </button>
        </div>

        <!-- Individual Extractor Sections -->

        <!-- ROLES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="rolesSection">
            <div class="step-card border-info">
                <div class="step-header bg-info bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge text-info"></i> Roles Extraction
                        </h5>
                        <button class="btn btn-info btn-sm" onclick="tagReferencedEntities('roles')">
                            <i class="bi bi-play-fill"></i> Tag Referenced Roles
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <!-- Roles Prompt Preview -->
                    <div class="prompt-preview mb-3" id="rolesPromptSection" style="{% if saved_prompts.roles and saved_prompts.roles is mapping and (saved_prompts.roles.matching or saved_prompts.roles.extraction) %}{% else %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompts</h6>
                            <button class="btn btn-outline-secondary btn-sm" onclick="regenerateConceptPrompt('roles')">
                                <i class="bi bi-arrow-clockwise"></i> Regenerate
                            </button>
                        </div>
                        <div class="prompt-text" id="rolesPromptText">
{%- if saved_prompts.roles and saved_prompts.roles is mapping -%}
{%- if saved_prompts.roles.matching -%}
<div class="mb-3">
<h6 class="text-primary"><i class="bi bi-1-circle"></i> Entity Matching Prompt</h6>
<small class="text-muted">Matches entities from Facts/Discussion/Questions to Conclusions section</small>
<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">{{ saved_prompts.roles.matching.prompt_text }}</pre>
<small class="text-muted">Saved: {{ saved_prompts.roles.matching.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
</div>
{%- endif -%}
{%- if saved_prompts.roles.extraction -%}
<div class="mb-3 border-top pt-3">
<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Prompt</h6>
<small class="text-muted">Extracts NEW entities not found in Facts/Discussion</small>
<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">{{ saved_prompts.roles.extraction.prompt_text }}</pre>
<small class="text-muted">Saved: {{ saved_prompts.roles.extraction.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
</div>
{%- endif -%}
{%- else -%}
<div class="text-center text-muted">
<i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Tag Referenced Roles
</div>
{%- endif -%}
                        </div>
                    </div>

                    <!-- Roles Results -->
                    <div class="results-preview" id="rolesResults" style="{% if saved_prompts.roles and saved_prompts.roles is mapping and (saved_prompts.roles.matching or saved_prompts.roles.extraction) %}{% else %}display: none;{% endif %}">
                        <h6><i class="bi bi-check-circle text-success"></i> LLM Responses</h6>
                        <div id="rolesResultsContent">
{%- if saved_prompts.roles and saved_prompts.roles is mapping -%}
{%- if saved_prompts.roles.matching and saved_prompts.roles.matching.raw_response -%}
<div class="mb-3">
<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rolesMatchingResponseCollapse">
<i class="bi bi-code-square"></i> Show Matching Response
</button>
<div class="collapse mt-2" id="rolesMatchingResponseCollapse">
<h6 class="text-primary"><i class="bi bi-1-circle"></i> Matching Response</h6>
<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">{{ saved_prompts.roles.matching.raw_response }}</pre>
</div>
</div>
{%- endif -%}
{%- if saved_prompts.roles.extraction and saved_prompts.roles.extraction.raw_response -%}
<div class="mb-3">
<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#rolesExtractionResponseCollapse">
<i class="bi bi-code-square"></i> Show Extraction Response
</button>
<div class="collapse mt-2" id="rolesExtractionResponseCollapse">
<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Response</h6>
<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #fff8e1; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">{{ saved_prompts.roles.extraction.raw_response }}</pre>
</div>
</div>
{%- endif -%}
{%- endif -%}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="statesSection">
            <div class="step-card border-warning">
                <div class="step-header bg-warning bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3 text-warning"></i> States Extraction
                        </h5>
                        <button class="btn btn-warning btn-sm" onclick="tagReferencedEntities('states')">
                            <i class="bi bi-play-fill"></i> Tag Referenced States
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <!-- States Prompt Preview -->
                    <div class="prompt-preview mb-3" id="statesPromptSection" style="{% if saved_prompts.states and saved_prompts.states is mapping and (saved_prompts.states.matching or saved_prompts.states.extraction) %}{% else %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompts</h6>
                            <button class="btn btn-outline-secondary btn-sm" onclick="regenerateConceptPrompt('states')">
                                <i class="bi bi-arrow-clockwise"></i> Regenerate
                            </button>
                        </div>
                        <div class="prompt-text" id="statesPromptText">
{%- if saved_prompts.states and saved_prompts.states is mapping -%}
{%- if saved_prompts.states.matching -%}
<div class="mb-3">
<h6 class="text-primary"><i class="bi bi-1-circle"></i> Entity Matching Prompt</h6>
<small class="text-muted">Matches entities from Facts/Discussion/Questions to Conclusions section</small>
<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">{{ saved_prompts.states.matching.prompt_text }}</pre>
<small class="text-muted">Saved: {{ saved_prompts.states.matching.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
</div>
{%- endif -%}
{%- if saved_prompts.states.extraction -%}
<div class="mb-3 border-top pt-3">
<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Prompt</h6>
<small class="text-muted">Extracts NEW entities not found in Facts/Discussion</small>
<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">{{ saved_prompts.states.extraction.prompt_text }}</pre>
<small class="text-muted">Saved: {{ saved_prompts.states.extraction.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
</div>
{%- endif -%}
{%- else -%}
<div class="text-center text-muted">
<i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Tag Referenced States
</div>
{%- endif -%}
                        </div>
                    </div>

                    <!-- States Results -->
                    <div class="results-preview" id="statesResults" style="{% if saved_prompts.states and saved_prompts.states is mapping and (saved_prompts.states.matching or saved_prompts.states.extraction) %}{% else %}display: none;{% endif %}">
                        <h6><i class="bi bi-check-circle text-success"></i> LLM Responses</h6>
                        <div id="statesResultsContent">
{%- if saved_prompts.states and saved_prompts.states is mapping -%}
{%- if saved_prompts.states.matching and saved_prompts.states.matching.raw_response -%}
<div class="mb-3">
<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#statesMatchingResponseCollapse">
<i class="bi bi-code-square"></i> Show Matching Response
</button>
<div class="collapse mt-2" id="statesMatchingResponseCollapse">
<h6 class="text-primary"><i class="bi bi-1-circle"></i> Matching Response</h6>
<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">{{ saved_prompts.states.matching.raw_response }}</pre>
</div>
</div>
{%- endif -%}
{%- if saved_prompts.states.extraction and saved_prompts.states.extraction.raw_response -%}
<div class="mb-3">
<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#statesExtractionResponseCollapse">
<i class="bi bi-code-square"></i> Show Extraction Response
</button>
<div class="collapse mt-2" id="statesExtractionResponseCollapse">
<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Response</h6>
<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #fff8e1; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">{{ saved_prompts.states.extraction.raw_response }}</pre>
</div>
</div>
{%- endif -%}
{%- endif -%}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESOURCES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="resourcesSection">
            <div class="step-card border-success">
                <div class="step-header bg-success bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-box-seam text-success"></i> Resources Extraction
                        </h5>
                        <button class="btn btn-success btn-sm" onclick="tagReferencedEntities('resources')">
                            <i class="bi bi-play-fill"></i> Tag Referenced Resources
                        </button>
                    </div>
                </div>
                <div class="step-content">
                    <!-- Resources Prompt Preview -->
                    <div class="prompt-preview mb-3" id="resourcesPromptSection" style="{% if saved_prompts.resources and saved_prompts.resources is mapping and (saved_prompts.resources.matching or saved_prompts.resources.extraction) %}{% else %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompts</h6>
                            <button class="btn btn-outline-secondary btn-sm" onclick="regenerateConceptPrompt('resources')">
                                <i class="bi bi-arrow-clockwise"></i> Regenerate
                            </button>
                        </div>
                        <div class="prompt-text" id="resourcesPromptText">
{%- if saved_prompts.resources and saved_prompts.resources is mapping -%}
{%- if saved_prompts.resources.matching -%}
<div class="mb-3">
<h6 class="text-primary"><i class="bi bi-1-circle"></i> Entity Matching Prompt</h6>
<small class="text-muted">Matches entities from Facts/Discussion/Questions to Conclusions section</small>
<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">{{ saved_prompts.resources.matching.prompt_text }}</pre>
<small class="text-muted">Saved: {{ saved_prompts.resources.matching.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
</div>
{%- endif -%}
{%- if saved_prompts.resources.extraction -%}
<div class="mb-3 border-top pt-3">
<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Prompt</h6>
<small class="text-muted">Extracts NEW entities not found in Facts/Discussion</small>
<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">{{ saved_prompts.resources.extraction.prompt_text }}</pre>
<small class="text-muted">Saved: {{ saved_prompts.resources.extraction.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
</div>
{%- endif -%}
{%- else -%}
<div class="text-center text-muted">
<i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Tag Referenced Resources
</div>
{%- endif -%}
                        </div>
                    </div>

                    <!-- Resources Results -->
                    <div class="results-preview" id="resourcesResults" style="{% if saved_prompts.resources and saved_prompts.resources is mapping and (saved_prompts.resources.matching or saved_prompts.resources.extraction) %}{% else %}display: none;{% endif %}">
                        <h6><i class="bi bi-check-circle text-success"></i> LLM Responses</h6>
                        <div id="resourcesResultsContent">
{%- if saved_prompts.resources and saved_prompts.resources is mapping -%}
{%- if saved_prompts.resources.matching and saved_prompts.resources.matching.raw_response -%}
<div class="mb-3">
<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#resourcesMatchingResponseCollapse">
<i class="bi bi-code-square"></i> Show Matching Response
</button>
<div class="collapse mt-2" id="resourcesMatchingResponseCollapse">
<h6 class="text-primary"><i class="bi bi-1-circle"></i> Matching Response</h6>
<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">{{ saved_prompts.resources.matching.raw_response }}</pre>
</div>
</div>
{%- endif -%}
{%- if saved_prompts.resources.extraction and saved_prompts.resources.extraction.raw_response -%}
<div class="mb-3">
<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#resourcesExtractionResponseCollapse">
<i class="bi bi-code-square"></i> Show Extraction Response
</button>
<div class="collapse mt-2" id="resourcesExtractionResponseCollapse">
<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Response</h6>
<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #fff8e1; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">{{ saved_prompts.resources.extraction.raw_response }}</pre>
</div>
</div>
{%- endif -%}
{%- endif -%}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Link Questions to Conclusions Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            <button id="linkQuestionsBtn" class="btn btn-success btn-lg" onclick="linkQuestionsToConclusions()">
                <i class="bi bi-link-45deg"></i> Link Questions to Conclusions
                <small class="d-block">Map which conclusion answers which question</small>
            </button>
        </div>

        <!-- Question→Conclusion Links Results -->
        <div id="qcLinksResults" class="mt-4" style="{% if question_conclusion_links %}display: block;{% else %}display: none;{% endif %}">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-link-45deg"></i> Question→Conclusion Relationships
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success" id="qcLinksStats">
                        {% if question_conclusion_links %}
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-check-circle-fill"></i>
                                <strong>Successfully linked {{ question_conclusion_links|length }} question(s) to conclusion(s)</strong>
                            </div>
                            <div>
                                <span class="badge bg-success">Average Confidence: {{ (question_conclusion_links|sum(attribute='confidence') / question_conclusion_links|length * 100)|round(0)|int }}%</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <div id="qcLinksList" class="list-group">
                        {% if question_conclusion_links %}
                            {% for link in question_conclusion_links %}
                            <div class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1 text-primary">
                                        <i class="bi bi-{{ link.question_number }}-circle"></i>
                                        Question {{ link.question_number }}
                                    </h6>
                                    <span class="badge bg-success">{{ (link.confidence * 100)|round(0)|int }}% confidence</span>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-primary">Question:</strong>
                                    <p class="mb-1 ms-3">{{ link.question_text }}</p>
                                </div>
                                <div class="mb-2">
                                    <strong class="text-success">Conclusion:</strong>
                                    <p class="mb-1 ms-3">{{ link.conclusion_text }}</p>
                                </div>
                                <div class="text-muted small">
                                    <i class="bi bi-info-circle"></i> {{ link.reasoning }}
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation to entity review -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-3">
            <a href="{{ url_for('entity_review.review_case_entities', case_id=case.id, section_type='conclusions') }}" class="btn btn-outline-primary">
                <i class="bi bi-eye"></i> Review Pass 1 Entities (Conclusions Section)
            </a>
        </div>

        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No facts section found in this case. Using first available section.
        </div>
        {% endif %}
    </div>
</div>

<!-- Navigation to NSPE References Section -->
<div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4 mb-4">
    <a href="{{ url_for('scenario_pipeline.step1e', case_id=case.id) }}" class="btn btn-primary btn-lg">
        Continue to Step 1e: NSPE References <i class="bi bi-arrow-right"></i>
    </a>
</div>

{% endblock %}

{% block step_styles %}
<style>
    .discussion-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: none;
        margin: 0;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .extractor-section .step-card {
        transition: all 0.3s ease;
    }

    .extractor-section .step-card:hover {
        box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
    }

    .prompt-preview {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .prompt-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: white;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
    }

    .results-preview {
        background-color: #f0fff4;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #d4edda;
    }

    /* Contextual Framework Pass Button Styling */
    #contextualPassBtn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    #contextualPassBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .entity-item {
        background: white;
        border-left: 3px solid #4e73df;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.25rem;
    }

    .entity-label {
        font-weight: bold;
        color: #2e59d9;
    }

    .entity-description {
        color: #5a5c69;
        margin-top: 0.25rem;
        font-size: 0.9rem;
    }

    .entity-confidence {
        color: #858796;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
const caseId = {{ case.id }};
const currentSectionText = `{{ conclusions_section.llm_text if conclusions_section else '' }}`;

// Helper function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// For Questions section, we DON'T load saved extraction prompts
// Instead, prompts are generated on-demand when user clicks "Tag Referenced..."
document.addEventListener('DOMContentLoaded', function() {
    // Show placeholder text ONLY if no saved prompts exist
    ['roles', 'states', 'resources'].forEach(conceptType => {
        const promptText = document.getElementById(`${conceptType}PromptText`);
        const promptSection = document.getElementById(`${conceptType}PromptSection`);

        // Only show placeholder if the section is hidden (no saved prompts)
        if (promptText && promptSection && promptSection.style.display === 'none') {
            promptText.innerHTML = '<div class="text-center text-muted p-3"><i class="bi bi-info-circle"></i> Click "Tag Referenced ' + conceptType.charAt(0).toUpperCase() + conceptType.slice(1) + '" to generate matching prompt</div>';
        }
    });
});

function loadSavedPrompt(conceptType) {
    // This function is not used in Questions section
    // Keeping it for compatibility but it won't be called
    fetch(`/scenario_pipeline/case/${caseId}/step1/get_saved_prompt?concept_type=${conceptType}&section_type=conclusions`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.prompt_text) {
                // Show the prompt section and display the saved prompt
                const promptSection = document.getElementById(`${conceptType}PromptSection`);
                const promptText = document.getElementById(`${conceptType}PromptText`);

                promptSection.style.display = 'block';
                promptText.innerHTML = data.prompt_text;

                // If there's a saved raw response, display it in the results section
                if (data.raw_response) {
                    const resultsSection = document.getElementById(`${conceptType}Results`);
                    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);

                    // Display the raw response
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = data.raw_response;
                    const escapedResponse = tempDiv.innerHTML;
                    resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapedResponse}</pre>`;

                    // Show the results section
                    resultsSection.style.display = 'block';
                }

                // Timestamp is already shown in the template, no need to add it here
            }
        })
        .catch(error => {
            console.log(`No saved prompt for ${conceptType}`, error);
        });
}

function extractIndividualConcept(conceptType) {
    const button = event.target.closest('button');
    const promptSection = document.getElementById(`${conceptType}PromptSection`);
    const promptText = document.getElementById(`${conceptType}PromptText`);
    const resultsSection = document.getElementById(`${conceptType}Results`);
    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting...';

    // Show prompt section with loading
    promptSection.style.display = 'block';
    promptText.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Generating prompt...</span>
            </div>
            <p class="mt-2">Generating prompt and extracting ${conceptType}...</p>
        </div>
    `;

    // Execute extraction using discussion-specific route
    fetch(`/scenario_pipeline/case/${caseId}/step1/extract_individual`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            concept_type: conceptType,
            section_text: currentSectionText,
            section_type: 'conclusions'  // Mark as Conclusions section
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display the prompt (should be the prompt sent TO the LLM)
            if (data.prompt) {
                // Escape HTML and display as preformatted text
                const tempDiv = document.createElement('div');
                tempDiv.textContent = data.prompt;
                const escapedPrompt = tempDiv.innerHTML;
                promptText.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${escapedPrompt}</pre>`;
            } else {
                promptText.innerHTML = 'No prompt available';
            }

            // Display the raw LLM response directly in the results section
            if (data.raw_llm_response) {
                // Simply display the raw response as-is
                const tempDiv = document.createElement('div');
                tempDiv.textContent = data.raw_llm_response;
                const escapedResponse = tempDiv.innerHTML;
                resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapedResponse}</pre>`;
            } else {
                resultsContent.innerHTML = '<div class="alert alert-info">No response received from LLM</div>';
            }

            // Show results section
            resultsSection.style.display = 'block';
        } else {
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Error: ${data.error}
                </div>
            `;
            resultsSection.style.display = 'block';
        }
    })
    .catch(error => {
        resultsContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Network error: ${error.message}
            </div>
        `;
        resultsSection.style.display = 'block';
    })
    .finally(() => {
        // Re-enable button with appropriate icon
        const iconClass = conceptType === 'roles' ? 'person-badge' :
                         conceptType === 'states' ? 'diagram-3' : 'box-seam';
        const btnClass = conceptType === 'roles' ? 'info' :
                        conceptType === 'states' ? 'warning' : 'success';
        button.disabled = false;
        button.innerHTML = `<i class="bi bi-play-fill"></i> Extract ${conceptType.charAt(0).toUpperCase() + conceptType.slice(1)}`;
    });
}

function displayConceptResults(conceptType, data) {
    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);
    let html = '';

    if (conceptType === 'roles' && (data.role_classes || data.individuals)) {
        // Display role classes
        if (data.role_classes && data.role_classes.length > 0) {
            html += `<h6>Role Classes (${data.role_classes.length})</h6>`;
            data.role_classes.forEach(role => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${role.label}</div>
                        ${role.description ? `<div class="entity-description">${role.description}</div>` : ''}
                        <div class="entity-confidence">Confidence: ${(role.confidence * 100).toFixed(0)}%</div>
                    </div>
                `;
            });
        }

        // Display individuals
        if (data.individuals && data.individuals.length > 0) {
            html += `<h6 class="mt-3">Individuals (${data.individuals.length})</h6>`;
            data.individuals.forEach(individual => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${individual.name}</div>
                        ${individual.role_class ? `<div class="entity-description">Role: ${individual.role_class}</div>` : ''}
                        ${individual.case_involvement ? `<div class="entity-description">${individual.case_involvement}</div>` : ''}
                    </div>
                `;
            });
        }

        if (!data.role_classes && !data.individuals) {
            html = `
                <div class="alert alert-warning">
                    No roles extracted from this section.
                </div>
            `;
        }
    } else if (conceptType === 'states' && (data.state_classes || data.state_individuals)) {
        // Display state classes
        if (data.state_classes && data.state_classes.length > 0) {
            html += `<h6>State Classes (${data.state_classes.length})</h6>`;
            data.state_classes.forEach(state => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${state.label}</div>
                        ${state.description ? `<div class="entity-description">${state.description}</div>` : ''}
                        ${state.persistence_type ? `<div class="entity-description"><small>Persistence: ${state.persistence_type}</small></div>` : ''}
                        <div class="entity-confidence">Confidence: ${(state.confidence * 100).toFixed(0)}%</div>
                    </div>
                `;
            });
        }

        // Display state individuals
        if (data.state_individuals && data.state_individuals.length > 0) {
            html += `<h6 class="mt-3">State Instances (${data.state_individuals.length})</h6>`;
            data.state_individuals.forEach(individual => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${individual.identifier}</div>
                        ${individual.state_class ? `<div class="entity-description">Type: ${individual.state_class}</div>` : ''}
                        ${individual.active_period ? `<div class="entity-description">Active: ${individual.active_period}</div>` : ''}
                        ${individual.triggering_event ? `<div class="entity-description">Triggered by: ${individual.triggering_event}</div>` : ''}
                    </div>
                `;
            });
        }

        if (!data.state_classes && !data.state_individuals) {
            html = `
                <div class="alert alert-warning">
                    No states extracted from this section.
                </div>
            `;
        }
    } else if (data.results && data.results.length > 0) {
        html += `<h6>${conceptType.charAt(0).toUpperCase() + conceptType.slice(1)} (${data.results.length})</h6>`;
        data.results.forEach(item => {
            html += `
                <div class="entity-item">
                    <div class="entity-label">${item.label}</div>
                    ${item.description ? `<div class="entity-description">${item.description}</div>` : ''}
                    <div class="entity-confidence">Confidence: ${(item.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        });
    } else {
        html = `
            <div class="alert alert-warning">
                No ${conceptType} extracted from this section.
            </div>
        `;
    }

    // Add metadata
    if (data.metadata) {
        html += `
            <div class="mt-3 text-muted small">
                <strong>Model:</strong> ${data.metadata.model || 'Unknown'} |
                <strong>Method:</strong> ${data.metadata.extraction_method || 'Unknown'}
            </div>
        `;
    }

    resultsContent.innerHTML = html;
}

function regenerateConceptPrompt(conceptType) {
    // Clear the saved prompt and regenerate
    const promptText = document.getElementById(`${conceptType}PromptText`);

    // Show loading
    promptText.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Regenerating prompt...</span>
            </div>
            <p class="mt-2">Regenerating ${conceptType} prompt...</p>
        </div>
    `;

    // Clear results if any
    const resultsSection = document.getElementById(`${conceptType}Results`);
    resultsSection.style.display = 'none';

    // Trigger extraction which will generate a new prompt
    extractIndividualConcept(conceptType);
}

function executeFullContextualPass() {
    // Execute all three extractions
    ['roles', 'states', 'resources'].forEach(conceptType => {
        // Simulate button click for each
        const button = document.querySelector(`#${conceptType}Section button`);
        if (button) {
            button.click();
        }
    });
}

// Tag Referenced Entities (instead of extracting new ones)
function tagReferencedEntities(entityType) {
    console.log('Tagging referenced ' + entityType + '...');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Tagging...';

    fetch('/scenario_pipeline/case/' + caseId + '/tag_entities_in_conclusions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            conclusions_text: currentSectionText,
            entity_type: entityType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display the matching prompt in the prompt section
            const promptSection = document.getElementById(`${entityType}PromptSection`);
            const promptText = document.getElementById(`${entityType}PromptText`);

            if (data.matching_prompt) {
                promptSection.style.display = 'block';
                let promptHtml = '<div class="mb-3">';
                promptHtml += '<h6 class="text-primary"><i class="bi bi-1-circle"></i> Entity Matching Prompt</h6>';
                promptHtml += '<small class="text-muted">Matches entities from Facts/Discussion/Questions to Conclusions section</small>';
                promptHtml += `<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">${escapeHtml(data.matching_prompt)}</pre>`;
                promptHtml += '</div>';

                // If there's also an extraction prompt for NEW entities, show it
                if (data.extraction_prompt) {
                    promptHtml += '<div class="mb-3 border-top pt-3">';
                    promptHtml += '<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Prompt</h6>';
                    promptHtml += '<small class="text-muted">Extracts NEW entities not found in Facts/Discussion</small>';
                    promptHtml += `<pre style="white-space: pre-wrap; word-wrap: break-word; margin-top: 0.5rem;">${escapeHtml(data.extraction_prompt)}</pre>`;
                    promptHtml += '</div>';
                }

                promptText.innerHTML = promptHtml;
            }

            // Display the LLM response and matches
            const resultsSection = document.getElementById(`${entityType}Results`);
            const resultsContent = document.getElementById(`${entityType}ResultsContent`);

            let html = '<div class="mb-3">';
            html += `<h6><i class="bi bi-check-circle text-success"></i> Tagged ${data.stats.total_matches} ${entityType}</h6>`;

            // Show matches summary
            html += '<div class="alert alert-success">';
            html += `<strong>Matched Entities:</strong> ${data.stats.total_matches} total<br>`;
            html += `<strong>From Facts:</strong> ${data.stats.from_facts}<br>`;
            html += `<strong>From Discussion:</strong> ${data.stats.from_discussion}<br>`;
            html += `<strong>From Questions:</strong> ${data.stats.from_questions}<br>`;
            if (data.stats.total_new_entities > 0) {
                html += `<strong class="text-warning">NEW Entities Found:</strong> ${data.stats.total_new_entities} (not in Facts/Discussion/Questions)<br>`;
            }
            html += `<strong>Avg Confidence:</strong> ${(data.stats.avg_confidence * 100).toFixed(1)}%`;
            html += '</div>';

            // Show individual matches
            if (data.matches && data.matches.length > 0) {
                html += '<h6 class="mt-3"><i class="bi bi-link-45deg"></i> Matched Entities (from Facts/Discussion/Questions):</h6>';
                data.matches.forEach(match => {
                    html += '<div class="entity-item">';
                    html += `<div class="entity-label">${escapeHtml(match.label)}</div>`;
                    // Only show "Mentioned as" if we have actual mention text
                    if (match.mention && match.mention.trim()) {
                        html += `<div class="entity-description"><strong>Mentioned as:</strong> "${escapeHtml(match.mention)}"</div>`;
                    }
                    html += `<div class="entity-description"><strong>Source:</strong> ${match.source_section} section</div>`;
                    html += `<div class="entity-confidence">Confidence: ${(match.confidence * 100).toFixed(0)}%</div>`;
                    html += '</div>';
                });
            }

            // Show NEW entities identified in Conclusions
            if (data.new_entities && data.new_entities.length > 0) {
                html += '<h6 class="mt-4"><i class="bi bi-star text-warning"></i> NEW Entities (not in Facts/Discussion/Questions):</h6>';
                html += '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> <strong>Gap Analysis:</strong> These entities appear in Conclusions but were not extracted from Facts/Discussion/Questions sections.</div>';
                data.new_entities.forEach(entity => {
                    html += '<div class="entity-item" style="border-left-color: #ffc107;">';
                    html += `<div class="entity-label">${escapeHtml(entity.label)} <span class="badge bg-warning text-dark">NEW</span></div>`;
                    html += `<div class="entity-description"><strong>Type:</strong> ${entity.storage_type === 'class' ? 'Class (general concept)' : 'Individual (specific instance)'}</div>`;
                    html += '</div>';
                });
            }

            // Show raw LLM responses in collapsible section
            if (data.matching_response || data.extraction_response) {
                html += '<div class="mt-3">';
                html += '<button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#llmResponseCollapse' + entityType + '">';
                html += '<i class="bi bi-code-square"></i> Show Raw LLM Responses';
                html += '</button>';
                html += '<div class="collapse mt-2" id="llmResponseCollapse' + entityType + '">';

                // Matching response
                if (data.matching_response) {
                    html += '<div class="mb-3">';
                    html += '<h6 class="text-primary"><i class="bi bi-1-circle"></i> Matching Response</h6>';
                    html += '<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">';
                    html += escapeHtml(data.matching_response);
                    html += '</pre>';
                    html += '</div>';
                }

                // Extraction response (for NEW entities)
                if (data.extraction_response) {
                    html += '<div class="mb-3 border-top pt-3">';
                    html += '<h6 class="text-warning"><i class="bi bi-2-circle"></i> New Entity Extraction Response</h6>';
                    html += '<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #fff8e1; padding: 1rem; border-radius: 0.5rem; max-height: 400px; overflow-y: auto;">';
                    html += escapeHtml(data.extraction_response);
                    html += '</pre>';
                    html += '</div>';
                }

                html += '</div>';
                html += '</div>';
            }

            html += '</div>';
            resultsContent.innerHTML = html;
            resultsSection.style.display = 'block';

            // Show success message
            alert('Tagged ' + data.stats.total_matches + ' ' + entityType + ' from Facts/Discussion/Questions!');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Extract Ethical Questions using McLaren Framework
function extractQuestions() {
    console.log('Extracting ethical questions...');

    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Extracting...';

    fetch('/scenario_pipeline/case/' + caseId + '/extract_questions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            question_text: currentSectionText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Successfully extracted ' + data.summary.total_questions + ' ethical questions!');
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Display Question→Conclusion Links Results
function displayQCLinksResults(data) {
    const resultsContainer = document.getElementById('qcLinksResults');
    const statsDiv = document.getElementById('qcLinksStats');
    const linksList = document.getElementById('qcLinksList');

    // Show results container
    resultsContainer.style.display = 'block';

    // Populate stats
    const pairsCount = data.stats.total_pairs;
    const avgConfidence = (data.stats.avg_confidence * 100).toFixed(0);
    statsDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-check-circle-fill"></i>
                <strong>Successfully linked ${pairsCount} question(s) to conclusion(s)</strong>
            </div>
            <div>
                <span class="badge bg-success">Average Confidence: ${avgConfidence}%</span>
            </div>
        </div>
    `;

    // Populate links list
    linksList.innerHTML = '';
    data.pairs.forEach(pair => {
        const confidence = (pair.confidence * 100).toFixed(0);

        const linkItem = document.createElement('div');
        linkItem.className = 'list-group-item';
        linkItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                <h6 class="mb-1 text-primary">
                    <i class="bi bi-${pair.question_number}-circle"></i>
                    Question ${pair.question_number}
                </h6>
                <span class="badge bg-success">${confidence}% confidence</span>
            </div>
            <div class="mb-2">
                <strong class="text-primary">Question:</strong>
                <p class="mb-1 ms-3">${escapeHtml(pair.question_text)}</p>
            </div>
            <div class="mb-2">
                <strong class="text-success">Conclusion:</strong>
                <p class="mb-1 ms-3">${escapeHtml(pair.conclusion_text)}</p>
            </div>
            <div class="text-muted small">
                <i class="bi bi-info-circle"></i> ${escapeHtml(pair.reasoning)}
            </div>
        `;
        linksList.appendChild(linkItem);
    });

    // Also display the LLM verification prompt if available (collapsible)
    if (data.linking_prompt) {
        const promptSection = document.createElement('div');
        promptSection.className = 'mt-3';
        promptSection.innerHTML = `
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#qcLinkingPromptCollapse">
                <i class="bi bi-code-square"></i> Show LLM Verification Prompt
            </button>
            <div class="collapse mt-2" id="qcLinkingPromptCollapse">
                <div class="card card-body bg-light">
                    <h6 class="text-muted">LLM Verification Prompt:</h6>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">${escapeHtml(data.linking_prompt)}</pre>
                </div>
            </div>
        `;
        linksList.appendChild(promptSection);
    }

    // Also display the LLM response if available
    if (data.linking_response) {
        const responseSection = document.createElement('div');
        responseSection.className = 'mt-2';
        responseSection.innerHTML = `
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#qcLinkingResponseCollapse">
                <i class="bi bi-code-square"></i> Show LLM Verification Response
            </button>
            <div class="collapse mt-2" id="qcLinkingResponseCollapse">
                <div class="card card-body bg-light">
                    <h6 class="text-muted">LLM Verification Response:</h6>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">${escapeHtml(data.linking_response)}</pre>
                </div>
            </div>
        `;
        linksList.appendChild(responseSection);
    }
}

// Link Questions to Conclusions
function linkQuestionsToConclusions() {
    const btn = document.getElementById('linkQuestionsBtn');
    const originalHTML = btn.innerHTML;

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = `
        <div class="spinner-border spinner-border-sm" role="status"></div>
        Linking Questions to Conclusions...
    `;

    // Call the linking endpoint
    fetch(`/scenario_pipeline/case/${caseId}/link_questions_conclusions`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display results on the page
            displayQCLinksResults(data);

            // Show success alert
            const pairsCount = data.stats.total_pairs;
            const avgConfidence = (data.stats.avg_confidence * 100).toFixed(0);
            alert(`Successfully linked ${pairsCount} question(s) to conclusion(s)!\nAverage confidence: ${avgConfidence}%\n\nSee results below.`);

            // Enable review button highlighting
            const reviewBtn = document.querySelector('a[href*="review_case_entities"]');
            if (reviewBtn) {
                reviewBtn.classList.add('btn-success');
                reviewBtn.classList.remove('btn-outline-primary');
            }

            // Scroll to results
            document.getElementById('qcLinksResults').scrollIntoView({ behavior: 'smooth', block: 'start' });
        } else {
            alert('Error linking questions to conclusions: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    });
}
</script>
{% endblock %}
