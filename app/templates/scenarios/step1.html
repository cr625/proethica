{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 1: Contextual Framework Pass - Facts Section{% endblock %}
{% block step_header %}Step 1: Contextual Framework Pass (Facts){% endblock %}
{% block step_subtitle %}Extract roles, states, and resources from the facts section{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.overview', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Overview
    </a>
    <a href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}" class="btn btn-outline-primary">
        Step 2: Normative Pass (Facts) <i class="bi bi-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-text"></i> Facts Section
        </h4>
    </div>
    <div class="step-content">
        {% if facts_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="facts-text">{{ facts_section.llm_text }}</pre>
        </div>
        
        <!-- Contextual Framework Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-3">
            <button id="contextualPassBtn" class="btn btn-primary btn-lg" onclick="showPrompt()">
                <i class="bi bi-arrow-right-circle"></i> Full Contextual Framework Pass
                <small class="d-block">Extract Roles + States + Resources</small>
            </button>
        </div>

        <!-- Debug Individual Extractors -->
        <div class="alert alert-secondary mb-3">
            <h6 class="mb-2"><i class="bi bi-bug"></i> Debug Individual Extractors:</h6>
            <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                <button class="btn btn-info" onclick="extractIndividual('roles')">
                    <i class="bi bi-person-badge"></i> Extract Roles Only
                </button>
                <button class="btn btn-warning" onclick="extractIndividual('states')">
                    <i class="bi bi-diagram-3"></i> Extract States Only
                </button>
                <button class="btn btn-success" onclick="extractIndividual('resources')">
                    <i class="bi bi-box-seam"></i> Extract Resources Only
                </button>
            </div>
        </div>

        <!-- Individual Extraction Results (Hidden initially) -->
        <div id="individualResultsCard" class="step-card" style="display: none;">
            <div class="step-header">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle"></i> <span id="individualResultsTitle">Individual Extraction Results</span>
                </h5>
            </div>
            <div class="step-content" id="individualResultsContent">
                <!-- Results will be displayed here -->
            </div>
        </div>
        
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No facts section found in this case. Using first available section.
        </div>
        {% endif %}
    </div>
</div>

<!-- LLM Prompt Display (Show if saved prompt exists) -->
<div id="promptCard" class="step-card" style="{% if not saved_prompts.roles %}display: none;{% endif %}">
    <div class="step-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-cpu"></i> LLM Prompt Preview
            </h5>
            {% if saved_prompts.roles %}
            <button class="btn btn-sm btn-outline-primary" onclick="regeneratePrompt()">
                <i class="bi bi-arrow-clockwise"></i> Regenerate Prompt
            </button>
            {% endif %}
        </div>
    </div>
    <div class="step-content">
        <div class="alert alert-warning mb-3">
            <i class="bi bi-info-circle"></i>
            {% if saved_prompts.roles %}
            This is the saved prompt from the last extraction (created {{ saved_prompts.roles.created_at.strftime('%Y-%m-%d %H:%M') if saved_prompts.roles else '' }}):
            {% else %}
            This is the prompt that will be sent to the LLM for contextual framework extraction:
            {% endif %}
        </div>

        <div id="promptContent">
            <div class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Generating prompt...</span>
                </div>
                <span class="ms-2">Generating prompt...</span>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-3" id="executeButtonContainer" style="display: none;">
            <button id="executeBtn" class="btn btn-success btn-lg" onclick="executeContextualPass()">
                <i class="bi bi-play-circle"></i> Execute Contextual Framework Pass
            </button>
        </div>
    </div>
</div>

<!-- Raw Response Display (Hidden initially) -->
<div id="responseCard" class="step-card response-card" style="display: none;">
    <div class="step-header">
        <h5 class="mb-0">
            <i class="bi bi-code-square"></i> LLM Response
        </h5>
    </div>
    <div class="step-content">
        <div class="alert alert-success mb-3">
            <i class="bi bi-check-circle"></i>
            Raw response from the LLM entities extraction:
        </div>
        <div id="responseContent">
            <div class="loading-spinner">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Extracting entities...</span>
                </div>
                <span class="ms-2">Extracting entities...</span>
            </div>
        </div>
    </div>
</div>

<!-- Results Display (Hidden initially) -->
<div id="resultsCard" class="step-card" style="display: none;">
    <div class="step-header">
        <h5 class="mb-0">
            <i class="bi bi-check-circle"></i> Contextual Framework Pass Results
        </h5>
    </div>
    <div class="step-content">
        <div id="resultsContent">
            <div class="loading-spinner">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Extracting entities...</span>
                </div>
                <span class="ms-2">Extracting entities...</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block step_styles %}
<style>
    .facts-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: none;
        margin: 0;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    /* Contextual Framework Pass Button Styling */
    #contextualPassBtn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    #contextualPassBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    /* Prompt Display Styling */
    #promptCard {
        background-color: #fff8dc;
        border-color: #ffc107;
    }

    #promptCard .step-header {
        background-color: #fff3cd;
        border-color: #ffc107;
    }

    .prompt-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .prompt-section h6 {
        color: #495057;
        margin-bottom: 0.5rem;
    }

    .prompt-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        background-color: #ffffff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.75rem;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
    }

    /* Response Card Styling - Green Border */
    .response-card {
        border: 2px solid #28a745 !important;
        background-color: #f8f9fa;
    }

    .response-card .step-header {
        background-color: #d4edda;
        border-bottom: 2px solid #28a745;
    }

    .response-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        background-color: #ffffff;
        border: 1px solid #28a745;
        border-radius: 0.25rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Results Display Styling */
    #resultsCard {
        background-color: #d4edda;
        border-color: #28a745;
    }

    #resultsCard .step-header {
        background-color: #d1ecf1;
        border-color: #28a745;
    }

    .entity-type {
        margin-bottom: 1.5rem;
    }

    .entity-type h6 {
        color: #495057;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #28a745;
    }

    .entity-item {
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .entity-label {
        font-weight: 600;
        color: #495057;
    }

    .entity-description {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .entity-confidence {
        font-size: 0.8rem;
        color: #28a745;
        font-weight: 500;
    }

    .loading-spinner {
        text-align: center;
        padding: 2rem;
    }

    .summary-stats {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .summary-stats .stat {
        display: inline-block;
        margin-right: 2rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
let currentSectionText = '';

// Initialize section text
document.addEventListener('DOMContentLoaded', function() {
    const factsTextElement = document.querySelector('.facts-text');
    if (factsTextElement) {
        currentSectionText = factsTextElement.textContent.trim();
    }

    // Display saved prompt if it exists
    {% if saved_prompts.roles %}
    const savedPromptText = {{ saved_prompts.roles.prompt_text | tojson }};
    displayPrompt(savedPromptText, true);
    {% endif %}
});

function showPrompt() {
    const promptCard = document.getElementById('promptCard');
    const contextualBtn = document.getElementById('contextualPassBtn');
    
    // Disable the button and show loading
    contextualBtn.disabled = true;
    contextualBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Generating Prompt...';
    
    // Show prompt card
    promptCard.style.display = 'block';
    promptCard.scrollIntoView({ behavior: 'smooth' });
    
    // Fetch the prompt from the server
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    fetch(`{{ url_for('scenario_pipeline.entities_pass_prompt', case_id=case.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            section_text: currentSectionText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayPrompt(data);
            // Show execute button
            document.getElementById('executeButtonContainer').style.display = 'block';
        } else {
            displayError('Error generating prompt: ' + data.error);
        }
    })
    .catch(error => {
        displayError('Network error: ' + error.message);
    })
    .finally(() => {
        // Re-enable the button
        contextualBtn.disabled = false;
        contextualBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Contextual Framework Pass <small class="d-block">Extract Roles + States + Resources</small>';
    });
}

function displayPrompt(data, isSaved = false) {
    const content = document.getElementById('promptContent');

    // If saved prompt (just text), display it directly
    if (isSaved && typeof data === 'string') {
        content.innerHTML = `
            <div class="prompt-section">
                <h6><i class="bi bi-people"></i> Roles Extraction Prompt (Saved):</h6>
                <div class="prompt-text">${data}</div>
            </div>
        `;
    } else {
        // Display freshly generated prompts
        content.innerHTML = `
            <div class="prompt-section">
                <h6><i class="bi bi-people"></i> Roles Extraction Prompt:</h6>
                <div class="prompt-text">${data.roles_prompt || 'Role extraction prompt will be generated'}</div>
            </div>
            <div class="prompt-section">
                <h6><i class="bi bi-diagram-3"></i> States Extraction Prompt:</h6>
                <div class="prompt-text">${data.states_prompt || 'States extraction prompt will be generated'}</div>
            </div>
            <div class="prompt-section">
                <h6><i class="bi bi-gear"></i> Resources Extraction Prompt:</h6>
                <div class="prompt-text">${data.resources_prompt || 'Resources extraction prompt will be generated'}</div>
            </div>
            <div class="alert alert-info">
                <strong>Section Length:</strong> ${data.section_length} characters
            </div>
        `;
    }
}

function regeneratePrompt() {
    // Clear the saved prompt and regenerate
    const promptCard = document.getElementById('promptCard');
    const promptContent = document.getElementById('promptContent');

    // Show loading spinner
    promptContent.innerHTML = `
        <div class="loading-spinner text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Regenerating prompt...</span>
            </div>
            <p class="mt-2">Regenerating prompt...</p>
        </div>
    `;

    // Call showPrompt to fetch and display new prompt
    showPrompt();
}

function executeContextualPass() {
    const responseCard = document.getElementById('responseCard');
    const resultsCard = document.getElementById('resultsCard');
    const executeBtn = document.getElementById('executeBtn');
    
    // Disable execute button and show loading
    executeBtn.disabled = true;
    executeBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting...';
    
    // Show response card with loading
    responseCard.style.display = 'block';
    responseCard.scrollIntoView({ behavior: 'smooth' });
    
    // Hide results card initially (we'll show it later if needed)
    resultsCard.style.display = 'none';
    
    // Execute the entities pass
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    fetch(`{{ url_for('scenario_pipeline.entities_pass_execute', case_id=case.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            section_text: currentSectionText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display raw response first
            displayRawResponse(data);
            // Optionally also display formatted results
            // Uncomment the following lines to show formatted results too
            // resultsCard.style.display = 'block';
            // displayResults(data);
        } else {
            displayResponseError('Error executing contextual framework pass: ' + data.error);
        }
    })
    .catch(error => {
        displayResponseError('Network error: ' + error.message);
    })
    .finally(() => {
        // Re-enable execute button
        executeBtn.disabled = false;
        executeBtn.innerHTML = '<i class="bi bi-play-circle"></i> Execute Contextual Framework Pass';
    });
}

function displayResults(data) {
    const content = document.getElementById('resultsContent');
    
    let html = `
        <div class="summary-stats">
            <div class="stat"><i class="bi bi-people"></i> Roles: ${data.summary.roles_count || 0}</div>
            <div class="stat"><i class="bi bi-diagram-3"></i> States: ${data.summary.states_count || 0}</div>
            <div class="stat"><i class="bi bi-gear"></i> Resources: ${data.summary.resources_count || 0}</div>
            <div class="stat"><i class="bi bi-collection"></i> Total: ${data.summary.total_entities || 0}</div>
        </div>
    `;
    
    // Display roles
    if (data.roles && data.roles.length > 0) {
        html += `
            <div class="entity-type">
                <h6><i class="bi bi-people"></i> Extracted Role Classes (${data.roles.length})</h6>
        `;

        data.roles.forEach(role => {
            html += `
                <div class="entity-item">
                    <div class="entity-label">${role.label}</div>
                    ${role.description ? `<div class="entity-description">${role.description}</div>` : ''}
                    <div class="entity-confidence">Confidence: ${(role.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        });

        html += '</div>';
    }

    // Display individuals
    if (data.individuals && data.individuals.length > 0) {
        html += `
            <div class="entity-type">
                <h6><i class="bi bi-person-badge"></i> Extracted Individuals (${data.individuals.length})</h6>
        `;

        data.individuals.forEach(individual => {
            html += `
                <div class="entity-item">
                    <div class="entity-label">${individual.name}</div>
                    ${individual.role_class ? `<div class="entity-description"><strong>Role:</strong> ${individual.role_class}</div>` : ''}
                    ${individual.attributes ? `<div class="entity-description"><strong>Attributes:</strong> ${Object.entries(individual.attributes).map(([key, value]) => `${key}: ${value}`).join(', ')}</div>` : ''}
                    ${individual.case_involvement ? `<div class="entity-description"><strong>Case Involvement:</strong> ${individual.case_involvement}</div>` : ''}
                    ${individual.is_new_role_class ? `<div class="badge bg-success">Fulfills New Role Class</div>` : `<div class="badge bg-info">Fulfills Existing Role Class</div>`}
                    <div class="entity-confidence">Confidence: ${(individual.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        });

        html += '</div>';
    }
    
    // Display states
    if (data.states && data.states.length > 0) {
        html += `
            <div class="entity-type">
                <h6><i class="bi bi-diagram-3"></i> Extracted States (${data.states.length})</h6>
        `;
        
        data.states.forEach(state => {
            html += `
                <div class="entity-item">
                    <div class="entity-label">${state.label}</div>
                    ${state.description ? `<div class="entity-description">${state.description}</div>` : ''}
                    <div class="entity-confidence">Confidence: ${(state.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    // Display resources
    if (data.resources && data.resources.length > 0) {
        html += `
            <div class="entity-type">
                <h6><i class="bi bi-gear"></i> Extracted Resources (${data.resources.length})</h6>
        `;
        
        data.resources.forEach(resource => {
            html += `
                <div class="entity-item">
                    <div class="entity-label">${resource.label}</div>
                    ${resource.description ? `<div class="entity-description">${resource.description}</div>` : ''}
                    <div class="entity-confidence">Confidence: ${(resource.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        });
        
        html += '</div>';
    }
    
    if (data.summary.total_entities === 0) {
        html += `
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                No entities were extracted from this section.
            </div>
        `;
    }
    
    content.innerHTML = html;
}

// Store the response data globally for the formatted view
let currentResponseData = null;

function displayRawResponse(data) {
    const content = document.getElementById('responseContent');
    
    // Store for formatted view
    currentResponseData = data;
    
    // Create a nicely formatted JSON display
    const responseData = {
        roles: data.roles || [],
        states: data.states || [],
        resources: data.resources || [],
        summary: data.summary || {},
        metadata: {
            extraction_time: data.extraction_time || 'N/A',
            model_used: data.model_used || 'N/A',
            total_entities: data.summary?.total_entities || 0
        }
    };
    
    // Format JSON with proper indentation
    const formattedJson = JSON.stringify(responseData, null, 2);
    
    // Escape the JSON for HTML display
    const escapedJson = formattedJson
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    
    content.innerHTML = `
        <div class="response-text">${escapedJson}</div>
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="copyJsonToClipboard()">
                <i class="bi bi-clipboard"></i> Copy JSON
            </button>
            <button class="btn btn-sm btn-outline-primary ms-2" onclick="toggleFormattedView()">
                <i class="bi bi-eye"></i> Show Formatted View
            </button>
        </div>
    `;
    
    // Store the JSON for copying
    window.lastJsonResponse = formattedJson;
}

function copyJsonToClipboard() {
    const text = window.lastJsonResponse;
    navigator.clipboard.writeText(text).then(() => {
        // Show a temporary success message
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    });
}

function toggleFormattedView() {
    const resultsCard = document.getElementById('resultsCard');
    const btn = event.target.closest('button');
    
    if (resultsCard.style.display === 'none' || resultsCard.style.display === '') {
        // Show formatted view and populate it if needed
        resultsCard.style.display = 'block';
        if (currentResponseData) {
            displayResults(currentResponseData);
        }
        btn.innerHTML = '<i class="bi bi-eye-slash"></i> Hide Formatted View';
    } else {
        resultsCard.style.display = 'none';
        btn.innerHTML = '<i class="bi bi-eye"></i> Show Formatted View';
    }
}

function displayError(message) {
    const content = document.getElementById('promptContent');
    content.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            ${message}
        </div>
    `;
}

function displayResponseError(message) {
    const content = document.getElementById('responseContent');
    content.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            ${message}
        </div>
    `;
}

function displayResultsError(message) {
    const content = document.getElementById('resultsContent');
    content.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i>
            ${message}
        </div>
    `;
}

// Individual extraction function for Step 1 entities
function extractIndividual(conceptType) {
    // Show loading state on button
    const buttons = document.querySelectorAll('.btn-info, .btn-warning, .btn-success');
    buttons.forEach(btn => btn.disabled = true);

    // Determine which button was clicked and update it
    let clickedBtn;
    if (conceptType === 'roles') {
        clickedBtn = document.querySelector('.btn-info');
        clickedBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting Roles...';
    } else if (conceptType === 'states') {
        clickedBtn = document.querySelector('.btn-warning');
        clickedBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting States...';
    } else if (conceptType === 'resources') {
        clickedBtn = document.querySelector('.btn-success');
        clickedBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting Resources...';
    }

    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // Make the API call
    fetch(`{{ url_for('scenario_pipeline.step1_extract_individual', case_id=case.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            concept_type: conceptType,
            section_text: currentSectionText
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayIndividualResults(data, conceptType);
        } else {
            alert('Error extracting ' + conceptType + ': ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Network error: ' + error.message);
    })
    .finally(() => {
        // Re-enable buttons
        buttons.forEach(btn => btn.disabled = false);

        // Reset button text
        document.querySelector('.btn-info').innerHTML = '<i class="bi bi-person-badge"></i> Extract Roles Only';
        document.querySelector('.btn-warning').innerHTML = '<i class="bi bi-diagram-3"></i> Extract States Only';
        document.querySelector('.btn-success').innerHTML = '<i class="bi bi-box-seam"></i> Extract Resources Only';
    });
}

function displayIndividualResults(data, conceptType) {
    const resultsCard = document.getElementById('individualResultsCard');
    const resultsTitle = document.getElementById('individualResultsTitle');
    const resultsContent = document.getElementById('individualResultsContent');

    // Update title
    const typeLabel = conceptType.charAt(0).toUpperCase() + conceptType.slice(1);
    resultsTitle.textContent = `${typeLabel} Extraction Results`;

    // Build results HTML
    let html = `
        <div class="alert alert-info mb-3">
            <strong>Extraction Method:</strong> ${data.extraction_metadata?.extraction_method || 'enhanced_individual'}<br>
            <strong>Model Used:</strong> ${data.extraction_metadata?.model_used || 'Unknown'}<br>
            <strong>Count:</strong> ${data.count || 0} ${conceptType} extracted
        </div>
    `;

    if (data.prompt) {
        html += `
            <div class="alert alert-secondary mb-3">
                <h6>Extraction Prompt Used:</h6>
                <pre style="max-height: 300px; overflow-y: auto;">${data.prompt}</pre>
            </div>
        `;
    }

    // Display raw LLM response for debugging (only for roles)
    if (data.raw_llm_response) {
        html += `
            <div class="alert alert-warning mb-3">
                <h6>Raw LLM Response (Debug):</h6>
                <pre style="max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; background: #f8f9fa; padding: 10px; border: 1px solid #dee2e6; border-radius: 4px;">${data.raw_llm_response}</pre>
            </div>
        `;
    }

    if (data.results && data.results.length > 0) {
        // Special handling for roles - separate classes from individuals
        if (conceptType === 'roles') {
            const roleClasses = data.results.filter(item => item.type === 'role_class');
            const roleIndividuals = data.results.filter(item => item.type === 'role_individual');

            html += '<div class="results-list">';

            // Display Role Classes
            if (roleClasses.length > 0) {
                html += '<div class="mb-4">';
                html += `<h6 class="text-primary"><i class="bi bi-diagram-3"></i> New Role Classes Discovered (${roleClasses.length}):</h6>`;
                html += '<ul class="list-group mb-3">';

                roleClasses.forEach(roleClass => {
                    html += `
                        <li class="list-group-item border-left border-primary">
                            <strong>${roleClass.label}</strong>
                            <span class="badge badge-primary ml-2">Class</span>
                            ${roleClass.description ? `<br><small class="text-muted">${roleClass.description}</small>` : ''}
                            ${roleClass.professional_scope ? `<br><small class="text-info"><strong>Scope:</strong> ${roleClass.professional_scope}</small>` : ''}
                            ${roleClass.confidence ? `<br><small class="text-success">Confidence: ${(roleClass.confidence * 100).toFixed(0)}%</small>` : ''}
                        </li>
                    `;
                });

                html += '</ul>';
                html += '</div>';
            }

            // Display Role Individuals
            if (roleIndividuals.length > 0) {
                html += '<div class="mb-4">';
                html += `<h6 class="text-info"><i class="bi bi-person-badge"></i> Role Individuals Found (${roleIndividuals.length}):</h6>`;
                html += '<ul class="list-group mb-3">';

                roleIndividuals.forEach(individual => {
                    html += `
                        <li class="list-group-item border-left border-info">
                            <strong>${individual.label}</strong>
                            <span class="badge badge-info ml-2">Individual</span>
                            ${individual.role_class ? `<br><small class="text-primary"><strong>Role:</strong> ${individual.role_class}</small>` : ''}
                            ${individual.description ? `<br><small class="text-muted">${individual.description}</small>` : ''}
                            ${individual.attributes ? `<br><small class="text-secondary"><strong>Attributes:</strong> ${JSON.stringify(individual.attributes)}</small>` : ''}
                            ${individual.confidence ? `<br><small class="text-success">Confidence: ${(individual.confidence * 100).toFixed(0)}%</small>` : ''}
                        </li>
                    `;
                });

                html += '</ul>';
                html += '</div>';
            }

            // Summary and link to review
            html += `<div class="alert alert-success">
                <div><strong>Summary:</strong> Found ${roleClasses.length} new role classes and ${roleIndividuals.length} specific individuals.</div>
                <div class="mt-2">
                    <a href="{{ url_for('entity_review.review_case_entities', case_id=case.id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-list-check"></i> Review Extracted Entities
                    </a>
                </div>
            </div>`;

            html += '</div>';
        } else {
            // Original handling for non-role extractions
            html += '<div class="results-list">';
            html += `<h6>Extracted ${typeLabel}:</h6>`;
            html += '<ul class="list-group">';

            data.results.forEach(item => {
                html += `
                    <li class="list-group-item">
                        <strong>${item.label || 'Unnamed'}</strong>
                        ${item.description ? `<br><small class="text-muted">${item.description}</small>` : ''}
                        ${item.confidence ? `<br><small class="text-success">Confidence: ${(item.confidence * 100).toFixed(0)}%</small>` : ''}
                    </li>
                `;
            });

            html += '</ul>';
            html += '</div>';
        }
    } else {
        html += '<div class="alert alert-warning">No ' + conceptType + ' extracted from this section.</div>';
    }

    resultsContent.innerHTML = html;
    resultsCard.style.display = 'block';
    resultsCard.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}