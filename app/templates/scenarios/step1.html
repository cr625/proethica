{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 1: Contextual Framework Pass - Facts Section{% endblock %}
{% block step_header %}Step 1: Contextual Framework Pass (Facts){% endblock %}
{% block step_subtitle %}Extract roles, states, and resources from the facts section{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.overview', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Overview
    </a>
    <a href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}" class="btn btn-outline-primary">
        Step 2: Normative Pass (Facts) <i class="bi bi-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block step_content %}
{% if is_mock_mode %}
<div class="alert alert-warning alert-dismissible fade show mb-3" role="alert">
    <strong><i class="bi bi-exclamation-triangle"></i> {{ data_source_label }}</strong>
    <br>{{ data_source_warning }}
    <br><small class="text-muted">Set MOCK_LLM_ENABLED=false in environment to use real LLM.</small>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-text"></i> Facts Section
            {% if is_mock_mode %}<span class="badge bg-warning text-dark ms-2">Mock Mode</span>{% endif %}
        </h4>
    </div>
    <div class="step-content">
        {% if facts_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="facts-text">{{ facts_section.llm_text }}</pre>
        </div>

        <!-- Full Contextual Framework Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-4">
            {% if current_user.is_authenticated %}
            <button id="contextualPassBtn" class="btn btn-primary btn-lg" onclick="executeFullContextualPass()">
                <i class="bi bi-arrow-right-circle"></i> Full Contextual Framework Pass
                <small class="d-block">Extract All: Roles + States + Resources</small>
            </button>
            {% else %}
            <button class="btn btn-secondary btn-lg" onclick="window.location.href='{{ url_for('auth.login') }}';" title="Login required to run extraction">
                <i class="bi bi-lock-fill"></i> Full Contextual Framework Pass
                <small class="d-block">Login Required</small>
            </button>
            {% endif %}
        </div>

        <!-- Individual Extractor Sections -->

        <!-- ROLES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="rolesSection">
            <div class="step-card border-info">
                <div class="step-header bg-info bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-person-badge text-info"></i> Roles Extraction
                        </h5>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-info btn-sm" onclick="extractIndividualConcept('roles')">
                            <i class="bi bi-play-fill"></i> Extract Roles
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <!-- Roles Prompt Preview -->
                    <div class="prompt-preview mb-3" id="rolesPromptSection" style="{% if not saved_prompts.roles %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="rolesPromptText">
                            {% if saved_prompts.roles %}
                            {{ saved_prompts.roles.prompt_text }}
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Extract Roles
                            </div>
                            {% endif %}
                        </div>
                        {% if saved_prompts.roles %}
                        <small class="text-muted">Saved: {{ saved_prompts.roles.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>

                    <!-- Roles LLM Response -->
                    <div class="results-preview mb-3" id="rolesResults" style="{% if not saved_prompts.roles or not saved_prompts.roles.raw_response %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="rolesResultsContent">
                            {% if saved_prompts.roles and saved_prompts.roles.raw_response %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">{{ saved_prompts.roles.raw_response }}</pre>
                            {% else %}
                            <!-- LLM response will be displayed here -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- STATES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="statesSection">
            <div class="step-card border-warning">
                <div class="step-header bg-warning bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-diagram-3 text-warning"></i> States Extraction
                        </h5>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-warning btn-sm" onclick="extractIndividualConcept('states')">
                            <i class="bi bi-play-fill"></i> Extract States
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <!-- States Prompt Preview -->
                    <div class="prompt-preview mb-3" id="statesPromptSection" style="{% if not saved_prompts.states %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="statesPromptText">
                            {% if saved_prompts.states %}
                            {{ saved_prompts.states.prompt_text }}
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Extract States
                            </div>
                            {% endif %}
                        </div>
                        {% if saved_prompts.states %}
                        <small class="text-muted">Saved: {{ saved_prompts.states.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>

                    <!-- States LLM Response -->
                    <div class="results-preview mb-3" id="statesResults" style="{% if not saved_prompts.states or not saved_prompts.states.raw_response %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="statesResultsContent">
                            {% if saved_prompts.states and saved_prompts.states.raw_response %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">{{ saved_prompts.states.raw_response }}</pre>
                            {% else %}
                            <!-- LLM response will be displayed here -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESOURCES EXTRACTION SECTION -->
        <div class="extractor-section mb-4" id="resourcesSection">
            <div class="step-card border-success">
                <div class="step-header bg-success bg-opacity-10">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-box-seam text-success"></i> Resources Extraction
                        </h5>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-success btn-sm" onclick="extractIndividualConcept('resources')">
                            <i class="bi bi-play-fill"></i> Extract Resources
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="step-content">
                    <!-- Resources Prompt Preview -->
                    <div class="prompt-preview mb-3" id="resourcesPromptSection" style="{% if not saved_prompts.resources %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-cpu"></i> LLM Prompt</h6>
                        </div>
                        <div class="prompt-text" id="resourcesPromptText">
                            {% if saved_prompts.resources %}
                            {{ saved_prompts.resources.prompt_text }}
                            {% else %}
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split"></i> Prompt will be generated when you click Extract Resources
                            </div>
                            {% endif %}
                        </div>
                        {% if saved_prompts.resources %}
                        <small class="text-muted">Saved: {{ saved_prompts.resources.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        {% endif %}
                    </div>

                    <!-- Resources LLM Response -->
                    <div class="results-preview mb-3" id="resourcesResults" style="{% if not saved_prompts.resources or not saved_prompts.resources.raw_response %}display: none;{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0"><i class="bi bi-chat-left-text text-success"></i> LLM Response</h6>
                        </div>
                        <div id="resourcesResultsContent">
                            {% if saved_prompts.resources and saved_prompts.resources.raw_response %}
                            <pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">{{ saved_prompts.resources.raw_response }}</pre>
                            {% else %}
                            <!-- LLM response will be displayed here -->
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation to entity review -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
            <a href="{{ url_for('entity_review.review_case_entities', case_id=case.id, section_type='facts') }}" class="btn btn-outline-primary">
                <i class="bi bi-eye"></i> Review Pass 1 Entities (Facts)
            </a>
        </div>

        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No facts section found in this case. Using first available section.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block step_styles %}
<style>
    /* Fade out page smoothly on navigation/redirect */
    body.navigating {
        opacity: 0;
        transition: opacity 0.15s ease-out;
    }

    .facts-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: none;
        margin: 0;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .extractor-section .step-card {
        transition: all 0.3s ease;
    }

    .extractor-section .step-card:hover {
        box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
    }

    .prompt-preview {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .prompt-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
        background-color: white;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: 1px solid #dee2e6;
    }

    .results-preview {
        background-color: #f0fff4;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #d4edda;
    }

    /* Contextual Framework Pass Button Styling */
    #contextualPassBtn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    #contextualPassBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .entity-item {
        background: white;
        border-left: 3px solid #4e73df;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 0.25rem;
    }

    .entity-label {
        font-weight: bold;
        color: #2e59d9;
    }

    .entity-description {
        color: #5a5c69;
        margin-top: 0.25rem;
        font-size: 0.9rem;
    }

    .entity-confidence {
        color: #858796;
        font-size: 0.85rem;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
const caseId = {{ case.id }};
const currentSectionText = `{{ facts_section.llm_text if facts_section else '' }}`;

// Detect navigation/redirect and fade out page smoothly
// This prevents flash of loading UI when redirecting to login
let navigationStarted = false;
const markNavigationStarted = () => {
    if (!navigationStarted) {
        navigationStarted = true;
        document.body.classList.add('navigating');
    }
};

// Detect normal navigation via beforeunload event
window.addEventListener('beforeunload', markNavigationStarted);

// Detect link clicks for smooth navigation
document.addEventListener('click', (e) => {
    const link = e.target.closest('a');
    if (link && link.href && !link.href.startsWith('javascript:')) {
        markNavigationStarted();
    }
});

// Load saved prompts on page load - using vanilla JS instead of jQuery
document.addEventListener('DOMContentLoaded', function() {
    // Load saved prompts for all three concept types
    ['roles', 'states', 'resources'].forEach(conceptType => {
        loadSavedPrompt(conceptType);
    });
});

function loadSavedPrompt(conceptType) {
    appFetch(`/scenario_pipeline/case/${caseId}/step1/get_saved_prompt?concept_type=${conceptType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.prompt_text) {
                // Show the prompt section and display the saved prompt
                const promptSection = document.getElementById(`${conceptType}PromptSection`);
                const promptText = document.getElementById(`${conceptType}PromptText`);

                promptSection.style.display = 'block';
                promptText.innerHTML = data.prompt_text;

                // If there's a saved raw response, display it in the results section
                if (data.raw_response) {
                    const resultsSection = document.getElementById(`${conceptType}Results`);
                    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);

                    // Display the raw response
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = data.raw_response;
                    const escapedResponse = tempDiv.innerHTML;
                    resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapedResponse}</pre>`;

                    // Show the results section
                    resultsSection.style.display = 'block';
                }

                // Timestamp is already shown in the template, no need to add it here
            }
        })
        .catch(error => {
            console.log(`No saved prompt for ${conceptType}`, error);
        });
}

async function clearEntitiesForType(conceptType, sectionType) {
    // Clear existing entities for this concept type before re-extraction
    try {
        const response = await appFetch(`/scenario_pipeline/case/${caseId}/entities/clear_by_types`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                extraction_types: [conceptType],
                section_type: sectionType
            })
        });
        const data = await response.json();
        if (data.success) {
            console.log(`Cleared ${conceptType} entities: ${data.message}`);
        }
        return data;
    } catch (error) {
        console.error(`Error clearing ${conceptType} entities:`, error);
        return { success: false, error: error.message };
    }
}

async function extractIndividualConcept(conceptType) {
    const button = event.target.closest('button');
    const promptSection = document.getElementById(`${conceptType}PromptSection`);
    const promptText = document.getElementById(`${conceptType}PromptText`);
    const resultsSection = document.getElementById(`${conceptType}Results`);
    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Extracting...';

    // Show prompt section with loading
    promptSection.style.display = 'block';
    promptText.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Processing request...</span>
            </div>
            <p class="mt-2">Request submitted, awaiting response...</p>
        </div>
    `;

    // Clear existing entities first
    await clearEntitiesForType(conceptType, 'facts');

    // Execute extraction using global appFetch (handles 401 auth redirect automatically)
    appFetch(`{{ url_for('scenario_pipeline.step1_extract_individual', case_id=case.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
            // CSRF token is added automatically by appFetch
        },
        body: JSON.stringify({
            concept_type: conceptType,
            section_text: currentSectionText,
            section_type: 'facts'  // Step 1 is always Facts section
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Display the prompt (should be the prompt sent TO the LLM)
            if (data.prompt) {
                // Escape HTML and display as preformatted text
                const tempDiv = document.createElement('div');
                tempDiv.textContent = data.prompt;
                const escapedPrompt = tempDiv.innerHTML;
                promptText.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word;">${escapedPrompt}</pre>`;
            } else {
                promptText.innerHTML = 'No prompt available';
            }

            // Display the raw LLM response directly in the results section
            if (data.raw_llm_response) {
                // Simply display the raw response as-is
                const tempDiv = document.createElement('div');
                tempDiv.textContent = data.raw_llm_response;
                const escapedResponse = tempDiv.innerHTML;
                resultsContent.innerHTML = `<pre style="white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 1rem; border-radius: 0.5rem; max-height: 500px; overflow-y: auto;">${escapedResponse}</pre>`;
            } else {
                resultsContent.innerHTML = '<div class="alert alert-info">No response received from LLM</div>';
            }

            // Show results section
            resultsSection.style.display = 'block';

            // Mark this extraction type as complete and check if all done
            markExtractionComplete(conceptType);
        } else {
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Error: ${data.error}
                </div>
            `;
            resultsSection.style.display = 'block';
        }
    })
    .catch(error => {
        resultsContent.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i>
                Network error: ${error.message}
            </div>
        `;
        resultsSection.style.display = 'block';
    })
    .finally(() => {
        // Re-enable button with appropriate icon
        const iconClass = conceptType === 'roles' ? 'person-badge' :
                         conceptType === 'states' ? 'diagram-3' : 'box-seam';
        const btnClass = conceptType === 'roles' ? 'info' :
                        conceptType === 'states' ? 'warning' : 'success';
        button.disabled = false;
        button.innerHTML = `<i class="bi bi-play-fill"></i> Extract ${conceptType.charAt(0).toUpperCase() + conceptType.slice(1)}`;
    });
}

function displayConceptResults(conceptType, data) {
    const resultsContent = document.getElementById(`${conceptType}ResultsContent`);
    let html = '';

    if (conceptType === 'roles' && (data.role_classes || data.individuals)) {
        // Display role classes
        if (data.role_classes && data.role_classes.length > 0) {
            html += `<h6>Role Classes (${data.role_classes.length})</h6>`;
            data.role_classes.forEach(role => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${role.label}</div>
                        ${role.description ? `<div class="entity-description">${role.description}</div>` : ''}
                        <div class="entity-confidence">Confidence: ${(role.confidence * 100).toFixed(0)}%</div>
                    </div>
                `;
            });
        }

        // Display individuals
        if (data.individuals && data.individuals.length > 0) {
            html += `<h6 class="mt-3">Individuals (${data.individuals.length})</h6>`;
            data.individuals.forEach(individual => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${individual.name}</div>
                        ${individual.role_class ? `<div class="entity-description">Role: ${individual.role_class}</div>` : ''}
                        ${individual.case_involvement ? `<div class="entity-description">${individual.case_involvement}</div>` : ''}
                    </div>
                `;
            });
        }

        if (!data.role_classes && !data.individuals) {
            html = `
                <div class="alert alert-warning">
                    No roles extracted from this section.
                </div>
            `;
        }
    } else if (conceptType === 'states' && (data.state_classes || data.state_individuals)) {
        // Display state classes
        if (data.state_classes && data.state_classes.length > 0) {
            html += `<h6>State Classes (${data.state_classes.length})</h6>`;
            data.state_classes.forEach(state => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${state.label}</div>
                        ${state.description ? `<div class="entity-description">${state.description}</div>` : ''}
                        ${state.persistence_type ? `<div class="entity-description"><small>Persistence: ${state.persistence_type}</small></div>` : ''}
                        <div class="entity-confidence">Confidence: ${(state.confidence * 100).toFixed(0)}%</div>
                    </div>
                `;
            });
        }

        // Display state individuals
        if (data.state_individuals && data.state_individuals.length > 0) {
            html += `<h6 class="mt-3">State Instances (${data.state_individuals.length})</h6>`;
            data.state_individuals.forEach(individual => {
                html += `
                    <div class="entity-item">
                        <div class="entity-label">${individual.identifier}</div>
                        ${individual.state_class ? `<div class="entity-description">Type: ${individual.state_class}</div>` : ''}
                        ${individual.active_period ? `<div class="entity-description">Active: ${individual.active_period}</div>` : ''}
                        ${individual.triggering_event ? `<div class="entity-description">Triggered by: ${individual.triggering_event}</div>` : ''}
                    </div>
                `;
            });
        }

        if (!data.state_classes && !data.state_individuals) {
            html = `
                <div class="alert alert-warning">
                    No states extracted from this section.
                </div>
            `;
        }
    } else if (data.results && data.results.length > 0) {
        html += `<h6>${conceptType.charAt(0).toUpperCase() + conceptType.slice(1)} (${data.results.length})</h6>`;
        data.results.forEach(item => {
            html += `
                <div class="entity-item">
                    <div class="entity-label">${item.label}</div>
                    ${item.description ? `<div class="entity-description">${item.description}</div>` : ''}
                    <div class="entity-confidence">Confidence: ${(item.confidence * 100).toFixed(0)}%</div>
                </div>
            `;
        });
    } else {
        html = `
            <div class="alert alert-warning">
                No ${conceptType} extracted from this section.
            </div>
        `;
    }

    // Add metadata
    if (data.metadata) {
        html += `
            <div class="mt-3 text-muted small">
                <strong>Model:</strong> ${data.metadata.model || 'Unknown'} |
                <strong>Method:</strong> ${data.metadata.extraction_method || 'Unknown'}
            </div>
        `;
    }

    resultsContent.innerHTML = html;
}

// Track extraction completion status
const extractionStatus = {
    roles: {{ 'true' if saved_prompts.roles and saved_prompts.roles.raw_response else 'false' }},
    states: {{ 'true' if saved_prompts.states and saved_prompts.states.raw_response else 'false' }},
    resources: {{ 'true' if saved_prompts.resources and saved_prompts.resources.raw_response else 'false' }}
};

// Track if we've already shown the completion popup (e.g., on page reload)
let completionPopupShown = false;
let isInitialLoad = true;
let isFullPassMode = false;  // Only show completion modal during Full Contextual Framework Pass

function markExtractionComplete(conceptType) {
    extractionStatus[conceptType] = true;
    checkAllExtractionsComplete();
}

function checkAllExtractionsComplete() {
    const allComplete = extractionStatus.roles && extractionStatus.states && extractionStatus.resources;
    const discussionBtn = document.getElementById('discussionSectionBtn');

    if (allComplete && discussionBtn) {
        // Enable the Discussion button
        discussionBtn.classList.remove('disabled', 'btn-secondary');
        discussionBtn.classList.add('btn-primary');
        discussionBtn.removeAttribute('aria-disabled');
        discussionBtn.removeAttribute('tabindex');
        discussionBtn.querySelector('.btn-text').innerHTML = 'Discussion Section <i class="bi bi-arrow-right"></i>';
        discussionBtn.querySelector('.lock-icon')?.remove();

        // Make it a link if it's a span
        if (discussionBtn.tagName === 'SPAN') {
            const link = document.createElement('a');
            link.href = '{{ url_for("scenario_pipeline.step1b", case_id=case.id) }}';
            link.id = 'discussionSectionBtn';
            link.className = 'btn btn-primary btn-lg';
            link.innerHTML = '<span class="btn-text">Discussion Section <i class="bi bi-arrow-right"></i></span>';
            discussionBtn.parentNode.replaceChild(link, discussionBtn);
        }

        // Update sidebar Discussion link
        const sidebarDiscussion = document.querySelector('.pipeline-substep.disabled');
        if (sidebarDiscussion && sidebarDiscussion.textContent.includes('Discussion')) {
            sidebarDiscussion.outerHTML = `
                <a href="{{ url_for('scenario_pipeline.step1b', case_id=case.id) }}"
                   class="pipeline-substep">
                    <span class="substep-label">Discussion</span>
                </a>`;
        }

        // Show completion popup only during Full Contextual Framework Pass
        if (!isInitialLoad && !completionPopupShown && isFullPassMode) {
            showCompletionPopup();
            completionPopupShown = true;
            isFullPassMode = false;  // Reset so individual buttons don't re-trigger
        }
    }
}

function showCompletionPopup() {
    // Create and show a Bootstrap modal for completion
    const modalHtml = `
        <div class="modal fade" id="extractionCompleteModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="bi bi-check-circle-fill me-2"></i>Facts Extraction Complete
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <p class="mb-3">All three entity types have been extracted from the Facts section:</p>
                        <div class="d-flex justify-content-center gap-3 mb-3">
                            <span class="badge bg-info fs-6"><i class="bi bi-person-badge me-1"></i> Roles</span>
                            <span class="badge bg-warning text-dark fs-6"><i class="bi bi-diagram-3 me-1"></i> States</span>
                            <span class="badge bg-secondary fs-6"><i class="bi bi-box me-1"></i> Resources</span>
                        </div>
                        <p class="text-muted">You can now proceed to extract entities from the Discussion section.</p>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            Stay Here
                        </button>
                        <a href="{{ url_for('scenario_pipeline.step1b', case_id=case.id) }}" class="btn btn-success btn-lg">
                            <i class="bi bi-arrow-right-circle me-1"></i> Go to Discussion Section
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Only show if not already shown
    if (!document.getElementById('extractionCompleteModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('extractionCompleteModal'));
        modal.show();
    }
}

async function executeFullContextualPass() {
    isFullPassMode = true;  // Enable completion modal for full pass
    completionPopupShown = false;

    // Reset extraction status so popup only fires after all 3 complete in THIS run
    extractionStatus.roles = false;
    extractionStatus.states = false;
    extractionStatus.resources = false;

    const mainButton = document.getElementById('contextualPassBtn');
    mainButton.disabled = true;
    mainButton.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Clearing & Extracting All...';

    // Clear all Pass 1 entities for facts section first
    try {
        const response = await appFetch(`/scenario_pipeline/case/${caseId}/entities/clear_by_types`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                extraction_types: ['roles', 'states', 'resources'],
                section_type: 'facts'
            })
        });
        const data = await response.json();
        if (data.success) {
            console.log(`Cleared all Pass 1 entities: ${data.message}`);
        }
    } catch (error) {
        console.error('Error clearing Pass 1 entities:', error);
    }

    // Reset main button
    mainButton.disabled = false;
    mainButton.innerHTML = `
        <i class="bi bi-arrow-right-circle"></i> Full Contextual Framework Pass
        <small class="d-block">Extract All: Roles + States + Resources</small>
    `;

    // Execute all three extractions (they won't clear again since we already cleared)
    ['roles', 'states', 'resources'].forEach(conceptType => {
        const button = document.querySelector(`#${conceptType}Section button`);
        if (button) {
            button.click();
        }
    });
}

// Check on page load if already complete
document.addEventListener('DOMContentLoaded', function() {
    checkAllExtractionsComplete();
    // After initial check, allow popup to show on future completions
    isInitialLoad = false;
});
</script>
{% endblock %}

{% block step_navigation_bottom %}
<div class="navigation-buttons">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <a href="{{ url_for('scenario_pipeline.overview', case_id=case.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Overview
            </a>
        </div>
        <div>
            {% set facts_complete = pipeline_status.step1.facts_complete if pipeline_status else false %}
            {% if facts_complete %}
            <a href="{{ url_for('scenario_pipeline.step1b', case_id=case.id) }}" id="discussionSectionBtn" class="btn btn-primary btn-lg">
                <span class="btn-text">Discussion Section <i class="bi bi-arrow-right"></i></span>
            </a>
            {% else %}
            <span id="discussionSectionBtn" class="btn btn-secondary btn-lg disabled" aria-disabled="true" tabindex="-1"
                  title="Complete Facts extraction first">
                <i class="bi bi-lock-fill me-1 lock-icon"></i>
                <span class="btn-text">Discussion Section</span>
            </span>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}