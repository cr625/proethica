{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 3: Behavioral Pass - Facts Section{% endblock %}
{% block step_header %}Step 3: Behavioral Pass (Facts){% endblock %}
{% block step_subtitle %}Extract states, actions, events, and capabilities from the facts section{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.step2', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Step 2
    </a>
    <a href="#" class="btn btn-outline-primary disabled">
        Step 4: Entities Pass (Discussion) <i class="bi bi-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-text"></i> Facts Section
        </h4>
    </div>
    <div class="step-content">
        {% if facts_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="discussion-text">{{ facts_section.llm_text }}</pre>
        </div>
        
        <!-- Behavioral Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-3">
            <button id="behavioralPassBtn" class="btn btn-primary btn-lg">
                <i class="bi bi-arrow-right-circle"></i> Run Behavioral Pass
                <small class="d-block">Extract States + Actions + Events + Capabilities</small>
            </button>
        </div>
        
        <!-- Results Container -->
        <div id="behavioralResults" style="display: none;">
            <div class="alert alert-success mb-3">
                <h5 class="alert-heading"><i class="bi bi-check-circle"></i> Behavioral Pass Complete</h5>
                <hr>
                <div id="extractionSummary"></div>
            </div>
            
            <!-- States Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-diagram-3"></i> States</h5>
                <div id="statesResults" class="results-container"></div>
            </div>
            
            <!-- Actions Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-play-circle"></i> Actions</h5>
                <div id="actionsResults" class="results-container"></div>
            </div>
            
            <!-- Events Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-calendar-event"></i> Events</h5>
                <div id="eventsResults" class="results-container"></div>
            </div>
            
            <!-- Capabilities Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-gear"></i> Capabilities</h5>
                <div id="capabilitiesResults" class="results-container"></div>
            </div>
        </div>
        
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No facts section found in this case. Using available section.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block step_styles %}
<style>
    .discussion-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: none;
        margin: 0;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    /* Behavioral Pass Button Styling */
    #behavioralPassBtn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    #behavioralPassBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    #behavioralPassBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .results-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .results-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .concept-item {
        background: white;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    
    .concept-label {
        font-weight: bold;
        color: #333;
    }
    
    .concept-description {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }
    
    .concept-metadata {
        font-size: 0.8rem;
        color: #999;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const behavioralPassBtn = document.getElementById('behavioralPassBtn');
    const behavioralResults = document.getElementById('behavioralResults');
    const extractionSummary = document.getElementById('extractionSummary');
    const statesResults = document.getElementById('statesResults');
    const actionsResults = document.getElementById('actionsResults');
    const eventsResults = document.getElementById('eventsResults');
    const capabilitiesResults = document.getElementById('capabilitiesResults');
    
    if (behavioralPassBtn) {
        behavioralPassBtn.addEventListener('click', async function() {
            // Disable button and show loading state
            behavioralPassBtn.disabled = true;
            behavioralPassBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Extracting...';
            
            try {
                // Get CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                
                // Call the extraction endpoint
                const response = await fetch(`/scenario_pipeline/case/{{ case.id }}/step3/extract`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Display results
                displayResults(data);
                
            } catch (error) {
                console.error('Error during behavioral pass:', error);
                alert('Error during extraction: ' + error.message);
            } finally {
                // Re-enable button
                behavioralPassBtn.disabled = false;
                behavioralPassBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Run Behavioral Pass<small class="d-block">Extract States + Actions + Events + Capabilities</small>';
            }
        });
    }
    
    function displayResults(data) {
        // Show results container
        behavioralResults.style.display = 'block';
        
        // Display summary
        const statesCount = data.states ? data.states.length : 0;
        const actionsCount = data.actions ? data.actions.length : 0;
        const eventsCount = data.events ? data.events.length : 0;
        const capabilitiesCount = data.capabilities ? data.capabilities.length : 0;
        
        extractionSummary.innerHTML = `
            <p class="mb-0">
                Extracted <strong>${statesCount} States</strong>, 
                <strong>${actionsCount} Actions</strong>, 
                <strong>${eventsCount} Events</strong>, and
                <strong>${capabilitiesCount} Capabilities</strong>
            </p>
            ${data.provenance_url ? `<p class="mb-0 mt-2"><a href="${data.provenance_url}" target="_blank" class="btn btn-sm btn-outline-info"><i class="bi bi-diagram-3"></i> View Provenance</a></p>` : ''}
        `;
        
        // Display states
        displayConcepts(statesResults, data.states, 'state');
        
        // Display actions
        displayConcepts(actionsResults, data.actions, 'action');
        
        // Display events
        displayConcepts(eventsResults, data.events, 'event');
        
        // Display capabilities
        displayConcepts(capabilitiesResults, data.capabilities, 'capability');
        
        // Scroll to results
        behavioralResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function displayConcepts(container, concepts, type) {
        if (!concepts || concepts.length === 0) {
            container.innerHTML = '<p class="text-muted">No ' + type + 's extracted</p>';
            return;
        }
        
        const html = concepts.map(concept => {
            let borderColor = '#007bff';
            if (type === 'state') borderColor = '#6c757d';
            else if (type === 'action') borderColor = '#17a2b8';
            else if (type === 'event') borderColor = '#ffc107';
            else if (type === 'capability') borderColor = '#28a745';
            
            let metadata = '';
            if (concept.state_type) {
                metadata += `<span class="badge bg-secondary me-1">${concept.state_type}</span>`;
            }
            if (concept.action_type) {
                metadata += `<span class="badge bg-info text-white me-1">${concept.action_type}</span>`;
            }
            if (concept.event_type) {
                metadata += `<span class="badge bg-warning text-dark me-1">${concept.event_type}</span>`;
            }
            if (concept.capability_type) {
                metadata += `<span class="badge bg-success me-1">${concept.capability_type}</span>`;
            }
            if (concept.confidence) {
                metadata += `<span class="badge bg-light text-dark">Confidence: ${(concept.confidence * 100).toFixed(0)}%</span>`;
            }
            
            return `
                <div class="concept-item" style="border-left-color: ${borderColor}">
                    <div class="concept-label">${concept.label}</div>
                    <div class="concept-description">${concept.description}</div>
                    ${metadata ? `<div class="concept-metadata">${metadata}</div>` : ''}
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }
});
</script>
{% endblock %}