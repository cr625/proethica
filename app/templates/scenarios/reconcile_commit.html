{% extends "scenarios/base_step.html" %}

{% block step_title %}Reconcile & Commit{% endblock %}
{% block step_header %}Reconcile & Commit{% endblock %}
{% block step_subtitle %}Review near-duplicates and commit entities to OntServe{% endblock %}
{% block step_info %}Between Steps 3 and 4{% endblock %}

{% block step_styles %}
<style>
    .reconcile-card {
        border: 1px solid #e3e6f0;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }
    .reconcile-card .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        padding: 1rem 1.5rem;
    }
    .reconcile-card .card-body {
        padding: 1.5rem;
    }
    .candidate-row {
        border: 1px solid #e3e6f0;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: #fff;
    }
    .candidate-row:hover {
        background: #f8f9fc;
    }
    .candidate-row.resolved {
        opacity: 0.5;
        background: #f0fdf4;
    }
    .similarity-badge {
        font-size: 0.875rem;
        padding: 0.25rem 0.5rem;
    }
    .entity-label {
        font-weight: 500;
        font-size: 0.95rem;
    }
    .commit-status {
        padding: 1rem;
        border-radius: 0.375rem;
        margin-top: 1rem;
    }
    .commit-status.success {
        background: #f0fdf4;
        border: 1px solid #86efac;
    }
    .commit-status.error {
        background: #fef2f2;
        border: 1px solid #fca5a5;
    }
</style>
{% endblock %}

{% block step_content %}

{# Summary Card #}
<div class="reconcile-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-clipboard-data me-2"></i>Entity Summary</h5>
        {% if published_count > 0 %}
        <span class="badge bg-success">Committed</span>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="fs-3 fw-bold text-primary">{{ unpublished_count + published_count }}</div>
                <div class="text-muted">Total Entities</div>
            </div>
            <div class="col-md-3">
                <div class="fs-3 fw-bold text-info">{{ class_count }}</div>
                <div class="text-muted">Classes (pending)</div>
            </div>
            <div class="col-md-3">
                <div class="fs-3 fw-bold text-info">{{ individual_count }}</div>
                <div class="text-muted">Individuals (pending)</div>
            </div>
            <div class="col-md-3">
                <div class="fs-3 fw-bold text-success">{{ published_count }}</div>
                <div class="text-muted">Committed</div>
            </div>
        </div>
        {% if reconciliation.auto_merged > 0 %}
        <div class="alert alert-info mt-3 mb-0">
            <i class="bi bi-info-circle me-1"></i>
            <strong>{{ reconciliation.auto_merged }}</strong> near-duplicate entities were auto-merged (similarity >= 0.85, same concept type).
        </div>
        {% endif %}
        {% if reconciliation.errors %}
        <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle me-1"></i>
            {{ reconciliation.errors|length }} errors during reconciliation.
        </div>
        {% endif %}
    </div>
</div>

{# Review Candidates #}
{% if reconciliation.review_candidates %}
<div class="reconcile-card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="bi bi-people me-2"></i>Review Candidates
            <span class="badge bg-warning text-dark ms-2">{{ reconciliation.review_candidates|length }}</span>
        </h5>
        <small class="text-muted">These entity pairs have moderate similarity. Review and decide whether to merge or keep separate.</small>
    </div>
    <div class="card-body">
        {% for candidate in reconciliation.review_candidates %}
        <div class="candidate-row" id="candidate-{{ loop.index }}">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <div class="entity-label">{{ candidate.entity_a_label }}</div>
                    <small class="text-muted">ID: {{ candidate.entity_a_id }}</small>
                </div>
                <div class="col-md-1 text-center">
                    <i class="bi bi-arrow-left-right text-muted"></i>
                </div>
                <div class="col-md-4">
                    <div class="entity-label">{{ candidate.entity_b_label }}</div>
                    <small class="text-muted">ID: {{ candidate.entity_b_id }}</small>
                </div>
                <div class="col-md-1 text-center">
                    <span class="badge similarity-badge {% if candidate.similarity >= 0.85 %}bg-success{% elif candidate.similarity >= 0.75 %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                        {{ (candidate.similarity * 100)|round(0)|int }}%
                    </span>
                    {% if candidate.same_concept_type %}
                    <br><small class="text-muted">same type</small>
                    {% endif %}
                </div>
                <div class="col-md-2 text-end">
                    <button class="btn btn-sm btn-outline-primary me-1"
                            onclick="mergeEntities({{ candidate.entity_a_id }}, {{ candidate.entity_b_id }}, {{ loop.index }})"
                            title="Merge (keep shorter label)">
                        <i class="bi bi-union"></i> Merge
                    </button>
                    <button class="btn btn-sm btn-outline-secondary"
                            onclick="skipCandidate({{ loop.index }})"
                            title="Keep both entities separate">
                        <i class="bi bi-x"></i> Skip
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% elif not published_count %}
<div class="reconcile-card">
    <div class="card-body text-center text-muted py-4">
        <i class="bi bi-check-circle fs-3 d-block mb-2"></i>
        No near-duplicate entities found. Ready to commit.
    </div>
</div>
{% endif %}

{# Commit Section #}
<div class="reconcile-card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-cloud-upload me-2"></i>Commit to OntServe</h5>
    </div>
    <div class="card-body">
        {% if published_count > 0 and unpublished_count == 0 %}
        <div class="commit-status success">
            <i class="bi bi-check-circle-fill me-2 text-success"></i>
            All {{ published_count }} entities have been committed to OntServe.
            <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}" class="btn btn-primary ms-3">
                <i class="bi bi-arrow-right"></i> Proceed to Step 4
            </a>
        </div>
        {% elif unpublished_count > 0 %}
        <p>
            <strong>{{ unpublished_count }}</strong> entities will be committed:
            {{ class_count }} classes to <code>proethica-intermediate-extended.ttl</code>,
            {{ individual_count }} individuals to <code>proethica-case-{{ case.id }}.ttl</code>.
        </p>
        <p class="text-muted mb-3">
            After commit, entities become available via OntServe MCP for Step 4 synthesis queries.
            The OntServe refresh script will populate parent_uri for CTE hierarchy walks.
        </p>
        <button id="commitBtn" class="btn btn-success btn-lg"
                onclick="commitToOntServe()"
                {% if reconciliation.review_candidates %}disabled title="Resolve all review candidates first"{% endif %}>
            <i class="bi bi-cloud-upload me-2"></i>Commit {{ unpublished_count }} Entities to OntServe
        </button>
        <div id="commitResult" class="mt-3" style="display: none;"></div>
        {% else %}
        <div class="text-muted">No entities to commit for this case.</div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function mergeEntities(entityAId, entityBId, candidateIndex) {
    const row = document.getElementById('candidate-' + candidateIndex);
    const btn = row.querySelector('.btn-outline-primary');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

    fetch('{{ url_for("entity_review.reconcile_merge", case_id=case.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({keep_id: entityAId, merge_id: entityBId})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            row.classList.add('resolved');
            row.innerHTML = '<div class="text-center text-success"><i class="bi bi-check-circle me-1"></i> Merged</div>';
            checkAllResolved();
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-union"></i> Merge';
            alert('Merge failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-union"></i> Merge';
        alert('Error: ' + err);
    });
}

function skipCandidate(candidateIndex) {
    const row = document.getElementById('candidate-' + candidateIndex);
    row.classList.add('resolved');
    row.innerHTML = '<div class="text-center text-muted"><i class="bi bi-dash-circle me-1"></i> Kept separate</div>';
    checkAllResolved();
}

function checkAllResolved() {
    const unresolved = document.querySelectorAll('.candidate-row:not(.resolved)');
    const commitBtn = document.getElementById('commitBtn');
    if (commitBtn && unresolved.length === 0) {
        commitBtn.disabled = false;
        commitBtn.removeAttribute('title');
    }
}

function commitToOntServe() {
    const btn = document.getElementById('commitBtn');
    const resultDiv = document.getElementById('commitResult');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Committing...';

    fetch('{{ url_for("entity_review.reconcile_commit_execute", case_id=case.id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        resultDiv.style.display = 'block';
        if (data.success) {
            const r = data.result || {};
            resultDiv.innerHTML = `
                <div class="commit-status success">
                    <i class="bi bi-check-circle-fill me-2 text-success"></i>
                    <strong>Commit successful.</strong>
                    Classes: ${r.classes_committed || 0},
                    Individuals: ${r.individuals_committed || 0},
                    OntServe synced: ${r.ontserve_synced ? 'Yes' : 'No'}
                    <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}" class="btn btn-primary ms-3">
                        <i class="bi bi-arrow-right"></i> Proceed to Step 4
                    </a>
                </div>`;
            btn.style.display = 'none';
        } else {
            resultDiv.innerHTML = `
                <div class="commit-status error">
                    <i class="bi bi-x-circle-fill me-2 text-danger"></i>
                    <strong>Commit failed:</strong> ${data.error || 'Unknown error'}
                </div>`;
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Retry Commit';
        }
    })
    .catch(err => {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="commit-status error">
                <i class="bi bi-x-circle-fill me-2 text-danger"></i>
                <strong>Error:</strong> ${err}
            </div>`;
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-upload me-2"></i>Retry Commit';
    });
}
</script>
{% endblock %}
