{% extends "scenarios/base_step.html" %}

{% block step_title %}Entity Knowledge Graph{% endblock %}
{% block step_header %}Entity Knowledge Graph{% endblock %}
{% block step_subtitle %}Interactive visualization of all extracted entities and their relationships{% endblock %}

{% block extra_css %}
<style>
    #graph-container {
        width: 100%;
        height: 700px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background: #fafafa;
        position: relative;
    }

    #graph-svg {
        width: 100%;
        height: 100%;
    }

    .node {
        cursor: pointer;
    }

    .node circle {
        stroke: #fff;
        stroke-width: 2px;
        transition: r 0.2s ease;
    }

    .node:hover circle {
        stroke: #333;
        stroke-width: 3px;
    }

    .node text {
        font-size: 10px;
        font-family: 'Segoe UI', sans-serif;
        pointer-events: none;
        text-anchor: middle;
    }

    .link {
        stroke: #999;
        stroke-opacity: 0.6;
        fill: none;
    }

    .link.highlighted {
        stroke: #333;
        stroke-opacity: 1;
        stroke-width: 2px;
    }

    #entity-details {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 320px;
        max-height: 400px;
        overflow-y: auto;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none;
        z-index: 100;
    }

    #entity-details.visible {
        display: block;
    }

    #entity-details h6 {
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
        font-size: 12px;
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
        border: 1px solid #fff;
        box-shadow: 0 0 2px rgba(0,0,0,0.3);
    }

    .filter-btn {
        padding: 4px 10px;
        font-size: 12px;
        margin: 2px;
    }

    .filter-btn.active {
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }

    #search-input {
        max-width: 300px;
    }

    .stats-badge {
        font-size: 0.9em;
    }

    #zoom-controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 100;
    }

    #zoom-controls button {
        width: 36px;
        height: 36px;
        margin: 2px;
    }
</style>
{% endblock %}

{% block step_content %}

<!-- Controls Card -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="row align-items-center">
            <div class="col-md-4">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="search-input" class="form-control" placeholder="Search entities...">
                </div>
            </div>
            <div class="col-md-8 text-end">
                <span class="me-2 text-muted small">Filter by Pass:</span>
                <button class="btn btn-sm btn-outline-primary filter-btn active" data-pass="all">All</button>
                <button class="btn btn-sm btn-outline-info filter-btn" data-pass="1">Pass 1</button>
                <button class="btn btn-sm btn-outline-success filter-btn" data-pass="2">Pass 2</button>
                <button class="btn btn-sm btn-outline-warning filter-btn" data-pass="3">Pass 3</button>
                <button class="btn btn-sm btn-outline-danger filter-btn" data-pass="4">Step 4</button>
            </div>
        </div>
    </div>
</div>

<!-- Legend -->
<div class="card mb-3">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap align-items-center">
            <span class="me-3 text-muted small"><strong>Legend:</strong></span>
            <div id="legend-container" class="d-flex flex-wrap"></div>
        </div>
    </div>
</div>

<!-- Graph Container -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Entity Graph</h5>
            <small class="text-muted">
                <span id="node-count">0</span> nodes, <span id="edge-count">0</span> edges
            </small>
        </div>
        <div>
            <span class="badge bg-primary stats-badge me-2" id="stats-pass1">Pass 1: 0</span>
            <span class="badge bg-success stats-badge me-2" id="stats-pass2">Pass 2: 0</span>
            <span class="badge bg-warning stats-badge me-2" id="stats-pass3">Pass 3: 0</span>
            <span class="badge bg-danger stats-badge" id="stats-pass4">Step 4: 0</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div id="graph-container">
            <svg id="graph-svg"></svg>

            <!-- Entity Details Panel -->
            <div id="entity-details">
                <button type="button" class="btn-close float-end" id="close-details"></button>
                <h6 id="detail-label" style="border-color: #666;"></h6>
                <p class="small mb-2">
                    <span class="badge" id="detail-type-badge">Type</span>
                    <span class="badge bg-secondary" id="detail-pass-badge">Pass</span>
                </p>
                <p class="small text-muted mb-2" id="detail-definition"></p>
                <hr>
                <p class="small mb-1"><strong>Connections:</strong></p>
                <ul class="small list-unstyled" id="detail-connections"></ul>
            </div>

            <!-- Zoom Controls -->
            <div id="zoom-controls">
                <button class="btn btn-sm btn-light" id="zoom-in" title="Zoom In">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="btn btn-sm btn-light" id="zoom-out" title="Zoom Out">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <button class="btn btn-sm btn-light" id="zoom-reset" title="Reset View">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Card -->
<div class="card mt-3">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Entity Summary</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <h6 class="text-primary">Pass 1: Contextual</h6>
                <ul class="list-unstyled small">
                    <li>Roles: {{ entities_summary.roles }}</li>
                    <li>States: {{ entities_summary.states }}</li>
                    <li>Resources: {{ entities_summary.resources }}</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="text-success">Pass 2: Normative</h6>
                <ul class="list-unstyled small">
                    <li>Principles: {{ entities_summary.principles }}</li>
                    <li>Obligations: {{ entities_summary.obligations }}</li>
                    <li>Constraints: {{ entities_summary.constraints }}</li>
                    <li>Capabilities: {{ entities_summary.capabilities }}</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="text-warning">Pass 3: Temporal</h6>
                <ul class="list-unstyled small">
                    <li>Actions: {{ entities_summary.actions }}</li>
                    <li>Events: {{ entities_summary.events }}</li>
                </ul>
            </div>
            <div class="col-md-3">
                <h6 class="text-danger">Step 4: Synthesis</h6>
                <ul class="list-unstyled small" id="step4-summary">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const caseId = {{ case.id }};
    const container = document.getElementById('graph-container');
    const svg = d3.select('#graph-svg');

    let graphData = null;
    let simulation = null;
    let currentFilter = 'all';
    let searchTerm = '';

    // Fetch and render graph
    fetch(`/scenario_pipeline/case/${caseId}/entity_graph`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                graphData = data;
                renderGraph(data);
                updateStats(data.metadata);
                buildLegend(data.metadata.type_colors);
                updateStep4Summary(data.metadata.type_counts);
            } else {
                console.error('Failed to load graph:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching graph:', error);
        });

    function renderGraph(data) {
        const width = container.clientWidth;
        const height = container.clientHeight;

        svg.selectAll('*').remove();

        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Create container group for zoom
        const g = svg.append('g');

        // Filter nodes and edges based on current filter
        const filteredNodes = filterNodes(data.nodes);
        const filteredNodeIds = new Set(filteredNodes.map(n => n.id));
        const filteredEdges = data.edges.filter(e =>
            filteredNodeIds.has(e.source) && filteredNodeIds.has(e.target) ||
            filteredNodeIds.has(e.source.id) && filteredNodeIds.has(e.target.id)
        );

        // Create simulation
        simulation = d3.forceSimulation(filteredNodes)
            .force('link', d3.forceLink(filteredEdges).id(d => d.id).distance(80))
            .force('charge', d3.forceManyBody().strength(-200))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(30));

        // Create edges
        const link = g.append('g')
            .attr('class', 'links')
            .selectAll('line')
            .data(filteredEdges)
            .enter().append('line')
            .attr('class', 'link')
            .attr('stroke-width', 1);

        // Create nodes
        const node = g.append('g')
            .attr('class', 'nodes')
            .selectAll('g')
            .data(filteredNodes)
            .enter().append('g')
            .attr('class', 'node')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended))
            .on('click', showDetails)
            .on('mouseover', highlightConnections)
            .on('mouseout', unhighlightConnections);

        // Node circles
        node.append('circle')
            .attr('r', d => getNodeSize(d))
            .attr('fill', d => d.color);

        // Node labels
        node.append('text')
            .attr('dy', d => getNodeSize(d) + 12)
            .text(d => truncateLabel(d.label, 15))
            .attr('fill', '#333');

        // Update positions on tick
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node.attr('transform', d => `translate(${d.x},${d.y})`);
        });

        // Update counts
        document.getElementById('node-count').textContent = filteredNodes.length;
        document.getElementById('edge-count').textContent = filteredEdges.length;

        // Zoom controls
        document.getElementById('zoom-in').onclick = () => {
            svg.transition().call(zoom.scaleBy, 1.3);
        };
        document.getElementById('zoom-out').onclick = () => {
            svg.transition().call(zoom.scaleBy, 0.7);
        };
        document.getElementById('zoom-reset').onclick = () => {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        };
    }

    function filterNodes(nodes) {
        return nodes.filter(n => {
            // Pass filter
            if (currentFilter !== 'all' && n.pass !== parseInt(currentFilter)) {
                return false;
            }
            // Search filter
            if (searchTerm && !n.label.toLowerCase().includes(searchTerm.toLowerCase())) {
                return false;
            }
            return true;
        });
    }

    function getNodeSize(node) {
        // Size based on entity type importance
        const sizes = {
            'roles': 12,
            'principles': 10,
            'obligations': 10,
            'temporal_dynamics_enhanced': 10,
            'ethical_question': 11,
            'ethical_conclusion': 11,
            'code_provision_reference': 9
        };
        return sizes[node.type] || 8;
    }

    function truncateLabel(label, maxLen) {
        if (label.length <= maxLen) return label;
        return label.substring(0, maxLen) + '...';
    }

    function showDetails(event, d) {
        const panel = document.getElementById('entity-details');
        const labelEl = document.getElementById('detail-label');
        const typeBadge = document.getElementById('detail-type-badge');
        const passBadge = document.getElementById('detail-pass-badge');
        const defEl = document.getElementById('detail-definition');
        const connEl = document.getElementById('detail-connections');

        labelEl.textContent = d.label;
        labelEl.style.borderColor = d.color;

        typeBadge.textContent = d.type.replace(/_/g, ' ');
        typeBadge.style.backgroundColor = d.color;

        const passNames = {1: 'Pass 1', 2: 'Pass 2', 3: 'Pass 3', 4: 'Step 4'};
        passBadge.textContent = passNames[d.pass] || 'Unknown';

        defEl.textContent = d.definition || 'No definition available';

        // Find connections
        const connections = graphData.edges.filter(e =>
            e.source === d.id || e.target === d.id ||
            (e.source.id && e.source.id === d.id) ||
            (e.target.id && e.target.id === d.id)
        );

        connEl.innerHTML = '';
        if (connections.length === 0) {
            connEl.innerHTML = '<li class="text-muted">No connections</li>';
        } else {
            connections.forEach(conn => {
                const isSource = conn.source === d.id || (conn.source.id && conn.source.id === d.id);
                const otherNode = isSource ?
                    graphData.nodes.find(n => n.id === conn.target || n.id === conn.target.id) :
                    graphData.nodes.find(n => n.id === conn.source || n.id === conn.source.id);

                if (otherNode) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span style="color:${otherNode.color}">${isSource ? '&#8594;' : '&#8592;'}</span> ${conn.type}: ${otherNode.label}`;
                    connEl.appendChild(li);
                }
            });
        }

        panel.classList.add('visible');
    }

    function highlightConnections(event, d) {
        d3.selectAll('.link')
            .classed('highlighted', l =>
                l.source === d || l.target === d ||
                l.source.id === d.id || l.target.id === d.id
            );
    }

    function unhighlightConnections() {
        d3.selectAll('.link').classed('highlighted', false);
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    function updateStats(metadata) {
        const pc = metadata.pass_counts;
        document.getElementById('stats-pass1').textContent = `Pass 1: ${pc[1] || 0}`;
        document.getElementById('stats-pass2').textContent = `Pass 2: ${pc[2] || 0}`;
        document.getElementById('stats-pass3').textContent = `Pass 3: ${pc[3] || 0}`;
        document.getElementById('stats-pass4').textContent = `Step 4: ${pc[4] || 0}`;
    }

    function buildLegend(colors) {
        const container = document.getElementById('legend-container');
        container.innerHTML = '';

        const typeLabels = {
            'roles': 'Roles',
            'states': 'States',
            'resources': 'Resources',
            'principles': 'Principles',
            'obligations': 'Obligations',
            'constraints': 'Constraints',
            'capabilities': 'Capabilities',
            'temporal_dynamics_enhanced': 'Actions/Events',
            'code_provision_reference': 'Provisions',
            'ethical_question': 'Questions',
            'ethical_conclusion': 'Conclusions'
        };

        Object.entries(colors).forEach(([type, color]) => {
            if (typeLabels[type]) {
                const item = document.createElement('span');
                item.className = 'legend-item';
                item.innerHTML = `<span class="legend-dot" style="background-color:${color}"></span>${typeLabels[type]}`;
                container.appendChild(item);
            }
        });
    }

    function updateStep4Summary(counts) {
        const el = document.getElementById('step4-summary');
        el.innerHTML = `
            <li>Provisions: ${counts.code_provision_reference || 0}</li>
            <li>Questions: ${counts.ethical_question || 0}</li>
            <li>Conclusions: ${counts.ethical_conclusion || 0}</li>
        `;
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.pass;
            if (graphData) renderGraph(graphData);
        });
    });

    // Search input
    document.getElementById('search-input').addEventListener('input', function() {
        searchTerm = this.value;
        if (graphData) renderGraph(graphData);
    });

    // Close details panel
    document.getElementById('close-details').addEventListener('click', function() {
        document.getElementById('entity-details').classList.remove('visible');
    });
});
</script>
{% endblock %}
