{% extends "scenarios/base_step.html" %}

{% block step_title %}Step 2: Normative Requirements Pass - Facts Section{% endblock %}
{% block step_header %}Step 2: Normative Requirements Pass (Facts){% endblock %}
{% block step_subtitle %}Extract principles, obligations, constraints, and capabilities from the facts section{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.step1', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Step 1
    </a>
    <a href="{{ next_step_url }}" class="btn btn-primary">
        Step 3: Temporal Dynamics Pass (Facts) <i class="bi bi-arrow-right"></i>
    </a>
</div>
{% endblock %}

{% block step_content %}
<div class="step-card">
    <div class="step-header">
        <h4 class="mb-0">
            <i class="bi bi-file-text"></i> Facts Section
        </h4>
    </div>
    <div class="step-content">
        {% if discussion_section %}
        <div class="alert alert-info mb-3">
            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Section Content:</h6>
            <pre class="discussion-text">{{ discussion_section.llm_text }}</pre>
        </div>
        
        <!-- Normative Requirements Pass Button -->
        <div class="d-grid gap-2 d-md-flex justify-content-md-center mb-3">
            <button id="normativePassBtn" class="btn btn-primary btn-lg">
                <i class="bi bi-arrow-right-circle"></i> Run Normative Requirements Pass
                <small class="d-block">Extract Principles + Obligations + Constraints + Capabilities</small>
            </button>
        </div>
        
        <!-- Results Container -->
        <div id="normativeResults" style="display: none;">
            <div class="alert alert-success mb-3">
                <h5 class="alert-heading"><i class="bi bi-check-circle"></i> Normative Requirements Pass Complete</h5>
                <hr>
                <div id="extractionSummary"></div>
            </div>
            
            <!-- Principles Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-stars"></i> Principles</h5>
                <div id="principlesResults" class="results-container"></div>
            </div>
            
            <!-- Obligations Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-shield-check"></i> Obligations</h5>
                <div id="obligationsResults" class="results-container"></div>
            </div>
            
            <!-- Constraints Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-exclamation-triangle"></i> Constraints</h5>
                <div id="constraintsResults" class="results-container"></div>
            </div>
            
            <!-- Capabilities Results -->
            <div class="results-section mb-4">
                <h5><i class="bi bi-gear"></i> Capabilities</h5>
                <div id="capabilitiesResults" class="results-container"></div>
            </div>
        </div>
        
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            No discussion/analysis section found in this case. Using available section.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block step_styles %}
<style>
    .discussion-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        border: none;
        margin: 0;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .alert-info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
    }

    /* Normative Pass Button Styling */
    #normativePassBtn {
        padding: 1rem 2rem;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    #normativePassBtn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    #normativePassBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .results-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .results-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    .concept-item {
        background: white;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        border-left: 4px solid #007bff;
    }
    
    .concept-label {
        font-weight: bold;
        color: #333;
    }
    
    .concept-description {
        color: #666;
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }
    
    .concept-metadata {
        font-size: 0.8rem;
        color: #999;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const normativePassBtn = document.getElementById('normativePassBtn');
    const normativeResults = document.getElementById('normativeResults');
    const extractionSummary = document.getElementById('extractionSummary');
    const principlesResults = document.getElementById('principlesResults');
    const obligationsResults = document.getElementById('obligationsResults');
    const constraintsResults = document.getElementById('constraintsResults');
    const capabilitiesResults = document.getElementById('capabilitiesResults');
    
    if (normativePassBtn) {
        normativePassBtn.addEventListener('click', async function() {
            // Disable button and show loading state
            normativePassBtn.disabled = true;
            normativePassBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Extracting...';
            
            try {
                // Get CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
                
                // Call the extraction endpoint
                const response = await fetch(`/scenario_pipeline/case/{{ case.id }}/step2/extract`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Display results
                displayResults(data);
                
            } catch (error) {
                console.error('Error during normative pass:', error);
                alert('Error during extraction: ' + error.message);
            } finally {
                // Re-enable button
                normativePassBtn.disabled = false;
                normativePassBtn.innerHTML = '<i class="bi bi-arrow-right-circle"></i> Run Normative Requirements Pass<small class="d-block">Extract Principles + Obligations + Constraints + Capabilities</small>';
            }
        });
    }
    
    function displayResults(data) {
        // Show results container
        normativeResults.style.display = 'block';
        
        // Display summary
        const principleCount = data.principles ? data.principles.length : 0;
        const obligationCount = data.obligations ? data.obligations.length : 0;
        const constraintCount = data.constraints ? data.constraints.length : 0;
        const capabilityCount = data.capabilities ? data.capabilities.length : 0;
        
        extractionSummary.innerHTML = `
            <p class="mb-0">
                Extracted <strong>${principleCount} Principles</strong>, 
                <strong>${obligationCount} Obligations</strong>, 
                <strong>${constraintCount} Constraints</strong>, and
                <strong>${capabilityCount} Capabilities</strong>
            </p>
            ${data.provenance_url ? `<p class="mb-0 mt-2"><a href="${data.provenance_url}" target="_blank" class="btn btn-sm btn-outline-info"><i class="bi bi-diagram-3"></i> View Provenance</a></p>` : ''}
        `;
        
        // Display principles
        displayConcepts(principlesResults, data.principles, 'principle');
        
        // Display obligations
        displayConcepts(obligationsResults, data.obligations, 'obligation');
        
        // Display constraints
        displayConcepts(constraintsResults, data.constraints, 'constraint');
        
        // Display capabilities
        displayConcepts(capabilitiesResults, data.capabilities, 'capability');
        
        // Scroll to results
        normativeResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    function displayConcepts(container, concepts, type) {
        if (!concepts || concepts.length === 0) {
            container.innerHTML = '<p class="text-muted">No ' + type + 's extracted</p>';
            return;
        }
        
        const html = concepts.map(concept => {
            let borderColor = '#007bff';
            if (type === 'principle') borderColor = '#28a745';
            else if (type === 'obligation') borderColor = '#ffc107';
            else if (type === 'constraint') borderColor = '#dc3545';
            else if (type === 'capability') borderColor = '#17a2b8';
            
            let metadata = '';
            if (concept.debug) {
                if (concept.debug.principle_category) {
                    metadata += `<span class="badge bg-secondary me-1">${concept.debug.principle_category}</span>`;
                }
                if (concept.debug.obligation_type) {
                    metadata += `<span class="badge bg-warning text-dark me-1">${concept.debug.obligation_type}</span>`;
                }
                if (concept.debug.constraint_type) {
                    metadata += `<span class="badge bg-danger me-1">${concept.debug.constraint_type}</span>`;
                }
                if (concept.debug.capability_type) {
                    metadata += `<span class="badge bg-info me-1">${concept.debug.capability_type}</span>`;
                }
                if (concept.debug.importance) {
                    metadata += `<span class="badge bg-info me-1">Importance: ${concept.debug.importance}</span>`;
                }
                if (concept.confidence) {
                    metadata += `<span class="badge bg-light text-dark">Confidence: ${(concept.confidence * 100).toFixed(0)}%</span>`;
                }
            }
            
            return `
                <div class="concept-item" style="border-left-color: ${borderColor}">
                    <div class="concept-label">${concept.label}</div>
                    <div class="concept-description">${concept.description}</div>
                    ${metadata ? `<div class="concept-metadata">${metadata}</div>` : ''}
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }
});
</script>
{% endblock %}