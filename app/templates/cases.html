{% extends "base.html" %}

{% block title %}Case Repository - AI Ethical Decision-Making Simulator{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Case Repository</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        Error loading cases: {{ error }}
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-8">
            <form id="caseFilterForm" class="d-flex align-items-center" action="/cases/" method="get">
                <div class="input-group me-2" style="max-width: 300px;">
                    <select class="form-select" name="world_id" id="worldFilter" aria-label="Filter by World">
                        <option value="">All Worlds</option>
                        {% for world in worlds %}
                        <option value="{{ world.id }}" {% if selected_world_id == world.id %}selected{% endif %}>
                            {{ world.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-check ms-3">
                    <input class="form-check-input" type="checkbox" id="analyzedOnlyFilter"
                           {% if show_analyzed_only %}checked{% endif %}>
                    <label class="form-check-label" for="analyzedOnlyFilter">
                        Show analyzed cases only
                    </label>
                </div>
                <!-- Search bar hidden until new search is implemented
                <input class="form-control" type="search" placeholder="Search cases..." name="query" value="{{ query }}"
                    aria-label="Search">
                <button class="btn btn-outline-primary" type="submit">Search</button>
                -->
            </form>

            <script>
                // Handle filter changes properly
                document.getElementById('worldFilter').addEventListener('change', function() {
                    updateCaseFilters();
                });

                document.getElementById('analyzedOnlyFilter').addEventListener('change', function() {
                    updateCaseFilters();
                });

                function updateCaseFilters() {
                    const worldId = document.getElementById('worldFilter').value;
                    const analyzedOnly = document.getElementById('analyzedOnlyFilter').checked;

                    // Build URL parameters
                    const params = new URLSearchParams();

                    // Only add world_id if it has a value
                    if (worldId) {
                        params.append('world_id', worldId);
                    }

                    // Add analyzed_only parameter (true or false)
                    params.append('analyzed_only', analyzedOnly ? 'true' : 'false');

                    // Navigate to the filtered URL
                    window.location.href = '/cases/?' + params.toString();
                }
            </script>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('cases.case_options') }}" class="btn btn-success">Add New Case</a>
        </div>
    </div>
    
    <!-- Processing Status Legend -->
    <div class="row mb-3">
    </div>

    {% if grouped_cases %}
    {% for year, year_cases in grouped_cases.items() %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">{{ year }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% for case in year_cases %}
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                {% if case.doc_metadata and (case.doc_metadata.get('source') == 'agent_generated' or case.doc_metadata.get('source') == 'agent_generated_sample') %}
                                <i class="bi bi-robot text-primary me-2" title="Generated with Language Model assistance"></i>
                                {% endif %}
                                {{ case.title }}
                            </h5>
                            <div>
                                {% if case.case_number %}
                                <span class="badge bg-secondary me-2">Case #{{ case.case_number }}</span>
                                {% endif %}
                                {% if case.is_analyzed %}
                                <span class="badge bg-success" title="Step 4 Whole-Case Synthesis completed">
                                    <i class="bi bi-check-circle"></i> Analyzed
                                </span>
                                {% else %}
                                <span class="badge bg-light text-muted" title="Analysis not yet completed">
                                    Not Analyzed
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Subject Tags on separate line -->
                        {% if case.doc_metadata and case.doc_metadata.subject_tags %}
                        <div class="card-header border-top">
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <strong class="text-muted me-2">Subject Tags:</strong>
                                {% for tag in case.doc_metadata.subject_tags %}
                                <span class="badge bg-warning text-dark me-1" title="NSPE Subject Classification">
                                    <i class="bi bi-tag"></i> {{ tag }}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        <div class="card-body">
                            {% if case.questions_list %}
                            <div class="mb-3">
                                <h6 class="text-primary">Questions:</h6>
                                {% if case.questions_list|length == 1 %}
                                <p class="mb-2">{{ case.questions_list[0]|striptags|truncate(200) }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for question in case.questions_list[:3] %}
                                    <li>{{ question|striptags|truncate(150) }}</li>
                                    {% endfor %}
                                    {% if case.questions_list|length > 3 %}
                                    <li class="text-muted">... and {{ case.questions_list|length - 3 }} more</li>
                                    {% endif %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            {% if case.conclusion_items %}
                            <div class="mb-3">
                                <h6 class="text-success">Conclusions:</h6>
                                {% if case.conclusion_items|length == 1 %}
                                <p class="mb-2">{{ case.conclusion_items[0]|striptags }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for conclusion in case.conclusion_items %}
                                    <li>{{ conclusion|striptags }}</li>
                                    {% endfor %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="/cases/{{ case.id }}" class="btn btn-sm btn-primary">View Details</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info" role="alert">
        No cases available. Please check the MCP server connection or add new cases.
    </div>
    {% endif %}

</div>
{% endblock %}
