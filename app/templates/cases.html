{% extends "base.html" %}

{% block title %}Case Repository - AI Ethical Decision-Making Simulator{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Case Repository</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        Error loading cases: {{ error }}
    </div>
    {% endif %}

    <div class="row mb-3">
        <div class="col-md-8">
            <form id="caseFilterForm" class="d-flex align-items-center flex-wrap gap-2" action="/cases/" method="get">
                <div class="input-group" style="max-width: 200px;">
                    <select class="form-select form-select-sm" name="world_id" id="worldFilter" aria-label="Filter by World">
                        <option value="">All Worlds</option>
                        {% for world in worlds %}
                        <option value="{{ world.id }}" {% if selected_world_id == world.id %}selected{% endif %}>
                            {{ world.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="input-group" style="max-width: 160px;">
                    <select class="form-select form-select-sm" name="status" id="statusFilter" aria-label="Filter by Status">
                        <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Cases</option>
                        <option value="extracted" {% if status_filter == 'extracted' %}selected{% endif %}>Extracted+</option>
                        <option value="analyzed" {% if status_filter == 'analyzed' %}selected{% endif %}>Analyzed</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('cases.case_options') }}" class="btn btn-success btn-sm">Add New Case</a>
        </div>
    </div>

    <!-- Active Filters Display -->
    {% if selected_tag %}
    <div class="mb-3">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <span class="text-muted small">Filtering by:</span>
            <a href="{{ url_for('cases.list_cases', world_id=selected_world_id, status=status_filter if status_filter != 'all' else none) }}"
               class="badge bg-warning text-dark text-decoration-none tag-filter-link"
               title="Click to clear filter">
                <i class="bi bi-tag-fill"></i> {{ selected_tag }} <i class="bi bi-x"></i>
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Available Tags Filter (expandable) -->
    {% if all_tags and not selected_tag %}
    <div class="mb-3">
        <div class="d-flex align-items-center gap-2 flex-wrap" id="tagFilterContainer">
            <span class="text-muted small">Filter by tag:</span>
            {% for tag in all_tags[:12] %}
            <a href="{{ url_for('cases.list_cases', world_id=selected_world_id, status=status_filter if status_filter != 'all' else none, tag=tag) }}"
               class="badge bg-light text-dark text-decoration-none tag-filter-link"
               title="Show cases with this tag">
                <i class="bi bi-tag"></i> {{ tag }}
            </a>
            {% endfor %}
            {% if all_tags|length > 12 %}
            <a href="#" class="badge bg-secondary text-white text-decoration-none" id="showMoreTags"
               title="Show all tags">
                +{{ all_tags|length - 12 }} more <i class="bi bi-chevron-down"></i>
            </a>
            <!-- Hidden tags shown when expanded -->
            <div id="moreTags" class="d-none d-flex flex-wrap gap-2">
                {% for tag in all_tags[12:] %}
                <a href="{{ url_for('cases.list_cases', world_id=selected_world_id, status=status_filter if status_filter != 'all' else none, tag=tag) }}"
                   class="badge bg-light text-dark text-decoration-none tag-filter-link"
                   title="Show cases with this tag">
                    <i class="bi bi-tag"></i> {{ tag }}
                </a>
                {% endfor %}
            </div>
            <a href="#" class="badge bg-secondary text-white text-decoration-none d-none" id="showLessTags"
               title="Show fewer tags">
                Show less <i class="bi bi-chevron-up"></i>
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if grouped_cases %}
    {% for year, year_cases in grouped_cases.items() %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">{{ year }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% for case in year_cases %}
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                {% if case.doc_metadata and (case.doc_metadata.get('source') == 'agent_generated' or case.doc_metadata.get('source') == 'agent_generated_sample') %}
                                <i class="bi bi-robot text-primary me-2" title="Generated with Language Model assistance"></i>
                                {% endif %}
                                {{ case.title }}
                            </h5>
                            <div>
                                {% if case.case_number %}
                                <span class="badge bg-secondary me-2">Case #{{ case.case_number }}</span>
                                {% endif %}
                                {% if case.pipeline_status == 'analyzed' %}
                                <span class="badge bg-success" title="Step 4 Whole-Case Synthesis completed">
                                    <i class="bi bi-check-circle"></i> Analyzed
                                </span>
                                {% elif case.pipeline_status == 'extracted' %}
                                <span class="badge bg-info" title="Extraction completed (Passes 1-3)">
                                    <i class="bi bi-layers"></i> Extracted
                                </span>
                                {% else %}
                                <span class="badge bg-light text-muted" title="Extraction not yet started">
                                    Not Started
                                </span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Subject Tags (clickable) and Find Similar -->
                        {% if case.doc_metadata and case.doc_metadata.subject_tags %}
                        <div class="card-header border-top py-2">
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                {% for tag in case.doc_metadata.subject_tags %}
                                {% if tag == selected_tag %}
                                <a href="{{ url_for('cases.list_cases', world_id=selected_world_id, status=status_filter if status_filter != 'all' else none) }}"
                                   class="badge text-decoration-none bg-warning text-dark tag-filter-link"
                                   title="Click to clear filter">
                                    <i class="bi bi-tag-fill"></i> {{ tag }} <i class="bi bi-x"></i>
                                </a>
                                {% else %}
                                <a href="{{ url_for('cases.list_cases', world_id=selected_world_id, status=status_filter if status_filter != 'all' else none, tag=tag) }}"
                                   class="badge text-decoration-none bg-light text-dark tag-filter-link"
                                   title="Filter by this tag">
                                    <i class="bi bi-tag"></i> {{ tag }}
                                </a>
                                {% endif %}
                                {% endfor %}
                                <span class="mx-1 text-muted">|</span>
                                <a href="{{ url_for('precedents.find_precedents', case_id=case.id) }}"
                                   class="badge bg-info bg-opacity-25 text-info text-decoration-none"
                                   title="Find cases similar to this one">
                                    <i class="bi bi-diagram-2"></i> Find Similar
                                </a>
                            </div>
                        </div>
                        {% else %}
                        <!-- No tags, but still show Find Similar -->
                        <div class="card-header border-top py-2">
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <a href="{{ url_for('precedents.find_precedents', case_id=case.id) }}"
                                   class="badge bg-info bg-opacity-25 text-info text-decoration-none"
                                   title="Find cases similar to this one">
                                    <i class="bi bi-diagram-2"></i> Find Similar
                                </a>
                            </div>
                        </div>
                        {% endif %}

                        <div class="card-body">
                            {% if case.questions_list %}
                            <div class="mb-3">
                                <h6 class="text-primary">Questions:</h6>
                                {% if case.questions_list|length == 1 %}
                                <p class="mb-2">{{ case.questions_list[0]|striptags|truncate(200) }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for question in case.questions_list[:3] %}
                                    <li>{{ question|striptags|truncate(150) }}</li>
                                    {% endfor %}
                                    {% if case.questions_list|length > 3 %}
                                    <li class="text-muted">... and {{ case.questions_list|length - 3 }} more</li>
                                    {% endif %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}

                            {% if case.conclusion_items %}
                            <div class="mb-3">
                                <h6 class="text-success">Conclusions:</h6>
                                {% if case.conclusion_items|length == 1 %}
                                <p class="mb-2">{{ case.conclusion_items[0]|striptags }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for conclusion in case.conclusion_items %}
                                    <li>{{ conclusion|striptags }}</li>
                                    {% endfor %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="/cases/{{ case.id }}" class="btn btn-sm btn-primary">View Details</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info" role="alert">
        {% if selected_tag %}
        No cases found with tag "{{ selected_tag }}".
        <a href="{{ url_for('cases.list_cases', world_id=selected_world_id, status=status_filter if status_filter != 'all' else none) }}">Clear filter</a>
        {% else %}
        No cases available. Please check the MCP server connection or add new cases.
        {% endif %}
    </div>
    {% endif %}

</div>

<style>
.tag-filter-link {
    transition: all 0.2s ease;
    cursor: pointer;
}
.tag-filter-link:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}
</style>

<script>
    // Handle filter changes properly
    document.getElementById('worldFilter').addEventListener('change', function() {
        updateCaseFilters();
    });

    document.getElementById('statusFilter').addEventListener('change', function() {
        updateCaseFilters();
    });

    function updateCaseFilters() {
        const worldId = document.getElementById('worldFilter').value;
        const status = document.getElementById('statusFilter').value;

        // Build URL parameters - only include non-default values for clean URLs
        const params = new URLSearchParams();

        // Only add world_id if it has a value
        if (worldId) {
            params.append('world_id', worldId);
        }

        // Only add status if not 'all' (default)
        if (status && status !== 'all') {
            params.append('status', status);
        }

        // Preserve tag filter if present
        const currentParams = new URLSearchParams(window.location.search);
        if (currentParams.has('tag')) {
            params.append('tag', currentParams.get('tag'));
        }

        // Navigate to the filtered URL (clean URL if no params)
        const queryString = params.toString();
        window.location.href = '/cases/' + (queryString ? '?' + queryString : '');
    }

    // Expandable tag filter
    const showMoreBtn = document.getElementById('showMoreTags');
    const showLessBtn = document.getElementById('showLessTags');
    const moreTags = document.getElementById('moreTags');

    if (showMoreBtn) {
        showMoreBtn.addEventListener('click', function(e) {
            e.preventDefault();
            moreTags.classList.remove('d-none');
            showMoreBtn.classList.add('d-none');
            showLessBtn.classList.remove('d-none');
        });
    }

    if (showLessBtn) {
        showLessBtn.addEventListener('click', function(e) {
            e.preventDefault();
            moreTags.classList.add('d-none');
            showLessBtn.classList.add('d-none');
            showMoreBtn.classList.remove('d-none');
        });
    }
</script>
{% endblock %}
