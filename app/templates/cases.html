{% extends "base.html" %}

{% block title %}Case Repository - AI Ethical Decision-Making Simulator{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Case Repository</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        Error loading cases: {{ error }}
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-8">
            <form id="caseFilterForm" class="d-flex" action="/cases/" method="get">
                <div class="input-group me-2">
                    <select class="form-select" name="world_id" id="worldFilter" aria-label="Filter by World" onchange="this.form.submit()">
                        <option value="">All Worlds</option>
                        {% for world in worlds %}
                        <option value="{{ world.id }}" {% if selected_world_id == world.id %}selected{% endif %}>
                            {{ world.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <input class="form-control" type="search" placeholder="Search cases..." name="query" value="{{ query }}"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </div>
            </form>
        </div>
        <div class="col-md-4 text-end">
            <a href="{{ url_for('cases.case_options') }}" class="btn btn-success">Add New Case</a>
        </div>
    </div>
    
    <!-- Processing Status Legend -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex align-items-center justify-content-end text-muted small">
                <span class="me-3">Processing Status:</span>
                <span class="badge bg-success me-2">
                    <i class="bi bi-link-45deg"></i> EGA
                </span>
                <span class="me-3">Enhanced Guideline Associations</span>
                <span class="badge bg-primary me-2">
                    <i class="bi bi-diagram-3"></i> OTL
                </span>
                <span class="me-2">Ontology Term Links</span>
            </div>
        </div>
    </div>

    {% if grouped_cases %}
    {% for year, year_cases in grouped_cases.items() %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">{{ year }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% for case in year_cases %}
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                {% if case.doc_metadata and (case.doc_metadata.get('source') == 'agent_generated' or case.doc_metadata.get('source') == 'agent_generated_sample') %}
                                <i class="bi bi-robot text-primary me-2" title="Generated with Language Model assistance"></i>
                                {% endif %}
                                {{ case.title }}
                            </h5>
                            <div>
                                {% if case.case_number %}
                                <span class="badge bg-secondary me-2">Case #{{ case.case_number }}</span>
                                {% endif %}
                                {% if case.full_date %}
                                <span class="badge bg-info me-2">{{ case.full_date }}</span>
                                {% endif %}
                                <!-- Processing Status Icons -->
                                {% if case.has_enhanced_associations %}
                                <span class="badge bg-success me-1" title="Enhanced Guideline Associations available">
                                    <i class="bi bi-link-45deg"></i> EGA
                                </span>
                                {% endif %}
                                {% if case.has_term_links %}
                                <span class="badge bg-primary me-1" title="Ontology Term Links available">
                                    <i class="bi bi-diagram-3"></i> OTL
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            {% if case.questions_list %}
                            <div class="mb-3">
                                <h6 class="text-primary">Questions:</h6>
                                {% if case.questions_list|length == 1 %}
                                <p class="mb-2">{{ case.questions_list[0]|striptags|truncate(200) }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for question in case.questions_list[:3] %}
                                    <li>{{ question|striptags|truncate(150) }}</li>
                                    {% endfor %}
                                    {% if case.questions_list|length > 3 %}
                                    <li class="text-muted">... and {{ case.questions_list|length - 3 }} more</li>
                                    {% endif %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            {% if case.conclusion_items %}
                            <div class="mb-3">
                                <h6 class="text-success">Conclusions:</h6>
                                {% if case.conclusion_items|length == 1 %}
                                <p class="mb-2">{{ case.conclusion_items[0]|striptags|truncate(200) }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for conclusion in case.conclusion_items[:2] %}
                                    <li>{{ conclusion|striptags|truncate(150) }}</li>
                                    {% endfor %}
                                    {% if case.conclusion_items|length > 2 %}
                                    <li class="text-muted">... and {{ case.conclusion_items|length - 2 }} more</li>
                                    {% endif %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="/cases/{{ case.id }}" class="btn btn-sm btn-primary">View Details</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info" role="alert">
        No cases available. Please check the MCP server connection or add new cases.
    </div>
    {% endif %}

    <div class="mt-4">
        <h2>About the Case Repository</h2>
        <p>
            This repository contains professional ethics cases where abstract principles are applied to
            concrete situations. Each case demonstrates how ethical guidelines are interpreted and applied
            in specific contexts through structured analysis and expert reasoning.
        </p>
        <p>
            Cases are organized by year and provide examples of how ethical principles are weighed
            and resolved when they appear to conflict. The repository includes the factual circumstances,
            relevant ethical provisions, discussion of competing considerations, and final determinations.
        </p>
        <p>
            Each case typically includes:
        </p>
        <ul>
            <li><strong>Facts</strong> - The circumstances and context of the situation</li>
            <li><strong>Questions</strong> - The specific ethical questions being examined</li>
            <li><strong>References</strong> - Citations to relevant codes of ethics or professional standards</li>
            <li><strong>Discussion</strong> - Analysis of the ethical considerations and precedents</li>
            <li><strong>Conclusions</strong> - The final determinations or recommendations</li>
        </ul>
        <p>
            Cases are stored with structured metadata that enables searching by content, year, and thematic
            categorization. The semantic representation captures relationships between ethical principles,
            factual circumstances, and reasoning patterns to support comparative analysis across cases.
        </p>
    </div>
</div>
{% endblock %}
