{% extends "base.html" %}

{% block title %}Case Repository - AI Ethical Decision-Making Simulator{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">Case Repository</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        Error loading cases: {{ error }}
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-md-8">
            <form id="caseFilterForm" class="d-flex" action="/cases/" method="get">
                <div class="input-group me-2">
                    <select class="form-select" name="world_id" id="worldFilter" aria-label="Filter by World" onchange="this.form.submit()">
                        <option value="">All Worlds</option>
                        {% for world in worlds %}
                        <option value="{{ world.id }}" {% if selected_world_id == world.id %}selected{% endif %}>
                            {{ world.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <input class="form-control" type="search" placeholder="Search cases..." name="query" value="{{ query }}"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </div>
            </form>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <a href="{{ url_for('cases.case_options') }}" class="btn btn-success">Add New Case</a>
                <a href="/cases/triple/new" class="btn btn-primary">
                    <i class="bi bi-diagram-3"></i> Create Triple-Based Case
                </a>
            </div>
        </div>
    </div>

    {% if grouped_cases %}
    {% for year, year_cases in grouped_cases.items() %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">{{ year }}</h3>
        </div>
        <div class="card-body">
            <div class="row">
                {% for case in year_cases %}
                <div class="col-12 mb-3">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">{{ case.title }}</h5>
                            <div>
                                {% if case.case_number %}
                                <span class="badge bg-secondary me-2">Case #{{ case.case_number }}</span>
                                {% endif %}
                                {% if case.full_date %}
                                <span class="badge bg-info">{{ case.full_date }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            {% if case.questions_list %}
                            <div class="mb-3">
                                <h6 class="text-primary">Questions:</h6>
                                {% if case.questions_list|length == 1 %}
                                <p class="mb-2">{{ case.questions_list[0]|striptags|truncate(200) }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for question in case.questions_list[:3] %}
                                    <li>{{ question|striptags|truncate(150) }}</li>
                                    {% endfor %}
                                    {% if case.questions_list|length > 3 %}
                                    <li class="text-muted">... and {{ case.questions_list|length - 3 }} more</li>
                                    {% endif %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            {% if case.conclusion_items %}
                            <div class="mb-3">
                                <h6 class="text-success">Conclusions:</h6>
                                {% if case.conclusion_items|length == 1 %}
                                <p class="mb-2">{{ case.conclusion_items[0]|striptags|truncate(200) }}</p>
                                {% else %}
                                <ol class="mb-2">
                                    {% for conclusion in case.conclusion_items[:2] %}
                                    <li>{{ conclusion|striptags|truncate(150) }}</li>
                                    {% endfor %}
                                    {% if case.conclusion_items|length > 2 %}
                                    <li class="text-muted">... and {{ case.conclusion_items|length - 2 }} more</li>
                                    {% endif %}
                                </ol>
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a href="/cases/{{ case.id }}" class="btn btn-sm btn-primary">View Details</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info" role="alert">
        No cases available. Please check the MCP server connection or add new cases.
    </div>
    {% endif %}

    <div class="mt-4">
        <h2>About the Case Repository</h2>
        <p>
            This repository contains historical engineering ethics cases where abstract principles were applied to
            concrete situations.
            Each case provides insight into how ethical principles are operationalized - that is, how the gap between
            abstract rules
            and specific facts is bridged through reasoning and explanation by ethics experts.
        </p>
        <p>
            The cases in this repository serve as reference points for analogical reasoning when evaluating new ethical
            dilemmas. They demonstrate how seemingly conflicting principles (such as duty to public safety versus
            obligation
            of confidentiality) can be weighed and resolved in specific contexts.
        </p>
        <p>
            Each case includes:
        </p>
        <ul>
            <li><strong>Description</strong> - The detailed scenario and context of the ethical dilemma</li>
            <li><strong>Decision</strong> - The ethical judgment reached about the engineer's actions</li>
            <li><strong>Outcome</strong> - The consequences of the decision</li>
            <li><strong>Ethical Analysis</strong> - Expert reasoning that links abstract principles to specific facts
            </li>
        </ul>
        <p>
            Cases may be represented in two complementary formats:
        </p>
        <ul>
            <li><strong>Standard Format</strong> - Traditional narrative representation with structured fields</li>
            <li><strong>Triple-Based Format</strong> - Semantic representation using RDF triples to express complex
                relationships
                between principles, actions, and outcomes</li>
        </ul>
        <p>
            The triple-based approach enables more sophisticated queries across cases to identify patterns in ethical
            reasoning
            and principle application.
        </p>
    </div>
</div>
{% endblock %}
