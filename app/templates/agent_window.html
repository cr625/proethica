{% extends "base.html" %}

{% block title %}Agent Window Prototype{% endblock %}

{% block styles %}
<style>
    .agent-window {
        height: 400px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .conversation {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        display: block;
    }

    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .agent-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
        text-align: left;
    }

    .input-area {
        padding: 10px;
        border-top: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        background-color: white;
        position: sticky;
        bottom: 0;
        width: 100%;
    }

    .prompt-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .prompt-option {
        background-color: #e9ecef;
        border: none;
        border-radius: 16px;
        padding: 8px 16px;
        cursor: pointer;
    }

    .prompt-option:hover {
        background-color: #dee2e6;
    }

    .input-disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .guidelines {
        margin-top: 20px;
        padding: 15px;
        background-color: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 123, 255, 0.3);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Agent Window Prototype</h1>
    <p class="lead">This is a prototype of the agent window interface.</p>

    <div id="agent-app">
        <!-- World selection dropdown -->
        <div class="mb-3">
            <label for="world-select" class="form-label">Select World:</label>
            <select id="world-select" class="form-select" v-model="selectedWorldId" @change="worldChanged">
                <option value="">-- Select a World --</option>
                {% for world in worlds %}
                <option value="{{ world.id }}">{{ world.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Agent window -->
        <div class="agent-window">
            <div class="conversation" ref="conversation">
                <div v-for="(message, index) in messages" :key="index" class="message"
                    :class="message.role === 'user' ? 'user-message' : 'agent-message'">
                    {% raw %}{{ message.content }}{% endraw %}
                </div>
                <div v-if="isProcessing" class="message agent-message">
                    <div class="loading"></div> Thinking...
                </div>
            </div>

            <div class="input-area">
                <div v-if="promptOptions.length > 0" class="prompt-options w-100">
                    <button v-for="option in promptOptions" :key="option.id" class="prompt-option"
                        @click="selectPromptOption(option)">
                        {% raw %}{{ option.text }}{% endraw %}
                    </button>
                </div>

                <div v-else class="input-group">
                    <input type="text" class="form-control" v-model="userInput"
                        :disabled="!inputEnabled || isProcessing"
                        :class="{ 'input-disabled': !inputEnabled || isProcessing }" placeholder="Type your message..."
                        @keyup.enter="sendMessage">
                    <button class="btn btn-primary" @click="sendMessage" :disabled="!inputEnabled || isProcessing">
                        Send
                    </button>
                </div>
            </div>
        </div>

        <!-- Guidelines section -->
        <div v-if="guidelines" class="guidelines">
            <h3>Guidelines</h3>
            <div v-html="formattedGuidelines"></div>
        </div>

        <!-- Reset button -->
        <button class="btn btn-secondary mt-3" @click="resetConversation">
            Reset Conversation
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Vue.js and Axios -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    new Vue({
        el: '#agent-app',
        data: {
            messages: [],
            userInput: '',
            inputEnabled: true,
            promptOptions: [],
            isProcessing: false,
            selectedWorldId: '{{ selected_world.id if selected_world else "" }}',
            guidelines: '',
            formattedGuidelines: ''
        },
        created() {
            // Initialize conversation from session
            this.initializeConversation();

            // Get prompt options
            this.getPromptOptions();

            // Get guidelines if world is selected
            if (this.selectedWorldId) {
                this.getGuidelines();
            }
        },
        methods: {
            initializeConversation() {
                // Initialize with a welcome message
                this.messages = [
                    { role: 'assistant', content: 'Hello! I am your AI assistant for ethical decision-making. How can I help you today?' }
                ];
            },
            sendMessage() {
                if (!this.inputEnabled || !this.userInput.trim() || this.isProcessing) return;

                // Add user message to conversation
                this.messages.push({ role: 'user', content: this.userInput });

                // Clear input and disable it while processing
                const userMessage = this.userInput;
                this.userInput = '';
                this.inputEnabled = true;
                this.isProcessing = true;
                this.promptOptions = [];

                // Scroll to bottom
                this.scrollToBottom();

                // Send message to API
                axios.post('/agent/api/message', {
                    message: userMessage,
                    world_id: this.selectedWorldId || null
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Add assistant response to conversation
                            this.messages.push({
                                role: response.data.message.role,
                                content: response.data.message.content
                            });

                            // Get new prompt options
                            this.getPromptOptions();
                        } else {
                            // Add error message
                            this.messages.push({
                                role: 'assistant',
                                content: 'Sorry, there was an error processing your request.'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        // Add error message
                        this.messages.push({
                            role: 'assistant',
                            content: 'Sorry, there was an error processing your request.'
                        });
                    })
                    .finally(() => {
                        // Re-enable input
                        this.isProcessing = false;
                        this.scrollToBottom();
                    });
            },
            selectPromptOption(option) {
                // Add selected option to conversation as user message
                this.messages.push({ role: 'user', content: option.text });

                // Clear prompt options and disable input while processing
                this.promptOptions = [];
                this.inputEnabled = true;
                this.isProcessing = true;

                // Scroll to bottom
                this.scrollToBottom();

                // Send message to API
                axios.post('/agent/api/message', {
                    message: option.text,
                    world_id: this.selectedWorldId || null
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Add assistant response to conversation
                            this.messages.push({
                                role: response.data.message.role,
                                content: response.data.message.content
                            });

                            // Get new prompt options
                            this.getPromptOptions();
                        } else {
                            // Add error message
                            this.messages.push({
                                role: 'assistant',
                                content: 'Sorry, there was an error processing your request.'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        // Add error message
                        this.messages.push({
                            role: 'assistant',
                            content: 'Sorry, there was an error processing your request.'
                        });
                    })
                    .finally(() => {
                        // Re-enable input
                        this.isProcessing = false;
                        this.scrollToBottom();
                    });
            },
            getPromptOptions() {
                // Get prompt options from API
                axios.get('/agent/api/options', {
                    params: {
                        world_id: this.selectedWorldId || null
                    }
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.promptOptions = response.data.options;
                        } else {
                            this.promptOptions = [];
                        }
                    })
                    .catch(error => {
                        console.error('Error getting prompt options:', error);
                        this.promptOptions = [];
                    });
            },
            worldChanged() {
                // Reset conversation when world changes
                this.resetConversation();

                // Get guidelines for the selected world
                if (this.selectedWorldId) {
                    this.getGuidelines();
                } else {
                    this.guidelines = '';
                    this.formattedGuidelines = '';
                }
            },
            getGuidelines() {
                if (!this.selectedWorldId) return;

                // Get guidelines from API
                axios.get('/agent/api/guidelines', {
                    params: {
                        world_id: this.selectedWorldId
                    }
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.guidelines = response.data.guidelines;
                            // Format guidelines as HTML using marked.js
                            this.formattedGuidelines = marked.parse(this.guidelines);
                        } else {
                            this.guidelines = '';
                            this.formattedGuidelines = '';
                        }
                    })
                    .catch(error => {
                        console.error('Error getting guidelines:', error);
                        this.guidelines = '';
                        this.formattedGuidelines = '';
                    });
            },
            resetConversation() {
                // Reset conversation
                axios.post('/agent/api/reset', {
                    world_id: this.selectedWorldId || null
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Reset conversation
                            this.initializeConversation();

                            // Get new prompt options
                            this.getPromptOptions();
                        }
                    })
                    .catch(error => {
                        console.error('Error resetting conversation:', error);
                    });
            },
            scrollToBottom() {
                // Scroll to bottom of conversation when new messages are added
                this.$nextTick(() => {
                    const container = this.$refs.conversation;
                    container.scrollTop = container.scrollHeight;
                });
            }
        },
        updated() {
            // Scroll to bottom of conversation when new messages are added
            this.scrollToBottom();
        }
    });
</script>
{% endblock %}