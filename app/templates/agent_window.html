{% extends "base.html" %}

{% block title %}Agent Window Prototype{% endblock %}

{% block styles %}
<style>
    .agent-window {
        height: 70vh; /* Use viewport height to make it taller */
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .conversation {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        display: block;
    }

    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .agent-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
        text-align: left;
    }

    .input-area {
        padding: 10px;
        border-top: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        background-color: white;
        position: sticky;
        bottom: 0;
        width: 100%;
    }

    .prompt-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .prompt-option {
        background-color: #e9ecef;
        border: none;
        border-radius: 12px;
        padding: 4px 10px;
        font-size: 0.9rem;
        margin: 2px;
        cursor: pointer;
    }

    .prompt-option:hover {
        background-color: #dee2e6;
    }

    .input-disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .guidelines {
        padding: 15px;
        background-color: #f8f9fa;
        border: 1px solid #ccc;
        border-radius: 8px;
        height: 70vh; /* Match the agent window height */
        overflow-y: auto;
        margin-bottom: 20px;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 123, 255, 0.3);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div id="agent-app">
        <!-- World selection and service selection -->
        <div class="row mb-3">
            <div class="col-md-8">
                <label for="world-select" class="form-label">Select World:</label>
                <select id="world-select" class="form-select" v-model="selectedWorldId" @change="worldChanged">
                    <option value="">-- Select a World --</option>
                    {% for world in worlds %}
                    <option value="{{ world.id }}">{{ world.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label for="service-select" class="form-label">LLM Service:</label>
                <select id="service-select" class="form-select" v-model="selectedService" @change="serviceChanged">
                    <option value="claude">Claude (Anthropic)</option>
                    <option value="langchain">LangChain (Mock)</option>
                </select>
            </div>
        </div>

        <div class="row">
            <!-- Agent window - left column -->
            <div class="col-md-8">
                <div class="agent-window">
                    <div class="conversation" ref="conversation">
                        <div v-for="(message, index) in messages" :key="index" class="message"
                            :class="message.role === 'user' ? 'user-message' : 'agent-message'">
                            {% raw %}{{ message.content }}{% endraw %}
                        </div>
                        <div v-if="isProcessing" class="message agent-message">
                            <div class="loading"></div> Thinking...
                        </div>
                    </div>

                    <div class="input-area">
                        <!-- Add suggestion button when world is selected but no suggestions are shown -->
                        <div v-if="selectedWorldId && promptOptions.length === 0" class="w-100 mb-2">
                            <button 
                                class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center" 
                                @click="generateSuggestions" 
                                :disabled="isFetchingSuggestions">
                                <i class="bi bi-lightbulb me-2" style="font-size: 1.1rem;"></i>
                                <span>Generate Suggestions</span>
                                <span v-if="isFetchingSuggestions" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
                            </button>
                        </div>
                        
                        <!-- Show prompt options when world is selected and options are available -->
                        <div v-if="selectedWorldId && promptOptions.length > 0" class="prompt-options w-100">
                            <button v-for="option in promptOptions" :key="option.id" class="prompt-option"
                                @click="selectPromptOption(option)">
                                {% raw %}{{ option.text }}{% endraw %}
                            </button>
                        </div>

                        <!-- Input box is always shown, but with different placeholder based on world selection -->
                        <div class="input-group">
                            <input type="text" class="form-control" v-model="userInput"
                                :disabled="!inputEnabled || isProcessing"
                                :class="{ 'input-disabled': !inputEnabled || isProcessing }" 
                                :placeholder="selectedWorldId ? 'Type your message about this world...' : 'Type any test message to Claude...'"
                                @keyup.enter="sendMessage">
                            <button class="btn btn-primary" @click="sendMessage" :disabled="!inputEnabled || isProcessing">
                                Send
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Reset button -->
                <button class="btn btn-secondary mt-2" @click="resetConversation">
                    Reset Conversation
                </button>
            </div>

            <!-- Guidelines section - right column -->
            <div class="col-md-4">
                <div v-if="guidelines" class="guidelines h-100">
                    <h5>World Guidelines</h5>
                    <div v-html="formattedGuidelines"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Vue.js and Axios -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    new Vue({
        el: '#agent-app',
        data: {
            messages: [],
            userInput: '',
            inputEnabled: true,
            promptOptions: [],
            isProcessing: false,
            isFetchingSuggestions: false, // Added for suggestion button loading state
            selectedWorldId: '{{ selected_world.id if selected_world else "" }}',
            selectedService: 'claude', // Default to Claude
            guidelines: '',
            formattedGuidelines: '',
            welcomeMessage: '{{ welcome_message | safe }}' // Get welcome message from Flask
        },
        created() {
            // Initialize conversation from session
            this.initializeConversation();

            // Get guidelines if world is selected
            if (this.selectedWorldId) {
                this.getGuidelines();
                // No longer automatically fetch prompt options
            }
        },
        methods: {
            initializeConversation() {
                // Initialize with a welcome message from the server
                this.messages = [
                    { role: 'assistant', content: this.welcomeMessage }
                ];
            },
            sendMessage() {
                if (!this.inputEnabled || !this.userInput.trim() || this.isProcessing) return;

                // Add user message to conversation
                this.messages.push({ role: 'user', content: this.userInput });

                // Clear input and disable it while processing
                const userMessage = this.userInput;
                this.userInput = '';
                this.inputEnabled = true;
                this.isProcessing = true;
                this.promptOptions = [];

                // Scroll to bottom
                this.scrollToBottom();

                // Send message to API
                axios.post('/agent/api/message', {
                    message: userMessage,
                    world_id: this.selectedWorldId || null
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Add assistant response to conversation
                            this.messages.push({
                                role: response.data.message.role,
                                content: response.data.message.content
                            });

                            // Get new prompt options
                            this.getPromptOptions();
                        } else {
                            // Add error message
                            this.messages.push({
                                role: 'assistant',
                                content: 'Sorry, there was an error processing your request.'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        // Add error message
                        this.messages.push({
                            role: 'assistant',
                            content: 'Sorry, there was an error processing your request.'
                        });
                    })
                    .finally(() => {
                        // Re-enable input
                        this.isProcessing = false;
                        this.scrollToBottom();
                    });
            },
            selectPromptOption(option) {
                // Add selected option to conversation as user message
                this.messages.push({ role: 'user', content: option.text });

                // Clear prompt options and disable input while processing
                this.promptOptions = [];
                this.inputEnabled = true;
                this.isProcessing = true;

                // Scroll to bottom
                this.scrollToBottom();

                // Send message to API
                axios.post('/agent/api/message', {
                    message: option.text,
                    world_id: this.selectedWorldId || null
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Add assistant response to conversation
                            this.messages.push({
                                role: response.data.message.role,
                                content: response.data.message.content
                            });

                            // Get new prompt options
                            this.getPromptOptions();
                        } else {
                            // Add error message
                            this.messages.push({
                                role: 'assistant',
                                content: 'Sorry, there was an error processing your request.'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        // Add error message
                        this.messages.push({
                            role: 'assistant',
                            content: 'Sorry, there was an error processing your request.'
                        });
                    })
                    .finally(() => {
                        // Re-enable input
                        this.isProcessing = false;
                        this.scrollToBottom();
                    });
            },
            getPromptOptions() {
                // Get prompt options from API
                axios.get('/agent/api/options', {
                    params: {
                        world_id: this.selectedWorldId || null
                    }
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.promptOptions = response.data.options;
                        } else {
                            this.promptOptions = [];
                        }
                    })
                    .catch(error => {
                        console.error('Error getting prompt options:', error);
                        this.promptOptions = [];
                    });
            },
            generateSuggestions() {
                if (!this.selectedWorldId || this.isFetchingSuggestions) return;
                
                // Set loading state
                this.isFetchingSuggestions = true;
                
                // Call API to get suggestions
                axios.get('/agent/api/options', {
                    params: {
                        world_id: this.selectedWorldId || null
                    }
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.promptOptions = response.data.options;
                        } else {
                            this.promptOptions = [];
                        }
                    })
                    .catch(error => {
                        console.error('Error getting prompt options:', error);
                        this.promptOptions = [];
                    })
                    .finally(() => {
                        this.isFetchingSuggestions = false;
                    });
            },
            worldChanged() {
                // Reset conversation when world changes
                this.resetConversation();

                // Get guidelines for the selected world
                if (this.selectedWorldId) {
                    this.getGuidelines();
                    // No longer automatically fetch prompt options
                } else {
                    this.guidelines = '';
                    this.formattedGuidelines = '';
                }
            },
            getGuidelines() {
                if (!this.selectedWorldId) return;

                // Get guidelines from API
                axios.get('/agent/api/guidelines', {
                    params: {
                        world_id: this.selectedWorldId
                    }
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.guidelines = response.data.guidelines;
                            // Format guidelines as HTML using marked.js
                            this.formattedGuidelines = marked.parse(this.guidelines);
                        } else {
                            this.guidelines = '';
                            this.formattedGuidelines = '';
                        }
                    })
                    .catch(error => {
                        console.error('Error getting guidelines:', error);
                        this.guidelines = '';
                        this.formattedGuidelines = '';
                    });
            },
            resetConversation() {
                // Reset conversation
                axios.post('/agent/api/reset', {
                    world_id: this.selectedWorldId || null
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Reset conversation
                            this.initializeConversation();
                            
                            // Clear any existing prompt options
                            this.promptOptions = [];
                        }
                    })
                    .catch(error => {
                        console.error('Error resetting conversation:', error);
                    });
            },
            serviceChanged() {
                // Switch between Claude and LangChain services
                this.isProcessing = true;

                axios.post('/agent/api/switch_service', {
                    service: this.selectedService,
                    world_id: this.selectedWorldId || null
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Add system message about service change
                            this.messages = [
                                {
                                    role: 'assistant',
                                    content: `Switched to ${this.selectedService === 'claude' ? 'Claude (Anthropic)' : 'LangChain (Mock)'} service. How can I help you today?`
                                }
                            ];

                            // Clear any existing prompt options
                            this.promptOptions = [];
                        } else {
                            // Add error message
                            this.messages.push({
                                role: 'assistant',
                                content: 'Sorry, there was an error switching services.'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error switching services:', error);
                        // Add error message
                        this.messages.push({
                            role: 'assistant',
                            content: 'Sorry, there was an error switching services.'
                        });
                    })
                    .finally(() => {
                        this.isProcessing = false;
                    });
            },
            scrollToBottom() {
                // Scroll to bottom of conversation when new messages are added
                this.$nextTick(() => {
                    const container = this.$refs.conversation;
                    container.scrollTop = container.scrollHeight;
                });
            }
        },
        updated() {
            // Scroll to bottom of conversation when new messages are added
            this.scrollToBottom();
        }
    });
</script>
{% endblock %}
