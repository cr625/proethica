{% extends "base.html" %}

{% block title %}Agent Window Prototype{% endblock %}

{% block styles %}
<style>
    .agent-window {
        height: 400px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .conversation {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        display: block;
    }

    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .agent-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
        text-align: left;
    }

    .input-area {
        padding: 10px;
        border-top: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        background-color: white;
        position: sticky;
        bottom: 0;
        width: 100%;
    }

    .prompt-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .prompt-option {
        background-color: #e9ecef;
        border: none;
        border-radius: 16px;
        padding: 8px 16px;
        cursor: pointer;
    }

    .prompt-option:hover {
        background-color: #dee2e6;
    }

    .input-disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Agent Window Prototype</h1>
    <p class="lead">This is a prototype of the agent window interface.</p>

    <div id="agent-app">
        <!-- Vue app will be mounted here -->
        <div class="agent-window">
            <div class="conversation" ref="conversation">
                <div v-for="(message, index) in messages" :key="index" class="message"
                    :class="message.sender === 'user' ? 'user-message' : 'agent-message'">
                    {% raw %}{{ message.text }}{% endraw %}
                </div>
            </div>

            <div class="input-area">
                <div v-if="promptOptions.length > 0" class="prompt-options w-100">
                    <button v-for="(option, index) in promptOptions" :key="index" class="prompt-option"
                        @click="selectPromptOption(option)">
                        {% raw %}{{ option.text }}{% endraw %}
                    </button>
                </div>

                <div v-else class="input-group">
                    <input type="text" class="form-control" v-model="userInput" :disabled="!inputEnabled"
                        :class="{ 'input-disabled': !inputEnabled }" placeholder="Type your message..."
                        @keyup.enter="sendMessage">
                    <button class="btn btn-primary" @click="sendMessage" :disabled="!inputEnabled">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include Vue.js -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script>
    // This is a placeholder for the Vue app
    // We'll implement the full Vue component in Step 4
    new Vue({
        el: '#agent-app',
        data: {
            messages: [
                { sender: 'agent', text: 'Hello! I am your AI assistant. How can I help you today?' }
            ],
            userInput: '',
            inputEnabled: true,
            promptOptions: [
                { id: 1, text: 'Tell me about this page' },
                { id: 2, text: 'What can you help me with?' },
                { id: 3, text: 'How do I use this interface?' }
            ],
            isProcessing: false
        },
        methods: {
            sendMessage() {
                if (!this.inputEnabled || !this.userInput.trim()) return;

                // Add user message to conversation
                this.messages.push({ sender: 'user', text: this.userInput });

                // Clear input and disable it while processing
                const userMessage = this.userInput;
                this.userInput = '';
                this.inputEnabled = false;
                this.isProcessing = true;

                // Simulate response (this will be replaced with actual API call)
                setTimeout(() => {
                    this.messages.push({
                        sender: 'agent',
                        text: 'This is a simulated response. The actual LLM integration will be implemented in the next steps.'
                    });

                    // Re-enable input
                    this.inputEnabled = true;
                    this.isProcessing = false;

                    // Show prompt options instead of free input
                    this.promptOptions = [
                        { id: 4, text: 'Tell me more' },
                        { id: 5, text: 'How does this work?' }
                    ];
                }, 1000);
            },
            selectPromptOption(option) {
                // Add selected option to conversation as user message
                this.messages.push({ sender: 'user', text: option.text });

                // Clear prompt options and disable input while processing
                this.promptOptions = [];
                this.inputEnabled = false;
                this.isProcessing = true;

                // Simulate response (this will be replaced with actual API call)
                setTimeout(() => {
                    this.messages.push({
                        sender: 'agent',
                        text: `You selected option: ${option.text}. This is a simulated response.`
                    });

                    // Re-enable input
                    this.inputEnabled = true;
                    this.isProcessing = false;
                }, 1000);
            }
        },
        updated() {
            // Scroll to bottom of conversation when new messages are added
            this.$nextTick(() => {
                const container = this.$refs.conversation;
                container.scrollTop = container.scrollHeight;
            });
        }
    });
</script>
{% endblock %}