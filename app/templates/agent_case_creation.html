{% extends "base.html" %}

{% block title %}Language Model-Assisted Case Creation - AI Ethical Decision-Making Simulator{% endblock %}

{% block styles %}
<style>
/* Agent Window Styling - Based on existing patterns */
.agent-window {
    display: flex;
    height: 75vh;
    min-height: 600px;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background-color: white;
}

/* Left Panel - Ontology Categories */
.ontology-panel {
    width: 300px;
    background-color: #f8f9fa;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    transition: width 0.3s ease;
}

.ontology-panel.collapsed {
    width: 60px;
}

.ontology-panel-header {
    padding: 15px;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
}

.ontology-panel.collapsed .ontology-panel-header {
    padding: 15px 10px;
}

.ontology-panel.collapsed .panel-title {
    display: none;
}

.panel-toggle {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.2em;
}

.ontology-content {
    flex: 1;
    overflow-y: auto;
    padding: 0;
}

.ontology-panel.collapsed .ontology-content {
    display: none;
}

/* Category Selection Styling */
.category-section {
    margin-bottom: 15px;
}

.category-header {
    background-color: #e9ecef;
    padding: 10px 15px;
    font-weight: bold;
    cursor: pointer;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background-color 0.2s;
}

.category-header:hover {
    background-color: #dee2e6;
}

.category-content {
    padding: 10px 15px;
    border-bottom: 1px solid #f0f0f0;
}

.category-checkbox {
    margin-bottom: 10px;
}

.category-checkbox input[type="checkbox"] {
    margin-right: 8px;
}

.category-checkbox label {
    margin-bottom: 0;
    font-weight: 500;
    cursor: pointer;
}

.concept-count {
    background-color: #6c757d;
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.8em;
    margin-left: 5px;
}

.concept-preview {
    margin-top: 8px;
    padding-left: 20px;
}

.concept-preview small {
    color: #6c757d;
    font-style: italic;
}

/* Center Panel - Agent Conversation */
.conversation-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    background-color: white;
    min-width: 0; /* Prevents flex item from overflowing */
}

.conversation-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border-bottom: 1px solid #ddd;
}

.conversation-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.conversation-area {
    flex: 1;
    min-height: 300px;
    margin-bottom: 20px;
}

.message {
    margin-bottom: 20px;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.user-message {
    text-align: right;
}

.user-message .message-bubble {
    background: #007bff;
    color: white;
    padding: 12px 16px;
    border-radius: 18px 18px 4px 18px;
    display: inline-block;
    max-width: 80%;
    text-align: left;
}

.agent-message {
    text-align: left;
}

.agent-message .message-bubble {
    background: #f8f9fa;
    color: #333;
    padding: 12px 16px;
    border-radius: 18px 18px 18px 4px;
    display: inline-block;
    max-width: 80%;
    border: 1px solid #e9ecef;
}

.agent-message .message-header {
    font-weight: bold;
    color: #28a745;
    margin-bottom: 8px;
    font-size: 0.9em;
}

/* Input Area */
.input-area {
    border-top: 1px solid #ddd;
    padding: 15px 20px;
    background-color: #f8f9fa;
}

.input-group {
    display: flex;
    gap: 10px;
}

.input-group textarea {
    flex: 1;
    border: 1px solid #ddd;
    border-radius: 20px;
    padding: 12px 16px;
    resize: none;
    min-height: 45px;
    max-height: 120px;
}

.input-group button {
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Suggestions and Next Steps */
.agent-suggestions {
    margin-top: 15px;
}

.suggestion-item {
    background: #e3f2fd;
    border: 1px solid #bbdefb;
    border-radius: 8px;
    padding: 10px 12px;
    margin: 5px 0;
    cursor: pointer;
    transition: all 0.2s;
}

.suggestion-item:hover {
    background: #bbdefb;
    transform: translateX(3px);
}

.next-steps {
    margin-top: 15px;
}

.next-step {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    display: flex;
    align-items: center;
}

.next-step:last-child {
    border-bottom: none;
}

.step-number {
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8em;
    margin-right: 10px;
}

/* Status Indicators */
.processing {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #6c757d;
    font-style: italic;
}

.spinner-border {
    width: 1rem;
    height: 1rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .agent-window {
        flex-direction: column;
        height: auto;
        min-height: 400px;
    }
    
    .ontology-panel {
        width: 100%;
        max-height: 300px;
        border-right: none;
        border-bottom: 1px solid #ddd;
    }
    
    .ontology-panel.collapsed {
        max-height: 60px;
    }
    
    .conversation-content {
        min-height: 300px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: none; padding-left: 15px; padding-right: 15px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-robot"></i> Language Model-Assisted Case Creation</h1>
        <div class="d-flex gap-2">
            <a href="{{ url_for('cases.case_options') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Options
            </a>
            <button id="clearConversation" class="btn btn-outline-warning">
                <i class="bi bi-trash"></i> Clear
            </button>
        </div>
    </div>

    <!-- Main Agent Interface -->
    <div class="agent-window" id="agentWindow">
        <!-- Left Panel: Ontology Categories -->
        <div class="ontology-panel" id="ontologyPanel">
            <div class="ontology-panel-header">
                <h5 class="panel-title mb-0">Ontology Categories</h5>
                <button class="panel-toggle" id="ontologyToggle">
                    <i class="bi bi-chevron-left"></i>
                </button>
            </div>
            <div class="ontology-content" id="ontologyContent">
                <div class="p-3">
                    <small class="text-muted d-block mb-3">
                        Select ontological categories to guide case development:
                    </small>
                    
                    {% for category in ontology_categories %}
                    <div class="category-section">
                        <div class="category-checkbox">
                            <input type="checkbox" 
                                   id="category_{{ category.name }}" 
                                   value="{{ category.name }}"
                                   class="category-select">
                            <label for="category_{{ category.name }}">
                                {{ category.name }}
                                <span class="concept-count">{{ category.count }}</span>
                            </label>
                            {% if category.concepts %}
                            <div class="concept-preview">
                                <small>
                                    {% for concept in category.concepts[:3] %}
                                        {% if concept is mapping %}
                                            {{ concept.get('label', concept.get('name', 'Unknown')) }}
                                        {% else %}
                                            {{ concept }}
                                        {% endif %}
                                        {% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if category.concepts|length > 3 %}...{% endif %}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary w-100" id="selectAllCategories">
                            <i class="bi bi-check-all"></i> Select All
                        </button>
                        <button class="btn btn-sm btn-outline-secondary w-100 mt-2" id="clearCategories">
                            <i class="bi bi-x-circle"></i> Clear All
                        </button>
                    </div>
                    
                    <div class="selected-summary mt-3 p-2 bg-light rounded" id="selectedSummary" style="display: none;">
                        <small><strong>Selected:</strong> <span id="selectedCount">0</span> categories</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel: Conversation -->
        <div class="conversation-panel">
            <div class="conversation-header">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Case Development Support
                </h5>
                <small class="text-light">
                    World: {{ default_world.name if default_world else 'No world selected' }}
                </small>
            </div>
            
            <div class="conversation-content">
                <div class="conversation-area" id="conversationArea">
                    <!-- Welcome Message -->
                    <div class="message agent-message">
                        <div class="message-header">
                            <i class="bi bi-robot"></i> Language Model
                        </div>
                        <div class="message-bubble">
                            <strong>Welcome to Language Model-Assisted Case Creation!</strong>
                            <br><br>
                            This interface helps you develop comprehensive engineering ethics cases. To get started:
                            <ol>
                                <li>Select relevant ontological categories from the left panel</li>
                                <li>Tell me what kind of case you'd like to create</li>
                                <li>Receive structured guidance through the development process</li>
                            </ol>
                            
                            <p><strong>Example prompts:</strong></p>
                            <div class="agent-suggestions">
                                <div class="suggestion-item" data-prompt="I want to create a case about a structural engineer facing pressure to approve unsafe designs">
                                    "I want to create a case about a structural engineer facing pressure to approve unsafe designs"
                                </div>
                                <div class="suggestion-item" data-prompt="Help me develop a case involving conflicts between professional obligations">
                                    "Help me develop a case involving conflicts between professional obligations"
                                </div>
                                <div class="suggestion-item" data-prompt="Create a case about whistleblowing in engineering consulting">
                                    "Create a case about whistleblowing in engineering consulting"
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-group">
                        <textarea id="userInput" 
                                  placeholder="Describe the kind of case you'd like to create..." 
                                  rows="2"></textarea>
                        <button id="sendMessage" class="btn btn-primary" disabled>
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    <div class="processing mt-2" id="processingIndicator" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span>Processing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden form data -->
    <input type="hidden" id="worldId" value="{{ default_world.id if default_world else '' }}">
    <input type="hidden" id="currentUser" value="{{ current_user.username if current_user else '' }}">
</div>
{% endblock %}

{% block scripts %}
<script>
// Vue.js App for Agent Case Creation
const AgentCaseCreation = {
    data() {
        return {
            worldId: document.getElementById('worldId').value,
            selectedCategories: [],
            conversationHistory: [],
            isProcessing: false,
            ontologyCollapsed: false
        }
    },
    mounted() {
        this.initializeEventListeners();
        this.updateSelectedSummary();
    },
    methods: {
        initializeEventListeners() {
            // Category selection
            const categorySelects = document.querySelectorAll('.category-select');
            if (categorySelects) {
                categorySelects.forEach(checkbox => {
                    checkbox.addEventListener('change', this.handleCategoryChange);
                });
            }
            
            // Panel toggle
            const ontologyToggle = document.getElementById('ontologyToggle');
            if (ontologyToggle) {
                ontologyToggle.addEventListener('click', this.toggleOntologyPanel);
            }
            
            // Input handling
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendMessage');
            
            if (userInput) {
                userInput.addEventListener('input', this.handleInputChange);
                userInput.addEventListener('keydown', this.handleKeyDown);
            }
            if (sendButton) {
                sendButton.addEventListener('click', this.sendMessage);
            }
            
            // Suggestion clicks
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('suggestion-item')) {
                    userInput.value = e.target.dataset.prompt;
                    this.handleInputChange();
                }
            });
            
            // Utility buttons
            const selectAllBtn = document.getElementById('selectAllCategories');
            const clearCategoriesBtn = document.getElementById('clearCategories');
            const clearConversationBtn = document.getElementById('clearConversation');
            
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', this.selectAllCategories);
            }
            if (clearCategoriesBtn) {
                clearCategoriesBtn.addEventListener('click', this.clearCategories);
            }
            if (clearConversationBtn) {
                clearConversationBtn.addEventListener('click', this.clearConversation);
            }
        },
        
        handleCategoryChange(e) {
            const category = e.target.value;
            if (e.target.checked) {
                if (!this.selectedCategories.includes(category)) {
                    this.selectedCategories.push(category);
                }
            } else {
                this.selectedCategories = this.selectedCategories.filter(cat => cat !== category);
            }
            this.updateSelectedSummary();
        },
        
        updateSelectedSummary() {
            const summary = document.getElementById('selectedSummary');
            const count = document.getElementById('selectedCount');
            
            count.textContent = this.selectedCategories.length;
            
            if (this.selectedCategories.length > 0) {
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        },
        
        selectAllCategories() {
            document.querySelectorAll('.category-select').forEach(checkbox => {
                checkbox.checked = true;
                if (!this.selectedCategories.includes(checkbox.value)) {
                    this.selectedCategories.push(checkbox.value);
                }
            });
            this.updateSelectedSummary();
        },
        
        clearCategories() {
            document.querySelectorAll('.category-select').forEach(checkbox => {
                checkbox.checked = false;
            });
            this.selectedCategories = [];
            this.updateSelectedSummary();
        },
        
        toggleOntologyPanel() {
            const panel = document.getElementById('ontologyPanel');
            const toggle = document.getElementById('ontologyToggle');
            
            this.ontologyCollapsed = !this.ontologyCollapsed;
            
            if (this.ontologyCollapsed) {
                panel.classList.add('collapsed');
                toggle.innerHTML = '<i class="bi bi-chevron-right"></i>';
            } else {
                panel.classList.remove('collapsed');
                toggle.innerHTML = '<i class="bi bi-chevron-left"></i>';
            }
        },
        
        handleInputChange() {
            const input = document.getElementById('userInput');
            const button = document.getElementById('sendMessage');
            
            button.disabled = input.value.trim().length === 0;
        },
        
        handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        },
        
        async sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message || this.isProcessing) return;
            
            // Add user message to conversation
            this.addMessage('user', message);
            
            // Clear input and show processing
            input.value = '';
            this.handleInputChange();
            this.showProcessing(true);
            
            try {
                // Send to API
                const response = await fetch('/cases/new/agent/api', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: message,
                        world_id: this.worldId,
                        selected_categories: this.selectedCategories,
                        selected_concepts: {},
                        conversation_history: this.conversationHistory
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.addAgentResponse(result.response);
                } else {
                    this.addMessage('error', result.error || 'An error occurred');
                }
                
            } catch (error) {
                console.error('Error sending message:', error);
                this.addMessage('error', 'Failed to communicate with language model');
            } finally {
                this.showProcessing(false);
            }
        },
        
        addMessage(type, content) {
            const area = document.getElementById('conversationArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-bubble">${this.escapeHtml(content)}</div>
                `;
            } else if (type === 'error') {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <i class="bi bi-exclamation-triangle text-danger"></i> Error
                    </div>
                    <div class="message-bubble bg-danger text-white">${this.escapeHtml(content)}</div>
                `;
            }
            
            area.appendChild(messageDiv);
            area.scrollTop = area.scrollHeight;
            
            // Add to history
            this.conversationHistory.push({
                type: type,
                content: content,
                timestamp: new Date().toISOString()
            });
        },
        
        addAgentResponse(response) {
            const area = document.getElementById('conversationArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent-message';
            
            let html = `
                <div class="message-header">
                    <i class="bi bi-robot"></i> AI Assistant
                </div>
                <div class="message-bubble">
                    ${this.escapeHtml(response.message)}
            `;
            
            // Add suggestions
            if (response.suggestions && response.suggestions.length > 0) {
                html += '<div class="agent-suggestions"><strong>Suggestions:</strong>';
                response.suggestions.forEach(suggestion => {
                    html += `
                        <div class="suggestion-item" data-prompt="${this.escapeHtml(suggestion.description)}">
                            <strong>${this.escapeHtml(suggestion.title)}</strong><br>
                            <small>${this.escapeHtml(suggestion.description)}</small>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Add next steps
            if (response.next_steps && response.next_steps.length > 0) {
                html += '<div class="next-steps"><strong>Next Steps:</strong>';
                response.next_steps.forEach((step, index) => {
                    html += `
                        <div class="next-step">
                            <div class="step-number">${index + 1}</div>
                            <div>${this.escapeHtml(step)}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            messageDiv.innerHTML = html;
            
            area.appendChild(messageDiv);
            area.scrollTop = area.scrollHeight;
            
            // Add to history
            this.conversationHistory.push({
                type: 'agent',
                content: response,
                timestamp: new Date().toISOString()
            });
        },
        
        showProcessing(show) {
            const indicator = document.getElementById('processingIndicator');
            const button = document.getElementById('sendMessage');
            
            this.isProcessing = show;
            
            if (show) {
                indicator.style.display = 'flex';
                button.disabled = true;
            } else {
                indicator.style.display = 'none';
                this.handleInputChange(); // Re-enable based on input
            }
        },
        
        clearConversation() {
            if (confirm('Clear the entire conversation?')) {
                document.getElementById('conversationArea').innerHTML = `
                    <div class="message agent-message">
                        <div class="message-header">
                            <i class="bi bi-robot"></i> Language Model
                        </div>
                        <div class="message-bubble">
                            <strong>Conversation cleared.</strong> How can I help you create a new case?
                        </div>
                    </div>
                `;
                this.conversationHistory = [];
            }
        },
        
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    }
};

// Initialize the Vue app
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Agent Case Creation interface...');
    window.agentApp = AgentCaseCreation;
    AgentCaseCreation.mounted();
    console.log('Agent Case Creation interface initialized');
});
</script>
{% endblock %}