{% extends "base.html" %}

{% block title %}Prompt Template Editor{% endblock %}

{% block head %}
<style>
    .form-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="bi bi-code-square"></i> 
                        {% if template %}Edit Template{% else %}New Template{% endif %}
                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('prompt_builder.index') }}">Prompt Builder</a></li>
                            {% if template %}
                            <li class="breadcrumb-item"><a href="{{ url_for('prompt_builder.domain_templates', domain_name=template.domain) }}">{{ template.domain.title() }}</a></li>
                            <li class="breadcrumb-item active">{{ template.name }}</li>
                            {% else %}
                            <li class="breadcrumb-item active">New Template</li>
                            {% endif %}
                        </ol>
                    </nav>
                </div>
                <div>
                    <button type="button" class="btn btn-success" onclick="saveTemplate()">
                        <i class="bi bi-check-lg"></i> Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <form id="templateForm">
        <div class="row">
            <!-- Template Configuration -->
            <div class="col-lg-4">
                <!-- Basic Information -->
                <div class="form-section">
                    <h5><i class="bi bi-info-circle"></i> Template Information</h5>
                    
                    <div class="mb-3">
                        <label for="templateName" class="form-label">Template Name</label>
                        <input type="text" class="form-control" id="templateName" 
                               value="{% if template %}{{ template.name }}{% endif %}"
                               placeholder="e.g., Engineering Factual Analysis">
                    </div>
                    
                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="templateDescription" rows="3"
                                  placeholder="Describe what this template is used for...">{% if template %}{{ template.description }}{% endif %}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="templateDomain" class="form-label">Domain</label>
                            <select class="form-select" id="templateDomain">
                                {% for domain in domains %}
                                <option value="{{ domain }}" {% if template and template.domain == domain %}selected{% endif %}>
                                    {{ domain.title() }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="templateSectionType" class="form-label">Section Type</label>
                            <select class="form-select" id="templateSectionType">
                                {% for section_type in section_types %}
                                <option value="{{ section_type.name }}" 
                                        {% if template and template.section_type == section_type.name %}selected{% endif %}>
                                    {{ section_type.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Template Editor -->
            <div class="col-lg-8">
                <div class="form-section">
                    <h5><i class="bi bi-textarea-t"></i> Template Content</h5>
                    
                    <div class="mb-3">
                        <label for="promptTemplate" class="form-label">Prompt Template</label>
                        <textarea class="form-control" id="promptTemplate" rows="15" 
                                  style="font-family: monospace;"
                                  placeholder="Enter your prompt template here...">{% if template %}{{ template.prompt_template }}{% else %}Extract information from this section including:
- Key concepts and entities
- Relationships and dependencies
- Context and background information
- Relevant details for {{ "{{ case_domain }}" }} domain analysis

Focus on extracting information that is relevant for professional ethics analysis.{% endif %}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-muted">
                            <strong>Template Variables:</strong> Use {{ "{{ variable_name }}" }} syntax for variables like {{ "{{ case_domain }}" }}, {{ "{{ stakeholder_types }}" }}, {{ "{{ professional_codes }}" }}, etc.
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        {% if template %}
        <input type="hidden" id="templateId" value="{{ template.id }}">
        {% endif %}
    </form>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>

<script>
function saveTemplate() {
    const templateData = {
        name: document.getElementById('templateName').value,
        description: document.getElementById('templateDescription').value,
        domain: document.getElementById('templateDomain').value,
        section_type: document.getElementById('templateSectionType').value,
        prompt_template: document.getElementById('promptTemplate').value,
        analysis_priority: 1,
        extraction_targets: '',
        variables: [],
        change_description: 'Updated via web editor'
    };

    const templateId = document.getElementById('templateId');
    if (templateId && templateId.value) {
        templateData.template_id = templateId.value;
    }

    fetch('/prompt-builder/api/templates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(templateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Template saved successfully!', 'success');
            if (!templateId && data.template_id) {
                // Redirect to edit mode for new template
                setTimeout(() => {
                    window.location.href = `/prompt-builder/editor/${data.template_id}`;
                }, 1500);
            }
        } else {
            showMessage('Error saving template: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        showMessage('Error saving template: ' + error.message, 'error');
    });
}

function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const alertClass = type === 'error' ? 'alert-danger' : 'alert-success';
    const icon = type === 'error' ? 'exclamation-triangle' : 'check-circle';
    
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show`;
    alert.innerHTML = `
        <i class="bi bi-${icon}"></i> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    container.appendChild(alert);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>

{% endblock %}