{% extends "base.html" %}

{% block title %}{{ case.title }} - AI Ethical Decision-Making Simulator{% endblock %}

{% block styles %}
<style>
    /* Show more/less functionality */
    .collapsible-section {
        position: relative;
        max-height: 200px;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .collapsible-section.expanded {
        max-height: none !important;
        overflow: visible;
    }
    
    .collapsible-section::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.8) 50%, rgba(255,255,255,1) 100%);
        pointer-events: none;
        z-index: 1;
    }
    
    .collapsible-section.expanded::after {
        display: none;
    }
    
    .section-content {
        position: relative;
        z-index: 0;
    }
    
    .show-more-link {
        display: inline-block;
        margin-top: 10px;
        color: #0066cc;
        cursor: pointer;
        text-decoration: none;
        font-weight: 500;
    }
    
    .show-more-link:hover {
        text-decoration: underline;
        color: #0052cc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="mb-4">
        <div class="d-flex justify-content-end mb-2">
            <a href="{{ url_for('cases.list_cases') }}" class="btn btn-secondary me-2">Back to Cases</a>
            {% if case.document_id %}
            <a href="{{ url_for('cases.edit_case_form', id=case.id) }}" class="btn btn-success me-2">
                <i class="bi bi-pencil"></i> Edit Details
            </a>
            <a href="{{ url_for('doc_structure.view_structure', id=case.document_id) }}" class="btn btn-primary me-2">
                <i class="bi bi-diagram-3"></i> View Structure
                {% if case.document_id and case.doc_metadata and case.doc_metadata.document_structure and
                case.doc_metadata.document_structure.section_embeddings %}
                <span class="badge bg-success ms-1" title="Section embeddings available">
                    <i class="bi bi-cpu"></i> {{ case.doc_metadata.document_structure.section_embeddings.count }}
                    sections
                </span>
                {% endif %}
            </a>
            <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="bi bi-trash"></i> Delete Case
            </button>
            {% endif %}
            {% if case.source %}
            <a href="{{ case.source }}" class="btn btn-info" target="_blank">View Original Source</a>
            {% endif %}
        </div>
        <h2>
            {% if case.doc_metadata and case.doc_metadata.get('source') == 'agent_generated' or case.doc_metadata and case.doc_metadata.get('source') == 'agent_generated_sample' %}
            <i class="bi bi-robot text-primary me-2" title="Generated with Language Model assistance"></i>
            {% endif %}
            {{ case.title }}
        </h2>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Case Details</h3>
            {% if case.case_number or case.year %}
            <div>
                {% if case.case_number %}
                <span class="badge bg-primary me-2">Case #{{ case.case_number }}</span>
                {% endif %}
                {% if case.year %}
                <span class="badge bg-secondary">{{ case.year }}</span>
                {% endif %}
                {% if case.doc_metadata and case.doc_metadata.full_date %}
                <span class="badge bg-info ms-2" title="Full date">
                    <i class="bi bi-calendar"></i> {{ case.doc_metadata.full_date }}
                </span>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Subject Tags Section -->
            {% if case.doc_metadata and case.doc_metadata.subject_tags %}
            <div class="mt-2">
                <strong>Subject Tags:</strong>
                {% for tag in case.doc_metadata.subject_tags %}
                <span class="badge bg-warning text-dark me-1 mb-1" title="NSPE Subject Classification">
                    <i class="bi bi-tag"></i> {{ tag }}
                </span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="card-body">
            {% if world %}
            <div class="mb-3">
                <span class="badge bg-success">World: {{ world.name }}</span>
            </div>
            {% endif %}

            {% if case.doc_metadata and case.doc_metadata.display_format == 'extraction_style' %}
            <div data-extraction-style="true">
                {{ case.description|safe }}
            </div>
            {% else %}
            <!-- Check if we have sections in metadata -->
            {% if case.doc_metadata and case.doc_metadata.sections_dual %}
                <!-- Facts Section -->
                {% if case.doc_metadata.sections_dual.facts and case.doc_metadata.sections_dual.facts.html %}
                <div class="mb-4">
                    <h4>Facts</h4>
                    <div class="collapsible-section" id="facts-section">
                        <div class="section-content">
                            {{ case.doc_metadata.sections_dual.facts.html|safe }}
                        </div>
                    </div>
                    <a href="#" class="show-more-link" data-target="facts-section">Show more</a>
                </div>
                {% endif %}
                
                <!-- Discussion Section -->
                {% if case.doc_metadata.sections_dual.discussion and case.doc_metadata.sections_dual.discussion.html %}
                <div class="mb-4">
                    <h4>Discussion</h4>
                    <div class="collapsible-section" id="discussion-section">
                        <div class="section-content">
                            {{ case.doc_metadata.sections_dual.discussion.html|safe }}
                        </div>
                    </div>
                    <a href="#" class="show-more-link" data-target="discussion-section">Show more</a>
                </div>
                {% endif %}
            {% else %}
                <!-- Fallback to regular description if no sections -->
                <h4>Description</h4>
                <div class="mb-4">
                    <div id="description-container">
                        <div id="description-content">
                            {{ case.description|safe }}
                        </div>
                    </div>
                </div>
            {% endif %}
            {% endif %}

            {% if case.decision %}
            <h4>Decision</h4>
            <div class="mb-4">
                {{ case.decision|safe|nl2br }}
            </div>
            {% endif %}

            {% if case.outcome %}
            <h4>Outcome</h4>
            <div class="mb-4">
                {{ case.outcome|safe|nl2br }}
            </div>
            {% endif %}

            {% if case.ethical_analysis %}
            <h4>Ethical Analysis</h4>
            <div class="mb-4">
                {{ case.ethical_analysis|safe|nl2br }}
            </div>
            {% endif %}

            <!-- Scenario Generation Section -->
            <div class="mb-4">
                <div class="card border-success">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-play-circle text-success"></i> Generate Interactive Scenario
                        </h4>
                        <span id="scenario-status-badge" class="badge bg-secondary">Checking...</span>
                    </div>
                    <div class="card-body">
                        <div id="scenario-generation-content">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Display ontology information if available -->
            {% if case.doc_metadata and case.doc_metadata.ontology_info %}
            <h4>Ontology Integration</h4>
            <div class="mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Principles</h5>
                        {% if case.doc_metadata.ontology_info.principles %}
                        <div class="mb-3">
                            {% for principle in case.doc_metadata.ontology_info.principles %}
                            <span class="badge bg-primary me-2 mb-2">{{ principle }}</span>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No principles have been identified for this case.</p>
                        {% endif %}

                        {% if case.doc_metadata.ontology_info.principle_instantiations %}
                        <h5 class="card-title">Principle Instantiations</h5>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Principle</th>
                                    <th>Fact</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inst in case.doc_metadata.ontology_info.principle_instantiations %}
                                <tr>
                                    <td>{{ inst.principle }}</td>
                                    <td>{{ inst.fact|truncate(100) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if case.source %}
            <div class="mt-3">
                <strong>Source:</strong> <a href="{{ case.source }}" target="_blank">{{ case.source }}</a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- RDF Property-Value Labels (Clickable) -->
    {% if entity_triples %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <h3>RDF Properties</h3>
            <button id="clearSelection" class="btn btn-sm btn-light" style="display: none;">
                Clear Selection
            </button>
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">
                <i class="bi bi-info-circle"></i> Click on any property to see related cases. Select multiple properties
                to find cases matching all selected criteria.
            </p>
            <div class="triple-labels">
                <div class="mb-3">
                    <small class="text-muted">
                        <span class="badge bg-primary me-1">■</span> Engineering Ethics Ontology
                        <span class="badge bg-success me-1 ms-3">■</span> McLaren Extensional Definition
                    </small>
                </div>
                {% for triple in entity_triples %}
                <span class="badge bg-info text-dark me-2 mb-2 triple-label" data-predicate="{{ triple.predicate }}"
                    data-object="{{ triple.object_literal if triple.is_literal else triple.object_uri }}"
                    data-is-literal="{{ 'true' if triple.is_literal else 'false' }}"
                    data-metadata="{{ triple.triple_metadata|tojson }}" style="cursor: pointer;">
                    {{ triple.predicate.split('/')[-1].split('#')[-1] }}:
                    {{ triple.object_literal if triple.is_literal else triple.object_uri.split('/')[-1].split('#')[-1]
                    }}
                </span>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Related Cases (Dynamic) -->
    <div id="relatedCasesContainer" class="card mb-4" style="display: none;">
        <div class="card-header bg-primary text-white">
            <h3>Related Cases</h3>
        </div>
        <div class="card-body">
            <div id="relatedCasesContent">
                <p class="text-muted">Select one or more RDF property values above to see related cases.</p>
            </div>
            <div id="relatedCasesList" class="list-group mt-3">
                <!-- Cases will be loaded here dynamically -->
            </div>
        </div>
    </div>
    {% endif %}

    <!-- RDF Triples Metadata Display -->
    {% if case.document_id and case.doc_metadata and case.doc_metadata.rdf_triples %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3>RDF Triple Metadata</h3>
        </div>
        <div class="card-body">
            <h4>Triples</h4>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Predicate</th>
                        <th>Object</th>
                    </tr>
                </thead>
                <tbody>
                    {% for triple in case.doc_metadata.rdf_triples %}
                    <tr>
                        <td>{{ triple.subject }}</td>
                        <td>{{ triple.predicate }}</td>
                        <td>{{ triple.object }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if case.doc_metadata.rdf_namespaces %}
            <h4>Namespaces</h4>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Prefix</th>
                        <th>URI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prefix, uri in case.doc_metadata.rdf_namespaces.items() %}
                    <tr>
                        <td><code>{{ prefix }}</code></td>
                        <td><code>{{ uri }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Knowledge Graph Connections section has been replaced by interactive Triple Labels -->

</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete case "{{ case.title }}"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('cases.delete_case', id=case.id) }}" method="POST">
                    <button type="submit" class="btn btn-danger">Delete Case</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- Include the external case detail JS file -->
<script src="{{ url_for('static', filename='js/case_detail.js') }}"></script>

<!-- Scenario Generation JavaScript -->
<script>
// Scenario Generation Management
class ScenarioGenerationManager {
    constructor(caseId) {
        this.caseId = caseId;
        this.statusCheckInterval = null;
        this.progressInterval = null;
        this.init();
    }
    
    init() {
        this.checkScenarioStatus();
    }
    
    async checkScenarioStatus() {
        try {
            const response = await fetch(`/cases/${this.caseId}/scenario_status`);
            const data = await response.json();
            
            if (data.success) {
                this.updateStatusDisplay(data);
            } else {
                this.showError('Failed to check scenario status: ' + data.error);
            }
        } catch (error) {
            this.showError('Error checking scenario status: ' + error.message);
        }
    }
    
    updateStatusDisplay(status) {
        const badge = document.getElementById('scenario-status-badge');
        const content = document.getElementById('scenario-generation-content');
        
        if (status.has_scenarios) {
            // Case has playable scenarios - show scenario links
            badge.className = 'badge bg-success';
            badge.textContent = `${status.scenario_count} Scenario${status.scenario_count !== 1 ? 's' : ''} Available`;
            
            content.innerHTML = this.renderScenarioLinks(status.scenarios);
        } else if (status.is_deconstructed && status.has_templates) {
            // Case is deconstructed and has templates - show scenario creation options
            badge.className = 'badge bg-warning';
            badge.textContent = `${status.template_count} Template${status.template_count !== 1 ? 's' : ''} Available`;
            
            content.innerHTML = this.renderTemplateOptions(status.templates);
        } else if (status.is_deconstructed) {
            // Case is deconstructed but no templates - offer to create template
            badge.className = 'badge bg-warning';
            badge.textContent = 'Ready for Template Creation';
            
            content.innerHTML = this.renderCreateTemplateOption();
        } else if (status.can_deconstruct) {
            // Case can be deconstructed - show generation option
            badge.className = 'badge bg-info';
            badge.textContent = 'Ready for Generation';
            
            content.innerHTML = this.renderGenerationOption();
        } else {
            // Case cannot be deconstructed
            badge.className = 'badge bg-danger';
            badge.textContent = 'Not Compatible';
            
            content.innerHTML = this.renderNotCompatible(status.deconstruct_reason);
        }
    }
    
    renderGenerationOption() {
        return `
            <div class="text-center">
                <h5>Transform this case into an interactive scenario</h5>
                <p class="text-muted">This will analyze the case to extract stakeholders, decision points, and reasoning chains.</p>
                <button id="generate-scenario-btn" class="btn btn-success btn-lg">
                    <i class="bi bi-play-circle"></i> Generate Scenario
                </button>
            </div>
        `;
    }
    
    renderCreateTemplateOption() {
        return `
            <div class="text-center">
                <h5>Case has been analyzed</h5>
                <p class="text-muted">Create a scenario template from the analyzed case data.</p>
                <button id="create-template-btn" class="btn btn-primary btn-lg">
                    <i class="bi bi-file-earmark-plus"></i> Create Scenario Template
                </button>
            </div>
        `;
    }
    
    renderTemplateOptions(templates) {
        let html = `
            <div class="text-center">
                <h5>Scenario Templates Available</h5>
                <p class="text-muted">Create playable scenarios from these templates.</p>
                <div class="row">
        `;
        
        templates.forEach(template => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${template.title}</h6>
                            <button class="btn btn-success create-scenario-btn" data-template-id="${template.id}">
                                <i class="bi bi-play"></i> Create Scenario
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                <button id="create-template-btn" class="btn btn-outline-primary">
                    <i class="bi bi-plus"></i> Create Another Template
                </button>
            </div>
        `;
        
        return html;
    }
    
    renderScenarioLinks(scenarios) {
        let html = `
            <div class="text-center">
                <h5><i class="bi bi-play-circle text-success"></i> Interactive Scenarios Ready!</h5>
                <p class="text-muted">This case has been transformed into playable scenarios. Click to explore:</p>
                <div class="row justify-content-center">
        `;
        
        scenarios.forEach(scenario => {
            html += `
                <div class="col-md-8 mb-3">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-title">${scenario.name}</h6>
                            <a href="${scenario.url}" class="btn btn-success btn-lg w-100" target="_blank">
                                <i class="bi bi-play-circle"></i> Play Scenario
                            </a>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                <div class="mt-3">
                    <a href="/scenarios/" class="btn btn-outline-primary">
                        <i class="bi bi-list"></i> View All Scenarios
                    </a>
                </div>
            </div>
        `;
        
        return html;
    }
    
    renderNotCompatible(reason) {
        return `
            <div class="text-center">
                <h5 class="text-muted">Scenario Generation Not Available</h5>
                <p class="text-muted">${reason}</p>
                <small class="text-muted">This case may need additional processing or may not be compatible with scenario generation.</small>
            </div>
        `;
    }
    
    async generateScenario() {
        const btn = document.getElementById('generate-scenario-btn');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
        
        try {
            const response = await fetch(`/cases/${this.caseId}/generate_scenario`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showProgress();
                this.startProgressPolling();
            } else {
                this.showError('Failed to start generation: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            this.showError('Error starting generation: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async createTemplate() {
        const btn = document.getElementById('create-template-btn');
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
        
        try {
            const response = await fetch(`/cases/${this.caseId}/create_scenario_template`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showSuccess('Template created successfully!');
                // Refresh status to show new template
                setTimeout(() => this.checkScenarioStatus(), 1000);
            } else {
                this.showError('Failed to create template: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            this.showError('Error creating template: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async createScenarioFromTemplate(templateId) {
        const btn = event.target;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
        
        try {
            const response = await fetch(`/cases/templates/${templateId}/create_scenario`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    difficulty: 'intermediate',
                    time_limits: 'normal'
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showSuccess('Scenario created successfully! Redirecting...');
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1500);
            } else {
                this.showError('Failed to create scenario: ' + data.error);
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            this.showError('Error creating scenario: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    showProgress() {
        const content = document.getElementById('scenario-generation-content');
        content.innerHTML = `
            <div class="text-center">
                <h5>Generating Scenario...</h5>
                <div class="progress mb-3">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 10%">10%</div>
                </div>
                <p id="progress-message" class="text-muted">Starting analysis...</p>
            </div>
        `;
    }
    
    startProgressPolling() {
        this.progressInterval = setInterval(async () => {
            try {
                const response = await fetch(`/cases/${this.caseId}/scenario_generation_progress`);
                const data = await response.json();
                
                if (data.success) {
                    this.updateProgress(data.progress);
                    
                    if (data.progress.status === 'COMPLETED') {
                        clearInterval(this.progressInterval);
                        this.showCompleted();
                    } else if (data.progress.status === 'FAILED') {
                        clearInterval(this.progressInterval);
                        this.showError('Generation failed: ' + data.progress.message);
                    }
                }
            } catch (error) {
                console.error('Error polling progress:', error);
            }
        }, 2000);
    }
    
    updateProgress(progress) {
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');
        
        if (progressBar) {
            progressBar.style.width = progress.progress + '%';
            progressBar.textContent = progress.progress + '%';
        }
        
        if (progressMessage) {
            progressMessage.textContent = progress.message || 'Processing...';
        }
    }
    
    showCompleted() {
        const content = document.getElementById('scenario-generation-content');
        content.innerHTML = `
            <div class="text-center">
                <h5 class="text-success"><i class="bi bi-check-circle"></i> Generation Complete!</h5>
                <p class="text-muted">The case has been analyzed. You can now create scenario templates.</p>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Page
                </button>
            </div>
        `;
    }
    
    showSuccess(message) {
        const content = document.getElementById('scenario-generation-content');
        content.innerHTML = `
            <div class="text-center">
                <h5 class="text-success"><i class="bi bi-check-circle"></i> ${message}</h5>
            </div>
        `;
    }
    
    showError(message) {
        const content = document.getElementById('scenario-generation-content');
        content.innerHTML = `
            <div class="text-center">
                <h5 class="text-danger"><i class="bi bi-exclamation-circle"></i> Error</h5>
                <p class="text-muted">${message}</p>
                <button class="btn btn-outline-primary" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Try Again
                </button>
            </div>
        `;
    }
}

// Initialize scenario generation when page loads
document.addEventListener('DOMContentLoaded', function() {
    const caseId = {{ case.id }};
    const scenarioManager = new ScenarioGenerationManager(caseId);
    
    // Event delegation for dynamically created buttons
    document.addEventListener('click', function(e) {
        if (e.target.id === 'generate-scenario-btn') {
            e.preventDefault();
            scenarioManager.generateScenario();
        } else if (e.target.id === 'create-template-btn') {
            e.preventDefault();
            scenarioManager.createTemplate();
        } else if (e.target.classList.contains('create-scenario-btn')) {
            e.preventDefault();
            const templateId = e.target.getAttribute('data-template-id');
            scenarioManager.createScenarioFromTemplate(templateId);
        }
    });
});
</script>

<!-- Pass case ID to JS -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Add document ID to page for JS to use
        const docIdEl = document.createElement('input');
        docIdEl.type = 'hidden';
        docIdEl.id = 'document-id';
        docIdEl.value = '{{ case.id }}';
        document.body.appendChild(docIdEl);
        
        // Show more/less functionality
        document.querySelectorAll('.show-more-link').forEach(function(link) {
            const targetId = link.getAttribute('data-target');
            const targetSection = document.getElementById(targetId);
            
            // Check if content actually needs to be collapsed
            if (targetSection && targetSection.scrollHeight <= 200) {
                // Content is short enough, no need for show more
                link.style.display = 'none';
                targetSection.classList.remove('collapsible-section');
            }
            
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (targetSection.classList.contains('expanded')) {
                    targetSection.classList.remove('expanded');
                    link.textContent = 'Show more';
                    // Scroll to the top of the section when collapsing
                    targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else {
                    targetSection.classList.add('expanded');
                    link.textContent = 'Show less';
                }
            });
        });
    });
    
    // Pass term links data to JavaScript for highlighting functionality
    {% if term_links_by_section %}
    window.termLinksData = {{ term_links_by_section | tojson | safe }};
    {% else %}
    window.termLinksData = {};
    {% endif %}
</script>
{% endblock %}