{% extends "base.html" %}

{% block title %}Select Cases for Experiment{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('experiment.index') }}">Experiments</a></li>
                    <li class="breadcrumb-item active">Select Cases</li>
                </ol>
            </nav>
            <h2>Select Cases for Experiment: {{ experiment.name }}</h2>
            <p class="text-muted">{{ experiment.description }}</p>
        </div>
    </div>

    {% if selected_cases %}
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">Selected Cases ({{ selected_cases|length }})</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Title</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for case in selected_cases %}
                                <tr>
                                    <td>{{ case.id }}</td>
                                    <td>{{ case.title }}</td>
                                    <td>{{ case.document_type }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="POST" action="{{ url_for('experiment.cases', id=experiment.id) }}">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">Available Cases</h3>
                    <div>
                        <div class="input-group">
                            <input type="text" id="caseSearch" class="form-control" placeholder="Search cases...">
                            <button type="button" class="btn btn-light" id="searchButton">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if cases %}
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            Select All Cases
                        </label>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped" id="casesTable">
                        <thead>
                            <tr>
                                <th>Select</th>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for case in cases %}
                            <tr>
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input case-checkbox" type="checkbox" name="case_ids" value="{{ case.id }}" 
                                            {% if selected_cases and case in selected_cases %}checked{% endif %}>
                                    </div>
                                </td>
                                <td>{{ case.id }}</td>
                                <td>{{ case.title }}</td>
                                <td>{{ case.document_type }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    No cases are available for selection. Please import some cases first.
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Save Case Selection
                    </button>
                    <a href="{{ url_for('experiment.index') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle select all checkbox
        const selectAllCheckbox = document.getElementById('selectAll');
        const caseCheckboxes = document.querySelectorAll('.case-checkbox');
        
        selectAllCheckbox.addEventListener('change', function() {
            caseCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        });
        
        // Handle search functionality
        const searchInput = document.getElementById('caseSearch');
        const searchButton = document.getElementById('searchButton');
        const casesTable = document.getElementById('casesTable');
        
        function performSearch() {
            const searchTerm = searchInput.value.toLowerCase();
            const rows = casesTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const title = row.cells[2].textContent.toLowerCase();
                const type = row.cells[3].textContent.toLowerCase();
                
                if (title.includes(searchTerm) || type.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        });
        
        // Update "Select All" checkbox when individual checkboxes change
        caseCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const allChecked = Array.from(caseCheckboxes).every(c => c.checked);
                const noneChecked = Array.from(caseCheckboxes).every(c => !c.checked);
                
                if (allChecked) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else if (noneChecked) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.indeterminate = true;
                }
            });
        });
    });
</script>
{% endblock %}
