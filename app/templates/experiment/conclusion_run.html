{% extends "base.html" %}

{% block title %}Run Conclusion Prediction Experiment{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('experiment.index') }}">Experiments</a></li>
                    <li class="breadcrumb-item active">Run Conclusion Prediction</li>
                </ol>
            </nav>
            <h2>Run Conclusion Prediction: {{ experiment.name }}</h2>
            <p class="text-muted">{{ experiment.description }}</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Experiment Configuration</h3>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Experiment ID:</strong> {{ experiment.id }}
                        </li>
                        <li class="list-group-item">
                            <strong>Name:</strong> {{ experiment.name }}
                        </li>
                        <li class="list-group-item">
                            <strong>Type:</strong> <span class="badge bg-info">Conclusion Prediction</span>
                        </li>
                        <li class="list-group-item">
                            <strong>Status:</strong>
                            <span class="badge 
                                {% if experiment.status == 'created' %}bg-secondary
                                {% elif experiment.status == 'configured' %}bg-info
                                {% elif experiment.status == 'running' %}bg-warning
                                {% elif experiment.status == 'completed' %}bg-success
                                {% elif experiment.status == 'failed' %}bg-danger
                                {% else %}bg-secondary{% endif %}">
                                {{ experiment.status }}
                            </span>
                        </li>
                        <li class="list-group-item">
                            <strong>Created:</strong> {{ experiment.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </li>
                        <li class="list-group-item">
                            <strong>Use Ontology:</strong> 
                            {% if experiment.config and experiment.config.use_ontology %}
                                <span class="badge bg-success">Enabled</span>
                            {% else %}
                                <span class="badge bg-secondary">Disabled</span>
                            {% endif %}
                        </li>
                        <li class="list-group-item">
                            <strong>Cases Selected:</strong> 
                            {% if experiment.config and experiment.config.case_ids %}
                                {{ experiment.config.case_ids|length }}
                            {% else %}
                                0
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>

            {% if experiment.config and experiment.config.case_ids %}
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h4 class="mb-0">Selected Cases</h4>
                </div>
                <div class="card-body">
                    {% for case_id in experiment.config.case_ids %}
                    <div class="mb-2">
                        <span class="badge bg-light text-dark">Case {{ case_id }}</span>
                        <a href="{{ url_for('cases.view_case', id=case_id) }}" target="_blank" class="ms-2">
                            View Case <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">Run Options</h3>
                </div>
                <div class="card-body">
                    <p>You're about to generate conclusion predictions for {{ experiment.config.case_ids|length if experiment.config and experiment.config.case_ids else 0 }} case(s) using ProEthica enhanced ethical reasoning.</p>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>About Conclusion Prediction:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Analyzes case context without original conclusion</li>
                            <li>Uses ontology-enhanced ethical reasoning</li>
                            <li>Generates predicted conclusion for comparison</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> This process may take several minutes depending on the number of cases selected. Please do not close this page while the experiment is running.
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="confirmCheck">
                        <label class="form-check-label" for="confirmCheck">
                            I understand that this process will generate LLM conclusion predictions for each case, which may take time and consume resources.
                        </label>
                    </div>
                    
                    <button id="runButton" class="btn btn-success btn-lg" disabled>
                        <i class="bi bi-play-circle"></i> Run Conclusion Prediction
                    </button>
                </div>
            </div>
            
            <div class="card d-none" id="progressCard">
                <div class="card-header bg-warning text-white">
                    <h3 class="mb-0">Prediction Progress</h3>
                </div>
                <div class="card-body">
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                    <p id="progressText">Initializing conclusion prediction...</p>
                    <div id="progressLog" class="mt-3 border rounded p-2 bg-light" style="height: 200px; overflow-y: auto;">
                        <div class="text-muted">Prediction log will appear here...</div>
                    </div>
                </div>
            </div>
            
            <div class="card d-none" id="completionCard">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">Prediction Complete</h3>
                </div>
                <div class="card-body">
                    <p>The conclusion prediction experiment has completed successfully.</p>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('experiment.conclusion_results', id=experiment.id) }}" class="btn btn-primary">
                            <i class="bi bi-bar-chart"></i> View Prediction Results
                        </a>
                        {% if experiment.config and experiment.config.case_ids and experiment.config.case_ids|length == 1 %}
                        <a href="{{ url_for('experiment.conclusion_comparison', id=experiment.id, doc_id=experiment.config.case_ids[0]) }}" class="btn btn-outline-primary">
                            <i class="bi bi-files"></i> Compare Original vs Predicted
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card d-none" id="errorCard">
                <div class="card-header bg-danger text-white">
                    <h3 class="mb-0">Error</h3>
                </div>
                <div class="card-body">
                    <p id="errorMessage">An error occurred while running the conclusion prediction.</p>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i class="bi bi-arrow-repeat"></i> Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const confirmCheck = document.getElementById('confirmCheck');
        const runButton = document.getElementById('runButton');
        const progressCard = document.getElementById('progressCard');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressLog = document.getElementById('progressLog');
        const completionCard = document.getElementById('completionCard');
        const errorCard = document.getElementById('errorCard');
        const errorMessage = document.getElementById('errorMessage');
        
        // Enable or disable run button based on checkbox
        confirmCheck.addEventListener('change', function() {
            runButton.disabled = !confirmCheck.checked;
        });
        
        // Handle run button click
        runButton.addEventListener('click', function() {
            // Disable button and show progress
            runButton.disabled = true;
            runButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Running Prediction...';
            progressCard.classList.remove('d-none');
            
            // Add log entry
            addLogEntry('Starting conclusion prediction experiment...');
            
            // Get CSRF token from form (if using CSRF protection)
            const csrfToken = document.querySelector('meta[name=csrf-token]')?.content || '';
            
            // Call API to run conclusion predictions
            fetch('{{ url_for("experiment.predict_conclusions", id=experiment.id) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show completion card
                    progressCard.classList.add('d-none');
                    completionCard.classList.remove('d-none');
                    
                    // Add log entries
                    addLogEntry('Conclusion prediction completed successfully.');
                    addLogEntry(data.message);
                } else {
                    // Show error
                    progressCard.classList.add('d-none');
                    errorCard.classList.remove('d-none');
                    errorMessage.textContent = data.error || 'An unknown error occurred.';
                    
                    // Add log entry
                    addLogEntry('Error: ' + (data.error || 'An unknown error occurred.'));
                }
            })
            .catch(error => {
                // Show error
                progressCard.classList.add('d-none');
                errorCard.classList.remove('d-none');
                errorMessage.textContent = error.toString();
                
                // Add log entry
                addLogEntry('Error: ' + error.toString());
            });
            
            // Simulate progress updates for UX
            simulateProgress();
        });
        
        // Function to add log entry
        function addLogEntry(message) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.innerHTML = `<small class="text-muted">[${timestamp}]</small> ${message}`;
            progressLog.appendChild(entry);
            progressLog.scrollTop = progressLog.scrollHeight;
        }
        
        // Simulate progress for better UX
        function simulateProgress() {
            let progress = 0;
            const numCases = {{ experiment.config.case_ids|length if experiment.config and experiment.config.case_ids else 0 }};
            const interval = setInterval(() => {
                if (progress >= 100) {
                    clearInterval(interval);
                    return;
                }
                
                progress += 8;
                progressBar.style.width = `${Math.min(progress, 100)}%`;
                
                // Add some realistic-looking progress messages
                if (progress === 8) {
                    addLogEntry('Initializing LLM services...');
                } else if (progress === 16) {
                    addLogEntry('Loading case documents...');
                } else if (progress === 32) {
                    addLogEntry(`Processing ${numCases} case(s)...`);
                } else if (progress === 56) {
                    addLogEntry('Extracting case context (excluding conclusions)...');
                } else if (progress === 72) {
                    addLogEntry('Applying ontology-enhanced reasoning...');
                } else if (progress === 88) {
                    addLogEntry('Generating conclusion predictions...');
                }
                
                progressText.textContent = `Progress: ${Math.min(progress, 100)}%`;
            }, 1200);
        }
    });
</script>
{% endblock %}
