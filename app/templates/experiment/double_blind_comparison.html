{% extends "base.html" %}

{% block title %}Validation Study - Case {{ document.id }}{% endblock %}

{% block head %}
{{ super() }}
<style>
  .evaluation-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  .study-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    position: relative;
  }

  .study-title {
    font-size: 2.2em;
    font-weight: 300;
    margin-bottom: 10px;
  }

  .study-subtitle {
    font-size: 1.1em;
    opacity: 0.9;
    font-weight: 300;
  }

  .participant-id {
    position: absolute;
    top: 20px;
    right: 20px;
    background-color: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9em;
  }

  .case-context {
    margin-bottom: 40px;
    padding: 25px;
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
    border-radius: 8px;
  }

  .case-context h3 {
    color: #0066cc;
    margin-bottom: 15px;
  }

  .comparison-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
  }

  .system-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }

  .system-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    transform: translateY(-2px);
  }

  .system-header {
    padding: 20px;
    font-weight: 600;
    font-size: 1.3em;
    text-align: center;
    color: white;
  }

  .system-a .system-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }

  .system-b .system-header {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  }

  .system-content {
    padding: 25px;
    line-height: 1.7;
    font-size: 1.05em;
    color: #333;
    min-height: 300px;
    max-height: 500px;
    overflow-y: auto;
  }

  .evaluation-form {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }

  .evaluation-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
  }

  .evaluation-header h3 {
    color: #333;
    font-weight: 300;
    font-size: 1.8em;
  }

  .evaluation-instruction {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    color: #1565c0;
  }

  /* Metric Section Styling */
  .metric-section {
    background-color: #fafafa;
    border: 1px solid #e0e0e0;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
  }

  .metric-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e0e0e0;
  }

  .metric-title {
    font-size: 1.2em;
    font-weight: 600;
    color: #333;
  }

  .metric-acronym {
    background-color: #667eea;
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.85em;
    font-weight: 600;
  }

  .metric-description {
    color: #666;
    font-size: 0.95em;
    margin-bottom: 20px;
    font-style: italic;
  }

  .sub-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
  }

  .sub-item-question {
    font-weight: 500;
    color: #333;
    margin-bottom: 12px;
  }

  .system-ratings {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .system-rating {
    background-color: #f8f9fa;
    padding: 12px;
    border-radius: 6px;
  }

  .system-rating-label {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9em;
  }

  .system-rating-label.system-left {
    color: #4facfe;
  }

  .system-rating-label.system-right {
    color: #fa709a;
  }

  .scale-selector {
    display: flex;
    justify-content: space-between;
    gap: 5px;
  }

  .scale-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 8px 6px;
    border-radius: 4px;
    transition: all 0.2s ease;
    flex: 1;
    text-align: center;
  }

  .scale-option:hover {
    background-color: #e3f2fd;
  }

  .scale-option input[type="radio"] {
    margin-bottom: 4px;
  }

  .scale-option.selected {
    background-color: #e3f2fd;
    color: #1976d2;
  }

  .scale-label {
    font-size: 0.85em;
    font-weight: 600;
  }

  .scale-endpoints {
    display: flex;
    justify-content: space-between;
    font-size: 0.75em;
    color: #888;
    margin-top: 4px;
  }

  /* Preference Section */
  .preference-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin: 30px 0;
  }

  .preference-section h3 {
    text-align: center;
    margin-bottom: 10px;
  }

  .preference-description {
    text-align: center;
    opacity: 0.9;
    margin-bottom: 20px;
  }

  .preference-buttons {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .preference-btn {
    padding: 12px 20px;
    border: 2px solid white;
    background-color: transparent;
    color: white;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 140px;
    text-align: center;
  }

  .preference-btn:hover {
    background-color: rgba(255,255,255,0.2);
  }

  .preference-btn.selected {
    background-color: white;
    color: #667eea;
  }

  .preference-btn small {
    display: block;
    font-size: 0.8em;
    opacity: 0.8;
    margin-top: 2px;
  }

  .justification-section {
    margin-top: 20px;
  }

  .justification-section label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .justification-textarea {
    width: 100%;
    min-height: 80px;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-family: inherit;
    font-size: 1em;
    resize: vertical;
  }

  /* Comments Section */
  .comments-section {
    margin-top: 30px;
  }

  .comments-textarea {
    width: 100%;
    min-height: 100px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: inherit;
    font-size: 1em;
    resize: vertical;
  }

  .comments-textarea:focus {
    outline: none;
    border-color: #4facfe;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
  }

  /* Submit Section */
  .submit-section {
    text-align: center;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #e9ecef;
  }

  .submit-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px 50px;
    border-radius: 25px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  /* Progress Indicator */
  .progress-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background-color: #e0e0e0;
    z-index: 1000;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    width: 0%;
    transition: width 0.3s ease;
  }

  /* Help Icon */
  .help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    background-color: #ccc;
    color: white;
    border-radius: 50%;
    font-size: 0.75em;
    cursor: help;
    margin-left: 5px;
  }

  /* Mobile responsiveness */
  @media (max-width: 992px) {
    .comparison-section {
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .system-ratings {
      grid-template-columns: 1fr;
    }

    .preference-buttons {
      flex-direction: column;
      align-items: center;
    }

    .preference-btn {
      width: 100%;
      max-width: 300px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="progress-indicator">
  <div class="progress-bar" id="progressBar"></div>
</div>

<div class="evaluation-container">
  <div class="study-header">
    <div class="participant-id">
      Participant: {{ participant_id or 'P' ~ (request.remote_addr|hash|abs % 10000) }}
    </div>
    <h1 class="study-title">ProEthica Validation Study</h1>
    <p class="study-subtitle">Double-Blind Comparison - {{ domain|default('Engineering')|title }} Ethics Case Analysis</p>
  </div>

  <div class="case-context">
    <h3>Case Background: {{ document.title }}</h3>
    {% if document.doc_metadata and document.doc_metadata.document_structure and document.doc_metadata.document_structure.sections %}
      {% for section_id, section in document.doc_metadata.document_structure.sections.items() %}
        {% if section.type and section.type.lower() not in ['conclusion', 'board conclusion', 'decision'] %}
        <div class="case-section mb-3">
          <strong>{{ section.type.title() }}:</strong>
          <p class="mb-0">{{ section.content|truncate(800) }}</p>
        </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p>{{ document.content|truncate(1500) if document.content else 'Case content not available.' }}</p>
    {% endif %}
  </div>

  <div class="comparison-section">
    <!-- Randomization: Left/Right assignment varies per session -->
    {% if randomize_systems %}
      {% set system_left = 'B' if (request.remote_addr|hash|abs % 2) else 'A' %}
      {% set system_right = 'A' if system_left == 'B' else 'B' %}
      {% set prediction_left = proethica_prediction if system_left == 'B' else baseline_prediction %}
      {% set prediction_right = baseline_prediction if system_left == 'B' else proethica_prediction %}
    {% else %}
      {% set system_left = 'A' %}
      {% set system_right = 'B' %}
      {% set prediction_left = baseline_prediction %}
      {% set prediction_right = proethica_prediction %}
    {% endif %}

    <div class="system-card system-a">
      <div class="system-header">
        System {{ system_left }}
      </div>
      <div class="system-content">
        {{ prediction_left.prediction_text|safe if prediction_left else 'Prediction not available.' }}
      </div>
    </div>

    <div class="system-card system-b">
      <div class="system-header">
        System {{ system_right }}
      </div>
      <div class="system-content">
        {{ prediction_right.prediction_text|safe if prediction_right else 'Prediction not available.' }}
      </div>
    </div>
  </div>

  <form method="POST" class="evaluation-form" id="evaluationForm">
    {{ form.hidden_tag() if form else '' }}

    <!-- Hidden fields for tracking -->
    <input type="hidden" name="system_left" value="{{ system_left }}">
    <input type="hidden" name="system_right" value="{{ system_right }}">
    <input type="hidden" name="baseline_prediction_id" value="{{ baseline_prediction.id if baseline_prediction else '' }}">
    <input type="hidden" name="proethica_prediction_id" value="{{ proethica_prediction.id if proethica_prediction else '' }}">
    <input type="hidden" name="evaluator_domain" value="{{ domain|default('engineering') }}">
    <input type="hidden" name="document_id" value="{{ document.id }}">

    <div class="evaluation-header">
      <h3>Evaluation Metrics</h3>
      <div class="evaluation-instruction">
        Rate each system on the following criteria using the 1-7 scale (1 = Poor, 7 = Excellent).
        Compare how well each system performs on each specific aspect of reasoning quality.
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- RTI: Reasoning Transparency Index -->
    <!-- ================================================================== -->
    <div class="metric-section">
      <div class="metric-header">
        <span class="metric-title">Reasoning Transparency Index</span>
        <span class="metric-acronym">RTI</span>
      </div>
      <p class="metric-description">
        How clearly does the reasoning trace from facts through principles to conclusions?
      </p>

      <!-- RTI Sub-item 1 -->
      <div class="sub-item">
        <div class="sub-item-question">Are factual premises clearly stated?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_premises_clear_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_premises_clear_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- RTI Sub-item 2 -->
      <div class="sub-item">
        <div class="sub-item-question">Are reasoning steps explicit and followable?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_steps_explicit_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_steps_explicit_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- RTI Sub-item 3 -->
      <div class="sub-item">
        <div class="sub-item-question">Is the conclusion clearly supported by prior steps?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_conclusion_supported_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_conclusion_supported_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- RTI Sub-item 4 -->
      <div class="sub-item">
        <div class="sub-item-question">Are alternative interpretations acknowledged?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_alternatives_acknowledged_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="rti_alternatives_acknowledged_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- PBRQ: Precedent-Based Reasoning Quality -->
    <!-- ================================================================== -->
    <div class="metric-section">
      <div class="metric-header">
        <span class="metric-title">Precedent-Based Reasoning Quality</span>
        <span class="metric-acronym">PBRQ</span>
      </div>
      <p class="metric-description">
        Does the system employ sound case-based reasoning methodology?
      </p>

      <!-- PBRQ Sub-item 1 -->
      <div class="sub-item">
        <div class="sub-item-question">Are relevant precedent cases identified?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_precedents_identified_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_precedents_identified_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- PBRQ Sub-item 2 -->
      <div class="sub-item">
        <div class="sub-item-question">Are transferable principles correctly extracted?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_principles_extracted_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_principles_extracted_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- PBRQ Sub-item 3 -->
      <div class="sub-item">
        <div class="sub-item-question">Is the adaptation to current facts appropriate?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_adaptation_appropriate_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_adaptation_appropriate_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- PBRQ Sub-item 4 -->
      <div class="sub-item">
        <div class="sub-item-question">Is the precedent selection well-justified?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_selection_justified_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="pbrq_selection_justified_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- CA: Citation Accuracy -->
    <!-- ================================================================== -->
    <div class="metric-section">
      <div class="metric-header">
        <span class="metric-title">Citation Accuracy</span>
        <span class="metric-acronym">CA</span>
      </div>
      <p class="metric-description">
        Are references to professional codes and precedent cases factually correct?
      </p>

      <!-- CA Sub-item 1 -->
      <div class="sub-item">
        <div class="sub-item-question">Are code provisions correctly cited?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ca_code_citations_correct_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ca_code_citations_correct_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- CA Sub-item 2 -->
      <div class="sub-item">
        <div class="sub-item-question">Are precedent cases accurately characterized?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ca_precedents_characterized_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ca_precedents_characterized_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- CA Sub-item 3 -->
      <div class="sub-item">
        <div class="sub-item-question">Do citations support the claims made?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ca_citations_support_claims_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ca_citations_support_claims_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- DRA: Domain Relevance Assessment -->
    <!-- ================================================================== -->
    <div class="metric-section">
      <div class="metric-header">
        <span class="metric-title">Domain Relevance Assessment</span>
        <span class="metric-acronym">DRA</span>
      </div>
      <p class="metric-description">
        Does the analysis address concerns relevant to actual professional practice?
      </p>

      <!-- DRA Sub-item 1 -->
      <div class="sub-item">
        <div class="sub-item-question">Does the analysis address concerns relevant to practice?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_concerns_relevant_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_concerns_relevant_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- DRA Sub-item 2 -->
      <div class="sub-item">
        <div class="sub-item-question">Does the reasoning follow accepted professional patterns?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_patterns_accepted_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_patterns_accepted_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- DRA Sub-item 3 -->
      <div class="sub-item">
        <div class="sub-item-question">Would this guidance help a practitioner?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_guidance_helpful_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_guidance_helpful_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>

      <!-- DRA Sub-item 4 -->
      <div class="sub-item">
        <div class="sub-item-question">Are domain-specific considerations appropriately weighted?</div>
        <div class="system-ratings">
          <div class="system-rating">
            <div class="system-rating-label system-left">System {{ system_left }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_domain_weighted_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
          <div class="system-rating">
            <div class="system-rating-label system-right">System {{ system_right }}</div>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="dra_domain_weighted_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
            <div class="scale-endpoints"><span>Poor</span><span>Excellent</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================================================================== -->
    <!-- Overall Preference (5-point scale) -->
    <!-- ================================================================== -->
    <div class="preference-section">
      <h3>Overall Preference</h3>
      <p class="preference-description">
        Which system would you prefer for analyzing similar {{ domain|default('engineering') }} ethics cases?
      </p>
      <div class="preference-buttons">
        <button type="button" class="preference-btn" data-value="-2" onclick="selectPreference(-2)">
          System {{ system_left }}
          <small>Strongly Prefer</small>
        </button>
        <button type="button" class="preference-btn" data-value="-1" onclick="selectPreference(-1)">
          System {{ system_left }}
          <small>Somewhat Prefer</small>
        </button>
        <button type="button" class="preference-btn" data-value="0" onclick="selectPreference(0)">
          No Meaningful
          <small>Difference</small>
        </button>
        <button type="button" class="preference-btn" data-value="1" onclick="selectPreference(1)">
          System {{ system_right }}
          <small>Somewhat Prefer</small>
        </button>
        <button type="button" class="preference-btn" data-value="2" onclick="selectPreference(2)">
          System {{ system_right }}
          <small>Strongly Prefer</small>
        </button>
      </div>
      <input type="hidden" name="overall_preference" id="overallPreference" required>

      <div class="justification-section">
        <label>Brief justification for your preference (required):</label>
        <textarea
          class="justification-textarea"
          name="preference_justification"
          id="preferenceJustification"
          placeholder="What factors most influenced your preference?"
          required></textarea>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <h4>Additional Comments (Optional)</h4>
      <textarea
        class="comments-textarea"
        name="comments"
        placeholder="Share any additional observations about the systems' performance, specific strengths or weaknesses, or suggestions for improvement..."></textarea>
    </div>

    <!-- Submit Section -->
    <div class="submit-section">
      <button type="submit" class="submit-btn" id="submitBtn">Submit Evaluation</button>
      <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
        Your evaluation will be anonymously recorded for research purposes.
      </p>
    </div>
  </form>
</div>

<script>
// Progress tracking
function updateProgress() {
  const form = document.getElementById('evaluationForm');
  const radioGroups = new Set();
  form.querySelectorAll('input[type="radio"]').forEach(radio => {
    radioGroups.add(radio.name);
  });

  let filledGroups = 0;
  radioGroups.forEach(name => {
    if (form.querySelector(`input[name="${name}"]:checked`)) {
      filledGroups++;
    }
  });

  // Check preference and justification
  const preference = document.getElementById('overallPreference').value;
  const justification = document.getElementById('preferenceJustification').value.trim();

  let totalItems = radioGroups.size + 2; // +2 for preference and justification
  let completedItems = filledGroups;
  if (preference) completedItems++;
  if (justification.length >= 10) completedItems++;

  const progress = (completedItems / totalItems) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
}

// Preference selection
function selectPreference(value) {
  const buttons = document.querySelectorAll('.preference-btn');
  buttons.forEach(btn => btn.classList.remove('selected'));

  const selectedBtn = document.querySelector(`[data-value="${value}"]`);
  if (selectedBtn) {
    selectedBtn.classList.add('selected');
  }

  document.getElementById('overallPreference').value = value;
  updateProgress();
}

// Scale selection visual feedback
document.addEventListener('DOMContentLoaded', function() {
  const radioButtons = document.querySelectorAll('input[type="radio"]');

  radioButtons.forEach(radio => {
    radio.addEventListener('change', function() {
      // Remove selected class from siblings
      const name = this.name;
      const siblings = document.querySelectorAll(`input[name="${name}"]`);
      siblings.forEach(sibling => {
        sibling.closest('.scale-option').classList.remove('selected');
      });

      // Add selected class to current
      this.closest('.scale-option').classList.add('selected');
      updateProgress();
    });
  });

  // Update progress on justification input
  document.getElementById('preferenceJustification').addEventListener('input', updateProgress);

  // Initialize progress
  updateProgress();
});

// Form validation before submit
document.getElementById('evaluationForm').addEventListener('submit', function(e) {
  const preference = document.getElementById('overallPreference').value;
  if (preference === '') {
    e.preventDefault();
    alert('Please select an overall preference before submitting.');
    return false;
  }

  const justification = document.getElementById('preferenceJustification').value.trim();
  if (justification.length < 10) {
    e.preventDefault();
    alert('Please provide a brief justification for your preference (at least 10 characters).');
    return false;
  }

  // Validate all radio groups
  const form = this;
  const radioGroups = new Set();
  form.querySelectorAll('input[type="radio"][required]').forEach(radio => {
    radioGroups.add(radio.name);
  });

  for (let group of radioGroups) {
    if (!form.querySelector(`input[name="${group}"]:checked`)) {
      e.preventDefault();
      alert('Please complete all evaluation ratings before submitting.');
      return false;
    }
  }

  return true;
});
</script>
{% endblock %}
