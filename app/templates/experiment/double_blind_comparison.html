{% extends "base.html" %}

{% block title %}Double-Blind Evaluation - Case {{ document.id }}{% endblock %}

{% block head %}
{{ super() }}
<style>
  .evaluation-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  .study-header {
    text-align: center;
    margin-bottom: 40px;
    padding: 30px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  .study-title {
    font-size: 2.2em;
    font-weight: 300;
    margin-bottom: 10px;
  }
  
  .study-subtitle {
    font-size: 1.1em;
    opacity: 0.9;
    font-weight: 300;
  }
  
  .participant-id {
    position: absolute;
    top: 20px;
    right: 20px;
    background-color: rgba(255,255,255,0.2);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9em;
  }
  
  .case-context {
    margin-bottom: 40px;
    padding: 25px;
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
    border-radius: 8px;
  }
  
  .case-context h3 {
    color: #0066cc;
    margin-bottom: 15px;
  }
  
  .comparison-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
  }
  
  .system-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
  }
  
  .system-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    transform: translateY(-2px);
  }
  
  .system-header {
    padding: 20px;
    font-weight: 600;
    font-size: 1.3em;
    text-align: center;
    color: white;
  }
  
  .system-a .system-header {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }
  
  .system-b .system-header {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  }
  
  .system-content {
    padding: 25px;
    line-height: 1.7;
    font-size: 1.05em;
    color: #333;
    min-height: 300px;
  }
  
  .evaluation-form {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  
  .evaluation-header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e9ecef;
  }
  
  .evaluation-header h3 {
    color: #333;
    font-weight: 300;
    font-size: 1.8em;
  }
  
  .evaluation-instruction {
    background-color: #e3f2fd;
    border: 1px solid #bbdefb;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    color: #1565c0;
  }
  
  .criteria-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
  }
  
  .criteria-section {
    background-color: #fafafa;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
  }
  
  .criteria-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .scale-selector {
    display: flex;
    justify-content: space-between;
    margin: 15px 0;
    padding: 10px;
    background-color: white;
    border-radius: 6px;
    border: 1px solid #ddd;
  }
  
  .scale-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
  }
  
  .scale-option:hover {
    background-color: #f0f0f0;
  }
  
  .scale-option input[type="radio"] {
    margin-bottom: 5px;
  }
  
  .scale-option.selected {
    background-color: #e3f2fd;
    color: #1976d2;
  }
  
  .scale-label {
    font-size: 0.8em;
    text-align: center;
  }
  
  .preference-section {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
    padding: 25px;
    border-radius: 12px;
    margin: 30px 0;
  }
  
  .preference-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 20px;
  }
  
  .preference-btn {
    padding: 15px 30px;
    border: 2px solid white;
    background-color: transparent;
    color: white;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }
  
  .preference-btn:hover {
    background-color: white;
    color: #333;
  }
  
  .preference-btn.selected {
    background-color: white;
    color: #333;
  }
  
  .comments-section {
    margin-top: 30px;
  }
  
  .comments-textarea {
    width: 100%;
    min-height: 120px;
    padding: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-family: inherit;
    font-size: 1em;
    resize: vertical;
  }
  
  .comments-textarea:focus {
    outline: none;
    border-color: #4facfe;
    box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
  }
  
  .submit-section {
    text-align: center;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #e9ecef;
  }
  
  .submit-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 25px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }
  
  .progress-indicator {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background-color: #e0e0e0;
    z-index: 1000;
  }
  
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    width: 0%;
    transition: width 0.3s ease;
  }
  
  .randomization-info {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: rgba(0,0,0,0.7);
    color: white;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    display: none;
  }
  
  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .comparison-section {
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    .criteria-grid {
      grid-template-columns: 1fr;
    }
    
    .preference-buttons {
      flex-direction: column;
      align-items: center;
    }
    
    .scale-selector {
      flex-wrap: wrap;
      gap: 5px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="progress-indicator">
  <div class="progress-bar" id="progressBar"></div>
</div>

<div class="evaluation-container">
  <div class="participant-id">
    Participant: {{ request.remote_addr|hash_participant_id }}
  </div>

  <div class="study-header">
    <h1 class="study-title">AI Ethics System Evaluation</h1>
    <p class="study-subtitle">Double-Blind Comparison Study - Engineering Ethics Case Analysis</p>
  </div>

  <div class="case-context">
    <h3>Case Background: {{ document.title }}</h3>
    {% if document.doc_metadata and document.doc_metadata.document_structure and document.doc_metadata.document_structure.sections %}
      {% for section_id, section in document.doc_metadata.document_structure.sections.items() %}
        {% if section.type and section.type.lower() != 'conclusion' %}
        <div class="case-section">
          <strong>{{ section.type.title() }}:</strong> {{ section.content|truncate(500) }}
        </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

  <div class="comparison-section">
    <!-- Randomization: Left/Right assignment varies per session -->
    {% if randomize_systems %}
      {% set system_left = 'B' if (request.remote_addr|hash|int % 2) else 'A' %}
      {% set system_right = 'A' if system_left == 'B' else 'B' %}
      {% set prediction_left = proethica_prediction if system_left == 'B' else baseline_prediction %}
      {% set prediction_right = baseline_prediction if system_left == 'B' else proethica_prediction %}
    {% else %}
      {% set system_left = 'A' %}
      {% set system_right = 'B' %}
      {% set prediction_left = baseline_prediction %}
      {% set prediction_right = proethica_prediction %}
    {% endif %}

    <div class="system-card system-a">
      <div class="system-header">
        System {{ system_left }}
      </div>
      <div class="system-content">
        {{ prediction_left.prediction_text|safe }}
      </div>
    </div>

    <div class="system-card system-b">
      <div class="system-header">
        System {{ system_right }}
      </div>
      <div class="system-content">
        {{ prediction_right.prediction_text|safe }}
      </div>
    </div>
  </div>

  <form method="POST" class="evaluation-form" id="evaluationForm">
    {{ form.hidden_tag() }}
    
    <!-- Hidden fields to track randomization -->
    <input type="hidden" name="system_left" value="{{ system_left }}">
    <input type="hidden" name="system_right" value="{{ system_right }}">
    <input type="hidden" name="randomization_seed" value="{{ request.remote_addr|hash }}">

    <div class="evaluation-header">
      <h3>Evaluation Criteria</h3>
      <div class="evaluation-instruction">
        Please evaluate both systems on the following criteria. Consider the quality of reasoning, 
        ethical grounding, and practical applicability of each system's analysis.
      </div>
    </div>

    <div class="criteria-grid">
      <div class="criteria-section">
        <div class="criteria-title">
          Reasoning Quality
          <span class="help-icon" title="Logical flow and depth of ethical analysis">?</span>
        </div>
        <div class="system-comparison">
          <div class="comparison-row">
            <span>System {{ system_left }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="reasoning_quality_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="comparison-row">
            <span>System {{ system_right }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="reasoning_quality_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="criteria-section">
        <div class="criteria-title">
          Ethical Grounding
          <span class="help-icon" title="Connection to established ethical principles">?</span>
        </div>
        <div class="system-comparison">
          <div class="comparison-row">
            <span>System {{ system_left }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ethical_grounding_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="comparison-row">
            <span>System {{ system_right }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="ethical_grounding_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="criteria-section">
        <div class="criteria-title">
          Practical Applicability
          <span class="help-icon" title="Usefulness for real-world decision making">?</span>
        </div>
        <div class="system-comparison">
          <div class="comparison-row">
            <span>System {{ system_left }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="practical_applicability_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="comparison-row">
            <span>System {{ system_right }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="practical_applicability_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <div class="criteria-section">
        <div class="criteria-title">
          Overall Coherence
          <span class="help-icon" title="Internal consistency and clarity">?</span>
        </div>
        <div class="system-comparison">
          <div class="comparison-row">
            <span>System {{ system_left }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="coherence_left" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="comparison-row">
            <span>System {{ system_right }}</span>
            <div class="scale-selector">
              {% for i in range(1, 8) %}
              <label class="scale-option">
                <input type="radio" name="coherence_right" value="{{ i }}" required>
                <span class="scale-label">{{ i }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="preference-section">
      <h3 style="text-align: center; margin-bottom: 10px;">Overall Preference</h3>
      <p style="text-align: center; opacity: 0.9;">Which system would you prefer for analyzing similar engineering ethics cases?</p>
      <div class="preference-buttons">
        <button type="button" class="preference-btn" data-value="left" onclick="selectPreference('left')">
          System {{ system_left }}
        </button>
        <button type="button" class="preference-btn" data-value="neither" onclick="selectPreference('neither')">
          No Preference
        </button>
        <button type="button" class="preference-btn" data-value="right" onclick="selectPreference('right')">
          System {{ system_right }}
        </button>
      </div>
      <input type="hidden" name="overall_preference" id="overallPreference" required>
    </div>

    <div class="comments-section">
      <h4>Additional Comments (Optional)</h4>
      <textarea 
        class="comments-textarea" 
        name="comments" 
        placeholder="Please share any additional thoughts about the systems' performance, specific strengths or weaknesses you noticed, or suggestions for improvement...">{{ form.comments.data or '' }}</textarea>
    </div>

    <div class="submit-section">
      <button type="submit" class="submit-btn">Submit Evaluation</button>
      <p style="margin-top: 15px; color: #666; font-size: 0.9em;">
        Your evaluation will be anonymously recorded for research purposes.
      </p>
    </div>
  </form>
</div>

<div class="randomization-info" id="randomizationInfo">
  Randomization: {{ system_left }} = {{ 'ProEthica' if system_left == 'B' else 'Baseline' }}, 
  {{ system_right }} = {{ 'ProEthica' if system_right == 'B' else 'Baseline' }}
</div>

<script>
// Progress tracking
function updateProgress() {
  const form = document.getElementById('evaluationForm');
  const requiredFields = form.querySelectorAll('input[required], select[required]');
  const filledFields = Array.from(requiredFields).filter(field => {
    if (field.type === 'radio') {
      return form.querySelector(`input[name="${field.name}"]:checked`);
    }
    return field.value.trim() !== '';
  });
  
  const progress = (filledFields.length / requiredFields.length) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
}

// Preference selection
function selectPreference(value) {
  const buttons = document.querySelectorAll('.preference-btn');
  buttons.forEach(btn => btn.classList.remove('selected'));
  
  const selectedBtn = document.querySelector(`[data-value="${value}"]`);
  selectedBtn.classList.add('selected');
  
  document.getElementById('overallPreference').value = value;
  updateProgress();
}

// Scale selection visual feedback
document.addEventListener('DOMContentLoaded', function() {
  const radioButtons = document.querySelectorAll('input[type="radio"]');
  
  radioButtons.forEach(radio => {
    radio.addEventListener('change', function() {
      // Remove selected class from siblings
      const name = this.name;
      const siblings = document.querySelectorAll(`input[name="${name}"]`);
      siblings.forEach(sibling => {
        sibling.closest('.scale-option').classList.remove('selected');
      });
      
      // Add selected class to current
      this.closest('.scale-option').classList.add('selected');
      updateProgress();
    });
  });
  
  // Show randomization info for admins (toggle with Ctrl+R)
  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'r') {
      e.preventDefault();
      const info = document.getElementById('randomizationInfo');
      info.style.display = info.style.display === 'none' ? 'block' : 'none';
    }
  });
  
  // Initialize progress
  updateProgress();
});

// Form validation before submit
document.getElementById('evaluationForm').addEventListener('submit', function(e) {
  const preference = document.getElementById('overallPreference').value;
  if (!preference) {
    e.preventDefault();
    alert('Please select an overall preference before submitting.');
    return false;
  }
  
  // Additional validation for required radio groups
  const requiredGroups = [
    'reasoning_quality_left', 'reasoning_quality_right',
    'ethical_grounding_left', 'ethical_grounding_right',
    'practical_applicability_left', 'practical_applicability_right',
    'coherence_left', 'coherence_right'
  ];
  
  for (let group of requiredGroups) {
    if (!document.querySelector(`input[name="${group}"]:checked`)) {
      e.preventDefault();
      alert(`Please complete all evaluation criteria ratings.`);
      return false;
    }
  }
  
  return true;
});
</script>

<!-- Custom Jinja2 filters needed -->
{% set dummy = request.jinja_env.filters.update({
  'hash_participant_id': 'lambda x: "P" + str(hash(x) % 10000)',
  'hash': 'lambda x: hash(x)'
}) %}
{% endblock %}
