{% extends "base.html" %}

{# Ontology Label Macro - inline definition for entity labels with popovers #}
{% macro ontology_label(uri, entity_lookup) %}
{%- set label = uri.split('#')[-1] if uri is string and '#' in uri else (uri.split('/')[-1] if uri is string and '/' in uri else uri) -%}
{%- set entity = entity_lookup.get(uri) if entity_lookup and uri is string else none -%}
{%- if entity -%}
{%- set pass_class = 'bg-primary' if entity.source_pass == 1 else ('bg-success' if entity.source_pass == 2 else ('bg-warning text-dark' if entity.source_pass == 3 else 'bg-danger')) -%}
{%- set type_class = 'onto-type-' ~ (entity.extraction_type or 'default')|lower|replace(' ', '-') -%}
<span class="onto-label"
      tabindex="0"
      data-bs-toggle="popover"
      data-bs-trigger="hover focus"
      data-bs-html="true"
      data-bs-placement="top"
      data-entity-type="{{ entity.entity_type or entity.extraction_type }}"
      data-entity-pass="{{ entity.source_pass }}"
      data-entity-definition="{{ entity.definition|e }}"
      data-entity-uri="{{ uri|e }}"
      title="{{ entity.label or label }}">{{ entity.label or label }}</span>
{%- elif uri is string and ('http' in uri or '#' in uri) -%}
<span class="onto-label onto-label-unknown"
      tabindex="0"
      data-bs-toggle="popover"
      data-bs-trigger="hover focus"
      data-bs-html="true"
      data-bs-placement="top"
      data-entity-uri="{{ uri|e }}"
      title="{{ label }}">{{ label }}</span>
{%- else -%}
<span>{{ uri }}</span>
{%- endif -%}
{% endmacro %}

{% block title %}Step 4 Review - Case {{ case.id }}{% endblock %}

{% block styles %}
<style>
    /* Ontology Label Styles */
    .onto-label { cursor: help; border-bottom: 1px dotted currentColor; text-decoration: none; }
    .onto-label:hover { background-color: rgba(var(--bs-primary-rgb), 0.1); border-radius: 2px; }
    .onto-popover-content { max-width: 350px; }
    .onto-popover-content .onto-type-badge { font-size: 0.7rem; padding: 0.15rem 0.4rem; }
    .onto-popover-content .onto-uri { font-size: 0.7rem; word-break: break-all; color: #6c757d; background: #f8f9fa; padding: 4px 6px; border-radius: 3px; margin-top: 8px; }
    .onto-popover-content .onto-definition { font-size: 0.85rem; margin: 8px 0; color: #495057; }
    .onto-popover-content .onto-pass-badge { font-size: 0.65rem; }
    .onto-label-unknown { color: #6c757d; font-style: italic; }
    .onto-type-roles, .onto-type-role { background-color: #0d6efd; color: white; }
    .onto-type-states, .onto-type-state { background-color: #6f42c1; color: white; }
    .onto-type-resources, .onto-type-resource { background-color: #20c997; color: white; }
    .onto-type-principles, .onto-type-principle { background-color: #fd7e14; color: white; }
    .onto-type-obligations, .onto-type-obligation { background-color: #dc3545; color: white; }
    .onto-type-constraints, .onto-type-constraint { background-color: #6c757d; color: white; }
    .onto-type-capabilities, .onto-type-capability { background-color: #0dcaf0; color: black; }
    .onto-type-actions, .onto-type-action, .onto-type-temporal_dynamics_enhanced { background-color: #198754; color: white; }
    .onto-type-events, .onto-type-event { background-color: #ffc107; color: black; }

    /* Original styles */
    .bg-purple { background-color: #6F42C1 !important; }
    .applies-to-item { font-size: 0.9rem; }
    .qc-link-card {
        border-left: 4px solid #FFC107;
        transition: all 0.2s ease;
    }
    .qc-link-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .qc-arrow {
        font-size: 1.5rem;
        color: #28A745;
    }
    .linked-conclusion {
        border-left: 4px solid #28A745;
        background-color: #f8fff8;
    }
    .unlinked-item {
        border-left: 4px solid #6c757d;
        opacity: 0.8;
    }

    /* Fullscreen mode for D3 graph */
    #d3-graph-card.fullscreen {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999;
        background: white;
        padding: 10px;
    }
    #d3-graph-card.fullscreen #d3-graph-container {
        height: calc(100vh - 20px) !important;
        border: none;
    }
    #d3-graph-card.fullscreen #d3-graph-svg {
        width: 100%;
        height: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-clipboard-check"></i> Step 4: Synthesis Review</h2>
            <p class="text-muted mb-0">Case {{ case.id }}: {{ case.title }}</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <!-- Publish to OntServe Button -->
            {% if current_user.is_authenticated %}
                {% if unpublished_count > 0 and can_publish %}
                <button id="publishAllBtn" class="btn btn-primary" onclick="publishAllEntities()">
                    <i class="bi bi-cloud-upload"></i> Publish to OntServe ({{ unpublished_count }})
                </button>
                {% elif unpublished_count > 0 and not can_publish %}
                <button id="publishAllBtn" class="btn btn-secondary" disabled title="Complete Pass 1 extraction before publishing">
                    <i class="bi bi-cloud-upload"></i> Publish (Pass 1 Required)
                </button>
                {% elif published_count > 0 %}
                <button id="publishAllBtn" class="btn btn-success" disabled>
                    <i class="bi bi-check-circle"></i> Published ({{ published_count }})
                </button>
                {% else %}
                <button id="publishAllBtn" class="btn btn-secondary" disabled title="Extract entities first">
                    <i class="bi bi-cloud-upload"></i> No Entities
                </button>
                {% endif %}
            {% else %}
            <button class="btn btn-secondary" onclick="window.location.href='{{ url_for('auth.login') }}';" title="Login required to publish">
                <i class="bi bi-lock-fill"></i> Publish (Login Required)
            </button>
            {% endif %}

            <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Step 4
            </a>
        </div>
    </div>

    <!-- Alert for publish operations -->
    <div id="publishAlert" class="alert alert-dismissible fade" role="alert" style="display: none;">
        <div id="publishMessage"></div>
        <button type="button" class="btn-close" onclick="document.getElementById('publishAlert').style.display='none'"></button>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col">
            <div class="card text-center border-primary">
                <div class="card-body py-2">
                    <h4 class="text-primary mb-0">{{ entity_count }}</h4>
                    <small class="text-muted">Entities</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-info">
                <div class="card-body py-2">
                    <h4 class="text-info mb-0">{{ provision_count }}</h4>
                    <small class="text-muted">Provisions</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-warning">
                <div class="card-body py-2">
                    <h4 class="text-warning mb-0">{{ question_count }}</h4>
                    <small class="text-muted">Questions</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-success">
                <div class="card-body py-2">
                    <h4 class="text-success mb-0">{{ conclusion_count }}</h4>
                    <small class="text-muted">Conclusions</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-purple" style="border-color: #6F42C1 !important;">
                <div class="card-body py-2">
                    {% if transformation_data and transformation_data.type %}
                    <h4 class="mb-0" style="color: #6F42C1;">
                        {% if transformation_data.type == 'transfer' %}Transfer
                        {% elif transformation_data.type == 'stalemate' %}Stalemate
                        {% elif transformation_data.type == 'oscillation' %}Oscillation
                        {% elif transformation_data.type == 'phase_lag' %}Phase Lag
                        {% else %}{{ transformation_data.type|title }}{% endif %}
                    </h4>
                    <small class="text-muted">Transformation
                        <a href="/tools/references#transformation" title="Marchais-Roubelat & Roubelat (2015)" class="text-muted ms-1">
                            <i class="bi bi-info-circle"></i>
                        </a>
                    </small>
                    {% else %}
                    <h4 class="text-muted mb-0">--</h4>
                    <small class="text-muted">Transformation
                        <a href="/tools/references#transformation" title="Marchais-Roubelat & Roubelat (2015)" class="text-muted ms-1">
                            <i class="bi bi-info-circle"></i>
                        </a>
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Transformation Details (if available) -->
    {% if transformation_data and transformation_data.type and transformation_data.type != 'unclear' %}
    <div class="alert alert-light border mb-4">
        <div class="d-flex align-items-center">
            <span class="badge me-2" style="background-color: #6F42C1;">
                {% if transformation_data.type == 'transfer' %}Transfer
                {% elif transformation_data.type == 'stalemate' %}Stalemate
                {% elif transformation_data.type == 'oscillation' %}Oscillation
                {% elif transformation_data.type == 'phase_lag' %}Phase Lag
                {% else %}{{ transformation_data.type|title }}{% endif %}
            </span>
            <span>
                {% if transformation_data.type == 'transfer' %}
                Resolution transfers obligation/responsibility to another party
                {% elif transformation_data.type == 'stalemate' %}
                Competing obligations remain in tension without clear resolution
                {% elif transformation_data.type == 'oscillation' %}
                Duties shift back and forth between parties over time
                {% elif transformation_data.type == 'phase_lag' %}
                Delayed consequences reveal obligations not initially apparent
                {% endif %}
            </span>
        </div>
        {% if transformation_data.pattern %}
        <small class="text-muted d-block mt-1">{{ transformation_data.pattern }}</small>
        {% endif %}
    </div>
    {% endif %}

    <!-- Tabs (compact labels to fit on one line) -->
    <ul class="nav nav-tabs nav-fill mb-3" id="reviewTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="fullgraph-tab" data-bs-toggle="tab" data-bs-target="#fullgraph" type="button">
                <i class="bi bi-diagram-3"></i> Entities <span class="badge bg-secondary" id="entities-tab-badge">{{ entity_count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph" type="button">
                <i class="bi bi-arrow-right-circle"></i> Flow
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="provisions-tab" data-bs-toggle="tab" data-bs-target="#provisions" type="button">
                <i class="bi bi-file-text"></i> Provisions
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button">
                <i class="bi bi-question-circle"></i> Q&C
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="richanalysis-tab" data-bs-toggle="tab" data-bs-target="#richanalysis" type="button">
                <i class="bi bi-lightbulb"></i> Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="decision-points-tab" data-bs-toggle="tab" data-bs-target="#decisionpoints" type="button">
                <i class="bi bi-signpost-split"></i> Decisions <span class="badge bg-primary">{{ decision_points|length if decision_points else 0 }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="narrative-tab" data-bs-toggle="tab" data-bs-target="#narrative" type="button">
                <i class="bi bi-book"></i> Narrative
            </button>
        </li>
    </ul>

    <div class="tab-content" id="reviewTabContent">
        <!-- Data Inventory Tab - MOVED TO step4.html -->

        <!-- Full Entity Graph Tab (D3.js) -->
        <div class="tab-pane fade show active" id="fullgraph" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Full Entity Graph</h5>
                        <small class="text-muted"><span id="d3-node-count">Loading...</span></small>
                    </div>
                    <div>
                        <span class="badge bg-primary me-1" id="d3-pass1">Pass 1: 0</span>
                        <span class="badge bg-success me-1" id="d3-pass2">Pass 2: 0</span>
                        <span class="badge bg-warning text-dark me-1" id="d3-pass3">Pass 3: 0</span>
                        <span class="badge bg-danger" id="d3-pass4">Step 4: 0</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- D3 Graph Controls - Row 1: Search and Pass Filters -->
                    <div class="mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <div class="input-group input-group-sm" style="width: 200px;">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="d3-search" class="form-control" placeholder="Search entities...">
                            </div>
                        </div>
                        <div class="d-flex align-items-center flex-wrap gap-1">
                            <span class="me-1 text-muted small">Pass:</span>
                            <button class="btn btn-sm btn-outline-secondary d3-filter active" data-pass="all">All</button>
                            <button class="btn btn-sm btn-outline-primary d3-filter" data-pass="1">1</button>
                            <button class="btn btn-sm btn-outline-success d3-filter" data-pass="2">2</button>
                            <button class="btn btn-sm btn-outline-warning d3-filter" data-pass="3">3</button>
                            <button class="btn btn-sm btn-outline-danger d3-filter" data-pass="4">4</button>
                        </div>
                    </div>
                    <!-- D3 Graph Controls - Row 2: Layout, Display Options -->
                    <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="d-flex align-items-center">
                                <label class="form-label mb-0 me-1 small text-muted">Layout:</label>
                                <select class="form-select form-select-sm" id="d3-layout-select" style="width: 90px;">
                                    <option value="force" selected>Force</option>
                                    <option value="circular">Circular</option>
                                    <option value="grid">Grid</option>
                                    <option value="radial">Radial</option>
                                </select>
                            </div>
                            <div class="form-check form-check-inline mb-0">
                                <input class="form-check-input" type="checkbox" id="d3-hide-unconnected" checked>
                                <label class="form-check-label small" for="d3-hide-unconnected">Hide unconnected</label>
                            </div>
                        </div>
                        <div class="d-flex align-items-center gap-1">
                            <button class="btn btn-sm btn-info" id="d3-toggle-hubs" title="Group entities by type (R, P, O, S, Rs, A, E, Ca, Cs)">
                                <i class="bi bi-diagram-2"></i> Type Hubs
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="d3-refresh" title="Refresh graph">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>

                    <!-- D3 Graph Container -->
                    <div id="d3-graph-card" class="position-relative">
                        <div id="d3-graph-container" style="width: 100%; height: 600px; border: 1px solid #ddd; background-color: #fafafa; position: relative;">
                            <svg id="d3-graph-svg" style="width: 100%; height: 100%;"></svg>

                            <!-- Loading Overlay -->
                            <div id="d3-loading-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" style="background: rgba(255,255,255,0.9); z-index: 50;">
                                <div class="text-center">
                                    <div class="spinner-border text-primary mb-2" role="status"></div>
                                    <div class="small text-muted" id="d3-loading-text">Building graph...</div>
                                </div>
                            </div>

                            <!-- Entity Details Panel -->
                            <div id="d3-entity-details" style="position: absolute; top: 10px; right: 10px; width: 320px; max-height: 450px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; z-index: 100;">
                                <button type="button" class="btn-close float-end" id="d3-close-details"></button>
                                <h6 id="d3-detail-label" class="mb-2" style="border-bottom: 2px solid #666; padding-bottom: 5px;"></h6>
                                <p class="small mb-2">
                                    <span class="badge" id="d3-detail-type"></span>
                                    <span class="badge bg-secondary" id="d3-detail-pass"></span>
                                </p>
                                <p class="small text-muted mb-2" id="d3-detail-definition"></p>
                                <div id="d3-detail-metadata" class="small mb-2" style="display: none;">
                                    <div id="d3-detail-agent" class="mb-1" style="display: none;">
                                        <strong class="text-primary">Agent:</strong> <span></span>
                                    </div>
                                    <div id="d3-detail-temporal" class="mb-1" style="display: none;">
                                        <strong class="text-info">When:</strong> <span></span>
                                    </div>
                                </div>
                                <p class="small mb-1"><strong>Connections:</strong></p>
                                <ul class="small list-unstyled" id="d3-detail-connections"></ul>
                            </div>

                            <!-- Zoom Controls -->
                            <div style="position: absolute; bottom: 10px; left: 10px; z-index: 100;">
                                <button class="btn btn-sm btn-light" id="d3-zoom-in" title="Zoom In"><i class="bi bi-plus-lg"></i></button>
                                <button class="btn btn-sm btn-light" id="d3-zoom-out" title="Zoom Out"><i class="bi bi-dash-lg"></i></button>
                                <button class="btn btn-sm btn-light" id="d3-zoom-reset" title="Reset View"><i class="bi bi-arrows-fullscreen"></i></button>
                                <button class="btn btn-sm btn-primary" id="d3-fullscreen-btn" title="Full Screen"><i class="bi bi-fullscreen"></i></button>
                                <button class="btn btn-sm btn-warning" id="d3-exit-fullscreen-btn" title="Exit Full Screen" style="display: none;"><i class="bi bi-fullscreen-exit"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-3">
                        <h6>Entity Types</h6>
                        <div id="d3-legend" class="d-flex flex-wrap gap-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reasoning Flow Tab (Cytoscape) -->
        <div class="tab-pane fade" id="graph" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-arrow-right-circle"></i> Synthesis Reasoning Flow</h5>
                    <small class="text-muted">Shows how NSPE provisions inform questions and conclusions - the board's reasoning chain</small>
                </div>
                <div class="card-body">
                    <!-- Graph Controls -->
                    <div class="mb-3">
                        <button id="fit-graph" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrows-fullscreen"></i> Fit to View
                        </button>
                        <button id="reset-graph" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Reset Layout
                        </button>
                        <div class="btn-group ms-2" role="group">
                            <input type="checkbox" class="btn-check" id="show-labels" checked autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="show-labels">Show Labels</label>
                        </div>
                    </div>

                    <!-- Cytoscape Container -->
                    <div style="position: relative;">
                        <div id="cy" style="width: 100%; height: 700px; border: 1px solid #ddd; background-color: #fafafa;"></div>

                        <!-- Flow Details Panel -->
                        <div id="cy-details-panel" style="position: absolute; top: 10px; right: 10px; width: 320px; max-height: 400px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; z-index: 100;">
                            <button type="button" class="btn-close float-end" id="cy-close-details"></button>
                            <h6 id="cy-detail-label" class="mb-2" style="border-bottom: 2px solid #666; padding-bottom: 5px;"></h6>
                            <p class="small mb-2">
                                <span class="badge" id="cy-detail-type"></span>
                            </p>
                            <div id="cy-detail-text" class="small text-muted mb-2"></div>
                            <div id="cy-detail-connections" class="small">
                                <strong>Connections:</strong>
                                <ul class="list-unstyled mt-1" id="cy-detail-edges"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-3">
                        <h6>Node Types & Relationships</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Nodes:</strong>
                                <div class="d-flex flex-wrap gap-3 mt-2">
                                    <span><span class="badge" style="background-color: #6C757D;">■</span> NSPE Provisions (rectangles)</span>
                                    <span><span class="badge" style="background-color: #FFC107;">◆</span> Questions (diamonds)</span>
                                    <span><span class="badge" style="background-color: #28A745;">▬</span> Conclusions (rounded)</span>
                                    <span><span class="badge" style="background-color: #17A2B8;">●</span> Entities (circles)</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <strong>Edge Colors:</strong>
                                <div class="mt-2">
                                    <span class="badge" style="background-color: #6C757D;">→</span> Provision informs Question<br>
                                    <span class="badge" style="background-color: #FFC107;">→</span> Question answered by Conclusion<br>
                                    <span class="badge" style="background-color: #17A2B8;">→</span> Provision applies to Entity
                                </div>
                            </div>
                        </div>
                        <p class="text-muted mt-2 mb-0"><small><strong>Note:</strong> For individual entity visualization, see <a href="http://localhost:5003/editor/ontology/proethica-case-{{ case.id }}/visualize" target="_blank">OntServe's full ontology view</a></small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Provisions Tab -->
        <div class="tab-pane fade" id="provisions" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-file-text"></i> NSPE Code Provisions Referenced</h5>
                    <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#provisionsSection" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> View Extraction
                    </a>
                </div>
                <div class="card-body">
                    {% if provisions %}
                        {% for provision in provisions %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <strong>{{ provision.entity_label }}</strong>
                                    {% if provision.rdf_json_ld and provision.rdf_json_ld.codeProvision %}
                                    <span class="badge bg-secondary ms-2">{{ provision.rdf_json_ld.codeProvision }}</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>Full Text:</strong></p>
                                <p class="text-muted mb-3">{{ provision.entity_definition }}</p>

                                {% if provision.rdf_json_ld and provision.rdf_json_ld.relevantExcerpts %}
                                <p class="mb-2"><strong>Relevant Case Excerpts:</strong></p>
                                {% for excerpt in provision.rdf_json_ld.relevantExcerpts %}
                                <div class="alert alert-info mb-2">
                                    <small class="text-muted"><strong>From {{ excerpt.section }}:</strong></small><br>
                                    "{{ excerpt.text }}"
                                    {% if excerpt.confidence %}
                                    <br><small class="text-muted">Confidence: {{ "%.1f"|format(excerpt.confidence * 100) }}%</small>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% endif %}

                                {% if provision.rdf_json_ld and provision.rdf_json_ld.appliesTo %}
                                <p class="mb-2"><strong>Applies To:</strong></p>
                                <div class="applies-to-list">
                                    {% for entity in provision.rdf_json_ld.appliesTo %}
                                    <div class="applies-to-item mb-2 p-2 border rounded bg-light">
                                        <div class="d-flex align-items-center">
                                            <span class="badge me-2
                                                {% if entity.entity_type|lower == 'roles' %}bg-primary
                                                {% elif entity.entity_type|lower == 'obligations' %}bg-warning text-dark
                                                {% elif entity.entity_type|lower == 'principles' %}bg-purple
                                                {% elif entity.entity_type|lower == 'actions' %}bg-dark
                                                {% elif entity.entity_type|lower == 'states' %}bg-info
                                                {% else %}bg-secondary{% endif %}">
                                                {{ entity.entity_type|default('Entity') }}
                                            </span>
                                            <strong>{{ entity.entity_label|default(entity) }}</strong>
                                        </div>
                                        {% if entity.reasoning %}
                                        <small class="text-muted d-block mt-1 fst-italic">{{ entity.reasoning }}</small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No code provisions extracted yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Questions & Conclusions Tab -->
        <div class="tab-pane fade" id="questions" role="tabpanel">
            <!-- Header with link back to extraction -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="bi bi-question-circle"></i> Questions & Conclusions</h6>
                    <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#questionsSection" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> View Extraction
                    </a>
                </div>
            </div>

            <!-- View Toggle -->
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="qcView" id="linkedView" checked>
                    <label class="btn btn-outline-primary" for="linkedView">Linked View</label>
                    <input type="radio" class="btn-check" name="qcView" id="splitView">
                    <label class="btn btn-outline-primary" for="splitView">Side-by-Side</label>
                </div>
            </div>

            <!-- LINKED VIEW: Shows Q→C relationships clearly -->
            <div id="linkedViewContent">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Each question is shown with its corresponding conclusion(s). This reveals the board's reasoning flow.
                </div>

                {% if questions %}
                    {% for question in questions %}
                    {% set q_num = (question.rdf_json_ld.questionNumber|string) if (question.rdf_json_ld and question.rdf_json_ld.questionNumber) else '' %}
                    {% set q_type = question.rdf_json_ld.questionType if (question.rdf_json_ld and question.rdf_json_ld.questionType) else 'unknown' %}
                    <div class="card mb-4 qc-link-card" id="qc-pair-{{ loop.index }}">
                        <!-- Question Header -->
                        <div class="card-header {% if q_type == 'board_explicit' %}bg-warning text-dark{% else %}bg-light{% endif %}">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-question-circle me-2"></i>
                                    Question {{ loop.index }}
                                    {% if q_type == 'board_explicit' %}
                                    <span class="badge bg-primary ms-2">Board Question</span>
                                    {% elif q_type == 'implicit' %}
                                    <span class="badge bg-secondary ms-2">Implicit</span>
                                    {% elif q_type == 'principle_tension' %}
                                    <span class="badge bg-info ms-2">Principle Tension</span>
                                    {% elif q_type == 'theoretical' %}
                                    <span class="badge bg-dark ms-2">Theoretical</span>
                                    {% elif q_type == 'counterfactual' %}
                                    <span class="badge bg-light text-dark ms-2">Counterfactual</span>
                                    {% endif %}
                                </h6>
                                {% if question.rdf_json_ld and question.rdf_json_ld.relatedProvisions %}
                                <div>
                                    {% for prov in question.rdf_json_ld.relatedProvisions %}
                                    <span class="badge bg-secondary">{{ prov }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Question Text -->
                            <p class="mb-3">{{ question.entity_definition }}</p>

                            {% if question.rdf_json_ld and question.rdf_json_ld.mentionedEntities %}
                            <div class="mb-3">
                                <small class="text-muted"><strong>Involves:</strong></small>
                                {% for entity in question.rdf_json_ld.mentionedEntities %}
                                <span class="badge bg-info me-1">{{ entity }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Arrow to Conclusions -->
                            <div class="text-center my-2">
                                <span class="qc-arrow"><i class="bi bi-arrow-down-circle-fill"></i></span>
                                {% if q_type == 'board_explicit' %}
                                <small class="text-muted d-block">Board's Conclusion</small>
                                {% else %}
                                <small class="text-muted d-block">Analysis</small>
                                {% endif %}
                            </div>

                            <!-- Linked Conclusions -->
                            {% set question_num = (question.rdf_json_ld.questionNumber|string) if (question.rdf_json_ld and question.rdf_json_ld.questionNumber) else question.entity_label|replace('Question_', '')|replace('Question ', '')|replace('Q', '') %}
                            {% set matched_conclusions = [] %}
                            {% for conclusion in conclusions %}
                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.answersQuestions %}
                                    {% for answered_q in conclusion.rdf_json_ld.answersQuestions %}
                                        {% if answered_q|string == question_num %}
                                            {% if conclusion not in matched_conclusions %}
                                                {% set _ = matched_conclusions.append(conclusion) %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}

                            {% for conclusion in matched_conclusions %}
                            {% set c_type = conclusion.rdf_json_ld.conclusionType if conclusion.rdf_json_ld else 'unknown' %}
                            {# Find conclusion's display index by looking it up in the full conclusions list #}
                            {% set ns_idx = namespace(val='') %}
                            {% for c in conclusions %}
                                {% if c.id == conclusion.id %}
                                    {% set ns_idx.val = loop.index %}
                                {% endif %}
                            {% endfor %}
                            <div class="card linked-conclusion mb-2 {% if c_type == 'board_explicit' %}border-success{% endif %}">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong class="{% if c_type == 'board_explicit' %}text-success{% else %}text-secondary{% endif %}">
                                                <i class="bi bi-check-circle me-1"></i>
                                                Conclusion {{ ns_idx.val }}
                                            </strong>
                                            {% if c_type == 'board_explicit' %}
                                            <span class="badge bg-success ms-2">Board Conclusion</span>
                                            {% elif c_type == 'analytical_extension' %}
                                            <span class="badge bg-secondary ms-2">Analytical</span>
                                            {% elif c_type == 'question_response' %}
                                            <span class="badge bg-info ms-2">Response</span>
                                            {% elif c_type == 'principle_synthesis' %}
                                            <span class="badge bg-dark ms-2">Synthesis</span>
                                            {% endif %}
                                            <p class="mb-1 mt-1">{{ conclusion.entity_definition }}</p>
                                        </div>
                                    </div>
                                    {% if conclusion.rdf_json_ld.citedProvisions %}
                                    <div class="mt-2">
                                        <small class="text-muted">Cites:</small>
                                        {% for prov in conclusion.rdf_json_ld.citedProvisions %}
                                        <span class="badge bg-secondary badge-sm">{{ prov }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}

                            {% if matched_conclusions|length == 0 %}
                            <div class="alert alert-secondary mb-0">
                                {% if q_type == 'board_explicit' %}
                                <small><i class="bi bi-exclamation-triangle"></i> Board's conclusion not yet extracted. Run conclusion extraction.</small>
                                {% else %}
                                <small><i class="bi bi-info-circle"></i> Analysis pending - insufficient information in case to address this question.</small>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Unlinked Conclusions -->
                    {% set unlinked_conclusions = [] %}
                    {% for conclusion in conclusions %}
                        {% if not conclusion.rdf_json_ld or not conclusion.rdf_json_ld.answersQuestions or conclusion.rdf_json_ld.answersQuestions|length == 0 %}
                            {% set _ = unlinked_conclusions.append(conclusion) %}
                        {% endif %}
                    {% endfor %}

                    {% if unlinked_conclusions|length > 0 %}
                    <div class="card mt-4 unlinked-item">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Additional Conclusions (No Direct Question Link)</h6>
                        </div>
                        <div class="card-body">
                            {% for conclusion in unlinked_conclusions %}
                            <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                <strong>{{ conclusion.entity_label }}</strong>
                                <p class="mb-1">{{ conclusion.entity_definition }}</p>
                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.citedProvisions %}
                                <small class="text-muted">Cites:</small>
                                {% for prov in conclusion.rdf_json_ld.citedProvisions %}
                                <span class="badge bg-secondary badge-sm">{{ prov }}</span>
                                {% endfor %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                {% else %}
                    <div class="alert alert-warning">No questions extracted yet. Run Step 4 synthesis first.</div>
                {% endif %}
            </div>

            <!-- SPLIT VIEW: Matched Q-C pairs in table format -->
            <div id="splitViewContent" style="display: none;">
                {% if questions %}
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50%"><i class="bi bi-question-circle text-warning"></i> Question</th>
                                <th style="width: 50%"><i class="bi bi-check-circle text-success"></i> Conclusion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for question in questions %}
                            {% set q_num = (question.rdf_json_ld.questionNumber|string) if (question.rdf_json_ld and question.rdf_json_ld.questionNumber) else '' %}
                            {% set q_type = question.rdf_json_ld.questionType if (question.rdf_json_ld and question.rdf_json_ld.questionType) else 'unknown' %}

                            {# Find matching conclusions for this question #}
                            {% set matched_conclusions = [] %}
                            {% for conclusion in conclusions %}
                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.answersQuestions %}
                                    {% if q_num|int in conclusion.rdf_json_ld.answersQuestions %}
                                        {% set _ = matched_conclusions.append(conclusion) %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            <tr>
                                <!-- Question Cell -->
                                <td class="{% if q_type == 'board_explicit' %}table-warning{% endif %}">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <strong>Question {{ loop.index }}</strong>
                                        {% if q_type == 'board_explicit' %}
                                        <span class="badge bg-primary">Board Question</span>
                                        {% elif q_type == 'implicit' %}
                                        <span class="badge bg-secondary">Implicit</span>
                                        {% elif q_type == 'principle_tension' %}
                                        <span class="badge bg-info">Principle Tension</span>
                                        {% elif q_type == 'theoretical' %}
                                        <span class="badge bg-dark">Theoretical</span>
                                        {% elif q_type == 'counterfactual' %}
                                        <span class="badge bg-light text-dark">Counterfactual</span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-0">{{ question.entity_definition }}</p>
                                </td>

                                <!-- Conclusion Cell -->
                                <td class="{% if matched_conclusions and matched_conclusions[0].rdf_json_ld.conclusionType == 'board_explicit' %}table-success{% endif %}">
                                    {% if matched_conclusions %}
                                        {% for conclusion in matched_conclusions %}
                                        {% set c_type = conclusion.rdf_json_ld.conclusionType if conclusion.rdf_json_ld else 'unknown' %}
                                        {# Find conclusion's display index #}
                                        {% set ns_c_idx = namespace(val='') %}
                                        {% for c in conclusions %}
                                            {% if c.id == conclusion.id %}
                                                {% set ns_c_idx.val = loop.index %}
                                            {% endif %}
                                        {% endfor %}
                                        <div class="{% if not loop.last %}mb-3 pb-3 border-bottom{% endif %}">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong>Conclusion {{ ns_c_idx.val }}</strong>
                                                {% if c_type == 'board_explicit' %}
                                                <span class="badge bg-success">Board Conclusion</span>
                                                {% elif c_type == 'analytical_extension' %}
                                                <span class="badge bg-secondary">Analytical</span>
                                                {% elif c_type == 'question_response' %}
                                                <span class="badge bg-info">Response</span>
                                                {% elif c_type == 'principle_synthesis' %}
                                                <span class="badge bg-dark">Synthesis</span>
                                                {% endif %}
                                            </div>
                                            <p class="mb-0">{{ conclusion.entity_definition }}</p>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        {% if q_type == 'board_explicit' %}
                                        <span class="text-warning fst-italic"><i class="bi bi-exclamation-triangle"></i> Not yet extracted</span>
                                        {% else %}
                                        <span class="text-muted fst-italic"><i class="bi bi-info-circle"></i> Insufficient information</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <div class="alert alert-warning">No questions extracted yet. Run Step 4 synthesis first.</div>
                {% endif %}
            </div>
        </div>

        <!-- Rich Analysis Tab -->
        <div class="tab-pane fade" id="richanalysis" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Rich Analysis Results</h5>
                    <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#rich_analysisSection" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> View Extraction
                    </a>
                </div>
                <div class="card-body">
                    {% if rich_analysis %}
                    <!-- Causal-Normative Links Section -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-link-45deg text-warning me-2"></i>
                            Causal-Normative Links
                            <span class="badge bg-warning text-dark ms-2">{{ rich_analysis.causal_links|length }}</span>
                        </h6>
                        {% if rich_analysis.causal_links %}
                        <div class="row">
                            {% for cl in rich_analysis.causal_links %}
                            <div class="col-md-6 mb-3">
                                <div class="card border-warning">
                                    <div class="card-body py-2">
                                        <h6 class="card-title mb-2">{{ cl.action_label }}</h6>
                                        {% if cl.action_definition %}
                                        <p class="text-muted small mb-2">{{ cl.action_definition }}</p>
                                        {% endif %}
                                        <!-- Fulfills Section -->
                                        <div class="mb-2 p-2 rounded" style="background-color: rgba(25, 135, 84, 0.08);">
                                            <small class="text-success fw-bold d-block mb-1">Fulfills</small>
                                            {% if cl.fulfills_obligations %}
                                            <ul class="list-unstyled small mb-0">
                                                {% for obl in cl.fulfills_obligations %}
                                                <li class="py-1">{{ ontology_label(obl, entity_lookup) }}</li>
                                                {% endfor %}
                                            </ul>
                                            {% else %}
                                            <span class="text-muted small">None</span>
                                            {% endif %}
                                        </div>
                                        <!-- Violates Section -->
                                        <div class="p-2 rounded" style="background-color: rgba(220, 53, 69, 0.08);">
                                            <small class="text-danger fw-bold d-block mb-1">Violates</small>
                                            {% if cl.violates_obligations %}
                                            <ul class="list-unstyled small mb-0">
                                                {% for obl in cl.violates_obligations %}
                                                <li class="py-1">{{ ontology_label(obl, entity_lookup) }}</li>
                                                {% endfor %}
                                            </ul>
                                            {% else %}
                                            <span class="text-muted small">None</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No causal-normative links found.</p>
                        {% endif %}
                    </div>

                    <!-- Question Emergence Section -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-question-circle text-info me-2"></i>
                            Question Emergence
                            <span class="badge bg-info ms-2">{{ rich_analysis.question_emergence|length }}</span>
                        </h6>
                        {% if rich_analysis.question_emergence %}
                        <div class="accordion" id="questionEmergenceAccordion">
                            {% for qe in rich_analysis.question_emergence %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#qe-{{ loop.index }}">
                                        <span class="me-2">{{ qe.question_text }}</span>
                                        <span class="badge bg-secondary ms-auto me-2">{{ (qe.data_events|length) + (qe.data_actions|length) }} triggers</span>
                                        <span class="badge bg-warning text-dark">{{ qe.competing_warrants|length }} competing warrants</span>
                                    </button>
                                </h2>
                                <div id="qe-{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#questionEmergenceAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <h6 class="small fw-bold">Triggering Events</h6>
                                                {% if qe.data_events %}
                                                <ul class="small mb-0">
                                                    {% for evt in qe.data_events %}
                                                    <li>{{ ontology_label(evt, entity_lookup) }}</li>
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                <span class="text-muted small">None</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4">
                                                <h6 class="small fw-bold">Triggering Actions</h6>
                                                {% if qe.data_actions %}
                                                <ul class="small mb-0">
                                                    {% for act in qe.data_actions %}
                                                    <li>{{ ontology_label(act, entity_lookup) }}</li>
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                <span class="text-muted small">None</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-4">
                                                <h6 class="small fw-bold">Competing Warrants</h6>
                                                {% if qe.competing_warrants %}
                                                <ul class="small mb-0 list-unstyled">
                                                    {% for cw_pair in qe.competing_warrants %}
                                                    <li class="mb-2 p-2 rounded" style="background-color: rgba(255, 193, 7, 0.1);">
                                                        {% if cw_pair is iterable and cw_pair is not string %}
                                                        <span class="d-flex align-items-center flex-wrap gap-1">
                                                            {{ ontology_label(cw_pair[0], entity_lookup) }}
                                                            <i class="bi bi-arrow-left-right text-warning mx-1"></i>
                                                            {{ ontology_label(cw_pair[1], entity_lookup) if cw_pair|length > 1 else '' }}
                                                        </span>
                                                        {% else %}
                                                        {{ ontology_label(cw_pair, entity_lookup) }}
                                                        {% endif %}
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                <span class="text-muted small">None</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No question emergence data found.</p>
                        {% endif %}
                    </div>

                    <!-- Resolution Patterns Section -->
                    <div class="mb-4">
                        <h6 class="border-bottom pb-2 mb-3">
                            <i class="bi bi-check-circle text-success me-2"></i>
                            Resolution Patterns
                            <span class="badge bg-success ms-2">{{ rich_analysis.resolution_patterns|length }}</span>
                        </h6>
                        {% if rich_analysis.resolution_patterns %}
                        <div class="accordion" id="resolutionPatternsAccordion">
                            {% for rp in rich_analysis.resolution_patterns %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#rp-{{ loop.index }}">
                                        <span class="me-2">{{ rp.conclusion_text }}</span>
                                        <span class="badge bg-primary ms-auto me-2">{{ rp.determinative_principles|length }} principles</span>
                                        <span class="badge bg-dark">{{ rp.determinative_facts|length }} facts</span>
                                    </button>
                                </h2>
                                <div id="rp-{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#resolutionPatternsAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="small fw-bold text-primary">Determinative Principles</h6>
                                                {% if rp.determinative_principles %}
                                                <ul class="small mb-0">
                                                    {% for princ in rp.determinative_principles %}
                                                    <li>{{ ontology_label(princ, entity_lookup) }}</li>
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                <span class="text-muted small">None identified</span>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <h6 class="small fw-bold">Determinative Facts</h6>
                                                {% if rp.determinative_facts %}
                                                <ul class="small mb-0">
                                                    {% for fact in rp.determinative_facts %}
                                                    <li>{{ ontology_label(fact, entity_lookup) }}</li>
                                                    {% endfor %}
                                                </ul>
                                                {% else %}
                                                <span class="text-muted small">None identified</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% if rp.reasoning_chain %}
                                        <div class="mt-3">
                                            <h6 class="small fw-bold">Reasoning Chain</h6>
                                            <p class="small text-muted mb-0">{{ rp.reasoning_chain }}</p>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No resolution patterns found.</p>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i> No rich analysis found.
                        <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#rich_analysisSection">Run Rich Analysis</a> on the Step 4 page first.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Decision Points Tab -->
        <div class="tab-pane fade" id="decisionpoints" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-signpost-split"></i> Decision Points</h5>
                    <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#phase3-card" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> View Extraction
                    </a>
                </div>
                <div class="card-body">
                    {% if decision_points and decision_points|length > 0 %}
                    <div class="list-group">
                        {% for dp in decision_points %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <span class="badge bg-primary me-2">{{ dp.focus_id or 'DP' ~ loop.index }}</span>
                                        <strong>{{ dp.description or dp.entity_label }}</strong>
                                        {% if dp.source == 'llm_fallback' %}
                                        <span class="badge bg-warning text-dark ms-2" title="Generated by LLM fallback">LLM</span>
                                        {% endif %}
                                    </div>
                                    <p class="mb-2 text-muted">{{ dp.decision_question or dp.entity_definition }}</p>
                                    {% if dp.obligations_in_tension %}
                                    <div class="mb-2">
                                        <small class="text-secondary"><strong>Obligations in tension:</strong></small>
                                        <div class="mt-1">
                                            {% for obl in dp.obligations_in_tension %}
                                            <span class="badge bg-light text-dark border me-1">{{ obl }}</span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                    {% if dp.options %}
                                    <div>
                                        <small class="text-secondary"><strong>Options:</strong></small>
                                        <ol class="mb-0 ps-3 mt-1 small">
                                            {% for opt in dp.options %}
                                            <li>{{ opt.label if opt.label else opt }}</li>
                                            {% endfor %}
                                        </ol>
                                    </div>
                                    {% endif %}
                                </div>
                                {% if dp.qc_alignment_score %}
                                <div class="text-end ms-3">
                                    <span class="badge {{ 'bg-success' if dp.qc_alignment_score > 0.5 else 'bg-secondary' }}">
                                        {{ (dp.qc_alignment_score * 100)|int }}% aligned
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i> No decision points found.
                        <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#phase3-card">Run Phase 3 synthesis</a> on the Step 4 page first.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Narrative Tab -->
        <div class="tab-pane fade" id="narrative" role="tabpanel">
            {% if narrative_data and narrative_data.has_data %}
            <!-- Summary Banner -->
            <div class="card mb-3 border-dark">
                <div class="card-body bg-dark bg-opacity-10">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-1"><i class="bi bi-book"></i> Case Narrative</h5>
                            <p class="text-muted mb-0 small">Phase 4 narrative construction results for Case {{ case.id }}</p>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end gap-4">
                                <div class="text-center">
                                    <div class="fs-4 fw-bold text-primary">{{ narrative_data.characters|length if narrative_data.characters else 0 }}</div>
                                    <small class="text-muted">Characters</small>
                                </div>
                                <div class="text-center">
                                    <div class="fs-4 fw-bold text-info">{{ narrative_data.events|length if narrative_data.events else 0 }}</div>
                                    <small class="text-muted">Events</small>
                                </div>
                                <div class="text-center">
                                    <div class="fs-4 fw-bold text-warning">{{ narrative_data.conflicts|length if narrative_data.conflicts else 0 }}</div>
                                    <small class="text-muted">Conflicts</small>
                                </div>
                                <div class="text-center">
                                    <div class="fs-4 fw-bold text-success">{{ narrative_data.initial_fluents|length if narrative_data.initial_fluents else 0 }}</div>
                                    <small class="text-muted">Fluents</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opening Context -->
            {% if narrative_data.opening_context %}
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-quote"></i> Opening Context</h6>
                </div>
                <div class="card-body">
                    <blockquote class="blockquote mb-0">
                        <p class="fst-italic">{{ narrative_data.opening_context }}</p>
                        {% if narrative_data.protagonist %}
                        <footer class="blockquote-footer mt-2">From the perspective of <cite>{{ narrative_data.protagonist }}</cite></footer>
                        {% endif %}
                    </blockquote>
                </div>
            </div>
            {% endif %}

            <div class="row">
                <!-- Characters -->
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-people"></i> Characters ({{ narrative_data.characters|length if narrative_data.characters else 0 }})</h6>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            {% if narrative_data.characters %}
                            {% for char in narrative_data.characters %}
                            <div class="mb-3 pb-3 border-bottom">
                                <!-- Character name and role badge -->
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <strong class="fs-6">{{ char.label if char.label else (char.name if char.name else char) }}</strong>
                                    {% set role_type = char.role_type if char.role_type else (char.role if char.role else '') %}
                                    {% if role_type %}
                                        {% if role_type == 'protagonist' %}
                                        <span class="badge bg-success">Protagonist</span>
                                        {% elif role_type == 'decision-maker' %}
                                        <span class="badge bg-primary">Decision-Maker</span>
                                        {% elif role_type == 'stakeholder' %}
                                        <span class="badge bg-info">Stakeholder</span>
                                        {% elif role_type == 'authority' %}
                                        <span class="badge bg-warning text-dark">Authority</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ role_type }}</span>
                                        {% endif %}
                                    {% endif %}
                                </div>

                                <!-- Professional position -->
                                {% set position = char.professional_position if char.professional_position else (char.description if char.description else '') %}
                                {% if position %}
                                <p class="mb-2 small text-muted fst-italic">{{ position }}</p>
                                {% endif %}

                                <!-- Ethical stance -->
                                {% if char.ethical_stance %}
                                <div class="mb-2 small">
                                    <span class="text-primary fw-bold">Ethical Stance:</span>
                                    <span>{{ char.ethical_stance }}</span>
                                </div>
                                {% endif %}

                                <!-- Motivations -->
                                {% set motivations = char.motivations if char.motivations else [] %}
                                {% if motivations %}
                                <div class="small">
                                    <span class="fw-bold">Motivations:</span>
                                    {% if motivations is iterable and motivations is not string %}
                                    <ul class="mb-0 ps-3 mt-1">
                                        {% for m in motivations %}
                                        <li class="text-muted">{{ m }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% else %}
                                    <span class="text-muted">{{ motivations }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Relationships (if any) -->
                                {% if char.relationships %}
                                <div class="small mt-2">
                                    <span class="fw-bold">Relationships:</span>
                                    <div class="d-flex flex-wrap gap-1 mt-1">
                                        {% for rel in char.relationships %}
                                        <span class="badge bg-light text-dark border">
                                            {{ rel[0] if rel is iterable else rel }}: {{ rel[1].split('#')[-1].split('/')[-1] if rel is iterable and rel|length > 1 else '' }}
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted mb-0">No characters extracted</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Ethical Tensions (Jones 1991 Moral Intensity) -->
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Ethical Tensions ({{ narrative_data.conflicts|length if narrative_data.conflicts else 0 }})</h6>
                            <a href="{{ url_for('tools.references') }}#jones-moral-intensity" class="text-dark" title="Jones (1991) Moral Intensity Model">
                                <i class="bi bi-info-circle"></i>
                            </a>
                        </div>
                        <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                            {% if narrative_data.conflicts %}
                            {% for tension in narrative_data.conflicts %}
                            <div class="mb-3 pb-3 border-bottom">
                                <!-- Tension description -->
                                <div class="mb-2">
                                    <strong>{{ tension.description if tension.description else 'Ethical tension' }}</strong>
                                    {% if tension.llm_enhanced %}
                                    <span class="badge bg-info ms-1" style="font-size: 0.65em;">LLM</span>
                                    {% endif %}
                                </div>

                                <!-- Entities in tension -->
                                <div class="d-flex align-items-center gap-2 mb-2 small">
                                    <span class="badge bg-primary">{{ tension.entity1_label if tension.entity1_label else '?' }}</span>
                                    <i class="bi bi-arrow-left-right text-warning"></i>
                                    <span class="badge bg-danger">{{ tension.entity2_label if tension.entity2_label else '?' }}</span>
                                </div>

                                <!-- Tension type -->
                                {% set ttype = tension.conflict_type if tension.conflict_type else '' %}
                                {% if ttype %}
                                <div class="small text-muted mb-2">
                                    <i class="bi bi-tag"></i>
                                    {% if ttype == 'obligation_vs_obligation' %}
                                    Obligation vs Obligation
                                    {% elif ttype == 'obligation_vs_constraint' %}
                                    Obligation vs Constraint
                                    {% else %}
                                    {{ ttype.replace('_', ' ').title() }}
                                    {% endif %}
                                </div>
                                {% endif %}

                                <!-- Affected roles -->
                                {% set roles = tension.affected_role_labels if tension.affected_role_labels else [] %}
                                {% if roles %}
                                <div class="small mb-2">
                                    <span class="text-muted">Affects:</span>
                                    {% for role in roles %}
                                    <span class="badge bg-secondary bg-opacity-50 text-dark">{{ role }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}

                                <!-- Moral Intensity Factors (Jones 1991) -->
                                {% if tension.magnitude_of_consequences or tension.probability_of_effect or tension.temporal_immediacy %}
                                <div class="small mt-2 p-2 bg-light rounded">
                                    <div class="text-muted mb-1" style="font-size: 0.8em;">Moral Intensity (Jones 1991):</div>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if tension.magnitude_of_consequences %}
                                        <span class="badge {{ 'bg-danger' if tension.magnitude_of_consequences == 'high' else ('bg-warning text-dark' if tension.magnitude_of_consequences == 'medium' else 'bg-secondary') }}" title="Magnitude of Consequences">
                                            Magnitude: {{ tension.magnitude_of_consequences }}
                                        </span>
                                        {% endif %}
                                        {% if tension.probability_of_effect %}
                                        <span class="badge {{ 'bg-danger' if tension.probability_of_effect == 'high' else ('bg-warning text-dark' if tension.probability_of_effect == 'medium' else 'bg-secondary') }}" title="Probability of Effect">
                                            Probability: {{ tension.probability_of_effect }}
                                        </span>
                                        {% endif %}
                                        {% if tension.temporal_immediacy %}
                                        <span class="badge {{ 'bg-danger' if tension.temporal_immediacy == 'immediate' else ('bg-warning text-dark' if tension.temporal_immediacy == 'near-term' else 'bg-secondary') }}" title="Temporal Immediacy">
                                            {{ tension.temporal_immediacy }}
                                        </span>
                                        {% endif %}
                                        {% if tension.proximity %}
                                        <span class="badge bg-info" title="Proximity to affected parties">
                                            {{ tension.proximity }}
                                        </span>
                                        {% endif %}
                                        {% if tension.concentration_of_effect %}
                                        <span class="badge bg-secondary" title="Concentration of Effect">
                                            {{ tension.concentration_of_effect }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <p class="text-muted mb-0">No ethical tensions extracted. Run Phase 4 to identify tensions.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Initial Fluents (Event Calculus State) -->
            {% if narrative_data.initial_fluents %}
            <div class="card mb-3">
                <div class="card-header bg-success bg-opacity-10">
                    <h6 class="mb-0"><i class="bi bi-toggles text-success"></i> Initial Fluents ({{ narrative_data.initial_fluents|length }})</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">State conditions at case start (Event Calculus)</p>
                    <div class="d-flex flex-wrap gap-1">
                        {% for fluent in narrative_data.initial_fluents %}
                        {% set raw_name = fluent.name if fluent.name else (fluent.fluent_name if fluent.fluent_name else (fluent|string)) %}
                        {% set fname = raw_name.split('#')[-1].split('/')[-1] if '#' in (raw_name|string) or '/' in (raw_name|string) else raw_name %}
                        {% set fname = fname.replace('_', ' ').replace('HoldsAt', '').replace('holdsAt', '') %}
                        {% set fval = fluent.value if fluent.value is defined else (fluent.initial_value if fluent.initial_value is defined else true) %}
                        <span class="badge {{ 'bg-success' if fval == true or fval == 'true' else ('bg-danger' if fval == false or fval == 'false' else 'bg-info') }} text-white" style="font-size: 0.75em;" title="{{ raw_name }}">
                            {{ fname[:40] }}{% if fname|length > 40 %}...{% endif %}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Event Timeline -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-clock-history"></i> Event Timeline ({{ narrative_data.events|length if narrative_data.events else 0 }})</h6>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if narrative_data.events %}
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th>Event</th>
                                <th style="width: 100px;">Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in narrative_data.events %}
                            <tr>
                                <td class="text-muted">{{ loop.index }}</td>
                                <td>{{ event.description if event.description else (event.label if event.label else event) }}</td>
                                <td>
                                    {% set etype = event.event_type if event.event_type else (event.type if event.type else '') %}
                                    {% if etype %}
                                    <span class="badge {{ 'bg-primary' if etype == 'action' else ('bg-secondary' if etype == 'automatic' else 'bg-light text-dark') }}">{{ etype }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% elif narrative_data.event_trace %}
                    <pre class="small mb-0" style="white-space: pre-wrap;">{{ narrative_data.event_trace[:2000] }}</pre>
                    {% else %}
                    <p class="text-muted mb-0">No timeline events extracted</p>
                    {% endif %}
                </div>
            </div>

            <!-- Decision Moments -->
            {% if narrative_data.decision_moments %}
            <div class="card mb-3">
                <div class="card-header bg-dark text-white">
                    <h6 class="mb-0"><i class="bi bi-signpost-split"></i> Decision Moments ({{ narrative_data.decision_moments|length }})</h6>
                </div>
                <div class="card-body">
                    {% for dm in narrative_data.decision_moments %}
                    <div class="mb-3 pb-3 border-bottom">
                        <strong>{{ loop.index }}. {{ dm.question if dm.question else (dm.description if dm.description else dm) }}</strong>
                        {% if dm.options %}
                        <ul class="mb-0 mt-2 small">
                            {% for opt in dm.options %}
                            <li>{{ opt.label if opt.label else opt }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Key Takeaways -->
            {% if narrative_data.key_takeaways %}
            <div class="card mb-3 border-info">
                <div class="card-header bg-info bg-opacity-10">
                    <h6 class="mb-0"><i class="bi bi-lightbulb text-info"></i> Key Takeaways</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        {% for takeaway in narrative_data.key_takeaways %}
                        <li class="mb-2">{{ takeaway }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Causal Links -->
            {% if narrative_data.causal_links %}
            <div class="card mb-3">
                <div class="card-header bg-secondary bg-opacity-10">
                    <h6 class="mb-0"><i class="bi bi-arrow-right-circle text-secondary"></i> Causal Links ({{ narrative_data.causal_links|length }})</h6>
                </div>
                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                    <ul class="mb-0 small">
                        {% for link in narrative_data.causal_links %}
                        <li class="mb-2">
                            <span class="text-primary">{{ link.source_label if link.source_label else (link.cause if link.cause else '?') }}</span>
                            <i class="bi bi-arrow-right mx-2 text-muted"></i>
                            <span class="text-success">{{ link.target_label if link.target_label else (link.effect if link.effect else '?') }}</span>
                            {% set ltype = link.link_type if link.link_type else (link.type if link.type else '') %}
                            {% if ltype %}<span class="badge bg-light text-dark ms-2">{{ ltype }}</span>{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            {% else %}
            <div class="card">
                <div class="card-body">
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-1"></i> No narrative data available.
                        <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#phase4-card">Run Phase 4 (Narrative Construction)</a> on the Step 4 page first.
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

    </div>
</div>

<!-- Include D3.js for Full Entity Graph -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Include Cytoscape.js for Reasoning Flow -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Activate tab from URL hash (e.g., #provisions, #questions)
    const hash = window.location.hash;
    if (hash) {
        const tabId = hash.substring(1) + '-tab'; // e.g., 'provisions-tab'
        const tabElement = document.getElementById(tabId);
        if (tabElement) {
            const tab = new bootstrap.Tab(tabElement);
            tab.show();
        }
    }

    // Load synthesis data (provisions, questions, conclusions)
    const provisions = {{ provisions_json | tojson | safe }};
    const questions = {{ questions_json | tojson | safe }};
    const conclusions = {{ conclusions_json | tojson | safe }};

    //BUILD SYNTHESIS REASONING GRAPH (LangGraph-style)
    // Shows: Provisions → Questions → Conclusions + Entity mentions
    const elements = [];
    const nodeIds = new Set();
    const edgeIds = new Set();  // Track edges to prevent duplicates

    // Add Provision nodes
    provisions.forEach(function(prov) {
        const nodeId = 'prov_' + prov.id;
        const provCode = prov.rdf_json_ld?.codeProvision || prov.entity_label;

        nodeIds.add(nodeId);
        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: provCode,
                type: 'provision',
                fullText: prov.entity_definition,
                nodeType: 'NSPE Provision'
            }
        });

        // Add edges from provisions to mentioned entities
        if (prov.rdf_json_ld && prov.rdf_json_ld.appliesTo) {
            prov.rdf_json_ld.appliesTo.forEach(function(entity) {
                const entityId = 'entity_' + entity.entity_label.replace(/\s+/g, '_');

                // Add entity node if not exists
                if (!nodeIds.has(entityId)) {
                    nodeIds.add(entityId);
                    elements.push({
                        group: 'nodes',
                        data: {
                            id: entityId,
                            label: entity.entity_label,
                            type: entity.entity_type,
                            reasoning: entity.reasoning,
                            nodeType: 'Entity'
                        }
                    });
                }

                // Add edge: provision → entity (with deduplication)
                const edgeId = nodeId + '_' + entityId;
                if (!edgeIds.has(edgeId) && nodeId !== entityId) {
                    edgeIds.add(edgeId);
                    elements.push({
                        group: 'edges',
                        data: {
                            id: edgeId,
                            source: nodeId,
                            target: entityId,
                            label: 'applies to',
                            edgeType: 'provision_to_entity'
                        }
                    });
                }
            });
        }
    });

    // Add Question nodes
    questions.forEach(function(q) {
        const nodeId = 'q_' + q.id;
        nodeIds.add(nodeId);

        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: q.entity_label,
                type: 'question',
                fullText: q.entity_definition,
                nodeType: 'Question'
            }
        });

        // Link questions to related provisions (with deduplication)
        if (q.rdf_json_ld && q.rdf_json_ld.relatedProvisions) {
            q.rdf_json_ld.relatedProvisions.forEach(function(provCode) {
                // Find provision node
                const provNode = provisions.find(p =>
                    p.rdf_json_ld?.codeProvision === provCode ||
                    p.entity_label.includes(provCode)
                );
                if (provNode) {
                    const provId = 'prov_' + provNode.id;
                    const edgeId = provId + '_' + nodeId;
                    // Only add if not duplicate and nodes exist
                    if (!edgeIds.has(edgeId) && nodeIds.has(provId) && provId !== nodeId) {
                        edgeIds.add(edgeId);
                        elements.push({
                            group: 'edges',
                            data: {
                                id: edgeId,
                                source: provId,
                                target: nodeId,
                                label: 'informs',
                                edgeType: 'provision_to_question'
                            }
                        });
                    }
                }
            });
        }
    });

    // Add Conclusion nodes
    conclusions.forEach(function(c) {
        const nodeId = 'c_' + c.id;
        nodeIds.add(nodeId);

        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: c.entity_label,
                type: 'conclusion',
                fullText: c.entity_definition,
                nodeType: 'Conclusion'
            }
        });

        // Link conclusions to questions they answer (with deduplication)
        if (c.rdf_json_ld && c.rdf_json_ld.answersQuestions) {
            c.rdf_json_ld.answersQuestions.forEach(function(qNum) {
                const qNode = questions.find(q => q.entity_label.includes(qNum) || q.entity_label.includes('Question_' + qNum));
                if (qNode) {
                    const qId = 'q_' + qNode.id;
                    const edgeId = qId + '_' + nodeId;
                    // Only add if not duplicate and nodes exist
                    if (!edgeIds.has(edgeId) && nodeIds.has(qId) && qId !== nodeId) {
                        edgeIds.add(edgeId);
                        elements.push({
                            group: 'edges',
                            data: {
                                id: edgeId,
                                source: qId,
                                target: nodeId,
                                label: 'answered by',
                                edgeType: 'question_to_conclusion'
                            }
                        });
                    }
                }
            });
        }
    });

    // Filter out any invalid edges before initialization
    const validElements = elements.filter(el => {
        if (el.group === 'edges') {
            const source = el.data.source;
            const target = el.data.target;
            // Remove edges where source equals target or endpoints don't exist
            if (source === target) return false;
            if (!nodeIds.has(source) || !nodeIds.has(target)) return false;
        }
        return true;
    });

    // Initialize Cytoscape with HIERARCHICAL layout (LangGraph-style)
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: validElements,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': function(ele) {
                        const type = ele.data('type');
                        const colors = {
                            'provision': '#6C757D',  // Gray - Code provisions
                            'question': '#FFC107',   // Yellow - Questions
                            'conclusion': '#28A745', // Green - Conclusions
                            'action': '#343A40',     // Dark - Actions
                            'event': '#6C757D'       // Gray - Events
                        };
                        return colors[type] || '#17A2B8'; // Cyan for entities
                    },
                    'label': function(ele) {
                        // Truncate labels to fit in nodes
                        const label = ele.data('label') || '';
                        const type = ele.data('type');
                        const maxLen = (type === 'provision') ? 8 : 12;
                        return label.length > maxLen ? label.substring(0, maxLen) + '...' : label;
                    },
                    'color': function(ele) {
                        // Dark text for light backgrounds (yellow, green)
                        const type = ele.data('type');
                        if (type === 'question' || type === 'conclusion') return '#333';
                        return '#fff';
                    },
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '10px',
                    'font-weight': 'bold',
                    'width': function(ele) {
                        // Larger nodes for Q/C/Provisions
                        const type = ele.data('type');
                        return (type === 'provision' || type === 'question' || type === 'conclusion') ? '80px' : '55px';
                    },
                    'height': function(ele) {
                        const type = ele.data('type');
                        return (type === 'provision' || type === 'question' || type === 'conclusion') ? '80px' : '55px';
                    },
                    'text-wrap': 'wrap',
                    'text-max-width': '70px',
                    'shape': function(ele) {
                        const type = ele.data('type');
                        if (type === 'provision') return 'rectangle';
                        if (type === 'question') return 'diamond';
                        if (type === 'conclusion') return 'round-rectangle';
                        return 'ellipse';
                    },
                    'border-width': 2,
                    'border-color': function(ele) {
                        const type = ele.data('type');
                        if (type === 'question' || type === 'conclusion') return '#333';
                        return '#fff';
                    }
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 3,
                    'line-color': function(ele) {
                        const edgeType = ele.data('edgeType');
                        if (edgeType === 'provision_to_question') return '#6C757D';
                        if (edgeType === 'question_to_conclusion') return '#FFC107';
                        if (edgeType === 'provision_to_entity') return '#17A2B8';
                        return '#ccc';
                    },
                    'target-arrow-color': function(ele) {
                        const edgeType = ele.data('edgeType');
                        if (edgeType === 'provision_to_question') return '#6C757D';
                        if (edgeType === 'question_to_conclusion') return '#FFC107';
                        if (edgeType === 'provision_to_entity') return '#17A2B8';
                        return '#ccc';
                    },
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'straight',  // Straight lines avoid bezier control point errors
                    'label': 'data(label)',
                    'font-size': '9px',
                    'text-rotation': 'autorotate',
                    'edge-distances': 'node-position',  // Better edge routing
                    'text-background-color': '#fff',
                    'text-background-opacity': 0.8,
                    'text-background-padding': '2px'
                }
            }
        ],
        layout: {
            name: 'cose',  // Force-directed layout handles DAGs (provisions connect to multiple questions)
            idealEdgeLength: 150,
            nodeOverlap: 50,
            refresh: 20,
            fit: true,
            padding: 40,
            randomize: false,
            componentSpacing: 100,
            nodeRepulsion: 8000,
            edgeElasticity: 100,
            nestingFactor: 5,
            gravity: 80,
            numIter: 1000,
            initialTemp: 200,
            coolingFactor: 0.95,
            minTemp: 1.0,
            avoidOverlap: true,
            nodeDimensionsIncludeLabels: true,
            animate: true,
            animationDuration: 500
        }
    });

    // Graph controls
    document.getElementById('fit-graph').addEventListener('click', function() {
        cy.fit();
    });

    document.getElementById('reset-graph').addEventListener('click', function() {
        cy.layout({
            name: 'cose',
            idealEdgeLength: 120,
            nodeOverlap: 40,
            avoidOverlap: true,
            nodeDimensionsIncludeLabels: true,
            fit: true
        }).run();
    });

    document.getElementById('show-labels').addEventListener('change', function(e) {
        if (e.target.checked) {
            cy.style().selector('node').style('label', function(ele) {
                const label = ele.data('label') || '';
                const type = ele.data('type');
                const maxLen = (type === 'provision') ? 8 : 12;
                return label.length > maxLen ? label.substring(0, maxLen) + '...' : label;
            }).update();
        } else {
            cy.style().selector('node').style('label', '').update();
        }
    });

    // Node click handler - show details panel
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        const data = node.data();

        // Get node type colors
        const typeColors = {
            'provision': '#6C757D',
            'question': '#FFC107',
            'conclusion': '#28A745',
            'action': '#343A40',
            'event': '#6C757D'
        };

        // Populate details panel
        const panel = document.getElementById('cy-details-panel');
        const labelEl = document.getElementById('cy-detail-label');
        const typeEl = document.getElementById('cy-detail-type');
        const textEl = document.getElementById('cy-detail-text');
        const edgesEl = document.getElementById('cy-detail-edges');

        labelEl.textContent = data.label;
        labelEl.style.borderColor = typeColors[data.type] || '#17A2B8';

        typeEl.textContent = data.nodeType || data.type;
        typeEl.style.backgroundColor = typeColors[data.type] || '#17A2B8';
        typeEl.style.color = (data.type === 'question' || data.type === 'conclusion') ? '#333' : '#fff';

        // Show full text (definition)
        const fullText = data.fullText || data.definition || data.reasoning || '';
        textEl.textContent = fullText || 'No details available';

        // Show connected edges
        const connectedEdges = node.connectedEdges();
        edgesEl.innerHTML = '';
        if (connectedEdges.length === 0) {
            edgesEl.innerHTML = '<li class="text-muted">None</li>';
        } else {
            connectedEdges.forEach(edge => {
                const isSource = edge.source().id() === node.id();
                const otherNode = isSource ? edge.target() : edge.source();
                const arrow = isSource ? '→' : '←';
                const li = document.createElement('li');
                li.innerHTML = `<span style="color:${typeColors[otherNode.data('type')] || '#17A2B8'}">${arrow}</span> ${otherNode.data('label')} <small class="text-muted">(${edge.data('label') || 'related'})</small>`;
                edgesEl.appendChild(li);
            });
        }

        panel.style.display = 'block';
    });

    // Close details panel
    document.getElementById('cy-close-details').addEventListener('click', function() {
        document.getElementById('cy-details-panel').style.display = 'none';
    });

    // Click on background to close panel
    cy.on('tap', function(evt) {
        if (evt.target === cy) {
            document.getElementById('cy-details-panel').style.display = 'none';
        }
    });

    // Q&C View Toggle
    document.getElementById('linkedView').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('linkedViewContent').style.display = 'block';
            document.getElementById('splitViewContent').style.display = 'none';
        }
    });

    document.getElementById('splitView').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('linkedViewContent').style.display = 'none';
            document.getElementById('splitViewContent').style.display = 'block';
        }
    });

});

const currentCaseId = {{ case.id }};

// Helper function to get CSRF token
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// ============================================================================
// D3.js Full Entity Graph with Layout Options
// ============================================================================
(function() {
    const caseId = {{ case.id }};
    const svg = d3.select('#d3-graph-svg');

    let graphData = null;
    let simulation = null;
    let currentFilter = 'all';
    let searchTerm = '';
    let showTypeHubs = true;  // Default to true for meaningful connections
    let hideUnconnected = true;  // Default to hide unconnected
    let currentLayout = 'force';
    let zoom = null;
    let g = null;

    // DOM element getters (ensures they exist when accessed)
    function getContainer() { return document.getElementById('d3-graph-container'); }
    function getGraphCard() { return document.getElementById('d3-graph-card'); }
    function getLoadingOverlay() { return document.getElementById('d3-loading-overlay'); }

    function showLoading(text) {
        const textEl = document.getElementById('d3-loading-text');
        const overlay = getLoadingOverlay();
        if (textEl) textEl.textContent = text || 'Building graph...';
        if (overlay) {
            overlay.classList.remove('d-none');
            overlay.classList.add('d-flex');
        }
    }

    function hideLoading() {
        const overlay = getLoadingOverlay();
        if (overlay) {
            overlay.classList.remove('d-flex');
            overlay.classList.add('d-none');
        }
    }

    function loadGraph() {
        showLoading('Loading entity data...');
        const url = `/scenario_pipeline/case/${caseId}/entity_graph` + (showTypeHubs ? '?type_hubs=true' : '');
        fetch(url)
            .then(response => response.json())
            .then(data => {
                try {
                    if (data.success) {
                        graphData = data;
                        renderD3Graph(data);
                        updateD3Stats(data.metadata);
                        buildD3Legend(data.metadata.type_colors);
                    } else {
                        console.error('Failed to load graph:', data.error);
                        document.getElementById('d3-node-count').textContent = 'Error loading';
                    }
                } catch (e) {
                    console.error('Error rendering graph:', e);
                }
                hideLoading();
            })
            .catch(error => {
                console.error('Error fetching graph:', error);
                document.getElementById('d3-node-count').textContent = 'Error';
                hideLoading();
            });
    }

    function renderD3Graph(data) {
        const container = getContainer();
        const width = container.clientWidth;
        const height = container.clientHeight || 600;

        svg.selectAll('*').remove();

        // Define arrow markers for edges
        svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '-0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('orient', 'auto')
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .append('path')
            .attr('d', 'M 0,-5 L 10,0 L 0,5')
            .attr('fill', '#666');

        // Create zoom behavior
        zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => g.attr('transform', event.transform));

        svg.call(zoom);
        g = svg.append('g');

        // Filter nodes by pass and search
        let filteredNodes = filterD3Nodes(data.nodes);

        // Build edge set for connectivity check
        let filteredNodeIds = new Set(filteredNodes.map(n => n.id));
        let filteredEdges = data.edges.filter(e =>
            filteredNodeIds.has(e.source) && filteredNodeIds.has(e.target) ||
            filteredNodeIds.has(e.source?.id) && filteredNodeIds.has(e.target?.id)
        );

        // If hideUnconnected is enabled, filter out nodes with no connections
        if (hideUnconnected) {
            const connectedNodeIds = new Set();
            filteredEdges.forEach(e => {
                connectedNodeIds.add(typeof e.source === 'object' ? e.source.id : e.source);
                connectedNodeIds.add(typeof e.target === 'object' ? e.target.id : e.target);
            });
            filteredNodes = filteredNodes.filter(n => connectedNodeIds.has(n.id));
            filteredNodeIds = new Set(filteredNodes.map(n => n.id));
            // Re-filter edges with new node set
            filteredEdges = data.edges.filter(e =>
                filteredNodeIds.has(e.source) && filteredNodeIds.has(e.target) ||
                filteredNodeIds.has(e.source?.id) && filteredNodeIds.has(e.target?.id)
            );
        }

        // Deep copy nodes to avoid mutation issues with D3
        const nodesCopy = filteredNodes.map(n => ({...n}));
        const edgesCopy = filteredEdges.map(e => ({...e}));

        // Apply layout
        applyLayout(nodesCopy, edgesCopy, width, height);

        // Create edges with arrows
        const link = g.append('g')
            .attr('class', 'links')
            .selectAll('line')
            .data(edgesCopy)
            .enter().append('line')
            .attr('stroke', d => d.type === 'instance_of' ? '#ccc' : '#666')
            .attr('stroke-opacity', d => d.type === 'instance_of' ? 0.3 : 0.7)
            .attr('stroke-width', d => d.type === 'instance_of' ? 1 : 2)
            .attr('marker-end', d => d.type !== 'instance_of' ? 'url(#arrowhead)' : null);

        // Create edge labels (only for non-instance_of edges in force layout)
        const edgeLabels = g.append('g')
            .attr('class', 'edge-labels')
            .selectAll('text')
            .data(edgesCopy.filter(e => e.type !== 'instance_of'))
            .enter().append('text')
            .attr('font-size', '8px')
            .attr('fill', '#666')
            .attr('text-anchor', 'middle')
            .text(d => d.type.replace(/_/g, ' '));

        // Create nodes
        const node = g.append('g')
            .attr('class', 'nodes')
            .selectAll('g')
            .data(nodesCopy)
            .enter().append('g')
            .style('cursor', 'pointer')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended))
            .on('click', showD3Details)
            .on('mouseover', function(event, d) {
                d3.select(this).select('circle').attr('stroke-width', 3).attr('stroke', '#333');
                // Highlight connected edges
                link.attr('stroke-opacity', e => (e.source.id === d.id || e.target.id === d.id) ? 1 : 0.2);
            })
            .on('mouseout', function() {
                d3.select(this).select('circle').attr('stroke-width', 2).attr('stroke', '#fff');
                link.attr('stroke-opacity', d => d.type === 'instance_of' ? 0.3 : 0.7);
            });

        node.append('circle')
            .attr('r', d => d.is_hub ? 18 : getD3NodeSize(d))
            .attr('fill', d => d.color)
            .attr('stroke', '#fff')
            .attr('stroke-width', 2);

        node.append('text')
            .attr('dy', d => (d.is_hub ? 18 : getD3NodeSize(d)) + 12)
            .attr('text-anchor', 'middle')
            .attr('font-size', d => d.is_hub ? '10px' : '9px')
            .attr('font-weight', d => d.is_hub ? 'bold' : 'normal')
            .attr('fill', '#333')
            .text(d => truncateD3Label(d.label, d.is_hub ? 20 : 12));

        // For force layout, use simulation; for static layouts, position immediately
        if (currentLayout === 'force') {
            simulation.on('tick', () => {
                link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                node.attr('transform', d => `translate(${d.x},${d.y})`);
                edgeLabels
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);
            });
        } else {
            // Static layout - position immediately
            link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
            node.attr('transform', d => `translate(${d.x},${d.y})`);
            edgeLabels
                .attr('x', d => (d.source.x + d.target.x) / 2)
                .attr('y', d => (d.source.y + d.target.y) / 2);
        }

        // Update stats
        const hubCount = nodesCopy.filter(n => n.is_hub).length;
        const entityCount = nodesCopy.length - hubCount;
        const totalEntities = data.nodes.filter(n => !n.is_hub).length;
        const hiddenCount = totalEntities - entityCount;

        let statsText = `Showing ${entityCount} of ${totalEntities} entities`;
        if (hubCount > 0) {
            statsText += ` (+ ${hubCount} type hubs)`;
        }
        if (hiddenCount > 0) {
            statsText += ` - ${hiddenCount} unconnected hidden`;
        }
        document.getElementById('d3-node-count').textContent = statsText;

        // Update tab badge to show visible entity count
        const tabBadge = document.getElementById('entities-tab-badge');
        if (tabBadge) {
            tabBadge.textContent = entityCount;
        }
    }

    // Layout functions
    function applyLayout(nodes, edges, width, height) {
        if (currentLayout === 'force') {
            // Create simulation with tighter clustering but spaced individual nodes
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(edges).id(d => d.id).distance(d => d.type === 'instance_of' ? 35 : 60).strength(1.5))
                .force('charge', d3.forceManyBody().strength(d => d.is_hub ? -250 : -120))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.is_hub ? 45 : 30))
                // Pull clusters toward center
                .force('x', d3.forceX(width / 2).strength(0.08))
                .force('y', d3.forceY(height / 2).strength(0.08));
        } else if (currentLayout === 'circular') {
            // Arrange nodes in a circle, grouped by type
            const typeGroups = {};
            nodes.forEach(n => {
                if (!typeGroups[n.type]) typeGroups[n.type] = [];
                typeGroups[n.type].push(n);
            });
            let angleOffset = 0;
            const radius = Math.min(width, height) / 2.5;
            Object.values(typeGroups).forEach(group => {
                const angleStep = (2 * Math.PI) / nodes.length;
                group.forEach((n, i) => {
                    const angle = angleOffset + i * angleStep;
                    n.x = width / 2 + radius * Math.cos(angle);
                    n.y = height / 2 + radius * Math.sin(angle);
                });
                angleOffset += group.length * angleStep;
            });
            // Resolve edge references
            resolveEdgeReferences(nodes, edges);
        } else if (currentLayout === 'grid') {
            // Arrange in grid, hubs on top
            const hubs = nodes.filter(n => n.is_hub);
            const others = nodes.filter(n => !n.is_hub);
            const cols = Math.ceil(Math.sqrt(others.length));
            const cellWidth = width / (cols + 1);
            const cellHeight = (height - 100) / (Math.ceil(others.length / cols) + 1);

            // Place hubs at top
            hubs.forEach((n, i) => {
                n.x = (i + 1) * (width / (hubs.length + 1));
                n.y = 40;
            });

            // Place others in grid below
            others.forEach((n, i) => {
                const row = Math.floor(i / cols);
                const col = i % cols;
                n.x = (col + 1) * cellWidth;
                n.y = 100 + (row + 1) * cellHeight;
            });
            resolveEdgeReferences(nodes, edges);
        } else if (currentLayout === 'radial') {
            // Radial layout with hubs at center
            const hubs = nodes.filter(n => n.is_hub);
            const others = nodes.filter(n => !n.is_hub);
            const centerX = width / 2;
            const centerY = height / 2;

            // Place hubs in inner ring
            const innerRadius = 60;
            hubs.forEach((n, i) => {
                const angle = (i / hubs.length) * 2 * Math.PI;
                n.x = centerX + innerRadius * Math.cos(angle);
                n.y = centerY + innerRadius * Math.sin(angle);
            });

            // Place others in outer rings by pass
            const passGroups = {1: [], 2: [], 3: [], 4: []};
            others.forEach(n => {
                if (passGroups[n.pass]) passGroups[n.pass].push(n);
                else passGroups[1].push(n);
            });

            let ringRadius = 120;
            Object.values(passGroups).forEach(group => {
                if (group.length === 0) return;
                group.forEach((n, i) => {
                    const angle = (i / group.length) * 2 * Math.PI;
                    n.x = centerX + ringRadius * Math.cos(angle);
                    n.y = centerY + ringRadius * Math.sin(angle);
                });
                ringRadius += 80;
            });
            resolveEdgeReferences(nodes, edges);
        }
    }

    function resolveEdgeReferences(nodes, edges) {
        const nodeMap = new Map(nodes.map(n => [n.id, n]));
        edges.forEach(e => {
            if (typeof e.source === 'string') e.source = nodeMap.get(e.source) || e.source;
            if (typeof e.target === 'string') e.target = nodeMap.get(e.target) || e.target;
        });
    }

    function filterD3Nodes(nodes) {
        return nodes.filter(n => {
            if (currentFilter !== 'all' && n.pass !== parseInt(currentFilter)) return false;
            if (searchTerm && !n.label.toLowerCase().includes(searchTerm.toLowerCase())) return false;
            return true;
        });
    }

    function getD3NodeSize(node) {
        const sizes = { 'roles': 10, 'principles': 8, 'obligations': 8, 'temporal_dynamics_enhanced': 8,
                       'ethical_question': 9, 'ethical_conclusion': 9, 'code_provision_reference': 8 };
        return sizes[node.type] || 7;
    }

    function truncateD3Label(label, maxLen) {
        return label.length <= maxLen ? label : label.substring(0, maxLen) + '...';
    }

    function showD3Details(event, d) {
        const panel = document.getElementById('d3-entity-details');
        document.getElementById('d3-detail-label').textContent = d.label;
        document.getElementById('d3-detail-label').style.borderColor = d.color;

        const typeBadge = document.getElementById('d3-detail-type');
        typeBadge.textContent = d.type.replace(/_/g, ' ');
        typeBadge.style.backgroundColor = d.color;

        const passNames = {1: 'Pass 1', 2: 'Pass 2', 3: 'Pass 3', 4: 'Step 4'};
        document.getElementById('d3-detail-pass').textContent = passNames[d.pass] || 'Unknown';
        document.getElementById('d3-detail-definition').textContent = d.definition || 'No definition available';

        // Show additional metadata if available
        const metadataDiv = document.getElementById('d3-detail-metadata');
        const agentDiv = document.getElementById('d3-detail-agent');
        const temporalDiv = document.getElementById('d3-detail-temporal');

        let hasMetadata = false;

        if (d.agent) {
            agentDiv.querySelector('span').textContent = d.agent;
            agentDiv.style.display = 'block';
            hasMetadata = true;
        } else {
            agentDiv.style.display = 'none';
        }

        if (d.temporal_marker) {
            temporalDiv.querySelector('span').textContent = d.temporal_marker;
            temporalDiv.style.display = 'block';
            hasMetadata = true;
        } else {
            temporalDiv.style.display = 'none';
        }

        metadataDiv.style.display = hasMetadata ? 'block' : 'none';

        const connections = graphData.edges.filter(e =>
            e.source === d.id || e.target === d.id ||
            e.source?.id === d.id || e.target?.id === d.id
        );

        const connEl = document.getElementById('d3-detail-connections');
        connEl.innerHTML = connections.length === 0 ? '<li class="text-muted">None</li>' : '';
        connections.forEach(conn => {
            const isSource = conn.source === d.id || conn.source?.id === d.id;
            const otherNode = graphData.nodes.find(n =>
                n.id === (isSource ? (conn.target?.id || conn.target) : (conn.source?.id || conn.source))
            );
            if (otherNode) {
                const li = document.createElement('li');
                li.innerHTML = `<span style="color:${otherNode.color}">${isSource ? '&#8594;' : '&#8592;'}</span> ${otherNode.label}`;
                connEl.appendChild(li);
            }
        });
        panel.style.display = 'block';
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
    }

    function updateD3Stats(metadata) {
        const pc = metadata.pass_counts;
        document.getElementById('d3-pass1').textContent = `Pass 1: ${pc[1] || 0}`;
        document.getElementById('d3-pass2').textContent = `Pass 2: ${pc[2] || 0}`;
        document.getElementById('d3-pass3').textContent = `Pass 3: ${pc[3] || 0}`;
        document.getElementById('d3-pass4').textContent = `Step 4: ${pc[4] || 0}`;
    }

    function buildD3Legend(colors) {
        const container = document.getElementById('d3-legend');
        container.innerHTML = '';
        const labels = {
            'roles': 'Roles', 'states': 'States', 'resources': 'Resources',
            'principles': 'Principles', 'obligations': 'Obligations', 'constraints': 'Constraints',
            'capabilities': 'Capabilities', 'temporal_dynamics_enhanced': 'Actions/Events',
            'code_provision_reference': 'Provisions', 'ethical_question': 'Questions', 'ethical_conclusion': 'Conclusions'
        };
        Object.entries(colors).forEach(([type, color]) => {
            if (labels[type]) {
                const span = document.createElement('span');
                span.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${color};border-radius:50%;margin-right:5px;"></span>${labels[type]}`;
                container.appendChild(span);
            }
        });
    }

    // Filter buttons
    document.querySelectorAll('.d3-filter').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.d3-filter').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.pass;
            if (graphData) renderD3Graph(graphData);
        });
    });

    // Search
    document.getElementById('d3-search').addEventListener('input', function() {
        searchTerm = this.value;
        if (graphData) renderD3Graph(graphData);
    });

    // Close details
    document.getElementById('d3-close-details').addEventListener('click', function() {
        document.getElementById('d3-entity-details').style.display = 'none';
    });

    // Type hubs toggle
    document.getElementById('d3-toggle-hubs').addEventListener('click', function() {
        showTypeHubs = !showTypeHubs;
        this.classList.toggle('active', showTypeHubs);
        this.classList.toggle('btn-info', showTypeHubs);
        this.classList.toggle('btn-outline-info', !showTypeHubs);
        loadGraph(); // Reload with/without type hubs
    });

    // Hide unconnected toggle
    document.getElementById('d3-hide-unconnected').addEventListener('change', function() {
        hideUnconnected = this.checked;
        if (graphData) renderD3Graph(graphData);
    });

    // Layout select
    document.getElementById('d3-layout-select').addEventListener('change', function() {
        currentLayout = this.value;
        if (graphData) renderD3Graph(graphData);
    });

    // Refresh button
    document.getElementById('d3-refresh').addEventListener('click', function() {
        loadGraph();
    });

    // Zoom controls
    document.getElementById('d3-zoom-in').addEventListener('click', function() {
        if (zoom) svg.transition().call(zoom.scaleBy, 1.3);
    });
    document.getElementById('d3-zoom-out').addEventListener('click', function() {
        if (zoom) svg.transition().call(zoom.scaleBy, 0.7);
    });
    document.getElementById('d3-zoom-reset').addEventListener('click', function() {
        if (zoom) svg.transition().call(zoom.transform, d3.zoomIdentity);
    });

    // Fullscreen toggle
    document.getElementById('d3-fullscreen-btn').addEventListener('click', function() {
        const card = getGraphCard();
        if (card) card.classList.add('fullscreen');
        this.style.display = 'none';
        document.getElementById('d3-exit-fullscreen-btn').style.display = 'inline-block';
        // Resize after transition
        setTimeout(() => {
            if (graphData) renderD3Graph(graphData);
        }, 100);
    });

    document.getElementById('d3-exit-fullscreen-btn').addEventListener('click', function() {
        const card = getGraphCard();
        if (card) card.classList.remove('fullscreen');
        this.style.display = 'none';
        document.getElementById('d3-fullscreen-btn').style.display = 'inline-block';
        // Resize after transition
        setTimeout(() => {
            if (graphData) renderD3Graph(graphData);
        }, 100);
    });

    // ESC key to exit fullscreen
    document.addEventListener('keydown', function(e) {
        const card = getGraphCard();
        if (e.key === 'Escape' && card && card.classList.contains('fullscreen')) {
            document.getElementById('d3-exit-fullscreen-btn').click();
        }
    });

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            const hubsBtn = document.getElementById('d3-toggle-hubs');
            if (hubsBtn) hubsBtn.classList.add('active');
            loadGraph();
        });
    } else {
        const hubsBtn = document.getElementById('d3-toggle-hubs');
        if (hubsBtn) hubsBtn.classList.add('active');
        loadGraph();
    }
})();

// ============================================================================
// DECISION POINTS (Part E)
// ============================================================================

// Load decision points when tab is shown
document.getElementById('decision-points-tab').addEventListener('shown.bs.tab', function() {
    loadDecisionPoints();
});

// Also load on page load if points exist
loadDecisionPoints();

function loadDecisionPoints() {
    const caseId = {{ case.id }};

    fetch(`/scenario_pipeline/case/${caseId}/decision_points`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.decision_points && data.decision_points.length > 0) {
                renderDecisionPoints(data.decision_points);
                updateDecisionPointCount(data.decision_points.length);
            }
        })
        .catch(err => {
            console.error('Error loading decision points:', err);
        });
}

function extractDecisionPoints() {
    const caseId = {{ case.id }};
    const btn = document.getElementById('extractDecisionPointsBtn');
    const status = document.getElementById('extractionStatus');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Extracting...';
    status.textContent = 'Analyzing case for decision points...';

    fetch(`/scenario_pipeline/case/${caseId}/extract_decision_points`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightning-charge"></i> Extract Decision Points';

        if (data.success) {
            status.textContent = `Extracted ${data.count} decision points - use Publish button at top to commit`;
            status.className = 'ms-2 text-success';
            renderDecisionPoints(data.decision_points);
            updateDecisionPointCount(data.decision_points.length);
            // Update publish button count
            const publishBtn = document.getElementById('publishAllBtn');
            if (publishBtn && !publishBtn.disabled) {
                // Refresh page to update entity counts
                setTimeout(() => location.reload(), 1500);
            }
        } else {
            status.textContent = data.error || 'Extraction failed';
            status.className = 'ms-2 text-danger';
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightning-charge"></i> Extract Decision Points';
        status.textContent = 'Error: ' + err.message;
        status.className = 'ms-2 text-danger';
        console.error('Extraction error:', err);
    });
}

// commitStep4Entities removed - use publishAllEntities() in header instead

function updateDecisionPointCount(count) {
    const badge = document.getElementById('decision-point-count');
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

function renderDecisionPoints(points) {
    const container = document.getElementById('decisionPointsContainer');

    if (!points || points.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-signpost-split" style="font-size: 3rem;"></i>
                <p class="mt-2">No decision points extracted yet.</p>
                <p><small>Click "Extract Decision Points" to analyze this case.</small></p>
            </div>
        `;
        return;
    }

    let html = '';
    points.forEach((point, index) => {
        // Build options HTML
        let optionsHtml = '';
        if (point.options && point.options.length > 0) {
            optionsHtml = '<div class="mt-3"><strong>Options:</strong><ul class="mb-0 mt-1">';
            point.options.forEach(opt => {
                const isBoardChoice = opt.is_board_choice;
                optionsHtml += `
                    <li class="${isBoardChoice ? 'fw-bold text-success' : ''}">
                        ${opt.description}
                        ${isBoardChoice ? '<span class="badge bg-success ms-1">Board Choice</span>' : ''}
                    </li>
                `;
            });
            optionsHtml += '</ul></div>';
        }

        // Build provisions badges
        let provisionsHtml = '';
        if (point.applicable_provisions && point.applicable_provisions.length > 0) {
            provisionsHtml = point.applicable_provisions.map(p =>
                `<span class="badge bg-secondary me-1">${p}</span>`
            ).join('');
        }

        // Build roles badges
        let rolesHtml = '';
        if (point.involved_roles && point.involved_roles.length > 0) {
            rolesHtml = point.involved_roles.map(r =>
                `<span class="badge bg-info me-1">${r}</span>`
            ).join('');
        }

        html += `
            <div class="card mb-4 border-primary">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="bi bi-signpost-split me-2"></i>
                        Decision Point ${point.point_number}: ${point.point_id}
                    </h6>
                    <span class="badge bg-light text-dark">${Math.round(point.confidence * 100)}% confidence</span>
                </div>
                <div class="card-body">
                    <h5>${point.description}</h5>

                    ${point.decision_question ? `
                        <div class="alert alert-light mt-3">
                            <strong>Decision Question:</strong><br>
                            <em>${point.decision_question}</em>
                        </div>
                    ` : ''}

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <small class="text-muted">Involved Roles:</small><br>
                            ${rolesHtml || '<span class="text-muted">--</span>'}
                        </div>
                        <div class="col-md-6">
                            <small class="text-muted">Applicable Provisions:</small><br>
                            ${provisionsHtml || '<span class="text-muted">--</span>'}
                        </div>
                    </div>

                    ${optionsHtml}

                    ${point.board_resolution ? `
                        <div class="alert alert-success mt-3 mb-0">
                            <strong><i class="bi bi-check-circle me-1"></i>Board Resolution:</strong>
                            <p class="mb-1 mt-1">${point.board_resolution}</p>
                            ${point.board_reasoning ? `
                                <small class="text-muted"><strong>Reasoning:</strong> ${point.board_reasoning}</small>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

// ============================================================================
// ENTITY-GROUNDED ARGUMENTS (Part F - Toulmin Structure)
// ============================================================================

// Global storage for argument data
let entityArgumentsData = null;

// Load arguments on page load (try entity-grounded first)
loadEntityArguments();

function loadEntityArguments() {
    const caseId = {{ case.id }};

    fetch(`/scenario_pipeline/case/${caseId}/entity_arguments`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.arguments && data.arguments.length > 0) {
                entityArgumentsData = data;
                renderEntityGroundedArguments(data);
                updateArgumentCount(data.arguments.length);
            }
        })
        .catch(err => {
            console.error('Error loading entity arguments:', err);
        });
}

function generateArguments() {
    const caseId = {{ case.id }};
    const btn = document.getElementById('generateArgumentsBtn');
    const status = document.getElementById('argumentsStatus');

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Running E1-F3 Pipeline...';
    status.textContent = 'Analyzing obligations, actions, and generating Toulmin arguments...';

    // Use GET to fetch entity-grounded arguments (pipeline runs on demand)
    fetch(`/scenario_pipeline/case/${caseId}/entity_arguments`)
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-chat-left-text"></i> Generate Arguments';

            if (data.success) {
                entityArgumentsData = data;
                const summary = data.pipeline_summary;
                status.innerHTML = `
                    <span class="text-success">
                        ${summary.total_arguments} arguments (${summary.pro_arguments} pro, ${summary.con_arguments} con)
                        | ${summary.valid_arguments} valid | Score: ${(summary.average_score * 100).toFixed(0)}%
                    </span>
                `;
                renderEntityGroundedArguments(data);
                updateArgumentCount(data.arguments.length);
            } else {
                status.textContent = data.error || 'Generation failed';
                status.className = 'ms-2 text-danger';
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-chat-left-text"></i> Generate Arguments';
            status.textContent = 'Error: ' + err.message;
            status.className = 'ms-2 text-danger';
            console.error('Generation error:', err);
        });
}

function updateArgumentCount(count) {
    const badge = document.getElementById('argument-count');
    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

function renderEntityGroundedArguments(data) {
    const container = document.getElementById('argumentsContainer');
    const args = data.arguments || [];
    const validations = data.validations || [];
    const decisionPoints = data.decision_points || [];
    const summary = data.pipeline_summary || {};

    if (args.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
                <p class="mt-2">No arguments generated yet.</p>
                <p><small>Click "Generate Arguments" to run the E1-F3 entity analysis pipeline.</small></p>
            </div>
        `;
        return;
    }

    // Build validation lookup by argument_id
    const validationLookup = {};
    validations.forEach(v => {
        validationLookup[v.argument_id] = v;
    });

    // Build decision point lookup
    const dpLookup = {};
    decisionPoints.forEach(dp => {
        dpLookup[dp.focus_id] = dp;
    });

    // Pipeline Summary Card
    let html = `
        <div class="card mb-4 border-info">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-graph-up me-2"></i>Entity-Grounded Argument Pipeline (E1-F3)</span>
                <span class="badge bg-light text-dark">Toulmin Structure</span>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <h4 class="text-primary mb-0">${summary.decision_points_count || 0}</h4>
                        <small class="text-muted">Decision Points</small>
                    </div>
                    <div class="col">
                        <h4 class="text-success mb-0">${summary.pro_arguments || 0}</h4>
                        <small class="text-muted">PRO Arguments</small>
                    </div>
                    <div class="col">
                        <h4 class="text-danger mb-0">${summary.con_arguments || 0}</h4>
                        <small class="text-muted">CON Arguments</small>
                    </div>
                    <div class="col">
                        <h4 class="mb-0" style="color: ${summary.valid_arguments / summary.total_arguments > 0.7 ? '#198754' : '#ffc107'}">${summary.valid_arguments || 0}/${summary.total_arguments || 0}</h4>
                        <small class="text-muted">Valid</small>
                    </div>
                    <div class="col">
                        <h4 class="mb-0">${((summary.average_score || 0) * 100).toFixed(0)}%</h4>
                        <small class="text-muted">Avg Score</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center small">
                    <div class="col">
                        <span class="badge ${data.validation_summary?.entity_test_pass_rate > 0.7 ? 'bg-success' : 'bg-warning'}">
                            Entity Refs: ${((data.validation_summary?.entity_test_pass_rate || 0) * 100).toFixed(0)}%
                        </span>
                    </div>
                    <div class="col">
                        <span class="badge ${data.validation_summary?.founding_test_pass_rate > 0.9 ? 'bg-success' : 'bg-warning'}">
                            Founding Value: ${((data.validation_summary?.founding_test_pass_rate || 0) * 100).toFixed(0)}%
                        </span>
                    </div>
                    <div class="col">
                        <span class="badge ${data.validation_summary?.virtue_test_pass_rate > 0.7 ? 'bg-success' : 'bg-warning'}">
                            Virtues: ${((data.validation_summary?.virtue_test_pass_rate || 0) * 100).toFixed(0)}%
                        </span>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Group arguments by decision point
    const byDecisionPoint = {};
    args.forEach(arg => {
        const dpId = arg.decision_point_id;
        if (!byDecisionPoint[dpId]) {
            byDecisionPoint[dpId] = { pro: [], con: [] };
        }
        if (arg.argument_type === 'pro') {
            byDecisionPoint[dpId].pro.push(arg);
        } else {
            byDecisionPoint[dpId].con.push(arg);
        }
    });

    // Render each decision point
    Object.entries(byDecisionPoint).forEach(([dpId, dpArgs]) => {
        const dp = dpLookup[dpId] || {};

        html += `
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-signpost-split me-2"></i>
                            <strong>${dpId}</strong>: ${dp.focus_description || 'Decision Point'}
                        </div>
                        ${dp.intensity_score ? `<span class="badge bg-warning text-dark">Intensity: ${(dp.intensity_score * 100).toFixed(0)}%</span>` : ''}
                    </div>
                    <small class="text-white-50">
                        Role: ${dp.role_label || 'Unknown'} |
                        ${dp.obligation_label ? `Obligation: ${dp.obligation_label}` : ''}
                        ${dp.constraint_label ? ` | Constraint: ${dp.constraint_label}` : ''}
                    </small>
                </div>
                <div class="card-body">
                    ${dp.board_conclusion ? `
                        <div class="alert alert-success mb-3 py-2">
                            <small><strong>Board Resolution:</strong> ${dp.board_conclusion}</small>
                        </div>
                    ` : ''}
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success border-bottom pb-2">
                                <i class="bi bi-hand-thumbs-up me-1"></i>PRO Arguments (${dpArgs.pro.length})
                            </h6>
                            ${dpArgs.pro.map(arg => renderToulminArgument(arg, validationLookup[arg.argument_id], 'success')).join('')}
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger border-bottom pb-2">
                                <i class="bi bi-hand-thumbs-down me-1"></i>CON Arguments (${dpArgs.con.length})
                            </h6>
                            ${dpArgs.con.map(arg => renderToulminArgument(arg, validationLookup[arg.argument_id], 'danger')).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function renderToulminArgument(arg, validation, colorClass) {
    const isValid = validation?.is_valid ?? true;
    const score = validation?.validation_score ?? 0;

    // Validation badges
    let validationBadges = '';
    if (validation) {
        const entityOk = validation.entity_validation?.is_valid;
        const foundingOk = validation.founding_value_validation?.is_compliant;
        const virtueOk = validation.virtue_validation?.is_valid;

        validationBadges = `
            <span class="badge ${entityOk ? 'bg-success' : 'bg-warning'} me-1" title="Entity References">
                <i class="bi bi-link-45deg"></i>
            </span>
            <span class="badge ${foundingOk ? 'bg-success' : 'bg-danger'} me-1" title="Founding Value">
                <i class="bi bi-shield-check"></i>
            </span>
            <span class="badge ${virtueOk ? 'bg-success' : 'bg-secondary'} me-1" title="Professional Virtues">
                <i class="bi bi-star"></i>
            </span>
        `;
    }

    // Virtue badges
    const virtueBadges = (arg.professional_virtues || []).map(v =>
        `<span class="badge bg-light text-dark border me-1">${v}</span>`
    ).join('');

    return `
        <div class="card mb-3 border-${colorClass} ${!isValid ? 'opacity-75' : ''}">
            <div class="card-header bg-${colorClass} bg-opacity-10 py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">${arg.argument_id}</span>
                    <div>
                        ${validationBadges}
                        <span class="badge ${isValid ? 'bg-success' : 'bg-secondary'}">${(score * 100).toFixed(0)}%</span>
                    </div>
                </div>
            </div>
            <div class="card-body py-2">
                <!-- CLAIM -->
                <div class="mb-2">
                    <span class="badge bg-dark me-1">CLAIM</span>
                    <span class="fw-bold">${arg.claim?.text || ''}</span>
                </div>

                <!-- WARRANT (from Obligation) -->
                <div class="mb-2">
                    <span class="badge bg-primary me-1">WARRANT</span>
                    <span>${arg.warrant?.text || ''}</span>
                    ${arg.warrant?.entity_label ? `<span class="badge bg-primary bg-opacity-25 ms-1">${arg.warrant.entity_label}</span>` : ''}
                </div>

                <!-- BACKING (from Provision) -->
                ${arg.backing?.text ? `
                <div class="mb-2">
                    <span class="badge bg-info me-1">BACKING</span>
                    <span class="small">${arg.backing.text}</span>
                    ${arg.backing?.entity_label ? `<span class="badge bg-info bg-opacity-25 ms-1">${arg.backing.entity_label}</span>` : ''}
                </div>
                ` : ''}

                <!-- DATA/GROUNDS (from Actions/Events) -->
                ${arg.data && arg.data.length > 0 ? `
                <div class="mb-2">
                    <span class="badge bg-secondary me-1">DATA</span>
                    <ul class="list-unstyled mb-0 ms-4 small">
                        ${arg.data.map(d => `<li>- ${d.text}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}

                <!-- QUALIFIER -->
                ${arg.qualifier?.text ? `
                <div class="mb-2">
                    <span class="badge bg-warning text-dark me-1">QUALIFIER</span>
                    <span class="small">${arg.qualifier.text}</span>
                </div>
                ` : ''}

                <!-- REBUTTAL -->
                ${arg.rebuttal?.text ? `
                <div class="mb-2">
                    <span class="badge bg-danger me-1">REBUTTAL</span>
                    <span class="small">${arg.rebuttal.text}</span>
                </div>
                ` : ''}

                <!-- Role & Virtues -->
                <div class="mt-2 pt-2 border-top">
                    <small class="text-muted">
                        Role: <span class="badge bg-light text-dark border">${arg.role_label || 'Unknown'}</span>
                        ${virtueBadges ? `| Virtues: ${virtueBadges}` : ''}
                    </small>
                </div>

                <!-- Founding Good Analysis -->
                ${arg.founding_good_analysis ? `
                <div class="small text-muted mt-1">
                    <i class="bi bi-lightbulb me-1"></i>${arg.founding_good_analysis}
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ============================================================================
// STEP 4 PROMPTS LOADING
// ============================================================================

let step4PromptsLoaded = false;
let step4PromptsData = null;

// Load prompts when any accordion is expanded
document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
    button.addEventListener('click', function() {
        if (!step4PromptsLoaded) {
            loadStep4Prompts();
        }
    });
});

function loadStep4Prompts() {
    if (step4PromptsLoaded) return;

    const caseId = {{ case.id }};

    fetch(`/scenario_pipeline/case/${caseId}/step4_prompts`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                step4PromptsData = data.prompts;
                step4PromptsLoaded = true;
                renderPromptContents();
            } else {
                console.error('Failed to load prompts:', data.error);
                showPromptError('Failed to load prompts');
            }
        })
        .catch(err => {
            console.error('Error loading prompts:', err);
            showPromptError('Error loading prompts: ' + err.message);
        });
}

function renderPromptContents() {
    // Helper to safely set innerHTML
    function setContent(elementId, content) {
        const el = document.getElementById(elementId);
        if (el) el.innerHTML = content;
    }

    // Provisions (4a)
    const provisionsPrompt = step4PromptsData['code_provision_reference'];
    if (provisionsPrompt) {
        setContent('provisionsPromptContent', formatPromptDisplay(provisionsPrompt, 'Code Provisions (4a)'));
    } else {
        setContent('provisionsPromptContent', '<p class="text-muted mb-0">No prompt data available. Run synthesis first.</p>');
    }

    // Questions (4b)
    const questionsPrompt = step4PromptsData['ethical_question'];
    if (questionsPrompt) {
        setContent('questionsPromptContent', formatPromptDisplay(questionsPrompt, 'Questions (4b)'));
    } else {
        setContent('questionsPromptContent', '<p class="text-muted mb-0">No prompt data available. Run synthesis first.</p>');
    }

    // Conclusions (4c)
    const conclusionsPrompt = step4PromptsData['ethical_conclusion'];
    if (conclusionsPrompt) {
        setContent('conclusionsPromptContent', formatPromptDisplay(conclusionsPrompt, 'Conclusions (4c)'));
    } else {
        setContent('conclusionsPromptContent', '<p class="text-muted mb-0">No prompt data available. Run synthesis first.</p>');
    }

    // Decision Points (4e)
    const decisionPointsPrompt = step4PromptsData['decision_point'];
    if (decisionPointsPrompt) {
        setContent('decisionPointsPromptContent', formatPromptDisplay(decisionPointsPrompt, 'Decision Points (4e)'));
    } else {
        setContent('decisionPointsPromptContent', '<p class="text-muted mb-0">No prompt data available. Extract decision points first.</p>');
    }

    // Arguments (4f)
    const argumentsPrompt = step4PromptsData['decision_argument'];
    if (argumentsPrompt) {
        setContent('argumentsPromptContent', formatPromptDisplay(argumentsPrompt, 'Arguments (4f)'));
    } else {
        setContent('argumentsPromptContent', '<p class="text-muted mb-0">No prompt data available. Generate arguments first.</p>');
    }
}

function formatPromptDisplay(promptData, title) {
    const truncatedPrompt = promptData.prompt_text.length > 2000
        ? promptData.prompt_text.substring(0, 2000) + '...'
        : promptData.prompt_text;
    const truncatedResponse = promptData.raw_response && promptData.raw_response.length > 2000
        ? promptData.raw_response.substring(0, 2000) + '...'
        : (promptData.raw_response || 'No response recorded');

    const createdAt = promptData.created_at
        ? new Date(promptData.created_at).toLocaleString()
        : 'Unknown';

    return `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>${title}</strong>
                <small class="text-muted">Model: ${promptData.llm_model || 'Unknown'} | ${createdAt}</small>
            </div>
            <div class="mb-2">
                <strong class="small">Prompt:</strong>
                <pre class="bg-white p-2 border rounded small" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(truncatedPrompt)}</pre>
            </div>
            <div>
                <strong class="small">Response:</strong>
                <pre class="bg-white p-2 border rounded small" style="max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(truncatedResponse)}</pre>
            </div>
            ${promptData.results_summary ? `
                <div class="mt-2">
                    <strong class="small">Summary:</strong>
                    <code class="small">${JSON.stringify(promptData.results_summary)}</code>
                </div>
            ` : ''}
        </div>
    `;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showPromptError(message) {
    const errorHtml = `<p class="text-danger mb-0">${message}</p>`;
    const elements = ['provisionsPromptContent', 'questionsPromptContent', 'conclusionsPromptContent', 'decisionPointsPromptContent'];
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = errorHtml;
    });
}

// ============================================================================
// PUBLISH ALL ENTITIES
// ============================================================================

function publishAllEntities() {
    const btn = document.getElementById('publishAllBtn');
    const alertDiv = document.getElementById('publishAlert');
    const message = document.getElementById('publishMessage');

    // Confirm with user
    if (!confirm('Publish all extracted entities to OntServe?\n\nThis will make entities available for querying and precedent discovery.')) {
        return;
    }

    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Publishing...';

    // Show processing message
    alertDiv.className = 'alert alert-info alert-dismissible fade show';
    alertDiv.style.display = 'block';
    message.innerHTML = '<strong>Publishing entities to OntServe...</strong> This may take a moment.';

    // Call API
    fetch('/scenario_pipeline/case/' + currentCaseId + '/publish_all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            let successMsg = `<strong>Published successfully!</strong> ${data.total_published} entities sent to OntServe.`;

            // Show entity breakdown if available
            if (data.entity_counts) {
                const counts = Object.entries(data.entity_counts)
                    .map(([type, count]) => `${count} ${type}`)
                    .join(', ');
                successMsg += `<br><small class="text-muted">${counts}</small>`;
            }

            // Show sync status
            if (data.ontserve_synced) {
                successMsg += '<br><small class="text-success">OntServe database synchronized.</small>';
            }

            // Show any warnings
            if (data.errors && data.errors.length > 0) {
                successMsg += '<br><small class="text-warning">Warnings: ' + data.errors.join(', ') + '</small>';
            }

            message.innerHTML = successMsg;

            // Update button to show published state
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Published';
            btn.className = 'btn btn-success';
            btn.disabled = true;

            // Reload page after 3 seconds to update entity counts
            setTimeout(function() {
                location.reload();
            }, 3000);
        } else {
            // Show error message
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            message.innerHTML = '<strong>Publish failed:</strong> ' + (data.error || 'Unknown error');

            // Re-enable button
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Publish to OntServe';
        }
    })
    .catch(err => {
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        message.innerHTML = '<strong>Error:</strong> ' + err.message;

        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-upload"></i> Publish to OntServe';
        console.error('Publish error:', err);
    });
}

// =============================================================================
// UNIFIED CASE SYNTHESIS FUNCTIONS - MOVED TO step4.html
// =============================================================================
// These functions were part of the Case Synthesis tab, which has been moved to step4.html
// to follow the pattern of showing LLM interactions on the extraction page, not the review page.

// =============================================================================
// ONTOLOGY LABEL POPOVERS
// =============================================================================
// Initialize Bootstrap popovers for ontology labels with rich metadata
document.addEventListener('DOMContentLoaded', function() {
    // Wait a short time for Bootstrap to be fully loaded
    setTimeout(function() {
        if (typeof bootstrap === 'undefined') {
            console.warn('Bootstrap not available for ontology label popovers');
            return;
        }

        // Helper to get pass badge class
        function getPassClass(pass) {
            switch(parseInt(pass)) {
                case 1: return 'bg-primary';
                case 2: return 'bg-success';
                case 3: return 'bg-warning text-dark';
                case 4: return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // Helper to get type badge class
        function getTypeClass(type) {
            if (!type) return 'bg-secondary';
            var t = type.toLowerCase();
            if (t.includes('role')) return 'onto-type-roles';
            if (t.includes('state')) return 'onto-type-states';
            if (t.includes('resource')) return 'onto-type-resources';
            if (t.includes('principle')) return 'onto-type-principles';
            if (t.includes('obligation')) return 'onto-type-obligations';
            if (t.includes('constraint')) return 'onto-type-constraints';
            if (t.includes('capability')) return 'onto-type-capabilities';
            if (t.includes('action') || t.includes('temporal')) return 'onto-type-actions';
            if (t.includes('event')) return 'onto-type-events';
        return 'bg-secondary';
    }

    // Initialize popovers for ontology labels
    var ontoLabels = document.querySelectorAll('.onto-label[data-bs-toggle="popover"]');
    ontoLabels.forEach(function(el) {
        var entityType = el.dataset.entityType || '';
        var entityPass = el.dataset.entityPass || '';
        var entityDef = el.dataset.entityDefinition || '';
        var entityUri = el.dataset.entityUri || '';

        var content = '<div class="onto-popover-content">';

        // Type and Pass badges
        if (entityType || entityPass) {
            content += '<div class="d-flex align-items-center gap-2 mb-2">';
            if (entityType) {
                content += '<span class="badge ' + getTypeClass(entityType) + '" style="font-size: 0.7rem;">' + entityType + '</span>';
            }
            if (entityPass) {
                content += '<span class="badge ' + getPassClass(entityPass) + '" style="font-size: 0.65rem;">Pass ' + entityPass + '</span>';
            }
            content += '</div>';
        }

        // Definition
        if (entityDef) {
            var truncatedDef = entityDef.length > 200 ? entityDef.substring(0, 200) + '...' : entityDef;
            content += '<div class="onto-definition" style="font-size: 0.85rem; color: #495057; margin-bottom: 8px;">' + truncatedDef + '</div>';
        }

        // URI
        if (entityUri) {
            content += '<div class="onto-uri" style="font-size: 0.7rem; word-break: break-all; color: #6c757d; background: #f8f9fa; padding: 4px 6px; border-radius: 3px;"><i class="bi bi-link-45deg"></i> ' + entityUri + '</div>';
        }

        // For unknown entities
        if (el.classList.contains('onto-label-unknown')) {
            content = '<div class="onto-popover-content">';
            content += '<div class="text-muted small mb-1"><i class="bi bi-question-circle"></i> Not found in case entities</div>';
            if (entityUri) {
                content += '<div class="onto-uri" style="font-size: 0.7rem; word-break: break-all; color: #6c757d; background: #f8f9fa; padding: 4px 6px; border-radius: 3px;"><i class="bi bi-link-45deg"></i> ' + entityUri + '</div>';
            }
        }

        content += '</div>';

        new bootstrap.Popover(el, {
            container: 'body',
            sanitize: false,
            content: content,
            html: true
        });
    });
    }, 100); // Small delay to ensure Bootstrap is loaded
});
</script>
{% endblock %}
