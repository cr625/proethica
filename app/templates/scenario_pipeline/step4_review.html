{% extends "base.html" %}

{% block title %}Step 4 Review - Case {{ case.id }}{% endblock %}

{% block styles %}
<style>
    .bg-purple { background-color: #6F42C1 !important; }
    .applies-to-item { font-size: 0.9rem; }
    .qc-link-card {
        border-left: 4px solid #FFC107;
        transition: all 0.2s ease;
    }
    .qc-link-card:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .qc-arrow {
        font-size: 1.5rem;
        color: #28A745;
    }
    .linked-conclusion {
        border-left: 4px solid #28A745;
        background-color: #f8fff8;
    }
    .unlinked-item {
        border-left: 4px solid #6c757d;
        opacity: 0.8;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-clipboard-check"></i> Step 4: Synthesis Review</h2>
            <p class="text-muted mb-0">Case {{ case.id }}: {{ case.title }}</p>
        </div>
        <div>
        <div>
            {% if has_synthesis_annotations %}
                <a href="{{ url_for('cases.view_case', id=case.id) }}?highlight=synthesis" class="btn btn-success me-2">
                    <i class="bi bi-eye"></i> View Case with Annotations ({{ annotation_count }})
                </a>
            {% else %}
                {% if current_user.is_authenticated %}
                <button id="generateAnnotationsBtn" class="btn btn-warning me-2" onclick="generateSynthesisAnnotations()">
                    <i class="bi bi-lightbulb"></i> Generate Synthesis Annotations
                </button>
                {% else %}
                <button class="btn btn-secondary me-2" onclick="window.location.href='{{ url_for('auth.login') }}';" title="Login required to generate annotations">
                    <i class="bi bi-lock-fill"></i> Generate Synthesis Annotations (Login Required)
                </button>
                {% endif %}
            {% endif %}
            <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Step 4
            </a>
        </div>
        </div>
    </div>

    <!-- Alert for annotation generation -->
    <div id="annotationAlert" class="alert alert-dismissible fade" role="alert" style="display: none;">
        <div id="annotationMessage"></div>
        <button type="button" class="btn-close" onclick="document.getElementById('annotationAlert').style.display='none'"></button>
    </div>

    <!-- Show existing annotations info -->
    {% if has_synthesis_annotations %}
    <div class="alert alert-info alert-dismissible fade show">
        <strong><i class="bi bi-info-circle"></i> Synthesis Annotations Available</strong>
        <p class="mb-2 mt-2">{{ annotation_count }} synthesis annotations have been generated for this case:</p>
        <ul class="mb-2">
            {% if annotation_breakdown.get('question') %}<li>{{ annotation_breakdown.get('question') }} questions</li>{% endif %}
            {% if annotation_breakdown.get('conclusion') %}<li>{{ annotation_breakdown.get('conclusion') }} conclusions</li>{% endif %}
            {% if annotation_breakdown.get('provision') %}<li>{{ annotation_breakdown.get('provision') }} provision citations</li>{% endif %}
            {% for key, value in annotation_breakdown.items() %}
                {% if key.startswith('entity_') %}
                    <li>{{ value }} {{ key.replace('entity_', '') }} mentions</li>
                {% endif %}
            {% endfor %}
        </ul>
        <p class="mb-0"><small class="text-muted">Click "View Case with Annotations" above to see them highlighted in the case text.</small></p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col">
            <div class="card text-center border-primary">
                <div class="card-body py-2">
                    <h4 class="text-primary mb-0">{{ entity_count }}</h4>
                    <small class="text-muted">Entities</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-info">
                <div class="card-body py-2">
                    <h4 class="text-info mb-0">{{ provision_count }}</h4>
                    <small class="text-muted">Provisions</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-warning">
                <div class="card-body py-2">
                    <h4 class="text-warning mb-0">{{ question_count }}</h4>
                    <small class="text-muted">Questions</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-success">
                <div class="card-body py-2">
                    <h4 class="text-success mb-0">{{ conclusion_count }}</h4>
                    <small class="text-muted">Conclusions</small>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card text-center border-purple" style="border-color: #6F42C1 !important;">
                <div class="card-body py-2">
                    {% if transformation_data and transformation_data.type %}
                    <h4 class="mb-0" style="color: #6F42C1;">
                        {% if transformation_data.type == 'transfer' %}Transfer
                        {% elif transformation_data.type == 'stalemate' %}Stalemate
                        {% elif transformation_data.type == 'oscillation' %}Oscillation
                        {% elif transformation_data.type == 'phase_lag' %}Phase Lag
                        {% else %}{{ transformation_data.type|title }}{% endif %}
                    </h4>
                    <small class="text-muted">Transformation
                        <a href="/tools/references#transformation" title="Marchais-Roubelat & Roubelat (2015)" class="text-muted ms-1">
                            <i class="bi bi-info-circle"></i>
                        </a>
                    </small>
                    {% else %}
                    <h4 class="text-muted mb-0">--</h4>
                    <small class="text-muted">Transformation
                        <a href="/tools/references#transformation" title="Marchais-Roubelat & Roubelat (2015)" class="text-muted ms-1">
                            <i class="bi bi-info-circle"></i>
                        </a>
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Transformation Details (if available) -->
    {% if transformation_data and transformation_data.type and transformation_data.type != 'unclear' %}
    <div class="alert alert-light border mb-4">
        <div class="d-flex align-items-center">
            <span class="badge me-2" style="background-color: #6F42C1;">
                {% if transformation_data.type == 'transfer' %}Transfer
                {% elif transformation_data.type == 'stalemate' %}Stalemate
                {% elif transformation_data.type == 'oscillation' %}Oscillation
                {% elif transformation_data.type == 'phase_lag' %}Phase Lag
                {% else %}{{ transformation_data.type|title }}{% endif %}
            </span>
            <span>
                {% if transformation_data.type == 'transfer' %}
                Resolution transfers obligation/responsibility to another party
                {% elif transformation_data.type == 'stalemate' %}
                Competing obligations remain in tension without clear resolution
                {% elif transformation_data.type == 'oscillation' %}
                Duties shift back and forth between parties over time
                {% elif transformation_data.type == 'phase_lag' %}
                Delayed consequences reveal obligations not initially apparent
                {% endif %}
            </span>
        </div>
        {% if transformation_data.pattern %}
        <small class="text-muted d-block mt-1">{{ transformation_data.pattern }}</small>
        {% endif %}
    </div>
    {% endif %}

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="reviewTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="fullgraph-tab" data-bs-toggle="tab" data-bs-target="#fullgraph" type="button">
                <i class="bi bi-diagram-3"></i> Full Entity Graph ({{ entity_count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph" type="button">
                <i class="bi bi-arrow-right-circle"></i> Reasoning Flow
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button">
                <i class="bi bi-box-seam"></i> Data Inventory
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="provisions-tab" data-bs-toggle="tab" data-bs-target="#provisions" type="button">
                <i class="bi bi-file-text"></i> Code Provisions
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button">
                <i class="bi bi-question-circle"></i> Questions & Conclusions
            </button>
        </li>
    </ul>

    <div class="tab-content" id="reviewTabContent">
        <!-- Data Inventory Tab -->
        <div class="tab-pane fade" id="inventory" role="tabpanel">
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i> This inventory shows data available for <strong>Precedent Discovery</strong> and <strong>Scenario Generation</strong>. Green items are ready; yellow items are missing and could enhance results.
            </div>

            <div class="row">
                <!-- Source Data: Passes 1-3 -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-layers me-2"></i>Source Data (Passes 1-3)</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <span class="badge {% if data_inventory.passes_1_3.available %}bg-success{% else %}bg-warning{% endif %} mb-2">
                                    {{ data_inventory.passes_1_3.total_entities }} Total Entities
                                </span>
                            </div>
                            <table class="table table-sm table-borderless mb-0">
                                <tbody>
                                {% for etype, count in entity_type_counts.items() %}
                                <tr>
                                    <td>
                                        <span class="badge me-1
                                            {% if etype == 'roles' %}bg-primary
                                            {% elif etype == 'states' %}bg-info
                                            {% elif etype == 'resources' %}bg-secondary
                                            {% elif etype == 'principles' %}bg-purple
                                            {% elif etype == 'obligations' %}bg-warning text-dark
                                            {% elif etype == 'constraints' %}bg-danger
                                            {% elif etype == 'capabilities' %}bg-success
                                            {% elif etype == 'actions' %}bg-dark
                                            {% elif etype == 'events' %}bg-secondary
                                            {% else %}bg-light text-dark{% endif %}">
                                            {{ count }}
                                        </span>
                                        {{ etype|title }}
                                    </td>
                                </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Step 4 Synthesis -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Step 4 Synthesis</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <span class="badge {% if data_inventory.step4_synthesis.available %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if data_inventory.step4_synthesis.available %}Ready{% else %}Not Run{% endif %}
                                </span>
                            </div>
                            <table class="table table-sm">
                                <tbody>
                                <tr>
                                    <td><i class="bi bi-{% if provision_count > 0 %}check-circle text-success{% else %}x-circle text-warning{% endif %}"></i> Code Provisions</td>
                                    <td class="text-end"><strong>{{ provision_count }}</strong></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-{% if question_count > 0 %}check-circle text-success{% else %}x-circle text-warning{% endif %}"></i> Questions</td>
                                    <td class="text-end"><strong>{{ question_count }}</strong></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-{% if conclusion_count > 0 %}check-circle text-success{% else %}x-circle text-warning{% endif %}"></i> Conclusions</td>
                                    <td class="text-end"><strong>{{ conclusion_count }}</strong></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-{% if transformation_data and transformation_data.type %}check-circle text-success{% else %}x-circle text-warning{% endif %}"></i> Transformation</td>
                                    <td class="text-end">
                                        {% if transformation_data and transformation_data.type %}
                                        <span class="badge bg-purple">{{ transformation_data.type|title }}</span>
                                        {% else %}
                                        <span class="text-muted">--</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-{% if has_synthesis_annotations %}check-circle text-success{% else %}x-circle text-muted{% endif %}"></i> Annotations</td>
                                    <td class="text-end"><strong>{{ annotation_count }}</strong></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Precedent Features -->
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Precedent Features</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <span class="badge {% if data_inventory.precedent_features.has_features %}bg-success{% else %}bg-warning{% endif %}">
                                    {% if data_inventory.precedent_features.has_features %}Extracted{% else %}Not Extracted{% endif %}
                                </span>
                            </div>
                            {% if precedent_features %}
                            <table class="table table-sm">
                                <tbody>
                                <tr>
                                    <td><i class="bi bi-check-circle text-success"></i> Outcome</td>
                                    <td class="text-end">
                                        <span class="badge {% if precedent_features.outcome_type == 'ethical' %}bg-success{% elif precedent_features.outcome_type == 'unethical' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {{ precedent_features.outcome_type|title }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-check-circle text-success"></i> Provisions Cited</td>
                                    <td class="text-end"><strong>{{ precedent_features.provisions_cited|length }}</strong></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-check-circle text-success"></i> Subject Tags</td>
                                    <td class="text-end"><strong>{{ precedent_features.subject_tags|length }}</strong></td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-{% if data_inventory.precedent_features.has_principle_tensions %}check-circle text-success{% else %}x-circle text-warning{% endif %}"></i> Principle Tensions</td>
                                    <td class="text-end">
                                        {% if data_inventory.precedent_features.has_principle_tensions %}
                                        <span class="badge bg-success">Yes</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">Missing</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-{% if data_inventory.precedent_features.has_obligation_conflicts %}check-circle text-success{% else %}x-circle text-warning{% endif %}"></i> Obligation Conflicts</td>
                                    <td class="text-end">
                                        {% if data_inventory.precedent_features.has_obligation_conflicts %}
                                        <span class="badge bg-success">Yes</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">Missing</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="bi bi-{% if data_inventory.precedent_features.has_embeddings %}check-circle text-success{% else %}x-circle text-warning{% endif %}"></i> Embeddings</td>
                                    <td class="text-end">
                                        {% if data_inventory.precedent_features.has_embeddings %}
                                        <span class="badge bg-success">Yes</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">Missing</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            {% else %}
                            <p class="text-muted mb-0">No precedent features extracted. Run feature extraction first.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Flow Diagram -->
            <div class="card mt-2">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-arrow-right-circle me-2"></i>Data Flow to Downstream Services</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white py-2">
                                    <strong><i class="bi bi-link-45deg me-2"></i>Precedent Discovery</strong>
                                </div>
                                <div class="card-body py-2">
                                    <small>
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr><td><i class="bi bi-{% if precedent_features and precedent_features.outcome_type %}check text-success{% else %}x text-warning{% endif %}"></i> Outcome Classification</td><td class="text-muted">Match ethical/unethical outcomes</td></tr>
                                        <tr><td><i class="bi bi-{% if precedent_features and precedent_features.provisions_cited %}check text-success{% else %}x text-warning{% endif %}"></i> Provisions Cited</td><td class="text-muted">Jaccard overlap matching</td></tr>
                                        <tr><td><i class="bi bi-{% if transformation_data and transformation_data.type %}check text-success{% else %}x text-warning{% endif %}"></i> Transformation Type</td><td class="text-muted">Pattern similarity</td></tr>
                                        <tr><td><i class="bi bi-{% if precedent_features and precedent_features.subject_tags %}check text-success{% else %}x text-warning{% endif %}"></i> Subject Tags</td><td class="text-muted">Topic overlap</td></tr>
                                        <tr><td><i class="bi bi-{% if data_inventory.precedent_features.has_principle_tensions %}check text-success{% else %}x text-warning{% endif %}"></i> Principle Tensions</td><td class="text-muted">Conflict pattern matching</td></tr>
                                        <tr><td><i class="bi bi-{% if data_inventory.precedent_features.has_embeddings %}check text-success{% else %}x text-warning{% endif %}"></i> Section Embeddings</td><td class="text-muted">Semantic similarity (cosine)</td></tr>
                                    </table>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white py-2">
                                    <strong><i class="bi bi-play-circle me-2"></i>Scenario Generation</strong>
                                </div>
                                <div class="card-body py-2">
                                    <small>
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr><td><i class="bi bi-{% if data_inventory.scenario_ready.has_roles %}check text-success{% else %}x text-warning{% endif %}"></i> Roles (Characters)</td><td class="text-muted">Scenario participants</td></tr>
                                        <tr><td><i class="bi bi-{% if data_inventory.scenario_ready.has_actions %}check text-success{% else %}x text-warning{% endif %}"></i> Actions</td><td class="text-muted">Decision points</td></tr>
                                        <tr><td><i class="bi bi-{% if data_inventory.scenario_ready.has_events %}check text-success{% else %}x text-warning{% endif %}"></i> Events</td><td class="text-muted">Timeline markers</td></tr>
                                        <tr><td><i class="bi bi-{% if data_inventory.scenario_ready.has_states %}check text-success{% else %}x text-warning{% endif %}"></i> States</td><td class="text-muted">Scenario conditions</td></tr>
                                        <tr><td><i class="bi bi-{% if data_inventory.scenario_ready.has_questions %}check text-success{% else %}x text-warning{% endif %}"></i> Questions</td><td class="text-muted">Ethical dilemmas</td></tr>
                                        <tr><td><i class="bi bi-{% if data_inventory.scenario_ready.has_conclusions %}check text-success{% else %}x text-warning{% endif %}"></i> Conclusions</td><td class="text-muted">Resolution paths</td></tr>
                                    </table>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Precedent Features -->
            {% if precedent_features %}
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Extracted Precedent Features (Detail)</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Provisions Cited</h6>
                            <div class="mb-3">
                                {% for prov in precedent_features.provisions_cited %}
                                <span class="badge bg-secondary me-1 mb-1">{{ prov }}</span>
                                {% else %}
                                <span class="text-muted">None extracted</span>
                                {% endfor %}
                            </div>

                            <h6>Subject Tags</h6>
                            <div class="mb-3">
                                {% for tag in precedent_features.subject_tags %}
                                <span class="badge bg-warning text-dark me-1 mb-1">{{ tag }}</span>
                                {% else %}
                                <span class="text-muted">None extracted</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Outcome Analysis</h6>
                            <p class="mb-2">
                                <strong>Type:</strong>
                                <span class="badge {% if precedent_features.outcome_type == 'ethical' %}bg-success{% elif precedent_features.outcome_type == 'unethical' %}bg-danger{% else %}bg-secondary{% endif %}">
                                    {{ precedent_features.outcome_type|title }}
                                </span>
                                {% if precedent_features.outcome_confidence %}
                                <small class="text-muted">({{ (precedent_features.outcome_confidence * 100)|round|int }}% confidence)</small>
                                {% endif %}
                            </p>
                            {% if precedent_features.outcome_reasoning %}
                            <p class="small text-muted">{{ precedent_features.outcome_reasoning }}</p>
                            {% endif %}

                            <h6>Transformation</h6>
                            <p class="mb-0">
                                <span class="badge bg-purple">{{ precedent_features.transformation_type|title }}</span>
                            </p>
                            {% if precedent_features.transformation_pattern %}
                            <p class="small text-muted mt-1">{{ precedent_features.transformation_pattern }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

        </div>

        <!-- Full Entity Graph Tab (D3.js) -->
        <div class="tab-pane fade show active" id="fullgraph" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Full Entity Graph</h5>
                        <small class="text-muted">All <span id="d3-node-count">0</span> entities from Passes 1-4 with relationships</small>
                    </div>
                    <div>
                        <span class="badge bg-primary me-1" id="d3-pass1">Pass 1: 0</span>
                        <span class="badge bg-success me-1" id="d3-pass2">Pass 2: 0</span>
                        <span class="badge bg-warning text-dark me-1" id="d3-pass3">Pass 3: 0</span>
                        <span class="badge bg-danger" id="d3-pass4">Step 4: 0</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- D3 Graph Controls -->
                    <div class="mb-3 d-flex justify-content-between align-items-center">
                        <div>
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" id="d3-search" class="form-control" placeholder="Search entities...">
                            </div>
                        </div>
                        <div>
                            <span class="me-2 text-muted small">Filter:</span>
                            <button class="btn btn-sm btn-outline-secondary d3-filter active" data-pass="all">All</button>
                            <button class="btn btn-sm btn-outline-primary d3-filter" data-pass="1">Pass 1</button>
                            <button class="btn btn-sm btn-outline-success d3-filter" data-pass="2">Pass 2</button>
                            <button class="btn btn-sm btn-outline-warning d3-filter" data-pass="3">Pass 3</button>
                            <button class="btn btn-sm btn-outline-danger d3-filter" data-pass="4">Step 4</button>
                            <span class="mx-2 text-muted">|</span>
                            <button class="btn btn-sm btn-outline-info" id="d3-toggle-hubs" title="Show type hub nodes (R, P, O, S, Rs, A, E, Ca, Cs)">
                                <i class="bi bi-diagram-2"></i> Type Hubs
                            </button>
                        </div>
                    </div>

                    <!-- D3 Graph Container -->
                    <div id="d3-graph-container" style="width: 100%; height: 600px; border: 1px solid #ddd; background-color: #fafafa; position: relative;">
                        <svg id="d3-graph-svg" style="width: 100%; height: 100%;"></svg>

                        <!-- Entity Details Panel -->
                        <div id="d3-entity-details" style="position: absolute; top: 10px; right: 10px; width: 300px; max-height: 350px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; z-index: 100;">
                            <button type="button" class="btn-close float-end" id="d3-close-details"></button>
                            <h6 id="d3-detail-label" class="mb-2" style="border-bottom: 2px solid #666; padding-bottom: 5px;"></h6>
                            <p class="small mb-2">
                                <span class="badge" id="d3-detail-type"></span>
                                <span class="badge bg-secondary" id="d3-detail-pass"></span>
                            </p>
                            <p class="small text-muted mb-2" id="d3-detail-definition"></p>
                            <p class="small mb-1"><strong>Connections:</strong></p>
                            <ul class="small list-unstyled" id="d3-detail-connections"></ul>
                        </div>

                        <!-- Zoom Controls -->
                        <div style="position: absolute; bottom: 10px; left: 10px; z-index: 100;">
                            <button class="btn btn-sm btn-light" id="d3-zoom-in" title="Zoom In"><i class="bi bi-plus-lg"></i></button>
                            <button class="btn btn-sm btn-light" id="d3-zoom-out" title="Zoom Out"><i class="bi bi-dash-lg"></i></button>
                            <button class="btn btn-sm btn-light" id="d3-zoom-reset" title="Reset"><i class="bi bi-arrows-fullscreen"></i></button>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-3">
                        <h6>Entity Types</h6>
                        <div id="d3-legend" class="d-flex flex-wrap gap-3"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reasoning Flow Tab (Cytoscape) -->
        <div class="tab-pane fade" id="graph" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-arrow-right-circle"></i> Synthesis Reasoning Flow</h5>
                    <small class="text-muted">Shows how NSPE provisions inform questions and conclusions - the board's reasoning chain</small>
                </div>
                <div class="card-body">
                    <!-- Graph Controls -->
                    <div class="mb-3">
                        <button id="fit-graph" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrows-fullscreen"></i> Fit to View
                        </button>
                        <button id="reset-graph" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Reset Layout
                        </button>
                        <div class="btn-group ms-2" role="group">
                            <input type="checkbox" class="btn-check" id="show-labels" checked autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="show-labels">Show Labels</label>
                        </div>
                    </div>

                    <!-- Cytoscape Container -->
                    <div id="cy" style="width: 100%; height: 700px; border: 1px solid #ddd; background-color: #fafafa;"></div>

                    <!-- Legend -->
                    <div class="mt-3">
                        <h6>Node Types & Relationships</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Nodes:</strong>
                                <div class="d-flex flex-wrap gap-3 mt-2">
                                    <span><span class="badge" style="background-color: #6C757D;">■</span> NSPE Provisions (rectangles)</span>
                                    <span><span class="badge" style="background-color: #FFC107;">◆</span> Questions (diamonds)</span>
                                    <span><span class="badge" style="background-color: #28A745;">▬</span> Conclusions (rounded)</span>
                                    <span><span class="badge" style="background-color: #17A2B8;">●</span> Entities (circles)</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <strong>Edge Colors:</strong>
                                <div class="mt-2">
                                    <span class="badge" style="background-color: #6C757D;">→</span> Provision informs Question<br>
                                    <span class="badge" style="background-color: #FFC107;">→</span> Question answered by Conclusion<br>
                                    <span class="badge" style="background-color: #17A2B8;">→</span> Provision applies to Entity
                                </div>
                            </div>
                        </div>
                        <p class="text-muted mt-2 mb-0"><small><strong>Note:</strong> For individual entity visualization, see <a href="http://localhost:5003/editor/ontology/proethica-case-{{ case.id }}/visualize" target="_blank">OntServe's full ontology view</a></small></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Provisions Tab -->
        <div class="tab-pane fade" id="provisions" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-file-text"></i> NSPE Code Provisions Referenced</h5>
                </div>
                <div class="card-body">
                    {% if provisions %}
                        {% for provision in provisions %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <strong>{{ provision.entity_label }}</strong>
                                    {% if provision.rdf_json_ld and provision.rdf_json_ld.codeProvision %}
                                    <span class="badge bg-secondary ms-2">{{ provision.rdf_json_ld.codeProvision }}</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>Full Text:</strong></p>
                                <p class="text-muted mb-3">{{ provision.entity_definition }}</p>

                                {% if provision.rdf_json_ld and provision.rdf_json_ld.relevantExcerpts %}
                                <p class="mb-2"><strong>Relevant Case Excerpts:</strong></p>
                                {% for excerpt in provision.rdf_json_ld.relevantExcerpts %}
                                <div class="alert alert-info mb-2">
                                    <small class="text-muted"><strong>From {{ excerpt.section }}:</strong></small><br>
                                    "{{ excerpt.text }}"
                                    {% if excerpt.confidence %}
                                    <br><small class="text-muted">Confidence: {{ "%.1f"|format(excerpt.confidence * 100) }}%</small>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% endif %}

                                {% if provision.rdf_json_ld and provision.rdf_json_ld.appliesTo %}
                                <p class="mb-2"><strong>Applies To:</strong></p>
                                <div class="applies-to-list">
                                    {% for entity in provision.rdf_json_ld.appliesTo %}
                                    <div class="applies-to-item mb-2 p-2 border rounded bg-light">
                                        <div class="d-flex align-items-center">
                                            <span class="badge me-2
                                                {% if entity.entity_type|lower == 'roles' %}bg-primary
                                                {% elif entity.entity_type|lower == 'obligations' %}bg-warning text-dark
                                                {% elif entity.entity_type|lower == 'principles' %}bg-purple
                                                {% elif entity.entity_type|lower == 'actions' %}bg-dark
                                                {% elif entity.entity_type|lower == 'states' %}bg-info
                                                {% else %}bg-secondary{% endif %}">
                                                {{ entity.entity_type|default('Entity') }}
                                            </span>
                                            <strong>{{ entity.entity_label|default(entity) }}</strong>
                                        </div>
                                        {% if entity.reasoning %}
                                        <small class="text-muted d-block mt-1 fst-italic">{{ entity.reasoning }}</small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No code provisions extracted yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Questions & Conclusions Tab -->
        <div class="tab-pane fade" id="questions" role="tabpanel">
            <!-- View Toggle -->
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="qcView" id="linkedView" checked>
                    <label class="btn btn-outline-primary" for="linkedView">Linked View</label>
                    <input type="radio" class="btn-check" name="qcView" id="splitView">
                    <label class="btn btn-outline-primary" for="splitView">Side-by-Side</label>
                </div>
            </div>

            <!-- LINKED VIEW: Shows Q→C relationships clearly -->
            <div id="linkedViewContent">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> Each question is shown with its corresponding conclusion(s). This reveals the board's reasoning flow.
                </div>

                {% if questions %}
                    {% for question in questions %}
                    <div class="card mb-4 qc-link-card" id="qc-pair-{{ loop.index }}">
                        <!-- Question Header -->
                        <div class="card-header bg-warning text-dark">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="bi bi-question-circle me-2"></i>
                                    {{ question.entity_label }}
                                </h6>
                                {% if question.rdf_json_ld and question.rdf_json_ld.relatedProvisions %}
                                <div>
                                    {% for prov in question.rdf_json_ld.relatedProvisions %}
                                    <span class="badge bg-secondary">{{ prov }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Question Text -->
                            <p class="mb-3">{{ question.entity_definition }}</p>

                            {% if question.rdf_json_ld and question.rdf_json_ld.mentionedEntities %}
                            <div class="mb-3">
                                <small class="text-muted"><strong>Involves:</strong></small>
                                {% for entity in question.rdf_json_ld.mentionedEntities %}
                                <span class="badge bg-info me-1">{{ entity }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Arrow to Conclusions -->
                            <div class="text-center my-2">
                                <span class="qc-arrow"><i class="bi bi-arrow-down-circle-fill"></i></span>
                                <small class="text-muted d-block">Board's Answer</small>
                            </div>

                            <!-- Linked Conclusions -->
                            {% set question_num = question.entity_label|replace('Question_', '')|replace('Question ', '') %}
                            {% set found_conclusion = false %}
                            {% for conclusion in conclusions %}
                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.answersQuestions %}
                                    {% for answered_q in conclusion.rdf_json_ld.answersQuestions %}
                                        {% set answered_q_str = answered_q|string %}
                                        {% if question_num in answered_q_str or question.entity_label in answered_q_str %}
                                            {% set found_conclusion = true %}
                                            <div class="card linked-conclusion mb-2">
                                                <div class="card-body py-2">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <strong class="text-success">
                                                                <i class="bi bi-check-circle me-1"></i>
                                                                {{ conclusion.entity_label }}
                                                            </strong>
                                                            <p class="mb-1 mt-1">{{ conclusion.entity_definition }}</p>
                                                        </div>
                                                        {% if conclusion.rdf_json_ld.conclusionType %}
                                                        <span class="badge bg-dark">{{ conclusion.rdf_json_ld.conclusionType }}</span>
                                                        {% endif %}
                                                    </div>
                                                    {% if conclusion.rdf_json_ld.citedProvisions %}
                                                    <div class="mt-2">
                                                        <small class="text-muted">Cites:</small>
                                                        {% for prov in conclusion.rdf_json_ld.citedProvisions %}
                                                        <span class="badge bg-secondary badge-sm">{{ prov }}</span>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}

                            {% if not found_conclusion %}
                            <div class="alert alert-secondary mb-0">
                                <small><i class="bi bi-dash-circle"></i> No linked conclusion found for this question.</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Unlinked Conclusions -->
                    {% set unlinked_conclusions = [] %}
                    {% for conclusion in conclusions %}
                        {% if not conclusion.rdf_json_ld or not conclusion.rdf_json_ld.answersQuestions or conclusion.rdf_json_ld.answersQuestions|length == 0 %}
                            {% set _ = unlinked_conclusions.append(conclusion) %}
                        {% endif %}
                    {% endfor %}

                    {% if unlinked_conclusions|length > 0 %}
                    <div class="card mt-4 unlinked-item">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="bi bi-link-45deg"></i> Additional Conclusions (No Direct Question Link)</h6>
                        </div>
                        <div class="card-body">
                            {% for conclusion in unlinked_conclusions %}
                            <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                <strong>{{ conclusion.entity_label }}</strong>
                                <p class="mb-1">{{ conclusion.entity_definition }}</p>
                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.citedProvisions %}
                                <small class="text-muted">Cites:</small>
                                {% for prov in conclusion.rdf_json_ld.citedProvisions %}
                                <span class="badge bg-secondary badge-sm">{{ prov }}</span>
                                {% endfor %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                {% else %}
                    <div class="alert alert-warning">No questions extracted yet. Run Step 4 synthesis first.</div>
                {% endif %}
            </div>

            <!-- SPLIT VIEW: Original side-by-side layout -->
            <div id="splitViewContent" style="display: none;">
                <div class="row">
                    <!-- Questions Column -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-warning text-dark">
                                <h5 class="mb-0"><i class="bi bi-question-circle"></i> Ethical Questions</h5>
                            </div>
                            <div class="card-body">
                                {% if questions %}
                                    {% for question in questions %}
                                    <div class="card mb-3" id="question-{{ loop.index }}">
                                        <div class="card-header bg-warning text-dark py-2">
                                            <strong>{{ question.entity_label }}</strong>
                                        </div>
                                        <div class="card-body">
                                            <p>{{ question.entity_definition }}</p>
                                            {% if question.rdf_json_ld and question.rdf_json_ld.mentionedEntities %}
                                            <div class="mb-2">
                                                <small class="text-muted"><strong>Mentioned:</strong></small>
                                                {% for entity in question.rdf_json_ld.mentionedEntities %}
                                                <span class="badge bg-info me-1">{{ entity }}</span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            {% if question.rdf_json_ld and question.rdf_json_ld.relatedProvisions %}
                                            <div>
                                                <small class="text-muted"><strong>Provisions:</strong></small>
                                                {% for prov in question.rdf_json_ld.relatedProvisions %}
                                                <span class="badge bg-secondary me-1">{{ prov }}</span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No questions extracted yet.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Conclusions Column -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-check-circle"></i> Board Conclusions</h5>
                            </div>
                            <div class="card-body">
                                {% if conclusions %}
                                    {% for conclusion in conclusions %}
                                    <div class="card mb-3" id="conclusion-{{ loop.index }}">
                                        <div class="card-header bg-success text-white py-2">
                                            <strong>{{ conclusion.entity_label }}</strong>
                                        </div>
                                        <div class="card-body">
                                            <p>{{ conclusion.entity_definition }}</p>
                                            {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.answersQuestions %}
                                            <div class="mb-2">
                                                <small class="text-muted"><strong>Answers:</strong></small>
                                                {% for q in conclusion.rdf_json_ld.answersQuestions %}
                                                <span class="badge bg-warning text-dark me-1">{{ q }}</span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.citedProvisions %}
                                            <div class="mb-2">
                                                <small class="text-muted"><strong>Cites:</strong></small>
                                                {% for prov in conclusion.rdf_json_ld.citedProvisions %}
                                                <span class="badge bg-secondary me-1">{{ prov }}</span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                            {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.conclusionType %}
                                            <div>
                                                <small class="text-muted"><strong>Type:</strong></small>
                                                <span class="badge bg-dark">{{ conclusion.rdf_json_ld.conclusionType }}</span>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No conclusions extracted yet.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include D3.js for Full Entity Graph -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- Include Cytoscape.js for Reasoning Flow -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load synthesis data (provisions, questions, conclusions)
    const provisions = {{ provisions_json | tojson | safe }};
    const questions = {{ questions_json | tojson | safe }};
    const conclusions = {{ conclusions_json | tojson | safe }};

    //BUILD SYNTHESIS REASONING GRAPH (LangGraph-style)
    // Shows: Provisions → Questions → Conclusions + Entity mentions
    const elements = [];
    const nodeIds = new Set();

    // Add Provision nodes
    provisions.forEach(function(prov) {
        const nodeId = 'prov_' + prov.id;
        const provCode = prov.rdf_json_ld?.codeProvision || prov.entity_label;

        nodeIds.add(nodeId);
        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: provCode,
                type: 'provision',
                fullText: prov.entity_definition,
                nodeType: 'NSPE Provision'
            }
        });

        // Add edges from provisions to mentioned entities
        if (prov.rdf_json_ld && prov.rdf_json_ld.appliesTo) {
            prov.rdf_json_ld.appliesTo.forEach(function(entity) {
                const entityId = 'entity_' + entity.entity_label.replace(/\s+/g, '_');

                // Add entity node if not exists
                if (!nodeIds.has(entityId)) {
                    nodeIds.add(entityId);
                    elements.push({
                        group: 'nodes',
                        data: {
                            id: entityId,
                            label: entity.entity_label,
                            type: entity.entity_type,
                            reasoning: entity.reasoning,
                            nodeType: 'Entity'
                        }
                    });
                }

                // Add edge: provision → entity
                elements.push({
                    group: 'edges',
                    data: {
                        id: nodeId + '_' + entityId,
                        source: nodeId,
                        target: entityId,
                        label: 'applies to',
                        edgeType: 'provision_to_entity'
                    }
                });
            });
        }
    });

    // Add Question nodes
    questions.forEach(function(q) {
        const nodeId = 'q_' + q.id;
        nodeIds.add(nodeId);

        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: q.entity_label,
                type: 'question',
                fullText: q.entity_definition,
                nodeType: 'Question'
            }
        });

        // Link questions to related provisions
        if (q.rdf_json_ld && q.rdf_json_ld.relatedProvisions) {
            q.rdf_json_ld.relatedProvisions.forEach(function(provCode) {
                // Find provision node
                const provNode = provisions.find(p =>
                    p.rdf_json_ld?.codeProvision === provCode ||
                    p.entity_label.includes(provCode)
                );
                if (provNode) {
                    const provId = 'prov_' + provNode.id;
                    elements.push({
                        group: 'edges',
                        data: {
                            id: provId + '_' + nodeId,
                            source: provId,
                            target: nodeId,
                            label: 'informs',
                            edgeType: 'provision_to_question'
                        }
                    });
                }
            });
        }
    });

    // Add Conclusion nodes
    conclusions.forEach(function(c) {
        const nodeId = 'c_' + c.id;
        nodeIds.add(nodeId);

        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: c.entity_label,
                type: 'conclusion',
                fullText: c.entity_definition,
                nodeType: 'Conclusion'
            }
        });

        // Link conclusions to questions they answer
        if (c.rdf_json_ld && c.rdf_json_ld.answersQuestions) {
            c.rdf_json_ld.answersQuestions.forEach(function(qNum) {
                const qNode = questions.find(q => q.entity_label.includes(qNum) || q.entity_label.includes('Question_' + qNum));
                if (qNode) {
                    const qId = 'q_' + qNode.id;
                    elements.push({
                        group: 'edges',
                        data: {
                            id: qId + '_' + nodeId,
                            source: qId,
                            target: nodeId,
                            label: 'answered by',
                            edgeType: 'question_to_conclusion'
                        }
                    });
                }
            });
        }
    });

    // Initialize Cytoscape with HIERARCHICAL layout (LangGraph-style)
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': function(ele) {
                        const type = ele.data('type');
                        const colors = {
                            'provision': '#6C757D',  // Gray - Code provisions
                            'question': '#FFC107',   // Yellow - Questions
                            'conclusion': '#28A745', // Green - Conclusions
                            'action': '#343A40',     // Dark - Actions
                            'event': '#6C757D'       // Gray - Events
                        };
                        return colors[type] || '#17A2B8'; // Cyan for entities
                    },
                    'label': 'data(label)',
                    'color': '#fff',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '11px',
                    'font-weight': 'bold',
                    'width': function(ele) {
                        // Larger nodes for Q/C/Provisions
                        const type = ele.data('type');
                        return (type === 'provision' || type === 'question' || type === 'conclusion') ? '60px' : '45px';
                    },
                    'height': function(ele) {
                        const type = ele.data('type');
                        return (type === 'provision' || type === 'question' || type === 'conclusion') ? '60px' : '45px';
                    },
                    'text-wrap': 'wrap',
                    'text-max-width': '100px',
                    'shape': function(ele) {
                        const type = ele.data('type');
                        if (type === 'provision') return 'rectangle';
                        if (type === 'question') return 'diamond';
                        if (type === 'conclusion') return 'round-rectangle';
                        return 'ellipse';
                    },
                    'border-width': 2,
                    'border-color': '#fff'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 3,
                    'line-color': function(ele) {
                        const edgeType = ele.data('edgeType');
                        if (edgeType === 'provision_to_question') return '#6C757D';
                        if (edgeType === 'question_to_conclusion') return '#FFC107';
                        if (edgeType === 'provision_to_entity') return '#17A2B8';
                        return '#ccc';
                    },
                    'target-arrow-color': function(ele) {
                        const edgeType = ele.data('edgeType');
                        if (edgeType === 'provision_to_question') return '#6C757D';
                        if (edgeType === 'question_to_conclusion') return '#FFC107';
                        if (edgeType === 'provision_to_entity') return '#17A2B8';
                        return '#ccc';
                    },
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'label': 'data(label)',
                    'font-size': '9px',
                    'text-rotation': 'autorotate',
                    'text-background-color': '#fff',
                    'text-background-opacity': 0.8,
                    'text-background-padding': '2px'
                }
            }
        ],
        layout: {
            name: 'breadthfirst',  // Hierarchical layout for flow
            directed: true,
            spacingFactor: 1.5,
            padding: 50,
            animate: true,
            animationDuration: 500
        }
    });

    // Graph controls
    document.getElementById('fit-graph').addEventListener('click', function() {
        cy.fit();
    });

    document.getElementById('reset-graph').addEventListener('click', function() {
        cy.layout({
            name: 'cose',
            idealEdgeLength: 100,
            nodeOverlap: 20,
            fit: true
        }).run();
    });

    document.getElementById('show-labels').addEventListener('change', function(e) {
        if (e.target.checked) {
            cy.style().selector('node').style('label', 'data(label)').update();
        } else {
            cy.style().selector('node').style('label', '').update();
        }
    });

    // Node click handler
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        const data = node.data();

        // Show entity details in modal or alert
        const details = `
Entity: ${data.label}
Type: ${data.type}
Definition: ${data.definition || 'No definition available'}
URI: ${data.uri}
        `.trim();

        alert(details);
    });

    // Q&C View Toggle
    document.getElementById('linkedView').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('linkedViewContent').style.display = 'block';
            document.getElementById('splitViewContent').style.display = 'none';
        }
    });

    document.getElementById('splitView').addEventListener('change', function() {
        if (this.checked) {
            document.getElementById('linkedViewContent').style.display = 'none';
            document.getElementById('splitViewContent').style.display = 'block';
        }
    });

});

// Synthesis Annotations (outside DOMContentLoaded for onclick access)

// Synthesis Annotations Generation
const currentCaseId = {{ case.id }};

function generateSynthesisAnnotations() {
    const btn = document.getElementById('generateAnnotationsBtn');
    const alertDiv = document.getElementById('annotationAlert');
    const message = document.getElementById('annotationMessage');
    
    // Disable button
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
    
    // Show processing message
    alertDiv.className = 'alert alert-info alert-dismissible fade show';
    alertDiv.style.display = 'block';
    message.innerHTML = '<strong>Generating synthesis annotations...</strong> This may take a minute.';
    
    // Call API
    fetch('/scenario_pipeline/case/' + currentCaseId + '/step4/generate_synthesis_annotations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            message.innerHTML = '<strong>Success!</strong> Generated ' + data.counts.total + ' synthesis annotations:<ul class="mb-0 mt-2"><li>' + data.counts.questions + ' questions</li><li>' + data.counts.conclusions + ' conclusions</li><li>' + data.counts.provisions + ' provision citations</li><li>' + data.counts.entity_mentions + ' entity mentions</li></ul><a href="/cases/{{ case.id }}?highlight=synthesis" class="btn btn-sm btn-info mt-2"><i class="bi bi-eye"></i> View Case with Annotations</a>';
        } else {
            // Show error
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            message.innerHTML = '<strong>Error:</strong> ' + (data.error || 'Failed to generate annotations');
        }
        
        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightbulb"></i> Generate Synthesis Annotations';
    })
    .catch(error => {
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        message.innerHTML = '<strong>Error:</strong> ' + error.message;
        
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightbulb"></i> Generate Synthesis Annotations';
    });
}

// Helper function to get CSRF token
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

// ============================================================================
// D3.js Full Entity Graph
// ============================================================================
(function() {
    const caseId = {{ case.id }};
    const container = document.getElementById('d3-graph-container');
    const svg = d3.select('#d3-graph-svg');

    let graphData = null;
    let simulation = null;
    let currentFilter = 'all';
    let searchTerm = '';
    let showTypeHubs = false;

    // Fetch and render graph
    loadGraph();

    function loadGraph() {
        const url = `/scenario_pipeline/case/${caseId}/entity_graph` + (showTypeHubs ? '?type_hubs=true' : '');
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    graphData = data;
                    renderD3Graph(data);
                    updateD3Stats(data.metadata);
                    buildD3Legend(data.metadata.type_colors);
                } else {
                    console.error('Failed to load graph:', data.error);
                    document.getElementById('d3-node-count').textContent = 'Error loading';
                }
            })
            .catch(error => {
                console.error('Error fetching graph:', error);
                document.getElementById('d3-node-count').textContent = 'Error';
            });
    }

    function renderD3Graph(data) {
        const width = container.clientWidth;
        const height = container.clientHeight || 600;

        svg.selectAll('*').remove();

        // Define arrow markers for edges
        svg.append('defs').append('marker')
            .attr('id', 'arrowhead')
            .attr('viewBox', '-0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('orient', 'auto')
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .append('path')
            .attr('d', 'M 0,-5 L 10,0 L 0,5')
            .attr('fill', '#666');

        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => g.attr('transform', event.transform));

        svg.call(zoom);
        const g = svg.append('g');

        // Filter nodes
        const filteredNodes = filterD3Nodes(data.nodes);
        const filteredNodeIds = new Set(filteredNodes.map(n => n.id));
        const filteredEdges = data.edges.filter(e =>
            filteredNodeIds.has(e.source) && filteredNodeIds.has(e.target) ||
            filteredNodeIds.has(e.source?.id) && filteredNodeIds.has(e.target?.id)
        );

        // Create simulation with adjusted forces
        simulation = d3.forceSimulation(filteredNodes)
            .force('link', d3.forceLink(filteredEdges).id(d => d.id).distance(d => d.type === 'instance_of' ? 40 : 80))
            .force('charge', d3.forceManyBody().strength(d => d.is_hub ? -300 : -120))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(d => d.is_hub ? 40 : 25));

        // Create edges with arrows
        const link = g.append('g')
            .attr('class', 'links')
            .selectAll('line')
            .data(filteredEdges)
            .enter().append('line')
            .attr('stroke', d => d.type === 'instance_of' ? '#ccc' : '#666')
            .attr('stroke-opacity', d => d.type === 'instance_of' ? 0.3 : 0.7)
            .attr('stroke-width', d => d.type === 'instance_of' ? 1 : 2)
            .attr('marker-end', d => d.type !== 'instance_of' ? 'url(#arrowhead)' : null);

        // Create edge labels
        const edgeLabels = g.append('g')
            .attr('class', 'edge-labels')
            .selectAll('text')
            .data(filteredEdges.filter(e => e.type !== 'instance_of'))
            .enter().append('text')
            .attr('font-size', '8px')
            .attr('fill', '#666')
            .attr('text-anchor', 'middle')
            .text(d => d.type.replace(/_/g, ' '));

        // Create nodes
        const node = g.append('g')
            .attr('class', 'nodes')
            .selectAll('g')
            .data(filteredNodes)
            .enter().append('g')
            .style('cursor', 'pointer')
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended))
            .on('click', showD3Details)
            .on('mouseover', function(event, d) {
                d3.select(this).select('circle').attr('stroke-width', 3).attr('stroke', '#333');
                // Highlight connected edges
                link.attr('stroke-opacity', e => (e.source.id === d.id || e.target.id === d.id) ? 1 : 0.2);
            })
            .on('mouseout', function() {
                d3.select(this).select('circle').attr('stroke-width', 2).attr('stroke', '#fff');
                link.attr('stroke-opacity', d => d.type === 'instance_of' ? 0.3 : 0.7);
            });

        node.append('circle')
            .attr('r', d => d.is_hub ? 18 : getD3NodeSize(d))
            .attr('fill', d => d.color)
            .attr('stroke', '#fff')
            .attr('stroke-width', 2);

        node.append('text')
            .attr('dy', d => (d.is_hub ? 18 : getD3NodeSize(d)) + 12)
            .attr('text-anchor', 'middle')
            .attr('font-size', d => d.is_hub ? '10px' : '9px')
            .attr('font-weight', d => d.is_hub ? 'bold' : 'normal')
            .attr('fill', '#333')
            .text(d => truncateD3Label(d.label, d.is_hub ? 20 : 12));

        simulation.on('tick', () => {
            link.attr('x1', d => d.source.x).attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
            node.attr('transform', d => `translate(${d.x},${d.y})`);
            edgeLabels
                .attr('x', d => (d.source.x + d.target.x) / 2)
                .attr('y', d => (d.source.y + d.target.y) / 2);
        });

        document.getElementById('d3-node-count').textContent = filteredNodes.length + ' nodes, ' + filteredEdges.length + ' edges';

        // Zoom controls
        document.getElementById('d3-zoom-in').onclick = () => svg.transition().call(zoom.scaleBy, 1.3);
        document.getElementById('d3-zoom-out').onclick = () => svg.transition().call(zoom.scaleBy, 0.7);
        document.getElementById('d3-zoom-reset').onclick = () => svg.transition().call(zoom.transform, d3.zoomIdentity);
    }

    function filterD3Nodes(nodes) {
        return nodes.filter(n => {
            if (currentFilter !== 'all' && n.pass !== parseInt(currentFilter)) return false;
            if (searchTerm && !n.label.toLowerCase().includes(searchTerm.toLowerCase())) return false;
            return true;
        });
    }

    function getD3NodeSize(node) {
        const sizes = { 'roles': 10, 'principles': 8, 'obligations': 8, 'temporal_dynamics_enhanced': 8,
                       'ethical_question': 9, 'ethical_conclusion': 9, 'code_provision_reference': 8 };
        return sizes[node.type] || 7;
    }

    function truncateD3Label(label, maxLen) {
        return label.length <= maxLen ? label : label.substring(0, maxLen) + '...';
    }

    function showD3Details(event, d) {
        const panel = document.getElementById('d3-entity-details');
        document.getElementById('d3-detail-label').textContent = d.label;
        document.getElementById('d3-detail-label').style.borderColor = d.color;

        const typeBadge = document.getElementById('d3-detail-type');
        typeBadge.textContent = d.type.replace(/_/g, ' ');
        typeBadge.style.backgroundColor = d.color;

        const passNames = {1: 'Pass 1', 2: 'Pass 2', 3: 'Pass 3', 4: 'Step 4'};
        document.getElementById('d3-detail-pass').textContent = passNames[d.pass] || 'Unknown';
        document.getElementById('d3-detail-definition').textContent = d.definition || 'No definition';

        const connections = graphData.edges.filter(e =>
            e.source === d.id || e.target === d.id ||
            e.source?.id === d.id || e.target?.id === d.id
        );

        const connEl = document.getElementById('d3-detail-connections');
        connEl.innerHTML = connections.length === 0 ? '<li class="text-muted">None</li>' : '';
        connections.forEach(conn => {
            const isSource = conn.source === d.id || conn.source?.id === d.id;
            const otherNode = graphData.nodes.find(n =>
                n.id === (isSource ? (conn.target?.id || conn.target) : (conn.source?.id || conn.source))
            );
            if (otherNode) {
                const li = document.createElement('li');
                li.innerHTML = `<span style="color:${otherNode.color}">${isSource ? '&#8594;' : '&#8592;'}</span> ${otherNode.label}`;
                connEl.appendChild(li);
            }
        });
        panel.style.display = 'block';
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
    }
    function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
    }

    function updateD3Stats(metadata) {
        const pc = metadata.pass_counts;
        document.getElementById('d3-pass1').textContent = `Pass 1: ${pc[1] || 0}`;
        document.getElementById('d3-pass2').textContent = `Pass 2: ${pc[2] || 0}`;
        document.getElementById('d3-pass3').textContent = `Pass 3: ${pc[3] || 0}`;
        document.getElementById('d3-pass4').textContent = `Step 4: ${pc[4] || 0}`;
    }

    function buildD3Legend(colors) {
        const container = document.getElementById('d3-legend');
        container.innerHTML = '';
        const labels = {
            'roles': 'Roles', 'states': 'States', 'resources': 'Resources',
            'principles': 'Principles', 'obligations': 'Obligations', 'constraints': 'Constraints',
            'capabilities': 'Capabilities', 'temporal_dynamics_enhanced': 'Actions/Events',
            'code_provision_reference': 'Provisions', 'ethical_question': 'Questions', 'ethical_conclusion': 'Conclusions'
        };
        Object.entries(colors).forEach(([type, color]) => {
            if (labels[type]) {
                const span = document.createElement('span');
                span.innerHTML = `<span style="display:inline-block;width:12px;height:12px;background:${color};border-radius:50%;margin-right:5px;"></span>${labels[type]}`;
                container.appendChild(span);
            }
        });
    }

    // Filter buttons
    document.querySelectorAll('.d3-filter').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.d3-filter').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentFilter = this.dataset.pass;
            if (graphData) renderD3Graph(graphData);
        });
    });

    // Search
    document.getElementById('d3-search').addEventListener('input', function() {
        searchTerm = this.value;
        if (graphData) renderD3Graph(graphData);
    });

    // Close details
    document.getElementById('d3-close-details').addEventListener('click', function() {
        document.getElementById('d3-entity-details').style.display = 'none';
    });
})();
</script>
{% endblock %}
