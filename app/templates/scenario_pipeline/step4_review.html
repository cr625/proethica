{% extends "base.html" %}

{% block title %}Step 4 Review - Case {{ case.id }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-clipboard-check"></i> Step 4: Synthesis Review</h2>
            <p class="text-muted mb-0">Case {{ case.id }}: {{ case.title }}</p>
        </div>
        <div>
        <div>
            {% if has_synthesis_annotations %}
                <a href="{{ url_for('cases.view_case', id=case.id) }}?highlight=synthesis" class="btn btn-success me-2">
                    <i class="bi bi-eye"></i> View Case with Annotations ({{ annotation_count }})
                </a>
            {% else %}
                {% if current_user.is_authenticated %}
                <button id="generateAnnotationsBtn" class="btn btn-warning me-2" onclick="generateSynthesisAnnotations()">
                    <i class="bi bi-lightbulb"></i> Generate Synthesis Annotations
                </button>
                {% else %}
                <button class="btn btn-secondary me-2" onclick="window.location.href='{{ url_for('auth.login') }}';" title="Login required to generate annotations">
                    <i class="bi bi-lock-fill"></i> Generate Synthesis Annotations (Login Required)
                </button>
                {% endif %}
            {% endif %}
            <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Step 4
            </a>
        </div>
        </div>
    </div>

    <!-- Alert for annotation generation -->
    <div id="annotationAlert" class="alert alert-dismissible fade" role="alert" style="display: none;">
        <div id="annotationMessage"></div>
        <button type="button" class="btn-close" onclick="document.getElementById('annotationAlert').style.display='none'"></button>
    </div>

    <!-- Show existing annotations info -->
    {% if has_synthesis_annotations %}
    <div class="alert alert-info alert-dismissible fade show">
        <strong><i class="bi bi-info-circle"></i> Synthesis Annotations Available</strong>
        <p class="mb-2 mt-2">{{ annotation_count }} synthesis annotations have been generated for this case:</p>
        <ul class="mb-2">
            {% if annotation_breakdown.get('question') %}<li>{{ annotation_breakdown.get('question') }} questions</li>{% endif %}
            {% if annotation_breakdown.get('conclusion') %}<li>{{ annotation_breakdown.get('conclusion') }} conclusions</li>{% endif %}
            {% if annotation_breakdown.get('provision') %}<li>{{ annotation_breakdown.get('provision') }} provision citations</li>{% endif %}
            {% for key, value in annotation_breakdown.items() %}
                {% if key.startswith('entity_') %}
                    <li>{{ value }} {{ key.replace('entity_', '') }} mentions</li>
                {% endif %}
            {% endfor %}
        </ul>
        <p class="mb-0"><small class="text-muted">Click "View Case with Annotations" above to see them highlighted in the case text.</small></p>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h3 class="text-primary">{{ entity_count }}</h3>
                    <p class="mb-0">Total Entities</p>
                    <small class="text-muted">Passes 1-3</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h3 class="text-info">{{ provision_count }}</h3>
                    <p class="mb-0">Code Provisions</p>
                    <small class="text-muted">NSPE References</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h3 class="text-warning">{{ question_count }}</h3>
                    <p class="mb-0">Questions</p>
                    <small class="text-muted">Ethical Dilemmas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h3 class="text-success">{{ conclusion_count }}</h3>
                    <p class="mb-0">Conclusions</p>
                    <small class="text-muted">Board Findings</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Accordion Sections -->
    <div class="accordion" id="step4Accordion">

        <!-- Entity Graph Section -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#graphSection">
                    <i class="bi bi-diagram-3 me-2"></i> Entity Graph
                </button>
            </h2>
            <div id="graphSection" class="accordion-collapse collapse" data-bs-parent="#step4Accordion">
                <div class="accordion-body">
                    <h5>Synthesis Reasoning Flow</h5>
                    <small class="text-muted">Shows how NSPE provisions inform questions and conclusions - the board's reasoning chain (LangGraph-style)</small>

                    <!-- View Toggle -->
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="graph-view" id="simple-view" checked autocomplete="off">
                            <label class="btn btn-outline-primary" for="simple-view">
                                <i class="bi bi-diagram-2"></i> Simple View
                            </label>

                            <input type="radio" class="btn-check" name="graph-view" id="enhanced-view" autocomplete="off">
                            <label class="btn btn-outline-primary" for="enhanced-view">
                                <i class="bi bi-diagram-3"></i> Enhanced View
                            </label>
                        </div>
                        <small class="text-muted ms-2">
                            Simple: Provisions → Questions → Conclusions | Enhanced: + Precedents, Principles, Conflicts
                        </small>
                    </div>

                    <!-- Graph Controls -->
                    <div class="my-3 d-flex flex-wrap gap-2 align-items-center">
                        <!-- Basic Controls -->
                        <button id="fit-graph" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrows-fullscreen"></i> Fit to View
                        </button>
                        <button id="reset-graph" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Reset Layout
                        </button>

                        <!-- Zoom Controls -->
                        <div class="btn-group">
                            <button id="zoom-in" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button id="zoom-out" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                        </div>

                        <!-- Layout Selector -->
                        <select id="layout-selector" class="form-select form-select-sm" style="width: auto;">
                            <option value="breadthfirst">Hierarchical</option>
                            <option value="cose">Force-Directed</option>
                            <option value="circle">Circle</option>
                            <option value="grid">Grid</option>
                        </select>

                        <!-- Labels Toggle -->
                        <div class="form-check form-switch ms-2">
                            <input class="form-check-input" type="checkbox" id="show-labels" checked>
                            <label class="form-check-label" for="show-labels">Labels</label>
                        </div>

                        <!-- Node Filters (Enhanced View Only) -->
                        <div id="node-filters" class="ms-3" style="display: none;">
                            <strong class="me-2">Show:</strong>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input node-filter" type="checkbox" id="filter-precedents" value="precedent" checked>
                                <label class="form-check-label" for="filter-precedents">Precedents</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input node-filter" type="checkbox" id="filter-principles" value="principle" checked>
                                <label class="form-check-label" for="filter-principles">Principles</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input node-filter" type="checkbox" id="filter-obligations" value="obligation" checked>
                                <label class="form-check-label" for="filter-obligations">Obligations</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input node-filter" type="checkbox" id="filter-conflicts" value="conflict" checked>
                                <label class="form-check-label" for="filter-conflicts">Conflicts</label>
                            </div>
                        </div>
                    </div>

                    <!-- Cytoscape Container -->
                    <div id="cy" style="width: 100%; height: 900px; border: 1px solid #ddd; background-color: #fafafa; position: relative;">
                        <div id="graph-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading graph...</span>
                            </div>
                            <div class="mt-2">Building graph...</div>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="mt-3">
                        <h6>Node Types & Relationships</h6>
                        <div class="row">
                            <div class="col-md-7">
                                <strong>Nodes:</strong>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <span><span class="badge" style="background-color: #6C757D;">■</span> Provisions</span>
                                    <span><span class="badge" style="background-color: #FFC107;">◆</span> Questions</span>
                                    <span><span class="badge" style="background-color: #28A745;">▬</span> Conclusions</span>
                                    <span id="legend-precedents" style="display: none;"><span class="badge" style="background-color: #FD7E14;">⬡</span> Precedents</span>
                                    <span id="legend-principles" style="display: none;"><span class="badge" style="background-color: #0D6EFD;">●</span> Principles</span>
                                    <span id="legend-obligations" style="display: none;"><span class="badge" style="background-color: #6F42C1;">●</span> Obligations</span>
                                    <span id="legend-constraints" style="display: none;"><span class="badge" style="background-color: #9B59B6;">■</span> Constraints</span>
                                </div>
                            </div>
                            <div class="col-md-5">
                                <strong>Relationships:</strong>
                                <div class="mt-2">
                                    <span class="badge" style="background-color: #6C757D;">─→</span> Informs<br>
                                    <span class="badge" style="background-color: #FFC107;">─→</span> Answers<br>
                                    <span class="badge" style="background-color: #17A2B8;">─→</span> Applies to<br>
                                    <span id="legend-conflicts" style="display: none;" class="badge" style="background-color: #DC3545;">⟷</span> Conflicts (dashed)</span>
                                </div>
                            </div>
                        </div>
                        <p class="text-muted mt-2 mb-0">
                            <small><strong>Tip:</strong> Hover over nodes for full text. Click nodes to highlight connections.</small><br>
                            <small>For complete ontology: <a href="http://localhost:5003/editor/ontology/proethica-case-{{ case.id }}/visualize" target="_blank">OntServe Visualization</a></small>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Provisions Section -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#provisionsSection">
                    <i class="bi bi-file-text me-2"></i> Code Provisions ({{ provision_count }})
                </button>
            </h2>
            <div id="provisionsSection" class="accordion-collapse collapse" data-bs-parent="#step4Accordion">
                <div class="accordion-body">
                    {% if provisions %}
                        {% for provision in provisions %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <strong>{{ provision.entity_label }}</strong>
                                    {% if provision.rdf_json_ld and provision.rdf_json_ld.codeProvision %}
                                    <span class="badge bg-secondary ms-2">{{ provision.rdf_json_ld.codeProvision }}</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2"><strong>Full Text:</strong></p>
                                <p class="text-muted mb-3">{{ provision.entity_definition }}</p>

                                {% if provision.rdf_json_ld and provision.rdf_json_ld.relevantExcerpts %}
                                <p class="mb-2"><strong>Relevant Case Excerpts:</strong></p>
                                {% for excerpt in provision.rdf_json_ld.relevantExcerpts %}
                                <div class="alert alert-info mb-2">
                                    <small class="text-muted"><strong>From {{ excerpt.section }}:</strong></small><br>
                                    "{{ excerpt.text }}"
                                    {% if excerpt.confidence %}
                                    <br><small class="text-muted">Confidence: {{ "%.1f"|format(excerpt.confidence * 100) }}%</small>
                                    {% endif %}
                                </div>
                                {% endfor %}
                                {% endif %}

                                {% if provision.rdf_json_ld and provision.rdf_json_ld.appliesTo %}
                                <p class="mb-2"><strong>Applies To:</strong></p>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for entity in provision.rdf_json_ld.appliesTo %}
                                    <span class="badge bg-secondary">{{ entity }}</span>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No code provisions extracted yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Precedent Cases Section -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#precedentsSection">
                    <i class="bi bi-bookmark-check me-2"></i> Precedent Cases Cited ({{ precedent_count }})
                </button>
            </h2>
            <div id="precedentsSection" class="accordion-collapse collapse" data-bs-parent="#step4Accordion">
                <div class="accordion-body">
                    {% if precedents %}
                        <p class="text-muted mb-3">Prior NSPE Board of Ethical Review cases cited by the board to establish patterns, support reasoning, or distinguish the current decision.</p>

                        {% for precedent in precedents %}
                        <div class="card mb-3 border-info">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    {% if precedent.rdf_json_ld.sourceUrl %}
                                    <a href="{{ precedent.rdf_json_ld.sourceUrl }}" target="_blank" class="text-decoration-none">
                                        <strong>{{ precedent.rdf_json_ld.fullCitation or precedent.entity_label }}</strong>
                                        <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.8em;"></i>
                                    </a>
                                    {% else %}
                                    <strong>{{ precedent.rdf_json_ld.fullCitation or precedent.entity_label }}</strong>
                                    {% endif %}
                                    {% if precedent.rdf_json_ld.yearDecided %}
                                    <span class="badge bg-info ms-2">{{ precedent.rdf_json_ld.yearDecided }}</span>
                                    {% endif %}
                                    {% if precedent.rdf_json_ld.confidence %}
                                    <span class="badge bg-secondary ms-1">{{ "%.0f"|format(precedent.rdf_json_ld.confidence * 100) }}% confident</span>
                                    {% endif %}
                                </h6>
                                {% if precedent.rdf_json_ld.sourceUrl %}
                                <a href="{{ precedent.rdf_json_ld.sourceUrl }}"
                                   class="btn btn-sm btn-info"
                                   target="_blank"
                                   title="View original case on NSPE website">
                                    <i class="bi bi-box-arrow-up-right"></i> View on NSPE
                                </a>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <h6 class="text-primary">{{ precedent.rdf_json_ld.caseTitle or precedent.entity_definition }}</h6>

                                {% if precedent.rdf_json_ld.citationContext %}
                                <div class="mb-3">
                                    <strong>Citation Context:</strong>
                                    <p class="text-muted mb-0 citation-context" data-citation="{{ precedent.rdf_json_ld.fullCitation or precedent.entity_label }}">
                                        "{{ precedent.rdf_json_ld.citationContext }}"
                                    </p>
                                </div>
                                {% endif %}

                                {% if precedent.rdf_json_ld.relevanceReasoning %}
                                <div class="alert alert-info mb-3">
                                    <strong><i class="bi bi-lightbulb"></i> Why the Board Cited This Case:</strong>
                                    <p class="mb-0 mt-2">{{ precedent.rdf_json_ld.relevanceReasoning }}</p>
                                </div>
                                {% endif %}

                                {% if precedent.rdf_json_ld.relatedProvisions %}
                                <div>
                                    <strong>Related NSPE Code Provisions:</strong>
                                    <div class="d-flex flex-wrap gap-2 mt-2">
                                        {% for prov in precedent.rdf_json_ld.relatedProvisions %}
                                        <span class="badge bg-secondary">{{ prov }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-info-circle"></i> No precedent cases found in Discussion or Conclusions sections.
                            <p class="mb-0 mt-2"><small>The extractor searches for BER/BOR case citations (e.g., "BER Case 84-5") throughout the case analysis.</small></p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Questions & Conclusions Section -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#questionsSection">
                    <i class="bi bi-question-circle me-2"></i> Questions & Conclusions ({{ question_count }} Q / {{ conclusion_count }} C)
                </button>
            </h2>
            <div id="questionsSection" class="accordion-collapse collapse" data-bs-parent="#step4Accordion">
                <div class="accordion-body">
                    <div class="row">
                        <!-- Questions Column -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h5><i class="bi bi-question-circle"></i> Ethical Questions</h5>
                                </div>
                                <div class="card-body">
                                    {% if questions %}
                                        {% for question in questions %}
                                        <div class="card mb-3" id="question-{{ loop.index }}">
                                            <div class="card-header bg-warning text-dark">
                                                <strong>{{ question.entity_label }}</strong>
                                            </div>
                                            <div class="card-body">
                                                <p>{{ question.entity_definition }}</p>

                                                {% if question.rdf_json_ld and question.rdf_json_ld.mentionedEntities %}
                                                <div class="mb-2">
                                                    <small class="text-muted"><strong>Mentioned Entities:</strong></small><br>
                                                    {% for entity in question.rdf_json_ld.mentionedEntities %}
                                                    <span class="badge bg-info me-1">{{ entity }}</span>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}

                                                {% if question.rdf_json_ld and question.rdf_json_ld.relatedProvisions %}
                                                <div>
                                                    <small class="text-muted"><strong>Related Provisions:</strong></small><br>
                                                    {% for prov in question.rdf_json_ld.relatedProvisions %}
                                                    <span class="badge bg-secondary me-1">{{ prov }}</span>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted">No questions extracted yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Conclusions Column -->
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5><i class="bi bi-check-circle"></i> Board Conclusions</h5>
                                </div>
                                <div class="card-body">
                                    {% if conclusions %}
                                        {% for conclusion in conclusions %}
                                        <div class="card mb-3" id="conclusion-{{ loop.index }}">
                                            <div class="card-header bg-success text-white">
                                                <strong>{{ conclusion.entity_label }}</strong>
                                            </div>
                                            <div class="card-body">
                                                <p>{{ conclusion.entity_definition }}</p>

                                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.answersQuestions %}
                                                <div class="mb-2">
                                                    <small class="text-muted"><strong>Answers:</strong></small><br>
                                                    {% for q in conclusion.rdf_json_ld.answersQuestions %}
                                                    <a href="#question-{{ loop.index }}" class="btn btn-sm btn-outline-warning">
                                                        {{ q }}
                                                    </a>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}

                                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.citedProvisions %}
                                                <div class="mb-2">
                                                    <small class="text-muted"><strong>Cited Provisions:</strong></small><br>
                                                    {% for prov in conclusion.rdf_json_ld.citedProvisions %}
                                                    <span class="badge bg-secondary me-1">{{ prov }}</span>
                                                    {% endfor %}
                                                </div>
                                                {% endif %}

                                                {% if conclusion.rdf_json_ld and conclusion.rdf_json_ld.conclusionType %}
                                                <div>
                                                    <small class="text-muted"><strong>Type:</strong></small>
                                                    <span class="badge bg-dark">{{ conclusion.rdf_json_ld.conclusionType }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted">No conclusions extracted yet.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Institutional Rule Analysis Section (Part D) - Default Open -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#institutionalSection">
                    <i class="bi bi-building me-2"></i> Institutional Rule Analysis (Part D)
                </button>
            </h2>
            <div id="institutionalSection" class="accordion-collapse collapse show" data-bs-parent="#step4Accordion">
                <div class="accordion-body">
                    {% if institutional_analysis %}
                        <!-- Case Significance -->
                        <div class="card mb-3 border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="bi bi-star"></i> Case Significance</h5>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">{{ institutional_analysis.case_significance }}</p>
                            </div>
                        </div>

                        <!-- Principle Tensions -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-lightning"></i> Principle Tensions</h5>
                            </div>
                            <div class="card-body">
                                {% if institutional_analysis.principle_conflict_description %}
                                <div class="alert alert-info mb-3">
                                    <strong>Overview:</strong> {{ institutional_analysis.principle_conflict_description }}
                                </div>
                                {% endif %}

                                {% if institutional_analysis.principle_tensions %}
                                    {% for tension in institutional_analysis.principle_tensions %}
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <h6>{{ tension.principle1 }} <span class="text-muted">vs</span> {{ tension.principle2 }}</h6>
                                            <p class="mb-2">{{ tension.tension_description }}</p>
                                            <small class="text-muted"><strong>Symbolic Significance:</strong> {{ tension.symbolic_significance }}</small>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No principle tensions identified.</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Obligation Conflicts -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Obligation Conflicts</h5>
                            </div>
                            <div class="card-body">
                                {% if institutional_analysis.obligation_conflict_description %}
                                <div class="alert alert-warning mb-3">
                                    <strong>Overview:</strong> {{ institutional_analysis.obligation_conflict_description }}
                                </div>
                                {% endif %}

                                {% if institutional_analysis.obligation_conflicts %}
                                    {% for conflict in institutional_analysis.obligation_conflicts %}
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <strong>{{ conflict.obligation1 }}</strong>
                                                    <span class="badge bg-secondary ms-1">{{ conflict.obligation1_code_section }}</span>
                                                </div>
                                                <span class="text-muted">vs</span>
                                                <div>
                                                    <strong>{{ conflict.obligation2 }}</strong>
                                                    <span class="badge bg-secondary ms-1">{{ conflict.obligation2_code_section }}</span>
                                                </div>
                                            </div>
                                            <p class="mb-0 mt-2">{{ conflict.conflict_description }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No obligation conflicts identified.</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Constraining Factors -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-shield"></i> Constraining Factors</h5>
                            </div>
                            <div class="card-body">
                                {% if institutional_analysis.constraint_influence_description %}
                                <div class="alert alert-secondary mb-3">
                                    <strong>Overview:</strong> {{ institutional_analysis.constraint_influence_description }}
                                </div>
                                {% endif %}

                                {% if institutional_analysis.constraining_factors %}
                                    {% for factor in institutional_analysis.constraining_factors %}
                                    <div class="card mb-2">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <h6 class="mb-0">{{ factor.constraint }}</h6>
                                                <span class="badge bg-info">{{ factor.constraint_type }}</span>
                                            </div>
                                            <p class="mb-0 mt-2">{{ factor.impact_description }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">No constraining factors identified.</p>
                                {% endif %}
                            </div>
                        </div>

                    {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-info-circle"></i> Institutional rule analysis not yet performed. Re-run Step 4 synthesis to generate this analysis.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div> <!-- End Accordion -->
</div>

<!-- Include Cytoscape.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load synthesis data (provisions, questions, conclusions)
    const provisions = {{ provisions_json | tojson | safe }};
    const questions = {{ questions_json | tojson | safe }};
    const conclusions = {{ conclusions_json | tojson | safe }};

    // BUILD SYNTHESIS REASONING GRAPH (LangGraph-style)
    // Shows: Provisions → Questions → Conclusions + Entity mentions
    const elements = [];
    const nodeIds = new Set();

    // Add Provision nodes
    provisions.forEach(function(prov) {
        const nodeId = 'prov_' + prov.id;
        const provCode = prov.rdf_json_ld?.codeProvision || prov.entity_label;

        nodeIds.add(nodeId);
        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: provCode,
                type: 'provision',
                fullText: prov.entity_definition,
                nodeType: 'NSPE Provision'
            }
        });

        // Add edges from provisions to mentioned entities
        if (prov.rdf_json_ld && prov.rdf_json_ld.appliesTo) {
            prov.rdf_json_ld.appliesTo.forEach(function(entity) {
                const entityId = 'entity_' + entity.entity_label.replace(/\s+/g, '_');

                // Add entity node if not exists
                if (!nodeIds.has(entityId)) {
                    nodeIds.add(entityId);
                    elements.push({
                        group: 'nodes',
                        data: {
                            id: entityId,
                            label: entity.entity_label,
                            type: entity.entity_type,
                            reasoning: entity.reasoning,
                            nodeType: 'Entity'
                        }
                    });
                }

                // Add edge: provision → entity
                elements.push({
                    group: 'edges',
                    data: {
                        id: nodeId + '_' + entityId,
                        source: nodeId,
                        target: entityId,
                        label: 'applies to',
                        edgeType: 'provision_to_entity'
                    }
                });
            });
        }
    });

    // Add Question nodes
    questions.forEach(function(q) {
        const nodeId = 'q_' + q.id;
        nodeIds.add(nodeId);

        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: q.entity_label,
                type: 'question',
                fullText: q.entity_definition,
                nodeType: 'Question'
            }
        });

        // Link questions to related provisions
        if (q.rdf_json_ld && q.rdf_json_ld.relatedProvisions) {
            q.rdf_json_ld.relatedProvisions.forEach(function(provCode) {
                // Find provision node
                const provNode = provisions.find(p =>
                    p.rdf_json_ld?.codeProvision === provCode ||
                    p.entity_label.includes(provCode)
                );
                if (provNode) {
                    const provId = 'prov_' + provNode.id;
                    elements.push({
                        group: 'edges',
                        data: {
                            id: provId + '_' + nodeId,
                            source: provId,
                            target: nodeId,
                            label: 'informs',
                            edgeType: 'provision_to_question'
                        }
                    });
                }
            });
        }
    });

    // Add Conclusion nodes
    conclusions.forEach(function(c) {
        const nodeId = 'c_' + c.id;
        nodeIds.add(nodeId);

        elements.push({
            group: 'nodes',
            data: {
                id: nodeId,
                label: c.entity_label,
                type: 'conclusion',
                fullText: c.entity_definition,
                nodeType: 'Conclusion'
            }
        });

        // Link conclusions to questions they answer
        if (c.rdf_json_ld && c.rdf_json_ld.answersQuestions) {
            c.rdf_json_ld.answersQuestions.forEach(function(qNum) {
                const qNode = questions.find(q => q.entity_label.includes(qNum) || q.entity_label.includes('Question_' + qNum));
                if (qNode) {
                    const qId = 'q_' + qNode.id;
                    elements.push({
                        group: 'edges',
                        data: {
                            id: qId + '_' + nodeId,
                            source: qId,
                            target: nodeId,
                            label: 'answered by',
                            edgeType: 'question_to_conclusion'
                        }
                    });
                }
            });
        }
    });

    // Initialize Cytoscape with HIERARCHICAL layout (LangGraph-style)
    const cy = cytoscape({
        container: document.getElementById('cy'),
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': function(ele) {
                        const type = ele.data('type');
                        const colors = {
                            'provision': '#6C757D',  // Gray - Code provisions
                            'question': '#FFC107',   // Yellow - Questions
                            'conclusion': '#28A745', // Green - Conclusions
                            'action': '#343A40',     // Dark - Actions
                            'event': '#6C757D'       // Gray - Events
                        };
                        return colors[type] || '#17A2B8'; // Cyan for entities
                    },
                    'label': 'data(label)',
                    'color': '#fff',
                    'text-valign': 'center',
                    'text-halign': 'center',
                    'font-size': '11px',
                    'font-weight': 'bold',
                    'width': function(ele) {
                        // Larger nodes for Q/C/Provisions
                        const type = ele.data('type');
                        return (type === 'provision' || type === 'question' || type === 'conclusion') ? '60px' : '45px';
                    },
                    'height': function(ele) {
                        const type = ele.data('type');
                        return (type === 'provision' || type === 'question' || type === 'conclusion') ? '60px' : '45px';
                    },
                    'text-wrap': 'wrap',
                    'text-max-width': '100px',
                    'shape': function(ele) {
                        const type = ele.data('type');
                        if (type === 'provision') return 'rectangle';
                        if (type === 'question') return 'diamond';
                        if (type === 'conclusion') return 'round-rectangle';
                        return 'ellipse';
                    },
                    'border-width': 2,
                    'border-color': '#fff'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 3,
                    'line-color': function(ele) {
                        const edgeType = ele.data('edgeType');
                        if (edgeType === 'provision_to_question') return '#6C757D';
                        if (edgeType === 'question_to_conclusion') return '#FFC107';
                        if (edgeType === 'provision_to_entity') return '#17A2B8';
                        return '#ccc';
                    },
                    'target-arrow-color': function(ele) {
                        const edgeType = ele.data('edgeType');
                        if (edgeType === 'provision_to_question') return '#6C757D';
                        if (edgeType === 'question_to_conclusion') return '#FFC107';
                        if (edgeType === 'provision_to_entity') return '#17A2B8';
                        return '#ccc';
                    },
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'label': 'data(label)',
                    'font-size': '9px',
                    'text-rotation': 'autorotate',
                    'text-background-color': '#fff',
                    'text-background-opacity': 0.8,
                    'text-background-padding': '2px'
                }
            }
        ],
        layout: {
            name: 'breadthfirst',  // Hierarchical layout for flow
            directed: true,
            spacingFactor: 1.5,
            padding: 50,
            animate: true,
            animationDuration: 500
        }
    });

    // Graph controls
    document.getElementById('fit-graph').addEventListener('click', function() {
        cy.fit();
    });

    document.getElementById('reset-graph').addEventListener('click', function() {
        cy.layout({
            name: 'cose',
            idealEdgeLength: 100,
            nodeOverlap: 20,
            fit: true
        }).run();
    });

    document.getElementById('show-labels').addEventListener('change', function(e) {
        if (e.target.checked) {
            cy.style().selector('node').style('label', 'data(label)').update();
        } else {
            cy.style().selector('node').style('label', '').update();
        }
    });

    // Node click handler
    cy.on('tap', 'node', function(evt) {
        const node = evt.target;
        const data = node.data();

        // Show entity details in modal or alert
        const details = `
Entity: ${data.label}
Type: ${data.type}
Definition: ${data.definition || 'No definition available'}
URI: ${data.uri}
        `.trim();

        alert(details);
    });


});

// Synthesis Annotations (outside DOMContentLoaded for onclick access)

// Synthesis Annotations Generation
const currentCaseId = {{ case.id }};

function generateSynthesisAnnotations() {
    const btn = document.getElementById('generateAnnotationsBtn');
    const alertDiv = document.getElementById('annotationAlert');
    const message = document.getElementById('annotationMessage');

    // Disable button
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

    // Show processing message
    alertDiv.className = 'alert alert-info alert-dismissible fade show';
    alertDiv.style.display = 'block';
    message.innerHTML = '<strong>Generating synthesis annotations...</strong> This may take a minute.';

    // Call API
    fetch('/scenario_pipeline/case/' + currentCaseId + '/step4/generate_synthesis_annotations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            message.innerHTML = '<strong>Success!</strong> Generated ' + data.counts.total + ' synthesis annotations:<ul class="mb-0 mt-2"><li>' + data.counts.questions + ' questions</li><li>' + data.counts.conclusions + ' conclusions</li><li>' + data.counts.provisions + ' provision citations</li><li>' + data.counts.entity_mentions + ' entity mentions</li></ul><a href="/cases/{{ case.id }}?highlight=synthesis" class="btn btn-sm btn-info mt-2"><i class="bi bi-eye"></i> View Case with Annotations</a>';
        } else {
            // Show error
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            message.innerHTML = '<strong>Error:</strong> ' + (data.error || 'Failed to generate annotations');
        }

        // Re-enable button
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightbulb"></i> Generate Synthesis Annotations';
    })
    .catch(error => {
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        message.innerHTML = '<strong>Error:</strong> ' + error.message;

        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-lightbulb"></i> Generate Synthesis Annotations';
    });
}

// Highlight case citations in citation context
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.citation-context').forEach(function(element) {
        const citation = element.getAttribute('data-citation');
        if (citation) {
            const text = element.innerHTML;
            // Use regex to replace all occurrences of the citation
            const regex = new RegExp(citation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            element.innerHTML = text.replace(regex, '<mark class="bg-warning">' + citation + '</mark>');
        }
    });
});
</script>
{% endblock %}
