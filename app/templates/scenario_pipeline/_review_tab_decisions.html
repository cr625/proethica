{# Step 4 Review -- Decision Points tab.
   Parent provides: case, decision_points, info_link_inline, research_caveat macros
#}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-signpost-split"></i> Decision Points
            {{ info_link_inline('jones-moral-intensity', 'Moral Intensity / Salience (Jones 1991)') }}
        </h5>
        <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#phase3-card" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> View Extraction
        </a>
    </div>
    <div class="card-body">
        {% if decision_points and decision_points|length > 0 %}
        <!-- Validation Score Legend -->
        <div class="alert alert-light border py-2 px-3 mb-3" style="font-size: 0.85rem;">
            <strong>Legend:</strong>
            <span class="ms-2"><i class="bi bi-hand-thumbs-up text-success"></i> PRO</span>
            <span class="ms-2"><i class="bi bi-hand-thumbs-down text-danger"></i> CON</span>
            <span class="mx-3">|</span>
            <span class="badge bg-secondary text-white" style="font-size: 0.75rem;">N%</span>
            <span class="ms-1">= Validation Score</span>
            {{ info_link_inline('argument-validation', 'Role ethics validation (Oakley & Cocking 2001)') }}{{ research_caveat('validation-weighting', 'Validation weighting is heuristic, not from literature') }}
        </div>
        <div class="list-group">
            {% for dp in decision_points %}
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-primary me-2">{{ dp.focus_id or 'DP' ~ loop.index }}</span>
                            <strong>{{ dp.description or dp.entity_label }}</strong>
                            {% if dp.source == 'llm_fallback' %}
                            <span class="badge bg-warning text-dark ms-2" title="Generated by LLM fallback">LLM</span>
                            {% endif %}
                        </div>
                        <p class="mb-2 text-muted">{{ dp.decision_question or dp.entity_definition }}</p>
                        {% if dp.obligations_in_tension %}
                        <div class="mb-2">
                            <small class="text-secondary"><strong>Obligations in tension:</strong></small>
                            <div class="mt-1">
                                {% for obl in dp.obligations_in_tension %}
                                <span class="badge bg-light text-dark border me-1">{{ obl }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        {% if dp.options %}
                        <div>
                            <small class="text-secondary"><strong>Options:</strong></small>
                            <ol class="mb-0 ps-3 mt-1 small">
                                {% for opt in dp.options %}
                                <li>{{ opt.label or opt.description or opt.option_id or opt }}</li>
                                {% endfor %}
                            </ol>
                        </div>
                        {% endif %}
                        {% if dp.arguments %}
                        <div class="mt-3 pt-2 border-top">
                            <small class="text-secondary"><strong>Arguments:</strong></small>
                            <div class="row mt-2">
                                {% for arg in dp.arguments %}
                                <div class="col-md-6 mb-2">
                                    <div class="card border-{{ 'success' if arg.argument_type == 'pro' else 'danger' }} card-sm">
                                        <div class="card-body py-2 px-3">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span>
                                                    <span class="text-{{ 'success' if arg.argument_type == 'pro' else 'danger' }}" title="{{ arg.argument_type|upper }}">
                                                        <i class="bi bi-hand-thumbs-{{ 'up' if arg.argument_type == 'pro' else 'down' }}"></i>
                                                    </span>
                                                    <span class="text-muted small ms-1" title="{% if arg.decision_point_ids and arg.decision_point_ids|length > 1 %}Shared: {{ arg.decision_point_ids|join(', ') }}{% else %}Unique to this DP{% endif %}">{{ arg.argument_id }}</span>
                                                </span>
                                                {% if arg.validation %}
                                                <span class="badge bg-{{ 'success' if arg.validation.is_valid else 'secondary' }} text-white" style="font-size: 0.7rem;" title="Validation Score: Entity grounding (40%) + Founding value compliance (40%) + Professional virtue alignment (20%)">
                                                    Score: {{ (arg.validation.validation_score * 100)|int }}%
                                                </span>
                                                {% endif %}
                                            </div>
                                            <p class="small mb-1"><strong>{{ arg.claim.text if arg.claim else '' }}</strong></p>
                                            {% if arg.warrant %}
                                            <p class="small text-muted mb-0">{{ arg.warrant.text }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% if dp.qc_alignment_score %}
                    <div class="text-end ms-3">
                        <span class="badge {{ 'bg-success' if dp.qc_alignment_score > 0.5 else 'bg-secondary' }}">
                            {{ (dp.qc_alignment_score * 100)|int }}% aligned
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-1"></i> No decision points found.
            <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}#phase3-card">Run Phase 3 synthesis</a> on the Step 4 page first.
        </div>
        {% endif %}
    </div>
</div>
