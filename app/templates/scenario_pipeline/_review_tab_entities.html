{# Step 4 Review -- Entities tab (D3 force graph).
   Requires: step4-entity-graph.js, D3 v7, window.STEP4_CASE_ID
   Parent provides: entity_count (for badge updates)
#}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Full Entity Graph</h5>
            <small class="text-muted"><span id="d3-node-count">Loading...</span></small>
        </div>
        <div>
            <span class="badge me-1" id="d3-pass1" title="Roles, States, Resources" style="background-color: #3b82f6;">Context: 0</span>
            <span class="badge me-1" id="d3-pass2" title="Principles, Obligations, Constraints, Capabilities" style="background-color: #8b5cf6;">Normative: 0</span>
            <span class="badge me-1" id="d3-pass3" title="Actions, Events" style="background-color: #14b8a6;">Temporal: 0</span>
            <span class="badge" id="d3-pass4" title="Provisions, Questions, Conclusions" style="background-color: #64748b;">Synthesis: 0</span>
        </div>
    </div>
    <div class="card-body">
        <!-- D3 Graph Controls - Row 1: Search and Pass Filters -->
        <div class="mb-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <div class="input-group input-group-sm" style="width: 200px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="d3-search" class="form-control" placeholder="Search entities...">
                </div>
            </div>
            <div class="d-flex align-items-center flex-wrap gap-1">
                <span class="me-1 text-muted small">Filter:</span>
                <button class="btn btn-sm btn-outline-secondary d3-filter active" data-pass="all">All</button>
                <button class="btn btn-sm d3-filter" data-pass="1" title="Roles, States, Resources" style="border-color: #3b82f6; color: #3b82f6;">Context</button>
                <button class="btn btn-sm d3-filter" data-pass="2" title="Principles, Obligations, Constraints, Capabilities" style="border-color: #8b5cf6; color: #8b5cf6;">Normative</button>
                <button class="btn btn-sm d3-filter" data-pass="3" title="Actions, Events" style="border-color: #14b8a6; color: #14b8a6;">Temporal</button>
                <button class="btn btn-sm d3-filter" data-pass="4" title="Provisions, Questions, Conclusions" style="border-color: #64748b; color: #64748b;">Synthesis</button>
            </div>
        </div>
        <!-- D3 Graph Controls - Row 2: Layout, Display Options -->
        <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <div class="d-flex align-items-center">
                    <label class="form-label mb-0 me-1 small text-muted">Layout:</label>
                    <select class="form-select form-select-sm" id="d3-layout-select" style="width: 90px;">
                        <option value="force" selected>Force</option>
                        <option value="circular">Circular</option>
                        <option value="grid">Grid</option>
                        <option value="radial">Radial</option>
                    </select>
                </div>
                <div class="form-check form-check-inline mb-0">
                    <input class="form-check-input" type="checkbox" id="d3-hide-unconnected" checked>
                    <label class="form-check-label small" for="d3-hide-unconnected">Hide unconnected</label>
                </div>
            </div>
            <div class="d-flex align-items-center gap-1">
                <button class="btn btn-sm btn-info" id="d3-toggle-hubs" title="Group entities by type (R, P, O, S, Rs, A, E, Ca, Cs)">
                    <i class="bi bi-diagram-2"></i> Type Hubs
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="d3-refresh" title="Refresh graph">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>

        <!-- D3 Graph Container -->
        <div id="d3-graph-card" class="position-relative">
            <div id="d3-graph-container" style="width: 100%; height: 600px; border: 1px solid #ddd; background-color: #fafafa; position: relative;">
                <svg id="d3-graph-svg" style="width: 100%; height: 100%;"></svg>

                <!-- Loading Overlay -->
                <div id="d3-loading-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-none align-items-center justify-content-center" style="background: rgba(255,255,255,0.9); z-index: 50;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-2" role="status"></div>
                        <div class="small text-muted" id="d3-loading-text">Building graph...</div>
                    </div>
                </div>

                <!-- Entity Details Panel -->
                <div id="d3-entity-details" style="position: absolute; top: 10px; right: 10px; width: 320px; max-height: 450px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none; z-index: 100;">
                    <button type="button" class="btn-close float-end" id="d3-close-details"></button>
                    <h6 id="d3-detail-label" class="mb-2" style="border-bottom: 2px solid #666; padding-bottom: 5px;"></h6>
                    <p class="small mb-2">
                        <span class="badge" id="d3-detail-type"></span>
                        <span class="badge bg-secondary" id="d3-detail-pass"></span>
                    </p>
                    <p class="small text-muted mb-2" id="d3-detail-definition"></p>
                    <div id="d3-detail-metadata" class="small mb-2" style="display: none;">
                        <div id="d3-detail-agent" class="mb-1" style="display: none;">
                            <strong class="text-primary">Agent:</strong> <span></span>
                        </div>
                        <div id="d3-detail-temporal" class="mb-1" style="display: none;">
                            <strong class="text-info">When:</strong> <span></span>
                        </div>
                    </div>
                    <p class="small mb-1"><strong>Connections:</strong></p>
                    <ul class="small list-unstyled" id="d3-detail-connections"></ul>
                </div>

                <!-- Zoom Controls -->
                <div style="position: absolute; bottom: 10px; left: 10px; z-index: 100;">
                    <button class="btn btn-sm btn-light" id="d3-zoom-in" title="Zoom In"><i class="bi bi-plus-lg"></i></button>
                    <button class="btn btn-sm btn-light" id="d3-zoom-out" title="Zoom Out"><i class="bi bi-dash-lg"></i></button>
                    <button class="btn btn-sm btn-light" id="d3-zoom-reset" title="Reset View"><i class="bi bi-arrows-fullscreen"></i></button>
                    <button class="btn btn-sm btn-primary" id="d3-fullscreen-btn" title="Full Screen"><i class="bi bi-fullscreen"></i></button>
                    <button class="btn btn-sm btn-warning" id="d3-exit-fullscreen-btn" title="Exit Full Screen" style="display: none;"><i class="bi bi-fullscreen-exit"></i></button>
                </div>
            </div>
        </div>

        <!-- Legend -->
        <div class="mt-3">
            <h6>Entity Types</h6>
            <div id="d3-legend" class="d-flex flex-wrap gap-3"></div>
        </div>
    </div>
</div>
