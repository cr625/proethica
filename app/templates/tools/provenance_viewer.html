{% extends "base.html" %}

{% block title %}PROV-O Provenance Viewer - ProEthica{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="bi bi-diagram-3"></i> PROV-O Provenance Viewer
            </h1>
            <p class="text-muted">
                View complete provenance tracking for LLM interactions, extraction operations, and analytical workflows.
                Based on W3C PROV-O standard for reproducible analysis.
            </p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Activities</h5>
                    <h2 class="mb-0">{{ stats.total_activities }}</h2>
                    <small>Extraction & Analysis Operations</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Entities</h5>
                    <h2 class="mb-0">{{ stats.total_entities }}</h2>
                    <small>Prompts, Responses & Results</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Agents Tracked</h5>
                    <h2 class="mb-0">{{ stats.total_agents }}</h2>
                    <small>LLMs & Extraction Services</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Cases Tracked</h5>
                    <h2 class="mb-0">{{ stats.total_cases_tracked }}</h2>
                    <small>Documents with Provenance</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Cases List -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Cases with Provenance</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div class="list-group">
                        {% for case in recent_cases %}
                        <a href="#" class="list-group-item list-group-item-action" 
                           onclick="loadCaseProvenance({{ case.id }}); return false;">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ case.title|truncate(50) }}</h6>
                                <small class="text-muted">{{ case.activity_count }} activities</small>
                            </div>
                            <p class="mb-1">
                                <span class="badge bg-secondary">{{ case.document_type }}</span>
                            </p>
                            <small class="text-muted">
                                Last activity: {{ case.last_activity.strftime('%Y-%m-%d %H:%M') if case.last_activity else 'N/A' }}
                            </small>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Provenance Details -->
        <div class="col-md-8">
            <div id="provenance-details" style="display: none;">
                <!-- Case Header -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 id="case-title" class="card-title"></h5>
                        <div class="row text-center">
                            <div class="col">
                                <strong id="total-activities">0</strong><br>
                                <small>Activities</small>
                            </div>
                            <div class="col">
                                <strong id="total-entities">0</strong><br>
                                <small>Entities</small>
                            </div>
                            <div class="col">
                                <strong id="successful-activities">0</strong><br>
                                <small>Successful</small>
                            </div>
                            <div class="col">
                                <strong id="failed-activities">0</strong><br>
                                <small>Failed</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs" id="provenanceTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="timeline-tab" data-bs-toggle="tab" 
                                data-bs-target="#timeline" type="button">
                            <i class="bi bi-clock-history"></i> Timeline
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="entities-tab" data-bs-toggle="tab" 
                                data-bs-target="#entities" type="button">
                            <i class="bi bi-file-earmark-text"></i> Entities
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="graph-tab" data-bs-toggle="tab" 
                                data-bs-target="#graph" type="button">
                            <i class="bi bi-diagram-2"></i> Graph
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="provenanceTabContent">
                    <!-- Timeline Tab -->
                    <div class="tab-pane fade show active" id="timeline">
                        <div class="card">
                            <div class="card-body">
                                <div id="timeline-content" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Timeline will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Entities Tab -->
                    <div class="tab-pane fade" id="entities">
                        <div class="card">
                            <div class="card-body">
                                <div id="entities-content" style="max-height: 500px; overflow-y: auto;">
                                    <!-- Entities will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Graph Tab -->
                    <div class="tab-pane fade" id="graph">
                        <div class="card">
                            <div class="card-body">
                                <div id="graph-container" style="height: 500px;">
                                    <canvas id="provenance-graph"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Welcome Message -->
            <div id="welcome-message" class="card">
                <div class="card-body text-center py-5">
                    <i class="bi bi-diagram-3" style="font-size: 4rem; color: #6c757d;"></i>
                    <h4 class="mt-3">Select a Case to View Provenance</h4>
                    <p class="text-muted">
                        Choose a case from the list on the left to explore its complete provenance graph,
                        including all LLM interactions, extraction operations, and analytical workflows.
                    </p>
                    <hr>
                    <h5>What is PROV-O Provenance?</h5>
                    <p class="text-muted mb-0">
                        PROV-O is the W3C standard for representing provenance information. It tracks:
                    </p>
                    <ul class="list-unstyled mt-3">
                        <li><strong>Agents:</strong> Who performed actions (LLMs, extractors, users)</li>
                        <li><strong>Activities:</strong> What operations were performed</li>
                        <li><strong>Entities:</strong> What data was used and generated</li>
                        <li><strong>Relationships:</strong> How everything is connected</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Entity Detail Modal -->
<div class="modal fade" id="entityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Entity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="entity-modal-content">
                <!-- Entity details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Activity Detail Modal -->
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="activity-modal-content">
                <!-- Activity details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let currentCaseId = null;
let currentProvenanceData = null;

function loadCaseProvenance(caseId) {
    currentCaseId = caseId;
    
    // Show loading state
    document.getElementById('welcome-message').style.display = 'none';
    document.getElementById('provenance-details').style.display = 'block';
    
    // Fetch provenance data
    fetch(`/api/provenance/case/${caseId}`)
        .then(response => response.json())
        .then(data => {
            currentProvenanceData = data;
            displayProvenanceData(data);
        })
        .catch(error => {
            console.error('Error loading provenance:', error);
            alert('Failed to load provenance data');
        });
}

function displayProvenanceData(data) {
    // Update header
    document.getElementById('case-title').textContent = data.document.title;
    document.getElementById('total-activities').textContent = data.stats.total_activities;
    document.getElementById('total-entities').textContent = data.stats.total_entities;
    document.getElementById('successful-activities').textContent = data.stats.successful_activities;
    document.getElementById('failed-activities').textContent = data.stats.failed_activities;
    
    // Display timeline
    displayTimeline(data.timeline);
    
    // Display entities
    displayEntities(data.entities);
    
    // Display graph
    displayGraph(data.graph);
}

function displayTimeline(timeline) {
    const container = document.getElementById('timeline-content');
    container.innerHTML = '';

    // Icon and color mapping for activity types
    const activityStyles = {
        'composition': { icon: 'bi-gear', color: 'primary', label: 'Algorithmic' },
        'alignment': { icon: 'bi-check2-square', color: 'info', label: 'Alignment' },
        'enrichment': { icon: 'bi-link-45deg', color: 'success', label: 'MCP Resolution' },
        'synthesis': { icon: 'bi-robot', color: 'warning', label: 'LLM Synthesis' },
        'storage': { icon: 'bi-database', color: 'secondary', label: 'Storage' },
        'extraction': { icon: 'bi-file-earmark-text', color: 'primary', label: 'Extraction' },
        'analysis': { icon: 'bi-graph-up', color: 'info', label: 'Analysis' },
        'llm_query': { icon: 'bi-chat-left-text', color: 'warning', label: 'LLM Query' }
    };

    timeline.forEach(item => {
        const timelineItem = document.createElement('div');
        const style = activityStyles[item.activity_type] || { icon: 'bi-circle', color: 'secondary', label: item.activity_type };

        // Determine border color based on activity type
        timelineItem.className = `timeline-item mb-3 p-3 border rounded border-${style.color}`;

        const statusBadge = item.status === 'completed' ? 'success' :
                           item.status === 'failed' ? 'danger' : 'warning';

        const duration = item.duration_ms ? `${item.duration_ms}ms` : 'N/A';

        // Format activity name for display
        const displayName = formatActivityName(item.name);

        timelineItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h6><i class="bi ${style.icon} text-${style.color} me-2"></i>${displayName}</h6>
                    <p class="mb-1">
                        <span class="badge bg-${statusBadge}">${item.status}</span>
                        <span class="badge bg-${style.color}">${style.label}</span>
                    </p>
                    <small class="text-muted">
                        Agent: ${item.agent ? item.agent.name : 'Unknown'} |
                        Duration: ${duration}
                    </small>
                </div>
                <button class="btn btn-sm btn-outline-${style.color}" onclick="showActivityDetails(${item.id})">
                    <i class="bi bi-info-circle"></i> Details
                </button>
            </div>
            <small class="text-muted">
                ${new Date(item.started_at).toLocaleString()}
            </small>
        `;

        container.appendChild(timelineItem);
    });
}

function formatActivityName(name) {
    // Convert snake_case activity names to readable format
    const nameMap = {
        'phase3_e1e3_algorithmic': 'Phase 3: E1-E3 Algorithmic Composition',
        'phase3_qc_alignment': 'Phase 3: Q&C Alignment Scoring',
        'phase3_mcp_entity_resolution': 'Phase 3: MCP Entity Resolution',
        'phase3_llm_refinement': 'Phase 3: LLM Refinement',
        'phase3_decision_points_stored': 'Phase 3: Decision Points Stored',
        'step4_phase3_decision': 'Step 4 Phase 3: Decision Point Synthesis',
        'step4_provisions': 'Step 4: Code Provisions',
        'step4_questions': 'Step 4: Ethical Questions',
        'step4_conclusions': 'Step 4: Board Conclusions',
        'step4_transformation': 'Step 4: Transformation Analysis',
        'step4_rich_analysis': 'Step 4: Rich Analysis',
        'step4_phase4_narrative': 'Step 4 Phase 4: Narrative Construction'
    };
    return nameMap[name] || name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function displayEntities(entities) {
    const container = document.getElementById('entities-content');
    container.innerHTML = '';
    
    // Group entities by type
    const grouped = {};
    entities.forEach(entity => {
        if (!grouped[entity.type]) {
            grouped[entity.type] = [];
        }
        grouped[entity.type].push(entity);
    });
    
    // Display grouped entities
    Object.entries(grouped).forEach(([type, items]) => {
        const section = document.createElement('div');
        section.className = 'mb-4';
        section.innerHTML = `<h6 class="text-muted">${type} (${items.length})</h6>`;
        
        items.forEach(entity => {
            const entityCard = document.createElement('div');
            entityCard.className = 'card mb-2';
            entityCard.innerHTML = `
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex: 1;">
                            <strong>${entity.name}</strong><br>
                            <small class="text-muted">${entity.preview}</small>
                            ${entity.confidence ? `<br><small>Confidence: ${(entity.confidence * 100).toFixed(1)}%</small>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-primary" onclick="showEntityDetails(${entity.id})">
                            <i class="bi bi-eye"></i> View
                        </button>
                    </div>
                </div>
            `;
            section.appendChild(entityCard);
        });
        
        container.appendChild(section);
    });
}

function displayGraph(graphData) {
    // Simple text representation for now
    const container = document.getElementById('graph-container');
    container.innerHTML = `
        <div class="p-3">
            <h6>Provenance Graph Summary</h6>
            <ul>
                <li>Agents: ${graphData.nodes.agents.length}</li>
                <li>Activities: ${graphData.nodes.activities.length}</li>
                <li>Entities: ${graphData.nodes.entities.length}</li>
            </ul>
            <h6>Relationships</h6>
            <ul>
                <li>wasGeneratedBy: ${graphData.edges.wasGeneratedBy.length} edges</li>
                <li>wasDerivedFrom: ${graphData.edges.wasDerivedFrom.length} edges</li>
                <li>wasAssociatedWith: ${graphData.edges.wasAssociatedWith.length} edges</li>
                <li>used: ${graphData.edges.used.length} edges</li>
                <li>wasInformedBy: ${graphData.edges.wasInformedBy.length} edges</li>
            </ul>
            <p class="text-muted mt-3">
                <i class="bi bi-info-circle"></i> Interactive graph visualization coming soon.
                For now, use the Timeline and Entities tabs to explore provenance.
            </p>
        </div>
    `;
}

function showEntityDetails(entityId) {
    fetch(`/api/provenance/entity/${entityId}`)
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('entity-modal-content');
            
            // Format content based on type
            let contentDisplay = '';
            let llmMetadata = '';
            
            if (data.entity.type === 'prompt' || data.entity.type === 'response') {
                contentDisplay = `<pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">${escapeHtml(data.entity.content)}</pre>`;
                
                // Extract LLM metadata for prompts and responses
                if (data.entity.entity_metadata) {
                    const meta = data.entity.entity_metadata;
                    if (meta.model || meta.usage) {
                        llmMetadata = `
                            <h6 class="mt-3">LLM Metadata</h6>
                            <table class="table table-sm">
                                ${meta.model ? `<tr><th>Model:</th><td>${meta.model}</td></tr>` : ''}
                                ${meta.model_params ? `<tr><th>Parameters:</th><td>${JSON.stringify(meta.model_params)}</td></tr>` : ''}
                                ${meta.extraction_type ? `<tr><th>Extraction Type:</th><td>${meta.extraction_type}</td></tr>` : ''}
                                ${meta.uses_mcp !== undefined ? `<tr><th>Uses MCP Context:</th><td>${meta.uses_mcp ? 'Yes' : 'No'}</td></tr>` : ''}
                                ${meta.usage ? `
                                    <tr><th>Token Usage:</th><td>
                                        Input: ${meta.usage.input_tokens || meta.usage.prompt_tokens || 'N/A'}<br>
                                        Output: ${meta.usage.output_tokens || meta.usage.completion_tokens || 'N/A'}<br>
                                        Total: ${meta.usage.total_tokens || 'N/A'}
                                    </td></tr>
                                ` : ''}
                            </table>
                        `;
                    }
                }
            } else {
                try {
                    const parsed = JSON.parse(data.entity.content);
                    contentDisplay = `<pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">${JSON.stringify(parsed, null, 2)}</pre>`;
                } catch {
                    contentDisplay = `<pre class="bg-light p-3" style="max-height: 300px; overflow-y: auto;">${escapeHtml(data.entity.content)}</pre>`;
                }
            }
            
            modal.innerHTML = `
                <h6>Entity: ${data.entity.name}</h6>
                <table class="table table-sm">
                    <tr><th>Type:</th><td><span class="badge bg-info">${data.entity.type}</span></td></tr>
                    <tr><th>Size:</th><td>${data.entity.content_size} bytes</td></tr>
                    <tr><th>Hash:</th><td><small>${data.entity.content_hash}</small></td></tr>
                    ${data.entity.confidence_score ? `<tr><th>Confidence:</th><td>${(data.entity.confidence_score * 100).toFixed(1)}%</td></tr>` : ''}
                    <tr><th>Created:</th><td>${new Date(data.entity.created_at).toLocaleString()}</td></tr>
                </table>
                
                <h6>Content</h6>
                ${contentDisplay}
                
                ${llmMetadata}
                
                ${data.derived_from.length > 0 ? `
                    <h6>Derived From</h6>
                    <ul>
                        ${data.derived_from.map(d => `<li>${d.entity_name} (${d.derivation_type})</li>`).join('')}
                    </ul>
                ` : ''}
                
                ${data.derives.length > 0 ? `
                    <h6>Derives</h6>
                    <ul>
                        ${data.derives.map(d => `<li>${d.entity_name} (${d.derivation_type})</li>`).join('')}
                    </ul>
                ` : ''}
            `;
            
            new bootstrap.Modal(document.getElementById('entityModal')).show();
        });
}

function showActivityDetails(activityId) {
    fetch(`/api/provenance/activity/${activityId}`)
        .then(response => response.json())
        .then(data => {
            const modal = document.getElementById('activity-modal-content');

            const duration = data.activity.duration_ms ? `${data.activity.duration_ms}ms` : 'N/A';
            const displayName = formatActivityName(data.activity.name);

            // Format execution plan for display
            let executionPlanHtml = '';
            if (data.activity.execution_plan && Object.keys(data.activity.execution_plan).length > 0) {
                executionPlanHtml = formatExecutionPlan(data.activity.execution_plan, data.activity.name);
            }

            modal.innerHTML = `
                <h6>Activity: ${displayName}</h6>
                <table class="table table-sm">
                    <tr><th>Type:</th><td>${data.activity.type}</td></tr>
                    <tr><th>Status:</th><td><span class="badge bg-${data.activity.status === 'completed' ? 'success' : 'danger'}">${data.activity.status}</span></td></tr>
                    <tr><th>Duration:</th><td>${duration}</td></tr>
                    <tr><th>Started:</th><td>${new Date(data.activity.started_at).toLocaleString()}</td></tr>
                    ${data.activity.ended_at ? `<tr><th>Ended:</th><td>${new Date(data.activity.ended_at).toLocaleString()}</td></tr>` : ''}
                    ${data.activity.error_message ? `<tr><th>Error:</th><td class="text-danger">${data.activity.error_message}</td></tr>` : ''}
                </table>

                ${data.agent ? `
                    <h6>Agent</h6>
                    <p><i class="bi bi-cpu me-1"></i> ${data.agent.name} <span class="badge bg-secondary">${data.agent.type}</span></p>
                ` : ''}

                ${executionPlanHtml}

                ${data.generated.length > 0 ? `
                    <h6>Generated Entities</h6>
                    <ul class="list-unstyled">
                        ${data.generated.map(e => `<li><i class="bi bi-arrow-right-circle text-success me-1"></i> ${e.entity_name} <span class="badge bg-info">${e.entity_type}</span></li>`).join('')}
                    </ul>
                ` : ''}

                ${data.used.length > 0 ? `
                    <h6>Used Entities</h6>
                    <ul class="list-unstyled">
                        ${data.used.map(e => `<li><i class="bi bi-arrow-left-circle text-primary me-1"></i> ${e.entity_name} <span class="badge bg-secondary">${e.usage_role}</span></li>`).join('')}
                    </ul>
                ` : ''}
            `;

            new bootstrap.Modal(document.getElementById('activityModal')).show();
        });
}

function formatExecutionPlan(plan, activityName) {
    // Special formatting for different activity types
    let html = '<h6><i class="bi bi-clipboard-data me-1"></i> Execution Details</h6><div class="bg-light p-2 rounded small">';

    if (activityName.includes('mcp_entity_resolution')) {
        // MCP resolution specific formatting
        html += '<div class="mb-2"><strong>Entity Resolution:</strong></div>';
        html += `<div class="ms-2">
            <span class="badge bg-success me-1">${plan.mcp_resolved || 0} from MCP</span>
            <span class="badge bg-warning me-1">${plan.local_resolved || 0} from Local</span>
            <span class="badge bg-secondary">${plan.not_found || 0} not found</span>
        </div>`;
        if (plan.total_uris) {
            html += `<div class="ms-2 mt-1">Total URIs processed: ${plan.total_uris}</div>`;
        }
    } else if (activityName.includes('e1e3')) {
        // E1-E3 composition formatting
        html += '<div class="mb-1"><strong>E1 Obligations:</strong> ' + (plan.e1_obligations || 0) + ' (' + (plan.e1_decision_relevant || 0) + ' decision-relevant)</div>';
        html += '<div class="mb-1"><strong>E2 Action Sets:</strong> ' + (plan.e2_action_sets || 0) + '</div>';
        html += '<div class="mb-1"><strong>E3 Candidates:</strong> ' + (plan.e3_candidates || 0) + '</div>';
        if (plan.e1_used_llm_fallback) {
            html += '<div class="text-info"><i class="bi bi-robot me-1"></i> Used LLM fallback for E1</div>';
        }
    } else if (activityName.includes('qc_alignment')) {
        // Q&C alignment formatting
        html += '<div class="mb-1"><strong>Candidates Scored:</strong> ' + (plan.candidates_scored || 0) + '</div>';
        html += '<div class="mb-1"><strong>High Alignment (>0.5):</strong> <span class="badge bg-success">' + (plan.high_alignment_count || 0) + '</span></div>';
    } else if (activityName.includes('llm_refinement')) {
        // LLM refinement formatting
        html += '<div class="mb-1"><strong>Input Candidates:</strong> ' + (plan.input_candidates || 0) + '</div>';
        html += '<div class="mb-1"><strong>High Alignment:</strong> ' + (plan.high_alignment_candidates || 0) + '</div>';
        html += '<div class="mb-1"><strong>Output Decision Points:</strong> <span class="badge bg-primary">' + (plan.output_decision_points || 0) + '</span></div>';
    } else if (activityName.includes('stored')) {
        // Storage formatting
        html += '<div class="mb-1"><strong>Decision Points Stored:</strong> <span class="badge bg-primary">' + (plan.canonical_count || 0) + '</span></div>';
        html += '<div class="mb-1"><strong>Storage Target:</strong> ' + (plan.stored_to || 'database') + '</div>';
    } else {
        // Generic formatting
        for (const [key, value] of Object.entries(plan)) {
            const formattedKey = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            html += `<div class="mb-1"><strong>${formattedKey}:</strong> ${JSON.stringify(value)}</div>`;
        }
    }

    html += '</div>';
    return html;
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<style>
.timeline-item {
    border-left: 3px solid #007bff !important;
}
.timeline-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}