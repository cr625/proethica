{% extends "base.html" %}

{% block title %}Edit {{ concept | title }} Template - ProEthica{% endblock %}

{% block styles %}
<style>
/* ============================================
   PROMPT EDITOR - 3-COLUMN LAYOUT
   ============================================ */

/* Main grid container */
div.editor-container {
    display: grid !important;
    grid-template-columns: 160px 1fr 280px !important;
    grid-template-areas: "sidebar main reference" !important;
    gap: 10px !important;
    height: calc(100vh - 110px) !important;
    min-height: 500px !important;
    width: 100% !important;
}

/* Responsive: narrower columns */
@media (max-width: 1200px) {
    div.editor-container {
        grid-template-columns: 140px 1fr 240px !important;
    }
}

/* Mobile: stack vertically */
@media (max-width: 900px) {
    div.editor-container {
        grid-template-columns: 1fr !important;
        grid-template-areas: "sidebar" "main" "reference" !important;
        height: auto !important;
    }
    .sidebar { max-height: 100px; overflow: hidden; }
}

/* ============================================
   SIDEBAR - Left Column
   ============================================ */
div.sidebar {
    grid-area: sidebar !important;
    display: block !important;
    background: #f8f9fa !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 8px !important;
    padding: 10px !important;
    overflow-y: auto !important;
}
/* Sidebar step groups */
.sidebar-step {
    display: block !important;
    margin-bottom: 12px !important;
}
.sidebar-step-header {
    display: block !important;
    font-weight: 600 !important;
    font-size: 0.7rem !important;
    padding: 4px 8px !important;
    border-radius: 4px !important;
    margin-bottom: 4px !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}
/* Sidebar concept links - MUST be block to stack vertically */
a.sidebar-concept {
    display: flex !important;
    align-items: center !important;
    padding: 5px 8px !important;
    border-radius: 4px !important;
    margin-bottom: 2px !important;
    text-decoration: none !important;
    color: #333 !important;
    font-size: 0.8rem !important;
    width: 100% !important;
}
a.sidebar-concept:hover { background: #e9ecef !important; color: #333 !important; }
a.sidebar-concept.active { background: #007bff !important; color: white !important; }
a.sidebar-concept.active:hover { background: #0056b3 !important; }
.sidebar-concept-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    margin-right: 0.4rem;
}

/* ============================================
   MAIN PANEL - Center Column
   ============================================ */
div.main-panel {
    grid-area: main !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
    border-radius: 8px !important;
    border: 1px solid #dee2e6 !important;
    background: white !important;
    min-height: 0 !important;
}
.main-header {
    padding: 0.5rem 0.75rem;
    background: linear-gradient(90deg, {{ concept_color }}15 0%, #f8f9fa 100%);
    border-bottom: 1px solid #dee2e6;
}
.main-tabs {
    display: flex;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}
.main-tab {
    padding: 0.5rem 1rem;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    color: #6c757d;
}
.main-tab:hover { background: #e9ecef; }
.main-tab.active {
    color: #007bff;
    border-bottom-color: #007bff;
    background: white;
}
.main-body {
    flex-grow: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}
.tab-content {
    flex-grow: 1;
    overflow: hidden;
    display: none;
}
.tab-content.active {
    display: flex;
    flex-direction: column;
}
.main-footer {
    padding: 0.4rem 0.75rem;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
}

/* Template editor */
.template-textarea {
    flex-grow: 1;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.8rem;
    line-height: 1.5;
    padding: 0.75rem;
    border: none;
    resize: none;
    background: #1e1e1e;
    color: #d4d4d4;
}
.template-textarea:focus { outline: none; }

/* Preview panel */
.preview-controls {
    padding: 0.5rem 0.75rem;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.preview-select { font-size: 0.8rem; }
.preview-body {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0.75rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 0.85rem;
    line-height: 1.6;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    margin: 0.5rem;
    color: #495057;
}
.preview-body .preview-section {
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #dee2e6;
}
.preview-body .preview-header {
    font-weight: 600;
    color: #212529;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}
.preview-body .preview-task {
    background: #e7f1ff;
    border-left: 3px solid #0d6efd;
    padding: 0.5rem 0.75rem;
    margin: 0.5rem 0;
    border-radius: 0 4px 4px 0;
}
.preview-body .preview-case-text {
    background: #fff;
    border: 1px solid #dee2e6;
    padding: 0.75rem;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    font-size: 0.8rem;
    white-space: pre-wrap;
}
.preview-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #6c757d;
    flex-direction: column;
}

/* Test panel */
.test-controls {
    padding: 0.5rem 0.75rem;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    gap: 0.5rem;
    align-items: center;
}
.test-results {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0.75rem;
}
.test-section {
    margin-bottom: 0.75rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}
.test-section-header {
    padding: 0.4rem 0.6rem;
    background: #f8f9fa;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.8rem;
    font-weight: 500;
}
.test-section-body {
    padding: 0.5rem;
    font-family: monospace;
    font-size: 0.75rem;
    background: #1e1e1e;
    color: #d4d4d4;
    white-space: pre-wrap;
    overflow-y: auto;
}
.test-section.collapsed .test-section-body { display: none; }
.entity-card {
    padding: 0.4rem 0.6rem;
    background: #f8f9fa;
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
}

/* ============================================
   REFERENCE PANEL - Right Column
   ============================================ */
div.reference-panel {
    grid-area: reference !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
    background: #f8f9fa !important;
    border-radius: 8px !important;
    border: 1px solid #dee2e6 !important;
    min-height: 0 !important;
}
.reference-header {
    padding: 0.4rem 0.6rem;
    background: #e9ecef;
    font-weight: 600;
    font-size: 0.8rem;
    border-bottom: 1px solid #dee2e6;
}
.reference-body {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0.5rem;
}
.ref-section {
    margin-bottom: 0.75rem;
}
.ref-section-title {
    font-weight: 600;
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 0.3rem;
    text-transform: uppercase;
}
.var-item {
    padding: 0.4rem;
    background: white;
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
    border: 1px solid #dee2e6;
}
.var-name {
    font-family: monospace;
    font-weight: 600;
    color: #0d6efd;
    font-size: 0.8rem;
}
.var-desc {
    color: #6c757d;
    font-size: 0.75rem;
    margin-top: 0.15rem;
}
.var-meta {
    font-size: 0.7rem;
    color: #adb5bd;
    margin-top: 0.15rem;
}
.schema-group {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    margin-bottom: 0.25rem;
}
.schema-group-header {
    padding: 0.3rem 0.4rem;
    background: #f8f9fa;
    font-weight: 500;
    font-size: 0.75rem;
    border-bottom: 1px solid #eee;
}
.schema-field {
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
    font-family: monospace;
    display: flex;
    justify-content: space-between;
}
.schema-type { color: #6c757d; }

/* Pipeline visualization */
.pipeline-viz {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.4rem;
}
.pipeline-step {
    display: flex;
    align-items: center;
    padding: 0.2rem 0;
    font-size: 0.7rem;
}
.pipeline-step::before {
    content: '';
    width: 6px;
    height: 6px;
    background: #28a745;
    border-radius: 50%;
    margin-right: 0.4rem;
}
.pipeline-arrow {
    text-align: center;
    color: #6c757d;
    font-size: 0.6rem;
    padding: 0.1rem 0;
}

/* Status */
.status-indicator {
    display: inline-flex;
    align-items: center;
    font-size: 0.75rem;
}
.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 0.3rem;
}
.status-saved { background: #28a745; }
.status-unsaved { background: #ffc107; }
.status-saving { background: #17a2b8; }

/* Extractor info */
.extractor-badge {
    font-size: 0.7rem;
    color: #6c757d;
    background: #e9ecef;
    padding: 0.15rem 0.4rem;
    border-radius: 0.2rem;
    font-family: monospace;
}

/* Clickable variables */
.var-clickable {
    cursor: pointer;
    transition: background-color 0.15s;
}
.var-clickable:hover {
    background: #e3f2fd !important;
}

/* Extra small button */
.btn-xs {
    padding: 0.1rem 0.3rem;
    font-size: 0.7rem;
    line-height: 1.2;
}

/* Variable preview modal */
.var-preview-content {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1rem;
    border-radius: 0.5rem;
    font-family: monospace;
    font-size: 0.8rem;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 400px;
    overflow-y: auto;
}
.var-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}
.var-preview-meta {
    font-size: 0.75rem;
    color: #6c757d;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-2">
    <!-- Compact Header -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0">
                <span class="badge" style="background-color: {{ concept_color }};">{{ concept | title }}</span>
                {% if template %}v{{ template.version }}{% endif %}
            </h5>
            {% if template and template.extractor_file %}
            <span class="extractor-badge">{{ template.extractor_file.split('/')[-1] }}</span>
            {% endif %}
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-success" id="saveBtn" onclick="saveTemplate()" disabled>
                <i class="bi bi-check-lg"></i> Save
            </button>
        </div>
    </div>

    <!-- Global Case Selector -->
    <div class="d-flex align-items-center gap-3 mb-2 p-2 bg-light rounded border">
        <label class="form-label mb-0 text-muted small fw-bold">Test Case:</label>
        <select class="form-select form-select-sm" id="globalCaseSelect" style="width: 300px;" onchange="onGlobalCaseChange()">
            {% for case in cases_with_extractions %}
            <option value="{{ case.id }}">{{ case.title[:60] }}{% if case.title|length > 60 %}...{% endif %}</option>
            {% endfor %}
        </select>
        <select class="form-select form-select-sm" id="globalSectionSelect" style="width: 130px;" onchange="onSectionChange()">
            <option value="facts">Facts</option>
            <option value="discussion">Discussion</option>
        </select>
        <span class="text-muted small" id="caseStatus"></span>
    </div>

    <!-- Main Editor Layout -->
    <div class="editor-container">
        <!-- Left: Concept Navigation -->
        <div class="sidebar">
            {% for step_item in pipeline_steps %}
            <div class="sidebar-step">
                <div class="sidebar-step-header" style="background: {{ step_item.color }}20; color: {{ step_item.color }};">
                    Step {{ step_item.step }}{% if step_item.get('read_only') %} <span style="font-size: 0.6rem; opacity: 0.7;">(View)</span>{% endif %}
                </div>
                {% for c in step_item.concepts %}
                {% if step_item.step == 4 %}
                <a href="{{ url_for('prompt_editor.view_step4_phase', phase=c) }}"
                   class="sidebar-concept">
                    <span class="sidebar-concept-dot" style="background: {{ concept_colors.get(c, '#6c757d') }};"></span>
                    {{ c | replace('_', ' ') | title }}
                </a>
                {% else %}
                <a href="{{ url_for('prompt_editor.edit_template', step=step_item.step, concept=c, domain=selected_domain) }}"
                   class="sidebar-concept {% if c == concept %}active{% endif %}">
                    <span class="sidebar-concept-dot" style="background: {{ concept_colors.get(c, '#6c757d') }};"></span>
                    {{ c | title }}
                </a>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>

        <!-- Center: Editor with Tabs -->
        <div class="main-panel">
            {% if template %}
            <div class="main-tabs">
                <div class="main-tab active" onclick="switchMainTab('template')">
                    <i class="bi bi-code-slash"></i> Template
                </div>
                <div class="main-tab" onclick="switchMainTab('preview')">
                    <i class="bi bi-eye"></i> Preview
                </div>
                <div class="main-tab" onclick="switchMainTab('test')">
                    <i class="bi bi-play-circle"></i> Test
                </div>
                <div class="main-tab" onclick="switchMainTab('history')">
                    <i class="bi bi-clock-history"></i> History
                </div>
            </div>
            <div class="main-body">
                <!-- Template Tab -->
                <div class="tab-content active" id="tab-template">
                    <textarea class="template-textarea" id="templateText"
                              onchange="markUnsaved()" oninput="markUnsaved()">{{ template.template_text }}</textarea>
                </div>

                <!-- Preview Tab -->
                <div class="tab-content" id="tab-preview">
                    <div class="preview-controls">
                        <span class="text-muted small" id="previewStatus"></span>
                        <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="renderPreview()" title="Refresh preview">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="preview-body" id="previewBody">
                        <div class="preview-placeholder">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                            <p class="mt-2 mb-0">Loading preview...</p>
                        </div>
                    </div>
                </div>

                <!-- Test Tab -->
                <div class="tab-content" id="tab-test">
                    <div class="test-controls">
                        <button class="btn btn-sm btn-warning" onclick="runTest()" id="testBtn">
                            <i class="bi bi-lightning"></i> Run Test Extraction
                        </button>
                        <span class="text-muted small" id="testStatus"></span>
                    </div>
                    <div class="test-results" id="testResults">
                        <div class="preview-placeholder">
                            <i class="bi bi-lightning" style="font-size: 2rem;"></i>
                            <p class="mt-2 mb-0">Select a case above, then run a test extraction</p>
                            <small class="text-muted">This will execute the prompt with the LLM</small>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-content" id="tab-history">
                    <div style="padding: 0.75rem; overflow-y: auto; height: 100%;">
                        <h6>Version History</h6>
                        {% if versions %}
                        {% for version in versions %}
                        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                            <div>
                                <strong>v{{ version.version_number }}</strong>
                                <small class="text-muted ms-2">{{ version.changed_at.strftime('%Y-%m-%d %H:%M') if version.changed_at else '' }}</small>
                                {% if version.change_description %}
                                <div class="small text-muted">{{ version.change_description }}</div>
                                {% endif %}
                            </div>
                            <button class="btn btn-sm btn-outline-warning" onclick="revertToVersion({{ version.version_number }})">
                                Revert
                            </button>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted">No version history yet. Save changes to create versions.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="main-footer">
                <div class="status-indicator" id="statusIndicator">
                    <span class="status-dot status-saved"></span>
                    <span id="statusText">Saved</span>
                </div>
                <div>
                    <span class="text-muted" id="charCount">{{ template.template_text | length }} chars</span>
                </div>
            </div>
            {% else %}
            <div class="d-flex align-items-center justify-content-center h-100">
                <div class="text-center text-muted">
                    <i class="bi bi-file-earmark-x" style="font-size: 3rem;"></i>
                    <h5 class="mt-2">No Template Found</h5>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right: Reference Panel -->
        <div class="reference-panel">
            <div class="reference-header">
                <i class="bi bi-info-circle"></i> Reference
            </div>
            <div class="reference-body">
                <!-- Variable Preview -->
                <div class="ref-section">
                    <div class="ref-section-title d-flex justify-content-between align-items-center">
                        <span>Template Variables</span>
                        <button class="btn btn-xs btn-outline-primary" onclick="previewVariables()" title="Preview all resolved values">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                    <div id="detectedVariables">
                        {% if template %}
                        {% set detected_vars = template.get_template_variables() %}
                        {% if detected_vars %}
                        {% for var_name in detected_vars %}
                        <div class="var-item var-clickable" onclick="previewSingleVariable('{{ var_name }}')" title="Click to preview value">
                            <div class="var-name d-flex justify-content-between">
                                <span>{{ "{{ " ~ var_name ~ " }}" }}</span>
                                <i class="bi bi-box-arrow-up-right text-muted" style="font-size: 0.7rem;"></i>
                            </div>
                            {% if template.variable_builders and var_name in template.variable_builders %}
                            <div class="var-desc">{{ template.variable_builders[var_name].get('description', '') }}</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted small">No variables detected in template</p>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Output Schema -->
                <div class="ref-section">
                    <div class="ref-section-title">Output Schema</div>
                    {% if template and template.output_schema and template.output_schema is mapping %}
                    {% for key, schema_info in template.output_schema.items() %}
                    <div class="schema-group">
                        <div class="schema-group-header">
                            {{ key }}
                            {% if schema_info.get('dataclass') %}<small class="text-muted">({{ schema_info.get('dataclass') }})</small>{% endif %}
                        </div>
                        {% if schema_info.get('fields') and schema_info.get('fields') is mapping %}
                        {% for field_name, field_info in schema_info.get('fields').items() %}
                        <div class="schema-field">
                            <span>{{ field_name }}{% if field_info.get('required') %}<span class="text-danger">*</span>{% endif %}</span>
                            <span class="schema-type">{{ field_info.get('type', '') }}</span>
                        </div>
                        {% endfor %}
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted small">No schema documented</p>
                    {% endif %}
                </div>

                <!-- Pipeline -->
                <div class="ref-section">
                    <div class="ref-section-title">Processing Pipeline</div>
                    <div class="pipeline-viz">
                        <div class="pipeline-step">Template + Variables</div>
                        <div class="pipeline-arrow">↓ Jinja2 render</div>
                        <div class="pipeline-step">Rendered Prompt</div>
                        <div class="pipeline-arrow">↓ LLM API</div>
                        <div class="pipeline-step">JSON Response</div>
                        <div class="pipeline-arrow">↓ Dataclass parse</div>
                        <div class="pipeline-step">Entities</div>
                        <div class="pipeline-arrow">↓ RDF convert</div>
                        <div class="pipeline-step">Storage</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Variable Preview Modal (All Variables) -->
<div class="modal fade" id="varPreviewModal" tabindex="-1" aria-labelledby="varPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="varPreviewModalLabel">All Template Variables</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="varPreviewLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Resolving variables...</div>
                </div>
                <div id="varPreviewError" class="alert alert-danger" style="display: none;"></div>
                <div id="varPreviewResults" style="display: none;">
                    <div class="var-preview-header">
                        <span id="varPreviewCaseTitle"></span>
                        <span class="var-preview-meta" id="varPreviewMeta"></span>
                    </div>
                    <div id="varPreviewList"></div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="copyAllVariables()">
                    <i class="bi bi-clipboard"></i> Copy All
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Single Variable Preview Modal -->
<div class="modal fade" id="singleVarModal" tabindex="-1" aria-labelledby="singleVarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="singleVarModalLabel">
                    <code id="singleVarName"></code>
                </h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="singleVarLoading" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2">Loading...</span>
                </div>
                <div id="singleVarContent" class="var-preview-content" style="display: none; max-height: 500px;"></div>
            </div>
            <div class="modal-footer py-2">
                <small class="text-muted me-auto" id="singleVarMeta"></small>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="copySingleVariable()">
                    <i class="bi bi-clipboard"></i> Copy
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const templateId = {{ template.id if template else 'null' }};
let originalText = document.getElementById('templateText')?.value || '';
let hasUnsavedChanges = false;

function switchMainTab(tabName) {
    document.querySelectorAll('.main-tab').forEach((t, i) => {
        t.classList.toggle('active', ['template', 'preview', 'test', 'history'][i] === tabName);
    });
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
}

function markUnsaved() {
    const text = document.getElementById('templateText').value;
    hasUnsavedChanges = text !== originalText;
    document.querySelector('#statusIndicator .status-dot').className =
        'status-dot ' + (hasUnsavedChanges ? 'status-unsaved' : 'status-saved');
    document.getElementById('statusText').textContent = hasUnsavedChanges ? 'Unsaved' : 'Saved';
    document.getElementById('saveBtn').disabled = !hasUnsavedChanges;
    document.getElementById('charCount').textContent = text.length + ' chars';
}

async function saveTemplate() {
    if (!templateId) return;
    const statusDot = document.querySelector('#statusIndicator .status-dot');
    const statusText = document.getElementById('statusText');
    statusDot.className = 'status-dot status-saving';
    statusText.textContent = 'Saving...';
    document.getElementById('saveBtn').disabled = true;

    try {
        const response = await fetch(`/api/prompts/template/${templateId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                template_text: document.getElementById('templateText').value,
                change_description: 'Updated via web editor'
            })
        });

        // Check if response is JSON before parsing
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error(`Server returned ${response.status}: ${text.substring(0, 100)}...`);
        }

        const data = await response.json();
        if (data.success) {
            originalText = document.getElementById('templateText').value;
            hasUnsavedChanges = false;
            statusDot.className = 'status-dot status-saved';
            statusText.textContent = `Saved (v${data.template.version})`;
        } else throw new Error(data.error);
    } catch (error) {
        statusDot.className = 'status-dot status-unsaved';
        statusText.textContent = 'Failed';
        document.getElementById('saveBtn').disabled = false;
        alert('Error: ' + error.message);
    }
}

// Helper to get global case selection
function getGlobalCase() {
    return {
        caseId: document.getElementById('globalCaseSelect').value,
        section: document.getElementById('globalSectionSelect').value
    };
}

// LocalStorage key for persisting case selection across pages
const CASE_STORAGE_KEY = 'proethica_prompt_editor_case';

// Called when global case selection changes
function onGlobalCaseChange() {
    const { caseId, section } = getGlobalCase();
    const statusEl = document.getElementById('caseStatus');
    if (caseId) {
        statusEl.textContent = 'Loading preview...';
        // Clear cached variables when case changes
        resolvedVariables = {};
        // Persist selection to localStorage
        localStorage.setItem(CASE_STORAGE_KEY, JSON.stringify({ caseId, section }));
        // Auto-render preview
        renderPreview();
    } else {
        statusEl.textContent = '';
        localStorage.removeItem(CASE_STORAGE_KEY);
    }
}

// Called when section selection changes
function onSectionChange() {
    const { caseId, section } = getGlobalCase();
    if (caseId) {
        // Clear cached variables when section changes
        resolvedVariables = {};
        // Update persisted selection
        localStorage.setItem(CASE_STORAGE_KEY, JSON.stringify({ caseId, section }));
        // Auto-render preview
        renderPreview();
    }
}

// Restore case selection from localStorage on page load, or default to first case
function restoreCaseSelection() {
    const caseSelect = document.getElementById('globalCaseSelect');
    const sectionSelect = document.getElementById('globalSectionSelect');

    // No cases available
    if (caseSelect.options.length === 0) return;

    try {
        const saved = localStorage.getItem(CASE_STORAGE_KEY);
        if (saved) {
            const { caseId, section } = JSON.parse(saved);
            // Check if the saved case exists in the dropdown
            if (caseId && caseSelect.querySelector(`option[value="${caseId}"]`)) {
                caseSelect.value = caseId;
                if (section && sectionSelect.querySelector(`option[value="${section}"]`)) {
                    sectionSelect.value = section;
                }
                // Trigger preview render
                renderPreview();
                return;
            }
        }
    } catch (e) {
        console.warn('Failed to restore case selection:', e);
    }

    // No saved selection or saved case not found - default to first case
    const firstCase = caseSelect.options[0];
    if (firstCase) {
        caseSelect.value = firstCase.value;
        localStorage.setItem(CASE_STORAGE_KEY, JSON.stringify({
            caseId: firstCase.value,
            section: sectionSelect.value
        }));
        renderPreview();
    }
}

// LocalStorage key for persisting last viewed template
const TEMPLATE_STORAGE_KEY = 'proethica_prompt_editor_template';

// Save current template location for redirect from index
function saveTemplateLocation() {
    try {
        localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify({
            url: window.location.pathname + window.location.search
        }));
    } catch (e) {
        console.warn('Failed to save template location:', e);
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    restoreCaseSelection();
    saveTemplateLocation();
});

async function renderPreview() {
    const { caseId, section } = getGlobalCase();
    const body = document.getElementById('previewBody');
    const status = document.getElementById('previewStatus');
    const caseStatus = document.getElementById('caseStatus');

    if (!caseId) {
        body.innerHTML = '<div class="preview-placeholder"><p>Please select a case above first</p></div>';
        return;
    }

    status.textContent = 'Rendering...';
    body.innerHTML = '<div class="preview-placeholder"><div class="spinner-border spinner-border-sm"></div></div>';

    try {
        const response = await fetch(`/api/prompts/template/${templateId}/render`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ case_id: parseInt(caseId), section_type: section })
        });
        const data = await response.json();
        if (data.success) {
            body.innerHTML = formatPromptPreview(data.rendered_prompt);
            status.textContent = `Rendered (${section})`;
            caseStatus.textContent = `Preview ready (${data.character_count.toLocaleString()} chars)`;
        } else {
            body.innerHTML = `<div class="preview-placeholder text-danger">${data.error || 'Render failed'}</div>`;
            status.textContent = 'Failed';
            caseStatus.textContent = 'Preview failed';
        }
    } catch (error) {
        body.innerHTML = `<div class="preview-placeholder text-danger">Error: ${error.message}</div>`;
        status.textContent = 'Error';
        caseStatus.textContent = 'Preview error';
    }
}

async function runTest() {
    const { caseId, section } = getGlobalCase();
    const results = document.getElementById('testResults');
    const status = document.getElementById('testStatus');

    if (!caseId) {
        alert('Please select a case above first');
        return;
    }

    document.getElementById('testBtn').disabled = true;
    status.textContent = 'Running...';
    results.innerHTML = '<div class="preview-placeholder"><div class="spinner-border"></div><p class="mt-2">Executing extraction...</p></div>';

    try {
        const response = await fetch(`/api/prompts/template/${templateId}/test-run`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ case_id: parseInt(caseId), section_type: section })
        });
        const data = await response.json();

        if (data.success) {
            status.textContent = `Completed in ${data.duration_ms}ms`;
            results.innerHTML = `
                <div class="test-section">
                    <div class="test-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <span><i class="bi bi-chat-text"></i> Rendered Prompt</span>
                        <i class="bi bi-chevron-down"></i>
                    </div>
                    <div class="test-section-body">${escapeHtml(data.rendered_prompt)}</div>
                </div>
                <div class="test-section collapsed">
                    <div class="test-section-header" onclick="this.parentElement.classList.toggle('collapsed')">
                        <span><i class="bi bi-robot"></i> LLM Response</span>
                        <i class="bi bi-chevron-right"></i>
                    </div>
                    <div class="test-section-body">${escapeHtml(data.raw_response)}</div>
                </div>
                <div class="test-section">
                    <div class="test-section-header">
                        <span><i class="bi bi-diagram-3"></i> Extracted Entities</span>
                    </div>
                    <div style="padding: 0.5rem;">
                        ${data.entities ? formatEntities(data.entities) : '<p class="text-muted small">No entities extracted</p>'}
                    </div>
                </div>`;
        } else {
            status.textContent = 'Failed';
            results.innerHTML = `<div class="preview-placeholder text-danger"><i class="bi bi-exclamation-triangle"></i><p>${data.error}</p></div>`;
        }
    } catch (error) {
        status.textContent = 'Error';
        results.innerHTML = `<div class="preview-placeholder text-danger">Error: ${error.message}</div>`;
    }
    document.getElementById('testBtn').disabled = false;
}

function formatEntities(entities) {
    let html = '';
    // Handle various entity key patterns from different concept extractors
    for (const [key, value] of Object.entries(entities)) {
        if (!Array.isArray(value) || value.length === 0) continue;

        // Format key name for display
        const displayName = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        html += `<div class="mb-2 mt-2"><strong>${displayName} (${value.length})</strong></div>`;

        value.forEach(e => {
            const label = e.label || e.name || e.title || 'Unknown';
            const desc = e.definition || e.description || e.reasoning || '';
            const truncDesc = desc.length > 100 ? desc.substring(0, 100) + '...' : desc;
            const classRef = e.role_class || e.class_label || e.parent_class || e.type || '';

            if (classRef) {
                html += `<div class="entity-card"><strong>${label}</strong> → ${classRef}</div>`;
            } else if (truncDesc) {
                html += `<div class="entity-card"><strong>${label}</strong><br><small class="text-muted">${truncDesc}</small></div>`;
            } else {
                html += `<div class="entity-card"><strong>${label}</strong></div>`;
            }
        });
    }
    return html || '<p class="text-muted small">No entities in response</p>';
}


function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatPromptPreview(text) {
    // Escape HTML first
    let html = escapeHtml(text);

    // Format main header (first line, usually "DUAL X EXTRACTION - ...")
    html = html.replace(/^([A-Z][A-Z\s\-]+(?:Extraction|Analysis)[^\n]*)/m,
        '<div class="preview-header">$1</div>');

    // Format section markers (=== TASK === etc)
    html = html.replace(/^(={3,}\s*[A-Z\s]+\s*={3,})$/gm,
        '<div class="preview-task"><strong>$1</strong></div>');

    // Format "EXISTING X IN ONTOLOGY:" headers
    html = html.replace(/^(EXISTING [A-Z\s]+ IN ONTOLOGY:)$/gm,
        '<div class="preview-header" style="margin-top: 1rem;">$1</div>');

    // Format "CASE TEXT:" section
    html = html.replace(/^(CASE TEXT:)\n([\s\S]*?)(?=\n\nRespond with|$)/m, (match, header, content) => {
        return `<div class="preview-header" style="margin-top: 1rem;">${header}</div><div class="preview-case-text">${content.trim()}</div>`;
    });

    // Format "Respond with valid JSON:" header
    html = html.replace(/^(Respond with valid JSON[^\n]*:)$/gm,
        '<div class="preview-header" style="margin-top: 1rem;">$1</div>');

    // Format LEVEL headers
    html = html.replace(/^(LEVEL \d+ - [A-Z\s]+:)/gm,
        '<div class="preview-header" style="margin-top: 0.75rem; color: #0d6efd;">$1</div>');

    // Format list items starting with -
    html = html.replace(/^- (.+)$/gm, '<div style="padding-left: 1rem;">- $1</div>');

    // Wrap remaining content and preserve line breaks
    html = html.replace(/\n\n/g, '</p><p style="margin: 0.5rem 0;">');
    html = html.replace(/\n/g, '<br>');

    return `<div style="padding: 0.5rem;">${html}</div>`;
}

async function revertToVersion(versionNumber) {
    if (!confirm(`Revert to v${versionNumber}?`)) return;
    try {
        const response = await fetch(`/api/prompts/template/${templateId}/revert/${versionNumber}`, { method: 'POST' });
        const data = await response.json();
        if (data.success) location.reload();
        else throw new Error(data.error);
    } catch (error) { alert('Error: ' + error.message); }
}

// Variable preview storage
let resolvedVariables = {};

async function previewVariables() {
    const { caseId, section } = getGlobalCase();
    if (!caseId) {
        alert('Please select a case above first');
        return;
    }
    if (!templateId) {
        alert('No template loaded');
        return;
    }

    const modal = new bootstrap.Modal(document.getElementById('varPreviewModal'));
    document.getElementById('varPreviewLoading').style.display = 'block';
    document.getElementById('varPreviewError').style.display = 'none';
    document.getElementById('varPreviewResults').style.display = 'none';
    modal.show();

    try {
        const response = await fetch(`/api/prompts/template/${templateId}/resolve-variables`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ case_id: parseInt(caseId), section_type: section })
        });
        const data = await response.json();

        document.getElementById('varPreviewLoading').style.display = 'none';

        if (data.success) {
            resolvedVariables = data.variables;
            document.getElementById('varPreviewCaseTitle').textContent = data.case_title;
            document.getElementById('varPreviewMeta').textContent = `${Object.keys(data.variables).length} variables | ${data.concept_type} | ${section}`;

            let html = '';
            for (const [varName, varInfo] of Object.entries(data.variables)) {
                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong class="text-primary">${"{{ " + varName + " }}"}</strong>
                            <span class="badge bg-secondary">${varInfo.length} chars</span>
                        </div>
                        <div class="var-preview-content">${escapeHtml(varInfo.value)}</div>
                    </div>`;
            }
            document.getElementById('varPreviewList').innerHTML = html || '<p class="text-muted">No variables resolved</p>';
            document.getElementById('varPreviewResults').style.display = 'block';
        } else {
            document.getElementById('varPreviewError').textContent = data.error || 'Unknown error';
            document.getElementById('varPreviewError').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('varPreviewLoading').style.display = 'none';
        document.getElementById('varPreviewError').textContent = error.message;
        document.getElementById('varPreviewError').style.display = 'block';
    }
}

let currentSingleVarName = '';

async function previewSingleVariable(varName) {
    const { caseId, section } = getGlobalCase();
    if (!caseId) {
        alert('Please select a case above first');
        return;
    }

    currentSingleVarName = varName;
    const modal = new bootstrap.Modal(document.getElementById('singleVarModal'));
    document.getElementById('singleVarName').textContent = '{{ ' + varName + ' }}';
    document.getElementById('singleVarLoading').style.display = 'block';
    document.getElementById('singleVarContent').style.display = 'none';
    document.getElementById('singleVarMeta').textContent = '';
    modal.show();

    // Check if we already have this variable cached
    if (resolvedVariables && resolvedVariables[varName]) {
        showSingleVariable(varName, resolvedVariables[varName]);
        return;
    }

    // Otherwise fetch all variables
    try {
        const response = await fetch(`/api/prompts/template/${templateId}/resolve-variables`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ case_id: parseInt(caseId), section_type: section })
        });
        const data = await response.json();

        if (data.success) {
            resolvedVariables = data.variables;
            if (resolvedVariables[varName]) {
                showSingleVariable(varName, resolvedVariables[varName]);
            } else {
                document.getElementById('singleVarLoading').style.display = 'none';
                document.getElementById('singleVarContent').textContent = '[Variable not found in resolved data]';
                document.getElementById('singleVarContent').style.display = 'block';
            }
        } else {
            document.getElementById('singleVarLoading').style.display = 'none';
            document.getElementById('singleVarContent').textContent = 'Error: ' + (data.error || 'Unknown error');
            document.getElementById('singleVarContent').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('singleVarLoading').style.display = 'none';
        document.getElementById('singleVarContent').textContent = 'Error: ' + error.message;
        document.getElementById('singleVarContent').style.display = 'block';
    }
}

function showSingleVariable(varName, varInfo) {
    document.getElementById('singleVarLoading').style.display = 'none';
    document.getElementById('singleVarContent').textContent = varInfo.value || varInfo;
    document.getElementById('singleVarContent').style.display = 'block';
    const length = (varInfo.value || varInfo).length;
    document.getElementById('singleVarMeta').textContent = `${length.toLocaleString()} characters`;
}

function copySingleVariable() {
    const content = document.getElementById('singleVarContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        setTimeout(() => { btn.innerHTML = originalHtml; }, 1500);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

function copyAllVariables() {
    if (!resolvedVariables || Object.keys(resolvedVariables).length === 0) {
        alert('No variables to copy');
        return;
    }
    let text = '';
    for (const [varName, varInfo] of Object.entries(resolvedVariables)) {
        text += `=== ${varName} ===\n${varInfo.value}\n\n`;
    }
    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        setTimeout(() => { btn.innerHTML = originalHtml; }, 1500);
    }).catch(err => {
        alert('Failed to copy: ' + err);
    });
}

window.addEventListener('beforeunload', e => {
    if (hasUnsavedChanges) { e.preventDefault(); e.returnValue = ''; }
});
</script>
{% endblock %}
