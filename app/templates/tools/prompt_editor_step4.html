{% extends "base.html" %}

{% block title %}Step 4: {{ phase_info.name }} - Prompt Editor{% endblock %}

{% block head %}
<style>
/* Compact layout */
.prompt-layout {
    display: grid;
    grid-template-columns: 180px 1fr 280px;
    gap: 0.75rem;
    height: calc(100vh - 120px);
}

/* Sidebar */
.sidebar {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.75rem;
    overflow-y: auto;
}
.sidebar-section {
    margin-bottom: 1rem;
}
.sidebar-section-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    color: #6c757d;
    font-weight: 600;
    margin-bottom: 0.5rem;
    padding-left: 0.25rem;
}
.nav-item {
    display: block;
    padding: 0.4rem 0.6rem;
    margin-bottom: 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
    color: #495057;
    text-decoration: none;
    transition: all 0.15s;
    border-left: 3px solid transparent;
}
.nav-item:hover {
    background: #e9ecef;
    color: #212529;
}
.nav-item.active {
    background: #fff;
    font-weight: 600;
    border-left-color: currentColor;
}
.nav-step {
    font-size: 0.65rem;
    text-transform: uppercase;
    color: #6c757d;
    margin-top: 0.75rem;
    margin-bottom: 0.25rem;
    padding-left: 0.25rem;
}

/* Main content */
.main-content {
    display: flex;
    flex-direction: column;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    overflow: hidden;
}

/* Tabs */
.tabs {
    display: flex;
    gap: 0;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 0 0.5rem;
}
.tab {
    padding: 0.5rem 1rem;
    font-size: 0.8rem;
    font-weight: 500;
    color: #6c757d;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
}
.tab:hover { color: #212529; }
.tab.active {
    color: #0d6efd;
    border-bottom-color: #0d6efd;
}

/* Tab content */
.tab-content {
    display: none;
    flex-grow: 1;
    overflow: hidden;
}
.tab-content.active {
    display: flex;
    flex-direction: column;
}

/* Prompt viewer */
.prompt-list {
    flex-grow: 1;
    overflow-y: auto;
    padding: 0.75rem;
}
.prompt-card {
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    margin-bottom: 0.75rem;
}
.prompt-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0.75rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
}
.prompt-card-header:hover { background: #e9ecef; }
.prompt-card-title {
    font-weight: 600;
    font-size: 0.85rem;
}
.prompt-card-source {
    font-size: 0.7rem;
    color: #6c757d;
}
.prompt-card-body {
    padding: 0;
    display: none;
}
.prompt-card.expanded .prompt-card-body { display: block; }
.prompt-card-body pre {
    margin: 0;
    padding: 0.75rem;
    background: #1e1e1e;
    color: #d4d4d4;
    font-size: 0.75rem;
    line-height: 1.4;
    overflow-x: auto;
    max-height: 400px;
}

/* Read-only badge */
.read-only-badge {
    background: #e9ecef;
    color: #6c757d;
    font-size: 0.65rem;
    padding: 0.15rem 0.4rem;
    border-radius: 0.25rem;
    font-weight: 500;
}

/* Settings panel */
.settings-panel {
    padding: 0.75rem;
    overflow-y: auto;
}
.setting-group {
    margin-bottom: 1rem;
}
.setting-group-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}
.setting-item {
    display: flex;
    flex-direction: column;
    margin-bottom: 0.75rem;
}
.setting-label {
    font-size: 0.8rem;
    font-weight: 500;
    margin-bottom: 0.25rem;
}
.setting-description {
    font-size: 0.7rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}
.setting-input {
    font-size: 0.8rem;
    padding: 0.3rem 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}
.setting-input:focus {
    outline: none;
    border-color: #0d6efd;
}

/* Reference panel */
.reference-panel {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.75rem;
    overflow-y: auto;
}
.reference-section {
    margin-bottom: 1rem;
}
.reference-title {
    font-size: 0.75rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
}
.info-card {
    background: #fff;
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
}
.info-label {
    font-size: 0.7rem;
    color: #6c757d;
}
.info-value {
    font-size: 0.8rem;
    font-weight: 500;
}
.algo-stage {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0;
    font-size: 0.8rem;
}
.algo-stage i { color: #10b981; }
.test-link {
    display: block;
    padding: 0.5rem;
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    text-decoration: none;
    color: #212529;
    font-size: 0.8rem;
    transition: all 0.15s;
}
.test-link:hover {
    border-color: #0d6efd;
    color: #0d6efd;
}

/* Status indicator */
.status-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.3rem 0.75rem;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    font-size: 0.75rem;
}
.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}
.status-saved { background: #10b981; }
.status-modified { background: #f59e0b; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-3 py-2">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="d-flex align-items-center gap-2">
            <h5 class="mb-0">
                <span class="badge" style="background-color: {{ phase_info.color }};">{{ phase_info.name }}</span>
            </h5>
            <span class="read-only-badge">Read-Only</span>
            <span class="text-muted small">{{ phase_info.description }}</span>
        </div>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="testCaseSelect" style="width: 250px;">
                <option value="">Select case for testing...</option>
                {% for case in cases %}
                <option value="{{ case.id }}">{{ case.title[:50] }}{% if case.title|length > 50 %}...{% endif %}</option>
                {% endfor %}
            </select>
            <button class="btn btn-sm btn-primary" onclick="goToStep4()" id="testBtn" disabled>
                <i class="bi bi-play-fill"></i> Test in Step 4
            </button>
        </div>
    </div>

    <!-- Three-column layout -->
    <div class="prompt-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            {% for step in pipeline_steps %}
            <div class="nav-step" style="color: {{ step.color }}">Step {{ step.step }}: {{ step.name }}</div>
            {% for concept in step.concepts %}
            {% if step.step == 4 %}
            <a href="{{ url_for('prompt_editor.view_step4_phase', phase=concept) }}"
               class="nav-item {% if concept == phase %}active{% endif %}"
               style="{% if concept == phase %}color: {{ concept_colors.get(concept, '#6c757d') }}{% endif %}">
                {{ step4_phases[concept].name if concept in step4_phases else concept|title }}
            </a>
            {% else %}
            <a href="{{ url_for('prompt_editor.edit_template', step=step.step, concept=concept) }}"
               class="nav-item">
                {{ concept|title }}
            </a>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>

        <!-- Main content -->
        <div class="main-content">
            <div class="tabs">
                <div class="tab active" data-tab="prompts">Prompts</div>
                <div class="tab" data-tab="settings">Settings</div>
            </div>

            <!-- Prompts tab -->
            <div class="tab-content active" id="tab-prompts">
                <div class="prompt-list">
                    {% for prompt in phase_info.prompts %}
                    <div class="prompt-card" data-method="{{ prompt.method }}">
                        <div class="prompt-card-header" onclick="togglePrompt(this)">
                            <div>
                                <div class="prompt-card-title">{{ prompt.name }}</div>
                                <div class="prompt-card-source">
                                    {{ prompt.get('file', phase_info.service_file).split('/')[-1] }} :: {{ prompt.method }}()
                                </div>
                            </div>
                            <i class="bi bi-chevron-down"></i>
                        </div>
                        <div class="prompt-card-body">
                            <pre class="code-view" id="code-{{ loop.index }}">Loading...</pre>
                        </div>
                    </div>
                    {% endfor %}

                    {% if phase_info.get('algorithmic_stages') %}
                    <div class="prompt-card">
                        <div class="prompt-card-header">
                            <div>
                                <div class="prompt-card-title">Algorithmic Stages (No LLM)</div>
                                <div class="prompt-card-source">These run before LLM refinement</div>
                            </div>
                            <span class="badge bg-info">Algorithmic</span>
                        </div>
                        <div class="prompt-card-body" style="display: block; padding: 0.75rem;">
                            {% for stage in phase_info.algorithmic_stages %}
                            <div class="algo-stage">
                                <i class="bi bi-check-circle-fill"></i>
                                {{ stage }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Settings tab -->
            <div class="tab-content" id="tab-settings">
                <div class="settings-panel">
                    <div class="setting-group">
                        <div class="setting-group-title">Decision Synthesis Parameters</div>

                        <div class="setting-item">
                            <label class="setting-label">Alignment Score Threshold</label>
                            <div class="setting-description">Minimum Q&C alignment score for candidates (0.0-1.0)</div>
                            <input type="number" class="setting-input" id="alignment_score_threshold"
                                   value="{{ config.alignment_score_threshold }}" min="0" max="1" step="0.05"
                                   onchange="updateSetting('alignment_score_threshold', this.value)">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Top Candidates Limit</label>
                            <div class="setting-description">Max candidates to refine via LLM</div>
                            <input type="number" class="setting-input" id="top_candidates_limit"
                                   value="{{ config.top_candidates_limit }}" min="1" max="20"
                                   onchange="updateSetting('top_candidates_limit', this.value)">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Provision Confidence Threshold</label>
                            <div class="setting-description">Minimum confidence for provision detection</div>
                            <input type="number" class="setting-input" id="provision_confidence_threshold"
                                   value="{{ config.provision_confidence_threshold }}" min="0" max="1" step="0.05"
                                   onchange="updateSetting('provision_confidence_threshold', this.value)">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Skip Algorithmic Fallback</label>
                            <div class="setting-description">Use only LLM for decision synthesis</div>
                            <select class="setting-input" id="skip_algorithmic_fallback"
                                    onchange="updateSetting('skip_algorithmic_fallback', this.value === 'true')">
                                <option value="false" {% if not config.skip_algorithmic_fallback %}selected{% endif %}>No (use E1-E3 stages)</option>
                                <option value="true" {% if config.skip_algorithmic_fallback %}selected{% endif %}>Yes (LLM only)</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-group">
                        <div class="setting-group-title">LLM Parameters</div>

                        <div class="setting-item">
                            <label class="setting-label">Model</label>
                            <div class="setting-description">Model for synthesis LLM calls</div>
                            <select class="setting-input" id="llm_model"
                                    onchange="updateSetting('llm_model', this.value)">
                                <option value="claude-sonnet-4-5-20250929" {% if config.llm_model == 'claude-sonnet-4-5-20250929' %}selected{% endif %}>Sonnet 4.5 (Default)</option>
                                <option value="claude-haiku-4-5-20251022" {% if config.llm_model == 'claude-haiku-4-5-20251022' %}selected{% endif %}>Haiku 4.5 (Fast)</option>
                                <option value="claude-opus-4-5-20251101" {% if config.llm_model == 'claude-opus-4-5-20251101' %}selected{% endif %}>Opus 4.5 (Powerful)</option>
                            </select>
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Temperature</label>
                            <div class="setting-description">0.0=deterministic, 1.0=creative</div>
                            <input type="number" class="setting-input" id="llm_temperature"
                                   value="{{ config.llm_temperature }}" min="0" max="1" step="0.1"
                                   onchange="updateSetting('llm_temperature', this.value)">
                        </div>

                        <div class="setting-item">
                            <label class="setting-label">Max Tokens</label>
                            <div class="setting-description">Maximum response tokens</div>
                            <input type="number" class="setting-input" id="llm_max_tokens"
                                   value="{{ config.llm_max_tokens }}" min="1000" max="8000" step="500"
                                   onchange="updateSetting('llm_max_tokens', this.value)">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status bar -->
            <div class="status-bar">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Ready</span>
            </div>
        </div>

        <!-- Reference panel -->
        <div class="reference-panel">
            <div class="reference-section">
                <div class="reference-title">Phase Info</div>
                <div class="info-card">
                    <div class="info-label">Service File</div>
                    <div class="info-value" style="font-size: 0.7rem; word-break: break-all;">
                        {{ phase_info.service_file }}
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-label">Prompts</div>
                    <div class="info-value">{{ phase_info.prompts | length }} LLM prompts</div>
                </div>
                {% if phase_info.get('algorithmic_stages') %}
                <div class="info-card">
                    <div class="info-label">Algorithmic Stages</div>
                    <div class="info-value">{{ phase_info.algorithmic_stages | length }} stages (no LLM)</div>
                </div>
                {% endif %}
            </div>

            <div class="reference-section">
                <div class="reference-title">Test with Case</div>
                <a href="#" class="test-link" id="testLink" style="pointer-events: none; opacity: 0.5;">
                    <i class="bi bi-arrow-right-circle"></i> Go to Step 4 page
                    <div class="text-muted" style="font-size: 0.7rem;">Select a case above first</div>
                </a>
            </div>

            <div class="reference-section">
                <div class="reference-title">Step 4 Pipeline</div>
                {% for p_key, p_info in step4_phases.items() %}
                <div class="info-card" style="{% if p_key == phase %}border-color: {{ p_info.color }};{% endif %}">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge" style="background: {{ p_info.color }}; width: 10px; height: 10px; padding: 0;"></span>
                        <span class="info-value" style="{% if p_key == phase %}color: {{ p_info.color }};{% endif %}">
                            {{ p_info.name }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
const phase = '{{ phase }}';

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    });
});

// Toggle prompt card expansion and load code
function togglePrompt(header) {
    const card = header.closest('.prompt-card');
    const wasExpanded = card.classList.contains('expanded');
    card.classList.toggle('expanded');

    if (!wasExpanded) {
        const method = card.dataset.method;
        const codeEl = card.querySelector('.code-view');
        if (codeEl.textContent === 'Loading...') {
            loadPromptCode(method, codeEl);
        }
    }
}

async function loadPromptCode(method, element) {
    try {
        const response = await fetch(`/api/prompts/step4/prompt/${phase}/${method}`);
        const data = await response.json();
        if (data.success) {
            element.textContent = data.code;
        } else {
            element.textContent = `# Error: ${data.error}`;
        }
    } catch (error) {
        element.textContent = `# Error loading code: ${error.message}`;
    }
}

// Update settings
async function updateSetting(key, value) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');

    statusDot.className = 'status-dot status-modified';
    statusText.textContent = 'Saving...';

    try {
        const response = await fetch('/api/prompts/step4/config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ [key]: value })
        });
        const data = await response.json();

        if (data.success) {
            statusDot.className = 'status-dot status-saved';
            statusText.textContent = 'Saved';
            setTimeout(() => {
                statusText.textContent = 'Ready';
                statusDot.className = 'status-dot';
            }, 2000);
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        statusDot.className = 'status-dot';
        statusText.textContent = 'Error: ' + error.message;
    }
}

// Case selection for testing
document.getElementById('testCaseSelect').addEventListener('change', function() {
    const caseId = this.value;
    const testBtn = document.getElementById('testBtn');
    const testLink = document.getElementById('testLink');

    if (caseId) {
        testBtn.disabled = false;
        testLink.style.pointerEvents = 'auto';
        testLink.style.opacity = '1';
        testLink.href = `/scenario_pipeline/case/${caseId}/step4`;
        testLink.querySelector('div').textContent = 'Run full synthesis';
    } else {
        testBtn.disabled = true;
        testLink.style.pointerEvents = 'none';
        testLink.style.opacity = '0.5';
        testLink.querySelector('div').textContent = 'Select a case above first';
    }
});

function goToStep4() {
    const caseId = document.getElementById('testCaseSelect').value;
    if (caseId) {
        window.location.href = `/scenario_pipeline/case/${caseId}/step4`;
    }
}

// LocalStorage for remembering template location
const TEMPLATE_STORAGE_KEY = 'proethica_prompt_editor_template';
localStorage.setItem(TEMPLATE_STORAGE_KEY, JSON.stringify({
    url: window.location.pathname
}));
</script>
{% endblock %}
