{% extends 'base.html' %}

{% block title %}Guideline Extracted Concepts{% endblock %}

{% block styles %}
<style>
    .concept-type-override {
        min-width: 120px;
        font-size: 0.875rem;
    }
    
    .concept-type-override option {
        padding: 0.25rem;
    }
    
    .concept-hierarchy {
        word-wrap: break-word;
        white-space: normal;
    }
    
    .hierarchy-path {
        padding: 0.25rem 0;
    }
    
    .table td {
        vertical-align: top;
        padding: 0.75rem 0.5rem;
    }
    
    .type-help-tooltip {
        cursor: help;
        font-size: 0.75rem;
        color: #6c757d;
        margin-left: 0.25rem;
    }
    
    .type-definitions {
        font-size: 0.8rem;
        background-color: #f8f9fa;
        padding: 0.75rem;
        border-radius: 0.25rem;
        margin-bottom: 1rem;
    }
    
    .type-definitions dt {
        font-weight: 600;
        color: #495057;
    }
    
    .type-definitions dd {
        margin-bottom: 0.5rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('worlds.list_worlds') }}">Worlds</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('worlds.view_world', id=world.id) }}">{{ world.name }}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('worlds.world_guidelines', id=world.id) }}">Guidelines</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('worlds.view_guideline', id=world.id, document_id=guideline.id) }}">{{ guideline.title }}</a></li>
            <li class="breadcrumb-item active">Extracted Concepts</li>
        </ol>
    </nav>
    
    <div class="row mb-4">
        <div class="col-12">
            <h1>Extracted Concepts from "{{ guideline.title }}"</h1>
            <p class="text-muted">These concepts were automatically extracted from the guideline text.</p>
        </div>
    </div>
    
    {% if error %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-heading">Error!</h4>
        <p>{{ error }}</p>
    </div>
    {% endif %}
    
    {% if concepts %}
    <form method="POST" action="{{ url_for('worlds.save_guideline_concepts', world_id=world.id, document_id=guideline.id) }}" id="concepts-form">
        <!-- Include concepts data as hidden field -->
        <input type="hidden" name="concepts_data" id="concepts_data" value="" />
        <input type="hidden" name="ontology_source" value="{{ ontology_source or '' }}" />
        <div class="row mb-3">
            <div class="col-md-8">
                <h3>Select concepts to include in the ontology:</h3>
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label" for="selectAll">
                            <strong>Select/Deselect All</strong>
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <button type="submit" class="btn btn-primary">Save Selected Concepts</button>
                <a href="{{ url_for('worlds.view_guideline', id=world.id, document_id=guideline.id) }}" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
        
        
        
        <div class="row">
            <div class="col-12">
                
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Extracted Concepts ({{ concepts|length }})</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 5%">Select</th>
                                        <th style="width: 25%">Concept</th>
                                        <th style="width: 30%">Type & Classification</th>
                                        <th style="width: 40%">Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for concept in concepts %}
                                    <tr>
                                        <td>
                                            <div class="form-check">
                                                <input class="form-check-input concept-checkbox" type="checkbox" name="selected_concepts" value="{{ loop.index0 }}" id="concept-{{ loop.index }}" checked>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% set primary_type = (concept.primary_type or concept.type or '').lower() %}
                                                {% set type_colors = {
                                                  'role': 'bg-primary',
                                                  'principle': 'bg-success', 
                                                  'obligation': 'bg-warning',
                                                  'state': 'bg-info',
                                                  'resource': 'bg-secondary',
                                                  'action': 'bg-danger',
                                                  'event': 'bg-dark',
                                                  'capability': 'bg-light text-dark'
                                                } %}
                                                {% set color_class = type_colors.get(primary_type, 'bg-secondary') %}
                                                {% set display_type = primary_type.capitalize() if primary_type else 'Concept' %}
                                                <span class="badge {{ color_class }} me-2">{{ display_type }}</span>
                                                <label class="form-check-label" for="concept-{{ loop.index }}"><strong>{{ concept.label }}</strong></label>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="concept-type-display">
                                                <!-- Manual Type Override Dropdown -->
                                                {% set actual_type = concept.type or concept.primary_type or 'concept' %}
                                                {% set dropdown_type = actual_type.lower() %}
                                                <select class="form-select form-select-sm concept-type-override" 
                                                        data-concept-index="{{ loop.index0 }}"
                                                        data-original-type="{{ dropdown_type }}"
                                                        style="width: auto; margin-bottom: 0.25rem;">
                                                    <option value="role" {% if dropdown_type == 'role' %}selected{% endif %} class="text-primary">Role</option>
                                                    <option value="principle" {% if dropdown_type == 'principle' %}selected{% endif %} class="text-success">Principle</option>
                                                    <option value="obligation" {% if dropdown_type == 'obligation' %}selected{% endif %} class="text-warning">Obligation</option>
                                                    <option value="state" {% if dropdown_type == 'state' %}selected{% endif %} class="text-info">State</option>
                                                    <option value="resource" {% if dropdown_type == 'resource' %}selected{% endif %} class="text-secondary">Resource</option>
                                                    <option value="action" {% if dropdown_type == 'action' %}selected{% endif %} class="text-danger">Action</option>
                                                    <option value="event" {% if dropdown_type == 'event' %}selected{% endif %} class="text-dark">Event</option>
                                                    <option value="capability" {% if dropdown_type == 'capability' %}selected{% endif %}>Capability</option>
                                                </select>
                                                
                                                <div class="concept-hierarchy mt-2">
                                                    {% set semantic_category = concept.category %}
                                                    {% set ontology_type = actual_type.capitalize() %}
                                                    <div class="hierarchy-path mb-1">
                                                        <small class="d-block" style="line-height: 1.4;">
                                                            <strong class="hierarchy-display text-dark">{{ ontology_type }}</strong>
                                                            {% if semantic_category and semantic_category != actual_type %}
                                                                <br>‚Ü≥ <span class="text-primary fst-italic">{{ semantic_category }}</span>
                                                                <br>‚Ü≥ <strong class="text-success">{{ concept.label }}</strong>
                                                            {% else %}
                                                                <br>‚Ü≥ <strong class="text-success">{{ concept.label }}</strong>
                                                            {% endif %}
                                                            {% if dropdown_type == 'role' and (concept.role_classification or concept.suggested_parent_class_uri) %}
                                                                <br>
                                                                <span class="badge bg-outline-secondary text-dark" style="border:1px solid #ccc;">Classification: {{ (concept.role_classification or 'unknown')|capitalize }}</span>
                                                                {% if concept.role_signals %}
                                                                    <br><span class="text-muted">Signals: {{ ", ".join(concept.role_signals) }}</span>
                                                                {% endif %}
                                                            {% endif %}
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>{{ concept.description }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Concept Types Reference -->
        <div class="card mt-4 mb-4">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-tags"></i> Concept Types</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">üèõÔ∏è Ontological Types (8 Fundamental Categories)</h6>
                        <p class="small text-muted mb-2">Formal ontology classes - stored as permanent classifications</p>
                        
                        <dl class="small mb-3">
                            <dt><span class="badge bg-primary">Role</span></dt>
                            <dd>Professional positions, occupations, or stakeholder categories (e.g., Engineer, Client, Manager). <strong>NOT duties or relationships.</strong></dd>
                            
                            <dt><span class="badge bg-success">Principle</span></dt>
                            <dd>Core ethical values, fundamental beliefs, or guiding standards (e.g., Safety First, Honesty).</dd>
                            
                            <dt><span class="badge bg-warning">Obligation</span></dt>
                            <dd>Professional duties, requirements, or things that MUST be done (e.g., Faithful Agency, Confidentiality).</dd>
                            
                            <dt><span class="badge bg-info">State</span></dt>
                            <dd>Conditions, situations, or circumstances that exist (e.g., Conflict of Interest, Risk State).</dd>
                            
                            <dt><span class="badge bg-secondary">Resource</span></dt>
                            <dd>Physical or informational entities, documents, or tools (e.g., Technical Standards, Specifications).</dd>
                            
                            <dt><span class="badge bg-danger">Action</span></dt>
                            <dd>Intentional activities or processes performed (e.g., Design Review, Communication).</dd>
                            
                            <dt><span class="badge bg-dark">Event</span></dt>
                            <dd>Occurrences, incidents, or happenings (e.g., Safety Incident, Project Milestone).</dd>
                            
                            <dt><span class="badge bg-light text-dark">Capability</span></dt>
                            <dd>Skills, competencies, or abilities (e.g., Technical Expertise, Problem Solving).</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">ü§ñ Semantic Categories (LLM Insights)</h6>
                        <p class="small text-muted mb-2">AI-generated classifications - stored as metadata for future ontology evolution</p>
                        <div class="mb-3">
                            <span class="text-primary fst-italic">Examples: Fundamental Duty, Professional Standard, Ethical Principle</span>
                        </div>
                        
                        <div class="alert alert-info mb-0">
                            <small>
                                <strong>Display Format:</strong><br>
                                <strong>Concept Column:</strong> <span class="badge bg-success">Ontological Type</span> <strong>Concept Name</strong><br>
                                <strong>Type Column:</strong> Dropdown + <strong>Ontological Type</strong> ‚Üí <span class="text-primary fst-italic">LLM Semantic Category</span> ‚Üí <strong>Concept Name</strong>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">Save Selected Concepts</button>
                <a href="{{ url_for('worlds.view_guideline', id=world.id, document_id=guideline.id) }}" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </form>
    {% else %}
    <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">No concepts found</h4>
        <p>No concepts were extracted from this guideline. The guideline content may be too short or not contain recognizable ethical engineering concepts.</p>
        <hr>
        <p class="mb-0">
            <a href="{{ url_for('worlds.view_guideline', id=world.id, document_id=guideline.id) }}" class="btn btn-secondary">Back to Guideline</a>
        </p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Select/deselect all checkboxes
    const selectAllCheckbox = document.getElementById('selectAll');
    const conceptCheckboxes = document.querySelectorAll('.concept-checkbox');
    
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = selectAllCheckbox.checked;
        conceptCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    });
    
    // Update "Select All" state based on individual checkboxes
    function updateSelectAllCheckbox() {
        const checkedCount = document.querySelectorAll('.concept-checkbox:checked').length;
        selectAllCheckbox.checked = checkedCount === conceptCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < conceptCheckboxes.length;
    }
    
    conceptCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllCheckbox);
    });
    
    // Sort concepts by confidence (optional feature)
    // Could be implemented with JavaScript to allow dynamic sorting
    
    // Handle type override changes
    const typeOverrideSelects = document.querySelectorAll('.concept-type-override');
    const typeColorMap = {
        'role': 'bg-primary',
        'principle': 'bg-success',
        'obligation': 'bg-warning',
        'state': 'bg-info',
        'resource': 'bg-secondary',
        'action': 'bg-danger',
        'event': 'bg-dark',
        'capability': 'bg-light text-dark'
    };
    
    typeOverrideSelects.forEach(select => {
        select.addEventListener('change', function() {
            const newType = this.value;
            const conceptIndex = this.dataset.conceptIndex;
            const conceptDiv = this.closest('.concept-type-display');
            const hierarchySpan = conceptDiv.querySelector('.hierarchy-display');
            
            // Update the hierarchy display
            hierarchySpan.textContent = newType.charAt(0).toUpperCase() + newType.slice(1);
            
            // Update select styling based on type
            this.className = 'form-select form-select-sm concept-type-override';
            
            // Show change indicator if different from original
            const originalType = this.dataset.originalType;
            const changeIndicator = conceptDiv.querySelector('.text-warning');
            if (newType !== originalType) {
                if (!changeIndicator) {
                    const indicator = document.createElement('small');
                    indicator.className = 'text-warning';
                    indicator.style.fontSize = '0.7rem';
                    indicator.innerHTML = '<br><i class="bi bi-info-circle"></i> Modified from: ' + originalType.charAt(0).toUpperCase() + originalType.slice(1);
                    conceptDiv.querySelector('.concept-hierarchy').appendChild(indicator);
                }
            } else if (changeIndicator) {
                changeIndicator.remove();
            }
            
            // Update the hidden concept data that will be submitted
            updateConceptData(conceptIndex, 'type', newType);
            updateConceptData(conceptIndex, 'primary_type', newType);
        });
    });
    
    // Function to update concept data in the form
    function updateConceptData(index, field, value) {
        // The concepts are stored in a hidden field as JSON
        const conceptsDataField = document.getElementById('concepts_data');
        let concepts = [];
        try {
            concepts = JSON.parse(conceptsDataField.value || '[]');
        } catch (e) {
            console.error('Error parsing concepts data:', e);
            return;
        }
        
        if (concepts[index]) {
            concepts[index][field] = value;
            // Mark as manually edited
            concepts[index]['manually_edited'] = true;
            concepts[index]['manual_type_override'] = value;
            conceptsDataField.value = JSON.stringify(concepts);
        }
    }
    
    // Initialize concepts data field with current data
    const conceptsData = {{ concepts|tojson|safe }};
    const conceptsDataField = document.getElementById('concepts_data');
    if (conceptsDataField) {
        conceptsDataField.value = JSON.stringify(conceptsData);
        console.log('Initial concepts data set:', conceptsDataField.value.substring(0, 100) + '...');
    } else {
        console.error('concepts_data field not found!');
    }
    
    // Add form submission handler to ensure data is present
    const form = document.getElementById('concepts-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            const dataField = document.getElementById('concepts_data');
            console.log('Form submitting with concepts_data:', dataField.value.substring(0, 100) + '...');
            if (!dataField.value || dataField.value === '') {
                console.error('concepts_data is empty! Setting it now...');
                dataField.value = JSON.stringify(conceptsData);
            }
        });
    }
});
</script>
{% endblock %}
