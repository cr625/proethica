{% extends "scenarios/base_step.html" %}

{% block step_title %}{{ step_title }}{% endblock %}
{% block step_header %}Enhanced Temporal Dynamics - Extraction Review{% endblock %}
{% block step_subtitle %}Review extracted temporal entities with OWL-Time integration and Allen algebra{% endblock %}

{% block step_navigation %}
<div class="d-flex justify-content-between mb-3">
    <a href="{{ url_for('scenario_pipeline.step3', case_id=case.id) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Step 3
    </a>
    <div>
        <a href="{{ url_for('step4.step4_synthesis', case_id=case.id) }}" class="btn btn-success">
            Continue to Step 4 <i class="bi bi-arrow-right"></i>
        </a>
    </div>
</div>
{% endblock %}

{% block step_content %}
<div class="container-fluid">
    {% if not extraction_complete %}
    <div class="alert alert-info">
        <h5><i class="bi bi-info-circle"></i> Enhanced Temporal Extraction Review</h5>
        <p class="mb-0">
            No temporal dynamics extraction found for this case. Please run the extraction from Step 3.
        </p>
    </div>
    {% else %}

    <div class="alert alert-success">
        <h5><i class="bi bi-check-circle"></i> Extraction Complete</h5>
        <p class="mb-2">Enhanced temporal dynamics extraction completed successfully.</p>
        <div class="row">
            <div class="col-md-2">
                <strong>Total Entities:</strong> {{ summary.total_entities }}
            </div>
            <div class="col-md-2">
                <strong>Actions:</strong> {{ summary.actions }}
            </div>
            <div class="col-md-2">
                <strong>Events:</strong> {{ summary.events }}
            </div>
            <div class="col-md-2">
                <strong>Causal Chains:</strong> {{ summary.causal_chains }}
            </div>
            <div class="col-md-2">
                <strong>Allen Relations:</strong> {{ summary.allen_relations }}
            </div>
            <div class="col-md-2">
                <strong>Timeline:</strong> {% if summary.has_timeline %}<i class="bi bi-check-circle text-success"></i>{% else %}<i class="bi bi-x-circle text-muted"></i>{% endif %}
            </div>
        </div>
    </div>

    <!-- Timeline Visualization -->
    {% if timeline %}
    <div class="card mb-4">
        <div class="card-header bg-primary bg-opacity-10">
            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Timeline Overview</h5>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-4">
                    <strong>Total Elements:</strong> {{ timeline.total_elements }}
                </div>
                <div class="col-md-4">
                    <strong>Actions:</strong> {{ timeline.action_count }}
                </div>
                <div class="col-md-4">
                    <strong>Events:</strong> {{ timeline.event_count }}
                </div>
            </div>

            <h6 class="mt-3">Temporal Markers</h6>
            <ul class="list-group">
                {% for timepoint in timeline.timepoints %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span><strong>{{ timepoint['proeth:timepoint'] }}</strong></span>
                    <span class="badge bg-secondary">{{ timepoint['proeth:elementCount'] }} elements</span>
                </li>
                {% endfor %}
            </ul>

            {% if timeline.temporal_consistency %}
            <div class="mt-3">
                <h6>Temporal Consistency Check</h6>
                {% if timeline.temporal_consistency.get('proeth:valid', False) %}
                <span class="badge bg-success">Valid</span>
                {% else %}
                <span class="badge bg-danger">Issues Found</span>
                {% endif %}

                {% if timeline.temporal_consistency.get('proeth:warnings', []) %}
                <div class="alert alert-warning mt-2">
                    <strong>Warnings:</strong>
                    <ul class="mb-0">
                        {% for warning in timeline.temporal_consistency['proeth:warnings'] %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if timeline.temporal_consistency.get('proeth:contradictions', []) %}
                <div class="alert alert-danger mt-2">
                    <strong>Contradictions:</strong>
                    <ul class="mb-0">
                        {% for contradiction in timeline.temporal_consistency['proeth:contradictions'] %}
                        <li>{{ contradiction }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    {% if actions %}
    <div class="card mb-4">
        <div class="card-header bg-success bg-opacity-10">
            <h5 class="mb-0"><i class="bi bi-lightning-charge"></i> Extracted Actions ({{ actions|length }})</h5>
            <small class="text-muted">Volitional professional decisions with intentions and ethical context</small>
        </div>
        <div class="card-body">
            <div class="accordion" id="actionsAccordion">
                {% for action in actions %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="action-{{ action.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#action-collapse-{{ action.id }}">
                            <strong>{{ action.label }}</strong>
                            {% if action.agent %}
                            <span class="badge bg-primary ms-2">{{ action.agent }}</span>
                            {% endif %}
                        </button>
                    </h2>
                    <div id="action-collapse-{{ action.id }}" class="accordion-collapse collapse" data-bs-parent="#actionsAccordion">
                        <div class="accordion-body">
                            <p><strong>Description:</strong> {{ action.description }}</p>

                            {% if action.temporal_marker %}
                            <p><strong>Temporal Marker:</strong> <span class="badge bg-secondary">{{ action.temporal_marker }}</span></p>
                            {% endif %}

                            {% if action.mental_state %}
                            <p><strong>Mental State:</strong> {{ action.mental_state }}</p>
                            {% endif %}

                            {% if action.intended_outcome %}
                            <p><strong>Intended Outcome:</strong> {{ action.intended_outcome }}</p>
                            {% endif %}

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    {% if action.fulfills_obligation %}
                                    <h6>Fulfills Obligations:</h6>
                                    <ul>
                                        {% for obligation in action.fulfills_obligation %}
                                        <li>{{ obligation }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    {% if action.guided_by_principle %}
                                    <h6>Guided By Principles:</h6>
                                    <ul>
                                        {% for principle in action.guided_by_principle %}
                                        <li>{{ principle }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                            </div>

                            {% if action.requires_capability %}
                            <div class="mt-2">
                                <h6>Required Capabilities:</h6>
                                <div>
                                    {% for capability in action.requires_capability %}
                                    <span class="badge bg-info me-1">{{ capability }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <div class="mt-2">
                                <small class="text-muted">
                                    <strong>Within Competence:</strong>
                                    {% if action.within_competence %}
                                    <span class="text-success">Yes</span>
                                    {% else %}
                                    <span class="text-danger">No</span>
                                    {% endif %}
                                </small>
                            </div>

                            <details class="mt-3">
                                <summary class="text-muted small">RDF JSON-LD</summary>
                                <pre class="mt-2"><code>{{ action.rdf_json | tojson(indent=2) }}</code></pre>
                            </details>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Events -->
    {% if events %}
    <div class="card mb-4">
        <div class="card-header bg-warning bg-opacity-10">
            <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Extracted Events ({{ events|length }})</h5>
            <small class="text-muted">Occurrences that trigger ethical considerations and state changes</small>
        </div>
        <div class="card-body">
            <div class="accordion" id="eventsAccordion">
                {% for event in events %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="event-{{ event.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#event-collapse-{{ event.id }}">
                            <strong>{{ event.label }}</strong>
                            {% if event.emergency_level %}
                            <span class="badge bg-danger ms-2">{{ event.emergency_level }}</span>
                            {% endif %}
                        </button>
                    </h2>
                    <div id="event-collapse-{{ event.id }}" class="accordion-collapse collapse" data-bs-parent="#eventsAccordion">
                        <div class="accordion-body">
                            <p><strong>Description:</strong> {{ event.description }}</p>

                            {% if event.affected_entity %}
                            <p><strong>Affected Entity:</strong> {{ event.affected_entity }}</p>
                            {% endif %}

                            {% if event.temporal_marker %}
                            <p><strong>Temporal Marker:</strong> <span class="badge bg-secondary">{{ event.temporal_marker }}</span></p>
                            {% endif %}

                            <div class="row mt-3">
                                <div class="col-md-4">
                                    {% if event.triggers_state %}
                                    <h6>Triggers States:</h6>
                                    <ul>
                                        {% for state in event.triggers_state %}
                                        <li>{{ state }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    {% if event.activates_constraint %}
                                    <h6>Activates Constraints:</h6>
                                    <ul>
                                        {% for constraint in event.activates_constraint %}
                                        <li>{{ constraint }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    {% if event.transforms_obligation %}
                                    <h6>Transforms Obligations:</h6>
                                    <ul>
                                        {% for obligation in event.transforms_obligation %}
                                        <li>{{ obligation }}</li>
                                        {% endfor %}
                                    </ul>
                                    {% endif %}
                                </div>
                            </div>

                            <details class="mt-3">
                                <summary class="text-muted small">RDF JSON-LD</summary>
                                <pre class="mt-2"><code>{{ event.rdf_json | tojson(indent=2) }}</code></pre>
                            </details>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Causal Chains (NESS Test) -->
    {% if causal_chains %}
    <div class="card mb-4">
        <div class="card-header bg-danger bg-opacity-10">
            <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Causal Chains ({{ causal_chains|length }})</h5>
            <small class="text-muted">NESS test analysis: Necessary Element of Sufficient Set</small>
        </div>
        <div class="card-body">
            <div class="accordion" id="causalAccordion">
                {% for chain in causal_chains %}
                <div class="accordion-item">
                    <h2 class="accordion-header" id="causal-{{ chain.id }}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#causal-collapse-{{ chain.id }}">
                            <strong>{{ chain.cause }}</strong> <i class="bi bi-arrow-right mx-2"></i> <strong>{{ chain.effect }}</strong>
                        </button>
                    </h2>
                    <div id="causal-collapse-{{ chain.id }}" class="accordion-collapse collapse" data-bs-parent="#causalAccordion">
                        <div class="accordion-body">
                            <p><strong>Causal Language:</strong> {{ chain.causal_language }}</p>

                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <h6>Necessary Factors (NESS):</h6>
                                    <ul>
                                        {% for factor in chain.necessary_factors %}
                                        <li>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Sufficient Factors:</h6>
                                    <ul>
                                        {% for factor in chain.sufficient_factors %}
                                        <li>{{ factor }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            {% if chain.counterfactual %}
                            <div class="alert alert-info mt-3">
                                <strong>Counterfactual Test:</strong> {{ chain.counterfactual }}
                            </div>
                            {% endif %}

                            <div class="mt-3">
                                <h6>Responsibility Attribution:</h6>
                                <p>
                                    <strong>Agent:</strong> {{ chain.responsible_agent }}<br>
                                    <strong>Type:</strong> <span class="badge bg-secondary">{{ chain.responsibility_type }}</span><br>
                                    <strong>Within Agent Control:</strong>
                                    {% if chain.within_agent_control %}
                                    <span class="text-success">Yes</span>
                                    {% else %}
                                    <span class="text-danger">No</span>
                                    {% endif %}
                                </p>
                            </div>

                            {% if chain.causal_sequence %}
                            <div class="mt-3">
                                <h6>Causal Sequence:</h6>
                                <ol>
                                    {% for step in chain.causal_sequence %}
                                    <li>
                                        <strong>{{ step['proeth:element'] }}</strong><br>
                                        <small class="text-muted">{{ step['proeth:description'] }}</small>
                                    </li>
                                    {% endfor %}
                                </ol>
                            </div>
                            {% endif %}

                            <details class="mt-3">
                                <summary class="text-muted small">RDF JSON-LD</summary>
                                <pre class="mt-2"><code>{{ chain.rdf_json | tojson(indent=2) }}</code></pre>
                            </details>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Allen Relations -->
    {% if allen_relations %}
    <div class="card mb-4">
        <div class="card-header bg-info bg-opacity-10">
            <h5 class="mb-0"><i class="bi bi-arrow-left-right"></i> Allen Temporal Relations ({{ allen_relations|length }})</h5>
            <small class="text-muted">Interval algebra relationships with OWL-Time standard properties</small>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>From Entity</th>
                            <th>Allen Relation</th>
                            <th>To Entity</th>
                            <th>OWL-Time Property</th>
                            <th>Evidence</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for relation in allen_relations %}
                        <tr>
                            <td><strong>{{ relation.from_entity }}</strong></td>
                            <td>
                                <span class="badge bg-info">{{ relation.relation_type }}</span>
                                <br>
                                <small class="text-muted">{{ relation.description }}</small>
                            </td>
                            <td><strong>{{ relation.to_entity }}</strong></td>
                            <td>
                                {% if relation.owl_time_property %}
                                <code class="text-success">{{ relation.owl_time_property }}</code>
                                <br>
                                <small class="text-muted" style="font-size: 0.75em;">
                                    <a href="{{ relation.owl_time_uri }}" target="_blank" class="text-decoration-none">
                                        {{ relation.owl_time_uri }}
                                    </a>
                                </small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if relation.evidence %}
                                <small>{{ relation.evidence[:100] }}{% if relation.evidence|length > 100 %}...{% endif %}</small>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="mt-3 p-3 bg-light rounded">
                <h6 class="mb-2"><i class="bi bi-info-circle"></i> About Allen Relations & OWL-Time</h6>
                <p class="small mb-0">
                    <strong>Allen's Interval Algebra</strong> provides 13 basic temporal relations between intervals.
                    These relations are mapped to <strong>OWL-Time</strong> standard properties for interoperability with
                    Semantic Web temporal reasoning systems and SPARQL queries.
                </p>
                <p class="small mb-0 mt-2">
                    Each relation includes both a <span class="badge bg-info">ProEthica custom property</span> and a
                    <code class="text-success">time:* OWL-Time property</code> for maximum compatibility.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Commit to OntServe Section -->
    {% if extraction_complete %}
    <div class="card mb-4">
        <div class="card-header bg-success bg-opacity-10">
            <h5 class="mb-0"><i class="bi bi-database-check"></i> Commit to OntServe</h5>
        </div>
        <div class="card-body">
            <p>Commit these temporal entities to OntServe permanent storage for use across cases.</p>

            <div class="alert alert-info">
                <strong>What will be committed:</strong>
                <ul class="mb-0">
                    <li><strong>Actions ({{summary.actions }})</strong> - Individual actions as case-specific entities</li>
                    <li><strong>Events ({{ summary.events }})</strong> - Individual events as case-specific entities</li>
                    <li><strong>Allen Relations ({{ summary.allen_relations }})</strong> - Temporal relationships with OWL-Time properties</li>
                    <li><strong>Causal Chains ({{ summary.causal_chains }})</strong> - NESS test causal analysis</li>
                    {% if summary.has_timeline %}<li><strong>Timeline</strong> - Complete temporal structure</li>{% endif %}
                </ul>
            </div>

            <button id="commit-temporal-btn" class="btn btn-success" onclick="commitTemporalEntities()">
                <i class="bi bi-database-add"></i> Commit All Temporal Entities to OntServe
            </button>

            <div id="commit-status" class="mt-3" style="display: none;"></div>
        </div>
    </div>
    {% endif %}

    {% endif %}
</div>
{% endblock %}

{% block step_styles %}
<style>
    .accordion-button:not(.collapsed) {
        background-color: rgba(13, 110, 253, 0.1);
    }
    details summary {
        cursor: pointer;
    }
    pre code {
        display: block;
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block step_scripts %}
<script>
function getCsrfToken() {
    return document.querySelector('meta[name="csrf-token"]')?.content || '';
}

function commitTemporalEntities() {
    const button = document.getElementById('commit-temporal-btn');
    const statusDiv = document.getElementById('commit-status');

    // Disable button and show loading
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Committing...';
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Committing temporal entities to OntServe...</div>';

    // Get all temporal entity IDs
    fetch('/scenario_pipeline/case/{{ case.id }}/entities/temporal/commit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6><i class="bi bi-check-circle"></i> Success!</h6>
                    <p>${data.message}</p>
                    <ul class="mb-0">
                        <li><strong>Actions committed:</strong> ${data.result.actions_committed || 0}</li>
                        <li><strong>Events committed:</strong> ${data.result.events_committed || 0}</li>
                        <li><strong>Allen relations committed:</strong> ${data.result.allen_relations_committed || 0}</li>
                        <li><strong>Causal chains committed:</strong> ${data.result.causal_chains_committed || 0}</li>
                        <li><strong>Timeline committed:</strong> ${data.result.timeline_committed || 0}</li>
                    </ul>
                </div>
            `;
            button.innerHTML = '<i class="bi bi-check-circle"></i> Committed Successfully';
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-success');
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="bi bi-exclamation-triangle"></i> Error</h6>
                    <p>${data.error || 'Failed to commit entities'}</p>
                </div>
            `;
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-database-add"></i> Commit All Temporal Entities to OntServe';
        }
    })
    .catch(error => {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle"></i> Error</h6>
                <p>Failed to commit entities: ${error.message}</p>
            </div>
        `;
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-database-add"></i> Commit All Temporal Entities to OntServe';
    });
}
</script>
{% endblock %}
