{% extends "base.html" %}

{% block title %}Simulate Scenario - {{ scenario.name }} - AI Ethical Decision-Making Simulator{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ scenario.name }} - Simulation</h1>
        <div class="btn-group" role="group">
            <a href="/scenarios/{{ scenario.id }}" class="btn btn-secondary">Back to Scenario</a>
            <button id="save-simulation" class="btn btn-primary">Save Simulation</button>
        </div>
    </div>

    <!-- Character Selection -->
    <div id="character-selection" class="card mb-4">
        <div class="card-header">
            <h3>Select Character Perspective</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label for="character-select">Choose a character:</label>
                <select id="character-select" class="form-control">
                    <option value="">All Perspectives</option>
                    {% for character in characters %}
                    <option value="{{ character.id }}">{{ character.name }} ({{ character.role }})</option>
                    {% endfor %}
                </select>
            </div>
            <button id="start-simulation" class="btn btn-primary mt-3">Start Simulation</button>
        </div>
    </div>

    <!-- Simulation Interface (initially hidden) -->
    <div id="simulation-interface" style="display: none;">
        <!-- Timeline Display -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Timeline</h3>
            </div>
            <div class="card-body">
                <div id="timeline-display" class="timeline">
                    <!-- Timeline events will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Current Event -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Current Event</h3>
            </div>
            <div class="card-body">
                <div id="current-event" class="mb-4">
                    <!-- Current event details will be inserted here -->
                </div>

                <div id="decision-point" style="display: none;">
                    <h4>Decision Point</h4>
                    <div id="decision-options">
                        <!-- Decision options will be inserted here -->
                    </div>
                </div>

                <div id="navigation-controls" class="mt-4">
                    <button id="next-event-btn" class="btn btn-primary">Next</button>
                </div>
            </div>
        </div>

        <!-- Ethical Analysis -->
        <div class="card mb-4">
            <div class="card-header">
                <h3>Ethical Analysis</h3>
            </div>
            <div class="card-body">
                <div id="ethical-analysis">
                    <!-- Ethical analysis will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add custom CSS for timeline -->
<style>
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline:before {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        left: 20px;
        width: 4px;
        background: #ddd;
    }

    .timeline-event {
        position: relative;
        margin-bottom: 30px;
        margin-left: 40px;
    }

    .timeline-event:before {
        content: '';
        position: absolute;
        top: 10px;
        left: -36px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #007bff;
    }

    .timeline-event.current:before {
        background: #dc3545;
        width: 20px;
        height: 20px;
        left: -38px;
        top: 8px;
    }

    .timeline-event-time {
        font-weight: bold;
        margin-bottom: 5px;
        color: #666;
    }

    .timeline-event-content {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .timeline-event-content.decision-point {
        background: #fff8e1;
        border-left: 4px solid #ffc107;
    }

    .timeline-event.current .timeline-event-content {
        background: #f8f9fa;
        border-left: 4px solid #dc3545;
    }

    .timeline-event.current .timeline-event-content.decision-point {
        background: #fff4e5;
        border-left: 4px solid #dc3545;
    }

    .timeline-decision {
        position: relative;
        margin-bottom: 30px;
        margin-left: 60px;
    }

    .timeline-decision:before {
        content: '';
        position: absolute;
        top: 10px;
        left: -36px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #28a745;
    }

    .timeline-decision-content {
        padding: 15px;
        background: #f0f9f0;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #28a745;
        margin-bottom: 10px;
    }

    .decision-evaluation {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 3px solid #17a2b8;
    }

    .decision-option {
        margin-bottom: 10px;
    }

    .decision-option-btn {
        width: 100%;
        text-align: left;
        white-space: normal;
    }
</style>

<!-- JavaScript for simulation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize variables
        let simulationState = null;
        let simulationSessionId = null;

        // Start simulation button
        document.getElementById('start-simulation').addEventListener('click', function () {
            const characterId = document.getElementById('character-select').value;

            // Initialize simulation
            fetch(`/simulation/scenario/{{ scenario.id }}/initialize`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    character_id: characterId ? parseInt(characterId) : null,
                    perspective: characterId ? 'specific' : 'all'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Hide character selection
                        document.getElementById('character-selection').style.display = 'none';

                        // Show simulation interface
                        document.getElementById('simulation-interface').style.display = 'block';

                        // Update state and session ID
                        simulationState = data.initial_state;
                        simulationSessionId = data.session_id;

                        // Update UI
                        updateSimulationUI(simulationState);
                    } else {
                        alert('Error initializing simulation: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error initializing simulation:', error);
                    alert('Error initializing simulation. See console for details.');
                });
        });

        // Save simulation button
        document.getElementById('save-simulation').addEventListener('click', function () {
            if (!simulationState) {
                alert('No simulation to save. Please start a simulation first.');
                return;
            }

            // Check if we have a session ID
            if (!simulationSessionId) {
                alert('Session ID not found. Please restart the simulation.');
                return;
            }

            fetch(`/simulation/scenario/{{ scenario.id }}/save`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: simulationSessionId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Simulation saved successfully!');
                    } else {
                        alert('Error saving simulation: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error saving simulation:', error);
                    alert('Error saving simulation. See console for details.');
                });
        });

        // Function to update the simulation UI
        function updateSimulationUI(state) {
            // Update timeline
            updateTimeline(state);

            // Update current event
            updateCurrentEvent(state);

            // Update decision point if present
            if (state.current_event_index < state.events.length &&
                isDecisionPoint(state.events[state.current_event_index])) {
                showDecisionPoint(state.events[state.current_event_index]);
            } else {
                hideDecisionPoint();
            }

            // Update ethical analysis if present
            if (state.evaluation) {
                updateEthicalAnalysis(state.evaluation);
            }
        }

        // Function to update the timeline display
        function updateTimeline(state) {
            const timelineDisplay = document.getElementById('timeline-display');
            timelineDisplay.innerHTML = '';

            console.log("Updating timeline with state:", state);
            console.log("Decision history:", state.decision_history);

            // Create a map of decisions by event index for quick lookup
            const decisionsByEventIndex = {};
            if (state.decision_history && state.decision_history.length > 0) {
                state.decision_history.forEach(historyItem => {
                    decisionsByEventIndex[historyItem.event_index] = historyItem;
                });
            }

            console.log("Decisions by event index:", decisionsByEventIndex);

            // Add events to timeline
            state.events.forEach((event, index) => {
                if (index <= state.current_event_index) {
                    // Add the event
                    const eventElement = document.createElement('div');
                    eventElement.className = 'timeline-event';

                    // Highlight the current event
                    if (index === state.current_event_index) {
                        eventElement.classList.add('current');
                    }

                    // Determine if this is a decision point
                    const isDecisionPoint = event.action_id !== null &&
                        (event.action && event.action.is_decision);

                    // Add appropriate styling and content
                    eventElement.innerHTML = `
                        <div class="timeline-event-time">${formatTime(event.event_time)}</div>
                        <div class="timeline-event-content ${isDecisionPoint ? 'decision-point' : ''}">
                            <h5>${event.description}</h5>
                            ${isDecisionPoint ?
                            '<span class="badge bg-warning">Decision Required</span>' :
                            (event.action_id ? '<span class="badge bg-info">Action</span>' : '')}
                        </div>
                    `;
                    timelineDisplay.appendChild(eventElement);

                    // Check if this event has a decision attached directly or in the history
                    const hasDirectDecision = event.decision !== undefined;
                    const hasHistoryDecision = decisionsByEventIndex[index] !== undefined;

                    console.log(`Event ${index}: hasDirectDecision=${hasDirectDecision}, hasHistoryDecision=${hasHistoryDecision}`);

                    // Get the decision from either the event or the history
                    const decision = hasDirectDecision ? event.decision :
                        (hasHistoryDecision ? decisionsByEventIndex[index].decision : null);

                    // Get the evaluation from either the event or the history
                    const evaluation = hasDirectDecision ? event.evaluation :
                        (hasHistoryDecision ? decisionsByEventIndex[index].evaluation : null);

                    if (decision) {
                        // Add the decision
                        const decisionElement = document.createElement('div');
                        decisionElement.className = 'timeline-decision';

                        // Get the option description - first try from the decision record itself
                        let optionDescription = decision.option_description || `Option ${decision.option_id}`;

                        // If not found in the decision record, try to find it in the decision options
                        if (!decision.option_description && event.decision_options) {
                            const selectedOption = event.decision_options.find(opt => opt.id === decision.option_id);
                            if (selectedOption) {
                                optionDescription = selectedOption.description;
                            }
                        }

                        // Get character info if available
                        let characterInfo = '';
                        if (decision.character_id && state.character_states && state.character_states[decision.character_id]) {
                            const character = state.character_states[decision.character_id];
                            characterInfo = `<p><strong>Character:</strong> ${character.name} (${character.role})</p>`;
                        }

                        // Create decision content with a more prominent display
                        let decisionContent = `
                            <div class="timeline-decision-content">
                                <h5>Decision Made</h5>
                                ${characterInfo}
                                <p><strong>Selected:</strong> ${optionDescription}</p>
                        `;

                        // Add evaluation summary if available
                        if (evaluation && evaluation.structured_evaluation) {
                            const eval = evaluation.structured_evaluation;
                            decisionContent += `
                                <div class="decision-evaluation">
                                    <p><strong>Ethical Alignment:</strong> ${eval.alignment_score}/10</p>
                                    <p><strong>Virtues Demonstrated:</strong> ${eval.virtues_demonstrated.join(', ')}</p>
                            `;

                            if (eval.virtues_violated && eval.virtues_violated.length > 0) {
                                decisionContent += `
                                    <p><strong>Virtues Violated:</strong> ${eval.virtues_violated.join(', ')}</p>
                                `;
                            }

                            decisionContent += `
                                    <p><strong>Reflection:</strong> ${eval.character_reflection}</p>
                                </div>
                            `;
                        }

                        decisionContent += `</div>`;
                        decisionElement.innerHTML = decisionContent;
                        timelineDisplay.appendChild(decisionElement);
                    }
                }
            });
        }

        // Function to update the current event display
        function updateCurrentEvent(state) {
            const currentEventDisplay = document.getElementById('current-event');
            const nextButton = document.getElementById('next-event-btn');

            if (state.current_event_index >= state.events.length) {
                currentEventDisplay.innerHTML = `
                    <div class="alert alert-info">
                        <h4>Simulation Complete</h4>
                        <p>You have reached the end of the scenario timeline.</p>
                    </div>
                `;
                nextButton.style.display = 'none';
                return;
            }

            const currentEvent = state.events[state.current_event_index];

            // Get character name if available
            let characterName = '';
            if (currentEvent.character_id && state.character_states[currentEvent.character_id]) {
                characterName = state.character_states[currentEvent.character_id].name;
            }

            currentEventDisplay.innerHTML = `
                <h4>${formatTime(currentEvent.event_time)}</h4>
                <p>${currentEvent.description}</p>
                ${characterName ? `<p><strong>Character:</strong> ${characterName}</p>` : ''}
            `;

            // Show or hide the next button based on whether this is a decision point
            if (isDecisionPoint(currentEvent)) {
                nextButton.style.display = 'none';
            } else {
                nextButton.style.display = 'inline-block';
            }
        }

        // Function to check if an event is a decision point
        function isDecisionPoint(event) {
            // Check if the event has an action_id
            if (event.action_id === null || event.action_id === undefined) {
                return false;
            }

            // If the event has action data, check if it's a decision
            if (event.action && event.action.is_decision !== undefined) {
                return event.action.is_decision;
            }

            // Otherwise, consider it a decision point if it has decision options
            return event.decision_options && event.decision_options.length > 0;
        }

        // Function to show decision point
        function showDecisionPoint(event) {
            const decisionPointDisplay = document.getElementById('decision-point');
            const decisionOptionsDisplay = document.getElementById('decision-options');
            const nextButton = document.getElementById('next-event-btn');

            decisionPointDisplay.style.display = 'block';
            decisionOptionsDisplay.innerHTML = '';
            nextButton.style.display = 'none';

            // Log the event to help with debugging
            console.log("Showing decision point for event:", event);

            // Prioritize options in this order:
            // 1. Pre-existing decision options from the database
            // 2. Options from the action object
            // 3. Default fallback options
            let options;

            if (event.decision_options && event.decision_options.length > 0) {
                console.log("Using pre-existing decision options from the database");
                options = event.decision_options;
            } else if (event.action && event.action.options && event.action.options.length > 0) {
                console.log("Using options from the action object");
                options = event.action.options;
            } else {
                console.log("Using default fallback options");
                options = [
                    { id: 1, description: 'Option 1: Take the ethical high ground' },
                    { id: 2, description: 'Option 2: Compromise for practical reasons' },
                    { id: 3, description: 'Option 3: Prioritize efficiency over other considerations' }
                ];
            }

            // Add decision options with improved styling
            options.forEach(option => {
                const optionElement = document.createElement('div');
                optionElement.className = 'decision-option mb-2';

                // Extract the option number and description for better formatting
                let optionText = option.description;
                let optionClass = 'btn-outline-primary';

                // Apply different styling based on the option content
                if (optionText.toLowerCase().includes('ethical') ||
                    optionText.toLowerCase().includes('integrity') ||
                    optionText.toLowerCase().includes('welfare') ||
                    optionText.toLowerCase().includes('safety')) {
                    optionClass = 'btn-outline-success';
                } else if (optionText.toLowerCase().includes('compromise') ||
                    optionText.toLowerCase().includes('balance')) {
                    optionClass = 'btn-outline-info';
                } else if (optionText.toLowerCase().includes('efficiency') ||
                    optionText.toLowerCase().includes('prioritize')) {
                    optionClass = 'btn-outline-warning';
                }

                optionElement.innerHTML = `
                    <button class="btn ${optionClass} decision-option-btn" data-option="${option.id}">
                        ${optionText}
                    </button>
                `;
                decisionOptionsDisplay.appendChild(optionElement);
            });

            // Add event listeners to decision buttons
            document.querySelectorAll('.decision-option-btn').forEach(button => {
                button.addEventListener('click', function () {
                    const optionId = parseInt(this.getAttribute('data-option'));
                    makeDecision(optionId, event);
                });
            });
        }

        // Function to hide decision point
        function hideDecisionPoint() {
            document.getElementById('decision-point').style.display = 'none';
            document.getElementById('next-event-btn').style.display = 'inline-block';
        }

        // Function to update ethical analysis
        function updateEthicalAnalysis(evaluation) {
            const analysisDisplay = document.getElementById('ethical-analysis');

            if (evaluation.structured_evaluation) {
                const structured = evaluation.structured_evaluation;
                analysisDisplay.innerHTML = `
                    <h4>Virtue Ethics Analysis</h4>
                    <p><strong>Alignment with Role Virtues:</strong> ${structured.alignment_score}/10</p>
                    
                    <h5>Virtues Demonstrated:</h5>
                    <ul>
                        ${structured.virtues_demonstrated.map(v => `<li>${v}</li>`).join('')}
                    </ul>
                    
                    ${structured.virtues_violated.length > 0 ? `
                        <h5>Virtues Violated:</h5>
                        <ul>
                            ${structured.virtues_violated.map(v => `<li>${v}</li>`).join('')}
                        </ul>
                    ` : ''}
                    
                    <h5>Character Reflection:</h5>
                    <p>${structured.character_reflection}</p>
                    
                    <h5>Recommendations:</h5>
                    <p>${structured.recommendations}</p>
                `;
            } else {
                analysisDisplay.innerHTML = `
                    <h4>Ethical Analysis</h4>
                    <p>${evaluation.raw_evaluation}</p>
                `;
            }
        }

        // Function to make a decision
        function makeDecision(optionId, event) {
            // Check if we have a session ID
            if (!simulationSessionId) {
                alert('Session ID not found. Please restart the simulation.');
                return;
            }

            fetch(`/simulation/scenario/{{ scenario.id }}/decision`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    option_id: optionId,
                    character_id: event.character_id,
                    event_id: event.id,
                    session_id: simulationSessionId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update state
                        simulationState = data.next_state;

                        // Update UI
                        updateSimulationUI(simulationState);

                        // Show evaluation
                        updateEthicalAnalysis(data.evaluation);
                    } else {
                        alert('Error processing decision: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error processing decision:', error);
                    // Try to get more detailed error information
                    error.text().then(errorText => {
                        try {
                            const errorData = JSON.parse(errorText);
                            alert(`Error processing decision: ${errorData.message || 'Unknown error'}`);
                            console.error('Detailed error:', errorData);
                        } catch (e) {
                            alert(`Error processing decision: ${errorText || error.message || 'Unknown error'}`);
                            console.error('Error text:', errorText);
                        }
                    }).catch(e => {
                        alert(`Error processing decision: ${error.message || 'Unknown error'}`);
                    });
                });
        }

        // Function to advance to the next event
        function advanceToNextEvent() {
            // Check if we have a session ID
            if (!simulationSessionId) {
                alert('Session ID not found. Please restart the simulation.');
                return;
            }

            fetch(`/simulation/scenario/{{ scenario.id }}/advance`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: simulationSessionId
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update state
                        simulationState = data.next_state;

                        // Update UI
                        updateSimulationUI(simulationState);
                    } else {
                        alert('Error advancing to next event: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error advancing to next event:', error);
                    // Try to get more detailed error information
                    error.text().then(errorText => {
                        try {
                            const errorData = JSON.parse(errorText);
                            alert(`Error advancing to next event: ${errorData.message || 'Unknown error'}`);
                            console.error('Detailed error:', errorData);
                        } catch (e) {
                            alert(`Error advancing to next event: ${errorText || error.message || 'Unknown error'}`);
                            console.error('Error text:', errorText);
                        }
                    }).catch(e => {
                        alert(`Error advancing to next event: ${error.message || 'Unknown error'}`);
                    });
                });
        }

        // Add event listener for next button
        document.getElementById('next-event-btn').addEventListener('click', advanceToNextEvent);

        // Helper function to format time
        function formatTime(timeString) {
            if (!timeString) return 'Unknown time';

            const date = new Date(timeString);
            return date.toLocaleString();
        }
    });
</script>
{% endblock %}