{% extends "base.html" %}

{% block title %}Case Similarity Network - ProEthica{% endblock %}

{% block styles %}
<style>
    #network-container {
        width: 100%;
        height: 700px;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        background: #fafafa;
        position: relative;
    }

    #network-svg {
        width: 100%;
        height: 100%;
    }

    .node {
        cursor: pointer;
    }

    .node circle {
        stroke: #fff;
        stroke-width: 2px;
        transition: all 0.2s ease;
    }

    .node.focus circle {
        stroke: #ffc107;
        stroke-width: 4px;
    }

    .node:hover circle {
        stroke: #333;
        stroke-width: 3px;
        filter: brightness(1.1);
    }

    .node text {
        font-size: 11px;
        font-family: 'Segoe UI', sans-serif;
        pointer-events: none;
        text-anchor: middle;
        fill: #333;
    }

    .link {
        fill: none;
        stroke-opacity: 0.6;
        transition: all 0.2s ease;
    }

    .link:hover {
        stroke-opacity: 1;
    }

    .link.highlighted {
        stroke-opacity: 1;
        stroke-width: 4px !important;
    }

    #details-panel {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 340px;
        max-height: 500px;
        overflow-y: auto;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
        z-index: 100;
    }

    #details-panel.visible {
        display: block;
    }

    #details-panel h6 {
        margin-bottom: 10px;
        padding-bottom: 8px;
        border-bottom: 2px solid;
    }

    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 15px;
        margin-bottom: 5px;
        font-size: 12px;
    }

    .legend-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        margin-right: 6px;
        border: 2px solid #fff;
        box-shadow: 0 0 3px rgba(0,0,0,0.3);
    }

    #zoom-controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        z-index: 100;
    }

    #zoom-controls button {
        width: 36px;
        height: 36px;
        margin: 2px;
    }

    .score-bar-mini {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin: 4px 0;
    }

    .score-fill-mini {
        height: 100%;
        border-radius: 4px;
    }

    .component-row-mini {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.85rem;
    }

    .component-label-mini {
        width: 100px;
        color: #666;
    }

    .component-bar-mini {
        flex: 1;
        margin: 0 8px;
    }

    .component-value-mini {
        width: 40px;
        text-align: right;
        font-family: monospace;
        font-weight: 500;
    }

    .edge-info {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
    }

    .provision-tag {
        display: inline-block;
        padding: 2px 6px;
        margin: 2px;
        background: #e7f1ff;
        color: #0d6efd;
        border-radius: 3px;
        font-size: 0.75rem;
    }

    #filter-controls {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 100;
        background: white;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h1 class="mb-2">Case Similarity Network</h1>
            <p class="text-muted">
                Interactive visualization of case similarities based on multi-factor analysis.
                {% if focus_case %}
                Focused on: <strong>{{ focus_case.title }}</strong>
                {% endif %}
            </p>
        </div>
        <div class="col-auto">
            <a href="{{ url_for('precedents.find_precedents') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Precedent Finder
            </a>
        </div>
    </div>

    <!-- Legend -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="d-flex flex-wrap align-items-center mb-2">
                <span class="me-3 text-muted small"><strong>Node Color (Outcome):</strong></span>
                <span class="legend-item">
                    <span class="legend-dot" style="background-color: #4CAF50;"></span>Ethical
                </span>
                <span class="legend-item">
                    <span class="legend-dot" style="background-color: #F44336;"></span>Unethical
                </span>
                <span class="legend-item">
                    <span class="legend-dot" style="background-color: #FF9800;"></span>Mixed
                </span>
                <span class="legend-item">
                    <span class="legend-dot" style="background-color: #9E9E9E;"></span>Unclear
                </span>
                <span class="mx-3 text-muted">|</span>
                <span class="me-3 text-muted small"><strong>Edge Color (Similarity):</strong></span>
                <span class="legend-item">
                    <span class="legend-dot" style="background-color: #4CAF50;"></span>&gt;0.5
                </span>
                <span class="legend-item">
                    <span class="legend-dot" style="background-color: #FFC107;"></span>0.3-0.5
                </span>
                <span class="legend-item">
                    <span class="legend-dot" style="background-color: #F44336;"></span>&lt;0.3
                </span>
            </div>
            <div class="d-flex flex-wrap align-items-center">
                <span class="me-3 text-muted small"><strong>Transformation Type:</strong></span>
                <span class="legend-item">
                    <span class="badge" style="background-color: #0d6efd; font-size: 0.65rem;">Transfer</span>
                </span>
                <span class="legend-item">
                    <span class="badge" style="background-color: #dc3545; font-size: 0.65rem;">Stalemate</span>
                </span>
                <span class="legend-item">
                    <span class="badge" style="background-color: #fd7e14; font-size: 0.65rem;">Oscillation</span>
                </span>
                <span class="legend-item">
                    <span class="badge" style="background-color: #6f42c1; font-size: 0.65rem;">Phase Lag</span>
                </span>
                <small class="text-muted ms-2">(shown in details panel)</small>
            </div>
        </div>
    </div>

    <!-- Network Container -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0"><i class="bi bi-diagram-3"></i> Similarity Network</h5>
                <small class="text-muted">
                    <span id="node-count">0</span> cases, <span id="edge-count">0</span> connections
                </small>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="d-flex align-items-center">
                    <label class="form-label mb-0 me-2 small">Min Score:</label>
                    <select class="form-select form-select-sm" id="min-score-select" style="width: 80px;">
                        <option value="0.1">0.1</option>
                        <option value="0.2" selected>0.2</option>
                        <option value="0.3">0.3</option>
                        <option value="0.4">0.4</option>
                        <option value="0.5">0.5</option>
                    </select>
                </div>
                <button class="btn btn-sm btn-outline-primary" id="refresh-btn">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div id="network-container">
                <svg id="network-svg"></svg>

                <!-- Details Panel -->
                <div id="details-panel">
                    <button type="button" class="btn-close float-end" id="close-details"></button>
                    <div id="node-details" style="display: none;">
                        <h6 id="detail-title" style="border-color: #666;">Case Details</h6>
                        <p class="mb-2">
                            <span class="badge" id="detail-outcome-badge">Outcome</span>
                            <span class="badge bg-secondary" id="detail-transform-badge">Transform</span>
                        </p>
                        <p class="small text-muted mb-2" id="detail-full-title"></p>
                        <div class="mb-2">
                            <strong class="small">Provisions:</strong>
                            <div id="detail-provisions"></div>
                        </div>
                        <p class="small mb-1">
                            <strong>Entities:</strong> <span id="detail-entity-count">0</span>
                        </p>
                        <hr>
                        <p class="small mb-1"><strong>Connected Cases:</strong></p>
                        <ul class="small list-unstyled" id="detail-connections"></ul>
                    </div>
                    <div id="edge-details" style="display: none;">
                        <h6 style="border-color: #0d6efd;">Connection Details</h6>
                        <p class="mb-2">
                            <span id="edge-source-label" class="fw-bold"></span>
                            <i class="bi bi-arrow-left-right mx-2"></i>
                            <span id="edge-target-label" class="fw-bold"></span>
                        </p>
                        <div class="edge-info">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold">Overall Similarity:</span>
                                <span class="fw-bold" id="edge-overall-score">0.00</span>
                            </div>
                            <div id="edge-components"></div>
                        </div>
                        <div class="mt-2">
                            <strong class="small">Matching Provisions:</strong>
                            <div id="edge-provisions"></div>
                        </div>
                    </div>
                </div>

                <!-- Zoom Controls -->
                <div id="zoom-controls">
                    <button class="btn btn-sm btn-light" id="zoom-in" title="Zoom In">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="zoom-out" title="Zoom Out">
                        <i class="bi bi-dash-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-light" id="zoom-reset" title="Reset View">
                        <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Method Reference -->
    <div class="card mt-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Similarity Methods</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for key, method in matching_methods.items() %}
                <div class="col-md-4 mb-2">
                    <strong>{{ method.name }}</strong>
                    <span class="badge bg-secondary ms-1">{{ method.method }}</span>
                    <p class="small text-muted mb-0">{{ method.description }}</p>
                    {% if method.citation %}
                    <small class="text-muted fst-italic">{{ method.citation }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('network-container');
    const svg = d3.select('#network-svg');
    const focusCaseId = {{ focus_case_id|tojson }};

    let graphData = null;
    let simulation = null;

    // Color scales
    const outcomeColors = {
        'ethical': '#4CAF50',
        'unethical': '#F44336',
        'mixed': '#FF9800',
        'unclear': '#9E9E9E',
        'unknown': '#9E9E9E'
    };

    function getEdgeColor(similarity) {
        if (similarity >= 0.5) return '#4CAF50';
        if (similarity >= 0.3) return '#FFC107';
        return '#F44336';
    }

    function loadNetwork() {
        const minScore = document.getElementById('min-score-select').value;
        let url = `/cases/precedents/api/similarity_network?min_score=${minScore}`;
        if (focusCaseId) {
            url += `&case_id=${focusCaseId}`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    graphData = data;
                    renderNetwork(data);
                    updateStats(data.metadata);
                } else {
                    console.error('Failed to load network:', data.error);
                    alert('Failed to load network: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error fetching network:', error);
            });
    }

    function renderNetwork(data) {
        const width = container.clientWidth;
        const height = container.clientHeight;

        svg.selectAll('*').remove();

        // Create zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.2, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // Create container group for zoom
        const g = svg.append('g');

        // Create simulation
        simulation = d3.forceSimulation(data.nodes)
            .force('link', d3.forceLink(data.edges)
                .id(d => d.id)
                .distance(d => 150 - d.similarity * 100)
                .strength(d => d.similarity * 0.5))
            .force('charge', d3.forceManyBody().strength(-300))
            .force('center', d3.forceCenter(width / 2, height / 2))
            .force('collision', d3.forceCollide().radius(40));

        // Create edges
        const link = g.append('g')
            .attr('class', 'links')
            .selectAll('line')
            .data(data.edges)
            .enter().append('line')
            .attr('class', 'link')
            .attr('stroke', d => getEdgeColor(d.similarity))
            .attr('stroke-width', d => 1 + d.similarity * 4)
            .on('click', showEdgeDetails)
            .on('mouseover', function(event, d) {
                d3.select(this).classed('highlighted', true);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).classed('highlighted', false);
            });

        // Create nodes
        const node = g.append('g')
            .attr('class', 'nodes')
            .selectAll('g')
            .data(data.nodes)
            .enter().append('g')
            .attr('class', d => 'node' + (d.is_focus ? ' focus' : ''))
            .call(d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended))
            .on('click', showNodeDetails)
            .on('mouseover', highlightConnections)
            .on('mouseout', unhighlightConnections);

        // Node circles
        node.append('circle')
            .attr('r', d => d.is_focus ? 20 : 14)
            .attr('fill', d => outcomeColors[d.outcome] || outcomeColors['unknown']);

        // Node labels
        node.append('text')
            .attr('dy', d => (d.is_focus ? 20 : 14) + 14)
            .text(d => d.label)
            .attr('fill', '#333');

        // Update positions on tick
        simulation.on('tick', () => {
            link
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            node.attr('transform', d => `translate(${d.x},${d.y})`);
        });

        // Update counts
        document.getElementById('node-count').textContent = data.nodes.length;
        document.getElementById('edge-count').textContent = data.edges.length;

        // Zoom controls
        document.getElementById('zoom-in').onclick = () => {
            svg.transition().call(zoom.scaleBy, 1.3);
        };
        document.getElementById('zoom-out').onclick = () => {
            svg.transition().call(zoom.scaleBy, 0.7);
        };
        document.getElementById('zoom-reset').onclick = () => {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        };
    }

    function showNodeDetails(event, d) {
        const panel = document.getElementById('details-panel');
        document.getElementById('node-details').style.display = 'block';
        document.getElementById('edge-details').style.display = 'none';

        document.getElementById('detail-title').textContent = d.label;
        document.getElementById('detail-title').style.borderColor = outcomeColors[d.outcome];
        document.getElementById('detail-full-title').textContent = d.full_title;

        const outcomeBadge = document.getElementById('detail-outcome-badge');
        outcomeBadge.textContent = d.outcome;
        outcomeBadge.style.backgroundColor = outcomeColors[d.outcome];

        const transformBadge = document.getElementById('detail-transform-badge');
        if (d.transformation) {
            transformBadge.textContent = d.transformation;
            transformBadge.style.display = 'inline';
        } else {
            transformBadge.style.display = 'none';
        }

        // Provisions
        const provDiv = document.getElementById('detail-provisions');
        if (d.provisions && d.provisions.length > 0) {
            provDiv.innerHTML = d.provisions.map(p =>
                `<span class="provision-tag">${p}</span>`
            ).join('');
        } else {
            provDiv.innerHTML = '<span class="text-muted small">None</span>';
        }

        document.getElementById('detail-entity-count').textContent = d.entity_count;

        // Find connections
        const connections = graphData.edges.filter(e =>
            e.source.id === d.id || e.target.id === d.id ||
            e.source === d.id || e.target === d.id
        );

        const connList = document.getElementById('detail-connections');
        connList.innerHTML = '';

        if (connections.length === 0) {
            connList.innerHTML = '<li class="text-muted">No connections at current threshold</li>';
        } else {
            connections.slice(0, 10).forEach(conn => {
                const otherId = (conn.source.id || conn.source) === d.id ?
                    (conn.target.id || conn.target) : (conn.source.id || conn.source);
                const otherNode = graphData.nodes.find(n => n.id === otherId);
                if (otherNode) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span style="color:${outcomeColors[otherNode.outcome]}">&#9679;</span> ${otherNode.label} <span class="text-muted">(${conn.similarity.toFixed(2)})</span>`;
                    connList.appendChild(li);
                }
            });
        }

        panel.classList.add('visible');
    }

    function showEdgeDetails(event, d) {
        const panel = document.getElementById('details-panel');
        document.getElementById('node-details').style.display = 'none';
        document.getElementById('edge-details').style.display = 'block';

        const sourceNode = graphData.nodes.find(n => n.id === (d.source.id || d.source));
        const targetNode = graphData.nodes.find(n => n.id === (d.target.id || d.target));

        document.getElementById('edge-source-label').textContent = sourceNode ? sourceNode.label : 'Unknown';
        document.getElementById('edge-target-label').textContent = targetNode ? targetNode.label : 'Unknown';
        document.getElementById('edge-overall-score').textContent = d.similarity.toFixed(3);

        // Component breakdown
        const compDiv = document.getElementById('edge-components');
        compDiv.innerHTML = '';

        const componentLabels = {
            'facts_similarity': 'Facts',
            'discussion_similarity': 'Discussion',
            'provision_overlap': 'Provisions',
            'outcome_alignment': 'Outcome',
            'tag_overlap': 'Tags',
            'principle_overlap': 'Principles'
        };

        for (const [key, label] of Object.entries(componentLabels)) {
            const score = d.components[key] || 0;
            const color = score >= 0.5 ? '#4CAF50' : (score >= 0.3 ? '#FFC107' : '#F44336');

            compDiv.innerHTML += `
                <div class="component-row-mini">
                    <span class="component-label-mini">${label}</span>
                    <div class="component-bar-mini">
                        <div class="score-bar-mini">
                            <div class="score-fill-mini" style="width: ${score * 100}%; background: ${color};"></div>
                        </div>
                    </div>
                    <span class="component-value-mini">${score.toFixed(2)}</span>
                </div>
            `;
        }

        // Matching provisions
        const provDiv = document.getElementById('edge-provisions');
        if (d.matching_provisions && d.matching_provisions.length > 0) {
            provDiv.innerHTML = d.matching_provisions.map(p =>
                `<span class="provision-tag">${p}</span>`
            ).join('');
        } else {
            provDiv.innerHTML = '<span class="text-muted small">None</span>';
        }

        panel.classList.add('visible');
    }

    function highlightConnections(event, d) {
        d3.selectAll('.link')
            .classed('highlighted', l =>
                (l.source.id || l.source) === d.id || (l.target.id || l.target) === d.id
            );
    }

    function unhighlightConnections() {
        d3.selectAll('.link').classed('highlighted', false);
    }

    function dragstarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }

    function dragended(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    function updateStats(metadata) {
        // Could add more stats display here
        console.log('Network metadata:', metadata);
    }

    // Event listeners
    document.getElementById('close-details').addEventListener('click', function() {
        document.getElementById('details-panel').classList.remove('visible');
    });

    document.getElementById('min-score-select').addEventListener('change', loadNetwork);
    document.getElementById('refresh-btn').addEventListener('click', loadNetwork);

    // Initial load
    loadNetwork();
});
</script>
{% endblock %}
