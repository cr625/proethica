{% extends "base.html" %}

{% block title %}Review Guideline Concepts - {{ guideline.title }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <h1>Review Extracted Concepts</h1>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('index.index') }}">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('worlds.view_world', id=world.id) }}">{{ world.name }}</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('worlds.world_guidelines', id=world.id) }}">Guidelines</a></li>
      <li class="breadcrumb-item"><a
          href="{{ url_for('worlds.view_guideline', id=world_id or world.id, document_id=document_id or guideline.id) }}">{{
          guideline.title }}</a></li>
      <li class="breadcrumb-item active">Review Concepts</li>
    </ol>
  </nav>

  <div class="alert alert-info">
    <h4 class="alert-heading">Enhanced Ontology-Aware Analysis</h4>
    <p>You are at step 2 of the guideline analysis process:</p>
    <ol>
      <li><strong>Extract concepts</strong> ✓ - Completed with ontology matching</li>
      <li><strong>Review concepts</strong> - You are here</li>
      <li><strong>Review and save triples</strong> - Next step</li>
    </ol>
    {% if stats %}
    <div class="mt-3">
      <h6>Analysis Results:</h6>
      <div class="row">
        <div class="col-md-3">
          <span class="badge bg-primary fs-6">{{ stats.total_concepts or concepts|length }} Total</span>
        </div>
        <div class="col-md-3">
          <span class="badge bg-success fs-6">{{ stats.matched_concepts or 0 }} Matched</span>
        </div>
        <div class="col-md-3">
          <span class="badge bg-warning fs-6">{{ stats.new_terms or 0 }} New</span>
        </div>
        <div class="col-md-3">
          <span class="badge bg-info fs-6">{{ stats.relationships or 0 }} Relations</span>
        </div>
      </div>
    </div>
    {% endif %}
    <hr>
    <p class="mb-0">Select concepts that accurately represent important ethical principles. 
      <strong>✅ Green badges</strong> show existing ontology matches, <strong>🆕 orange badges</strong> show new concepts.
    </p>
  </div>

  {% if llm_unavailable %}
  <div class="alert alert-warning">
    <h4 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Limited Functionality</h4>
    <p>The LLM (Large Language Model) service is currently unavailable. The following functionality is limited:</p>
    <ul>
      <li>Concept matching with ontology entities may not be available</li>
      <li>Triple generation preview may be limited</li>
    </ul>
    <p class="mb-0">You can still review and save the extracted concepts, but some advanced features may not work fully.
    </p>
  </div>
  {% endif %}

  {% set has_error_concepts = false %}
  {% for concept in concepts %}
    {% if not concept.is_new and not concept.ontology_match %}
      {% set has_error_concepts = true %}
    {% endif %}
  {% endfor %}

  {% if has_error_concepts %}
  <div class="alert alert-danger">
    <h4 class="alert-heading"><i class="fas fa-exclamation-circle"></i> Enhanced Matching Service Error</h4>
    <p>The enhanced ontology matching service (GuidelineAnalysisServiceV2) is not working properly. Concepts are missing required matching data.</p>
    <p class="mb-0"><strong>Debug Info:</strong> Check server logs for "CRITICAL: Concept missing enhanced match fields" errors.</p>
  </div>
  {% endif %}

  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Guideline Information</h5>
    </div>
    <div class="card-body">
      <h4>{{ guideline.title }}</h4>
      <p class="text-muted">
        <strong>Source:</strong>
        {% if guideline.source_url %}
        <a href="{{ guideline.source_url }}" target="_blank">{{ guideline.source_url }}</a>
        {% elif guideline.file_path %}
        Uploaded file: {{ guideline.file_path.split('/')[-1] }}
        {% else %}
        Manual entry
        {% endif %}
      </p>

      <div class="collapse" id="guidelineContent">
        <div class="card card-body bg-light">
          {% if guideline.content %}
          <div class="guideline-content">
            {% if guideline.content.startswith('#') or '##' in guideline.content %}
            <div class="markdown-content">
              {{ guideline.content|markdown|safe }}
            </div>
            {% else %}
            {{ guideline.content|safe }}
            {% endif %}
          </div>
          {% else %}
          <div class="alert alert-warning">No content available for this guideline.</div>
          {% endif %}
        </div>
      </div>

      <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
        data-bs-target="#guidelineContent">
        Show/Hide Content
      </button>
    </div>
  </div>

  <!-- Use the worlds.save_guideline_concepts route for saving concepts first -->
  <form method="post"
    action="{{ url_for('worlds.save_guideline_concepts', world_id=world.id, document_id=guideline.id) }}">
  <!-- CSRF token for Flask-WTF -->
  {% if csrf_token %}
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
  {% endif %}
    <!-- Include lightweight concepts reference instead of full JSON data -->
    <input type="hidden" name="concepts_data" id="concepts_data" value="cached_in_session" />
    <input type="hidden" name="concepts_count" value="{{ concepts|length }}" />
    <input type="hidden" name="ontology_source" value="{{ ontology_source or '' }}" />

    <!-- Preview of the triples that will be generated -->
    {% if preview_triples and preview_triples|length > 0 %}
    <div class="row mb-4">
      <div class="col">
        <div class="card border-dark">
          <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Generated RDF Triples Preview</h5>
            <div>
              <span class="badge bg-light text-dark">{{ triple_count }} triples</span>
              <button class="btn btn-sm btn-outline-light ms-2" type="button" data-bs-toggle="collapse"
                data-bs-target="#triplesPreview">
                <i class="fas fa-eye"></i> Show/Hide Triples
              </button>
            </div>
          </div>
          <div class="collapse" id="triplesPreview">
            <div class="card-body">
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> This is a preview of the RDF triples that will be generated from the
                selected concepts.
                These triples represent the semantic relationships that will be added to the knowledge graph.
              </div>

              <div class="table-responsive">
                <table class="table table-sm table-striped">
                  <thead class="table-dark">
                    <tr>
                      <th>Subject</th>
                      <th>Predicate</th>
                      <th>Object</th>
                      <th>Type</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for triple in preview_triples %}
                    <tr>
                      <td>
                        <span class="text-primary">{{ triple.subject_label or triple.subject }}</span>
                        <small class="d-block text-muted text-truncate" style="max-width: 250px;">{{ triple.subject
                          }}</small>
                      </td>
                      <td>
                        <span>{{ triple.predicate_label or triple.predicate.split('/')[-1] }}</span>
                      </td>
                      <td>
                        {% if triple.is_literal %}
                        <span class="text-success">"{{ triple.object }}"</span>
                        {% else %}
                        <span class="text-info">{{ triple.object_label or triple.object }}</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if triple.is_literal %}
                        <span class="badge bg-success">Literal</span>
                        {% else %}
                        <span class="badge bg-info">URI</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                    {% if preview_triples|length > 100 %}
                    <tr>
                      <td colspan="4" class="text-center">
                        <em>... and {{ preview_triples|length - 100 }} more triples (showing first 100 only)</em>
                      </td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>

              <div class="alert alert-warning mt-3">
                <strong>Note:</strong> This is just a preview. Only triples for the concepts you select will actually be
                saved.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="row mb-4">
      <div class="col">
        <div class="card border-info">
          <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Extracted Concepts ({{ concepts|length }})</h5>
            <div>
              <button type="button" class="btn btn-sm btn-outline-light me-2" id="selectAllBtn">Select All</button>
              <button type="button" class="btn btn-sm btn-outline-light" id="deselectAllBtn">Deselect All</button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th style="width: 50px;">Select</th>
                    <th style="width: 25%;">Concept</th>
                    <th style="width: 30%;">Type & Classification</th>
                    <th style="width: 30%;">Description</th>
                    <th style="width: 15%;">Ontology Match</th>
                  </tr>
                </thead>
                <tbody>
                  {% if concepts %}
                  {% for concept in concepts %}
                  <tr>
                    <td class="text-center">
                      <div class="form-check">
                        <input class="form-check-input concept-checkbox" type="checkbox" name="selected_concepts"
                          value="{{ loop.index0 }}" id="concept{{ loop.index }}" checked>
                        <label class="form-check-label" for="concept{{ loop.index }}"></label>
                      </div>
                    </td>
                    <td>
                      <div class="d-flex align-items-center">
                        {% set primary_type = (concept.primary_type or concept.type or '').lower() %}
                        {% set type_colors = {
                          'role': 'bg-primary',
                          'principle': 'bg-success', 
                          'obligation': 'bg-warning',
                          'state': 'bg-info',
                          'resource': 'bg-secondary',
                          'action': 'bg-danger',
                          'event': 'bg-dark',
                          'capability': 'bg-light text-dark'
                        } %}
                        {% set color_class = type_colors.get(primary_type, 'bg-secondary') %}
                        {% set display_type = primary_type.capitalize() if primary_type else 'Concept' %}
                        <span class="badge {{ color_class }} me-2">{{ display_type }}</span>
                        <strong>{{ concept.label }}</strong>
                      </div>
                    </td>
                    <td>
                      <div class="concept-type-display">
                        <!-- Manual Type Override Dropdown -->
                        {% set actual_type = concept.type or concept.primary_type or 'concept' %}
                        {% set dropdown_type = actual_type.lower() %}
                        <select class="form-select form-select-sm concept-type-override" 
                                data-concept-index="{{ loop.index0 }}"
                                data-original-type="{{ dropdown_type }}"
                                style="width: auto; margin-bottom: 0.25rem;">
                            <option value="role" {% if dropdown_type == 'role' %}selected{% endif %} class="text-primary">Role</option>
                            <option value="principle" {% if dropdown_type == 'principle' %}selected{% endif %} class="text-success">Principle</option>
                            <option value="obligation" {% if dropdown_type == 'obligation' %}selected{% endif %} class="text-warning">Obligation</option>
                            <option value="state" {% if dropdown_type == 'state' %}selected{% endif %} class="text-info">State</option>
                            <option value="resource" {% if dropdown_type == 'resource' %}selected{% endif %} class="text-secondary">Resource</option>
                            <option value="action" {% if dropdown_type == 'action' %}selected{% endif %} class="text-danger">Action</option>
                            <option value="event" {% if dropdown_type == 'event' %}selected{% endif %} class="text-dark">Event</option>
                            <option value="capability" {% if dropdown_type == 'capability' %}selected{% endif %}>Capability</option>
                        </select>
                        
                        <div class="concept-hierarchy mt-2">
                          {% set semantic_category = concept.category %}
                          {% set ontology_type = actual_type.capitalize() %}
                          <div class="hierarchy-path mb-1">
                            <small class="d-block" style="line-height: 1.4;">
                              <strong class="hierarchy-display text-dark">{{ ontology_type }}</strong>
                              {% if semantic_category and semantic_category != actual_type %}
                                <br>↳ <span class="text-primary fst-italic">{{ semantic_category }}</span>
                                <br>↳ <strong class="text-success">{{ concept.label }}</strong>
                              {% else %}
                                <br>↳ <strong class="text-success">{{ concept.label }}</strong>
                              {% endif %}
                            </small>
                          </div>
                          
                          <!-- Show if user has made manual changes -->
                          <div class="manual-change-indicator" style="display: none;">
                            <small class="text-info d-block" style="font-size: 0.75rem;">
                              <i class="bi bi-pencil-square"></i> Manually adjusted
                            </small>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>{{ concept.description }}</td>
                    <td>
                      {% if concept.ontology_match %}
                      <!-- Existing ontology match found -->
                      <div class="mb-1">
                        <span class="badge bg-success">✅ Match</span>
                        <strong>{{ concept.ontology_match.label }}</strong>
                        <small class="text-muted d-block">
                          Confidence: {{ (concept.match_confidence * 100)|round|int }}%
                          {% if concept.ontology_match.category %}
                          <br>Category: {{ concept.ontology_match.category|title }}
                          {% endif %}
                        </small>
                      </div>
                      {% elif concept.is_new %}
                      <!-- New concept -->
                      <div class="mb-1">
                        <span class="badge bg-warning text-dark">🆕 New</span>
                        {% if concept.suggested_parent %}
                        <small class="text-muted d-block">
                          Parent: {{ concept.suggested_parent.label }}
                          <br>Confidence: {{ (concept.suggested_parent.confidence * 100)|round|int }}%
                        </small>
                        {% endif %}
                      </div>
                      {% else %}
                      <!-- Fallback to legacy match display -->
                      {% if concept.label in matched_entities and matched_entities[concept.label]|length > 0 %}
                      {% for match in matched_entities[concept.label] %}
                      <div class="mb-1">
                        <span class="badge bg-success">{{ match.match_type|capitalize }}</span>
                        <strong>{{ match.label }}</strong>
                        <small class="text-muted d-block">Confidence: {{ (match.confidence * 100)|int }}%</small>
                      </div>
                      {% endfor %}
                      {% else %}
                      <span class="badge bg-danger">❌ ERROR: Missing match data</span>
                      {% endif %}
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                  {% else %}
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <div class="alert alert-warning mb-0">
                        No concepts were extracted from this guideline. This may happen if the guideline does not
                        contain any recognizable ethical concepts or if the extraction process encountered an error.
                      </div>
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Concept Types Reference -->
    <div class="card mt-4 mb-4">
      <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-tags"></i> Concept Types</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary">🏛️ Ontological Types (8 Fundamental Categories)</h6>
            <p class="small text-muted mb-2">Formal ontology classes - stored as permanent classifications</p>
            
            <dl class="small mb-3">
              <dt><span class="badge bg-primary">Role</span></dt>
              <dd>Professional positions, occupations, or stakeholder categories (e.g., Engineer, Client, Manager). <strong>NOT duties or relationships.</strong></dd>
              
              <dt><span class="badge bg-success">Principle</span></dt>
              <dd>Core ethical values, fundamental beliefs, or guiding standards (e.g., Safety First, Honesty).</dd>
              
              <dt><span class="badge bg-warning">Obligation</span></dt>
              <dd>Professional duties, requirements, or things that MUST be done (e.g., Faithful Agency, Confidentiality).</dd>
              
              <dt><span class="badge bg-info">State</span></dt>
              <dd>Conditions, situations, or circumstances that exist (e.g., Conflict of Interest, Risk State).</dd>
              
              <dt><span class="badge bg-secondary">Resource</span></dt>
              <dd>Physical or informational entities, documents, or tools (e.g., Technical Standards, Specifications).</dd>
              
              <dt><span class="badge bg-danger">Action</span></dt>
              <dd>Intentional activities or processes performed (e.g., Design Review, Communication).</dd>
              
              <dt><span class="badge bg-dark">Event</span></dt>
              <dd>Occurrences, incidents, or happenings (e.g., Safety Incident, Project Milestone).</dd>
              
              <dt><span class="badge bg-light text-dark">Capability</span></dt>
              <dd>Skills, competencies, or abilities (e.g., Technical Expertise, Problem Solving).</dd>
            </dl>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary">🤖 Semantic Categories (LLM Insights)</h6>
            <p class="small text-muted mb-2">AI-generated classifications - stored as metadata for future ontology evolution</p>
            <div class="mb-3">
              <span class="text-primary fst-italic">Examples: Fundamental Duty, Professional Standard, Ethical Principle</span>
            </div>
            
            <div class="alert alert-info mb-0">
              <small>
                <strong>Display Format:</strong><br>
                <strong>Concept Column:</strong> <span class="badge bg-success">Ontological Type</span> <strong>Concept Name</strong><br>
                <strong>Type Column:</strong> Dropdown + <strong>Ontological Type</strong> → <span class="text-primary fst-italic">LLM Semantic Category</span> → <strong>Concept Name</strong>
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between">
      <a href="{{ url_for('worlds.view_guideline', id=world.id, document_id=guideline.id) }}"
        class="btn btn-secondary">Cancel</a>

      {% if concepts %}
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i> Save Concepts
      </button>
      {% else %}
      <a href="{{ url_for('worlds.view_guideline', id=world.id, document_id=guideline.id) }}" class="btn btn-primary">
        <i class="fas fa-arrow-left"></i> Return to Guideline
      </a>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Get references to buttons and checkboxes
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const checkboxes = document.querySelectorAll('.concept-checkbox');
    const conceptsDataField = document.getElementById('concepts_data');

    // Concepts data is now set directly in the HTML template
    // Just verify it's there for debugging
    if (conceptsDataField) {
        console.log('Concepts data field found with length:', conceptsDataField.value.length);
        console.log('Preview:', conceptsDataField.value.substring(0, 100) + '...');
    } else {
        console.error('concepts_data field not found!');
    }

  // Select all concepts
  selectAllBtn.addEventListener('click', function () {
    checkboxes.forEach(checkbox => {
      checkbox.checked = true;
    });
  });

  // Deselect all concepts
  deselectAllBtn.addEventListener('click', function () {
    checkboxes.forEach(checkbox => {
      checkbox.checked = false;
    });
  });
  });

  // Handle type override changes
  const typeOverrideSelects = document.querySelectorAll('.concept-type-override');
    
    typeOverrideSelects.forEach(select => {
        select.addEventListener('change', function() {
            const newType = this.value;
            const conceptIndex = this.dataset.conceptIndex;
            const conceptDiv = this.closest('.concept-type-display');
            const hierarchySpan = conceptDiv.querySelector('.hierarchy-display');
            
            const typeColors = {
                'role': 'bg-primary',
                'principle': 'bg-success',
                'obligation': 'bg-warning',
                'state': 'bg-info',
                'resource': 'bg-secondary',
                'action': 'bg-danger',
                'event': 'bg-dark',
                'capability': 'bg-light text-dark'
            };
            
            // Update the hierarchy display
            if (hierarchySpan) {
                hierarchySpan.textContent = newType.charAt(0).toUpperCase() + newType.slice(1);
            }
            
            // Update the concept column badge
            const row = this.closest('tr');
            const conceptBadge = row.querySelector('td:nth-child(2) .badge');
            if (conceptBadge) {
                // Remove old color classes
                conceptBadge.className = 'badge me-2';
                // Add new color class
                conceptBadge.classList.add(typeColors[newType] || 'bg-secondary');
                conceptBadge.textContent = newType.charAt(0).toUpperCase() + newType.slice(1);
            }
            
            // Show manual adjustment indicator if different from original
            const originalType = this.dataset.originalType;
            const manualIndicator = conceptDiv.querySelector('.manual-change-indicator');
            if (newType !== originalType) {
                manualIndicator.style.display = 'block';
            } else {
                manualIndicator.style.display = 'none';
            }
            console.log('Type manually changed for concept', conceptIndex, 'from', originalType, 'to', newType);
        });
    });
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .guideline-content {
    max-height: 300px;
    overflow-y: auto;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  .table td {
    vertical-align: middle;
  }
  
  .concept-type-override {
    min-width: 120px;
    font-size: 0.875rem;
  }
  
  .concept-hierarchy {
    word-wrap: break-word;
    white-space: normal;
  }
  
  .hierarchy-path {
    padding: 0.25rem 0;
  }
  
  .table td {
    vertical-align: top;
    padding: 0.75rem 0.5rem;
  }
</style>
{% endblock %}