{% extends "base.html" %}

{% block title %}Admin Dashboard - ProEthica{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-cog"></i> Admin Dashboard</h1>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="/debug/status" class="btn btn-outline-secondary">
                        <i class="fas fa-bug"></i> Debug Status
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- System Stats Row -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <!-- Main Stats Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Worlds</h5>
                            <h3>{{ stats.overview.worlds }}</h3>
                            <small class="text-muted">Professional domains</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Guidelines</h5>
                            <h3>{{ stats.overview.guidelines }}</h3>
                            <small class="text-muted">Ethical guidelines</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Cases</h5>
                            <h3>{{ stats.overview.cases }}</h3>
                            <small class="text-muted">Ethics cases</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Documents</h5>
                            <h3>{{ stats.overview.documents }}</h3>
                            <small class="text-muted">Total documents</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- System Status Card -->
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge badge-{{ 'success' if system_status.mcp_server else 'danger' }}">
                            MCP Server: {{ 'Online' if system_status.mcp_server else 'Offline' }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <span class="badge badge-{{ 'success' if system_status.database else 'danger' }}">
                            Database: {{ 'Connected' if system_status.database else 'Error' }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <span class="badge badge-{{ 'warning' if sync_status.needs_sync else 'success' }}">
                            Ontology Sync: {{ 'Update Needed' if sync_status.needs_sync else 'Synced' }}
                        </span>
                    </div>
                    {% if sync_status.last_sync %}
                    <small class="text-muted">Last sync: {{ sync_status.last_sync }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Left Column: Data Management -->
        <div class="col-lg-6">
            <!-- Ontology Management -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ontology Management</h5>
                    <button class="btn btn-sm btn-primary" onclick="syncOntologies()">
                        <i class="fas fa-sync"></i> Sync TTL to DB
                    </button>
                </div>
                <div class="card-body">
                    <h6>Core Ontologies</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>File</th>
                                    <th>Database</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ont in sync_status.core_ontologies %}
                                <tr>
                                    <td>{{ ont.domain }}</td>
                                    <td>
                                        {% if ont.file_exists %}
                                        <i class="fas fa-check text-success"></i>
                                        {% else %}
                                        <i class="fas fa-times text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ont.db_exists %}
                                        <i class="fas fa-check text-success"></i>
                                        {% else %}
                                        <i class="fas fa-times text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ont.is_synced %}
                                        <span class="badge badge-success">Synced</span>
                                        {% else %}
                                        <span class="badge badge-warning">Needs Sync</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ont.ontology_id %}
                                        <a href="/ontology-editor/?ontology={{ ont.ontology_id }}&ontology_id={{ ont.ontology_id }}&view=full" 
                                           class="btn btn-sm btn-outline-primary" title="Edit {{ ont.domain }} ontology">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="mt-3">Guideline Ontologies</h6>
                    <p class="mb-0">
                        <strong>{{ sync_status.guideline_ontologies.count }}</strong> guideline-derived ontologies
                        <br>
                        <small class="text-muted">{{ sync_status.guideline_ontologies.note }}</small>
                    </p>
                </div>
            </div>

            <!-- Processing Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Processing Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1">Documents with Structure</p>
                            <div class="progress mb-3">
                                <div class="progress-bar" style="width: {{ stats.processing.structure_percentage }}%">
                                    {{ stats.processing.structure_percentage }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <p class="mb-1">Documents with Embeddings</p>
                            <div class="progress mb-3">
                                <div class="progress-bar bg-info" style="width: {{ stats.processing.embeddings_percentage }}%">
                                    {{ stats.processing.embeddings_percentage }}%
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Entity Triples: <strong>{{ stats.analysis.entity_triples }}</strong></small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Associations: <strong>{{ stats.analysis.associations }}</strong></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Recent Activity & Quick Actions -->
        <div class="col-lg-6">
            <!-- Quick Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6 mb-2">
                            <a href="/worlds" class="btn btn-block btn-outline-primary">
                                <i class="fas fa-globe"></i> Manage Worlds
                            </a>
                        </div>
                        <div class="col-6 mb-2">
                            <a href="/guidelines" class="btn btn-block btn-outline-success">
                                <i class="fas fa-book"></i> Manage Guidelines
                            </a>
                        </div>
                        <div class="col-6 mb-2">
                            <a href="/cases" class="btn btn-block btn-outline-info">
                                <i class="fas fa-file-alt"></i> Process Cases
                            </a>
                        </div>
                        <div class="col-6 mb-2">
                            <a href="/ontology-editor" class="btn btn-block btn-outline-warning">
                                <i class="fas fa-sitemap"></i> Ontology Editor
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if recent_activity.documents %}
                    <h6>Recent Documents</h6>
                    <ul class="list-unstyled">
                        {% for doc in recent_activity.documents[:5] %}
                        <li class="mb-2">
                            <a href="/documents/{{ doc.id }}/structure">{{ doc.title[:50] }}...</a>
                            <br>
                            <small class="text-muted">
                                {{ doc.document_type }} - {{ doc.created_at }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if recent_activity.guidelines %}
                    <h6>Recent Guidelines</h6>
                    <ul class="list-unstyled">
                        {% for guideline in recent_activity.guidelines[:3] %}
                        <li class="mb-2">
                            <a href="/guidelines/{{ guideline.id }}">{{ guideline.title[:50] }}...</a>
                            <br>
                            <small class="text-muted">
                                World: {{ guideline.world_name }} - {{ guideline.created_at }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Database Tables Info (from debug route) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Database Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Table Count: {{ stats.database.table_count }}</h6>
                        </div>
                        <div class="col-md-8">
                            <h6>Key Tables</h6>
                            <div class="d-flex flex-wrap">
                                {% for table in ['worlds', 'guidelines', 'documents', 'entity_triples', 'ontologies', 'scenarios'] %}
                                <span class="badge badge-secondary mr-2 mb-1">{{ table }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function syncOntologies() {
    if (!confirm('Sync TTL files to database? This will update the database with the latest ontology definitions.')) {
        return;
    }
    
    alert('Please run: python scripts/sync_ontology_to_database.py\n\nThis operation should be run from the command line.');
}
</script>
{% endblock %}