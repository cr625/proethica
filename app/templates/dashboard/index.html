{% extends "base.html" %}

{% block title %}Admin Dashboard - ProEthica{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-cog"></i> Admin Dashboard</h1>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <a href="/debug/status" class="btn btn-outline-secondary">
                        <i class="fas fa-bug"></i> Debug Status
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- System Stats Row -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <!-- Main Stats Cards -->
            <div class="row">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Worlds</h5>
                            <h3>{{ stats.overview.worlds }}</h3>
                            <small class="text-muted">Professional domains</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Guidelines</h5>
                            <h3>{{ stats.overview.guidelines }}</h3>
                            <small class="text-muted">Ethical guidelines</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Cases</h5>
                            <h3>{{ stats.overview.cases }}</h3>
                            <small class="text-muted">Ethics cases</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title text-muted">Documents</h5>
                            <h3>{{ stats.overview.documents }}</h3>
                            <small class="text-muted">Total documents</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- System Status Card -->
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">System Status</h5>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge badge-{{ 'success' if system_status.mcp_server else 'danger' }}">
                            MCP Server: {{ 'Online' if system_status.mcp_server else 'Offline' }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <span class="badge badge-{{ 'success' if system_status.database else 'danger' }}">
                            Database: {{ 'Connected' if system_status.database else 'Error' }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <span class="badge badge-{{ 'warning' if sync_status.needs_sync else 'success' }}">
                            Ontology Sync: {{ 'Update Needed' if sync_status.needs_sync else 'Synced' }}
                        </span>
                    </div>
                    {% if sync_status.last_sync %}
                    <small class="text-muted">Last sync: {{ sync_status.last_sync }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Left Column: Data Management -->
        <div class="col-lg-6">
            <!-- Ontology Management -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Ontology Management</h5>
                    <button class="btn btn-sm btn-primary" onclick="syncOntologies()">
                        <i class="fas fa-sync"></i> Sync TTL to DB
                    </button>
                </div>
                <div class="card-body">
                    <h6>Core Ontologies</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>File</th>
                                    <th>Database</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ont in sync_status.core_ontologies %}
                                <tr>
                                    <td>{{ ont.domain }}</td>
                                    <td>
                                        {% if ont.file_exists %}
                                        <span class="text-success font-weight-bold">{{ ont.domain }}.ttl</span>
                                        {% else %}
                                        <span class="text-danger font-weight-bold">MISSING</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if ont.db_exists %}
                                        <span class="text-success" style="font-size: 1.2em;">✓</span>
                                        {% else %}
                                        <span class="text-danger" style="font-size: 1.2em;">✗</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if ont.is_synced %}
                                        <span class="text-success" style="font-size: 1.2em;">✓</span>
                                        {% else %}
                                        <span class="text-warning" style="font-size: 1.2em;">⚠</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ont.ontology_id %}
                                        <a href="/ontology-editor/?ontology={{ ont.ontology_id }}&ontology_id={{ ont.ontology_id }}&view=full" 
                                           class="btn btn-sm btn-outline-primary" title="Edit {{ ont.domain }} ontology">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <h6 class="mt-3">Guideline Ontologies</h6>
                    {% if sync_status.guideline_ontologies.list %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Ontology Name</th>
                                        <th>Related Guideline</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ont in sync_status.guideline_ontologies.list %}
                                    <tr>
                                        <td>{{ ont.name }}</td>
                                        <td>
                                            {% if ont.related_document_id and ont.related_world_id %}
                                                <a href="{{ url_for('worlds.view_guideline', id=ont.related_world_id, document_id=ont.related_document_id) }}" class="text-primary text-decoration-none">
                                                    {{ ont.related_guideline_title }}
                                                </a>
                                            {% else %}
                                                <span class="text-muted">{{ ont.related_guideline_title }}</span>
                                            {% endif %}
                                            <br>
                                            <small class="text-muted">{{ ont.domain_id }}</small>
                                        </td>
                                        <td>
                                            <a href="/ontology-editor/?ontology_id={{ ont.id }}&view=full" 
                                               class="btn btn-sm btn-outline-primary" title="Edit {{ ont.name }}">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted">{{ sync_status.guideline_ontologies.note }}</small>
                    {% else %}
                        <p class="mb-0">
                            <strong>{{ sync_status.guideline_ontologies.count }}</strong> guideline-derived ontologies
                            <br>
                            <small class="text-muted">{{ sync_status.guideline_ontologies.note }}</small>
                        </p>
                    {% endif %}
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recent Activity</h5>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                    {% if recent_activity.documents %}
                    <h6>Recent Documents</h6>
                    <ul class="list-unstyled">
                        {% for doc in recent_activity.documents[:5] %}
                        <li class="mb-2">
                            <a href="/documents/{{ doc.id }}/structure">{{ doc.title[:50] }}...</a>
                            <br>
                            <small class="text-muted">
                                {{ doc.document_type }} - {{ doc.created_at }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if recent_activity.guidelines %}
                    <h6>Recent Guidelines</h6>
                    <ul class="list-unstyled">
                        {% for guideline in recent_activity.guidelines[:3] %}
                        <li class="mb-2">
                            <a href="/guidelines/{{ guideline.id }}">{{ guideline.title[:50] }}...</a>
                            <br>
                            <small class="text-muted">
                                World: {{ guideline.world_name }} - {{ guideline.created_at }}
                            </small>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Processing & Actions -->
        <div class="col-lg-6">
            <!-- Processing & Actions -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Processing & Actions</h5>
                </div>
                <div class="card-body">
                    <!-- Processing Status -->
                    <h6>Processing Status</h6>
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>Document Structure</span>
                                <small>{{ stats.processing.processed_documents }}/{{ stats.processing.total_documents }}</small>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar" style="width: {{ stats.processing.structure_percentage }}%">
                                    {{ stats.processing.structure_percentage }}%
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span>Section Embeddings</span>
                                <small>{{ stats.processing.embedded_sections }}/{{ stats.processing.total_sections }}</small>
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar bg-info" style="width: {{ stats.processing.embeddings_percentage }}%">
                                    {{ stats.processing.embeddings_percentage }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions Based on Processing Needs -->
                    <h6>Available Actions</h6>
                    <div class="row">
                        <!-- Document Processing Actions -->
                        {% if stats.processing.structure_percentage < 100 %}
                        <div class="col-6 mb-2">
                            <a href="/cases" class="btn btn-block btn-sm btn-outline-warning">
                                <i class="fas fa-cogs"></i> Process Documents
                            </a>
                            <small class="text-muted">{{ stats.processing.total_documents - stats.processing.processed_documents }} need structure</small>
                        </div>
                        {% endif %}

                        {% if stats.processing.embeddings_percentage < 100 %}
                        <div class="col-6 mb-2">
                            <a href="/documents" class="btn btn-block btn-sm btn-outline-info">
                                <i class="fas fa-vector-square"></i> Generate Embeddings
                            </a>
                            <small class="text-muted">{{ stats.processing.total_sections - stats.processing.embedded_sections }} sections need embeddings</small>
                        </div>
                        {% endif %}

                        <!-- Guidelines Actions -->
                        <div class="col-6 mb-2">
                            <a href="/guidelines" class="btn btn-block btn-sm btn-outline-success">
                                <i class="fas fa-book"></i> Manage Guidelines
                            </a>
                            <small class="text-muted">{{ stats.overview.guidelines }} guidelines</small>
                        </div>

                        <!-- Ontology Actions -->
                        {% if sync_status.needs_sync %}
                        <div class="col-6 mb-2">
                            <button class="btn btn-block btn-sm btn-outline-danger" onclick="syncOntologies()">
                                <i class="fas fa-sync"></i> Sync Ontologies
                            </button>
                            <small class="text-muted">TTL files need sync</small>
                        </div>
                        {% else %}
                        <div class="col-6 mb-2">
                            <a href="/ontology-editor" class="btn btn-block btn-sm btn-outline-secondary">
                                <i class="fas fa-sitemap"></i> Edit Ontologies
                            </a>
                            <small class="text-muted">All ontologies synced</small>
                        </div>
                        {% endif %}

                        <!-- Association Generation (if there are unprocessed documents) -->
                        {% if stats.analysis.associations < stats.overview.documents %}
                        <div class="col-6 mb-2">
                            <a href="/cases" class="btn btn-block btn-sm btn-outline-primary">
                                <i class="fas fa-link"></i> Generate Associations
                            </a>
                            <small class="text-muted">{{ stats.overview.documents - stats.analysis.associations }} documents need associations</small>
                        </div>
                        {% endif %}

                        <!-- Always show worlds management -->
                        <div class="col-6 mb-2">
                            <a href="/worlds" class="btn btn-block btn-sm btn-outline-primary">
                                <i class="fas fa-globe"></i> Manage Worlds
                            </a>
                            <small class="text-muted">{{ stats.overview.worlds }} worlds</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
function syncOntologies() {
    if (!confirm('Sync TTL files to database? This will update the database with the latest ontology definitions.')) {
        return;
    }
    
    alert('Please run: python scripts/sync_ontology_to_database.py\n\nThis operation should be run from the command line.');
}
</script>
{% endblock %}