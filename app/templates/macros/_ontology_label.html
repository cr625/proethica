{#
Ontology Label Macro - Reusable entity labels with rich popovers.

Usage:
    import ontology_label from macros/_ontology_label.html
    call ontology_label(uri, entity_lookup) in your template

Popover content is built at runtime by ontology-popovers.js using data-* attributes.
Include ontology-labels.css for styling and ontology-popovers.js for initialization.

Parameters:
    uri: The entity URI (string) or plain label
    entity_lookup: Dict mapping URI to entity metadata dict
#}

{% macro ontology_label(uri, entity_lookup) %}
{%- set label = uri.split('#')[-1] if uri is string and '#' in uri else (uri.split('/')[-1] if uri is string and '/' in uri else uri) -%}
{%- set entity = entity_lookup.get(uri) if entity_lookup and uri is string else none -%}
{%- if entity -%}
<span class="onto-label{% if entity.source == 'ontology' %} onto-source-ontology{% endif %}"
      tabindex="0"
      data-bs-toggle="popover"
      data-bs-trigger="hover focus"
      data-bs-html="true"
      data-bs-placement="top"
      data-entity-type="{{ entity.entity_type or entity.extraction_type }}"
      data-entity-pass="{{ entity.source_pass }}"
      data-entity-source="{{ entity.source or 'case' }}"
      data-entity-definition="{{ entity.definition|e }}"
      data-entity-uri="{{ uri|e }}"
      title="{{ entity.label or label }}">{{ entity.label or label }}</span>
{%- elif uri is string and ('http' in uri or '#' in uri) -%}
<span class="onto-label onto-label-unknown"
      tabindex="0"
      data-bs-toggle="popover"
      data-bs-trigger="hover focus"
      data-bs-html="true"
      data-bs-placement="top"
      data-entity-uri="{{ uri|e }}"
      title="{{ label }}">{{ label }}</span>
{%- else -%}
<span>{{ uri }}</span>
{%- endif -%}
{% endmacro %}
