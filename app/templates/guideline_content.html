{% extends "base.html" %}

{% block title %}{{ guideline.title }} - Guideline{% endblock %}

{% block content %}
<div class="container mt-5" id="page-root"
  data-auth="{{ 'true' if current_user and current_user.is_authenticated else 'false' }}" data-document-type="guideline"
  data-document-id="{{ guideline.id }}">
  <h1>{{ guideline.title }}</h1>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('index.index') }}">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('worlds.view_world', id=world.id) }}">{{ world.name }}</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('worlds.world_guidelines', id=world.id) }}">Guidelines</a></li>
      <li class="breadcrumb-item active">{{ guideline.title }}</li>
    </ol>
  </nav>

  <!-- Main content -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Guideline Content</h5>
      <div>
        <a href="{{ url_for('worlds.view_guideline_sections', id=world.id, document_id=guideline.id) }}"
          class="btn btn-sm btn-light">
          <i class="bi bi-list-ul"></i> View Provisions
          {% if guideline.guideline_metadata and guideline.guideline_metadata.guideline_structure and
          guideline.guideline_metadata.guideline_structure.sections_count %}
          <span class="badge bg-success ms-1" title="Extracted provisions available">
            {{ guideline.guideline_metadata.guideline_structure.sections_count }}
          </span>
          {% endif %}
        </a>
        {% if can_delete_item(guideline) %}
        <button type="button" class="btn btn-sm btn-outline-light ms-2" data-bs-toggle="modal"
          data-bs-target="#deleteGuidelineModal">
          <i class="bi bi-trash"></i>
        </button>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <!-- Metadata row -->
      <div class="row mb-3">
        <div class="col-md-6">
          <p class="text-muted mb-2">
            <strong>Source:</strong>
            {% if guideline.source %}
            <a href="{{ guideline.source }}" target="_blank">{{ guideline.source }}</a>
            {% elif guideline.source_url %}
            <a href="{{ guideline.source_url }}" target="_blank">{{ guideline.source_url }}</a>
            {% elif guideline.file_path %}
            Uploaded file: {{ guideline.file_path.split('/')[-1] }}
            {% else %}
            Manual entry
            {% endif %}
          </p>
        </div>
        <div class="col-md-6">
          <p class="text-muted mb-2">
            <strong>Created by:</strong> {{ get_creator_name(guideline) }}
          </p>
          {% if guideline.created_at %}
          <p class="text-muted mb-2">
            <strong>Created:</strong> {{ guideline.created_at.strftime('%Y-%m-%d %H:%M') }}
          </p>
          {% endif %}
        </div>
      </div>

      <!-- Provisions info card (if sections exist) -->
      {% if guideline.guideline_metadata and guideline.guideline_metadata.guideline_structure %}
      {% set structure = guideline.guideline_metadata.guideline_structure %}
      <div class="card bg-light border mb-4">
        <div class="card-body py-2">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <strong>{{ structure.sections_count|default(0) }} provisions</strong> extracted
              {% if structure.categories %}
              <span class="text-muted ms-2">
                {% for cat, count in structure.categories.items() %}
                <span class="badge bg-secondary me-1">{{ cat|replace('_', ' ')|title }}: {{ count }}</span>
                {% endfor %}
              </span>
              {% endif %}
            </div>
            <a href="{{ url_for('worlds.view_guideline_sections', id=world.id, document_id=guideline.id) }}"
              class="btn btn-primary btn-sm">
              <i class="bi bi-list-ul"></i> View Provisions
            </a>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Document content -->
      <div class="guideline-content" id="documentContent">
        {% if guideline.content %}
        {% if guideline.content.startswith('#') or '##' in guideline.content %}
        <div class="markdown-content">
          {{ guideline.content|markdown|safe }}
        </div>
        {% else %}
        {{ guideline.content|safe }}
        {% endif %}
        {% else %}
        <div class="alert alert-warning">
          No content available for this guideline.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Delete Guideline Modal -->
<div class="modal fade" id="deleteGuidelineModal" tabindex="-1" aria-labelledby="deleteGuidelineModalLabel"
  aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteGuidelineModalLabel">Delete Guideline</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete the guideline <strong>{{ guideline.title }}</strong>?</p>
        <p class="text-danger">This action cannot be undone. All associated concepts and triples will also be deleted.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form action="{{ url_for('worlds.delete_guideline', id=world.id, guideline_id=guideline.id) }}" method="post">
          {% if csrf_token %}
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          {% endif %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .guideline-content {
    font-size: 1rem;
    line-height: 1.6;
  }

  .guideline-content h1,
  .guideline-content h2,
  .guideline-content h3,
  .guideline-content h4,
  .guideline-content h5,
  .guideline-content h6 {
    margin-top: 1.5rem;
    margin-bottom: 1rem;
  }

  .guideline-content p {
    margin-bottom: 1rem;
  }

  .guideline-content ul,
  .guideline-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
  }

  .guideline-content blockquote {
    border-left: 4px solid #ccc;
    padding-left: 1rem;
    margin-left: 0;
    color: #666;
  }
</style>
{% endblock %}
