{% extends "realm/base.html" %}

{% block title %}REALM - Materials Science Chat{% endblock %}

{% block styles %}
<style>
    .chat-window {
        height: 70vh; /* Use viewport height to make it taller */
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .conversation {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #f8f9fa;
    }

    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
        max-width: 80%;
        display: block;
    }

    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .assistant-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
        text-align: left;
    }

    .input-area {
        padding: 10px;
        border-top: 1px solid #ccc;
        display: flex;
        flex-direction: column;
        background-color: white;
        position: sticky;
        bottom: 0;
        width: 100%;
    }

    .prompt-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .prompt-option {
        background-color: #e9ecef;
        border: none;
        border-radius: 12px;
        padding: 4px 10px;
        font-size: 0.9rem;
        margin: 2px;
        cursor: pointer;
    }

    .prompt-option:hover {
        background-color: #dee2e6;
    }

    .input-disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 123, 255, 0.3);
        border-radius: 50%;
        border-top-color: #007bff;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
    
    /* Materials panel styles */
    .materials-panel {
        height: 70vh;
        border: 1px solid #ccc;
        border-radius: 8px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 15px;
        transition: all 0.3s ease;
    }
    
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e5e5e5;
    }
    
    .panel-content {
        flex-grow: 1;
        overflow-y: auto;
    }
    
    .material-item {
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .material-item:hover {
        background-color: #dee2e6;
    }
    
    .material-item.selected {
        background-color: #b8daff;
        border-left: 3px solid #007bff;
    }

    /* Collapsed panels */
    .panel-collapsed {
        width: 60px;
        overflow: hidden;
        padding: 10px 5px;
    }

    .panel-collapsed .panel-title,
    .panel-collapsed .panel-content {
        display: none;
    }

    .panel-collapsed .panel-header {
        padding: 0;
        margin: 0;
        border: none;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" id="materials-chat-app">
    <div class="row mb-3">
        <div class="col-md-6">
            <h1>Materials Science Chat</h1>
            <p class="text-muted">Ask questions about materials science using the MSEO ontology</p>
        </div>
        <div class="col-md-6 text-end">
            <div class="form-group">
                <label for="ontology-select" class="form-label me-2">Ontology:</label>
                <select id="ontology-select" class="form-select d-inline-block w-auto" v-model="selectedOntologyId" @change="ontologyChanged">
                    <option value="">-- Select an Ontology --</option>
                    {% for ontology in ontologies %}
                    <option value="{{ ontology.id }}">{{ ontology.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Materials panel - left column -->
        <div :class="{'col-md-3': !isMaterialsPanelCollapsed, 'col-md-1': isMaterialsPanelCollapsed}">
            <div :class="{'materials-panel': true, 'panel-collapsed': isMaterialsPanelCollapsed}">
                <div class="panel-header">
                    <h5 class="panel-title">Materials</h5>
                    <button class="btn btn-sm btn-outline-secondary toggle-panel" @click="toggleMaterialsPanel">
                        <i :class="isMaterialsPanelCollapsed ? 'bi bi-chevron-right' : 'bi bi-chevron-left'"></i>
                    </button>
                </div>
                <div class="panel-content">
                    <div class="mb-3">
                        <select class="form-select form-select-sm" v-model="categoryFilter">
                            <option value="all">All Categories</option>
                            <option value="elements">Elements</option>
                            <option value="compounds">Compounds</option>
                            <option value="alloys">Alloys</option>
                            <option value="ceramics">Ceramics</option>
                            <option value="polymers">Polymers</option>
                            <option value="composites">Composites</option>
                        </select>
                    </div>
                    
                    <div v-if="isLoadingMaterials" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading materials...</span>
                        </div>
                        <p class="mt-2">Loading materials...</p>
                    </div>
                    
                    <div v-else-if="materials.length === 0" class="text-center py-5 text-muted">
                        <i class="bi bi-exclamation-circle" style="font-size: 2rem;"></i>
                        <p class="mt-2">No materials found. Select an ontology to view materials.</p>
                    </div>
                    
                    <div v-else>
                        <div class="material-list">
                            <div v-for="material in filteredMaterials" :key="material.id" 
                                class="material-item"
                                @click="selectMaterial(material)"
                                :class="{ 'selected': selectedMaterial && selectedMaterial.id === material.id }">
                                {% raw %}{{ material.name }}{% endraw %}
                                <div v-if="material.symbol" class="text-muted small">
                                    {% raw %}{{ material.symbol }}{% endraw %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat window - main column -->
        <div :class="{
            'col-md-9': !isMaterialsPanelCollapsed,
            'col-md-11': isMaterialsPanelCollapsed
        }">
            <div class="chat-window">
                <div class="conversation" ref="conversation">
                    <div v-for="(message, index) in messages" :key="index" class="message"
                        :class="message.role === 'user' ? 'user-message' : 'assistant-message'">
                        {% raw %}{{ message.content }}{% endraw %}
                    </div>
                    <div v-if="isProcessing" class="message assistant-message">
                        <div class="loading"></div> Thinking...
                    </div>
                </div>

                <div class="input-area">
                    <!-- Show prompt options when available -->
                    <div v-if="promptOptions.length > 0" class="prompt-options w-100">
                        <button v-for="option in promptOptions" :key="option.id" class="prompt-option"
                            @click="selectPromptOption(option)">
                            {% raw %}{{ option.text }}{% endraw %}
                        </button>
                    </div>

                    <!-- Generate suggestions button -->
                    <div v-if="selectedOntologyId && promptOptions.length === 0" class="w-100 mb-2">
                        <button
                            class="btn btn-outline-secondary w-100 d-flex align-items-center justify-content-center"
                            @click="generateSuggestions"
                            :disabled="isFetchingSuggestions">
                            <i class="bi bi-lightbulb me-2" style="font-size: 1.1rem;"></i>
                            <span>Generate Suggestions</span>
                            <span v-if="isFetchingSuggestions" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true"></span>
                        </button>
                    </div>

                    <!-- Input box -->
                    <div class="input-group">
                        <input type="text" class="form-control" v-model="userInput"
                            :disabled="!inputEnabled || isProcessing"
                            :class="{ 'input-disabled': !inputEnabled || isProcessing }"
                            :placeholder="selectedOntologyId ? 'Ask questions about materials science...' : 'Select an ontology first...'"
                            @keyup.enter="sendMessage">
                        <button class="btn btn-primary" @click="sendMessage" :disabled="!inputEnabled || isProcessing">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat window control buttons -->
            <div class="d-flex mt-2 gap-2">
                <button class="btn btn-secondary" @click="resetConversation">
                    <i class="bi bi-arrow-repeat"></i> Reset Conversation
                </button>
                <button v-if="selectedMaterial" class="btn btn-outline-primary" @click="askAboutMaterial">
                    <i class="bi bi-search"></i> Ask About Selected Material
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include necessary libraries -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    new Vue({
        el: '#materials-chat-app',
        data: {
            messages: [{
                role: 'assistant',
                content: 'Welcome to the Materials Science Chat! I can help answer questions about various materials, their properties, and applications. Please select an ontology to get started.'
            }],
            userInput: '',
            inputEnabled: true,
            isProcessing: false,
            isFetchingSuggestions: false,
            selectedOntologyId: '',
            
            // Materials panel
            materials: [],
            filteredMaterials: [],
            selectedMaterial: null,
            categoryFilter: 'all',
            isLoadingMaterials: false,
            isMaterialsPanelCollapsed: false,
            
            // Prompt suggestions
            promptOptions: []
        },
        watch: {
            categoryFilter: function(newVal) {
                this.filterMaterials();
            }
        },
        mounted() {
            // Check for saved collapsed state
            const savedMaterialsPanelState = localStorage.getItem('materialsPanelCollapsed');
            if (savedMaterialsPanelState) {
                this.isMaterialsPanelCollapsed = savedMaterialsPanelState === 'true';
            }
        },
        methods: {
            toggleMaterialsPanel() {
                this.isMaterialsPanelCollapsed = !this.isMaterialsPanelCollapsed;
                localStorage.setItem('materialsPanelCollapsed', this.isMaterialsPanelCollapsed);
            },
            
            ontologyChanged() {
                // Reset conversation when ontology changes
                if (this.messages.length > 1) {
                    if (confirm('Changing ontologies will reset your current conversation. Continue?')) {
                        this.resetConversation();
                    } else {
                        // Restore the previous selection
                        this.$nextTick(() => {
                            const select = document.getElementById('ontology-select');
                            if (select) {
                                select.value = this.selectedOntologyId;
                            }
                        });
                        return;
                    }
                }
                
                // Load materials for the selected ontology
                this.loadMaterials();
            },
            
            loadMaterials() {
                if (!this.selectedOntologyId) {
                    this.materials = [];
                    this.filteredMaterials = [];
                    this.selectedMaterial = null;
                    return;
                }
                
                this.isLoadingMaterials = true;
                
                axios.get(`/realm/api/materials?ontology_id=${this.selectedOntologyId}`)
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.materials = response.data.materials || [];
                            this.filterMaterials();
                        } else {
                            console.error('Error loading materials:', response.data.message);
                            this.materials = [];
                            this.filteredMaterials = [];
                        }
                    })
                    .catch(error => {
                        console.error('Error loading materials:', error);
                        this.materials = [];
                        this.filteredMaterials = [];
                    })
                    .finally(() => {
                        this.isLoadingMaterials = false;
                    });
            },
            
            filterMaterials() {
                if (this.categoryFilter === 'all') {
                    this.filteredMaterials = this.materials;
                } else {
                    this.filteredMaterials = this.materials.filter(material => 
                        material.category && material.category.toLowerCase() === this.categoryFilter.toLowerCase()
                    );
                }
                
                // Sort by name
                this.filteredMaterials.sort((a, b) => a.name.localeCompare(b.name));
            },
            
            selectMaterial(material) {
                this.selectedMaterial = material;
            },
            
            askAboutMaterial() {
                if (!this.selectedMaterial) return;
                
                const question = `Tell me about ${this.selectedMaterial.name}. What are its properties and applications?`;
                this.userInput = question;
                this.sendMessage();
            },
            
            scrollToBottom() {
                this.$nextTick(() => {
                    if (this.$refs.conversation) {
                        this.$refs.conversation.scrollTop = this.$refs.conversation.scrollHeight;
                    }
                });
            },
            
            sendMessage() {
                if (!this.inputEnabled || !this.userInput.trim() || this.isProcessing) return;
                
                // Check if ontology is selected
                if (!this.selectedOntologyId) {
                    alert('Please select an ontology first.');
                    return;
                }
                
                // Add user message to conversation
                this.messages.push({ role: 'user', content: this.userInput });
                
                // Clear input and disable it while processing
                const userMessage = this.userInput;
                this.userInput = '';
                this.inputEnabled = true;
                this.isProcessing = true;
                this.promptOptions = [];
                
                // Scroll to bottom
                this.scrollToBottom();
                
                // Send message to API
                axios.post('/realm/api/message', {
                    message: userMessage,
                    ontology_id: this.selectedOntologyId,
                    service: 'claude'  // Default to Claude
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            // Add assistant response to conversation
                            this.messages.push({
                                role: response.data.message.role,
                                content: response.data.message.content
                            });
                        } else {
                            // Add error message
                            this.messages.push({
                                role: 'assistant',
                                content: 'Sorry, there was an error processing your request.'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error sending message:', error);
                        // Add error message
                        this.messages.push({
                            role: 'assistant',
                            content: 'Sorry, there was an error processing your request.'
                        });
                    })
                    .finally(() => {
                        // Re-enable input
                        this.isProcessing = false;
                        this.scrollToBottom();
                    });
            },
            
            selectPromptOption(option) {
                this.userInput = option.text;
                this.sendMessage();
            },
            
            resetConversation() {
                // Initialize with welcome message
                this.messages = [{
                    role: 'assistant',
                    content: 'Welcome to the Materials Science Chat! I can help answer questions about various materials, their properties, and applications.'
                }];
                this.promptOptions = [];
                
                // Reset conversation state on server
                axios.post('/realm/api/reset', {
                    ontology_id: this.selectedOntologyId
                })
                    .catch(error => {
                        console.error('Error resetting conversation:', error);
                    });
            },
            
            generateSuggestions() {
                if (!this.selectedOntologyId || this.isFetchingSuggestions) return;
                
                this.isFetchingSuggestions = true;
                
                axios.post('/realm/api/suggestions', {
                    ontology_id: this.selectedOntologyId
                })
                    .then(response => {
                        if (response.data.status === 'success') {
                            this.promptOptions = response.data.suggestions || [];
                        } else {
                            console.error('Error generating suggestions:', response.data.message);
                            this.promptOptions = [];
                        }
                    })
                    .catch(error => {
                        console.error('Error generating suggestions:', error);
                        this.promptOptions = [];
                    })
                    .finally(() => {
                        this.isFetchingSuggestions = false;
                    });
            }
        }
    });
</script>
{% endblock %}
